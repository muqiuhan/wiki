#svelte #web #compiler

åœ¨ svelte æºç é‡Œï¼Œä½¿ç”¨äº† [`acorn`](https://github.com/acornjs/acorn) parser å°† javascript ç¼–è¯‘æˆ ast æ ‘ï¼Œç„¶åå¯¹ Javascript çš„è¯­ä¹‰è§£é‡Šè¿‡ç¨‹åšäº†é¢å¤–çš„å·¥ä½œï¼š

- ç¼–è¯‘èµ‹å€¼è¯­å¥æ—¶ï¼Œé™¤äº†ç”Ÿæˆå¯¹åº”çš„èµ‹å€¼é€»è¾‘ï¼Œé¢å¤–ç”Ÿæˆæ•°æ®æ›´æ–°é€»è¾‘ä»£ç 
    
- ç¼–è¯‘å˜é‡å£°æ˜æ—¶ï¼Œå˜é‡è¢«ç¼–è¯‘æˆä¸Šä¸‹æ–‡æ•°ç»„
    
- ç¼–è¯‘æ¨¡æ¿æ—¶ï¼Œæ ‡è®°ä¾èµ–ï¼Œå¹¶å¯¹æ¯ä¸ªå˜é‡å¼•ç”¨ç”Ÿæˆæ›´æ–°é€»è¾‘
    

è¿™å°±æ˜¯ç¼–è¯‘å‹æ¡†æ¶ï¼Œä¸ä¼ ç»Ÿå‰ç«¯æ¡†æ¶çš„åŒºåˆ«ï¼šæŠŠè¿è¡Œæ—¶çš„é€»è¾‘æå‰åœ¨ç¼–è¯‘æœŸå°±å®Œæˆã€‚æ‰€ä»¥è‡ªç„¶è€Œç„¶çš„ï¼Œè¿è¡Œæ—¶é€»è¾‘å¾ˆè½»é‡çº§ï¼Œå¾ˆæ˜¾ç„¶æ˜¯æœ‰åˆ©äºé¡µé¢çš„é¦–å±å’Œæ¸²æŸ“æ€§èƒ½çš„ã€‚

### ç»„ä»¶çš„åº•å±‚å®ç°

æ¯ä¸€ä¸ª .svelte æ–‡ä»¶ä»£è¡¨ä¸€ä¸ª svelte çš„ç»„ä»¶ã€‚

é€šè¿‡ svelte çš„ç¼–è¯‘ï¼Œæœ€ç»ˆä¼šè½¬æ¢ä¸ºä¸‹å›¾æ‰€ç¤ºçš„ç»„ä»¶çš„ç»“æ„

![[Pasted image 20241115111951.png]]

æ¯ä¸€ä¸ª svelte çš„ç»„ä»¶ç±»ï¼Œéƒ½ç»§æ‰¿äº† `SvelteComponent`ã€‚

svelte ç»„ä»¶ä½¿ç”¨ `create`, `mount`, `patch`, `destroy` è¿™å››ä¸ªæ–¹æ³•å®ç°å¯¹ DOM è§†å›¾çš„æ“ä½œã€‚

- `create` è´Ÿè´£ç»„ä»¶ dom çš„åˆ›å»º
    
- `mount` è´Ÿè´£å°† dom æŒ‚è½½åˆ°å¯¹åº”çš„çˆ¶èŠ‚ç‚¹ä¸Š
    
- `patch` è´Ÿè´£æ ¹æ®æ•°æ®çš„å˜åŒ–æ›´æ–° dom
    
- `destroy` è´Ÿè´£é”€æ¯å¯¹åº”çš„ dom
    

svelte çš„ç»„ä»¶å®ä¾‹åŒ–ï¼Œæ˜¯é€šè¿‡ `instance` æ–¹æ³•å’Œç»„ä»¶ä¸Šä¸‹æ–‡æ„æˆçš„ã€‚

- `instance` æ–¹æ³•æ˜¯ svelte ç»„ä»¶çš„æ„é€ å™¨ã€‚å†™åœ¨ script é‡Œçš„ä»£ç ï¼Œä¼šè¢«ç”Ÿæˆåœ¨ `instance` æ–¹æ³•é‡Œã€‚æ¯ä¸ªç»„ä»¶å®ä¾‹éƒ½ä¼šè°ƒç”¨ä¸€æ¬¡å½¢æˆè‡ªå·±çš„é—­åŒ…ï¼Œä»è€Œéš”ç¦»å„è‡ªçš„æ•°æ®ï¼Œé€šè¿‡ `instance` æ–¹æ³•è¿”å›çš„æ•°ç»„å°±æ˜¯ä¸Šä¸‹æ–‡ã€‚ä»£ç ä¸­çš„èµ‹å€¼è¯­å¥ï¼Œä¼šè¢«ç”Ÿæˆä¸ºæ•°æ®æ›´æ–°é€»è¾‘ã€‚å˜é‡å®šä¹‰ä¼šè¢«æ”¶é›†ç”Ÿæˆä¸Šä¸‹æ–‡æ•°ç»„ã€‚
- æ¯ä¸ª svelte ç»„ä»¶éƒ½ä¼šæœ‰è‡ªå·±çš„ä¸Šä¸‹æ–‡ï¼Œä¸Šä¸‹æ–‡å­˜å‚¨çš„å°±æ˜¯ script æ ‡ç­¾å†…å®šä¹‰çš„å˜é‡çš„å€¼ã€‚svelte ä¼šä¸ºæ¯ä¸ªç»„ä»¶å®ä¾‹å†…å®šä¹‰çš„æ•°æ®ç”Ÿæˆä¸Šä¸‹æ–‡ï¼ŒæŒ‰ç…§å˜é‡çš„å£°æ˜é¡ºåºä¿å­˜åœ¨ä¸€ä¸ªåä¸º `ctx` æ•°ç»„å†…ã€‚

![[Pasted image 20241115112012.png]]

### æ¨¡æ¿ç¼–è¯‘

ä¾‹å¦‚æœ‰å¦‚ä¸‹ Svelte ä»£ç :
```svelte
<h1>Hello world!</h1>
```

ç¼–è¯‘å:

```js
/* App.svelte generated by Svelte v3.59.1 */
import {
  SvelteComponent,
  detach,
  element,
  init,
  insert,
  noop,
  safe_not_equal
} from "svelte/internal";

function create_fragment(ctx) {
  let h1;

  return {
    c() {
      h1 = element("h1");
      h1.textContent = "Hello world!";
    },
    m(target, anchor) {
      insert(target, h1, anchor);
    },
    p: noop,
    i: noop,
    o: noop,
    d(detaching) {
      if (detaching) detach(h1);
    }
  };
}

class App extends SvelteComponent {
  constructor(options) {
    super();  
    init(this, options, null, create_fragment, safe_not_equal, {});
  }
}

export default App;
```


å¾ˆæ˜æ˜¾ï¼Œç»„ä»¶ç¼–è¯‘ä¹‹åï¼Œä¼šè¿”å›ä¸€ä¸ªç»§æ‰¿äº†`SvelteComponent`çš„ç±»ï¼Œå¹¶ä¸”åœ¨æ„é€ å‡½æ•°ä¸­æ‰§è¡Œäº†`init`æ–¹æ³•ï¼Œå®ƒçš„å…¶ä¸­ä¸€ä¸ªå‚æ•°æ˜¯ç»„ä»¶ä¸­å®šä¹‰çš„`create_fragment`å‡½æ•°ã€‚

è¿™ä¸ªå‡½æ•°ä¼šè¿”å›ä¸€ä¸ªå¯¹è±¡ï¼ŒåŒ…å«ç»„ä»¶å¯¹åº”çš„çš„`create` `mount` `update` `delete`æ“ä½œã€‚ç”±äºä¸Šé¢çš„ä»£ç ä¸­æ˜¯ä¸ªé™æ€çš„å­—ç¬¦ä¸²ï¼Œæ‰€ä»¥`p`å¯¹åº”çš„å€¼ä¸º`noop`å³`no operate`æ²¡æœ‰æ“ä½œã€‚

æ¥ä¸‹æ¥åŠ ç‚¹æ–™:
```svelte
<script>
let count = 0
</script>
<h1 on:click={() => count++}>Hello world!</h1>
```

ç¼–è¯‘ç»“æœ:
```js
function create_fragment(ctx) {
  let h1;
  let mounted;
  let dispose;
  
  return {
    c() {
      h1 = element("h1");
      h1.textContent = "Hello world!";
    },
    m(target, anchor) {
      insert(target, h1, anchor);
      if (!mounted) {
        dispose = listen(h1, "click", /*click_handler*/ ctx[1]);
        mounted = true;
      }
    },
    // ...
    d(detaching) {
      if (detaching) detach(h1);
      mounted = false;
      dispose();
    }
  };
}

function instance($$self, $$props, $$invalidate) {
  let count = 0;
  const click_handler = () => $$invalidate(0, count++, count);
  return [count, click_handler];
}
```

æˆ‘ä»¬å¯ä»¥çœ‹åˆ°åœ¨`mounted`ä¹‹åä½¿ç”¨`listen`æ–¹æ³•æ–°å¢äº†ä¸€ä¸ªé’ˆå¯¹`h1`çš„`click`æ–¹æ³•çš„ç›‘å¬äº‹ä»¶ï¼Œå¹¶ä¸”åœ¨`delete`é˜¶æ®µç§»é™¤ç›‘å¬äº‹ä»¶ã€‚

åŒæ—¶å¤šäº†ä¸ªå®ä¾‹æ–¹æ³•`instance`ï¼Œå®ƒçš„è¿”å›å€¼æ˜¯`count`çš„å®é™…å€¼ï¼Œä»¥åŠä¿®æ”¹`count`çš„å¤„ç†å‡½æ•°ã€‚

å†æ”¹æ”¹:
```svelte
<script>
let count = 0
</script>
<h1 on:click={() => count++}>Hello world!{count}</h1>
```

ç¼–è¯‘ç»“æœ:
```js
function create_fragment(ctx) {
  let h1;
  let t0;
  let t1;
  let mounted;
  let dispose;
  
  return {
    c() {
      h1 = element("h1");
      h1.textContent = "Hello world!";
      t0 = text("Hello world!");
      t1 = text(/*count*/ ctx[0]);
    },
    m(target, anchor) {
      insert(target, h1, anchor);
      append(h1, t0);
      append(h1, t1);
      if (!mounted) {
        dispose = listen(h1, "click", /*click_handler*/ ctx[1]);
        mounted = true;
      }
    },
    // ...
    p(ctx, [dirty]) {
      if (dirty & /*count*/ 1) set_data(t1, /*count*/ ctx[0]);
    },
    d(detaching) {
      if (detaching) detach(h1);
      mounted = false;
      dispose();
    }
  };
}
```

#### dirty è„æ ‡è®°

svelte é€šè¿‡ä½è¿ç®—(bitmask)å¯¹å˜é‡çš„æ”¹å˜è¿›è¡Œè„æ ‡è®°

æ¯ä¸ªå˜é‡éƒ½è¢«åˆ†é…ä¸€ä¸ªä½å€¼ï¼Œå¯ä»¥ç”¨äºåœ¨ `ctx` ä¸Šä¸‹æ–‡æ•°æ®é‡Œå–å¾—å˜é‡å¯¹åº”çš„å€¼ï¼Œä¹Ÿå¯ä»¥é€šè¿‡ä½è¿ç®—å¯¹å˜é‡æ”¹åŠ¨è¿›è¡Œæ ‡è®°å’Œæ£€æŸ¥ã€‚

æ¯”å¦‚ `name` çš„ä½å€¼æ˜¯ `1`ï¼Œé‚£ `name` çš„å€¼å¯ä»¥é€šè¿‡ `ctx[1]` å–å¾—ã€‚

é€šè¿‡ `dirty |= 1` è®¾ç½® `name` å·²ç»æ”¹åŠ¨çš„çŠ¶æ€ï¼Œå†é€šè¿‡ `dirty & 1` åˆ¤æ–­ `name` æ˜¯å¦æ”¹åŠ¨ã€‚

Javascript çš„ä½è¿ç®—å¯ä»¥æœ‰ 32 ä½ã€‚ svelte æ”¯æŒæ¯ä¸ªç»„ä»¶é‡Œå¯¹ 32 ä¸ªå˜é‡æ ‡è®°æ”¹åŠ¨ã€‚

ä¸€èˆ¬ä¸€ä¸ªç»„ä»¶ä¸åº”è¯¥å®šä¹‰è¿‡å¤šçš„å˜é‡ã€‚å½“ç„¶å¦‚æœå®šä¹‰å˜é‡å¤šäº 32 ä¸ªï¼Œæ— éå°±æ˜¯æ‹¿ä¸¤ä¸ªä½æ ‡è®°å˜é‡ï¼Œå‡‘æˆ 64 ä½ï¼Œä»¥æ­¤ç±»æ¨ã€‚

![[Pasted image 20241115112612.png]]

è®¾ç½®ä½ï¼š`bitmask |= 1 << (n-1)`

æ£€æµ‹ä½ï¼š`if (bitmask & (1 << (n-1)))`

| å˜é‡     | ä½ç½®  | ä½å€¼         |
| ------ | --- | ---------- |
| name   | 1   | 1<<(1-1)=1 |
| age    | 2   | 1<<(2-1)=2 |
| school | 3   | 1<<(3-1)=4 |

#### è§†å›¾çš„åˆ›å»º

å‰ç«¯æ¡†æ¶åˆ›å»ºè§†å›¾çš„æ–¹å¼æœ‰å‡ ç§ï¼Œæ¯”å¦‚è™šæ‹Ÿ domï¼Œå­—ç¬¦ä¸²æ¨¡æ¿ï¼Œè¿‡ç¨‹å¼åˆ›å»ºã€‚

svelte é‡‡ç”¨çš„æ˜¯è¿‡ç¨‹å¼åˆ›å»ºã€‚

ä¸¾ä¸ªä¾‹å­ï¼Œå‡è®¾æˆ‘æƒ³è¦é€šè¿‡çº¯ js çš„æ–¹å¼åˆ›å»ºä¸€ä¸ªå¦‚ä¸‹çš„ web uiï¼š

![[Pasted image 20241115112039.png]]

æˆ‘ä»¬å¯èƒ½ä¼šå†™ä¸‹è¿™æ ·çš„ä»£ç ï¼š

```js
const todoListNode = document.createElement('ul');
const todos = [1,2,3];
for (const todo of todos) {
    const itemNode = document.createElement('li');
    itemNode.textContent = `item ${todo}`;
    todoListNode.appendChild(itemNode);
}
```

è€Œ svelte ç”Ÿæˆçš„è§†å›¾ä»£ç å°±å¾ˆç±»ä¼¼æˆ‘ä»¬æ‰‹åŠ¨ç¼–å†™çš„ js ä»£ç ã€‚

è¿™éƒ¨åˆ†åˆ›å»º dom çš„ä»£ç ï¼Œä¼šç”Ÿæˆä¸ºç»„ä»¶å†…éƒ¨çš„ `create` å‡½æ•°ï¼Œ `mount` å‡½æ•°ï¼Œ`patch` å‡½æ•°ã€‚

ä¸‹é¢æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹æ¨¡æ¿ç¼–è¯‘è¿‡ç¨‹ã€‚

- é¦–å…ˆè§£æ svelte æ¨¡æ¿å¹¶ç”Ÿæˆæ¨¡æ¿ AST
    
- ç„¶åéå†æ¨¡æ¿ AST
    
- å¦‚æœç¢°åˆ°æ™®é€šçš„ html tag æˆ–è€…æ–‡æœ¬ï¼Œè¾“å‡º dom åˆ›å»ºè¯­å¥ï¼ˆ`dom.createElement`)
    - å¦‚æœç¢°åˆ°å˜é‡
    - è½¬æ¢ä¸ºä¸Šä¸‹æ–‡å¼•ç”¨æ–¹å¼å¹¶è¾“å‡ºå–å€¼è¯­å¥ï¼ˆå¦‚ï¼š `name` è¢«ç”Ÿæˆä¸º` ctx[/** name */0]`)
        - åœ¨ `patch` å‡½æ•°ä¸­ç”Ÿæˆå¯¹åº”çš„æ›´æ–°è¯­å¥
    - å¦‚æœç¢°åˆ° if æ¨¡æ¿
    - è·å– condition è¯­å¥ï¼Œè¾“å‡ºé€‰æ‹©å‡½æ•° `select_block` ï¼ˆå­æ¨¡æ¿é€‰æ‹©å™¨ï¼‰
        - è·å– condition ä¸º `true` çš„æ¨¡æ¿ç‰‡æ®µï¼Œè¾“å‡º `if_block` å­æ¨¡æ¿æ„å»ºå‡½æ•°
        - è·å– condition ä¸º `false` çš„æ¨¡æ¿ç‰‡æ®µï¼Œè¾“å‡º `else_block` å­æ¨¡æ¿æ„å»ºå‡½æ•°
    - å¦‚æœç¢°åˆ° each æ¨¡æ¿
    - è·å–å¾ªç¯æ¨¡æ¿ç‰‡æ®µï¼Œç”Ÿæˆå—æ„å»ºå‡½æ•° `create_each_block`
        - æ ¹æ®å¾ªç¯å†…å˜é‡å¼•ç”¨ï¼Œç”Ÿæˆå¾ªç¯å®ä¾‹ä¸Šä¸‹æ–‡è·å– `get_each_block_context`
- ç”Ÿæˆ keyè·å–å‡½æ•° `get_key`
    
- ç”ŸæˆåŸºäºkeyæ›´æ–°åˆ—è¡¨çš„ `patch` é€»è¾‘å‡½æ•° `update_keyed_each`
    

![[Pasted image 20241115112127.png]]

##### å­æ¨¡æ¿æ„å»ºå‡½æ•°

svelte ä¼šæŠŠ if æ¨¡æ¿ï¼Œ each æ¨¡æ¿ä¸­çš„é€»è¾‘åˆ†æ”¯ï¼ŒæŠ½å–æˆå­æ¨¡æ¿ï¼Œå¹¶ä¸ºå…¶ç”Ÿæˆç‹¬ç«‹çš„æ¨¡æ¿å®ä¾‹ï¼ˆåŒ…å«åˆ›å»ºï¼ŒæŒ‚è½½ï¼Œæ›´æ–°ï¼Œé”€æ¯ç­‰ç”Ÿå‘½å‘¨æœŸï¼‰

#### è§†å›¾æ›´æ–°

è§†å›¾æ›´æ–°æ—¶é€šè¿‡ `patch` å‡½æ•°æ¥å®Œæˆçš„ã€‚

ä¸‹å›¾æ˜¯æ¨¡æ¿è§£æè¿‡ç¨‹ä¸­ `patch` å‡½æ•°çš„é€»è¾‘ï¼š

```scss
function patch(ctx, [dirty]) {
  if (dirty & /*name*/ 1) set_data(t1, /*name*/ ctx[0]);
  if (dirty & /*age*/ 2) set_data(t4, /*age*/ ctx[1]);
  if (dirty & /*school*/ 4) set_data(t6, /*school*/ ctx[2]);
}
```

é€šè¿‡ `dirty` ä½æ£€æŸ¥å˜é‡æ˜¯å¦å‘ç”Ÿæ›´æ–°ï¼Œå¦‚æœå‘ç”Ÿæ›´æ–°è°ƒç”¨ dom æ“ä½œå‡½æ•°å¯¹ dom è¿›è¡Œå±€éƒ¨æ›´æ–°ã€‚ä¸Šé¢ä¾‹å­çš„ `set_data` å‡½æ•°ä½œç”¨æ˜¯ç»™ dom è®¾ç½® `innerText`ã€‚æ ¹æ®æ•°æ®æ›´æ–°çš„è§†å›¾ä½ç½®çš„ä¸åŒï¼Œè¿˜ä¼šæœ‰ `set_props` ä¹‹ç±»çš„æ›´æ–° dom å±æ€§çš„å‡½æ•°ç­‰ã€‚

#### æ¡ä»¶åˆ†æ”¯çš„å¤„ç†

æ¡ä»¶åˆ†æ”¯ä¾‹å­ï¼š

```svelte
<script>
   let isLogin = false;
	const login = () => {
		isLogin = true;
	}
	const logout = () => {
		isLogin = false;
	}
</script>

{#if !isLogin}
<button on:click={login}>
	login
</button>
{:else}
<div>
	hello, xxx
	<button on:click={logout}>logout</button>
</div>
{/if}
```

![[Pasted image 20241115112203.png]]

1. æ¡ä»¶åˆ†æ”¯çš„åˆ¤æ–­è¯­å¥ä¼šç”Ÿæˆ `select_block` å‡½æ•°ï¼Œç”¨äºåˆ¤æ–­æ¡ä»¶ï¼Œå¹¶æ ¹æ®æ¡ä»¶è¿”å›æ¡ä»¶åˆ¤æ–­ä¸ºçœŸçš„å­æ¨¡æ¿ (`if_block`) æˆ–è€…æ¡ä»¶åˆ¤æ–­ä¸ºå‡çš„å­æ¨¡æ¿ (`else_block`)

```js
// æ ¹æ®æ¡ä»¶è¿”å›å¯¹åº”çš„blockæ„é€ å‡½æ•°
function select_block(ctx, dirty) {
  if (!/*isLogin*/ ctx[0]) return if_block;
  return else_block;
}
// é€‰æ‹©blockæ„é€ å‡½æ•°
let current_block = select_block(ctx, -1);
// è¿”å›å­æ¨¡æ¿å®ä¾‹ï¼Œè·Ÿç»„ä»¶ç±»ä¼¼ï¼Œæä¾›createï¼Œmountï¼Œpatchç­‰ç”Ÿå‘½å‘¨æœŸ
let block = current_block(ctx);
```

2. æ¡ä»¶é€»è¾‘åˆ†æ”¯ä¼šç”Ÿæˆç‹¬ç«‹çš„å­æ¨¡æ¿æ„é€ å‡½æ•°

if blockç¤ºä¾‹

```js
// å­æ¨¡æ¿æ„é€ å‡½æ•°
function if_block(ctx) {
  let button;
  let mounted;
  let dispose;

  return {
    // åˆ›å»ºblock
    create() {
      button = element("button");
      button.textContent = "login";
    },
    // æŒ‚è½½block
    mount(target, anchor) {
      insert(target, button, anchor);
      if (!mounted) {
        mounted = true;
      }
    },
    // é”€æ¯block
    destroy(detaching) {
      if (detaching) detach(button);
      mounted = false;
      dispose();
    }
  };
}
```

3. ifåˆ†æ”¯å¦‚ä½•æŒ‚è½½åŠæ›´æ–°

if åˆ†æ”¯çš„åˆ›å»ºï¼š

![[Pasted image 20241115112230.png]]

if åˆ†æ”¯çš„æ›´æ–°ï¼š

![[Pasted image 20241115112241.png]]
#### å¾ªç¯æ¨¡æ¿çš„å¤„ç†

svelte çš„å¾ªç¯æ¨¡æ¿è·Ÿæ¡ä»¶åˆ†æ”¯æ¨¡æ¿ä¸€æ ·ï¼Œä¹Ÿä¼šç”Ÿæˆè¿­ä»£é€»è¾‘çš„å­æ¨¡æ¿ï¼Œæ¯ä¸€ä¸ªå¾ªç¯è¿­ä»£éƒ½æ˜¯å­æ¨¡æ¿çš„å®ä¾‹ï¼Œå¹¶ä¸”æ‹¥æœ‰ç‹¬ç«‹çš„ä¸Šä¸‹æ–‡ã€‚

ä¸»è¦ç”±4éƒ¨åˆ†ç»„æˆï¼š

1. å¾ªç¯è¿­ä»£æ„å»ºå‡½æ•° `create_each_block`
    
2. å¾ªç¯è¿­ä»£å®ä¾‹ä¸Šä¸‹æ–‡è·å–å‡½æ•° `get_each_block_context`
    
3. å¾ªç¯è¿­ä»£ `key` è·å–å‡½æ•° `get_key`
    
4. åŸºäº `key` æ›´æ–°åˆ—è¡¨çš„ `patch` é€»è¾‘å‡½æ•° `update_keyed_each`
    

### ç¼–è¯‘è¿‡ç¨‹

- svelte è°ƒç”¨ acorn ç”Ÿæˆ JS AST æ ‘
    
- éå† AST æ‰¾åˆ°èµ‹å€¼è¯­å¥
    
- ä¸ºèµ‹å€¼è¯­å¥ç”Ÿæˆæ•°æ®å“åº”å¼ä»£ç 
    

![[Pasted image 20241115112450.png]]

ä¾‹å¦‚ï¼š

```svelte
<script>
    let name = 'world';
    const changeName = () => {
        name = 'yyb';
    }
</script>
```

ç¼–è¯‘ç»“æœï¼š

```js
function instance($$self, $$props, $$invalidate) {
	let name = 'world';

	const changeName = () => {
		$$invalidate(0, name = 'yyb');
	};

	return [name];
}
```

#### `$$invalidate`

æ¯ä¸ªæ•°æ®çš„èµ‹å€¼è¯­å¥ï¼Œsvelte éƒ½ä¼šç”Ÿæˆå¯¹ `invalidate` çš„è°ƒç”¨, `invalidate` çš„è°ƒç”¨ä¸»è¦åšçš„æ˜¯å¯¹æŸä¸ªæ”¹åŠ¨çš„å˜é‡è¿›è¡Œæ ‡è®°ï¼Œç„¶ååœ¨å¾®ä»»åŠ¡ä¸­è°ƒç”¨patchå‡½æ•°ï¼Œæ ¹æ®å˜é‡æ”¹åŠ¨çš„è„æ ‡è®°è¿›è¡Œå±€éƒ¨æ›´æ–°

æ•°æ®èµ‹å€¼è§¦å‘è§†å›¾æ›´æ–°ï¼š

![[Pasted image 20241115112544.png]]

## è¿è¡Œæ—¶

### `init` 

åœ¨è¿›å…¥è¿è¡Œæ—¶ï¼Œé¦–å…ˆæ‰§è¡Œ`init`æ–¹æ³•ï¼Œè¯¥æ–¹æ³•å¤§è‡´æµç¨‹å¦‚ä¸‹ï¼š

- åˆå§‹åŒ–çŠ¶æ€
- åˆå§‹åŒ–å‘¨æœŸå‡½æ•°
- æ‰§è¡Œ`instance`æ–¹æ³•ï¼Œåœ¨å›è°ƒå‡½æ•°ä¸­æ ‡è®° __è„ç»„ä»¶__ (`dirty_components`)
- æ‰§è¡Œæ‰€æœ‰`beforeUpdate`ç”Ÿå‘½å‘¨æœŸçš„å‡½æ•°
- æ‰§è¡Œåˆ›å»ºç‰‡æ®µ`create_fragment`å‡½æ•°
- æŒ‚è½½å½“å‰ç»„ä»¶å¹¶æ‰§è¡Œ`create_fragement`è¿”å›çš„`mï¼ˆmountedï¼‰`æ–¹æ³•
- æ‰§è¡Œ`flush`æ–¹æ³•

```js
export function init(
  component,
  options,
  instance,
  create_fragment,
  not_equal,
  props,
  append_styles,
  dirty = [-1]
) {
  const parent_component = current_component;
  set_current_component(component);

  const $$: T$$ = component.$$ = {
    fragment: null,
    ctx: [],

    // state
    props,
    update: noop,
    not_equal,
    bound: blank_object(),

    // lifecycle
    on_mount: [],
    on_destroy: [],
    on_disconnect: [],
    before_update: [],
    after_update: [],
    context: new Map(options.context || (parent_component ? parent_component.$$.context : [])),

    // everything else
    callbacks: blank_object(),
    dirty,
    skip_bound: false,
    root: options.target || parent_component.$$.root
  };

  append_styles && append_styles($$.root);

  let ready = false;

  $$.ctx = instance
    ? instance(component, options.props || {}, (i, ret, ...rest) => {
        const value = rest.length ? rest[0] : ret;
        if ($$.ctx && not_equal($$.ctx[i], $$.ctx[i] = value)) {
            if (!$$.skip_bound && $$.bound[i]) $$.bound[i](value);
            if (ready) make_dirty(component, i);
        }
        return ret;
    })
    : [];

  $$.update();
  ready = true;
  run_all($$.before_update);

  // `false` as a special case of no DOM component
  $$.fragment = create_fragment ? create_fragment($$.ctx) : false;

  if (options.target) {
    if (options.hydrate) {
        start_hydrating();
        const nodes = children(options.target);
        // eslint-disable-next-line @typescript-eslint/no-non-null-assertion
        $$.fragment && $$.fragment!.l(nodes);
        nodes.forEach(detach);
    } else {
        // eslint-disable-next-line @typescript-eslint/no-non-null-assertion
        $$.fragment && $$.fragment!.c();
    }

    if (options.intro) transition_in(component.$$.fragment);
    mount_component(component, options.target, options.anchor, options.customElement);
    end_hydrating();
    flush();
  }

  set_current_component(parent_component);
}
```

### `flush` æ–¹æ³•

`flush` çš„æ–¹æ³•ä¸»è¦åšäº†ä¸€ä»¶äº‹ï¼š
éå†éœ€è¦æ›´æ–°çš„ç»„ä»¶ï¼ˆ`dirty_components`ï¼‰ï¼Œç„¶åæ›´æ–°å®ƒï¼Œå¹¶ä¸”è°ƒç”¨`afterUpdate`æ–¹æ³•:

```js
export function flush() {
  // Do not reenter flush while dirty components are updated, as this can
  // result in an infinite loop. Instead, let the inner flush handle it.
  // Reentrancy is ok afterwards for bindings etc.
  if (flushidx !== 0) {
    return;
  }

  const saved_component = current_component;

  do {
    // first, call beforeUpdate functions
    // and update components
    try {
        while (flushidx < dirty_components.length) {
            const component = dirty_components[flushidx];
            flushidx++;
            set_current_component(component);
            update(component.$$);
        }
    } catch (e) {
        // reset dirty state to not end up in a deadlocked state and then rethrow
        dirty_components.length = 0;
        flushidx = 0;
        throw e;
    }

    set_current_component(null);

    dirty_components.length = 0;
    flushidx = 0;

    // then, once components are updated, call
    // afterUpdate functions. This may cause
    // subsequent updates...
    for (let i = 0; i < render_callbacks.length; i += 1) {
        const callback = render_callbacks[i];

        if (!seen_callbacks.has(callback)) {
            // ...so guard against infinite loops
            seen_callbacks.add(callback);

            callback();
        }
    }

    render_callbacks.length = 0;
  } while (dirty_components.length);

  while (flush_callbacks.length) {
    flush_callbacks.pop()();
  }

  update_scheduled = false;
  seen_callbacks.clear();
  set_current_component(saved_component);
}
```

å†æ¥çœ‹çœ‹å…·ä½“çš„æ›´æ–°æ“ä½œ`update`å‡½æ•°åšäº†å•¥

- é¦–å…ˆæ‰§è¡Œæ‰€æœ‰çš„`before_update`æ–¹æ³•
- ç„¶åæ‰§è¡Œ`create_fragment`è¿”å›çš„`pï¼ˆupdateï¼‰`æ–¹æ³•

```js
function update($$) {
    if ($$.fragment !== null) {
        $$.update();
        run_all($$.before_update);
        const dirty = $$.dirty;
        $$.dirty = [-1];
        $$.fragment && $$.fragment.p($$.ctx, dirty);

        $$.after_update.forEach(add_render_callback);
    }
}
```

æ€»ç»“,åœ¨è¿è¡Œæ—¶:

1. åˆå§‹åŒ–çŠ¶æ€ã€åˆå§‹åŒ–å‘¨æœŸå‡½æ•°
2. æ‰§è¡Œ`instance`æ–¹æ³•ï¼Œåœ¨å›è°ƒå‡½æ•°ä¸­æ ‡è®°`è„ç»„ä»¶`
3. æ‰§è¡Œæ‰€æœ‰`beforeUpdate`ç”Ÿå‘½å‘¨æœŸçš„å‡½æ•°
4. æ‰§è¡Œåˆ›å»ºç‰‡æ®µ`create_fragment`å‡½æ•°
5. æŒ‚è½½å½“å‰ç»„ä»¶å¹¶æ‰§è¡Œ`create_fragement`è¿”å›çš„`mï¼ˆmountedï¼‰`æ–¹æ³•
6. æ‰§è¡Œ`flush`æ–¹æ³•
7. æ‰§è¡Œæ‰€æœ‰çš„`before_update`æ–¹æ³•
8. æ‰§è¡Œ`create_fragment`è¿”å›çš„`pï¼ˆupdateï¼‰`æ–¹æ³•
9. æœ€åï¼Œæ‰§è¡Œ`afterUpdate`æ–¹æ³•

## Svelte ç¼–è¯‘å™¨

- [https://github.com/sveltejs/svelte/blob/main/packages/svelte/src/compiler/index.js](https://github.com/sveltejs/svelte/blob/main/packages/svelte/src/compiler/index.js)
```js
/**
 * `compile` converts your `.svelte` source code into a JavaScript module that exports a component
 *
 * @param {string} source The component source code
 * @param {CompileOptions} options The compiler options
 * @returns {CompileResult}
 */
export function compile(source, options) {
	source = remove_bom(source);
	state.reset_warning_filter(options.warningFilter);
	const validated = validate_component_options(options, '');
	state.reset(source, validated);

	let parsed = _parse(source);

	const { customElement: customElementOptions, ...parsed_options } = parsed.options || {};

	/** @type {ValidatedCompileOptions} */
	const combined_options = {
		...validated,
		...parsed_options,
		customElementOptions
	};

	if (parsed.metadata.ts) {
		parsed = {
			...parsed,
			fragment: parsed.fragment && remove_typescript_nodes(parsed.fragment),
			instance: parsed.instance && remove_typescript_nodes(parsed.instance),
			module: parsed.module && remove_typescript_nodes(parsed.module)
		};
	}

	const analysis = analyze_component(parsed, source, combined_options);
	const result = transform_component(analysis, source, combined_options);
	result.ast = to_public_ast(source, parsed, options.modernAst);
	return result;
}
```

ä»è¿™é‡Œçœ‹, Svelteçš„ç¼–è¯‘è¿‡ç¨‹å¯ä»¥åˆ†ä¸ºä¸‰ä¸ªä¸»è¦é˜¶æ®µï¼š

1. **ParseÂ è§£æ**
2. **AnalyzeÂ åˆ†æ**
3. **TransformÂ è½¬æ¢**

 velte æ–‡ä»¶çš„ Scriptã€HTML å’Œ CSS ä»£ç è¢«åˆ†å¼€ä»¥å½¢æˆå•ä¸ªç»„ä»¶å¯¹è±¡:
![[Pasted image 20241115115009.png]]
åœ¨`Parser`æ„é€ å‡½æ•°å†…éƒ¨ï¼Œ [`fragment`](https://github.com/sveltejs/svelte/blob/main/packages/svelte/src/compiler/phases/1-parse/state/fragment.js) å‡½æ•°ç”¨äºé€’å½’åœ°è§£æè‡ªèº«:
```js
/** @param {Parser} parser */
export default function fragment(parser) {
	if (parser.match('<')) {
		return element;
	}

	if (parser.match('{')) {
		return tag;
	}

	return text;
}
```

fragment æ ¹æ®æ¡ä»¶è¿”å› `element` `tag` `text` ç­‰å‡½æ•°, è¿™ä¸ªè¿”å›å€¼ä¼šè¢«è°ƒç”¨ä»¥ä»æºä»£ç ä¸­æå–ä¿¡æ¯ã€‚

åŒ…å«åœ¨`script`æ ‡ç­¾ä¸­çš„åŒºåŸŸé€šè¿‡[`read_script`](https://github.com/sveltejs/svelte/blob/main/packages/svelte/src/compiler/phases/1-parse/read/script.js)è¿›è¡Œè§£æ:

```js
/**
 * @param {Parser} parser
 * @param {number} start
 * @param {Array<AST.Attribute | AST.SpreadAttribute | Directive>} attributes
 * @returns {AST.Script}
 */
export function read_script(parser, start, attributes) {
...
	const source =
		parser.template.slice(0, script_start).replace(regex_not_newline_characters, ' ') + data;
	parser.read(regex_starts_with_closing_script_tag);

	/** @type {Program} */
	let ast;

	try {
		ast = acorn.parse(source, parser.ts);
	} catch (err) {
		parser.acorn_error(err);
	}
...
}
```

å…¶ä»–åŒºåŸŸä½¿ç”¨ Svelte Compiler è‡ªå·±çš„è§£æé€»è¾‘ã€‚å½“é‡åˆ°`style`æ ‡ç­¾æ—¶ï¼Œä¼šä½¿ç”¨[`read_style`](https://github.com/sveltejs/svelte/blob/main/packages/svelte/src/compiler/phases/1-parse/read/style.js):

```js
/**
 * @param {Parser} parser
 * @param {number} start
 * @param {Array<AST.Attribute | AST.SpreadAttribute | Directive>} attributes
 * @returns {Css.StyleSheet}
 */
export default function read_style(parser, start, attributes) {
	const content_start = parser.index;
	const children = read_body(parser, '</style');
	const content_end = parser.index;

	parser.read(/^<\/style\s*>/);

	return {
		type: 'StyleSheet',
		start,
		end: parser.index,
		attributes,
		children,
		content: {
			start: content_start,
			end: content_end,
			styles: parser.template.slice(content_start, content_end),
			comment: null
		}
	};
}
```

å…¶ä»–ç±»ä¼¼çš„ä¹Ÿéƒ½å’Œ `read_style` æ”¾åœ¨ä¸€èµ·.

æœ€ç»ˆä¼šç”Ÿæˆä¸€ä¸ªè¿™æ ·çš„ JSON:
```json
{
  html: { type, start, end, children }
  css: { type, start, end, attributes, children, content }
  instance: { type, start, end, context, content }
  module: { type, start, end, context, content }
}
```

### åˆ†æå’Œè·Ÿè¸ªç»„ä»¶å†…éƒ¨çš„ä¾èµ–å…³ç³»

ä»åˆ›å»ºçš„ AST ä¸­æå–ç”¨äºæ‰§è¡Œç»„ä»¶çš„å„ç§æ“ä½œçš„ä¿¡æ¯:
![[Pasted image 20241115115845.png]]

å‚è€ƒ[æºç ](https://github.com/sveltejs/svelte/blob/main/packages/svelte/src/compiler/phases/2-analyze/index.js#L398)ï¼Œç»„ä»¶çš„ä¸»è¦å±æ€§å¯ä»¥æ€»ç»“å¦‚ä¸‹ï¼š
```js
const analysis = {
root: scope_root,
module,
instance,
template,
stylesheet: new Stylesheet({...}),
// Various compile options
runes,
warnings,
reactive_statements: new Map(),
binding_groups: new Map(),
slot_names: new Set(),
...
};
```

`ScopeRoot`æ˜¯ä¸€ä¸ªå……å½“ç»„ä»¶æœ€é«˜[ä½œç”¨åŸŸ](https://developer.mozilla.org/ko/docs/Glossary/Scope)çš„å¯¹è±¡ã€‚åœ¨å†…éƒ¨ï¼Œå®ƒä½¿ç”¨`Set`æ•°æ®ç»“æ„æ¥ç¡®ä¿å˜é‡å’Œå‡½æ•°ç­‰æ ‡è¯†ç¬¦çš„å”¯ä¸€æ€§ã€‚

éå† instance script å’Œ module script çš„ AST æ¥è¯†åˆ«**å˜é‡è¢«å¼•ç”¨çš„æ‰€æœ‰åŒºåŸŸ**ï¼Œä»è€Œäº†è§£å˜é‡å¯èƒ½å‘ç”Ÿå˜åŒ–çš„æ‰€æœ‰æƒ…å†µã€‚åœ¨æ­¤è¿‡ç¨‹ä¸­ï¼Œå°†åˆ›å»º script çš„è¾ƒä½ä½œç”¨åŸŸï¼Œå¼•ç”¨ `scope_root` ä¸ºå˜é‡åˆ†é…å”¯ä¸€æ ‡è¯†ç¬¦.

instance script å’Œ module script çš„åŒºåˆ«æ˜¯:

- module å®šä¹‰ç»„ä»¶ä¹‹é—´å…±äº«çš„çŠ¶æ€å’Œé€»è¾‘, å¯ä»¥ä½¿ç”¨[`<script context="module">`](https://learn.svelte.dev/tutorial/sharing-code)å£°æ˜, ä½†ä¸èƒ½åŒ…å« `reactive` çš„ä»£ç 
- instance å®šä¹‰ç»„ä»¶çš„å”¯ä¸€çŠ¶æ€å’Œé€»è¾‘.

å…¶ä»–çš„åŸºæœ¬æ²¡å•¥è®²çš„, `stylesheet` ä¼šæ ¹æ®æ”¶é›†åˆ°çš„`analysis`ä¿¡æ¯æ‰§è¡Œä¸€äº›ä¼˜åŒ–ä»»åŠ¡:
- é‡å¤çš„å…¨å±€ CSS é€‰æ‹©å™¨å’Œç»„ä»¶èŒƒå›´å†…æœªä½¿ç”¨çš„é€‰æ‹©å™¨å°†è¢«åˆ é™¤ã€‚
- ç»„ä»¶èŒƒå›´å†…ä½¿ç”¨çš„ CSS é€‰æ‹©å™¨è¢«å“ˆå¸Œä¸º`.svelte-xxx`æ ¼å¼ï¼Œé˜²æ­¢ä¸åŒåé€‰æ‹©å™¨å‘ç”Ÿå†²çªã€‚

### Final Traversel

æœ€åä¼šæ ¹æ®è·å¾—çš„`analysis`ä¿¡æ¯ï¼Œå†æ¬¡éå† AST æ¥ä¼˜åŒ–ç»„ä»¶çŠ¶æ€:

```js
walk(
  /** @type {import('#compiler').SvelteNode} \*/ (ast),
  /** @type {import('./types').AnalysisState} \*/ (state),
  merge(
    set_scope(scopes),
    validation_runes,
    runes_scope_tweaker,
    common_visitors,
  ),
);
```

- `validation_runes` æ£€æŸ¥ä¸æ­£ç¡®çš„èµ‹å€¼æˆ–æ›´æ–°è¡¨è¾¾å¼, éªŒè¯å˜é‡çš„å£°æ˜å’Œå¯¼å‡ºå¹¶æ£€æŸ¥æ–°çš„`reactive`è¯­æ³•`runes`çš„æœ‰æ•ˆæ€§ã€‚
- `runes_scope_tweaker` è°ƒæ•´ä½œç”¨åŸŸ, è®¾ç½®ä½¿ç”¨ç‰¹å®šæ¨¡å¼çš„å˜é‡å£°æ˜çš„ä½œç”¨åŸŸå’Œç»‘å®šç±»å‹, å¹¶å°†å˜é‡æˆ–å‡½æ•°ç§»åŠ¨åˆ°å®ä¾‹ä¹‹å¤–è€Œä¸æ”¹å˜çŠ¶æ€ã€‚
- `common_visitors` å¤„ç†`directive`å’Œ`binding`ç›¸å…³æŒ‡ä»¤å’Œä¸€èˆ¬ HTML æˆ– Svelte ç‰¹å®šå…ƒç´ , å¹¶å¤„ç†ä¸äº‹ä»¶ç›¸å…³çš„å±æ€§å¹¶ç¡®å®šæ˜¯å¦éœ€è¦äº‹ä»¶å§”æ‰˜æˆ–æå‡ã€‚

### è½¬æ¢

æœ€åï¼ŒSvelteç¼–è¯‘å™¨ç»è¿‡ä¸€ä¸ªè½¬æ¢è¿‡ç¨‹æ¥ç”Ÿæˆæ¸²æŸ“ä»£ç ã€‚

![[Pasted image 20241115120819.png]]

åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼ŒSSRï¼ˆæœåŠ¡å™¨ç«¯æ¸²æŸ“ï¼‰å’Œ CSRï¼ˆå®¢æˆ·ç«¯æ¸²æŸ“ï¼‰çš„ä»£ç ç”Ÿæˆé€»è¾‘æ˜¯ä¸åŒçš„ã€‚ç¼–è¯‘å™¨ä½¿ç”¨ä¸¤ä¸ªå‡½æ•°`server_component`å’Œ`client_component`æ¥åˆ›å»ºé’ˆå¯¹æ¯ç§åœºæ™¯ä¼˜åŒ–çš„ä»£ç , å°±åƒè¿™æ ·:

```js
const program =
  options.generate === 'server'
    ? server_component(analysis, options)
    : client_component(source, analysis, options);

```

åœ¨ SSR ä¸­ï¼Œç»„ä»¶ä»…æ¸²æŸ“ä¸€æ¬¡ï¼Œå¹¶ä¸”ç»„ä»¶æ²¡æœ‰ç”Ÿå‘½å‘¨æœŸã€‚
å› æ­¤ï¼Œ `server_component`ä¸“æ³¨äºåˆ›å»º[`template literals`](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Template_literals) ã€‚å®ƒä½¿ç”¨`javascript_visitors`å’Œ`template_visitors`ç­‰è®¿é—®è€…æ·»åŠ ä»£ç å—ã€‚

åœ¨ CSR ä¸­ï¼Œéœ€è¦ä¸ DOM ä¸æ–­äº¤äº’ï¼Œå¹¶ä¸”ç»„ä»¶éœ€è¦æœ‰ç”Ÿå‘½å‘¨æœŸã€‚
å› æ­¤ï¼Œ `client_component`ç”±æ›´åŠ å¤šæ ·åŒ–å’Œå¤æ‚çš„è®¿é—®è€…ç»„æˆã€‚å³ä½¿ç›¸åŒçš„`javascript_visitors`ä¹ŸåŒ…å«éå†è¿‡ç¨‹ä¸­å‡½æ•°çš„é™„åŠ å¤„ç†é€»è¾‘ã€‚

## REFERENCE
- [svelte/compiler](https://svelte.dev/docs/svelte-compiler)
- [Svelte â€” What made me meet you like this](https://blog.kalan.dev/en/series/svelte-series/1)
- [ğŸš€SvelteåŸç†å’Œè¿›é˜¶çœ‹è¿™ç¯‡å°±å¤Ÿäº†ğŸš€](https://juejin.cn/post/7235628080219078693)
- [How Does the Svelte Compiler Work?](https://bepyan.me/en/post/svelte-compiler-operation)
- [ä¸€æ–‡è®²é€å‰ç«¯æ–°ç§€ svelte](https://juejin.cn/post/7185433911437033531)