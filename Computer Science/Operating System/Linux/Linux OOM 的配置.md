#os #linux 

OOM（Out-of-Memory）机制是内核的一部分，用于处理内存消耗过度的情况。OOM机制的责任是选择一个或多个高内存消耗的进程，并终止它们以释放内存。

在Linux中，进程的OOM Score决定了在出现内存不足的情况下，进程是最可能被终止的。OOM Score越高的进程被终止的可能性也就越大。

不应该直接修改一个进程的OOM Score。通常可以通过以下方式来影响OOM的行为：

    调整系统级别的内存限制（例如sysctl调整vm.overcommit_memory限制）
    调整内存使用（例如在应用程序代码中管理内存，或使用可调整的进程或容器限制）
    调整OOM Score的全局设置（例如修改/proc/sys/vm/oom_score_adj值，该值影响所有进程）

可以使用 `sysctl` 来调整Linux系统中的 `vm.overcommit_memory` 设置。这个设置控制Linux内核如何处理内存过度分配的情况。

## 修改 `vm.overcommit_memory` 限制

以下是在 Linux 中使用 `sysctl` 修改 `vm.overcommit_memory` 设置的步骤：

- 确认当前的vm.overcommit_memory设置。在终端中运行以下命令：`sysctl vm.overcommit_memory`

`vm.overcommit_memory` 有以下三个值可供选择：

- 0: 表示内核将检查是否有足够的可用内存来满足进程的需要，如果没有足够的内存，内核将杀死进程并释放内存。

- 1：表示内核将允许进程分配所有它们请求的虚拟内存，并且不会检查物理内存是否足够。当物理内存不足时，进程可能会因无可用内存而崩溃。

- 2：表示内核将允许进程分配所有它们请求的虚拟内存，但会检查交换空间和物理内存是否足够。如果两者都不足，内核将杀死进程并释放内存。

如果想将值设置为2，可以运行:  `sudo sysctl vm.overcommit_memory=2`

如果希望永久保存修改的值，可以将它们添加到 `/etc/sysctl.conf` 文件中。在文件的末尾添加以下行：`vm.overcommit_memory = <value>`

注意事项：请注意操作系统版本和内核版本是否支持您设置的值。另外，请谨慎地进行内存设置的更改，以免出现不可预料的行为。

调整内存使用

1. 在应用程序代码中管理内存：应用程序可以使用一些技术来管理内存，例如手动释放内存、使用内存池和内存重用等。可以帮助应用程序避免过度使用内存，从而减少出现 OOM 问题的概率。

2. 使用可调整的进程或容器限制：可以使用可调整的进程或容器限制来限制进程或容器可以使用的内存量。这些限制可以根据需要进行调整，并可用于避免过度使用内存和 OOM 问题。

3. 升级硬件：如果出现频繁的 OOM 问题，则可以考虑升级系统硬件，例如增加内存容量。这将提高系统的内存容量，并减少 OOM 问题的发生。

调整 OOM Score 的全局设置

OOM Score 是 Linux 系统中用来确定进程优先级的指标，可以通过更改该值来调整系统中进程的优先级:

```
vm.overcommit_memory = 2
vm.overcommit_ratio = 80
vm.oom_kill_allocating_task = 0
```

1. `vm.overcommit_memory`：表示系统内存充足性检查机制。0表示表示系统将会检查并根据需要减少内存使用，1表示系统将允许分配超出系统内存总量的内存（即虚拟内存），2表示所有的内存请求都分配，而不管交换空间是否够用。
2. `vm.overcommit_ratio`：表示当开启 `vm.overcommit_memory` 时，向应用层分配物理内存与虚拟内存的比例。默认值为50%，所以将该值调整为80%可以给应用层更多的物理内存。
3. `vm.oom_kill_allocating_task`：表示当系统出现 OOM（out of memory）时，是否杀掉正在分配内存的任务以释放内存。将该值设置为0可以让系统直接杀掉已存在的进程，而不是正在分配内存的进程。

保存并退出文件，重启系统（或者执行以下命令使设置生效）：

```
sudo sysctl -p
```