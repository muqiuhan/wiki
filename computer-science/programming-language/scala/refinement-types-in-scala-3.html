<!DOCTYPE html> <html><head>
		<title>Refinement types in Scala 3</title>
		<base href="../../../">
		<meta id="root-path" root-path="../../../">
		<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes, minimum-scale=1.0, maximum-scale=5.0">
		<meta charset="UTF-8">
		<meta name="description" content="韩暮秋的个人维基 - Refinement types in Scala 3">
		<meta property="og:title" content="Refinement types in Scala 3">
		<meta property="og:description" content="韩暮秋的个人维基 - Refinement types in Scala 3">
		<meta property="og:type" content="website">
		<meta property="og:url" content="https://muqiuhan.github.io/wiki/computer-science/programming-language/scala/refinement-types-in-scala-3.html">
		<meta property="og:image" content="undefined">
		<meta property="og:site_name" content="韩暮秋的个人维基">
		<meta name="author" content="韩暮秋"><link rel="alternate" type="application/rss+xml" title="RSS Feed" href="https://muqiuhan.github.io/wiki/lib/rss.xml"><script async="" id="webpage-script" src="lib/scripts/webpage.js" onload="this.onload=null;this.setAttribute(&quot;loaded&quot;, &quot;true&quot;)"></script><script type="module" async="" id="graph-view-script" src="lib/scripts/graph-view.js"></script><script async="" id="graph-wasm-script" src="lib/scripts/graph-wasm.js" onload="this.onload=null;this.setAttribute(&quot;loaded&quot;, &quot;true&quot;)"></script><script async="" id="graph-render-worker-script" src="lib/scripts/graph-render-worker.js" onload="this.onload=null;this.setAttribute(&quot;loaded&quot;, &quot;true&quot;)"></script><script async="" id="tinycolor-script" src="lib/scripts/tinycolor.js" onload="this.onload=null;this.setAttribute(&quot;loaded&quot;, &quot;true&quot;)"></script><script async="" id="pixi-script" src="lib/scripts/pixi.js" onload="this.onload=null;this.setAttribute(&quot;loaded&quot;, &quot;true&quot;)"></script><script async="" id="minisearch-script" src="lib/scripts/minisearch.js" onload="this.onload=null;this.setAttribute(&quot;loaded&quot;, &quot;true&quot;)"></script><link rel="icon" href="lib/media/favicon.ico"><script async="" id="graph-data-script" src="lib/scripts/graph-data.js" onload="this.onload=null;this.setAttribute(&quot;loaded&quot;, &quot;true&quot;)"></script><style>body{--line-width:40em;--line-width-adaptive:40em;--file-line-width:40em;--sidebar-width:min(20em, 80vw);--collapse-arrow-size:11px;--tree-horizontal-spacing:0.6em;--tree-vertical-spacing:0.6em;--sidebar-margin:12px}.sidebar{height:100%;min-width:calc(var(--sidebar-width) + var(--divider-width-hover));max-width:calc(var(--sidebar-width) + var(--divider-width-hover));font-size:14px;z-index:10;position:relative;overflow:hidden;transition:min-width ease-in-out,max-width ease-in-out;transition-duration:.2s;contain:size}.sidebar-left{left:0}.sidebar-right{right:0}.sidebar.is-collapsed{min-width:0;max-width:0}body.floating-sidebars .sidebar{position:absolute}.sidebar-content{height:100%;min-width:calc(var(--sidebar-width) - var(--divider-width-hover));top:0;padding:var(--sidebar-margin);padding-top:4em;line-height:var(--line-height-tight);background-color:var(--background-secondary);transition:background-color,border-right,border-left,box-shadow;transition-duration:var(--color-fade-speed);transition-timing-function:ease-in-out;position:absolute;display:flex;flex-direction:column}.sidebar:not(.is-collapsed) .sidebar-content{min-width:calc(max(100%,var(--sidebar-width)) - 3px);max-width:calc(max(100%,var(--sidebar-width)) - 3px)}.sidebar-left .sidebar-content{left:0;border-top-right-radius:var(--radius-l);border-bottom-right-radius:var(--radius-l)}.sidebar-right .sidebar-content{right:0;border-top-left-radius:var(--radius-l);border-bottom-left-radius:var(--radius-l)}.sidebar:has(.sidebar-content:empty):has(.topbar-content:empty){display:none}.sidebar-topbar{height:2em;width:var(--sidebar-width);top:var(--sidebar-margin);padding-inline:var(--sidebar-margin);z-index:1;position:fixed;display:flex;align-items:center;transition:width ease-in-out;transition-duration:inherit}.sidebar.is-collapsed .sidebar-topbar{width:calc(2.3em + var(--sidebar-margin) * 2)}.sidebar .sidebar-topbar.is-collapsed{width:0}.sidebar-left .sidebar-topbar{left:0}.sidebar-right .sidebar-topbar{right:0}.topbar-content{overflow:hidden;overflow:clip;width:100%;height:100%;display:flex;align-items:center;transition:inherit}.sidebar.is-collapsed .topbar-content{width:0;transition:inherit}.clickable-icon.sidebar-collapse-icon{background-color:transparent;color:var(--icon-color-focused);padding:0!important;margin:0!important;height:100%!important;width:2.3em!important;margin-inline:0.14em!important;position:absolute}.sidebar-left .clickable-icon.sidebar-collapse-icon{transform:rotateY(180deg);right:var(--sidebar-margin)}.sidebar-right .clickable-icon.sidebar-collapse-icon{transform:rotateY(180deg);left:var(--sidebar-margin)}.clickable-icon.sidebar-collapse-icon svg.svg-icon{width:100%;height:100%}.sidebar-section-header{margin:0 0 1em 0;text-transform:uppercase;letter-spacing:.06em;font-weight:600}body{transition:background-color var(--color-fade-speed) ease-in-out}.webpage-container{display:flex;flex-direction:row;height:100%;width:100%;align-items:stretch;justify-content:center}.document-container{opacity:1;flex-basis:100%;max-width:100%;width:100%;height:100%;display:flex;flex-direction:column;align-items:center;transition:opacity .2s ease-in-out;contain:inline-size}.hide{opacity:0;transition:opacity .2s ease-in-out}.document-container>.markdown-preview-view{margin:var(--sidebar-margin);margin-bottom:0;width:100%;width:-webkit-fill-available;width:-moz-available;width:fill-available;background-color:var(--background-primary);transition:background-color var(--color-fade-speed) ease-in-out;border-top-right-radius:var(--window-radius,var(--radius-m));border-top-left-radius:var(--window-radius,var(--radius-m));overflow-x:hidden!important;overflow-y:auto!important;display:flex!important;flex-direction:column!important;align-items:center!important;contain:inline-size}.document-container>.markdown-preview-view>.markdown-preview-sizer{padding-bottom:80vh!important;width:100%!important;max-width:var(--line-width)!important;flex-basis:var(--line-width)!important;transition:background-color var(--color-fade-speed) ease-in-out;contain:inline-size}.markdown-rendered img:not([width]),.view-content img:not([width]){max-width:100%;outline:0}.document-container>.view-content.embed{display:flex;padding:1em;height:100%;width:100%;align-items:center;justify-content:center}.document-container>.view-content.embed>*{max-width:100%;max-height:100%;object-fit:contain}:has(> :is(.math,table)){overflow-x:auto!important}.document-container>.view-content{overflow-x:auto;contain:content;padding:0;margin:0;height:100%}.scroll-highlight{position:absolute;width:100%;height:100%;pointer-events:none;z-index:1000;background-color:hsla(var(--color-accent-hsl),.25);opacity:0;padding:1em;inset:50%;translate:-50% -50%;border-radius:var(--radius-s)}</style><script defer="">async function loadIncludes(){if("file:"!=location.protocol){let e=document.querySelectorAll("include");for(let t=0;t<e.length;t++){let o=e[t],l=o.getAttribute("src");try{const e=await fetch(l);if(!e.ok){console.log("Could not include file: "+l),o?.remove();continue}let t=await e.text(),n=document.createRange().createContextualFragment(t),i=Array.from(n.children);for(let e of i)e.classList.add("hide"),e.style.transition="opacity 0.5s ease-in-out",setTimeout((()=>{e.classList.remove("hide")}),10);o.before(n),o.remove(),console.log("Included file: "+l)}catch(e){o?.remove(),console.log("Could not include file: "+l,e);continue}}}else{if(document.querySelectorAll("include").length>0){var e=document.createElement("div");e.id="error",e.textContent="Web server exports must be hosted on an http / web server to be viewed correctly.",e.style.position="fixed",e.style.top="50%",e.style.left="50%",e.style.transform="translate(-50%, -50%)",e.style.fontSize="1.5em",e.style.fontWeight="bold",e.style.textAlign="center",document.body.appendChild(e),document.querySelector(".document-container")?.classList.remove("hide")}}}document.addEventListener("DOMContentLoaded",(()=>{loadIncludes()}));let isFileProtocol="file:"==location.protocol;function waitLoadScripts(e,t){let o=e.map((e=>document.getElementById(e+"-script"))),l=0;!function e(){let n=o[l];l++,n&&"true"!=n.getAttribute("loaded")||l<o.length&&e(),l<o.length?n.addEventListener("load",e):t()}()}</script><link rel="stylesheet" href="lib/styles/obsidian.css"><link rel="preload" href="lib/styles/other-plugins.css" as="style" onload="this.onload=null;this.rel='stylesheet'"><noscript><link rel="stylesheet" href="lib/styles/other-plugins.css"></noscript><link rel="stylesheet" href="lib/styles/theme.css"><link rel="preload" href="lib/styles/global-variable-styles.css" as="style" onload="this.onload=null;this.rel='stylesheet'"><noscript><link rel="stylesheet" href="lib/styles/global-variable-styles.css"></noscript><link rel="preload" href="lib/styles/main-styles.css" as="style" onload="this.onload=null;this.rel='stylesheet'"><noscript><link rel="stylesheet" href="lib/styles/main-styles.css"></noscript></head><body class="publish css-settings-manager theme-light show-inline-title show-ribbon pt-color-scheme-style-minimal-lt pt-accent-style-borderandfilled-lt pt-accent-color-grey-lt pt-highlight-text-accent-lt pt-accent-style-borderandfilled-dt pt-accent-color-purple-dt pt-highlight-text-accent-dt pt-focused-style-main-only pt-font-disable-ligatures pt-highlight-style-borderandfilled-lt pt-highlight-text-color-lt pt-highlight-style-borderandfilled-dt pt-highlight-text-color-dt pt-file-explorer-folder-icon-default pt-colored-folders-style-rainbow pt-center-kanban-title-text pt-kanban-background-grid-lt pt-kanban-background-grid-dt pt-icon-folder-accent"><script defer="">let theme=localStorage.getItem("theme")||(window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light");"dark"==theme?(document.body.classList.add("theme-dark"),document.body.classList.remove("theme-light")):(document.body.classList.add("theme-light"),document.body.classList.remove("theme-dark")),window.innerWidth<480?document.body.classList.add("is-phone"):window.innerWidth<768?document.body.classList.add("is-tablet"):window.innerWidth<1024?document.body.classList.add("is-small-screen"):document.body.classList.add("is-large-screen")</script><div class="webpage-container workspace"><div class="sidebar-left sidebar"><div class="sidebar-handle"></div><div class="sidebar-topbar"><div class="topbar-content"><label class="theme-toggle-container" for="theme_toggle"><input class="theme-toggle-input" type="checkbox" id="theme_toggle"><div class="toggle-background"></div></label></div><div class="clickable-icon sidebar-collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" class="svg-icon"><path d="M21 3H3C1.89543 3 1 3.89543 1 5V19C1 20.1046 1.89543 21 3 21H21C22.1046 21 23 20.1046 23 19V5C23 3.89543 22.1046 3 21 3Z"></path><path d="M10 4V20"></path><path d="M4 7H7"></path><path d="M4 10H7"></path><path d="M4 13H7"></path></svg></div></div><div class="sidebar-content"><div class="search-input-container"><input enterkeyhint="search" type="search" spellcheck="false" placeholder="Search..."><div class="search-input-clear-button" aria-label="Clear search"></div></div><include src="lib/html/file-tree.html"></include></div><script defer="">let ls = document.querySelector(".sidebar-left"); ls.classList.add("is-collapsed"); if (window.innerWidth > 768) ls.classList.remove("is-collapsed"); ls.style.setProperty("--sidebar-width", localStorage.getItem("sidebar-left-width"));</script></div><div class="document-container markdown-reading-view hide"><div class="markdown-preview-view markdown-rendered allow-fold-headings allow-fold-lists is-readable-line-width"><style id="MJX-CHTML-styles"></style><div class="markdown-preview-sizer markdown-preview-section"><h1 class="page-title heading inline-title" id="Refinement types in Scala 3"><p dir="auto">Refinement types in Scala 3</p></h1><div><p dir="auto">When familiarizing myself with additions in Scala 3, it was improvements in meta-programming capabilities that caught my eye. I wondered what it would take to implement a simple refinement types library. It is definitely not my plan to end up with a full-blown refinement library as <a data-tooltip-position="top" aria-label="https://github.com/fthomas/refined" rel="noopener" class="external-link" href="https://github.com/fthomas/refined" target="_blank">refined</a>, but only to understand if the language's new version can offer some improvements in the process.</p></div><div><p dir="auto">We will use literal types as a basic construct. The introduction of literal types was a subject of <a data-tooltip-position="top" aria-label="https://docs.scala-lang.org/sips/42.type.html" rel="noopener" class="external-link" href="https://docs.scala-lang.org/sips/42.type.html" target="_blank">SIP-23</a>, and they've been already included in Scala 2.13. They enable you to use literals of primitive types at places where types are expected:</p></div><div><pre><code>val a: 4 = 4
// val b: 5 = a // fails compilation with: 
// Found:    (a : (4 : Int))
// Required: (5 : Int)
</code><button class="copy-code-button">Copy</button></pre></div><div><p dir="auto">What Scala 3 adds to the mix are compile-time operators on literal types. You can found them in the <code>scala.compiletime</code> package:</p></div><div><pre><code>type PlusTwo[T &lt;: Int] = scala.compiletime.ops.int.+[2, T]

val a: PlusTwo[4] = 6
// val bb: PlusTwo[4] = 7 // fails compilation with:
// Found:    (7 : Int)
// Required: (6 : Int)
</code><button class="copy-code-button">Copy</button></pre></div><div><p dir="auto">In the definition of <code>PlusTwo</code> I wanted to stress that <code>+</code> is a type operator, hence the prefix notation. In practice infix operator might be more convenient:</p></div><div><pre><code>import scala.compiletime.ops.int.*

type PlusTwo[T &lt;: Int] = 2 + T
</code><button class="copy-code-button">Copy</button></pre></div><div><p dir="auto">One of operators available in <code>compiletime</code> is comparison operator <code>&lt;</code> which looks particularly useful in scope of refinement types:</p></div><div><pre><code>type &lt;[X &lt;: Int, Y &lt;: Int] &lt;: Boolean
</code><button class="copy-code-button">Copy</button></pre></div><div><p dir="auto">Here are some examples of its usage:</p></div><div><pre><code>val a: 5 &lt; 10 = true
// val b: 15 &lt; 10 = true // fails compilation with:
// Found:    (true : Boolean)
// Required: (false : Boolean)
</code><button class="copy-code-button">Copy</button></pre></div><div><p dir="auto">However, in context of refinement types we would like to use <code>&lt;</code> as a kind of type bound as opposed to just an operator returning Boolean. Therefore, while <code>&lt;</code> is definitely helpful, it's not sufficient by itself to express refinement types. We're striving for something akin to:</p></div><div><pre><code>// val a: Int &lt; 10 = 5 // fails compilation
</code><button class="copy-code-button">Copy</button></pre></div><div class="heading-wrapper"><h3 data-heading="Iteration 1" dir="auto" class="heading" id="Iteration_1"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>Iteration 1</h3><div class="heading-children"><div><p dir="auto">To be able to use comparison operators as a type bound we have to build some minimal structure:</p></div><div><pre><code>trait Validated[PredRes &lt;: Boolean]
given Validated[true] = new Validated[true] {}

trait RefinedInt[Predicate[_ &lt;: Int] &lt;: Boolean]
def validate[V &lt;: Int, Predicate[_ &lt;: Int] &lt;: Boolean]
    (using Validated[Predicate[V]]): RefinedInt[Predicate] = new RefinedInt {}
</code><button class="copy-code-button">Copy</button></pre></div><div><p dir="auto">The idea behind this is that code invoking <code>validate</code> will compile only if <code>Predicate[V]</code> evaluates to type <code>true</code>. Therefore, the whole business of validation will be offloaded to the second type parameter of <code>validate</code>.</p></div><div><p dir="auto">Such minimal structure is enough to express something like this:</p></div><div><pre><code>type LowerThan10[V &lt;: Int] = V &lt; 10
val lowerThan10: RefinedInt[LowerThan10] = validate[4, LowerThan10]
</code><button class="copy-code-button">Copy</button></pre></div><div><p dir="auto">An equivalent written with type lambda:</p></div><div><pre><code>val lowerThan10: RefinedInt[[V &lt;: Int] =&gt;&gt; V &lt; 10] = validate[4, [V &lt;: Int] =&gt;&gt; V &lt; 10]
</code><button class="copy-code-button">Copy</button></pre></div><div><p dir="auto">I must admit the latter looks uglier, but in general, it is preferred as it allows us to avoid coming up with an unnecessary type name.</p></div><div><p dir="auto">If you want to see how type lambdas are being used in the wild, I recommend taking a look at <a data-tooltip-position="top" aria-label="https://github.com/lampepfl/dotty/blob/master/library/src/scala/Tuple.scala#L139" rel="noopener" class="external-link" href="https://github.com/lampepfl/dotty/blob/master/library/src/scala/Tuple.scala#L139" target="_blank">type-level implementations</a> of <code>scala.Tuple</code> higher kinded types of <code>Filter</code> or <code>Fold</code>.</p></div><div><p dir="auto">This encoding, while very simplistic and not the most convenient to use, is quite flexible. Thanks to operators in <code>compiletime.ops.bool</code> we can build more complicated predicates as the following:</p></div><div><pre><code>import scala.compiletime.ops.boolean.*

validate[7, [V &lt;: Int] =&gt;&gt; V &gt; 5 &amp;&amp; V &lt; 10]
</code><button class="copy-code-button">Copy</button></pre></div><div><p dir="auto">If we try to pass incorrect input we will get a compilation error:</p></div><div><pre><code>validate[4, [V &lt;: Int] =&gt;&gt; V &gt; 5 &amp;&amp; V &lt; 10]
// no implicit argument of type iteration1.Validated[(false : Boolean)] was found for parameter x$2 of method validate in package iteration1
// L25:   validate[4, [V &lt;: Int] =&gt;&gt; V &gt; 5 &amp;&amp; V &lt; 10]
</code><button class="copy-code-button">Copy</button></pre></div><div><p dir="auto">The compilation error is not very helpful, especially compared to the message produced by <a data-tooltip-position="top" aria-label="https://github.com/fthomas/refined" rel="noopener" class="external-link" href="https://github.com/fthomas/refined" target="_blank">refined</a>:</p></div><div><pre><code>Left predicate of ((4 &gt; 5) &amp;&amp; (4 &lt; 10)) failed: Predicate failed: (4 &gt; 5).
</code><button class="copy-code-button">Copy</button></pre></div><div><p dir="auto">It's something we will work on in iteration 2. That being said, with just a few lines of code we were able to get that basic version working.</p></div></div></div><div class="heading-wrapper"><h3 data-heading="Iteration 2 - self-descriptive compilation errors" dir="auto" class="heading" id="Iteration_2_-_self-descriptive_compilation_errors"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>Iteration 2 - self-descriptive compilation errors</h3><div class="heading-children"><div><p dir="auto">Mechanisms we've used so far, <code>compiletime</code> operators and implicit resolution, are not enough to implement friendly validation errors. That's because the result of implicit resolution is binary - either the implicit had been found or not. We need richer information in case of failure.</p></div><div><p dir="auto">To do that, we will explore another new feature of Scala 3, which is <code>inline</code>.</p></div><div><p dir="auto">First, we need to define an ADT for predicates:</p></div><div><pre><code>sealed trait Pred
class And[A &lt;: Pred, B &lt;: Pred]         extends Pred
class Leaf                              extends Pred
class LowerThan[T &lt;: Int &amp; Singleton]   extends Leaf
class GreaterThan[T &lt;: Int &amp; Singleton] extends Leaf
</code><button class="copy-code-button">Copy</button></pre></div><div><p dir="auto">The only notable thing in the above is mixing in <code>Singleton</code>. It restricts type <code>T</code> into being a singleton type, so that <code>LowerThan[Int]</code> will not compile.</p></div><div><p dir="auto">Then, we have to interpret this ADT at compile-time:</p></div><div><pre><code>import scala.compiletime.*
import scala.compiletime.ops.int.*

trait Validated[E &lt;: Pred]

implicit inline def mkVal[V &lt;: Int &amp; Singleton, E &lt;: Pred](v: V): Validated[E] =
  inline erasedValue[E] match
    case _: LowerThan[t] =&gt;
      inline if constValue[V] &lt; constValue[t]
        then new Validated[E] {}
        else
          inline val vs    = constValue[ToString[V]]
          inline val limit = constValue[ToString[t]]
          error("Validation failed: " + vs + " &lt; " + limit)
    case _: GreaterThan[t] =&gt; // ommited here since it's symmetrical to LowerThan
    case _: And[a, b] =&gt;
      inline mkVal[V, a](v) match
        case _: Validated[_] =&gt;
          inline mkVal[V, b](v) match
            case _: Validated[_] =&gt; new Validated[E] {}
</code><button class="copy-code-button">Copy</button></pre></div><div><p dir="auto">There are a few things worth noting here:</p></div><div><ul>
<li data-line="0" dir="auto">
<p><code>mkVal</code> has an <code>inline</code> modifier which tells the compiler that it should inline any invocation of this method at compile-time. If it's not possible, compiler will fail the compilation</p>
</li>
<li data-line="2" dir="auto">
<p><code>erasedValue</code> comes from <code>compiletime</code> package. It's usually used in tandem with inline match. It allows us to match on the expression type, but we cannot access extracted value as that code is executed at compile-time</p>
</li>
<li data-line="4" dir="auto">
<p>You could have noticed a lower-case letter used for the type parameter in <code>case _: LowerThan[t]</code>, something against the usual convention. That was not a choice though. In Scala 3 you must use a lower-case identifier for a type being extracted from a pattern match. Using <code>case _: LowerThan[T]</code> would mean that the match would succeed only if <code>LowerThan</code> is parametrized with an already known type <code>T</code>. I like to compare that to term-level pattern match in which there's also a distinction between <code>case a =&gt;</code> and <code>case `a` =&gt;</code>, which in regards to types becomes <code>case _: V[a]</code> and <code>case _: V[A]</code> respectively</p>
</li>
<li data-line="6" dir="auto">
<p><code>constValue</code> comes from <code>compiletime</code> too. It returns the value of a singleton type</p>
</li>
<li data-line="8" dir="auto">
<p><code>ToString</code> is a type-level counterpart of <code>toString</code> available only for singleton types of Int, so that <code>val a: ToString[5] = "5"</code> holds</p>
</li>
<li data-line="10" dir="auto">
<p>Calling <code>error</code> fails the compilation with provided message. In Scala 3.0.0 it cannot be invoked with interpolated string, yet it might be <a data-tooltip-position="top" aria-label="https://github.com/lampepfl/dotty/issues/10315" rel="noopener" class="external-link" href="https://github.com/lampepfl/dotty/issues/10315" target="_blank">possible in future</a>.</p>
</li>
<li data-line="12" dir="auto">
<p><code>mkVal</code> is defined as an implicit conversion so it will never be called explicitly</p>
</li>
</ul></div><div><p dir="auto">Once you got acquainted with these new Scala constructs, the code should not be hard to follow. The great news is that it's all it takes to have reasonable refinements types for Int <a data-tooltip-position="top" aria-label="https://msitko.pl/blog/build-your-own-refinement-types-in-scala3.html#footnote1" rel="noopener" class="external-link" href="https://msitko.pl/blog/build-your-own-refinement-types-in-scala3.html#footnote1" target="_blank">1</a>. Let's try it out:</p></div><div><pre><code>val a: Validated[LowerThan[10]] = 6
val b: Validated[GreaterThan[5] And LowerThan[10]] = 6

// val y: Validated[GreaterThan[5] And LowerThan[10]] = 1
// fails with:
// Validation failed: 1 &gt; 5
</code><button class="copy-code-button">Copy</button></pre></div><div class="heading-wrapper"><h4 data-heading="A note on testing" dir="auto" class="heading" id="A_note_on_testing"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>A note on testing</h4><div class="heading-children"><div><p dir="auto">Since the core functionality of refined boils down to preventing some code from being compiled, we have to specify negative test cases as code snippets that do not compile. In Scala 3 there's a built-in operation for that: <code>scala.compiletime.testing.typeCheckErrors</code>. We can employ it to write assertions:</p></div><div><pre><code>import scala.compiletime.testing.typeCheckErrors

class IntSpec extends munit.FunSuite:
  test("Those should not compile") {
    val errs = typeCheckErrors("val x: Validated[LowerThan[10]] = 16")
    assertEquals(errs.map(_.message), List("Validation failed: 16 &lt; 10"))
  }
</code><button class="copy-code-button">Copy</button></pre></div><div><p dir="auto">If you're interested in cross-compiling your code you would be better off using munit's <code>compilerErrors</code> which for Scala 3 <a data-tooltip-position="top" aria-label="https://github.com/scalameta/munit/blob/7761b08fcf34396d90b22b1d086bdfd05bb733b0/munit/shared/src/main/scala-3/munit/internal/MacroCompat.scala#L38" rel="noopener" class="external-link" href="https://github.com/scalameta/munit/blob/7761b08fcf34396d90b22b1d086bdfd05bb733b0/munit/shared/src/main/scala-3/munit/internal/MacroCompat.scala#L38" target="_blank">uses</a> said built-in.</p></div><div><p dir="auto">Once we have an implementation for Int, it would be interesting to do the same for String.</p></div></div></div></div></div><div class="heading-wrapper"><h3 data-heading="Iteration 3 - moving beyond Int validation" dir="auto" class="heading" id="Iteration_3_-_moving_beyond_Int_validation"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>Iteration 3 - moving beyond Int validation</h3><div class="heading-children"><div><p dir="auto">We will use the following as a motivating example:</p></div><div><pre><code>val a: String Refined StartsWith["abc"] = "abcd"
</code><button class="copy-code-button">Copy</button></pre></div><div><p dir="auto">We had to add another type parameter in addition to the predicate. To express that that <code>Refined[T, Predicate]</code> type was introduced. You can find the whole code of that <a data-tooltip-position="top" aria-label="https://github.com/note/blog-examples/tree/master/build-your-own-refinement-types-in-scala3/src/main/scala/iteration3" rel="noopener" class="external-link" href="https://github.com/note/blog-examples/tree/master/build-your-own-refinement-types-in-scala3/src/main/scala/iteration3" target="_blank">iteration</a> in the accompanying repository. However, most of it is a straightforward structure not related to metaprogramming so we will jump right to the relevant bits instead.</p></div><div><p dir="auto">What's interesting is how to actually implement <code>StartsWith</code> predicate at compile-time.</p></div><div><p dir="auto">The first attempt might be to do the same thing that was done with Int:</p></div><div><pre><code>transparent inline def checkPredString[V &lt;: String &amp; Singleton, E &lt;: Pred]: Boolean =
    inline erasedValue[E] match
      case _: StartsWith[t] =&gt;
        inline if constValue[V].startsWith(constValue[t])
        ...
</code><button class="copy-code-button">Copy</button></pre></div><div><p dir="auto">If we try to invoke it, it will end up with such compilation error:</p></div><div><pre><code>Cannot reduce `inline if` because its condition is not a constant value: "abcd".startsWith("abc")
</code><button class="copy-code-button">Copy</button></pre></div><div><p dir="auto">The problem is that we're trying to call non-inline method <code>startsWith</code> from an inline method. Since compiler cannot reduce <code>startsWith</code> it just cannot be invoked there.</p></div><div><p dir="auto">The solution to that problem is writing a simple macro:</p></div><div><pre><code>transparent inline def startsWith(inline v: String, inline pred: String): Boolean =
    ${ startsWithC('v, 'pred)  }

def startsWithC(v: Expr[String], pred: Expr[String])(using Quotes): Expr[Boolean] =
    val res = v.valueOrError.startsWith(pred.valueOrError)
    Expr(res)
</code><button class="copy-code-button">Copy</button></pre></div><div><p dir="auto">In the macro implementation (i.e. <code>startsWithC</code>) we are not limited to calling only inline methods; therefore, we can call <code>String.startsWith</code>. From my limited experience with Scala 3 macros, the tricky part is to get a value of type <code>T</code> from <code>Expr[T]</code> for non-primitive types.</p></div><div><p dir="auto">We can freely call macro <code>startsWith</code> from the inline method checkPredString which completes our exercise.</p></div><div class="heading-wrapper"><h4 data-heading="Why `startsWith` has to be transparent" dir="auto" class="heading" id="Why_`startsWith`_has_to_be_transparent"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>Why <code>startsWith</code> has to be transparent</h4><div class="heading-children"><div><p dir="auto">Another new Scala 3 feature used in the macro definition is modifier <code>transparent</code>. When it's used in inline method signature <a data-tooltip-position="top" aria-label="https://msitko.pl/blog/build-your-own-refinement-types-in-scala3.html#footnote2" rel="noopener" class="external-link" href="https://msitko.pl/blog/build-your-own-refinement-types-in-scala3.html#footnote2" target="_blank">2</a>, it allows compiler to specialize return type to a more precise type.</p></div><div><p dir="auto">Getting back to our example, let's take a look at how <code>checkPredString</code> is used:</p></div><div><pre><code>implicit inline def mkValString[V &lt;: String &amp; Singleton, E &lt;: Pred](v: V): Refined[V, E] =
    inline if checkPredString[V, E]
    then Refined.unsafeApply(v)
    else error("Validation failed")
</code><button class="copy-code-button">Copy</button></pre></div><div><p dir="auto">If we remove <code>transparent</code> from <code>checkPredString</code> signature the above code would fail compilation with that message:</p></div><div><pre><code>Cannot reduce `inline if` because its condition is not a constant value: (true:Boolean).&amp;&amp;(true:Boolean):Boolean
</code><button class="copy-code-button">Copy</button></pre></div><div><p dir="auto">Without <code>transparent</code> compiler sees return type of <code>checkPredString</code> as a Boolean which is not enough to inline the code. In contrast to that, with <code>transparent</code>, it would be a concrete type <code>true</code> or <code>false</code> depending on the validation result.</p></div></div></div></div></div><div class="heading-wrapper"><h3 data-heading="Summary" dir="auto" class="heading" id="Summary"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>Summary</h3><div class="heading-children"><div><p dir="auto">We've ended up with a code supporting simple compile-time predicates for Int and String with very few lines of code. If you're familiar with Scala 3 metaprogramming building blocks such as inline, the code is straigforward to read. Of course, compared to real refinement types libraries there are many capabilities missing, like predicates inference or runtime lifting to refined types. This is something I explore in <a data-tooltip-position="top" aria-label="https://github.com/note/mini-refined" rel="noopener" class="external-link" href="https://github.com/note/mini-refined" target="_blank">mini-refined</a>.</p></div><div><p dir="auto">If you're interested more in Scala 3 metaprogramming capabilities, explore links in the next section.</p></div></div></div><div class="heading-wrapper"><h3 data-heading="More resources" dir="auto" class="heading" id="More_resources"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>More resources</h3><div class="heading-children"><div><ul>
<li data-line="0" dir="auto"><a data-tooltip-position="top" aria-label="https://github.com/note/blog-examples/tree/master/build-your-own-refinement-types-in-scala3" rel="noopener" class="external-link" href="https://github.com/note/blog-examples/tree/master/build-your-own-refinement-types-in-scala3" target="_blank">full source code</a> of examples presented in this article</li>
<li data-line="1" dir="auto"><a data-tooltip-position="top" aria-label="http://dotty.epfl.ch/docs/reference/metaprogramming/toc.html" rel="noopener" class="external-link" href="http://dotty.epfl.ch/docs/reference/metaprogramming/toc.html" target="_blank">Scala 3 documentation</a> on metaprogramming</li>
<li data-line="2" dir="auto"><a data-tooltip-position="top" aria-label="https://www.youtube.com/watch?v=OPBuCQRgyV4" rel="noopener" class="external-link" href="https://www.youtube.com/watch?v=OPBuCQRgyV4" target="_blank">talk</a> by Josh Suereth on inline</li>
<li data-line="3" dir="auto"><a data-tooltip-position="top" aria-label="https://github.com/note/mini-refined" rel="noopener" class="external-link" href="https://github.com/note/mini-refined" target="_blank">mini-refined</a> - project exploring further ideas proposed in this article</li>
</ul></div><div><p dir="auto">1: One thing might bother you in the method signature itself:</p></div><div><pre><code>implicit inline def mkVal[V &lt;: Int &amp; Singleton, E &lt;: Pred](v: V): Validated[E]
</code><button class="copy-code-button">Copy</button></pre></div><div><p dir="auto">Why do we provide value being validated both on type-level and on term-level? Wouldn't such signature suffice:</p></div><div><pre><code>implicit inline def mkVal[E &lt;: Pred](v: Int &amp; Singleton): Validated[E]
</code><button class="copy-code-button">Copy</button></pre></div><div><p dir="auto">Given the new signature we just need to replace all <code>constValue[V]</code> in the previous implementation with <code>v</code> and that's it, right?</p></div><div><p dir="auto">The answer is <em>mostly yes</em>. It would compile indeed but whenever you call <code>mkVal</code> with a value failing validation, instead of a nice error message you would get:</p></div><div><pre><code>"A literal string is expected as an argument to `compiletime.error`. Got \"Validation failed: \".+(4).+(\" &lt; \").+(limit)
</code><button class="copy-code-button">Copy</button></pre></div><div><p dir="auto">The issue, again, is lack of <a data-tooltip-position="top" aria-label="https://github.com/lampepfl/dotty/issues/10315" rel="noopener" class="external-link" href="https://github.com/lampepfl/dotty/issues/10315" target="_blank">constant folding</a> which occurs in this line:</p></div><div><pre><code>error("Validation failed: " + v + " &lt; " + limit)
</code><button class="copy-code-button">Copy</button></pre></div><div><p dir="auto"><em>Reminder - in the previous version we used <code>constValue[V]</code> instead of just <code>v</code></em>. Therefore, at least for now, we have to duplicate validated value on both type- and term-level. <a data-tooltip-position="top" aria-label="https://msitko.pl/blog/build-your-own-refinement-types-in-scala3.html#afootnote1" rel="noopener" class="external-link" href="https://msitko.pl/blog/build-your-own-refinement-types-in-scala3.html#afootnote1" target="_blank">↩</a></p></div><div><p dir="auto">2: <code>transparent</code> can be also used in <a data-tooltip-position="top" aria-label="https://dotty.epfl.ch/docs/reference/other-new-features/transparent-traits.html#transparent-traits" rel="noopener" class="external-link" href="https://dotty.epfl.ch/docs/reference/other-new-features/transparent-traits.html#transparent-traits" target="_blank">conjunction with traits</a>, in which case it has entirely</p></div><div class="mod-footer"></div></div></div></div></div></div><div class="sidebar-right sidebar"><div class="sidebar-handle"></div><div class="sidebar-topbar"><div class="topbar-content"></div><div class="clickable-icon sidebar-collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" class="svg-icon"><path d="M21 3H3C1.89543 3 1 3.89543 1 5V19C1 20.1046 1.89543 21 3 21H21C22.1046 21 23 20.1046 23 19V5C23 3.89543 22.1046 3 21 3Z"></path><path d="M10 4V20"></path><path d="M4 7H7"></path><path d="M4 10H7"></path><path d="M4 13H7"></path></svg></div></div><div class="sidebar-content"><div class="graph-view-wrapper"><div class="sidebar-section-header">Interactive Graph</div><div class="graph-view-placeholder">
		<div class="graph-view-container">
			<div class="graph-icon graph-expand" role="button" aria-label="Expand" data-tooltip-position="top"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon"><line x1="7" y1="17" x2="17" y2="7"></line><polyline points="7 7 17 7 17 17"></polyline></svg></div>
			<canvas id="graph-canvas" class="hide" width="512px" height="512px"></canvas>
		</div>
		</div></div><div class="tree-container mod-root nav-folder tree-item outline-tree" data-depth="0"><div class="tree-header"><span class="sidebar-section-header">Table Of Contents</span><button class="clickable-icon collapse-tree-button" aria-label="Collapse All"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></svg></button></div><div class="tree-scroll-area tree-item-children nav-folder-children"><div class="tree-item mod-tree-folder nav-folder mod-collapsible is-collapsed" style="display: none;"></div><div class="tree-item" data-depth="1"><a class="tree-link" href="computer-science/programming-language/scala/refinement-types-in-scala-3.html#Refinement types in Scala 3"><div class="tree-item-contents heading-link" heading-name="Refinement types in Scala 3"><span class="tree-item-title">Refinement types in Scala 3</span></div></a><div class="tree-item-children nav-folder-children"><div class="tree-item" data-depth="3"><a class="tree-link" href="computer-science/programming-language/scala/refinement-types-in-scala-3.html#Iteration_1"><div class="tree-item-contents heading-link" heading-name="Iteration 1"><span class="tree-item-title">Iteration 1</span></div></a><div class="tree-item-children nav-folder-children"></div></div><div class="tree-item" data-depth="3"><a class="tree-link" href="computer-science/programming-language/scala/refinement-types-in-scala-3.html#Iteration_2_-_self-descriptive_compilation_errors"><div class="tree-item-contents heading-link" heading-name="Iteration 2 - self-descriptive compilation errors"><span class="tree-item-title">Iteration 2 - self-descriptive compilation errors</span></div></a><div class="tree-item-children nav-folder-children"></div></div><div class="tree-item" data-depth="4"><a class="tree-link" href="computer-science/programming-language/scala/refinement-types-in-scala-3.html#A_note_on_testing"><div class="tree-item-contents heading-link" heading-name="A note on testing"><span class="tree-item-title">A note on testing</span></div></a><div class="tree-item-children nav-folder-children"></div></div><div class="tree-item" data-depth="3"><a class="tree-link" href="computer-science/programming-language/scala/refinement-types-in-scala-3.html#Iteration_3_-_moving_beyond_Int_validation"><div class="tree-item-contents heading-link" heading-name="Iteration 3 - moving beyond Int validation"><span class="tree-item-title">Iteration 3 - moving beyond Int validation</span></div></a><div class="tree-item-children nav-folder-children"></div></div><div class="tree-item" data-depth="4"><a class="tree-link" href="computer-science/programming-language/scala/refinement-types-in-scala-3.html#Why_`startsWith`_has_to_be_transparent"><div class="tree-item-contents heading-link" heading-name="Why `startsWith` has to be transparent"><span class="tree-item-title">Why <code>startsWith</code> has to be transparent</span></div></a><div class="tree-item-children nav-folder-children"></div></div><div class="tree-item" data-depth="3"><a class="tree-link" href="computer-science/programming-language/scala/refinement-types-in-scala-3.html#Summary"><div class="tree-item-contents heading-link" heading-name="Summary"><span class="tree-item-title">Summary</span></div></a><div class="tree-item-children nav-folder-children"></div></div><div class="tree-item" data-depth="3"><a class="tree-link" href="computer-science/programming-language/scala/refinement-types-in-scala-3.html#More_resources"><div class="tree-item-contents heading-link" heading-name="More resources"><span class="tree-item-title">More resources</span></div></a><div class="tree-item-children nav-folder-children"></div></div></div></div></div></div></div><script defer="">let rs = document.querySelector(".sidebar-right"); rs.classList.add("is-collapsed"); if (window.innerWidth > 768) rs.classList.remove("is-collapsed"); rs.style.setProperty("--sidebar-width", localStorage.getItem("sidebar-right-width"));</script></div></div></body></html>