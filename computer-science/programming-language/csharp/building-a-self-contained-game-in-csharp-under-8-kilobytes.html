<html><head>
		<title>Building a self-contained game in CSharp under 8 kilobytes</title>
		<base href="../../../">
		<meta id="root-path" root-path="../../../">
		<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes, minimum-scale=1.0, maximum-scale=5.0">
		<meta charset="UTF-8">
		<meta name="description" content="韩暮秋的个人维基 - Building a self-contained game in CSharp under 8 kilobytes">
		<meta property="og:title" content="Building a self-contained game in CSharp under 8 kilobytes">
		<meta property="og:description" content="韩暮秋的个人维基 - Building a self-contained game in CSharp under 8 kilobytes">
		<meta property="og:type" content="website">
		<meta property="og:url" content="https://muqiuhan.github.io/wiki/computer-science/programming-language/csharp/building-a-self-contained-game-in-csharp-under-8-kilobytes.html">
		<meta property="og:image" content="https://migeel.sk/blog/2020/01/03/building-a-self-contained-game-in-csharp-under-8-kilobytes/01-floppies.jpg">
		<meta property="og:site_name" content="韩暮秋的个人维基">
		<meta name="author" content="韩暮秋"><script async="" id="webpage-script" src="lib/scripts/webpage.js" onload="this.onload=null;this.setAttribute(&quot;loaded&quot;, &quot;true&quot;)"></script><script type="module" async="" id="graph-view-script" src="lib/scripts/graph-view.js"></script><script async="" id="graph-wasm-script" src="lib/scripts/graph-wasm.js" onload="this.onload=null;this.setAttribute(&quot;loaded&quot;, &quot;true&quot;)"></script><script async="" id="graph-render-worker-script" src="lib/scripts/graph-render-worker.js" onload="this.onload=null;this.setAttribute(&quot;loaded&quot;, &quot;true&quot;)"></script><script async="" id="tinycolor-script" src="lib/scripts/tinycolor.js" onload="this.onload=null;this.setAttribute(&quot;loaded&quot;, &quot;true&quot;)"></script><script async="" id="pixi-script" src="lib/scripts/pixi.js" onload="this.onload=null;this.setAttribute(&quot;loaded&quot;, &quot;true&quot;)"></script><script async="" id="minisearch-script" src="lib/scripts/minisearch.js" onload="this.onload=null;this.setAttribute(&quot;loaded&quot;, &quot;true&quot;)"></script><link rel="icon" href="lib/media/favicon.jpg"><script async="" id="graph-data-script" src="lib/scripts/graph-data.js" onload="this.onload=null;this.setAttribute(&quot;loaded&quot;, &quot;true&quot;)"></script><style>body{--line-width:40em;--line-width-adaptive:40em;--file-line-width:40em;--sidebar-width:min(20em, 80vw);--collapse-arrow-size:11px;--tree-horizontal-spacing:0.6em;--tree-vertical-spacing:0.6em;--sidebar-margin:12px}.sidebar{height:100%;min-width:calc(var(--sidebar-width) + var(--divider-width-hover));max-width:calc(var(--sidebar-width) + var(--divider-width-hover));font-size:14px;z-index:10;position:relative;overflow:hidden;transition:min-width ease-in-out,max-width ease-in-out;transition-duration:.2s;contain:size}.sidebar-left{left:0}.sidebar-right{right:0}.sidebar.is-collapsed{min-width:0;max-width:0}body.floating-sidebars .sidebar{position:absolute}.sidebar-content{height:100%;min-width:calc(var(--sidebar-width) - var(--divider-width-hover));top:0;padding:var(--sidebar-margin);padding-top:4em;line-height:var(--line-height-tight);background-color:var(--background-secondary);transition:background-color,border-right,border-left,box-shadow;transition-duration:var(--color-fade-speed);transition-timing-function:ease-in-out;position:absolute;display:flex;flex-direction:column}.sidebar:not(.is-collapsed) .sidebar-content{min-width:calc(max(100%,var(--sidebar-width)) - 3px);max-width:calc(max(100%,var(--sidebar-width)) - 3px)}.sidebar-left .sidebar-content{left:0;border-top-right-radius:var(--radius-l);border-bottom-right-radius:var(--radius-l)}.sidebar-right .sidebar-content{right:0;border-top-left-radius:var(--radius-l);border-bottom-left-radius:var(--radius-l)}.sidebar:has(.sidebar-content:empty):has(.topbar-content:empty){display:none}.sidebar-topbar{height:2em;width:var(--sidebar-width);top:var(--sidebar-margin);padding-inline:var(--sidebar-margin);z-index:1;position:fixed;display:flex;align-items:center;transition:width ease-in-out;transition-duration:inherit}.sidebar.is-collapsed .sidebar-topbar{width:calc(2.3em + var(--sidebar-margin) * 2)}.sidebar .sidebar-topbar.is-collapsed{width:0}.sidebar-left .sidebar-topbar{left:0}.sidebar-right .sidebar-topbar{right:0}.topbar-content{overflow:hidden;overflow:clip;width:100%;height:100%;display:flex;align-items:center;transition:inherit}.sidebar.is-collapsed .topbar-content{width:0;transition:inherit}.clickable-icon.sidebar-collapse-icon{background-color:transparent;color:var(--icon-color-focused);padding:0!important;margin:0!important;height:100%!important;width:2.3em!important;margin-inline:0.14em!important;position:absolute}.sidebar-left .clickable-icon.sidebar-collapse-icon{transform:rotateY(180deg);right:var(--sidebar-margin)}.sidebar-right .clickable-icon.sidebar-collapse-icon{transform:rotateY(180deg);left:var(--sidebar-margin)}.clickable-icon.sidebar-collapse-icon svg.svg-icon{width:100%;height:100%}.sidebar-section-header{margin:0 0 1em 0;text-transform:uppercase;letter-spacing:.06em;font-weight:600}body{transition:background-color var(--color-fade-speed) ease-in-out}.webpage-container{display:flex;flex-direction:row;height:100%;width:100%;align-items:stretch;justify-content:center}.document-container{opacity:1;flex-basis:100%;max-width:100%;width:100%;height:100%;display:flex;flex-direction:column;align-items:center;transition:opacity .2s ease-in-out;contain:inline-size}.hide{opacity:0;transition:opacity .2s ease-in-out}.document-container>.markdown-preview-view{margin:var(--sidebar-margin);margin-bottom:0;width:100%;width:-webkit-fill-available;width:-moz-available;width:fill-available;background-color:var(--background-primary);transition:background-color var(--color-fade-speed) ease-in-out;border-top-right-radius:var(--window-radius,var(--radius-m));border-top-left-radius:var(--window-radius,var(--radius-m));overflow-x:hidden!important;overflow-y:auto!important;display:flex!important;flex-direction:column!important;align-items:center!important;contain:inline-size}.document-container>.markdown-preview-view>.markdown-preview-sizer{padding-bottom:80vh!important;width:100%!important;max-width:var(--line-width)!important;flex-basis:var(--line-width)!important;transition:background-color var(--color-fade-speed) ease-in-out;contain:inline-size}.markdown-rendered img:not([width]),.view-content img:not([width]){max-width:100%;outline:0}.document-container>.view-content.embed{display:flex;padding:1em;height:100%;width:100%;align-items:center;justify-content:center}.document-container>.view-content.embed>*{max-width:100%;max-height:100%;object-fit:contain}:has(> :is(.math,table)){overflow-x:auto!important}.document-container>.view-content{overflow-x:auto;contain:content;padding:0;margin:0;height:100%}.scroll-highlight{position:absolute;width:100%;height:100%;pointer-events:none;z-index:1000;background-color:hsla(var(--color-accent-hsl),.25);opacity:0;padding:1em;inset:50%;translate:-50% -50%;border-radius:var(--radius-s)}</style><script defer="">async function loadIncludes(){if("file:"!=location.protocol){let e=document.querySelectorAll("include");for(let t=0;t<e.length;t++){let o=e[t],l=o.getAttribute("src");try{const e=await fetch(l);if(!e.ok){console.log("Could not include file: "+l),o?.remove();continue}let t=await e.text(),n=document.createRange().createContextualFragment(t),i=Array.from(n.children);for(let e of i)e.classList.add("hide"),e.style.transition="opacity 0.5s ease-in-out",setTimeout((()=>{e.classList.remove("hide")}),10);o.before(n),o.remove(),console.log("Included file: "+l)}catch(e){o?.remove(),console.log("Could not include file: "+l,e);continue}}}else{if(document.querySelectorAll("include").length>0){var e=document.createElement("div");e.id="error",e.textContent="Web server exports must be hosted on an http / web server to be viewed correctly.",e.style.position="fixed",e.style.top="50%",e.style.left="50%",e.style.transform="translate(-50%, -50%)",e.style.fontSize="1.5em",e.style.fontWeight="bold",e.style.textAlign="center",document.body.appendChild(e),document.querySelector(".document-container")?.classList.remove("hide")}}}document.addEventListener("DOMContentLoaded",(()=>{loadIncludes()}));let isFileProtocol="file:"==location.protocol;function waitLoadScripts(e,t){let o=e.map((e=>document.getElementById(e+"-script"))),l=0;!function e(){let n=o[l];l++,n&&"true"!=n.getAttribute("loaded")||l<o.length&&e(),l<o.length?n.addEventListener("load",e):t()}()}</script><link rel="stylesheet" href="lib/styles/obsidian.css"><link rel="preload" href="lib/styles/other-plugins.css" as="style" onload="this.onload=null;this.rel='stylesheet'"><noscript><link rel="stylesheet" href="lib/styles/other-plugins.css"></noscript><link rel="stylesheet" href="lib/styles/theme.css"><link rel="preload" href="lib/styles/global-variable-styles.css" as="style" onload="this.onload=null;this.rel='stylesheet'"><noscript><link rel="stylesheet" href="lib/styles/global-variable-styles.css"></noscript><link rel="preload" href="lib/styles/supported-plugins.css" as="style" onload="this.onload=null;this.rel='stylesheet'"><noscript><link rel="stylesheet" href="lib/styles/supported-plugins.css"></noscript><link rel="preload" href="lib/styles/main-styles.css" as="style" onload="this.onload=null;this.rel='stylesheet'"><noscript><link rel="stylesheet" href="lib/styles/main-styles.css"></noscript></head><body class="publish css-settings-manager theme-light show-inline-title show-ribbon show-file-explorer-navigation"><script defer="">let theme=localStorage.getItem("theme")||(window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light");"dark"==theme?(document.body.classList.add("theme-dark"),document.body.classList.remove("theme-light")):(document.body.classList.add("theme-light"),document.body.classList.remove("theme-dark")),window.innerWidth<480?document.body.classList.add("is-phone"):window.innerWidth<768?document.body.classList.add("is-tablet"):window.innerWidth<1024?document.body.classList.add("is-small-screen"):document.body.classList.add("is-large-screen")</script><div class="webpage-container workspace"><div class="sidebar-left sidebar"><div class="sidebar-handle"></div><div class="sidebar-topbar"><div class="topbar-content"><label class="theme-toggle-container" for="theme_toggle"><input class="theme-toggle-input" type="checkbox" id="theme_toggle"><div class="toggle-background"></div></label></div><div class="clickable-icon sidebar-collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" class="svg-icon"><path d="M21 3H3C1.89543 3 1 3.89543 1 5V19C1 20.1046 1.89543 21 3 21H21C22.1046 21 23 20.1046 23 19V5C23 3.89543 22.1046 3 21 3Z"></path><path d="M10 4V20"></path><path d="M4 7H7"></path><path d="M4 10H7"></path><path d="M4 13H7"></path></svg></div></div><div class="sidebar-content"><div class="search-input-container"><input enterkeyhint="search" type="search" spellcheck="false" placeholder="Search..."><div class="search-input-clear-button" aria-label="Clear search"></div></div><include src="lib/html/file-tree.html"></include></div><script defer="">let ls = document.querySelector(".sidebar-left"); ls.classList.add("is-collapsed"); if (window.innerWidth > 768) ls.classList.remove("is-collapsed"); ls.style.setProperty("--sidebar-width", localStorage.getItem("sidebar-left-width"));</script></div><div class="document-container markdown-reading-view hide"><div class="markdown-preview-view markdown-rendered allow-fold-headings allow-fold-lists is-readable-line-width"><style id="MJX-CHTML-styles"></style><div class="markdown-preview-sizer markdown-preview-section"><h1 class="page-title heading inline-title" id="Building a self-contained game in CSharp under 8 kilobytes"><p dir="auto">Building a self-contained game in CSharp under 8 kilobytes</p></h1><div><p dir="auto"><a href="?query=tag:csharp" class="tag" target="_blank" rel="noopener">#csharp</a> <a href="?query=tag:game" class="tag" target="_blank" rel="noopener">#game</a></p></div><div class="heading-wrapper"><h3 data-heading="How I fit a Snake game in C# into 8 kilobytes, with no .NET runtime required." dir="auto" class="heading" id="How_I_fit_a_Snake_game_in_C#_into_8_kilobytes,_with_no_.NET_runtime_required."><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>How I fit a Snake game in C# into 8 kilobytes, with no .NET runtime required.</h3><div class="heading-children"><div><p dir="auto">Jan 03, 2020</p></div><div><p dir="auto">28 minute read</p></div><div><blockquote dir="auto">
<p>NOTE: This article captures a point in time in the past. While the general information is still correct, the CoreRT project got folded into <a data-tooltip-position="top" aria-label="https://learn.microsoft.com/dotnet/core/deploying/native-aot/" rel="noopener" class="external-link" href="https://learn.microsoft.com/dotnet/core/deploying/native-aot/" target="_blank">Native AOT publishing</a> in .NET 7 and is now a supported part of .NET. The information about sizes is no longer accurate (and much better), neither is the information about support for dynamic code (both interpreter and JIT are unsupported).</p>
</blockquote></div><div><p dir="auto">As someone who grew up in the times of 1.44 MB floppy disks and 56 kbit modems, I’ve always liked small programs. I could fit many small programs on a floppy disk I carried with me. If a program couldn’t fit on my floppy disk, I started thinking about why - does it have a lot of graphics? Is there music? Can the program do many complex things? Or is it simply <em>bloated</em>?</p></div><div><p dir="auto"><a data-tooltip-position="top" aria-label="https://migeel.sk/blog/2020/01/03/building-a-self-contained-game-in-csharp-under-8-kilobytes/01-floppies.jpg" rel="noopener" class="external-link" href="https://migeel.sk/blog/2020/01/03/building-a-self-contained-game-in-csharp-under-8-kilobytes/01-floppies.jpg" target="_blank"><img alt="3.5&quot; floppies, photo by Brett Jordan on Unsplash" src="https://migeel.sk/blog/2020/01/03/building-a-self-contained-game-in-csharp-under-8-kilobytes/01-floppies.jpg" referrerpolicy="no-referrer"></a></p></div><div><p dir="auto">3.5" floppies, photo by Brett Jordan on Unsplash</p></div><div><p dir="auto">These days, disk space became so cheap (and huge flashdrives so ubiquitous) that people gave up on optimizing for size.</p></div><div><p dir="auto">One place where size still matters is transfers: when transferring a program over a wire, megabytes equate to seconds. A fast 100 MBit connection can only push through 12 megabytes per second in the best case. If on the other end of the wire is a person waiting for a download to finish, the difference between five seconds and one second can have meaningful impact on their experience.</p></div><div><p dir="auto">The person could be exposed to the transfer times either directly (user is downloading a program over network), or indirectly (a serverless service is getting deployed to respond to a web request).</p></div><div><p dir="auto">People typically perceive anything faster than 0.1 seconds as instant, 3.0 seconds is about the limit for user’s flow to stay uninterrupted, and you would have a hard time to keep the user engaged after 10 seconds.</p></div><div><blockquote dir="auto">
<p>While smaller is not essential anymore, it’s still <em>better</em>.</p>
</blockquote></div><div><p dir="auto">This article came out as an experiment to find out just how small a useful self-contained C# executable can be. Can C# apps hit the sizes where users would consider the download times <em>instant</em>? Would it enable C# to be used in places where it isn’t used right now?</p></div></div></div><div class="heading-wrapper"><h1 data-heading="What exactly is “self-contained”?" dir="auto" class="heading" id="What_exactly_is_“self-contained”?">What exactly is “self-contained”?</h1><div class="heading-children"><div><p dir="auto">A self-contained application is an application that includes everything that’s necessary for it to run on a vanilla installation of the operating system.</p></div><div><p dir="auto">The C# compiler belongs to a group of compilers targeting a virtual machine (Java and Kotlin being another notable members of the group): the output of the C# compiler is an executable that requires some sort of virtual machine (VM) to execute. One can’t just install a barebone operating system and expect to be able to run programs produced by the C# compiler on it.</p></div><div><p dir="auto">At least on Windows, it used to be the case that one could rely on a machine-wide installation of the .NET Framework to run the outputs of the C# compiler. Nowadays there are many Windows SKUs that no longer carry the framework with it (IoT, Nano Server, ARM64,…). .NET Framework also doesn’t support the latest enhancements to the C# language. It’s kind of on its way out.</p></div><div><p dir="auto">For a C# app to be self-contained, it needs to include the runtime and all the class libraries it uses. It’s a lot of stuff to fit into the 8 kB that we budget for!</p></div></div></div><div class="heading-wrapper"><h1 data-heading="The 8 kB game" dir="auto" class="heading" id="The_8_kB_game">The 8 kB game</h1><div class="heading-children"><div><p dir="auto">We’re going to build a clone of the Snake game. Here’s the finished product:</p></div><div><p dir="auto"><a data-tooltip-position="top" aria-label="https://migeel.sk/blog/2020/01/03/building-a-self-contained-game-in-csharp-under-8-kilobytes/02-snake.gif" rel="noopener" class="external-link" href="https://migeel.sk/blog/2020/01/03/building-a-self-contained-game-in-csharp-under-8-kilobytes/02-snake.gif" target="_blank"><img alt="Snake game" src="https://migeel.sk/blog/2020/01/03/building-a-self-contained-game-in-csharp-under-8-kilobytes/02-snake.gif" referrerpolicy="no-referrer"></a></p></div><div><p dir="auto">Snake game</p></div><div><p dir="auto">If you’re not interested in the game mechanics, feel free to skip over to the interesting parts where we shrink the game from <strong>65 megabytes</strong> to <strong>8 kilobytes</strong> in 9 steps (scroll down to where you see graphs).</p></div><div><p dir="auto">The game will run in text mode and we’ll use the box drawing characters to draw the snake. I’m sure Vulcan or DirectX would be a lot more fun, but we’ll get by with <code>System.Console</code>.</p></div></div></div><div class="heading-wrapper"><h1 data-heading="A no-allocation game" dir="auto" class="heading" id="A_no-allocation_game">A no-allocation game</h1><div class="heading-children"><div><p dir="auto">We’re going to build a no-allocation game - and by no-allocation I don’t mean the “don’t allocate in the game loop” that is common among C# game devs. I mean “the new keyword with reference types is forbidden in the entire codebase”. The reasons for that will become apparent at the final stretch of shrinking the game.</p></div><div><p dir="auto">With such restriction in place, one might wonder if there’s any point in using C# after all: without the new keyword, we won’t be using the garbage collector, we can’t throw exceptions, etc. - a language like C would work just as well.</p></div><div><p dir="auto">One reason to use C# is “because we can”. The other reason is testability and code sharing - while the game as a whole is no-allocation, it doesn’t mean that parts of it couldn’t be reused in a different project that doesn’t have such constrains. For example, parts of the game could be included from an xUnit project to get unit test coverage. If one chooses C to build the game, things have to stay constrained by what C can do even when the code is reused from elsewhere. But since C# provides a good mix of high level and low level constructs, we can follow the “<em>high level by default, low level when necessary</em>” philosophy.</p></div><div><p dir="auto">To reach the 8 kB deployment size, the low level part will be necessary.</p></div></div></div><div class="heading-wrapper"><h1 data-heading="The game structure" dir="auto" class="heading" id="The_game_structure">The game structure</h1><div class="heading-children"><div><p dir="auto">Let’s start with a struct that represents the frame buffer. Frame buffer is a component that holds the pixels (or in this case characters) to be drawn to the screen.</p></div><div><pre class="language-csharp" tabindex="0"><code class="language-csharp is-loaded"><span class="token keyword">unsafe</span> <span class="token keyword">struct</span> <span class="token class-name">FrameBuffer</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">const</span> <span class="token class-name"><span class="token keyword">int</span></span> Width <span class="token operator">=</span> <span class="token number">40</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">const</span> <span class="token class-name"><span class="token keyword">int</span></span> Height <span class="token operator">=</span> <span class="token number">20</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">const</span> <span class="token class-name"><span class="token keyword">int</span></span> Area <span class="token operator">=</span> Width <span class="token operator">*</span> Height<span class="token punctuation">;</span>

    <span class="token keyword">fixed</span> <span class="token keyword">char</span> _chars<span class="token punctuation">[</span>Area<span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">SetPixel</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">int</span></span> x<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">int</span></span> y<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">char</span></span> character<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        _chars<span class="token punctuation">[</span>y <span class="token operator">*</span> Width <span class="token operator">+</span> x<span class="token punctuation">]</span> <span class="token operator">=</span> character<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">int</span></span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> Area<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
            _chars<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token char">' '</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">readonly</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Render</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        Console<span class="token punctuation">.</span><span class="token function">SetCursorPosition</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">const</span> <span class="token class-name">ConsoleColor</span> snakeColor <span class="token operator">=</span> ConsoleColor<span class="token punctuation">.</span>Green<span class="token punctuation">;</span>

        Console<span class="token punctuation">.</span>ForegroundColor <span class="token operator">=</span> snakeColor<span class="token punctuation">;</span>

        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">int</span></span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> Area<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token class-name"><span class="token keyword">char</span></span> c <span class="token operator">=</span> _chars<span class="token punctuation">[</span>i <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>c <span class="token operator">==</span> <span class="token char">'*'</span> <span class="token operator">||</span> <span class="token punctuation">(</span>c <span class="token operator">&gt;=</span> <span class="token char">'A'</span> <span class="token operator">&amp;&amp;</span> c <span class="token operator">&lt;=</span> <span class="token char">'Z'</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span>c <span class="token operator">&gt;=</span> <span class="token char">'a'</span> <span class="token operator">&amp;&amp;</span> c <span class="token operator">&lt;=</span> <span class="token char">'z'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                Console<span class="token punctuation">.</span>ForegroundColor <span class="token operator">=</span> c <span class="token operator">==</span> <span class="token char">'*'</span> <span class="token punctuation">?</span> ConsoleColor<span class="token punctuation">.</span>Red <span class="token punctuation">:</span> ConsoleColor<span class="token punctuation">.</span>White<span class="token punctuation">;</span>
                Console<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span>
                Console<span class="token punctuation">.</span>ForegroundColor <span class="token operator">=</span> snakeColor<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">else</span>
                Console<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">%</span> Width <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                Console<span class="token punctuation">.</span><span class="token function">SetCursorPosition</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> i <span class="token operator">/</span> Width <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code><button class="copy-code-button">Copy</button></pre></div><div><p dir="auto">We provide methods to set individual pixels, clear the frame buffer, and to render the contents of the frame buffer into <code>System.Console</code>. The rendering step special cases a couple characters so that we get colorful output without having to keep track of color for each pixel of the frame buffer.</p></div><div><p dir="auto">One interesting thing to call out is the <code>fixed char _chars[Area]</code> field: this is the C# syntax to declare a <a data-tooltip-position="top" aria-label="https://docs.microsoft.com/en-us/dotnet/csharp/programming-guide/unsafe-code-pointers/fixed-size-buffers" rel="noopener" class="external-link" href="https://docs.microsoft.com/en-us/dotnet/csharp/programming-guide/unsafe-code-pointers/fixed-size-buffers" target="_blank">fixed array</a>. A fixed array is an array whose individual elements are a part of the struct. You can think of it as a shortcut for a set of fields <code>char _char_0, _char_1, _char_2, _char_3,... _char_Area</code> that one can access as an array. The size of this array needs to be a compile time constant so that the size of the entire struct is fixed.</p></div><div><p dir="auto">We can’t go overboard with the size of a fixed array because being a part of a struct, the array needs to live on the stack and stacks tend to be limited to a small number of bytes (1 MB per thread, typically). But 40 <em> 20 </em> 2 bytes (width <em> height </em> sizeof(char)) should be fine.</p></div><div><p dir="auto">Next thing we need is a random number generator. The one that comes with .NET is a reference type (for good reasons!) and we forbid ourselves the new keyword - we can’t use it. A simple struct will do:</p></div><div><pre class="language-csharp" tabindex="0"><code class="language-csharp is-loaded"><span class="token keyword">struct</span> <span class="token class-name">Random</span>
<span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token class-name"><span class="token keyword">uint</span></span> _val<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token function">Random</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">uint</span></span> seed<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        _val <span class="token operator">=</span> seed<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">uint</span></span> <span class="token function">Next</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> _val <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">1103515245</span> <span class="token operator">*</span> _val <span class="token operator">+</span> <span class="token number">12345</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">2147483648</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code><button class="copy-code-button">Copy</button></pre></div><div><p dir="auto">This random number generator is not great, but we don’t need anything sophisticated.</p></div><div><p dir="auto">Now we only need something that wraps the snake logic. Time for a Snake struct:</p></div><div><pre class="language-csharp" tabindex="0"><code class="language-csharp is-loaded"><span class="token keyword">struct</span> <span class="token class-name">Snake</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">const</span> <span class="token class-name"><span class="token keyword">int</span></span> MaxLength <span class="token operator">=</span> <span class="token number">30</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name"><span class="token keyword">int</span></span> _length<span class="token punctuation">;</span>

    <span class="token comment">// Body is a packed integer that packs the X coordinate, Y coordinate, and the character</span>
    <span class="token comment">// for the snake's body.</span>
    <span class="token comment">// Only primitive types can be used with C# `fixed`, hence this is an `int`.</span>
    <span class="token keyword">private</span> <span class="token keyword">unsafe</span> <span class="token keyword">fixed</span> <span class="token keyword">int</span> _body<span class="token punctuation">[</span>MaxLength<span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">Direction</span> _direction<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">Direction</span> _oldDirection<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token return-type class-name">Direction</span> Course
    <span class="token punctuation">{</span>
        <span class="token keyword">set</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>_oldDirection <span class="token operator">!=</span> _direction<span class="token punctuation">)</span>
                _oldDirection <span class="token operator">=</span> _direction<span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>_direction <span class="token operator">-</span> <span class="token keyword">value</span> <span class="token operator">!=</span> <span class="token number">2</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">value</span> <span class="token operator">-</span> _direction <span class="token operator">!=</span> <span class="token number">2</span><span class="token punctuation">)</span>
                _direction <span class="token operator">=</span> <span class="token keyword">value</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">unsafe</span> <span class="token function">Snake</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">byte</span></span> x<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">byte</span></span> y<span class="token punctuation">,</span> <span class="token class-name">Direction</span> direction<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        _body<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Part</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> <span class="token function">DirectionToChar</span><span class="token punctuation">(</span>direction<span class="token punctuation">,</span> direction<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Pack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        _direction <span class="token operator">=</span> direction<span class="token punctuation">;</span>
        _oldDirection <span class="token operator">=</span> direction<span class="token punctuation">;</span>
        _length <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">unsafe</span> <span class="token return-type class-name"><span class="token keyword">bool</span></span> <span class="token function">Update</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token class-name">Part</span> oldHead <span class="token operator">=</span> Part<span class="token punctuation">.</span><span class="token function">Unpack</span><span class="token punctuation">(</span>_body<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Part</span> newHead <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Part</span><span class="token punctuation">(</span>
            <span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">)</span><span class="token punctuation">(</span>_direction <span class="token keyword">switch</span>
            <span class="token punctuation">{</span>
                Direction<span class="token punctuation">.</span>Left <span class="token operator">=&gt;</span> oldHead<span class="token punctuation">.</span>X <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">?</span> FrameBuffer<span class="token punctuation">.</span>Width <span class="token operator">-</span> <span class="token number">1</span> <span class="token punctuation">:</span> oldHead<span class="token punctuation">.</span>X <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span>
                Direction<span class="token punctuation">.</span>Right <span class="token operator">=&gt;</span> <span class="token punctuation">(</span>oldHead<span class="token punctuation">.</span>X <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">%</span> FrameBuffer<span class="token punctuation">.</span>Width<span class="token punctuation">,</span>
                _ <span class="token operator">=&gt;</span> oldHead<span class="token punctuation">.</span>X<span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">)</span><span class="token punctuation">(</span>_direction <span class="token keyword">switch</span>
            <span class="token punctuation">{</span>
                Direction<span class="token punctuation">.</span>Up <span class="token operator">=&gt;</span> oldHead<span class="token punctuation">.</span>Y <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">?</span> FrameBuffer<span class="token punctuation">.</span>Height <span class="token operator">-</span> <span class="token number">1</span> <span class="token punctuation">:</span> oldHead<span class="token punctuation">.</span>Y <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span>
                Direction<span class="token punctuation">.</span>Down <span class="token operator">=&gt;</span> <span class="token punctuation">(</span>oldHead<span class="token punctuation">.</span>Y <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">%</span> FrameBuffer<span class="token punctuation">.</span>Height<span class="token punctuation">,</span>
                _ <span class="token operator">=&gt;</span> oldHead<span class="token punctuation">.</span>Y<span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token function">DirectionToChar</span><span class="token punctuation">(</span>_direction<span class="token punctuation">,</span> _direction<span class="token punctuation">)</span>
            <span class="token punctuation">)</span><span class="token punctuation">;</span>

        oldHead <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Part</span><span class="token punctuation">(</span>oldHead<span class="token punctuation">.</span>X<span class="token punctuation">,</span> oldHead<span class="token punctuation">.</span>Y<span class="token punctuation">,</span> <span class="token function">DirectionToChar</span><span class="token punctuation">(</span>_oldDirection<span class="token punctuation">,</span> _direction<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name"><span class="token keyword">bool</span></span> result <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>

        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">int</span></span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> _length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token class-name">Part</span> current <span class="token operator">=</span> Part<span class="token punctuation">.</span><span class="token function">Unpack</span><span class="token punctuation">(</span>_body<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>current<span class="token punctuation">.</span>X <span class="token operator">==</span> newHead<span class="token punctuation">.</span>X <span class="token operator">&amp;&amp;</span> current<span class="token punctuation">.</span>Y <span class="token operator">==</span> newHead<span class="token punctuation">.</span>Y<span class="token punctuation">)</span>
                result <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        _body<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> oldHead<span class="token punctuation">.</span><span class="token function">Pack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">int</span></span> i <span class="token operator">=</span> _length <span class="token operator">-</span> <span class="token number">2</span><span class="token punctuation">;</span> i <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">--</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            _body<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> _body<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        _body<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> newHead<span class="token punctuation">.</span><span class="token function">Pack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        _oldDirection <span class="token operator">=</span> _direction<span class="token punctuation">;</span>

        <span class="token keyword">return</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">unsafe</span> <span class="token keyword">readonly</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Draw</span><span class="token punctuation">(</span><span class="token keyword">ref</span> <span class="token class-name">FrameBuffer</span> fb<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">int</span></span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> _length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token class-name">Part</span> p <span class="token operator">=</span> Part<span class="token punctuation">.</span><span class="token function">Unpack</span><span class="token punctuation">(</span>_body<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            fb<span class="token punctuation">.</span><span class="token function">SetPixel</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>X<span class="token punctuation">,</span> p<span class="token punctuation">.</span>Y<span class="token punctuation">,</span> p<span class="token punctuation">.</span>Character<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">bool</span></span> <span class="token function">Extend</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>_length <span class="token operator">&lt;</span> MaxLength<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            _length <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">unsafe</span> <span class="token keyword">readonly</span> <span class="token return-type class-name"><span class="token keyword">bool</span></span> <span class="token function">HitTest</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">int</span></span> x<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">int</span></span> y<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">int</span></span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> _length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token class-name">Part</span> current <span class="token operator">=</span> Part<span class="token punctuation">.</span><span class="token function">Unpack</span><span class="token punctuation">(</span>_body<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>current<span class="token punctuation">.</span>X <span class="token operator">==</span> x <span class="token operator">&amp;&amp;</span> current<span class="token punctuation">.</span>Y <span class="token operator">==</span> y<span class="token punctuation">)</span>
                <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">char</span></span> <span class="token function">DirectionToChar</span><span class="token punctuation">(</span><span class="token class-name">Direction</span> oldDirection<span class="token punctuation">,</span> <span class="token class-name">Direction</span> newDirection<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">const</span> <span class="token class-name"><span class="token keyword">string</span></span> DirectionChangeToChar <span class="token operator">=</span> <span class="token string">"│┌?┐┘─┐??└│┘└?┌─"</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> DirectionChangeToChar<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>oldDirection <span class="token operator">*</span> <span class="token number">4</span> <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>newDirection<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Helper struct to pack and unpack the packed integer in _body.</span>
    <span class="token keyword">readonly</span> <span class="token keyword">struct</span> <span class="token class-name">Part</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">public</span> <span class="token keyword">readonly</span> <span class="token class-name"><span class="token keyword">byte</span></span> X<span class="token punctuation">,</span> Y<span class="token punctuation">;</span>
        <span class="token keyword">public</span> <span class="token keyword">readonly</span> <span class="token class-name"><span class="token keyword">char</span></span> Character<span class="token punctuation">;</span>

        <span class="token keyword">public</span> <span class="token function">Part</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">byte</span></span> x<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">byte</span></span> y<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">char</span></span> c<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            X <span class="token operator">=</span> x<span class="token punctuation">;</span>
            Y <span class="token operator">=</span> y<span class="token punctuation">;</span>
            Character <span class="token operator">=</span> c<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">int</span></span> <span class="token function">Pack</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> X <span class="token operator">&lt;&lt;</span> <span class="token number">24</span> <span class="token operator">|</span> Y <span class="token operator">&lt;&lt;</span> <span class="token number">16</span> <span class="token operator">|</span> Character<span class="token punctuation">;</span>
        <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name">Part</span> <span class="token function">Unpack</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">int</span></span> packed<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Part</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">)</span><span class="token punctuation">(</span>packed <span class="token operator">&gt;&gt;</span> <span class="token number">24</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">)</span><span class="token punctuation">(</span>packed <span class="token operator">&gt;&gt;</span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">char</span><span class="token punctuation">)</span>packed<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">enum</span> <span class="token class-name">Direction</span>
    <span class="token punctuation">{</span>
        Up<span class="token punctuation">,</span> Right<span class="token punctuation">,</span> Down<span class="token punctuation">,</span> Left
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code><button class="copy-code-button">Copy</button></pre></div><div><p dir="auto">The state that a snake needs to track is:</p></div><div><ul>
<li data-line="0" dir="auto">the coordinates of each pixel that represents the snake’s body,</li>
<li data-line="1" dir="auto">the current length of the snake,</li>
<li data-line="2" dir="auto">the current direction of the snake,</li>
<li data-line="3" dir="auto">past direction of the snake (in case we need to draw the “bend” character instead of a straight line)</li>
</ul></div><div><p dir="auto">The snake provides methods to Extend the length of snake by one (returns false if the snake is already at full length), to HitTest a pixel with the snake’s body, to Draw the snake into a FrameBuffer and to Update the snake’s position as a response to a game tick (returns false if the snake ate itself). There’s also a property to set the current Course of the snake.</p></div><div><p dir="auto">We use the same fixed array trick that we used in the frame buffer to keep the snake no-allocation. It means the maximum length of the snake has to be a compile time constant.</p></div><div><p dir="auto">The last thing we need is the game loop:</p></div><div><pre class="language-csharp" tabindex="0"><code class="language-csharp is-loaded"><span class="token keyword">struct</span> <span class="token class-name">Game</span>
<span class="token punctuation">{</span>
    <span class="token keyword">enum</span> <span class="token class-name">Result</span>
    <span class="token punctuation">{</span>
        Win<span class="token punctuation">,</span> Loss
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token class-name">Random</span> _random<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token function">Game</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">uint</span></span> randomSeed<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        _random <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Random</span><span class="token punctuation">(</span>randomSeed<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token return-type class-name">Result</span> <span class="token function">Run</span><span class="token punctuation">(</span><span class="token keyword">ref</span> <span class="token class-name">FrameBuffer</span> fb<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token class-name">Snake</span> s <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Snake</span><span class="token punctuation">(</span>
            <span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">)</span><span class="token punctuation">(</span>_random<span class="token punctuation">.</span><span class="token function">Next</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">%</span> FrameBuffer<span class="token punctuation">.</span>Width<span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">)</span><span class="token punctuation">(</span>_random<span class="token punctuation">.</span><span class="token function">Next</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">%</span> FrameBuffer<span class="token punctuation">.</span>Height<span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token punctuation">(</span>Snake<span class="token punctuation">.</span>Direction<span class="token punctuation">)</span><span class="token punctuation">(</span>_random<span class="token punctuation">.</span><span class="token function">Next</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">MakeFood</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token keyword">out</span> <span class="token class-name"><span class="token keyword">byte</span></span> foodX<span class="token punctuation">,</span> <span class="token keyword">out</span> <span class="token class-name"><span class="token keyword">byte</span></span> foodY<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name"><span class="token keyword">long</span></span> gameTime <span class="token operator">=</span> Environment<span class="token punctuation">.</span>TickCount64<span class="token punctuation">;</span>

        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            fb<span class="token punctuation">.</span><span class="token function">Clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>s<span class="token punctuation">.</span><span class="token function">Update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                s<span class="token punctuation">.</span><span class="token function">Draw</span><span class="token punctuation">(</span><span class="token keyword">ref</span> fb<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> Result<span class="token punctuation">.</span>Loss<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            s<span class="token punctuation">.</span><span class="token function">Draw</span><span class="token punctuation">(</span><span class="token keyword">ref</span> fb<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>Console<span class="token punctuation">.</span>KeyAvailable<span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                <span class="token class-name">ConsoleKeyInfo</span> ki <span class="token operator">=</span> Console<span class="token punctuation">.</span><span class="token function">ReadKey</span><span class="token punctuation">(</span><span class="token named-parameter punctuation">intercept</span><span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">switch</span> <span class="token punctuation">(</span>ki<span class="token punctuation">.</span>Key<span class="token punctuation">)</span>
                <span class="token punctuation">{</span>
                    <span class="token keyword">case</span> ConsoleKey<span class="token punctuation">.</span>UpArrow<span class="token punctuation">:</span>
                        s<span class="token punctuation">.</span>Course <span class="token operator">=</span> Snake<span class="token punctuation">.</span>Direction<span class="token punctuation">.</span>Up<span class="token punctuation">;</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
                    <span class="token keyword">case</span> ConsoleKey<span class="token punctuation">.</span>DownArrow<span class="token punctuation">:</span>
                        s<span class="token punctuation">.</span>Course <span class="token operator">=</span> Snake<span class="token punctuation">.</span>Direction<span class="token punctuation">.</span>Down<span class="token punctuation">;</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
                    <span class="token keyword">case</span> ConsoleKey<span class="token punctuation">.</span>LeftArrow<span class="token punctuation">:</span>
                        s<span class="token punctuation">.</span>Course <span class="token operator">=</span> Snake<span class="token punctuation">.</span>Direction<span class="token punctuation">.</span>Left<span class="token punctuation">;</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
                    <span class="token keyword">case</span> ConsoleKey<span class="token punctuation">.</span>RightArrow<span class="token punctuation">:</span>
                        s<span class="token punctuation">.</span>Course <span class="token operator">=</span> Snake<span class="token punctuation">.</span>Direction<span class="token punctuation">.</span>Right<span class="token punctuation">;</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>s<span class="token punctuation">.</span><span class="token function">HitTest</span><span class="token punctuation">(</span>foodX<span class="token punctuation">,</span> foodY<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>s<span class="token punctuation">.</span><span class="token function">Extend</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token function">MakeFood</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token keyword">out</span> foodX<span class="token punctuation">,</span> <span class="token keyword">out</span> foodY<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">else</span>
                    <span class="token keyword">return</span> Result<span class="token punctuation">.</span>Win<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            fb<span class="token punctuation">.</span><span class="token function">SetPixel</span><span class="token punctuation">(</span>foodX<span class="token punctuation">,</span> foodY<span class="token punctuation">,</span> <span class="token char">'*'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            fb<span class="token punctuation">.</span><span class="token function">Render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            gameTime <span class="token operator">+=</span> <span class="token number">100</span><span class="token punctuation">;</span>

            <span class="token class-name"><span class="token keyword">long</span></span> delay <span class="token operator">=</span> gameTime <span class="token operator">-</span> Environment<span class="token punctuation">.</span>TickCount64<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>delay <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span>
                Thread<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>delay<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">else</span>
                gameTime <span class="token operator">=</span> Environment<span class="token punctuation">.</span>TickCount64<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">MakeFood</span><span class="token punctuation">(</span><span class="token keyword">in</span> <span class="token class-name">Snake</span> snake<span class="token punctuation">,</span> <span class="token keyword">out</span> <span class="token class-name"><span class="token keyword">byte</span></span> foodX<span class="token punctuation">,</span> <span class="token keyword">out</span> <span class="token class-name"><span class="token keyword">byte</span></span> foodY<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">do</span>
        <span class="token punctuation">{</span>
            foodX <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">)</span><span class="token punctuation">(</span>_random<span class="token punctuation">.</span><span class="token function">Next</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">%</span> FrameBuffer<span class="token punctuation">.</span>Width<span class="token punctuation">)</span><span class="token punctuation">;</span>
            foodY <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">)</span><span class="token punctuation">(</span>_random<span class="token punctuation">.</span><span class="token function">Next</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">%</span> FrameBuffer<span class="token punctuation">.</span>Height<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>snake<span class="token punctuation">.</span><span class="token function">HitTest</span><span class="token punctuation">(</span>foodX<span class="token punctuation">,</span> foodY<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        Console<span class="token punctuation">.</span><span class="token function">SetWindowSize</span><span class="token punctuation">(</span>FrameBuffer<span class="token punctuation">.</span>Width<span class="token punctuation">,</span> FrameBuffer<span class="token punctuation">.</span>Height<span class="token punctuation">)</span><span class="token punctuation">;</span>
        Console<span class="token punctuation">.</span><span class="token function">SetBufferSize</span><span class="token punctuation">(</span>FrameBuffer<span class="token punctuation">.</span>Width<span class="token punctuation">,</span> FrameBuffer<span class="token punctuation">.</span>Height<span class="token punctuation">)</span><span class="token punctuation">;</span>
        Console<span class="token punctuation">.</span>Title <span class="token operator">=</span> <span class="token string">"See Sharp Snake"</span><span class="token punctuation">;</span>
        Console<span class="token punctuation">.</span>CursorVisible <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

        <span class="token class-name">FrameBuffer</span> fb <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">FrameBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token class-name">Game</span> g <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Game</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">uint</span><span class="token punctuation">)</span>Environment<span class="token punctuation">.</span>TickCount64<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Result</span> result <span class="token operator">=</span> g<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token keyword">ref</span> fb<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token class-name"><span class="token keyword">string</span></span> message <span class="token operator">=</span> result <span class="token operator">==</span> Result<span class="token punctuation">.</span>Win <span class="token punctuation">?</span> <span class="token string">"You win"</span> <span class="token punctuation">:</span> <span class="token string">"You lose"</span><span class="token punctuation">;</span>

            <span class="token class-name"><span class="token keyword">int</span></span> position <span class="token operator">=</span> <span class="token punctuation">(</span>FrameBuffer<span class="token punctuation">.</span>Width <span class="token operator">-</span> message<span class="token punctuation">.</span>Length<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">int</span></span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> message<span class="token punctuation">.</span>Length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                fb<span class="token punctuation">.</span><span class="token function">SetPixel</span><span class="token punctuation">(</span>position <span class="token operator">+</span> i<span class="token punctuation">,</span> FrameBuffer<span class="token punctuation">.</span>Height <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">,</span> message<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            fb<span class="token punctuation">.</span><span class="token function">Render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            Console<span class="token punctuation">.</span><span class="token function">ReadKey</span><span class="token punctuation">(</span><span class="token named-parameter punctuation">intercept</span><span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code><button class="copy-code-button">Copy</button></pre></div><div><p dir="auto">We use the random number generator to generate a random position and direction of the snake, we randomly place the food on the game surface, making sure it doesn’t overlap the snake, and start the game loop.</p></div><div><p dir="auto">Within the game loop we ask the snake to update its position and check whether it ate itself. We then draw the snake, check the keyboard for input, hit-test the snake with the food, and render everything to the console.</p></div><div><p dir="auto">That’s pretty much it. Let’s see where we are in terms of size.</p></div></div></div><div class="heading-wrapper"><h1 data-heading="The default size of a .NET Core 3.0 Snake" dir="auto" class="heading" id="The_default_size_of_a_.NET_Core_3.0_Snake">The default size of a .NET Core 3.0 Snake</h1><div class="heading-children"><div><p dir="auto">I’ve placed the game in <a data-tooltip-position="top" aria-label="https://github.com/MichalStrehovsky/SeeSharpSnake" rel="noopener" class="external-link" href="https://github.com/MichalStrehovsky/SeeSharpSnake" target="_blank">a GitHub repo</a> so that you can follow along. The project file will produce the game in different configurations depending on the Mode property passed to publish. To produce the default configuration with CoreCLR, run:</p></div><div><pre class="language-sh" tabindex="0"><code class="language-sh is-loaded">$ dotnet publish -r win-x64 -c Release
</code><button class="copy-code-button">Copy</button></pre></div><div><p dir="auto">This will produce a single EXE file that has whopping 65 MB. The produced EXE includes the game, the .NET Runtime, and the base class libraries that are the standard part of .NET. You might say “still better than Electron” and call it good, but let’s see if we can do better.</p></div><div><p dir="auto"><a data-tooltip-position="top" aria-label="https://migeel.sk/blog/2020/01/03/building-a-self-contained-game-in-csharp-under-8-kilobytes/03-graph1.png" rel="noopener" class="external-link" href="https://migeel.sk/blog/2020/01/03/building-a-self-contained-game-in-csharp-under-8-kilobytes/03-graph1.png" target="_blank"><img alt="Starting point" src="https://migeel.sk/blog/2020/01/03/building-a-self-contained-game-in-csharp-under-8-kilobytes/03-graph1.png" referrerpolicy="no-referrer"></a></p></div><div><p dir="auto">Starting point</p></div></div></div><div class="heading-wrapper"><h1 data-heading="IL Trimming" dir="auto" class="heading" id="IL_Trimming">IL Trimming</h1><div class="heading-children"><div><p dir="auto">IL trimming shipped with .NET Core 3.0 - trimming removes unused code from your app by scanning the entire program and removing assemblies that are unreferenced. To use it with the project, pass a PublishTrimmed property to publish. Like so:</p></div><div><pre class="language-sh" tabindex="0"><code class="language-sh is-loaded">$ dotnet publish -r win-x64 -c Release /p:PublishTrimmed=true
</code><button class="copy-code-button">Copy</button></pre></div><div><p dir="auto">With this setting, the game shrinks to 25 MB. It’s a nice 60% reduction, but far from our 8 kB goal.</p></div><div><p dir="auto">Trimming has more aggressive settings that are not publicly exposed and they could bring this down further, but in the end, we’re going to be limited by the size of the CoreCLR runtime itself - coreclr.dll - at 5.3 MB. We might have reached a dead end on the road to a 8 kB game.</p></div><div><p dir="auto"><a data-tooltip-position="top" aria-label="https://migeel.sk/blog/2020/01/03/building-a-self-contained-game-in-csharp-under-8-kilobytes/04-graph2.png" rel="noopener" class="external-link" href="https://migeel.sk/blog/2020/01/03/building-a-self-contained-game-in-csharp-under-8-kilobytes/04-graph2.png" target="_blank"><img alt="After trimming" src="https://migeel.sk/blog/2020/01/03/building-a-self-contained-game-in-csharp-under-8-kilobytes/04-graph2.png" referrerpolicy="no-referrer"></a></p></div><div><p dir="auto">After trimming</p></div></div></div><div class="heading-wrapper"><h1 data-heading="Slight detour: Mono" dir="auto" class="heading" id="Slight_detour:_Mono">Slight detour: Mono</h1><div class="heading-children"><div><p dir="auto"><a data-tooltip-position="top" aria-label="https://www.mono-project.com/" rel="noopener" class="external-link" href="https://www.mono-project.com/" target="_blank">Mono</a> is another .NET runtime that for many is the synonym for Xamarin. To build a single executable with the C# snake, we can use the mkbundle tool that comes with Mono:</p></div><div><pre class="language-sh" tabindex="0"><code class="language-sh is-loaded">$ mkbundle SeeSharpSnake.dll --simple -o SeeSharpSnake.exe
</code><button class="copy-code-button">Copy</button></pre></div><div><p dir="auto">This will produce a 12.3 MB executable that depends on mono-2.0-sgen.dll that itself has 5.9 MB - so we’re looking at 18.2 MB in total. When trying to launch it, I hit “Error mapping file: mono_file_map_error failed”, but I’m going to trust that except for this bug, things would work with Mono and the result would be 18.2 MB.</p></div><div><p dir="auto">Unlike CoreCLR, Mono also depends on the Visual C++ runtime redistributable library that is not available in a default Windows installation: to keep the goal of the app being self-contained, we need to carry this library with the app. This increases the footprint of the application by another megabyte or so.</p></div><div><p dir="auto">We would likely be able to make things smaller by adding trimming to the mix, but we’re going to hit the same problem as with CoreCLR - the size of the runtime (mono-2.0-sgen.dll) is 5.9 MB (plus the size of the C++ runtime libraries on top of it), and represents the floor of where any possible IL-level optimization could bring us.</p></div><div><p dir="auto"><a data-tooltip-position="top" aria-label="https://migeel.sk/blog/2020/01/03/building-a-self-contained-game-in-csharp-under-8-kilobytes/05-graph3.png" rel="noopener" class="external-link" href="https://migeel.sk/blog/2020/01/03/building-a-self-contained-game-in-csharp-under-8-kilobytes/05-graph3.png" target="_blank"><img alt="With Mono" src="https://migeel.sk/blog/2020/01/03/building-a-self-contained-game-in-csharp-under-8-kilobytes/05-graph3.png" referrerpolicy="no-referrer"></a></p></div><div><p dir="auto">With Mono</p></div></div></div><div class="heading-wrapper"><h1 data-heading="Can we take the runtime out?" dir="auto" class="heading" id="Can_we_take_the_runtime_out?">Can we take the runtime out?</h1><div class="heading-children"><div><p dir="auto">It is clear that to get anywhere near the 8 kB goal, we need to take the runtime out of the app. The only .NET runtime where this is possible is <a data-tooltip-position="top" aria-label="https://github.com/dotnet/corert" rel="noopener" class="external-link" href="https://github.com/dotnet/corert" target="_blank">CoreRT</a>. While it’s common to call CoreRT a “runtime”, it’s closer to being a “runtime library”. It’s not a virtual machine like CoreCLR or Mono - the CoreRT’s runtime is just a set of functions that support ahead of time generated native code produced by CoreRT’s ahead of time compiler.</p></div><div><p dir="auto">CoreRT comes with <em>libraries</em> that make CoreRT look like any other .NET runtime: there’s a library that adds GC, library that adds support for reflection, library that adds a JIT, library that adds an interpreter, etc. But all of those libraries are <em>optional</em> (and that includes the GC).</p></div><div><p dir="auto">More on how CoreRT differs from CoreCLR and Mono is in <a data-tooltip-position="top" aria-label="https://migeel.sk/blog/2019/05/01/fight-the-global-warming-compile-your-csharp-apps-ahead-of-time/" rel="noopener" class="external-link" href="https://migeel.sk/blog/2019/05/01/fight-the-global-warming-compile-your-csharp-apps-ahead-of-time/" target="_blank">this article</a>. When I was reading about the runtime of the <a data-tooltip-position="top" aria-label="https://theartofmachinery.com/2017/06/04/what_is_the_d_runtime.html" rel="noopener" class="external-link" href="https://theartofmachinery.com/2017/06/04/what_is_the_d_runtime.html" target="_blank">D language</a>, it reminded me of CoreRT a lot. The article is an interesting read too.</p></div><div><p dir="auto">Let’s see where we’re with the default CoreRT configuration:</p></div><div><pre class="language-sh" tabindex="0"><code class="language-sh is-loaded">$ dotnet publish -r win-x64 -c Release /p:Mode=CoreRT
</code><button class="copy-code-button">Copy</button></pre></div><div><p dir="auto">This comes down to 4.7 MB. It’s the smallest so far, but still not good enough.</p></div><div><p dir="auto"><a data-tooltip-position="top" aria-label="https://migeel.sk/blog/2020/01/03/building-a-self-contained-game-in-csharp-under-8-kilobytes/06-graph4.png" rel="noopener" class="external-link" href="https://migeel.sk/blog/2020/01/03/building-a-self-contained-game-in-csharp-under-8-kilobytes/06-graph4.png" target="_blank"><img alt="With CoreRT" src="https://migeel.sk/blog/2020/01/03/building-a-self-contained-game-in-csharp-under-8-kilobytes/06-graph4.png" referrerpolicy="no-referrer"></a></p></div><div><p dir="auto">With CoreRT</p></div><div><p dir="auto">The CoreRT ahead of time compiler offers a <a data-tooltip-position="top" aria-label="http://aka.ms/OptimizeCoreRT" rel="noopener" class="external-link" href="http://aka.ms/OptimizeCoreRT" target="_blank">vast number</a> of settings that affect code generation. By default, the compiler tries to maximize the generated code speed and compatibility with other .NET runtimes at the expense of the size of the generated executable.</p></div><div><p dir="auto">The compiler has a built-in trimmer that removes unused code. The “CoreRT-Moderate” setting that we define in the Snake project relaxes one of the restrictions on removing unused code that allows more removal. We also ask the compiler to trade program speed for some extra bytes. Most .NET programs would work just fine in this mode.</p></div><div><pre class="language-sh" tabindex="0"><code class="language-sh is-loaded">$ dotnet publish -r win-x64 -c Release /p:Mode=CoreRT-Moderate
</code><button class="copy-code-button">Copy</button></pre></div><div><p dir="auto">We’re now at 4.3 MB.</p></div><div><p dir="auto"><a data-tooltip-position="top" aria-label="https://migeel.sk/blog/2020/01/03/building-a-self-contained-game-in-csharp-under-8-kilobytes/07-graph5.png" rel="noopener" class="external-link" href="https://migeel.sk/blog/2020/01/03/building-a-self-contained-game-in-csharp-under-8-kilobytes/07-graph5.png" target="_blank"><img alt="With stuff removed" src="https://migeel.sk/blog/2020/01/03/building-a-self-contained-game-in-csharp-under-8-kilobytes/07-graph5.png" referrerpolicy="no-referrer"></a></p></div><div><p dir="auto">With stuff removed</p></div></div></div><div class="heading-wrapper"><h1 data-heading="Turning on high savings in CoreRT" dir="auto" class="heading" id="Turning_on_high_savings_in_CoreRT">Turning on high savings in CoreRT</h1><div class="heading-children"><div><p dir="auto">I’ve grouped a couple more compilation options into a “high savings” mode. This mode is going to remove support for things that many apps would notice, but Snake (being the low level thing that it is) won’t.</p></div><div><p dir="auto">We are going to remove:</p></div><div><ul>
<li data-line="0" dir="auto">Stack trace data for framework implementation details</li>
<li data-line="1" dir="auto">Exception messages in framework-thrown exceptions</li>
<li data-line="2" dir="auto">Support for non-English locales</li>
<li data-line="3" dir="auto">EventSource instrumentation</li>
</ul></div><div><pre class="language-sh" tabindex="0"><code class="language-sh is-loaded">$ dotnet publish -r win-x64 -c Release /p:Mode=CoreRT-High
</code><button class="copy-code-button">Copy</button></pre></div><div><p dir="auto">We’ve reached 3.0 MB. This is 5% of what we started with, but CoreRT has one more trick up its sleeve.</p></div><div><p dir="auto"><a data-tooltip-position="top" aria-label="https://migeel.sk/blog/2020/01/03/building-a-self-contained-game-in-csharp-under-8-kilobytes/08-graph6.png" rel="noopener" class="external-link" href="https://migeel.sk/blog/2020/01/03/building-a-self-contained-game-in-csharp-under-8-kilobytes/08-graph6.png" target="_blank"><img alt="With more stuff removed" src="https://migeel.sk/blog/2020/01/03/building-a-self-contained-game-in-csharp-under-8-kilobytes/08-graph6.png" referrerpolicy="no-referrer"></a></p></div><div><p dir="auto">With more stuff removed</p></div></div></div><div class="heading-wrapper"><h1 data-heading="Disabling reflection" dir="auto" class="heading" id="Disabling_reflection">Disabling reflection</h1><div class="heading-children"><div><p dir="auto">Substantial part of the CoreRT runtime libraries is dedicated to the implementation of the .NET reflection surface area. Because CoreRT is an ahead-of-time-compiled runtime-library-based .NET implementation, it doesn’t need most of the data structures a typical VM-based runtime (like CoreCLR and Mono) needs. This data includes things like names of types, methods, signatures, base types, etc. CoreRT embeds this data because programs using .NET reflection need it, but not because it’s needed for the runtime to operate. I call this data “the reflection tax”, because that’s what it is for the runtime.</p></div><div><p dir="auto">CoreRT supports a <a data-tooltip-position="top" aria-label="https://github.com/dotnet/corert/blob/master/Documentation/using-corert/reflection-free-mode.md" rel="noopener" class="external-link" href="https://github.com/dotnet/corert/blob/master/Documentation/using-corert/reflection-free-mode.md" target="_blank">reflection-free mode</a> that avoids this tax. You might feel that a lot of .NET code wouldn’t work without reflection and you might be right, but a surprising amount of things do work: Gui.cs, System.IO.Pipelines, or even a basic WinForms app. Snake will definitely work, so let’s turn this mode on:</p></div><div><pre class="language-sh" tabindex="0"><code class="language-sh is-loaded">$ dotnet publish -r win-x64 -c Release /p:Mode=CoreRT-ReflectionFree
</code><button class="copy-code-button">Copy</button></pre></div><div><p dir="auto">We’re now at 1.2 MB. The reflection tax is a pretty heavy tax!</p></div><div><p dir="auto"><a data-tooltip-position="top" aria-label="https://migeel.sk/blog/2020/01/03/building-a-self-contained-game-in-csharp-under-8-kilobytes/09-graph7.png" rel="noopener" class="external-link" href="https://migeel.sk/blog/2020/01/03/building-a-self-contained-game-in-csharp-under-8-kilobytes/09-graph7.png" target="_blank"><img alt="With more stuff removed" src="https://migeel.sk/blog/2020/01/03/building-a-self-contained-game-in-csharp-under-8-kilobytes/09-graph7.png" referrerpolicy="no-referrer"></a></p></div><div><p dir="auto">With more stuff removed</p></div></div></div><div class="heading-wrapper"><h1 data-heading="Getting our hands dirty" dir="auto" class="heading" id="Getting_our_hands_dirty">Getting our hands dirty</h1><div class="heading-children"><div><p dir="auto">Now we’ve reached the end of what’s possible with the .NET SDK and we need to get our hands dirty. What we’re going to do now is starting to be ridiculous and I wouldn’t expect anyone else to do this. We’re going to rely on the implementation details of the CoreRT compiler and runtime.</p></div><div><p dir="auto">As we saw earlier, CoreRT is a set of runtime libraries coupled with an ahead of time compiler. What if we replace the runtime libraries with a minimal reimplementation? We’ve decided not to use the garbage collector and that makes this job much more feasible.</p></div><div><p dir="auto">Let’s start with the easy things:</p></div><div><pre class="language-csharp" tabindex="0"><code class="language-csharp is-loaded"><span class="token keyword">namespace</span> <span class="token namespace">System<span class="token punctuation">.</span>Threading</span>
<span class="token punctuation">{</span>
    <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">Thread</span>
    <span class="token punctuation">{</span>
        <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">DllImport</span><span class="token attribute-arguments"><span class="token punctuation">(</span><span class="token string">"api-ms-win-core-synch-l1-2-0"</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>
        <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">extern</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">int</span></span> delayMs<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">namespace</span> <span class="token namespace">System</span>
<span class="token punctuation">{</span>
    <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">Environment</span>
    <span class="token punctuation">{</span>
        <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">DllImport</span><span class="token attribute-arguments"><span class="token punctuation">(</span><span class="token string">"api-ms-win-core-sysinfo-l1-1-0"</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>
        <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">extern</span> <span class="token return-type class-name"><span class="token keyword">long</span></span> <span class="token function">GetTickCount64</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">long</span></span> TickCount64 <span class="token operator">=&gt;</span> <span class="token function">GetTickCount64</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code><button class="copy-code-button">Copy</button></pre></div><div><p dir="auto">There - we just reimplemented <code>Thread.Sleep</code> and <code>Environment.TickCount64</code> (for Windows) while avoiding all dependencies on the existing runtime library.</p></div><div><p dir="auto">Let’s do the same for the subset of <code>System.Console</code> that the game uses:</p></div><div><pre class="language-csharp" tabindex="0"><code class="language-csharp is-loaded"><span class="token keyword">namespace</span> <span class="token namespace">System</span>
<span class="token punctuation">{</span>
    <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">Console</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">private</span> <span class="token keyword">enum</span> <span class="token class-name">BOOL</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token keyword">int</span></span>
        <span class="token punctuation">{</span>
            FALSE <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>
            TRUE <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span>

        <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">DllImport</span><span class="token attribute-arguments"><span class="token punctuation">(</span><span class="token string">"api-ms-win-core-processenvironment-l1-1-0"</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>
        <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">unsafe</span> <span class="token keyword">extern</span> <span class="token return-type class-name">IntPtr</span> <span class="token function">GetStdHandle</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">int</span></span> c<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">private</span> <span class="token keyword">readonly</span> <span class="token keyword">static</span> <span class="token class-name">IntPtr</span> s_outputHandle <span class="token operator">=</span> <span class="token function">GetStdHandle</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">11</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">private</span> <span class="token keyword">readonly</span> <span class="token keyword">static</span> <span class="token class-name">IntPtr</span> s_inputHandle <span class="token operator">=</span> <span class="token function">GetStdHandle</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">DllImport</span><span class="token attribute-arguments"><span class="token punctuation">(</span><span class="token string">"api-ms-win-core-console-l2-1-0.dll"</span><span class="token punctuation">,</span> EntryPoint <span class="token operator">=</span> <span class="token string">"SetConsoleTitleW"</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>
        <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">unsafe</span> <span class="token keyword">extern</span> <span class="token return-type class-name">BOOL</span> <span class="token function">SetConsoleTitle</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span> c<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">unsafe</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> Title
        <span class="token punctuation">{</span>
            <span class="token keyword">set</span>
            <span class="token punctuation">{</span>
                <span class="token keyword">fixed</span> <span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span> c <span class="token operator">=</span> <span class="token keyword">value</span><span class="token punctuation">)</span>
                    <span class="token function">SetConsoleTitle</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">StructLayout</span><span class="token attribute-arguments"><span class="token punctuation">(</span>LayoutKind<span class="token punctuation">.</span>Sequential<span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>
        <span class="token keyword">struct</span> <span class="token class-name">CONSOLE_CURSOR_INFO</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">public</span> <span class="token class-name"><span class="token keyword">uint</span></span> Size<span class="token punctuation">;</span>
            <span class="token keyword">public</span> <span class="token class-name">BOOL</span> Visible<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">DllImport</span><span class="token attribute-arguments"><span class="token punctuation">(</span><span class="token string">"api-ms-win-core-console-l2-1-0"</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>
        <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">unsafe</span> <span class="token keyword">extern</span> <span class="token return-type class-name">BOOL</span> <span class="token function">SetConsoleCursorInfo</span><span class="token punctuation">(</span><span class="token class-name">IntPtr</span> handle<span class="token punctuation">,</span> CONSOLE_CURSOR_INFO<span class="token operator">*</span> cursorInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">unsafe</span> <span class="token return-type class-name"><span class="token keyword">bool</span></span> CursorVisible
        <span class="token punctuation">{</span>
            <span class="token keyword">set</span>
            <span class="token punctuation">{</span>
                <span class="token class-name">CONSOLE_CURSOR_INFO</span> cursorInfo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">CONSOLE_CURSOR_INFO</span>
                <span class="token punctuation">{</span>
                    Size <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span>
                    Visible <span class="token operator">=</span> <span class="token keyword">value</span> <span class="token punctuation">?</span> BOOL<span class="token punctuation">.</span>TRUE <span class="token punctuation">:</span> BOOL<span class="token punctuation">.</span>FALSE
                <span class="token punctuation">}</span><span class="token punctuation">;</span>
                <span class="token function">SetConsoleCursorInfo</span><span class="token punctuation">(</span>s_outputHandle<span class="token punctuation">,</span> <span class="token operator">&amp;</span>cursorInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">DllImport</span><span class="token attribute-arguments"><span class="token punctuation">(</span><span class="token string">"api-ms-win-core-console-l2-1-0"</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>
        <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">unsafe</span> <span class="token keyword">extern</span> <span class="token return-type class-name">BOOL</span> <span class="token function">SetConsoleTextAttribute</span><span class="token punctuation">(</span><span class="token class-name">IntPtr</span> handle<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">ushort</span></span> attribute<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name">ConsoleColor</span> ForegroundColor
        <span class="token punctuation">{</span>
            <span class="token keyword">set</span>
            <span class="token punctuation">{</span>
                <span class="token function">SetConsoleTextAttribute</span><span class="token punctuation">(</span>s_outputHandle<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">ushort</span><span class="token punctuation">)</span><span class="token keyword">value</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">StructLayout</span><span class="token attribute-arguments"><span class="token punctuation">(</span>LayoutKind<span class="token punctuation">.</span>Sequential<span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>
        <span class="token keyword">private</span> <span class="token keyword">struct</span> <span class="token class-name">KEY_EVENT_RECORD</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">public</span> <span class="token class-name">BOOL</span> KeyDown<span class="token punctuation">;</span>
            <span class="token keyword">public</span> <span class="token class-name"><span class="token keyword">short</span></span> RepeatCount<span class="token punctuation">;</span>
            <span class="token keyword">public</span> <span class="token class-name"><span class="token keyword">short</span></span> VirtualKeyCode<span class="token punctuation">;</span>
            <span class="token keyword">public</span> <span class="token class-name"><span class="token keyword">short</span></span> VirtualScanCode<span class="token punctuation">;</span>
            <span class="token keyword">public</span> <span class="token class-name"><span class="token keyword">short</span></span> UChar<span class="token punctuation">;</span>
            <span class="token keyword">public</span> <span class="token class-name"><span class="token keyword">int</span></span> ControlKeyState<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">StructLayout</span><span class="token attribute-arguments"><span class="token punctuation">(</span>LayoutKind<span class="token punctuation">.</span>Sequential<span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>
        <span class="token keyword">private</span> <span class="token keyword">struct</span> <span class="token class-name">INPUT_RECORD</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">public</span> <span class="token class-name"><span class="token keyword">short</span></span> EventType<span class="token punctuation">;</span>
            <span class="token keyword">public</span> <span class="token class-name">KEY_EVENT_RECORD</span> KeyEvent<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">DllImport</span><span class="token attribute-arguments"><span class="token punctuation">(</span><span class="token string">"api-ms-win-core-console-l1-2-0"</span><span class="token punctuation">,</span> EntryPoint <span class="token operator">=</span> <span class="token string">"PeekConsoleInputW"</span><span class="token punctuation">,</span> CharSet <span class="token operator">=</span> CharSet<span class="token punctuation">.</span>Unicode<span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>
        <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">unsafe</span> <span class="token keyword">extern</span> <span class="token return-type class-name">BOOL</span> <span class="token function">PeekConsoleInput</span><span class="token punctuation">(</span><span class="token class-name">IntPtr</span> hConsoleInput<span class="token punctuation">,</span> INPUT_RECORD<span class="token operator">*</span> lpBuffer<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">uint</span></span> nLength<span class="token punctuation">,</span> <span class="token keyword">uint</span><span class="token operator">*</span> lpNumberOfEventsRead<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">unsafe</span> <span class="token return-type class-name"><span class="token keyword">bool</span></span> KeyAvailable
        <span class="token punctuation">{</span>
            <span class="token keyword">get</span>
            <span class="token punctuation">{</span>
                <span class="token class-name"><span class="token keyword">uint</span></span> nRead<span class="token punctuation">;</span>
                <span class="token class-name">INPUT_RECORD</span> buffer<span class="token punctuation">;</span>
                <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
                <span class="token punctuation">{</span>
                    <span class="token function">PeekConsoleInput</span><span class="token punctuation">(</span>s_inputHandle<span class="token punctuation">,</span> <span class="token operator">&amp;</span>buffer<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>nRead<span class="token punctuation">)</span><span class="token punctuation">;</span>

                    <span class="token keyword">if</span> <span class="token punctuation">(</span>nRead <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
                        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

                    <span class="token keyword">if</span> <span class="token punctuation">(</span>buffer<span class="token punctuation">.</span>EventType <span class="token operator">==</span> <span class="token number">1</span> <span class="token operator">&amp;&amp;</span> buffer<span class="token punctuation">.</span>KeyEvent<span class="token punctuation">.</span>KeyDown <span class="token operator">!=</span> BOOL<span class="token punctuation">.</span>FALSE<span class="token punctuation">)</span>
                        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>

                    <span class="token function">ReadConsoleInput</span><span class="token punctuation">(</span>s_inputHandle<span class="token punctuation">,</span> <span class="token operator">&amp;</span>buffer<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>nRead<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">DllImport</span><span class="token attribute-arguments"><span class="token punctuation">(</span><span class="token string">"api-ms-win-core-console-l1-2-0"</span><span class="token punctuation">,</span> EntryPoint <span class="token operator">=</span> <span class="token string">"ReadConsoleInputW"</span><span class="token punctuation">,</span> CharSet <span class="token operator">=</span> CharSet<span class="token punctuation">.</span>Unicode<span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>
        <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">unsafe</span> <span class="token keyword">extern</span> <span class="token return-type class-name">BOOL</span> <span class="token function">ReadConsoleInput</span><span class="token punctuation">(</span><span class="token class-name">IntPtr</span> hConsoleInput<span class="token punctuation">,</span> INPUT_RECORD<span class="token operator">*</span> lpBuffer<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">uint</span></span> nLength<span class="token punctuation">,</span> <span class="token keyword">uint</span><span class="token operator">*</span> lpNumberOfEventsRead<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">unsafe</span> <span class="token return-type class-name">ConsoleKeyInfo</span> <span class="token function">ReadKey</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">bool</span></span> intercept<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token class-name"><span class="token keyword">uint</span></span> nRead<span class="token punctuation">;</span>
            <span class="token class-name">INPUT_RECORD</span> buffer<span class="token punctuation">;</span>
            <span class="token keyword">do</span>
            <span class="token punctuation">{</span>
                <span class="token function">ReadConsoleInput</span><span class="token punctuation">(</span>s_inputHandle<span class="token punctuation">,</span> <span class="token operator">&amp;</span>buffer<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>nRead<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span>buffer<span class="token punctuation">.</span>EventType <span class="token operator">!=</span> <span class="token number">1</span> <span class="token operator">||</span> buffer<span class="token punctuation">.</span>KeyEvent<span class="token punctuation">.</span>KeyDown <span class="token operator">==</span> BOOL<span class="token punctuation">.</span>FALSE<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">ConsoleKeyInfo</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token punctuation">)</span>buffer<span class="token punctuation">.</span>KeyEvent<span class="token punctuation">.</span>UChar<span class="token punctuation">,</span> <span class="token punctuation">(</span>ConsoleKey<span class="token punctuation">)</span>buffer<span class="token punctuation">.</span>KeyEvent<span class="token punctuation">.</span>VirtualKeyCode<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">struct</span> <span class="token class-name">SMALL_RECT</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">public</span> <span class="token class-name"><span class="token keyword">short</span></span> Left<span class="token punctuation">,</span> Top<span class="token punctuation">,</span> Right<span class="token punctuation">,</span> Bottom<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">DllImport</span><span class="token attribute-arguments"><span class="token punctuation">(</span><span class="token string">"api-ms-win-core-console-l2-1-0"</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>
        <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">unsafe</span> <span class="token keyword">extern</span> <span class="token return-type class-name">BOOL</span> <span class="token function">SetConsoleWindowInfo</span><span class="token punctuation">(</span><span class="token class-name">IntPtr</span> handle<span class="token punctuation">,</span> <span class="token class-name">BOOL</span> absolute<span class="token punctuation">,</span> SMALL_RECT<span class="token operator">*</span> consoleWindow<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">unsafe</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">SetWindowSize</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">int</span></span> x<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">int</span></span> y<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token class-name">SMALL_RECT</span> rect <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">SMALL_RECT</span>
            <span class="token punctuation">{</span>
                Left <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>
                Top <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>
                Right <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">short</span><span class="token punctuation">)</span><span class="token punctuation">(</span>x <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                Bottom <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">short</span><span class="token punctuation">)</span><span class="token punctuation">(</span>y <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">;</span>
            <span class="token function">SetConsoleWindowInfo</span><span class="token punctuation">(</span>s_outputHandle<span class="token punctuation">,</span> BOOL<span class="token punctuation">.</span>TRUE<span class="token punctuation">,</span> <span class="token operator">&amp;</span>rect<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">StructLayout</span><span class="token attribute-arguments"><span class="token punctuation">(</span>LayoutKind<span class="token punctuation">.</span>Sequential<span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>
        <span class="token keyword">struct</span> <span class="token class-name">COORD</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">public</span> <span class="token class-name"><span class="token keyword">short</span></span> X<span class="token punctuation">,</span> Y<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">DllImport</span><span class="token attribute-arguments"><span class="token punctuation">(</span><span class="token string">"api-ms-win-core-console-l2-1-0"</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>
        <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">unsafe</span> <span class="token keyword">extern</span> <span class="token return-type class-name">BOOL</span> <span class="token function">SetConsoleScreenBufferSize</span><span class="token punctuation">(</span><span class="token class-name">IntPtr</span> handle<span class="token punctuation">,</span> <span class="token class-name">COORD</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">SetBufferSize</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">int</span></span> x<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">int</span></span> y<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token function">SetConsoleScreenBufferSize</span><span class="token punctuation">(</span>s_outputHandle<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">COORD</span> <span class="token punctuation">{</span> X <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">short</span><span class="token punctuation">)</span>x<span class="token punctuation">,</span> Y <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">short</span><span class="token punctuation">)</span>y <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">DllImport</span><span class="token attribute-arguments"><span class="token punctuation">(</span><span class="token string">"api-ms-win-core-console-l2-1-0"</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>
        <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">unsafe</span> <span class="token keyword">extern</span> <span class="token return-type class-name">BOOL</span> <span class="token function">SetConsoleCursorPosition</span><span class="token punctuation">(</span><span class="token class-name">IntPtr</span> handle<span class="token punctuation">,</span> <span class="token class-name">COORD</span> position<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">SetCursorPosition</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">int</span></span> x<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">int</span></span> y<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token function">SetConsoleCursorPosition</span><span class="token punctuation">(</span>s_outputHandle<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">COORD</span> <span class="token punctuation">{</span> X <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">short</span><span class="token punctuation">)</span>x<span class="token punctuation">,</span> Y <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">short</span><span class="token punctuation">)</span>y <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">DllImport</span><span class="token attribute-arguments"><span class="token punctuation">(</span><span class="token string">"api-ms-win-core-console-l1-2-0"</span><span class="token punctuation">,</span> EntryPoint <span class="token operator">=</span> <span class="token string">"WriteConsoleW"</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>
        <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">unsafe</span> <span class="token keyword">extern</span> <span class="token return-type class-name">BOOL</span> <span class="token function">WriteConsole</span><span class="token punctuation">(</span><span class="token class-name">IntPtr</span> handle<span class="token punctuation">,</span> <span class="token keyword">void</span><span class="token operator">*</span> buffer<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">int</span></span> numChars<span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token operator">*</span> charsWritten<span class="token punctuation">,</span> <span class="token keyword">void</span><span class="token operator">*</span> reserved<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">unsafe</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Write</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">char</span></span> c<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token class-name"><span class="token keyword">int</span></span> dummy<span class="token punctuation">;</span>
            <span class="token function">WriteConsole</span><span class="token punctuation">(</span>s_outputHandle<span class="token punctuation">,</span> <span class="token operator">&amp;</span>c<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>dummy<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code><button class="copy-code-button">Copy</button></pre></div><div><p dir="auto">Let’s rebuild the game with this replacement framework:</p></div><div><pre class="language-sh" tabindex="0"><code class="language-sh is-loaded">$ dotnet publish -r win-x64 -c Release /p:Mode=CoreRT-ReflectionFree /p:IncludePal=true
</code><button class="copy-code-button">Copy</button></pre></div><div><p dir="auto">Unsurprisingly, this didn’t save us much. The APIs we’re replacing are already relatively lightweight, and rewriting them only gains a couple kilobytes that are not worth mentioning. But this is an important stepping stone to the last step in our journey.</p></div></div></div><div class="heading-wrapper"><h1 data-heading="Replacing all runtime libraries" dir="auto" class="heading" id="Replacing_all_runtime_libraries">Replacing all runtime libraries</h1><div class="heading-children"><div><p dir="auto">The remaining 1.2 MB of code and data in the Snake game is there to support things we don’t see, but are there - ready in case we need them. There’s the garbage collector, support for exception handling, the code to format and print stack traces to the console when an unhandled exception happens, and many other things that are “under the hood”.</p></div><div><p dir="auto">The compiler could detect that none of this is needed and avoid generating them, but what we’re trying to do is so weird that it’s not worth adding compiler features to support it. The way to avoid it is to simply provide an alternative runtime library.</p></div><div><p dir="auto">Let’s start with redefining a minimal version of the base types:</p></div><div><pre class="language-csharp" tabindex="0"><code class="language-csharp is-loaded"><span class="token keyword">namespace</span> <span class="token namespace">System</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Object</span>
    <span class="token punctuation">{</span>
        <span class="token comment">// The layout of object is a contract with the compiler.</span>
        <span class="token keyword">public</span> <span class="token class-name">IntPtr</span> m_pEEType<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">struct</span> <span class="token class-name">Void</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>

    <span class="token comment">// The layout of primitive types is special cased because it would be recursive.</span>
    <span class="token comment">// These really don't need any fields to work.</span>
    <span class="token keyword">public</span> <span class="token keyword">struct</span> <span class="token class-name">Boolean</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">struct</span> <span class="token class-name">Char</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">struct</span> <span class="token class-name">SByte</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">struct</span> <span class="token class-name">Byte</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">struct</span> <span class="token class-name">Int16</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">struct</span> <span class="token class-name">UInt16</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">struct</span> <span class="token class-name">Int32</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">struct</span> <span class="token class-name">UInt32</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">struct</span> <span class="token class-name">Int64</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">struct</span> <span class="token class-name">UInt64</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">struct</span> <span class="token class-name">IntPtr</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">struct</span> <span class="token class-name">UIntPtr</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">struct</span> <span class="token class-name">Single</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">struct</span> <span class="token class-name">Double</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">ValueType</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">Enum</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">ValueType</span></span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">struct</span> <span class="token class-name">Nullable<span class="token punctuation">&lt;</span>T<span class="token punctuation">&gt;</span></span> <span class="token keyword">where</span> <span class="token class-name">T</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token keyword">struct</span></span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>
    
    <span class="token keyword">public</span> <span class="token keyword">sealed</span> <span class="token keyword">class</span> <span class="token class-name">String</span>
    <span class="token punctuation">{</span>
        <span class="token comment">// The layout of the string type is a contract with the compiler.</span>
        <span class="token keyword">public</span> <span class="token keyword">readonly</span> <span class="token class-name"><span class="token keyword">int</span></span> Length<span class="token punctuation">;</span>
        <span class="token keyword">public</span> <span class="token class-name"><span class="token keyword">char</span></span> _firstChar<span class="token punctuation">;</span>

        <span class="token keyword">public</span> <span class="token keyword">unsafe</span> <span class="token return-type class-name"><span class="token keyword">char</span></span> <span class="token keyword">this</span><span class="token punctuation">[</span><span class="token class-name"><span class="token keyword">int</span></span> index<span class="token punctuation">]</span>
        <span class="token punctuation">{</span>
            <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">System<span class="token punctuation">.</span>Runtime<span class="token punctuation">.</span>CompilerServices<span class="token punctuation">.</span>Intrinsic</span></span><span class="token punctuation">]</span>
            <span class="token keyword">get</span>
            <span class="token punctuation">{</span>
                <span class="token keyword">return</span> Internal<span class="token punctuation">.</span>Runtime<span class="token punctuation">.</span>CompilerServices<span class="token punctuation">.</span>Unsafe<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token keyword">ref</span> _firstChar<span class="token punctuation">,</span> index<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">Array</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">Delegate</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">MulticastDelegate</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">Delegate</span></span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">struct</span> <span class="token class-name">RuntimeTypeHandle</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">struct</span> <span class="token class-name">RuntimeMethodHandle</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">struct</span> <span class="token class-name">RuntimeFieldHandle</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Attribute</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">namespace</span> <span class="token namespace">System<span class="token punctuation">.</span>Runtime<span class="token punctuation">.</span>CompilerServices</span>
<span class="token punctuation">{</span>
    <span class="token keyword">internal</span> <span class="token keyword">sealed</span> <span class="token keyword">class</span> <span class="token class-name">IntrinsicAttribute</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">Attribute</span></span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RuntimeHelpers</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">unsafe</span> <span class="token return-type class-name"><span class="token keyword">int</span></span> OffsetToStringData <span class="token operator">=&gt;</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token type-expression class-name">IntPtr</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token type-expression class-name"><span class="token keyword">int</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">namespace</span> <span class="token namespace">System<span class="token punctuation">.</span>Runtime<span class="token punctuation">.</span>InteropServices</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">enum</span> <span class="token class-name">CharSet</span>
    <span class="token punctuation">{</span>
        None <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span>
        Ansi <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">,</span>
        Unicode <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">,</span>
        Auto <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">sealed</span> <span class="token keyword">class</span> <span class="token class-name">DllImportAttribute</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">Attribute</span></span>
    <span class="token punctuation">{</span>
        <span class="token keyword">public</span> <span class="token class-name"><span class="token keyword">string</span></span> EntryPoint<span class="token punctuation">;</span>
        <span class="token keyword">public</span> <span class="token class-name">CharSet</span> CharSet<span class="token punctuation">;</span>
        <span class="token keyword">public</span> <span class="token function">DllImportAttribute</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> dllName<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">enum</span> <span class="token class-name">LayoutKind</span>
    <span class="token punctuation">{</span>
        Sequential <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>
        Explicit <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">,</span>
        Auto <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">sealed</span> <span class="token keyword">class</span> <span class="token class-name">StructLayoutAttribute</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">Attribute</span></span>
    <span class="token punctuation">{</span>
        <span class="token keyword">public</span> <span class="token function">StructLayoutAttribute</span><span class="token punctuation">(</span><span class="token class-name">LayoutKind</span> layoutKind<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">namespace</span> <span class="token namespace">Internal<span class="token punctuation">.</span>Runtime<span class="token punctuation">.</span>CompilerServices</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">unsafe</span> <span class="token keyword">partial</span> <span class="token keyword">class</span> <span class="token class-name">Unsafe</span>
    <span class="token punctuation">{</span>
        <span class="token comment">// The body of this method is generated by the compiler.</span>
        <span class="token comment">// It will do what Unsafe.Add is expected to do. It's just not possible to express it in C#.</span>
        <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">System<span class="token punctuation">.</span>Runtime<span class="token punctuation">.</span>CompilerServices<span class="token punctuation">.</span>Intrinsic</span></span><span class="token punctuation">]</span>
        <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">extern</span> <span class="token keyword">ref</span> <span class="token return-type class-name">T</span> <span class="token generic-method"><span class="token function">Add</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>T<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token keyword">ref</span> <span class="token class-name">T</span> source<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">int</span></span> elementOffset<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code><button class="copy-code-button">Copy</button></pre></div><div><p dir="auto">At this point let’s forgo the project file and dotnet CLI and launch the individual tools directly. We start by launching the C# compiler (CSC). I recommend launching these commands from the “x64 Native Tools Command Prompt for VS 2019” - it’s in your Start menu if you have Visual Studio installed. The right version of tools is on the PATH in that window.</p></div><div><p dir="auto">The /noconfig, /nostdlib, and /runtimemetadataversion are the magic switches needed to compile something that defines System.Object. I chose the .ilexe file extension instead of .exe because .exe will be used for the finished product.</p></div><div><pre class="language-sh" tabindex="0"><code class="language-sh is-loaded">$ csc.exe /debug /O /noconfig /nostdlib /runtimemetadataversion:v4.0.30319 MiniBCL.cs Game\FrameBuffer.cs Game\Random.cs Game\Game.cs Game\Snake.cs Pal\Thread.Windows.cs Pal\Environment.Windows.cs Pal\Console.Windows.cs /out:zerosnake.ilexe /langversion:latest /unsafe
</code><button class="copy-code-button">Copy</button></pre></div><div><p dir="auto">This will successfully compile the IL bytecode version of the game with the C# compiler. We still need some sort of runtime to execute it.</p></div><div><p dir="auto">Let’s try to feed this to the CoreRT ahead of time compiler to generate native code from the IL. If you followed the steps above, you’ll find ilc.exe, the CoreRT ahead of time compiler, in your NuGet package cache (somewhere like %USERPROFILE%.nuget\packages\runtime.win-x64.microsoft.dotnet.ilcompiler\1.0.0-alpha-27402–01\Tools).</p></div><div><pre class="language-sh" tabindex="0"><code class="language-sh is-loaded">$ ilc.exe zerosnake.ilexe -o zerosnake.obj --systemmodule zerosnake --Os -g
</code><button class="copy-code-button">Copy</button></pre></div><div><p dir="auto">This is going to crash with “Expected type ‘Internal.Runtime.CompilerHelpers.StartupCodeHelpers’ not found in module ‘zerosnake’”. Turns out that besides the obvious minimum that a managed developer would expect, there’s also a minimum that the CoreRT compiler needs to compile the input.</p></div><div><p dir="auto">Let’s skip to the chase and add what’s needed:</p></div><div><pre class="language-csharp" tabindex="0"><code class="language-csharp is-loaded"><span class="token keyword">namespace</span> <span class="token namespace">Internal<span class="token punctuation">.</span>Runtime<span class="token punctuation">.</span>CompilerHelpers</span>
<span class="token punctuation">{</span>
    <span class="token comment">// A class that the compiler looks for that has helpers to initialize the</span>
    <span class="token comment">// process. The compiler can gracefully handle the helpers not being present,</span>
    <span class="token comment">// but the class itself being absent is unhandled. Let's add an empty class.</span>
    <span class="token keyword">class</span> <span class="token class-name">StartupCodeHelpers</span>
    <span class="token punctuation">{</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">namespace</span> <span class="token namespace">System</span>
<span class="token punctuation">{</span>
    <span class="token comment">// A special type that the compiler uses to implement generic interfaces</span>
    <span class="token comment">// (e.g. IEnumerable&lt;T&gt;) on arrays. Our arrays won't implement any generic interfaces.</span>
    <span class="token keyword">class</span> <span class="token class-name">Array<span class="token punctuation">&lt;</span>T<span class="token punctuation">&gt;</span></span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">Array</span></span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">namespace</span> <span class="token namespace">System<span class="token punctuation">.</span>Runtime<span class="token punctuation">.</span>InteropServices</span>
<span class="token punctuation">{</span>
    <span class="token comment">// Custom attribute that marks a class as having special "Call" intrinsics.</span>
    <span class="token comment">// The compiler has special logic handling types with this attribute.</span>
    <span class="token keyword">internal</span> <span class="token keyword">class</span> <span class="token class-name">McgIntrinsicsAttribute</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">Attribute</span></span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">namespace</span> <span class="token namespace">System<span class="token punctuation">.</span>Runtime<span class="token punctuation">.</span>CompilerServices</span>
<span class="token punctuation">{</span>
    <span class="token comment">// A class responsible for running static constructors. The compiler will call into this</span>
    <span class="token comment">// code to ensure static constructors run and that they only run once.</span>
    <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">System<span class="token punctuation">.</span>Runtime<span class="token punctuation">.</span>InteropServices<span class="token punctuation">.</span>McgIntrinsics</span></span><span class="token punctuation">]</span>
    <span class="token keyword">internal</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">ClassConstructorRunner</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">unsafe</span> <span class="token return-type class-name">IntPtr</span> <span class="token function">CheckStaticClassConstructionReturnNonGCStaticBase</span><span class="token punctuation">(</span><span class="token keyword">ref</span> <span class="token class-name">StaticClassConstructionContext</span> context<span class="token punctuation">,</span> <span class="token class-name">IntPtr</span> nonGcStaticBase<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token function">CheckStaticClassConstruction</span><span class="token punctuation">(</span><span class="token keyword">ref</span> context<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> nonGcStaticBase<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">unsafe</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">CheckStaticClassConstruction</span><span class="token punctuation">(</span><span class="token keyword">ref</span> <span class="token class-name">StaticClassConstructionContext</span> context<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token comment">// Very simplified class constructor runner. In real world, the class constructor runner</span>
            <span class="token comment">// would need to be able to deal with potentially multiple threads racing to initialize</span>
            <span class="token comment">// a single class, and would need to be able to deal with potential deadlocks</span>
            <span class="token comment">// between class constructors.</span>

            <span class="token comment">// If the class is already initialized, we're done.</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>context<span class="token punctuation">.</span>initialized <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>

            <span class="token comment">// Mark the class as initialized.</span>
            context<span class="token punctuation">.</span>initialized <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>

            <span class="token comment">// Run the class constructor.</span>
            <span class="token generic-method"><span class="token function">Call</span><span class="token generic class-name"><span class="token punctuation">&lt;</span><span class="token keyword">int</span><span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span>context<span class="token punctuation">.</span>cctorMethodAddress<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// This is a special compiler intrinsic that calls the method pointed to by pfn.</span>
        <span class="token comment">// The compiler generates code for this and we can just mark it `extern`.</span>
        <span class="token comment">// Once C# gets proper function pointer support (planned for C# 9), this won't be needed.</span>
        <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">System<span class="token punctuation">.</span>Runtime<span class="token punctuation">.</span>CompilerServices<span class="token punctuation">.</span>Intrinsic</span></span><span class="token punctuation">]</span>
        <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">extern</span> <span class="token return-type class-name">T</span> <span class="token generic-method"><span class="token function">Call</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>T<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token class-name">System<span class="token punctuation">.</span>IntPtr</span> pfn<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// This data structure is a contract with the compiler. It holds the address of a static</span>
    <span class="token comment">// constructor and a flag that specifies whether the constructor already executed.</span>
    <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">System<span class="token punctuation">.</span>Runtime<span class="token punctuation">.</span>InteropServices<span class="token punctuation">.</span>StructLayout</span><span class="token attribute-arguments"><span class="token punctuation">(</span>System<span class="token punctuation">.</span>Runtime<span class="token punctuation">.</span>InteropServices<span class="token punctuation">.</span>LayoutKind<span class="token punctuation">.</span>Sequential<span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>
    <span class="token keyword">public</span> <span class="token keyword">struct</span> <span class="token class-name">StaticClassConstructionContext</span>
    <span class="token punctuation">{</span>
        <span class="token comment">// Pointer to the code for the static class constructor method. This is initialized by the</span>
        <span class="token comment">// binder/runtime.</span>
        <span class="token keyword">public</span> <span class="token class-name">IntPtr</span> cctorMethodAddress<span class="token punctuation">;</span>

        <span class="token comment">// Initialization state of the class. This is initialized to 0. Every time managed code checks the</span>
        <span class="token comment">// cctor state the runtime will call the classlibrary's CheckStaticClassConstruction with this context</span>
        <span class="token comment">// structure unless initialized == 1. This check is specific to allow the classlibrary to store more</span>
        <span class="token comment">// than a binary state for each cctor if it so desires.</span>
        <span class="token keyword">public</span> <span class="token class-name"><span class="token keyword">int</span></span> initialized<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code><button class="copy-code-button">Copy</button></pre></div><div><p dir="auto">Let’s rebuild the IL bytecode with this newly added code and re-rerun ILC.</p></div><div><pre class="language-sh" tabindex="0"><code class="language-sh is-loaded">$ csc.exe /debug /O /noconfig /nostdlib /runtimemetadataversion:v4.0.30319 MiniRuntime.cs MiniBCL.cs Game\FrameBuffer.cs Game\Random.cs Game\Game.cs Game\Snake.cs Pal\Thread.Windows.cs Pal\Environment.Windows.cs Pal\Console.Windows.cs /out:zerosnake.ilexe /langversion:latest /unsafe
$ ilc.exe zerosnake.ilexe -o zerosnake.obj --systemmodule zerosnake --Os -g
</code><button class="copy-code-button">Copy</button></pre></div><div><p dir="auto">Now we have zerosnake.obj - a standard object file that is no different from object files produced by other native compilers such as C or C++. The last step is linking it. We’ll use the link.exe tool that should be on the PATH of our “x64 Native Tools Command Prompt” (you might need to install the C/C++ development tools in Visual Studio).</p></div><div><pre class="language-sh" tabindex="0"><code class="language-sh is-loaded">link.exe /debug:full /subsystem:console zerosnake.obj /entry:__managed__Main
</code><button class="copy-code-button">Copy</button></pre></div><div><p dir="auto">The <code>__managed__Main</code> symbol name is a contract with the compiler - it’s the name of the managed entrypoint of the program that ILC created.</p></div><div><p dir="auto">But it doesn’t work:</p></div><div><pre><code>error LNK2001: unresolved external symbol RhpPInvoke
error LNK2001: unresolved external symbol SetConsoleTextAttribute
error LNK2001: unresolved external symbol WriteConsoleW
error LNK2001: unresolved external symbol GetStdHandle
...
fatal error LNK1120: 17 unresolved externals
</code><button class="copy-code-button">Copy</button></pre></div><div><p dir="auto">Some of these symbols look familiar - the linker doesn’t know where to look for the Windows APIs we call. Let’s add the import libraries for those:</p></div><div><pre class="language-sh" tabindex="0"><code class="language-sh is-loaded">$ link.exe /debug:full /subsystem:console zerosnake.obj /entry:__managed__Main kernel32.lib ucrt.lib
</code><button class="copy-code-button">Copy</button></pre></div><div><p dir="auto">This looks better - only 4 unresolved symbols:</p></div><div><pre><code>error LNK2001: unresolved external symbol RhpPInvoke
error LNK2001: unresolved external symbol RhpPInvokeReturn
error LNK2001: unresolved external symbol RhpReversePInvoke2
error LNK2001: unresolved external symbol RhpReversePInvokeReturn2
fatal error LNK1120: 4 unresolved externals
</code><button class="copy-code-button">Copy</button></pre></div><div><p dir="auto">The remaining missing symbols are helpers that the compiler expects to find in the runtime library. The fact they’re missing is only discovered at the time of linking because these helpers are typically implemented in assembly and the compiler only refers to them by their symbolic name (as opposed to other compiler-required types and methods we provided above).</p></div><div><p dir="auto">The helpers set up and tear down the stack frames when native code calls into managed code, and managed code calls into native code. This is necessary for the GC to operate. Since we don’t have a GC, let’s stub them out with a piece of C# and another magical attribute that the compiler understands.</p></div><div><pre class="language-csharp" tabindex="0"><code class="language-csharp is-loaded"><span class="token keyword">namespace</span> <span class="token namespace">System<span class="token punctuation">.</span>Runtime</span>
<span class="token punctuation">{</span>
    <span class="token comment">// Custom attribute that the compiler understands that instructs it</span>
    <span class="token comment">// to export the method under the given symbolic name.</span>
    <span class="token keyword">internal</span> <span class="token keyword">sealed</span> <span class="token keyword">class</span> <span class="token class-name">RuntimeExportAttribute</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">Attribute</span></span>
    <span class="token punctuation">{</span>
        <span class="token keyword">public</span> <span class="token function">RuntimeExportAttribute</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> entry<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">namespace</span> <span class="token namespace">Internal<span class="token punctuation">.</span>Runtime<span class="token punctuation">.</span>CompilerHelpers</span>
<span class="token punctuation">{</span>
    <span class="token keyword">class</span> <span class="token class-name">StartupCodeHelpers</span>
    <span class="token punctuation">{</span>
        <span class="token comment">// The containing type for these methods doesn't matter.</span>
        <span class="token comment">// Let's park them in StarupCodeHelpers.</span>
        
        <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">System<span class="token punctuation">.</span>Runtime<span class="token punctuation">.</span>RuntimeExport</span><span class="token attribute-arguments"><span class="token punctuation">(</span><span class="token string">"RhpReversePInvoke2"</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>
        <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">RhpReversePInvoke2</span><span class="token punctuation">(</span><span class="token class-name">System<span class="token punctuation">.</span>IntPtr</span> frame<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>
        <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">System<span class="token punctuation">.</span>Runtime<span class="token punctuation">.</span>RuntimeExport</span><span class="token attribute-arguments"><span class="token punctuation">(</span><span class="token string">"RhpReversePInvokeReturn2"</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>
        <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">RhpReversePInvokeReturn2</span><span class="token punctuation">(</span><span class="token class-name">System<span class="token punctuation">.</span>IntPtr</span> frame<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>
        <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">System<span class="token punctuation">.</span>Runtime<span class="token punctuation">.</span>RuntimeExport</span><span class="token attribute-arguments"><span class="token punctuation">(</span><span class="token string">"RhpPInvoke"</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>
        <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">RhpPinvoke</span><span class="token punctuation">(</span><span class="token class-name">System<span class="token punctuation">.</span>IntPtr</span> frame<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>
        <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">System<span class="token punctuation">.</span>Runtime<span class="token punctuation">.</span>RuntimeExport</span><span class="token attribute-arguments"><span class="token punctuation">(</span><span class="token string">"RhpPInvokeReturn"</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>
        <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">RhpPinvokeReturn</span><span class="token punctuation">(</span><span class="token class-name">System<span class="token punctuation">.</span>IntPtr</span> frame<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code><button class="copy-code-button">Copy</button></pre></div><div><p dir="auto">After rebuilding the C# source code with these modifications and re-running ILC, the linking will finally succeed.</p></div><div><p dir="auto">We’re now at 27 kilobytes and the game still works!</p></div><div><p dir="auto"><a data-tooltip-position="top" aria-label="https://migeel.sk/blog/2020/01/03/building-a-self-contained-game-in-csharp-under-8-kilobytes/10-graph8.png" rel="noopener" class="external-link" href="https://migeel.sk/blog/2020/01/03/building-a-self-contained-game-in-csharp-under-8-kilobytes/10-graph8.png" target="_blank"><img alt="With runtime removed" src="https://migeel.sk/blog/2020/01/03/building-a-self-contained-game-in-csharp-under-8-kilobytes/10-graph8.png" referrerpolicy="no-referrer"></a></p></div><div><p dir="auto">With runtime removed</p></div></div></div><div class="heading-wrapper"><h1 data-heading="Messing with the linker" dir="auto" class="heading" id="Messing_with_the_linker">Messing with the linker</h1><div class="heading-children"><div><p dir="auto">The remaining kilobytes can be shaved off by using tricks native developers use to shrink their native apps.</p></div><div><p dir="auto">We’re going to:</p></div><div><ul>
<li data-line="0" dir="auto">Disable incremental linking</li>
<li data-line="1" dir="auto">Strip relocation information</li>
<li data-line="2" dir="auto">Merge similar sections within the executable</li>
<li data-line="3" dir="auto">Set internal alignment within the executable to a small value</li>
</ul></div><div><pre class="language-sh" tabindex="0"><code class="language-sh is-loaded">$ link.exe /debug:full /subsystem:console zerosnake.obj /entry:__managed__Main kernel32.lib ucrt.lib /merge:.modules=.rdata /merge:.pdata=.rdata /incremental:no /DYNAMICBASE:NO /filealign:16 /align:16
</code><button class="copy-code-button">Copy</button></pre></div><div><p dir="auto">Success! 8176 bytes!</p></div><div><p dir="auto">The game still works, and interestingly, it’s still fully debuggable - feel free to open the EXE in Visual Studio (File -&gt; Open Solution), open one of the C# files that are part of the game, set a breakpoint in it, hit F5 to launch the EXE, and see the breakpoint getting hit. You can disable optimizations in ILC to make the executable even more debuggable - just drop the –Os argument.</p></div><div><p dir="auto"><a data-tooltip-position="top" aria-label="https://migeel.sk/blog/2020/01/03/building-a-self-contained-game-in-csharp-under-8-kilobytes/11-graph9.png" rel="noopener" class="external-link" href="https://migeel.sk/blog/2020/01/03/building-a-self-contained-game-in-csharp-under-8-kilobytes/11-graph9.png" target="_blank"><img alt="After messing with linker" src="https://migeel.sk/blog/2020/01/03/building-a-self-contained-game-in-csharp-under-8-kilobytes/11-graph9.png" referrerpolicy="no-referrer"></a></p></div><div><p dir="auto">After messing with linker</p></div></div></div><div class="heading-wrapper"><h1 data-heading="Can we make things smaller than that?" dir="auto" class="heading" id="Can_we_make_things_smaller_than_that?">Can we make things smaller than that?</h1><div class="heading-children"><div><p dir="auto">The executable still carries some data that is not essential - the ILC compiler just doesn’t expose command line options to disable their generation.</p></div><div><p dir="auto">One of those data structures that gets generated but we don’t need is GC information for the individual methods. CoreRT has a precise garbage collector that requires each method to describe where references to GC heap are at each instruction of the method body. Since we don’t have a garbage collector in the Snake game, this data is unnecessary. Other runtimes (e.g. Mono) use a conservative garbage collector that doesn’t require this data (it simply assumes any piece of the stack and CPU registers could be a GC reference) - a conservative garbage collector trades GC performance for extra size savings. The precise garbage collector used in CoreRT can operate in conservative mode too, but it hasn’t been hooked up yet. It’s a potential future addition that we could then leverage to make things even smaller.</p></div><div><p dir="auto">Maybe one day we can make a simplified version of our game fit into a 512 byte boot sector. Until then, happy hacking!</p></div><div class="mod-footer"></div></div></div></div></div></div><div class="sidebar-right sidebar"><div class="sidebar-handle"></div><div class="sidebar-topbar"><div class="topbar-content"></div><div class="clickable-icon sidebar-collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" class="svg-icon"><path d="M21 3H3C1.89543 3 1 3.89543 1 5V19C1 20.1046 1.89543 21 3 21H21C22.1046 21 23 20.1046 23 19V5C23 3.89543 22.1046 3 21 3Z"></path><path d="M10 4V20"></path><path d="M4 7H7"></path><path d="M4 10H7"></path><path d="M4 13H7"></path></svg></div></div><div class="sidebar-content"><div class="graph-view-wrapper"><div class="sidebar-section-header">Interactive Graph</div><div class="graph-view-placeholder">
		<div class="graph-view-container">
			<div class="graph-icon graph-expand" role="button" aria-label="Expand" data-tooltip-position="top"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon"><line x1="7" y1="17" x2="17" y2="7"></line><polyline points="7 7 17 7 17 17"></polyline></svg></div>
			<canvas id="graph-canvas" class="hide" width="512px" height="512px"></canvas>
		</div>
		</div></div><div class="tree-container mod-root nav-folder tree-item outline-tree" data-depth="0"><div class="tree-header"><span class="sidebar-section-header">Table Of Contents</span><button class="clickable-icon collapse-tree-button" aria-label="Collapse All"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></svg></button></div><div class="tree-scroll-area tree-item-children nav-folder-children"><div class="tree-item mod-tree-folder nav-folder mod-collapsible is-collapsed" style="display: none;"></div><div class="tree-item" data-depth="1"><a class="tree-link" href="computer-science/programming-language/csharp/building-a-self-contained-game-in-csharp-under-8-kilobytes.html#Building a self-contained game in CSharp under 8 kilobytes"><div class="tree-item-contents heading-link" heading-name="Building a self-contained game in CSharp under 8 kilobytes"><span class="tree-item-title">Building a self-contained game in CSharp under 8 kilobytes</span></div></a><div class="tree-item-children nav-folder-children"><div class="tree-item" data-depth="3"><a class="tree-link" href="computer-science/programming-language/csharp/building-a-self-contained-game-in-csharp-under-8-kilobytes.html#How_I_fit_a_Snake_game_in_C#_into_8_kilobytes,_with_no_.NET_runtime_required."><div class="tree-item-contents heading-link" heading-name="How I fit a Snake game in C# into 8 kilobytes, with no .NET runtime required."><span class="tree-item-title">How I fit a Snake game in C# into 8 kilobytes, with no .NET runtime required.</span></div></a><div class="tree-item-children nav-folder-children"></div></div></div></div><div class="tree-item" data-depth="1"><a class="tree-link" href="computer-science/programming-language/csharp/building-a-self-contained-game-in-csharp-under-8-kilobytes.html#What_exactly_is_“self-contained”?"><div class="tree-item-contents heading-link" heading-name="What exactly is “self-contained”?"><span class="tree-item-title">What exactly is “self-contained”?</span></div></a><div class="tree-item-children nav-folder-children"></div></div><div class="tree-item" data-depth="1"><a class="tree-link" href="computer-science/programming-language/csharp/building-a-self-contained-game-in-csharp-under-8-kilobytes.html#The_8_kB_game"><div class="tree-item-contents heading-link" heading-name="The 8 kB game"><span class="tree-item-title">The 8 kB game</span></div></a><div class="tree-item-children nav-folder-children"></div></div><div class="tree-item" data-depth="1"><a class="tree-link" href="computer-science/programming-language/csharp/building-a-self-contained-game-in-csharp-under-8-kilobytes.html#A_no-allocation_game"><div class="tree-item-contents heading-link" heading-name="A no-allocation game"><span class="tree-item-title">A no-allocation game</span></div></a><div class="tree-item-children nav-folder-children"></div></div><div class="tree-item" data-depth="1"><a class="tree-link" href="computer-science/programming-language/csharp/building-a-self-contained-game-in-csharp-under-8-kilobytes.html#The_game_structure"><div class="tree-item-contents heading-link" heading-name="The game structure"><span class="tree-item-title">The game structure</span></div></a><div class="tree-item-children nav-folder-children"></div></div><div class="tree-item" data-depth="1"><a class="tree-link" href="computer-science/programming-language/csharp/building-a-self-contained-game-in-csharp-under-8-kilobytes.html#The_default_size_of_a_.NET_Core_3.0_Snake"><div class="tree-item-contents heading-link" heading-name="The default size of a .NET Core 3.0 Snake"><span class="tree-item-title">The default size of a .NET Core 3.0 Snake</span></div></a><div class="tree-item-children nav-folder-children"></div></div><div class="tree-item" data-depth="1"><a class="tree-link" href="computer-science/programming-language/csharp/building-a-self-contained-game-in-csharp-under-8-kilobytes.html#IL_Trimming"><div class="tree-item-contents heading-link" heading-name="IL Trimming"><span class="tree-item-title">IL Trimming</span></div></a><div class="tree-item-children nav-folder-children"></div></div><div class="tree-item" data-depth="1"><a class="tree-link" href="computer-science/programming-language/csharp/building-a-self-contained-game-in-csharp-under-8-kilobytes.html#Slight_detour:_Mono"><div class="tree-item-contents heading-link" heading-name="Slight detour: Mono"><span class="tree-item-title">Slight detour: Mono</span></div></a><div class="tree-item-children nav-folder-children"></div></div><div class="tree-item" data-depth="1"><a class="tree-link" href="computer-science/programming-language/csharp/building-a-self-contained-game-in-csharp-under-8-kilobytes.html#Can_we_take_the_runtime_out?"><div class="tree-item-contents heading-link" heading-name="Can we take the runtime out?"><span class="tree-item-title">Can we take the runtime out?</span></div></a><div class="tree-item-children nav-folder-children"></div></div><div class="tree-item" data-depth="1"><a class="tree-link" href="computer-science/programming-language/csharp/building-a-self-contained-game-in-csharp-under-8-kilobytes.html#Turning_on_high_savings_in_CoreRT"><div class="tree-item-contents heading-link" heading-name="Turning on high savings in CoreRT"><span class="tree-item-title">Turning on high savings in CoreRT</span></div></a><div class="tree-item-children nav-folder-children"></div></div><div class="tree-item" data-depth="1"><a class="tree-link" href="computer-science/programming-language/csharp/building-a-self-contained-game-in-csharp-under-8-kilobytes.html#Disabling_reflection"><div class="tree-item-contents heading-link" heading-name="Disabling reflection"><span class="tree-item-title">Disabling reflection</span></div></a><div class="tree-item-children nav-folder-children"></div></div><div class="tree-item" data-depth="1"><a class="tree-link" href="computer-science/programming-language/csharp/building-a-self-contained-game-in-csharp-under-8-kilobytes.html#Getting_our_hands_dirty"><div class="tree-item-contents heading-link" heading-name="Getting our hands dirty"><span class="tree-item-title">Getting our hands dirty</span></div></a><div class="tree-item-children nav-folder-children"></div></div><div class="tree-item" data-depth="1"><a class="tree-link" href="computer-science/programming-language/csharp/building-a-self-contained-game-in-csharp-under-8-kilobytes.html#Replacing_all_runtime_libraries"><div class="tree-item-contents heading-link" heading-name="Replacing all runtime libraries"><span class="tree-item-title">Replacing all runtime libraries</span></div></a><div class="tree-item-children nav-folder-children"></div></div><div class="tree-item" data-depth="1"><a class="tree-link" href="computer-science/programming-language/csharp/building-a-self-contained-game-in-csharp-under-8-kilobytes.html#Messing_with_the_linker"><div class="tree-item-contents heading-link" heading-name="Messing with the linker"><span class="tree-item-title">Messing with the linker</span></div></a><div class="tree-item-children nav-folder-children"></div></div><div class="tree-item" data-depth="1"><a class="tree-link" href="computer-science/programming-language/csharp/building-a-self-contained-game-in-csharp-under-8-kilobytes.html#Can_we_make_things_smaller_than_that?"><div class="tree-item-contents heading-link" heading-name="Can we make things smaller than that?"><span class="tree-item-title">Can we make things smaller than that?</span></div></a><div class="tree-item-children nav-folder-children"></div></div></div></div></div><script defer="">let rs = document.querySelector(".sidebar-right"); rs.classList.add("is-collapsed"); if (window.innerWidth > 768) rs.classList.remove("is-collapsed"); rs.style.setProperty("--sidebar-width", localStorage.getItem("sidebar-right-width"));</script></div></div></body></html>