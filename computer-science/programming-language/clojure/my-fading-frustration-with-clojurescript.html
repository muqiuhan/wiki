<!DOCTYPE html> <html><head>
		<title>My fading frustration with ClojureScript</title>
		<base href="../../../">
		<meta id="root-path" root-path="../../../">
		<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes, minimum-scale=1.0, maximum-scale=5.0">
		<meta charset="UTF-8">
		<meta name="description" content="韩暮秋的个人维基 - My fading frustration with ClojureScript">
		<meta property="og:title" content="My fading frustration with ClojureScript">
		<meta property="og:description" content="韩暮秋的个人维基 - My fading frustration with ClojureScript">
		<meta property="og:type" content="website">
		<meta property="og:url" content="https://muqiuhan.github.io/wiki/computer-science/programming-language/clojure/my-fading-frustration-with-clojurescript.html">
		<meta property="og:image" content="undefined">
		<meta property="og:site_name" content="韩暮秋的个人维基">
		<meta name="author" content="韩暮秋"><link rel="alternate" type="application/rss+xml" title="RSS Feed" href="https://muqiuhan.github.io/wiki/lib/rss.xml"><script async="" id="webpage-script" src="lib/scripts/webpage.js" onload="this.onload=null;this.setAttribute(&quot;loaded&quot;, &quot;true&quot;)"></script><script type="module" async="" id="graph-view-script" src="lib/scripts/graph-view.js"></script><script async="" id="graph-wasm-script" src="lib/scripts/graph-wasm.js" onload="this.onload=null;this.setAttribute(&quot;loaded&quot;, &quot;true&quot;)"></script><script async="" id="graph-render-worker-script" src="lib/scripts/graph-render-worker.js" onload="this.onload=null;this.setAttribute(&quot;loaded&quot;, &quot;true&quot;)"></script><script async="" id="tinycolor-script" src="lib/scripts/tinycolor.js" onload="this.onload=null;this.setAttribute(&quot;loaded&quot;, &quot;true&quot;)"></script><script async="" id="pixi-script" src="lib/scripts/pixi.js" onload="this.onload=null;this.setAttribute(&quot;loaded&quot;, &quot;true&quot;)"></script><script async="" id="minisearch-script" src="lib/scripts/minisearch.js" onload="this.onload=null;this.setAttribute(&quot;loaded&quot;, &quot;true&quot;)"></script><link rel="icon" href="lib/media/favicon.ico"><script async="" id="graph-data-script" src="lib/scripts/graph-data.js" onload="this.onload=null;this.setAttribute(&quot;loaded&quot;, &quot;true&quot;)"></script><style>body{--line-width:40em;--line-width-adaptive:40em;--file-line-width:40em;--sidebar-width:min(20em, 80vw);--collapse-arrow-size:11px;--tree-horizontal-spacing:0.6em;--tree-vertical-spacing:0.6em;--sidebar-margin:12px}.sidebar{height:100%;min-width:calc(var(--sidebar-width) + var(--divider-width-hover));max-width:calc(var(--sidebar-width) + var(--divider-width-hover));font-size:14px;z-index:10;position:relative;overflow:hidden;transition:min-width ease-in-out,max-width ease-in-out;transition-duration:.2s;contain:size}.sidebar-left{left:0}.sidebar-right{right:0}.sidebar.is-collapsed{min-width:0;max-width:0}body.floating-sidebars .sidebar{position:absolute}.sidebar-content{height:100%;min-width:calc(var(--sidebar-width) - var(--divider-width-hover));top:0;padding:var(--sidebar-margin);padding-top:4em;line-height:var(--line-height-tight);background-color:var(--background-secondary);transition:background-color,border-right,border-left,box-shadow;transition-duration:var(--color-fade-speed);transition-timing-function:ease-in-out;position:absolute;display:flex;flex-direction:column}.sidebar:not(.is-collapsed) .sidebar-content{min-width:calc(max(100%,var(--sidebar-width)) - 3px);max-width:calc(max(100%,var(--sidebar-width)) - 3px)}.sidebar-left .sidebar-content{left:0;border-top-right-radius:var(--radius-l);border-bottom-right-radius:var(--radius-l)}.sidebar-right .sidebar-content{right:0;border-top-left-radius:var(--radius-l);border-bottom-left-radius:var(--radius-l)}.sidebar:has(.sidebar-content:empty):has(.topbar-content:empty){display:none}.sidebar-topbar{height:2em;width:var(--sidebar-width);top:var(--sidebar-margin);padding-inline:var(--sidebar-margin);z-index:1;position:fixed;display:flex;align-items:center;transition:width ease-in-out;transition-duration:inherit}.sidebar.is-collapsed .sidebar-topbar{width:calc(2.3em + var(--sidebar-margin) * 2)}.sidebar .sidebar-topbar.is-collapsed{width:0}.sidebar-left .sidebar-topbar{left:0}.sidebar-right .sidebar-topbar{right:0}.topbar-content{overflow:hidden;overflow:clip;width:100%;height:100%;display:flex;align-items:center;transition:inherit}.sidebar.is-collapsed .topbar-content{width:0;transition:inherit}.clickable-icon.sidebar-collapse-icon{background-color:transparent;color:var(--icon-color-focused);padding:0!important;margin:0!important;height:100%!important;width:2.3em!important;margin-inline:0.14em!important;position:absolute}.sidebar-left .clickable-icon.sidebar-collapse-icon{transform:rotateY(180deg);right:var(--sidebar-margin)}.sidebar-right .clickable-icon.sidebar-collapse-icon{transform:rotateY(180deg);left:var(--sidebar-margin)}.clickable-icon.sidebar-collapse-icon svg.svg-icon{width:100%;height:100%}.sidebar-section-header{margin:0 0 1em 0;text-transform:uppercase;letter-spacing:.06em;font-weight:600}body{transition:background-color var(--color-fade-speed) ease-in-out}.webpage-container{display:flex;flex-direction:row;height:100%;width:100%;align-items:stretch;justify-content:center}.document-container{opacity:1;flex-basis:100%;max-width:100%;width:100%;height:100%;display:flex;flex-direction:column;align-items:center;transition:opacity .2s ease-in-out;contain:inline-size}.hide{opacity:0;transition:opacity .2s ease-in-out}.document-container>.markdown-preview-view{margin:var(--sidebar-margin);margin-bottom:0;width:100%;width:-webkit-fill-available;width:-moz-available;width:fill-available;background-color:var(--background-primary);transition:background-color var(--color-fade-speed) ease-in-out;border-top-right-radius:var(--window-radius,var(--radius-m));border-top-left-radius:var(--window-radius,var(--radius-m));overflow-x:hidden!important;overflow-y:auto!important;display:flex!important;flex-direction:column!important;align-items:center!important;contain:inline-size}.document-container>.markdown-preview-view>.markdown-preview-sizer{padding-bottom:80vh!important;width:100%!important;max-width:var(--line-width)!important;flex-basis:var(--line-width)!important;transition:background-color var(--color-fade-speed) ease-in-out;contain:inline-size}.markdown-rendered img:not([width]),.view-content img:not([width]){max-width:100%;outline:0}.document-container>.view-content.embed{display:flex;padding:1em;height:100%;width:100%;align-items:center;justify-content:center}.document-container>.view-content.embed>*{max-width:100%;max-height:100%;object-fit:contain}:has(> :is(.math,table)){overflow-x:auto!important}.document-container>.view-content{overflow-x:auto;contain:content;padding:0;margin:0;height:100%}.scroll-highlight{position:absolute;width:100%;height:100%;pointer-events:none;z-index:1000;background-color:hsla(var(--color-accent-hsl),.25);opacity:0;padding:1em;inset:50%;translate:-50% -50%;border-radius:var(--radius-s)}</style><script defer="">async function loadIncludes(){if("file:"!=location.protocol){let e=document.querySelectorAll("include");for(let t=0;t<e.length;t++){let o=e[t],l=o.getAttribute("src");try{const e=await fetch(l);if(!e.ok){console.log("Could not include file: "+l),o?.remove();continue}let t=await e.text(),n=document.createRange().createContextualFragment(t),i=Array.from(n.children);for(let e of i)e.classList.add("hide"),e.style.transition="opacity 0.5s ease-in-out",setTimeout((()=>{e.classList.remove("hide")}),10);o.before(n),o.remove(),console.log("Included file: "+l)}catch(e){o?.remove(),console.log("Could not include file: "+l,e);continue}}}else{if(document.querySelectorAll("include").length>0){var e=document.createElement("div");e.id="error",e.textContent="Web server exports must be hosted on an http / web server to be viewed correctly.",e.style.position="fixed",e.style.top="50%",e.style.left="50%",e.style.transform="translate(-50%, -50%)",e.style.fontSize="1.5em",e.style.fontWeight="bold",e.style.textAlign="center",document.body.appendChild(e),document.querySelector(".document-container")?.classList.remove("hide")}}}document.addEventListener("DOMContentLoaded",(()=>{loadIncludes()}));let isFileProtocol="file:"==location.protocol;function waitLoadScripts(e,t){let o=e.map((e=>document.getElementById(e+"-script"))),l=0;!function e(){let n=o[l];l++,n&&"true"!=n.getAttribute("loaded")||l<o.length&&e(),l<o.length?n.addEventListener("load",e):t()}()}</script><link rel="stylesheet" href="lib/styles/obsidian.css"><link rel="preload" href="lib/styles/other-plugins.css" as="style" onload="this.onload=null;this.rel='stylesheet'"><noscript><link rel="stylesheet" href="lib/styles/other-plugins.css"></noscript><link rel="stylesheet" href="lib/styles/theme.css"><link rel="preload" href="lib/styles/global-variable-styles.css" as="style" onload="this.onload=null;this.rel='stylesheet'"><noscript><link rel="stylesheet" href="lib/styles/global-variable-styles.css"></noscript><link rel="preload" href="lib/styles/main-styles.css" as="style" onload="this.onload=null;this.rel='stylesheet'"><noscript><link rel="stylesheet" href="lib/styles/main-styles.css"></noscript></head><body class="publish css-settings-manager theme-light show-inline-title show-ribbon pt-color-scheme-style-minimal-lt pt-accent-style-borderandfilled-lt pt-accent-color-grey-lt pt-highlight-text-accent-lt pt-accent-style-borderandfilled-dt pt-accent-color-purple-dt pt-highlight-text-accent-dt pt-focused-style-main-only pt-font-disable-ligatures pt-highlight-style-borderandfilled-lt pt-highlight-text-color-lt pt-highlight-style-borderandfilled-dt pt-highlight-text-color-dt pt-file-explorer-folder-icon-default pt-colored-folders-style-rainbow pt-center-kanban-title-text pt-kanban-background-grid-lt pt-kanban-background-grid-dt pt-icon-folder-accent"><script defer="">let theme=localStorage.getItem("theme")||(window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light");"dark"==theme?(document.body.classList.add("theme-dark"),document.body.classList.remove("theme-light")):(document.body.classList.add("theme-light"),document.body.classList.remove("theme-dark")),window.innerWidth<480?document.body.classList.add("is-phone"):window.innerWidth<768?document.body.classList.add("is-tablet"):window.innerWidth<1024?document.body.classList.add("is-small-screen"):document.body.classList.add("is-large-screen")</script><div class="webpage-container workspace"><div class="sidebar-left sidebar"><div class="sidebar-handle"></div><div class="sidebar-topbar"><div class="topbar-content"><label class="theme-toggle-container" for="theme_toggle"><input class="theme-toggle-input" type="checkbox" id="theme_toggle"><div class="toggle-background"></div></label></div><div class="clickable-icon sidebar-collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" class="svg-icon"><path d="M21 3H3C1.89543 3 1 3.89543 1 5V19C1 20.1046 1.89543 21 3 21H21C22.1046 21 23 20.1046 23 19V5C23 3.89543 22.1046 3 21 3Z"></path><path d="M10 4V20"></path><path d="M4 7H7"></path><path d="M4 10H7"></path><path d="M4 13H7"></path></svg></div></div><div class="sidebar-content"><div class="search-input-container"><input enterkeyhint="search" type="search" spellcheck="false" placeholder="Search..."><div class="search-input-clear-button" aria-label="Clear search"></div></div><include src="lib/html/file-tree.html"></include></div><script defer="">let ls = document.querySelector(".sidebar-left"); ls.classList.add("is-collapsed"); if (window.innerWidth > 768) ls.classList.remove("is-collapsed"); ls.style.setProperty("--sidebar-width", localStorage.getItem("sidebar-left-width"));</script></div><div class="document-container markdown-reading-view hide"><div class="markdown-preview-view markdown-rendered allow-fold-headings allow-fold-lists is-readable-line-width"><style id="MJX-CHTML-styles"></style><div class="markdown-preview-sizer markdown-preview-section"><h1 class="page-title heading inline-title" id="My fading frustration with ClojureScript"><p dir="auto">My fading frustration with ClojureScript</p></h1><div><p dir="auto">I’ve talked about <a data-tooltip-position="top" aria-label="https://mauricio.szabo.link/blog/2018/04/05/my-frustration-with-clojurescript/" rel="noopener" class="external-link" href="https://mauricio.szabo.link/blog/2018/04/05/my-frustration-with-clojurescript/" target="_blank">at another post</a> on how ClojureScript frustrates me, mostly because I was doing some Node.JS work and Figwheel simply wasn’t working correctly. Now, it’s time to revisit these points:</p></div><div><p dir="auto"><em>A little update</em>: I talked a little with Thomas Heller, Shadow-CLJS creator, and he pointed me some issues with this article, so I’ll update it acordingly</p></div><div class="heading-wrapper"><h2 data-heading="Tooling" dir="auto" class="heading" id="Tooling"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>Tooling</h2><div class="heading-children"><div><p dir="auto">Figwheel and Lein are not the best tools to work with ClojureScript. Since I discovered shadow-cljs, things are working way better than before: I can reload ClojureScript code from any target, and I’m even experimenting with Hubot (and it works really fine too). The only thing I’m missing is my <code>profiles.clj</code> file, but I can live with that (and I can always use Shadow with Lein if I need profiles.clj).</p></div><div><p dir="auto">Also, I’m working on a new package for Atom (and in the future, for another editors too) called <a data-tooltip-position="top" aria-label="http://github.com/mauricioszabo/atom-chlorine/" rel="noopener" class="external-link" href="http://github.com/mauricioszabo/atom-chlorine/" target="_blank">Chlorine</a>. One of the ideas is to offer better ClojureScript support (we have Autocomplete now!), using Socket REPL for solutions (even self-hosted REPLs like Lumo and Plank) and even wrap UNREPL protocol in Clojure. So far, is still in the very beginning but things are looking promising!</p></div></div></div><div class="heading-wrapper"><h2 data-heading="The stack" dir="auto" class="heading" id="The_stack"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>The stack</h2><div class="heading-children"><div><p dir="auto">Forget Figwheel <em>at all</em>: Shadow-CLJS is probably the best tooling for ClojureScript <strong>ever</strong>. It auto-reloads ClojureScript code for the browser, for node.js, for node modules, and it integrates with almost everything that you want. It controls release optimizations, have sensible defaults, and even have post-compile hooks (so you can hook Clojure code to do something after some compilation phases). Also, it integrates with node-modules (no more maven-wrappers for JS libraries!) and have some warnings when you use some kind of ClojureScript code that would break <code>:advanced</code> compilation. And, let’s not forget that you can control the refresh reload phase, it adds a userful <code>:include-macros</code> in <code>ns</code> form (that will include all macros from the namespace being required), and controls exports in a sane manner. But first let’s begin with the feature that I found most useful: <code>:before-load-async</code>.  </p></div><div><p dir="auto">When you’re developing ClojureScript code, one of the killer features is the abilty to reload your code after save, so at any moment you have the most recent version of your code running. Let’s see how it works in practice: imagine you’re developing a simple static website (no react, no vue.js, nothing – just a simple site that’ll calculate the sum of two input boxes). You already have the HTML file with two input boxes (IDs “n1” and “n2”) and a “results” div. You’ll want to add Shadow-CLJS in this project.</p></div><div><p dir="auto">Simple: just <code>npm install shadow-cljs</code>, then <code>npx shadow-cljs init</code>, and edit the <code>shadow-cljs.edn</code> file. You’ll want to add a build targeting browser, so the file will look like this:</p></div><div dir="auto" style="overflow-x: auto;"><table>
<thead>
<tr>
<th dir="auto"></th>
<th dir="auto"></th>
</tr>
</thead>
<tbody>
<tr>
<td dir="auto">1<br><br>2<br><br>3<br><br>4<br><br>5<br><br>6<br><br>7<br><br>8</td>
<td dir="ltr"><code>{``:source-paths</code> <code>[``"src"``]</code><br><br>&nbsp;<code>:dependencies</code> <code>[``]</code><br><br>&nbsp;<code>:builds</code> <code>{``:app</code> <code>{``:target</code> <code>:browser</code><br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<code>:modules</code> <code>{``:main</code> <code>{``:init-fn</code> <code>calc.core/main}}</code><br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<code>:output-dir</code> <code>"js"</code><br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<code>:asset-path</code> <code>"js"</code><br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<code>:devtools</code><br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<code>{``:before-load-async</code> <code>calc.core/reload}}}}</code></td>
</tr>
</tbody>
</table></div><div><p dir="auto">Most of the keys should be self-explanatory. The ones that are not are:</p></div><div><ul>
<li data-line="0" dir="auto"><code>:asset-path</code> mostly says that, relative to the root of your webserver, where assets will be put – for instance, suppose that your webserver will load static assets from the <code>public</code> directory. Then, your config will be <code>:output-dir "public/js"</code>, so that the compiler will generate code in a folder that your webserver will be able to serve, and <code>:asset-path "js"</code>, so the compiler will generate “requires” relative to “js” folder, not “public/js”</li>
<li data-line="1" dir="auto"><code>:devtools</code> registers a “hook function” that’ll be called when Shadow-CLJS have compiled the source paths, and it is ready to reload our code. This “reload function” will receive a parameter (let’s call it <code>done</code>) that, when called, it informs shadow-cljs that it’s time to use the new versions of our functions. So, let’s first look at the <code>main</code> function:</li>
</ul></div><div dir="auto" style="overflow-x: auto;"><table>
<thead>
<tr>
<th dir="auto"></th>
<th dir="auto"></th>
</tr>
</thead>
<tbody>
<tr>
<td dir="auto">1<br><br>2<br><br>3<br><br>4<br><br>5<br><br>6<br><br>7<br><br>8<br><br>9<br><br>10</td>
<td dir="ltr"><code>(``ns</code> <code>calc.core)</code><br><br><code>(``defn``- calculate-res</code> <code>[``]</code><br><br>&nbsp;&nbsp;<code>(``let</code> <code>[``n1 (-&gt; (js/jQuery</code> <code>"#n1"``) .val (js/parseInt))</code><br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<code>n2 (-&gt; (js/jQuery</code> <code>"#n2"``) .val (js/parseInt))``]</code><br><br>&nbsp;&nbsp;&nbsp;&nbsp;<code>(prn</code> <code>[``n1 n2``]``)</code><br><br>&nbsp;&nbsp;&nbsp;&nbsp;<code>(. (js/jQuery</code> <code>"#result"``) (text (+ n1 n2)))))</code><br><br><code>(``defn</code> <code>main</code> <code>[``]</code><br><br>&nbsp;&nbsp;<code>(. (js/jQuery</code> <code>"input"``) (on</code> <code>"input"</code> <code>""</code> <code>calculate-res)))</code></td>
</tr>
</tbody>
</table></div><div><p dir="auto">You can start our compiler with <code>npx shadow-cljs watch app</code>, and yes, we’re using jQuery. Also, there’s a <code>prn</code> function that’ll be used to debug. If you include <code>js/main.js</code> as a script in your webpage, this code will work – but it’ll not reload. So, after these functions, we can add our reload function that’ll just call our <code>main</code> function after informing shadow that we did our cleanup:</p></div><div dir="auto" style="overflow-x: auto;"><table>
<thead>
<tr>
<th dir="auto"></th>
<th dir="auto"></th>
</tr>
</thead>
<tbody>
<tr>
<td dir="auto">1<br><br>2<br><br>3</td>
<td dir="ltr"><code>(``defn</code> <code>reload</code> <code>[``done``]</code><br><br>&nbsp;&nbsp;<code>(done)</code><br><br>&nbsp;&nbsp;<code>(main))</code></td>
</tr>
</tbody>
</table></div><div><p dir="auto">If you change your code in any way – maybe change the math operation to multiplication – you’ll see that our page changes correctly. You’ll also see, in the console, that we’re printing our numbers twice per change. This is because jQuery’s <code>.on</code> method stacks callbacks: this means that we’re still listening to our old code. What we have to do is to clean our callbacks <em>before</em> reloading our code, and this is quite simple with Shadow:</p></div><div dir="auto" style="overflow-x: auto;"><table>
<thead>
<tr>
<th dir="auto"></th>
<th dir="auto"></th>
</tr>
</thead>
<tbody>
<tr>
<td dir="auto">1<br><br>2<br><br>3<br><br>4</td>
<td dir="ltr"><code>(``defn</code> <code>reload</code> <code>[``done``]</code><br><br>&nbsp;&nbsp;<code>(.off (js/jQuery</code> <code>"*"``)</code> <code>"input"</code> <code>""``)</code><br><br>&nbsp;&nbsp;<code>(done)</code><br><br>&nbsp;&nbsp;<code>(main))</code></td>
</tr>
</tbody>
</table></div><div><p dir="auto">UPDATE: As Thomas Heller told me, <code>:before-load-async</code> is used do signal my application that a reload is due, so I can control what to happen before the reload, and also to inform shadow that it can continue reloading our code. If we do any async stuff to reload code – let’s say, resolve a promise (something like <code>(-&gt; clear-things (.then done))</code> – or if the reload uses some async code, this will not work. In this case, it’s better to register another callback, <code>:after-load</code>, and use it to re-activate our code, something like:</p></div><div dir="auto" style="overflow-x: auto;"><table>
<thead>
<tr>
<th dir="auto"></th>
<th dir="auto"></th>
</tr>
</thead>
<tbody>
<tr>
<td dir="auto">1<br><br>2<br><br>3<br><br>4<br><br>5<br><br>6<br><br>7<br><br>8<br><br>9<br><br>10<br><br>11<br><br>12</td>
<td dir="ltr"><code>; On shadow-cljs.edn, under</code> <code>:devtools</code> <code>key:</code><br><br><code>{``:before-load-async</code> <code>calc.core/reload</code><br><br>&nbsp;<code>:after-load</code> <code>calc.core/reactivate}</code><br><br><code>; On calc.core.cljs</code><br><br><code>(``defn</code> <code>reload</code> <code>[``done``]</code><br><br>&nbsp;&nbsp;<code>(done))</code><br><br><code>(``defn</code> <code>reactivate</code> <code>[``]</code><br><br>&nbsp;&nbsp;<code>; other code to re-activate things</code><br><br>&nbsp;&nbsp;<code>; that``'ll</code> <code>be run after reloaded</code><br><br>&nbsp;&nbsp;<code>(main))</code></td>
</tr>
</tbody>
</table></div></div></div><div class="heading-wrapper"><h2 data-heading="More about reloads" dir="auto" class="heading" id="More_about_reloads"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>More about reloads</h2><div class="heading-children"><div><p dir="auto">Now, this probably misses some points about why this is completely awesome. So, let’s imagine a different use-case: a <code>reload</code> function for an Atom editor’s package. In Atom, almost every side-effect function that you can call will return an <code>Disposable</code> object: one that you can dispose and nullify the effect (for instance, if you listen to changes in an editor, you can <code>.dispose()</code> those changes and un-listen to changes).</p></div><div><p dir="auto">What you <em>can do</em> is to create a <code>CompositeDisposable</code>, and when you refresh, you <code>.dispose</code> everything, re-creates the <code>CompositeDisposable</code>, then re-adds your effects. This means that while you’re developing your plug-in, you can stop subscriptions, delete your commands, add new commands to editor, re-load subscriptions, all just saving your code. If this is not <strong>awesome</strong>, I don’t really know what it is. The code to do it is surprisingly simple:</p></div><div dir="auto" style="overflow-x: auto;"><table>
<thead>
<tr>
<th dir="auto"></th>
<th dir="auto"></th>
</tr>
</thead>
<tbody>
<tr>
<td dir="auto">1<br><br>2<br><br>3<br><br>4<br><br>5<br><br>6<br><br>7<br><br>8<br><br>9<br><br>10<br><br>11<br><br>12<br><br>13<br><br>14<br><br>15<br><br>16</td>
<td dir="ltr"><code>(``def</code> <code>CompositeDisposable</code><br><br>&nbsp;&nbsp;<code>(-&gt;</code> <code>"atom"</code><br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<code>js/``require</code><br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<code>.-CompositeDisposable))</code><br><br><code>(``def</code> <code>subscriptions (atom nil))</code><br><br><code>(``defn</code> <code>activate</code> <code>[``]</code><br><br>&nbsp;&nbsp;<code>(reset! subscriptions (CompositeDisposable.))</code><br><br>&nbsp;&nbsp;<code>(.add @subscriptions</code><br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<code>(.. js/atom -workspace</code><br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<code>(observeTextEditors #(prn</code> <code>"An event have happened!"``)))))</code><br><br><code>(``defn</code> <code>reload</code> <code>[``done``]</code><br><br>&nbsp;&nbsp;<code>(.dispose @subscriptions)</code><br><br>&nbsp;&nbsp;<code>(done)</code><br><br>&nbsp;&nbsp;<code>(activate))</code></td>
</tr>
</tbody>
</table></div><div><p dir="auto">For projects like Atom or other editors’ plug-ins (like VSCode, NeoVim, Oni) this give a temendous power. Also, this can be used while developing extensions for browsers, or projects when it’s tedious to unload everything, reload everything, just to see you have called a function with the arguments swapped…</p></div></div></div><div class="heading-wrapper"><h2 data-heading="More Goodies" dir="auto" class="heading" id="More_Goodies"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>More Goodies</h2><div class="heading-children"><div><p dir="auto">With a simple <code>npx shadow-cljs release app</code>, Shadow will try to compile your code with <code>:advanced</code> optimizations. But sometimes, this won’t work: imagine that in our jQuery example, <code>:advanced</code> will rename <code>jQuery</code> to something else, so things will not work. There are two options you can use: inside your build id (in our case, <code>:app</code>) you can add the key <code>:compiler-options {:infer-externs :auto}</code>. This will throw an warning when you’re using code that Shadow-CLJS can’t infer. Also, you can use <code>npx shadow-cljs release --debug app</code> to compile with <code>:advanced</code> features, but will pretty-print files and will make meaningful names (so you can debug where things went wrong).</p></div><div><p dir="auto">This is not exclusive of Shadow-CLJS, but the compiler just make easier to access these options. <del>Now, what <strong>is exclusive</strong> from Shadow-CLJS is an extension to <code>ns</code> form</del> (UPDATE: it is not. As Thomas told me, it uses a different implementation and have more checks, but it works in CLJS too):</p></div><div dir="auto" style="overflow-x: auto;"><table>
<thead>
<tr>
<th dir="auto"></th>
<th dir="auto"></th>
</tr>
</thead>
<tbody>
<tr>
<td dir="auto">1<br><br>2<br><br>3<br><br>4</td>
<td dir="ltr"><code>(``ns</code> <code>my.lib</code><br><br>&nbsp;&nbsp;<code>(``:require</code> <code>[``some-lib.core</code> <code>:as</code> <code>lib</code> <code>:include-macros</code> <code>true``]``))</code><br><br><code>(lib/some-macro ....)</code></td>
</tr>
</tbody>
</table></div><div><p dir="auto">This means no more <code>:refer-macros</code> or <code>:require-macros</code>. This magically finds the macros in that required namespace, and allows then to be used in the current ns. Simpler code, less things to remember, and cleaner. Also, I never had the compiler problems that I had with figwheel – that it compiles a version, then sometime later you clean things and it didn’t compile anymore. Or, that it compiles a version, and there’s a runtime exception with a compiler error.</p></div><div><p dir="auto">Yet, for now, there are still problems with <code>.cljc</code> files that have macros, and some toolings that I was unable to make it work (cljs-complete being one of the most critical for me). Even with these limitations, developing with ClojureScript is now my primary choice for JS projects (when I can choose), even if there’s already JS code in production (because it integrates with existing code like a breeze too). It wasn’t before, and this was all thanks to a better tooling.</p></div><div><p dir="auto">So yes, tools make all the difference!</p></div><div class="mod-footer"></div></div></div></div></div></div><div class="sidebar-right sidebar"><div class="sidebar-handle"></div><div class="sidebar-topbar"><div class="topbar-content"></div><div class="clickable-icon sidebar-collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" class="svg-icon"><path d="M21 3H3C1.89543 3 1 3.89543 1 5V19C1 20.1046 1.89543 21 3 21H21C22.1046 21 23 20.1046 23 19V5C23 3.89543 22.1046 3 21 3Z"></path><path d="M10 4V20"></path><path d="M4 7H7"></path><path d="M4 10H7"></path><path d="M4 13H7"></path></svg></div></div><div class="sidebar-content"><div class="graph-view-wrapper"><div class="sidebar-section-header">Interactive Graph</div><div class="graph-view-placeholder">
		<div class="graph-view-container">
			<div class="graph-icon graph-expand" role="button" aria-label="Expand" data-tooltip-position="top"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon"><line x1="7" y1="17" x2="17" y2="7"></line><polyline points="7 7 17 7 17 17"></polyline></svg></div>
			<canvas id="graph-canvas" class="hide" width="512px" height="512px"></canvas>
		</div>
		</div></div><div class="tree-container mod-root nav-folder tree-item outline-tree" data-depth="0"><div class="tree-header"><span class="sidebar-section-header">Table Of Contents</span><button class="clickable-icon collapse-tree-button" aria-label="Collapse All"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></svg></button></div><div class="tree-scroll-area tree-item-children nav-folder-children"><div class="tree-item mod-tree-folder nav-folder mod-collapsible is-collapsed" style="display: none;"></div><div class="tree-item" data-depth="1"><a class="tree-link" href="computer-science/programming-language/clojure/my-fading-frustration-with-clojurescript.html#My fading frustration with ClojureScript"><div class="tree-item-contents heading-link" heading-name="My fading frustration with ClojureScript"><span class="tree-item-title">My fading frustration with ClojureScript</span></div></a><div class="tree-item-children nav-folder-children"><div class="tree-item" data-depth="2"><a class="tree-link" href="computer-science/programming-language/clojure/my-fading-frustration-with-clojurescript.html#Tooling"><div class="tree-item-contents heading-link" heading-name="Tooling"><span class="tree-item-title">Tooling</span></div></a><div class="tree-item-children nav-folder-children"></div></div><div class="tree-item" data-depth="2"><a class="tree-link" href="computer-science/programming-language/clojure/my-fading-frustration-with-clojurescript.html#The_stack"><div class="tree-item-contents heading-link" heading-name="The stack"><span class="tree-item-title">The stack</span></div></a><div class="tree-item-children nav-folder-children"></div></div><div class="tree-item" data-depth="2"><a class="tree-link" href="computer-science/programming-language/clojure/my-fading-frustration-with-clojurescript.html#More_about_reloads"><div class="tree-item-contents heading-link" heading-name="More about reloads"><span class="tree-item-title">More about reloads</span></div></a><div class="tree-item-children nav-folder-children"></div></div><div class="tree-item" data-depth="2"><a class="tree-link" href="computer-science/programming-language/clojure/my-fading-frustration-with-clojurescript.html#More_Goodies"><div class="tree-item-contents heading-link" heading-name="More Goodies"><span class="tree-item-title">More Goodies</span></div></a><div class="tree-item-children nav-folder-children"></div></div></div></div></div></div></div><script defer="">let rs = document.querySelector(".sidebar-right"); rs.classList.add("is-collapsed"); if (window.innerWidth > 768) rs.classList.remove("is-collapsed"); rs.style.setProperty("--sidebar-width", localStorage.getItem("sidebar-right-width"));</script></div></div></body></html>