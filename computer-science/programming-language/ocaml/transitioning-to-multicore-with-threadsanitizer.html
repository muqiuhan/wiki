<html><head>
		<title>Transitioning to Multicore with ThreadSanitizer</title>
		<base href="../../../">
		<meta id="root-path" root-path="../../../">
		<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes, minimum-scale=1.0, maximum-scale=5.0">
		<meta charset="UTF-8">
		<meta name="description" content="韩暮秋的个人维基 - Transitioning to Multicore with ThreadSanitizer">
		<meta property="og:title" content="Transitioning to Multicore with ThreadSanitizer">
		<meta property="og:description" content="韩暮秋的个人维基 - Transitioning to Multicore with ThreadSanitizer">
		<meta property="og:type" content="website">
		<meta property="og:url" content="https://muqiuhan.github.io/wiki/computer-science/programming-language/ocaml/transitioning-to-multicore-with-threadsanitizer.html">
		<meta property="og:image" content="undefined">
		<meta property="og:site_name" content="韩暮秋的个人维基">
		<meta name="author" content="韩暮秋"><script async="" id="webpage-script" src="lib/scripts/webpage.js" onload="this.onload=null;this.setAttribute(&quot;loaded&quot;, &quot;true&quot;)"></script><script type="module" async="" id="graph-view-script" src="lib/scripts/graph-view.js"></script><script async="" id="graph-wasm-script" src="lib/scripts/graph-wasm.js" onload="this.onload=null;this.setAttribute(&quot;loaded&quot;, &quot;true&quot;)"></script><script async="" id="graph-render-worker-script" src="lib/scripts/graph-render-worker.js" onload="this.onload=null;this.setAttribute(&quot;loaded&quot;, &quot;true&quot;)"></script><script async="" id="tinycolor-script" src="lib/scripts/tinycolor.js" onload="this.onload=null;this.setAttribute(&quot;loaded&quot;, &quot;true&quot;)"></script><script async="" id="pixi-script" src="lib/scripts/pixi.js" onload="this.onload=null;this.setAttribute(&quot;loaded&quot;, &quot;true&quot;)"></script><script async="" id="minisearch-script" src="lib/scripts/minisearch.js" onload="this.onload=null;this.setAttribute(&quot;loaded&quot;, &quot;true&quot;)"></script><link rel="icon" href="lib/media/favicon.jpg"><script async="" id="graph-data-script" src="lib/scripts/graph-data.js" onload="this.onload=null;this.setAttribute(&quot;loaded&quot;, &quot;true&quot;)"></script><style>body{--line-width:40em;--line-width-adaptive:40em;--file-line-width:40em;--sidebar-width:min(20em, 80vw);--collapse-arrow-size:11px;--tree-horizontal-spacing:0.6em;--tree-vertical-spacing:0.6em;--sidebar-margin:12px}.sidebar{height:100%;min-width:calc(var(--sidebar-width) + var(--divider-width-hover));max-width:calc(var(--sidebar-width) + var(--divider-width-hover));font-size:14px;z-index:10;position:relative;overflow:hidden;transition:min-width ease-in-out,max-width ease-in-out;transition-duration:.2s;contain:size}.sidebar-left{left:0}.sidebar-right{right:0}.sidebar.is-collapsed{min-width:0;max-width:0}body.floating-sidebars .sidebar{position:absolute}.sidebar-content{height:100%;min-width:calc(var(--sidebar-width) - var(--divider-width-hover));top:0;padding:var(--sidebar-margin);padding-top:4em;line-height:var(--line-height-tight);background-color:var(--background-secondary);transition:background-color,border-right,border-left,box-shadow;transition-duration:var(--color-fade-speed);transition-timing-function:ease-in-out;position:absolute;display:flex;flex-direction:column}.sidebar:not(.is-collapsed) .sidebar-content{min-width:calc(max(100%,var(--sidebar-width)) - 3px);max-width:calc(max(100%,var(--sidebar-width)) - 3px)}.sidebar-left .sidebar-content{left:0;border-top-right-radius:var(--radius-l);border-bottom-right-radius:var(--radius-l)}.sidebar-right .sidebar-content{right:0;border-top-left-radius:var(--radius-l);border-bottom-left-radius:var(--radius-l)}.sidebar:has(.sidebar-content:empty):has(.topbar-content:empty){display:none}.sidebar-topbar{height:2em;width:var(--sidebar-width);top:var(--sidebar-margin);padding-inline:var(--sidebar-margin);z-index:1;position:fixed;display:flex;align-items:center;transition:width ease-in-out;transition-duration:inherit}.sidebar.is-collapsed .sidebar-topbar{width:calc(2.3em + var(--sidebar-margin) * 2)}.sidebar .sidebar-topbar.is-collapsed{width:0}.sidebar-left .sidebar-topbar{left:0}.sidebar-right .sidebar-topbar{right:0}.topbar-content{overflow:hidden;overflow:clip;width:100%;height:100%;display:flex;align-items:center;transition:inherit}.sidebar.is-collapsed .topbar-content{width:0;transition:inherit}.clickable-icon.sidebar-collapse-icon{background-color:transparent;color:var(--icon-color-focused);padding:0!important;margin:0!important;height:100%!important;width:2.3em!important;margin-inline:0.14em!important;position:absolute}.sidebar-left .clickable-icon.sidebar-collapse-icon{transform:rotateY(180deg);right:var(--sidebar-margin)}.sidebar-right .clickable-icon.sidebar-collapse-icon{transform:rotateY(180deg);left:var(--sidebar-margin)}.clickable-icon.sidebar-collapse-icon svg.svg-icon{width:100%;height:100%}.sidebar-section-header{margin:0 0 1em 0;text-transform:uppercase;letter-spacing:.06em;font-weight:600}body{transition:background-color var(--color-fade-speed) ease-in-out}.webpage-container{display:flex;flex-direction:row;height:100%;width:100%;align-items:stretch;justify-content:center}.document-container{opacity:1;flex-basis:100%;max-width:100%;width:100%;height:100%;display:flex;flex-direction:column;align-items:center;transition:opacity .2s ease-in-out;contain:inline-size}.hide{opacity:0;transition:opacity .2s ease-in-out}.document-container>.markdown-preview-view{margin:var(--sidebar-margin);margin-bottom:0;width:100%;width:-webkit-fill-available;width:-moz-available;width:fill-available;background-color:var(--background-primary);transition:background-color var(--color-fade-speed) ease-in-out;border-top-right-radius:var(--window-radius,var(--radius-m));border-top-left-radius:var(--window-radius,var(--radius-m));overflow-x:hidden!important;overflow-y:auto!important;display:flex!important;flex-direction:column!important;align-items:center!important;contain:inline-size}.document-container>.markdown-preview-view>.markdown-preview-sizer{padding-bottom:80vh!important;width:100%!important;max-width:var(--line-width)!important;flex-basis:var(--line-width)!important;transition:background-color var(--color-fade-speed) ease-in-out;contain:inline-size}.markdown-rendered img:not([width]),.view-content img:not([width]){max-width:100%;outline:0}.document-container>.view-content.embed{display:flex;padding:1em;height:100%;width:100%;align-items:center;justify-content:center}.document-container>.view-content.embed>*{max-width:100%;max-height:100%;object-fit:contain}:has(> :is(.math,table)){overflow-x:auto!important}.document-container>.view-content{overflow-x:auto;contain:content;padding:0;margin:0;height:100%}.scroll-highlight{position:absolute;width:100%;height:100%;pointer-events:none;z-index:1000;background-color:hsla(var(--color-accent-hsl),.25);opacity:0;padding:1em;inset:50%;translate:-50% -50%;border-radius:var(--radius-s)}</style><script defer="">async function loadIncludes(){if("file:"!=location.protocol){let e=document.querySelectorAll("include");for(let t=0;t<e.length;t++){let o=e[t],l=o.getAttribute("src");try{const e=await fetch(l);if(!e.ok){console.log("Could not include file: "+l),o?.remove();continue}let t=await e.text(),n=document.createRange().createContextualFragment(t),i=Array.from(n.children);for(let e of i)e.classList.add("hide"),e.style.transition="opacity 0.5s ease-in-out",setTimeout((()=>{e.classList.remove("hide")}),10);o.before(n),o.remove(),console.log("Included file: "+l)}catch(e){o?.remove(),console.log("Could not include file: "+l,e);continue}}}else{if(document.querySelectorAll("include").length>0){var e=document.createElement("div");e.id="error",e.textContent="Web server exports must be hosted on an http / web server to be viewed correctly.",e.style.position="fixed",e.style.top="50%",e.style.left="50%",e.style.transform="translate(-50%, -50%)",e.style.fontSize="1.5em",e.style.fontWeight="bold",e.style.textAlign="center",document.body.appendChild(e),document.querySelector(".document-container")?.classList.remove("hide")}}}document.addEventListener("DOMContentLoaded",(()=>{loadIncludes()}));let isFileProtocol="file:"==location.protocol;function waitLoadScripts(e,t){let o=e.map((e=>document.getElementById(e+"-script"))),l=0;!function e(){let n=o[l];l++,n&&"true"!=n.getAttribute("loaded")||l<o.length&&e(),l<o.length?n.addEventListener("load",e):t()}()}</script><link rel="stylesheet" href="lib/styles/obsidian.css"><link rel="preload" href="lib/styles/other-plugins.css" as="style" onload="this.onload=null;this.rel='stylesheet'"><noscript><link rel="stylesheet" href="lib/styles/other-plugins.css"></noscript><link rel="stylesheet" href="lib/styles/theme.css"><link rel="preload" href="lib/styles/global-variable-styles.css" as="style" onload="this.onload=null;this.rel='stylesheet'"><noscript><link rel="stylesheet" href="lib/styles/global-variable-styles.css"></noscript><link rel="preload" href="lib/styles/supported-plugins.css" as="style" onload="this.onload=null;this.rel='stylesheet'"><noscript><link rel="stylesheet" href="lib/styles/supported-plugins.css"></noscript><link rel="preload" href="lib/styles/main-styles.css" as="style" onload="this.onload=null;this.rel='stylesheet'"><noscript><link rel="stylesheet" href="lib/styles/main-styles.css"></noscript></head><body class="publish css-settings-manager theme-light show-inline-title show-ribbon show-file-explorer-navigation"><script defer="">let theme=localStorage.getItem("theme")||(window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light");"dark"==theme?(document.body.classList.add("theme-dark"),document.body.classList.remove("theme-light")):(document.body.classList.add("theme-light"),document.body.classList.remove("theme-dark")),window.innerWidth<480?document.body.classList.add("is-phone"):window.innerWidth<768?document.body.classList.add("is-tablet"):window.innerWidth<1024?document.body.classList.add("is-small-screen"):document.body.classList.add("is-large-screen")</script><div class="webpage-container workspace"><div class="sidebar-left sidebar"><div class="sidebar-handle"></div><div class="sidebar-topbar"><div class="topbar-content"><label class="theme-toggle-container" for="theme_toggle"><input class="theme-toggle-input" type="checkbox" id="theme_toggle"><div class="toggle-background"></div></label></div><div class="clickable-icon sidebar-collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" class="svg-icon"><path d="M21 3H3C1.89543 3 1 3.89543 1 5V19C1 20.1046 1.89543 21 3 21H21C22.1046 21 23 20.1046 23 19V5C23 3.89543 22.1046 3 21 3Z"></path><path d="M10 4V20"></path><path d="M4 7H7"></path><path d="M4 10H7"></path><path d="M4 13H7"></path></svg></div></div><div class="sidebar-content"><div class="search-input-container"><input enterkeyhint="search" type="search" spellcheck="false" placeholder="Search..."><div class="search-input-clear-button" aria-label="Clear search"></div></div><include src="lib/html/file-tree.html"></include></div><script defer="">let ls = document.querySelector(".sidebar-left"); ls.classList.add("is-collapsed"); if (window.innerWidth > 768) ls.classList.remove("is-collapsed"); ls.style.setProperty("--sidebar-width", localStorage.getItem("sidebar-left-width"));</script></div><div class="document-container markdown-reading-view hide"><div class="markdown-preview-view markdown-rendered allow-fold-headings allow-fold-lists is-readable-line-width"><style id="MJX-CHTML-styles"></style><div class="markdown-preview-sizer markdown-preview-section"><h1 class="page-title heading inline-title" id="Transitioning to Multicore with ThreadSanitizer"><p dir="auto">Transitioning to Multicore with ThreadSanitizer</p></h1><div><p dir="auto"><a href="?query=tag:ocaml" class="tag" target="_blank" rel="noopener">#ocaml</a> <a href="?query=tag:fp" class="tag" target="_blank" rel="noopener">#fp</a></p></div><div><p dir="auto">The 5.0 release brought Multicore, <code>Domain</code>-based parallelism to the OCaml language. Parallel <code>Domain</code>s performing uncoordinated operations on shared mutable memory locations may however cause data races. Such issues will unfortunately not <a data-tooltip-position="top" aria-label="https://blog.janestreet.com/oxidizing-ocaml-parallelism/" rel="noopener" class="external-link" href="https://blog.janestreet.com/oxidizing-ocaml-parallelism/" target="_blank">(yet)</a> be caught by OCaml's strong type system, meaning they may go unnoticed when introducing parallelism into an existing OCaml code base. In this guide, we will therefore study a step-wise workflow that utilises the <a data-tooltip-position="top" aria-label="https://github.com/ocaml-multicore/ocaml-tsan" rel="noopener" class="external-link" href="https://github.com/ocaml-multicore/ocaml-tsan" target="_blank">ThreadSanitizer (TSan)</a> tool to help make your OCaml code 5.x ready.</p></div><div><p dir="auto"><strong>Note:</strong> TSan is currently only supported under Linux with AMD/Intel cpus. It furthermore requires at least GCC 11 or Clang 11 and the <code>libunwind</code> library.</p></div><div class="heading-wrapper"><h2 data-heading="[](https://www.ocaml.org/docs/multicore-transition#an-example-application)An Example Application" dir="auto" class="heading" id="[](https://www.ocaml.org/docs/multicore-transition#an-example-application)An_Example_Application"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div><a data-tooltip-position="top" aria-label="https://www.ocaml.org/docs/multicore-transition#an-example-application" rel="noopener" class="external-link" href="https://www.ocaml.org/docs/multicore-transition#an-example-application" target="_blank"></a>An Example Application</h2><div class="heading-children"><div><p dir="auto">Consider a little bank library with the following signature in <code>bank.mli</code>:</p></div><div><pre><code>type t
(** a collective type representing a bank *)

val init : num_accounts:int -&gt; init_balance:int -&gt; t
(** [init ~num_accounts ~init_balance] creates a bank with [num_accounts] each
    containing [init_balance]. *)

val transfer : t -&gt; src_acc:int -&gt; dst_acc:int -&gt; amount:int -&gt; unit
(** [transfer t ~src_acc ~dst_acc ~amount] moves [amount] from account
    [src_acc] to account [dst_acc].
    @raise Invalid_argument if amount is not positive,
    if [src_acc] and [dst_acc] are the same, or if [src_acc] contains
    insufficient funds. *)

val iter_accounts : t -&gt; (account:int -&gt; balance:int -&gt; unit) -&gt; unit
(** [iter_accounts t f] applies [f] to each account from [t]
    one after another. *)
</code><button class="copy-code-button">Copy</button></pre></div><div><p dir="auto">Underneath the hood, the library may have been implemented in various ways. Consider the following thread-unsafe implementation in <code>bank.ml</code>:</p></div><div><pre><code>type t = int array

let init ~num_accounts ~init_balance =
  Array.make num_accounts init_balance

let transfer t ~src_acc ~dst_acc ~amount =
  begin
    if amount &lt;= 0 then raise (Invalid_argument "Amount has to be positive");
    if src_acc = dst_acc then raise (Invalid_argument "Cannot transfer to yourself");
    if t.(src_acc) &lt; amount then raise (Invalid_argument "Not enough money on account");
    t.(src_acc) &lt;- t.(src_acc) - amount;
    t.(dst_acc) &lt;- t.(dst_acc) + amount;
  end

let iter_accounts t f = (* inspect the bank accounts *)
  Array.iteri (fun account balance -&gt; f ~account ~balance) t;
</code><button class="copy-code-button">Copy</button></pre></div></div></div><div class="heading-wrapper"><h2 data-heading="[](https://www.ocaml.org/docs/multicore-transition#a-proposed-workflow)A Proposed Workflow" dir="auto" class="heading" id="[](https://www.ocaml.org/docs/multicore-transition#a-proposed-workflow)A_Proposed_Workflow"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div><a data-tooltip-position="top" aria-label="https://www.ocaml.org/docs/multicore-transition#a-proposed-workflow" rel="noopener" class="external-link" href="https://www.ocaml.org/docs/multicore-transition#a-proposed-workflow" target="_blank"></a>A Proposed Workflow</h2><div class="heading-children"><div><p dir="auto">Now if we want to see if this code is Multicore ready for OCaml 5.x, we can utilise the following workflow:</p></div><div><ol start="0">
<li data-line="0" dir="auto">Install TSan</li>
<li data-line="1" dir="auto">Write a parallel test runner</li>
<li data-line="2" dir="auto">Run tests under TSan</li>
<li data-line="3" dir="auto">If TSan complains about data races, address the reported issue and go to step 2.</li>
</ol></div></div></div><div class="heading-wrapper"><h2 data-heading="[](https://www.ocaml.org/docs/multicore-transition#following-the-workflow)Following the Workflow" dir="auto" class="heading" id="[](https://www.ocaml.org/docs/multicore-transition#following-the-workflow)Following_the_Workflow"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div><a data-tooltip-position="top" aria-label="https://www.ocaml.org/docs/multicore-transition#following-the-workflow" rel="noopener" class="external-link" href="https://www.ocaml.org/docs/multicore-transition#following-the-workflow" target="_blank"></a>Following the Workflow</h2><div class="heading-children"><div><p dir="auto">We will now go through the proposed workflow for our example application.</p></div><div class="heading-wrapper"><h3 data-heading="[](https://www.ocaml.org/docs/multicore-transition#install-the-instrumenting-tsan-compiler-step-0)Install the Instrumenting TSan Compiler (Step 0)" dir="auto" class="heading" id="[](https://www.ocaml.org/docs/multicore-transition#install-the-instrumenting-tsan-compiler-step-0)Install_the_Instrumenting_TSan_Compiler_(Step_0)"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div><a data-tooltip-position="top" aria-label="https://www.ocaml.org/docs/multicore-transition#install-the-instrumenting-tsan-compiler-step-0" rel="noopener" class="external-link" href="https://www.ocaml.org/docs/multicore-transition#install-the-instrumenting-tsan-compiler-step-0" target="_blank"></a>Install the Instrumenting TSan Compiler (Step 0)</h3><div class="heading-children"><div><p dir="auto">For now, convenient <code>5.1.0+tsan</code> and <code>5.0.0+tsan</code> opam switches are available until TSan is officially included with the forthcoming 5.2.0 OCaml release. You can install such a TSan switch as follows:</p></div><div><pre><code>opam switch create 5.1.0+tsan
</code><button class="copy-code-button">Copy</button></pre></div></div></div><div class="heading-wrapper"><h3 data-heading="[](https://www.ocaml.org/docs/multicore-transition#write-a-parallel-test-runner-step-1)Write a Parallel Test Runner (Step 1)" dir="auto" class="heading" id="[](https://www.ocaml.org/docs/multicore-transition#write-a-parallel-test-runner-step-1)Write_a_Parallel_Test_Runner_(Step_1)"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div><a data-tooltip-position="top" aria-label="https://www.ocaml.org/docs/multicore-transition#write-a-parallel-test-runner-step-1" rel="noopener" class="external-link" href="https://www.ocaml.org/docs/multicore-transition#write-a-parallel-test-runner-step-1" target="_blank"></a>Write a Parallel Test Runner (Step 1)</h3><div class="heading-children"><div><p dir="auto">For a start, we can test our library under parallel usage by running two <code>Domain</code>s in parallel. Here's a quick little test runner in <code>bank_test.ml</code> utilising this idea:</p></div><div><pre><code>let num_accounts = 7

let money_shuffle t = (* simulate an economy *)
  for i = 1 to 10 do
    Unix.sleepf 0.1 ; (* wait for a network request *)
    let src_acc = i mod num_accounts in
    let dst_acc = (i*3+1) mod num_accounts in
    try Bank.transfer t ~src_acc ~dst_acc ~amount:1 (* transfer $1 *)
    with Invalid_argument _ -&gt; ()
  done

let print_balances t = (* inspect the bank accounts *)
  for _ = 1 to 12 do
    let sum = ref 0 in
    Bank.iter_accounts t
      (fun ~account ~balance -&gt; Format.printf "%i %3i " account balance; sum := !sum + balance);
    Format.printf "  total = %i @." !sum;
    Unix.sleepf 0.1;
  done

let _ =
  let t = Bank.init ~num_accounts ~init_balance:100 in
  (* run the simulation and the debug view in parallel *)
  [| Domain.spawn (fun () -&gt; money_shuffle t);
     Domain.spawn (fun () -&gt; print_balances t);
  |]
  |&gt; Array.iter Domain.join
</code><button class="copy-code-button">Copy</button></pre></div><div><p dir="auto">The runner creates a bank with 7 accounts containing $100 each and then runs two loops in parallel with:</p></div><div><ul>
<li data-line="0" dir="auto">One transfering money with <code>money_shuffle</code></li>
<li data-line="1" dir="auto">Another one repeatedly printing the account balances with <code>print_balances</code>:</li>
</ul></div><div><pre><code>$ opam switch 5.1.0
$ dune runtest
0 100 1 100 2 100 3 100 4 100 5 100 6 100   total = 700
0 100 1 100 2 100 3 100 4 100 5 100 6 100   total = 700
0 100 1  99 2 100 3 100 4 101 5 100 6 100   total = 700
0 101 1  99 2  99 3 100 4 101 5 100 6 100   total = 700
0 101 1  99 2  99 3 100 4 100 5 100 6 101   total = 700
0 101 1  99 2 100 3 100 4 100 5  99 6 101   total = 700
0 101 1  99 2 100 3 100 4 100 5 100 6 100   total = 700
0 100 1 100 2 100 3 100 4 100 5 100 6 100   total = 700
0 100 1  99 2 100 3 100 4 101 5 100 6 100   total = 700
0 101 1  99 2  99 3 100 4 101 5 100 6 100   total = 700
0 101 1  99 2  99 3 100 4 101 5 100 6 100   total = 700
0 101 1  99 2  99 3 100 4 101 5 100 6 100   total = 700
</code><button class="copy-code-button">Copy</button></pre></div><div><p dir="auto">From the above run under a regular <code>5.1.0</code> compiler, one may get the impression that everything is OK, as the balances sum to a total of $700 as expected, indicating that no money is lost.</p></div></div></div><div class="heading-wrapper"><h3 data-heading="[](https://www.ocaml.org/docs/multicore-transition#run-the-parallel-tests-under-tsan-step-2)Run the Parallel Tests Under TSan (Step 2)" dir="auto" class="heading" id="[](https://www.ocaml.org/docs/multicore-transition#run-the-parallel-tests-under-tsan-step-2)Run_the_Parallel_Tests_Under_TSan_(Step_2)"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div><a data-tooltip-position="top" aria-label="https://www.ocaml.org/docs/multicore-transition#run-the-parallel-tests-under-tsan-step-2" rel="noopener" class="external-link" href="https://www.ocaml.org/docs/multicore-transition#run-the-parallel-tests-under-tsan-step-2" target="_blank"></a>Run the Parallel Tests Under TSan (Step 2)</h3><div class="heading-children"><div><p dir="auto">Let us now perform the same test run under TSan. Doing so is as simple as follows and immediately complains about races:</p></div><div><pre><code>$ opam switch 5.1.0+tsan
$ dune runtest
File "test/dune", line 2, characters 7-16:
2 |  (name bank_test)
           ^^^^^^^^^
0 100 1 100 2 100 3 100 4 100 5 100 6 100   total = 700
0 100 1 100 2 100 3 100 4 100 5 100 6 100   total = 700
0 100 1  99 2 100 3 100 4 101 5 100 6 100   total = 700
0 101 1  99 2  99 3 100 4 101 5 100 6 100   total = 700
0 101 1  99 2  99 3 100 4 101 5 100 6 100   total = 700
0 101 1  99 2  99 3 100 4 100 5 100 6 101   total = 700
0 101 1  99 2 100 3 100 4 100 5  99 6 101   total = 700
0 101 1  99 2 100 3 100 4 100 5 100 6 100   total = 700
0 100 1 100 2 100 3 100 4 100 5 100 6 100   total = 700
0 100 1  99 2 100 3 100 4 101 5 100 6 100   total = 700
0 101 1  99 2  99 3 100 4 101 5 100 6 100   total = 700
0 101 1  99 2  99 3 100 4 101 5 100 6 100   total = 700
==================
WARNING: ThreadSanitizer: data race (pid=26148)
  Write of size 8 at 0x7f5b0c0fd6d8 by thread T4 (mutexes: write M85):
    #0 camlBank.transfer_322 lib/bank.ml:11 (bank_test.exe+0x6de4d)
    #1 camlDune__exe__Bank_test.money_shuffle_270 test/bank_test.ml:8 (bank_test.exe+0x6d7c5)
    #2 camlStdlib__Domain.body_703 /home/opam/.opam/5.1.0+tsan/.opam-switch/build/ocaml-variants.5.1.0+tsan/stdlib/domain.ml:202 (bank_test.exe+0xb06b0)
    #3 caml_start_program &lt;null&gt; (bank_test.exe+0x13fdfb)
    #4 caml_callback_exn runtime/callback.c:197 (bank_test.exe+0x106053)
    #5 caml_callback runtime/callback.c:293 (bank_test.exe+0x106b70)
    #6 domain_thread_func runtime/domain.c:1102 (bank_test.exe+0x10a2b1)

  Previous read of size 8 at 0x7f5b0c0fd6d8 by thread T1 (mutexes: write M81):
    #0 camlStdlib__Array.iteri_367 /home/opam/.opam/5.1.0+tsan/.opam-switch/build/ocaml-variants.5.1.0+tsan/stdlib/array.ml:136 (bank_test.exe+0xa0f36)
    #1 camlDune__exe__Bank_test.print_balances_496 test/bank_test.ml:15 (bank_test.exe+0x6d8f4)
    #2 camlStdlib__Domain.body_703 /home/opam/.opam/5.1.0+tsan/.opam-switch/build/ocaml-variants.5.1.0+tsan/stdlib/domain.ml:202 (bank_test.exe+0xb06b0)
    #3 caml_start_program &lt;null&gt; (bank_test.exe+0x13fdfb)
    #4 caml_callback_exn runtime/callback.c:197 (bank_test.exe+0x106053)
    #5 caml_callback runtime/callback.c:293 (bank_test.exe+0x106b70)
    #6 domain_thread_func runtime/domain.c:1102 (bank_test.exe+0x10a2b1)

  [...]
</code><button class="copy-code-button">Copy</button></pre></div><div><p dir="auto">Notice we obtain a back trace of the two racing accesses, with</p></div><div><ul>
<li data-line="0" dir="auto">A write in one <code>Domain</code> coming from the array assignment in <code>Bank.transfer</code></li>
<li data-line="1" dir="auto">A read in another <code>Domain</code> coming from a call to <code>Stdlib.Array.iteri</code> to read and print the array entries in <code>print_balances</code>.</li>
</ul></div></div></div><div class="heading-wrapper"><h3 data-heading="[](https://www.ocaml.org/docs/multicore-transition#address-the-reported-races-and-rerun-the-tests-steps-3-and-2)Address the Reported Races and Rerun the Tests (Steps 3 and 2)" dir="auto" class="heading" id="[](https://www.ocaml.org/docs/multicore-transition#address-the-reported-races-and-rerun-the-tests-steps-3-and-2)Address_the_Reported_Races_and_Rerun_the_Tests_(Steps_3_and_2)"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div><a data-tooltip-position="top" aria-label="https://www.ocaml.org/docs/multicore-transition#address-the-reported-races-and-rerun-the-tests-steps-3-and-2" rel="noopener" class="external-link" href="https://www.ocaml.org/docs/multicore-transition#address-the-reported-races-and-rerun-the-tests-steps-3-and-2" target="_blank"></a>Address the Reported Races and Rerun the Tests (Steps 3 and 2)</h3><div class="heading-children"><div><p dir="auto">One way to address the reported races is to add a <code>Mutex</code>, ensuring exclusive access to the underlying array. A first attempt could be to wrap <code>transfer</code> and <code>iter_accounts</code> with <code>lock</code>-<code>unlock</code> calls as follows:</p></div><div><pre><code>let lock = Mutex.create () (* addition *)

let transfer t ~src_acc ~dst_acc ~amount =
  begin
    Mutex.lock lock; (* addition *)
    if amount &lt;= 0 then raise (Invalid_argument "Amount has to be positive");
    if src_acc = dst_acc then raise (Invalid_argument "Cannot transfer to yourself");
    if t.(src_acc) &lt; amount then raise (Invalid_argument "Not enough money on account");
    t.(src_acc) &lt;- t.(src_acc) - amount;
    t.(dst_acc) &lt;- t.(dst_acc) + amount;
    Mutex.unlock lock; (* addition *)
  end

let iter_accounts t f = (* inspect the bank accounts *)
  Mutex.lock lock; (* addition *)
  Array.iteri (fun account balance -&gt; f ~account ~balance) t;
  Mutex.unlock lock (* addition *)
</code><button class="copy-code-button">Copy</button></pre></div><div><p dir="auto">Rerunning our tests, we obtain:</p></div><div><pre><code>$ dune runtest
File "test/dune", line 2, characters 7-16:
2 |  (name bank_test)
           ^^^^^^^^^
0 100 1 100 2 100 3 100 4 100 5 100 6 100   total = 700
0 100 1 100 2 100 3 100 4 100 5 100 6 100   total = 700
0 100 1  99 2 100 3 100 4 101 5 100 6 100   total = 700
0 101 1  99 2  99 3 100 4 101 5 100 6 100   total = 700
Fatal error: exception Sys_error("Mutex.lock: Resource deadlock avoided")
</code><button class="copy-code-button">Copy</button></pre></div><div><p dir="auto">How come we may hit a resource deadlock error when adding just two pairs of <code>Mutex.lock</code> and <code>Mutex.unlock</code> calls?</p></div></div></div><div class="heading-wrapper"><h3 data-heading="[](https://www.ocaml.org/docs/multicore-transition#address-the-reported-races-and-rerun-the-tests-take-2-steps-3-and-2)Address the Reported Races and Rerun the Tests, Take 2 (Steps 3 and 2)" dir="auto" class="heading" id="[](https://www.ocaml.org/docs/multicore-transition#address-the-reported-races-and-rerun-the-tests-take-2-steps-3-and-2)Address_the_Reported_Races_and_Rerun_the_Tests,_Take_2_(Steps_3_and_2)"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div><a data-tooltip-position="top" aria-label="https://www.ocaml.org/docs/multicore-transition#address-the-reported-races-and-rerun-the-tests-take-2-steps-3-and-2" rel="noopener" class="external-link" href="https://www.ocaml.org/docs/multicore-transition#address-the-reported-races-and-rerun-the-tests-take-2-steps-3-and-2" target="_blank"></a>Address the Reported Races and Rerun the Tests, Take 2 (Steps 3 and 2)</h3><div class="heading-children"><div><p dir="auto">Oh, wait! When raising an exception in <code>transfer</code>, we forgot to unlock the <code>Mutex</code> again. Let's adapt the function to do so:</p></div><div><pre><code>let transfer t ~src_acc ~dst_acc ~amount =
  begin
    if amount &lt;= 0 then raise (Invalid_argument "Amount has to be positive");
    if src_acc = dst_acc then raise (Invalid_argument "Cannot transfer to yourself");
    Mutex.lock lock; (* addition *)
    if t.(src_acc) &lt; amount
    then (Mutex.unlock lock; (* addition *)
          raise (Invalid_argument "Not enough money on account"));
    t.(src_acc) &lt;- t.(src_acc) - amount;
    t.(dst_acc) &lt;- t.(dst_acc) + amount;
    Mutex.unlock lock; (* addition *)
  end
</code><button class="copy-code-button">Copy</button></pre></div><div><p dir="auto">We can now rerun our tests under TSan to confirm the fix:</p></div><div><pre><code>$ dune runtest
0 100 1 100 2 100 3 100 4 100 5 100 6 100   total = 700
0 100 1 100 2 100 3 100 4 100 5 100 6 100   total = 700
0 100 1  99 2 100 3 100 4 101 5 100 6 100   total = 700
0 101 1  99 2  99 3 100 4 101 5 100 6 100   total = 700
0 101 1  99 2  99 3 100 4 101 5 100 6 100   total = 700
0 101 1  99 2 100 3 100 4 100 5  99 6 101   total = 700
0 101 1  99 2 100 3 100 4 100 5 100 6 100   total = 700
0 100 1 100 2 100 3 100 4 100 5 100 6 100   total = 700
0 100 1  99 2 100 3 100 4 101 5 100 6 100   total = 700
0 101 1  99 2  99 3 100 4 101 5 100 6 100   total = 700
0 101 1  99 2  99 3 100 4 101 5 100 6 100   total = 700
0 101 1  99 2  99 3 100 4 101 5 100 6 100   total = 700
</code><button class="copy-code-button">Copy</button></pre></div><div><p dir="auto">This works well and TSan no longer complains, so our little library is ready for OCaml 5.x parallelism, hurrah!</p></div></div></div><div class="heading-wrapper"><h3 data-heading="[](https://www.ocaml.org/docs/multicore-transition#final-remarks-and-a-word-of-warning)Final Remarks and a Word of Warning" dir="auto" class="heading" id="[](https://www.ocaml.org/docs/multicore-transition#final-remarks-and-a-word-of-warning)Final_Remarks_and_a_Word_of_Warning"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div><a data-tooltip-position="top" aria-label="https://www.ocaml.org/docs/multicore-transition#final-remarks-and-a-word-of-warning" rel="noopener" class="external-link" href="https://www.ocaml.org/docs/multicore-transition#final-remarks-and-a-word-of-warning" target="_blank"></a>Final Remarks and a Word of Warning</h3><div class="heading-children"><div><p dir="auto">The programming pattern of 'always-having-to-do-something-at-the-end' that we encountered with the missing <code>Mutex.unlock</code> is a recurring one for which OCaml offers a dedicate function:</p></div><div><pre><code> Fun.protect : finally:(unit -&gt; unit) -&gt; (unit -&gt; 'a) -&gt; 'a
</code><button class="copy-code-button">Copy</button></pre></div><div><p dir="auto">Using <code>Fun.protect</code>, we could have written our final fix as follows:</p></div><div><pre><code>let transfer t ~src_acc ~dst_acc ~amount =
  begin
    if amount &lt;= 0 then raise (Invalid_argument "Amount has to be positive");
    if src_acc = dst_acc then raise (Invalid_argument "Cannot transfer to yourself");
    Mutex.lock lock; (* addition *)
    Fun.protect ~finally:(fun () -&gt; Mutex.unlock lock) (* addition *)
      (fun () -&gt;
         begin
           if t.(src_acc) &lt; amount
           then raise (Invalid_argument "Not enough money on account");
           t.(src_acc) &lt;- t.(src_acc) - amount;
           t.(dst_acc) &lt;- t.(dst_acc) + amount;
         end)
  end
</code><button class="copy-code-button">Copy</button></pre></div><div><p dir="auto">Admittedly, using a <code>Mutex</code> to ensure exclusive access may be a bit heavy if performance is a concern. If this is the case, one option is to replace the underlying <code>array</code> with a lock-free data structure, such as the <a data-tooltip-position="top" aria-label="https://ocaml-multicore.github.io/kcas/doc/kcas_data/Kcas_data/Hashtbl/index.html" rel="noopener" class="external-link" href="https://ocaml-multicore.github.io/kcas/doc/kcas_data/Kcas_data/Hashtbl/index.html" target="_blank"><code>Hashtbl</code> from<code>Kcas_data</code></a>.</p></div><div><p dir="auto">As a final word of warning, <code>Domain</code>s are so fast that in a too simple test runner, one <code>Domain</code> may complete before the second has even started up yet! This is problematic, as there will be no apparent parallelism for TSan to observe and check. In the above example, the calls to <code>Unix.sleepf</code> help ensure that the test runner is indeed parallel. A useful alternative trick is to coordinate on an <code>Atomic</code> to make sure both <code>Domain</code>s are up and running before the parallel test code proceeds. To do so, we can adapt our parallel test runner as follows:</p></div><div><pre><code>let _ =
  let wait = Atomic.make 2 in
  let t = Bank.init ~num_accounts ~init_balance:100 in
  (* run the simulation and the debug view in parallel *)
  [| Domain.spawn (fun () -&gt;
         Atomic.decr wait; while Atomic.get wait &gt; 0 do () done; money_shuffle t);
     Domain.spawn (fun () -&gt;
         Atomic.decr wait; while Atomic.get wait &gt; 0 do () done; print_balances t);
  |]
  |&gt; Array.iter Domain.join
</code><button class="copy-code-button">Copy</button></pre></div><div><p dir="auto">With that warning in mind and TSan in hand, you should now be equipped to hunt for data races.</p></div><div class="mod-footer"></div></div></div></div></div></div></div></div><div class="sidebar-right sidebar"><div class="sidebar-handle"></div><div class="sidebar-topbar"><div class="topbar-content"></div><div class="clickable-icon sidebar-collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" class="svg-icon"><path d="M21 3H3C1.89543 3 1 3.89543 1 5V19C1 20.1046 1.89543 21 3 21H21C22.1046 21 23 20.1046 23 19V5C23 3.89543 22.1046 3 21 3Z"></path><path d="M10 4V20"></path><path d="M4 7H7"></path><path d="M4 10H7"></path><path d="M4 13H7"></path></svg></div></div><div class="sidebar-content"><div class="graph-view-wrapper"><div class="sidebar-section-header">Interactive Graph</div><div class="graph-view-placeholder">
		<div class="graph-view-container">
			<div class="graph-icon graph-expand" role="button" aria-label="Expand" data-tooltip-position="top"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon"><line x1="7" y1="17" x2="17" y2="7"></line><polyline points="7 7 17 7 17 17"></polyline></svg></div>
			<canvas id="graph-canvas" class="hide" width="512px" height="512px"></canvas>
		</div>
		</div></div><div class="tree-container mod-root nav-folder tree-item outline-tree" data-depth="0"><div class="tree-header"><span class="sidebar-section-header">Table Of Contents</span><button class="clickable-icon collapse-tree-button" aria-label="Collapse All"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></svg></button></div><div class="tree-scroll-area tree-item-children nav-folder-children"><div class="tree-item mod-tree-folder nav-folder mod-collapsible is-collapsed" style="display: none;"></div><div class="tree-item" data-depth="1"><a class="tree-link" href="computer-science/programming-language/ocaml/transitioning-to-multicore-with-threadsanitizer.html#Transitioning to Multicore with ThreadSanitizer"><div class="tree-item-contents heading-link" heading-name="Transitioning to Multicore with ThreadSanitizer"><span class="tree-item-title">Transitioning to Multicore with ThreadSanitizer</span></div></a><div class="tree-item-children nav-folder-children"><div class="tree-item" data-depth="2"><a class="tree-link" href="computer-science/programming-language/ocaml/transitioning-to-multicore-with-threadsanitizer.html#[](https://www.ocaml.org/docs/multicore-transition#an-example-application)An_Example_Application"></a><div class="tree-item-contents heading-link" heading-name="[](https://www.ocaml.org/docs/multicore-transition#an-example-application)An Example Application"><a class="tree-link" href="computer-science/programming-language/ocaml/transitioning-to-multicore-with-threadsanitizer.html#[](https://www.ocaml.org/docs/multicore-transition#an-example-application)An_Example_Application"><span class="tree-item-title"></span></a><a data-tooltip-position="top" aria-label="https://www.ocaml.org/docs/multicore-transition#an-example-application" rel="noopener" class="external-link" href="https://www.ocaml.org/docs/multicore-transition#an-example-application" target="_blank"></a>An Example Application</div><div class="tree-item-children nav-folder-children"></div></div><div class="tree-item" data-depth="2"><a class="tree-link" href="computer-science/programming-language/ocaml/transitioning-to-multicore-with-threadsanitizer.html#[](https://www.ocaml.org/docs/multicore-transition#a-proposed-workflow)A_Proposed_Workflow"></a><div class="tree-item-contents heading-link" heading-name="[](https://www.ocaml.org/docs/multicore-transition#a-proposed-workflow)A Proposed Workflow"><a class="tree-link" href="computer-science/programming-language/ocaml/transitioning-to-multicore-with-threadsanitizer.html#[](https://www.ocaml.org/docs/multicore-transition#a-proposed-workflow)A_Proposed_Workflow"><span class="tree-item-title"></span></a><a data-tooltip-position="top" aria-label="https://www.ocaml.org/docs/multicore-transition#a-proposed-workflow" rel="noopener" class="external-link" href="https://www.ocaml.org/docs/multicore-transition#a-proposed-workflow" target="_blank"></a>A Proposed Workflow</div><div class="tree-item-children nav-folder-children"></div></div><div class="tree-item mod-collapsible" data-depth="2"><a class="tree-link" href="computer-science/programming-language/ocaml/transitioning-to-multicore-with-threadsanitizer.html#[](https://www.ocaml.org/docs/multicore-transition#following-the-workflow)Following_the_Workflow"></a><div class="tree-item-contents heading-link" heading-name="[](https://www.ocaml.org/docs/multicore-transition#following-the-workflow)Following the Workflow"><a class="tree-link" href="computer-science/programming-language/ocaml/transitioning-to-multicore-with-threadsanitizer.html#[](https://www.ocaml.org/docs/multicore-transition#following-the-workflow)Following_the_Workflow"><div class="collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div><span class="tree-item-title"></span></a><a data-tooltip-position="top" aria-label="https://www.ocaml.org/docs/multicore-transition#following-the-workflow" rel="noopener" class="external-link" href="https://www.ocaml.org/docs/multicore-transition#following-the-workflow" target="_blank"></a>Following the Workflow</div><div class="tree-item-children nav-folder-children"><div class="tree-item" data-depth="3"><a class="tree-link" href="computer-science/programming-language/ocaml/transitioning-to-multicore-with-threadsanitizer.html#[](https://www.ocaml.org/docs/multicore-transition#install-the-instrumenting-tsan-compiler-step-0)Install_the_Instrumenting_TSan_Compiler_(Step_0)"></a><div class="tree-item-contents heading-link" heading-name="[](https://www.ocaml.org/docs/multicore-transition#install-the-instrumenting-tsan-compiler-step-0)Install the Instrumenting TSan Compiler (Step 0)"><a class="tree-link" href="computer-science/programming-language/ocaml/transitioning-to-multicore-with-threadsanitizer.html#[](https://www.ocaml.org/docs/multicore-transition#install-the-instrumenting-tsan-compiler-step-0)Install_the_Instrumenting_TSan_Compiler_(Step_0)"><span class="tree-item-title"></span></a><a data-tooltip-position="top" aria-label="https://www.ocaml.org/docs/multicore-transition#install-the-instrumenting-tsan-compiler-step-0" rel="noopener" class="external-link" href="https://www.ocaml.org/docs/multicore-transition#install-the-instrumenting-tsan-compiler-step-0" target="_blank"></a>Install the Instrumenting TSan Compiler (Step 0)</div><div class="tree-item-children nav-folder-children"></div></div><div class="tree-item" data-depth="3"><a class="tree-link" href="computer-science/programming-language/ocaml/transitioning-to-multicore-with-threadsanitizer.html#[](https://www.ocaml.org/docs/multicore-transition#write-a-parallel-test-runner-step-1)Write_a_Parallel_Test_Runner_(Step_1)"></a><div class="tree-item-contents heading-link" heading-name="[](https://www.ocaml.org/docs/multicore-transition#write-a-parallel-test-runner-step-1)Write a Parallel Test Runner (Step 1)"><a class="tree-link" href="computer-science/programming-language/ocaml/transitioning-to-multicore-with-threadsanitizer.html#[](https://www.ocaml.org/docs/multicore-transition#write-a-parallel-test-runner-step-1)Write_a_Parallel_Test_Runner_(Step_1)"><span class="tree-item-title"></span></a><a data-tooltip-position="top" aria-label="https://www.ocaml.org/docs/multicore-transition#write-a-parallel-test-runner-step-1" rel="noopener" class="external-link" href="https://www.ocaml.org/docs/multicore-transition#write-a-parallel-test-runner-step-1" target="_blank"></a>Write a Parallel Test Runner (Step 1)</div><div class="tree-item-children nav-folder-children"></div></div><div class="tree-item" data-depth="3"><a class="tree-link" href="computer-science/programming-language/ocaml/transitioning-to-multicore-with-threadsanitizer.html#[](https://www.ocaml.org/docs/multicore-transition#run-the-parallel-tests-under-tsan-step-2)Run_the_Parallel_Tests_Under_TSan_(Step_2)"></a><div class="tree-item-contents heading-link" heading-name="[](https://www.ocaml.org/docs/multicore-transition#run-the-parallel-tests-under-tsan-step-2)Run the Parallel Tests Under TSan (Step 2)"><a class="tree-link" href="computer-science/programming-language/ocaml/transitioning-to-multicore-with-threadsanitizer.html#[](https://www.ocaml.org/docs/multicore-transition#run-the-parallel-tests-under-tsan-step-2)Run_the_Parallel_Tests_Under_TSan_(Step_2)"><span class="tree-item-title"></span></a><a data-tooltip-position="top" aria-label="https://www.ocaml.org/docs/multicore-transition#run-the-parallel-tests-under-tsan-step-2" rel="noopener" class="external-link" href="https://www.ocaml.org/docs/multicore-transition#run-the-parallel-tests-under-tsan-step-2" target="_blank"></a>Run the Parallel Tests Under TSan (Step 2)</div><div class="tree-item-children nav-folder-children"></div></div><div class="tree-item" data-depth="3"><a class="tree-link" href="computer-science/programming-language/ocaml/transitioning-to-multicore-with-threadsanitizer.html#[](https://www.ocaml.org/docs/multicore-transition#address-the-reported-races-and-rerun-the-tests-steps-3-and-2)Address_the_Reported_Races_and_Rerun_the_Tests_(Steps_3_and_2)"></a><div class="tree-item-contents heading-link" heading-name="[](https://www.ocaml.org/docs/multicore-transition#address-the-reported-races-and-rerun-the-tests-steps-3-and-2)Address the Reported Races and Rerun the Tests (Steps 3 and 2)"><a class="tree-link" href="computer-science/programming-language/ocaml/transitioning-to-multicore-with-threadsanitizer.html#[](https://www.ocaml.org/docs/multicore-transition#address-the-reported-races-and-rerun-the-tests-steps-3-and-2)Address_the_Reported_Races_and_Rerun_the_Tests_(Steps_3_and_2)"><span class="tree-item-title"></span></a><a data-tooltip-position="top" aria-label="https://www.ocaml.org/docs/multicore-transition#address-the-reported-races-and-rerun-the-tests-steps-3-and-2" rel="noopener" class="external-link" href="https://www.ocaml.org/docs/multicore-transition#address-the-reported-races-and-rerun-the-tests-steps-3-and-2" target="_blank"></a>Address the Reported Races and Rerun the Tests (Steps 3 and 2)</div><div class="tree-item-children nav-folder-children"></div></div><div class="tree-item" data-depth="3"><a class="tree-link" href="computer-science/programming-language/ocaml/transitioning-to-multicore-with-threadsanitizer.html#[](https://www.ocaml.org/docs/multicore-transition#address-the-reported-races-and-rerun-the-tests-take-2-steps-3-and-2)Address_the_Reported_Races_and_Rerun_the_Tests,_Take_2_(Steps_3_and_2)"></a><div class="tree-item-contents heading-link" heading-name="[](https://www.ocaml.org/docs/multicore-transition#address-the-reported-races-and-rerun-the-tests-take-2-steps-3-and-2)Address the Reported Races and Rerun the Tests, Take 2 (Steps 3 and 2)"><a class="tree-link" href="computer-science/programming-language/ocaml/transitioning-to-multicore-with-threadsanitizer.html#[](https://www.ocaml.org/docs/multicore-transition#address-the-reported-races-and-rerun-the-tests-take-2-steps-3-and-2)Address_the_Reported_Races_and_Rerun_the_Tests,_Take_2_(Steps_3_and_2)"><span class="tree-item-title"></span></a><a data-tooltip-position="top" aria-label="https://www.ocaml.org/docs/multicore-transition#address-the-reported-races-and-rerun-the-tests-take-2-steps-3-and-2" rel="noopener" class="external-link" href="https://www.ocaml.org/docs/multicore-transition#address-the-reported-races-and-rerun-the-tests-take-2-steps-3-and-2" target="_blank"></a>Address the Reported Races and Rerun the Tests, Take 2 (Steps 3 and 2)</div><div class="tree-item-children nav-folder-children"></div></div><div class="tree-item" data-depth="3"><a class="tree-link" href="computer-science/programming-language/ocaml/transitioning-to-multicore-with-threadsanitizer.html#[](https://www.ocaml.org/docs/multicore-transition#final-remarks-and-a-word-of-warning)Final_Remarks_and_a_Word_of_Warning"></a><div class="tree-item-contents heading-link" heading-name="[](https://www.ocaml.org/docs/multicore-transition#final-remarks-and-a-word-of-warning)Final Remarks and a Word of Warning"><a class="tree-link" href="computer-science/programming-language/ocaml/transitioning-to-multicore-with-threadsanitizer.html#[](https://www.ocaml.org/docs/multicore-transition#final-remarks-and-a-word-of-warning)Final_Remarks_and_a_Word_of_Warning"><span class="tree-item-title"></span></a><a data-tooltip-position="top" aria-label="https://www.ocaml.org/docs/multicore-transition#final-remarks-and-a-word-of-warning" rel="noopener" class="external-link" href="https://www.ocaml.org/docs/multicore-transition#final-remarks-and-a-word-of-warning" target="_blank"></a>Final Remarks and a Word of Warning</div><div class="tree-item-children nav-folder-children"></div></div></div></div></div></div></div></div></div><script defer="">let rs = document.querySelector(".sidebar-right"); rs.classList.add("is-collapsed"); if (window.innerWidth > 768) rs.classList.remove("is-collapsed"); rs.style.setProperty("--sidebar-width", localStorage.getItem("sidebar-right-width"));</script></div></div></body></html>