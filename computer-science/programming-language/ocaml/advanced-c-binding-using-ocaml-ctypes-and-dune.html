<!DOCTYPE html> <html><head>
		<title>Advanced C binding using ocaml-ctypes and dune</title>
		<base href="../../../">
		<meta id="root-path" root-path="../../../">
		<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes, minimum-scale=1.0, maximum-scale=5.0">
		<meta charset="UTF-8">
		<meta name="description" content="韩暮秋的个人维基 - Advanced C binding using ocaml-ctypes and dune">
		<meta property="og:title" content="Advanced C binding using ocaml-ctypes and dune">
		<meta property="og:description" content="韩暮秋的个人维基 - Advanced C binding using ocaml-ctypes and dune">
		<meta property="og:type" content="website">
		<meta property="og:url" content="https://muqiuhan.github.io/wiki/computer-science/programming-language/ocaml/advanced-c-binding-using-ocaml-ctypes-and-dune.html">
		<meta property="og:image" content="undefined">
		<meta property="og:site_name" content="韩暮秋的个人维基">
		<meta name="author" content="韩暮秋"><link rel="alternate" type="application/rss+xml" title="RSS Feed" href="https://muqiuhan.github.io/wiki/lib/rss.xml"><script async="" id="webpage-script" src="lib/scripts/webpage.js" onload="this.onload=null;this.setAttribute(&quot;loaded&quot;, &quot;true&quot;)"></script><script type="module" async="" id="graph-view-script" src="lib/scripts/graph-view.js"></script><script async="" id="graph-wasm-script" src="lib/scripts/graph-wasm.js" onload="this.onload=null;this.setAttribute(&quot;loaded&quot;, &quot;true&quot;)"></script><script async="" id="graph-render-worker-script" src="lib/scripts/graph-render-worker.js" onload="this.onload=null;this.setAttribute(&quot;loaded&quot;, &quot;true&quot;)"></script><script async="" id="tinycolor-script" src="lib/scripts/tinycolor.js" onload="this.onload=null;this.setAttribute(&quot;loaded&quot;, &quot;true&quot;)"></script><script async="" id="pixi-script" src="lib/scripts/pixi.js" onload="this.onload=null;this.setAttribute(&quot;loaded&quot;, &quot;true&quot;)"></script><script async="" id="minisearch-script" src="lib/scripts/minisearch.js" onload="this.onload=null;this.setAttribute(&quot;loaded&quot;, &quot;true&quot;)"></script><link rel="icon" href="lib/media/favicon.png"><script async="" id="graph-data-script" src="lib/scripts/graph-data.js" onload="this.onload=null;this.setAttribute(&quot;loaded&quot;, &quot;true&quot;)"></script><style>body{--line-width:40em;--line-width-adaptive:40em;--file-line-width:40em;--sidebar-width:min(20em, 80vw);--collapse-arrow-size:11px;--tree-horizontal-spacing:0.6em;--tree-vertical-spacing:0.6em;--sidebar-margin:12px}.sidebar{height:100%;min-width:calc(var(--sidebar-width) + var(--divider-width-hover));max-width:calc(var(--sidebar-width) + var(--divider-width-hover));font-size:14px;z-index:10;position:relative;overflow:hidden;transition:min-width ease-in-out,max-width ease-in-out;transition-duration:.2s;contain:size}.sidebar-left{left:0}.sidebar-right{right:0}.sidebar.is-collapsed{min-width:0;max-width:0}body.floating-sidebars .sidebar{position:absolute}.sidebar-content{height:100%;min-width:calc(var(--sidebar-width) - var(--divider-width-hover));top:0;padding:var(--sidebar-margin);padding-top:4em;line-height:var(--line-height-tight);background-color:var(--background-secondary);transition:background-color,border-right,border-left,box-shadow;transition-duration:var(--color-fade-speed);transition-timing-function:ease-in-out;position:absolute;display:flex;flex-direction:column}.sidebar:not(.is-collapsed) .sidebar-content{min-width:calc(max(100%,var(--sidebar-width)) - 3px);max-width:calc(max(100%,var(--sidebar-width)) - 3px)}.sidebar-left .sidebar-content{left:0;border-top-right-radius:var(--radius-l);border-bottom-right-radius:var(--radius-l)}.sidebar-right .sidebar-content{right:0;border-top-left-radius:var(--radius-l);border-bottom-left-radius:var(--radius-l)}.sidebar:has(.sidebar-content:empty):has(.topbar-content:empty){display:none}.sidebar-topbar{height:2em;width:var(--sidebar-width);top:var(--sidebar-margin);padding-inline:var(--sidebar-margin);z-index:1;position:fixed;display:flex;align-items:center;transition:width ease-in-out;transition-duration:inherit}.sidebar.is-collapsed .sidebar-topbar{width:calc(2.3em + var(--sidebar-margin) * 2)}.sidebar .sidebar-topbar.is-collapsed{width:0}.sidebar-left .sidebar-topbar{left:0}.sidebar-right .sidebar-topbar{right:0}.topbar-content{overflow:hidden;overflow:clip;width:100%;height:100%;display:flex;align-items:center;transition:inherit}.sidebar.is-collapsed .topbar-content{width:0;transition:inherit}.clickable-icon.sidebar-collapse-icon{background-color:transparent;color:var(--icon-color-focused);padding:0!important;margin:0!important;height:100%!important;width:2.3em!important;margin-inline:0.14em!important;position:absolute}.sidebar-left .clickable-icon.sidebar-collapse-icon{transform:rotateY(180deg);right:var(--sidebar-margin)}.sidebar-right .clickable-icon.sidebar-collapse-icon{transform:rotateY(180deg);left:var(--sidebar-margin)}.clickable-icon.sidebar-collapse-icon svg.svg-icon{width:100%;height:100%}.sidebar-section-header{margin:0 0 1em 0;text-transform:uppercase;letter-spacing:.06em;font-weight:600}body{transition:background-color var(--color-fade-speed) ease-in-out}.webpage-container{display:flex;flex-direction:row;height:100%;width:100%;align-items:stretch;justify-content:center}.document-container{opacity:1;flex-basis:100%;max-width:100%;width:100%;height:100%;display:flex;flex-direction:column;align-items:center;transition:opacity .2s ease-in-out;contain:inline-size}.hide{opacity:0;transition:opacity .2s ease-in-out}.document-container>.markdown-preview-view{margin:var(--sidebar-margin);margin-bottom:0;width:100%;width:-webkit-fill-available;width:-moz-available;width:fill-available;background-color:var(--background-primary);transition:background-color var(--color-fade-speed) ease-in-out;border-top-right-radius:var(--window-radius,var(--radius-m));border-top-left-radius:var(--window-radius,var(--radius-m));overflow-x:hidden!important;overflow-y:auto!important;display:flex!important;flex-direction:column!important;align-items:center!important;contain:inline-size}.document-container>.markdown-preview-view>.markdown-preview-sizer{padding-bottom:80vh!important;width:100%!important;max-width:var(--line-width)!important;flex-basis:var(--line-width)!important;transition:background-color var(--color-fade-speed) ease-in-out;contain:inline-size}.markdown-rendered img:not([width]),.view-content img:not([width]){max-width:100%;outline:0}.document-container>.view-content.embed{display:flex;padding:1em;height:100%;width:100%;align-items:center;justify-content:center}.document-container>.view-content.embed>*{max-width:100%;max-height:100%;object-fit:contain}:has(> :is(.math,table)){overflow-x:auto!important}.document-container>.view-content{overflow-x:auto;contain:content;padding:0;margin:0;height:100%}.scroll-highlight{position:absolute;width:100%;height:100%;pointer-events:none;z-index:1000;background-color:hsla(var(--color-accent-hsl),.25);opacity:0;padding:1em;inset:50%;translate:-50% -50%;border-radius:var(--radius-s)}</style><script defer="">async function loadIncludes(){if("file:"!=location.protocol){let e=document.querySelectorAll("include");for(let t=0;t<e.length;t++){let o=e[t],l=o.getAttribute("src");try{const e=await fetch(l);if(!e.ok){console.log("Could not include file: "+l),o?.remove();continue}let t=await e.text(),n=document.createRange().createContextualFragment(t),i=Array.from(n.children);for(let e of i)e.classList.add("hide"),e.style.transition="opacity 0.5s ease-in-out",setTimeout((()=>{e.classList.remove("hide")}),10);o.before(n),o.remove(),console.log("Included file: "+l)}catch(e){o?.remove(),console.log("Could not include file: "+l,e);continue}}}else{if(document.querySelectorAll("include").length>0){var e=document.createElement("div");e.id="error",e.textContent="Web server exports must be hosted on an http / web server to be viewed correctly.",e.style.position="fixed",e.style.top="50%",e.style.left="50%",e.style.transform="translate(-50%, -50%)",e.style.fontSize="1.5em",e.style.fontWeight="bold",e.style.textAlign="center",document.body.appendChild(e),document.querySelector(".document-container")?.classList.remove("hide")}}}document.addEventListener("DOMContentLoaded",(()=>{loadIncludes()}));let isFileProtocol="file:"==location.protocol;function waitLoadScripts(e,t){let o=e.map((e=>document.getElementById(e+"-script"))),l=0;!function e(){let n=o[l];l++,n&&"true"!=n.getAttribute("loaded")||l<o.length&&e(),l<o.length?n.addEventListener("load",e):t()}()}</script><link rel="stylesheet" href="lib/styles/obsidian.css"><link rel="preload" href="lib/styles/other-plugins.css" as="style" onload="this.onload=null;this.rel='stylesheet'"><noscript><link rel="stylesheet" href="lib/styles/other-plugins.css"></noscript><link rel="stylesheet" href="lib/styles/theme.css"><link rel="preload" href="lib/styles/global-variable-styles.css" as="style" onload="this.onload=null;this.rel='stylesheet'"><noscript><link rel="stylesheet" href="lib/styles/global-variable-styles.css"></noscript><link rel="preload" href="lib/styles/main-styles.css" as="style" onload="this.onload=null;this.rel='stylesheet'"><noscript><link rel="stylesheet" href="lib/styles/main-styles.css"></noscript></head><body class="publish css-settings-manager theme-light show-inline-title show-ribbon outliner-plugin-dnd h2-underline"><script defer="">let theme=localStorage.getItem("theme")||(window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light");"dark"==theme?(document.body.classList.add("theme-dark"),document.body.classList.remove("theme-light")):(document.body.classList.add("theme-light"),document.body.classList.remove("theme-dark")),window.innerWidth<480?document.body.classList.add("is-phone"):window.innerWidth<768?document.body.classList.add("is-tablet"):window.innerWidth<1024?document.body.classList.add("is-small-screen"):document.body.classList.add("is-large-screen")</script><div class="webpage-container workspace"><div class="sidebar-left sidebar"><div class="sidebar-handle"></div><div class="sidebar-topbar"><div class="topbar-content"><label class="theme-toggle-container" for="theme_toggle"><input class="theme-toggle-input" type="checkbox" id="theme_toggle"><div class="toggle-background"></div></label></div><div class="clickable-icon sidebar-collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" class="svg-icon"><path d="M21 3H3C1.89543 3 1 3.89543 1 5V19C1 20.1046 1.89543 21 3 21H21C22.1046 21 23 20.1046 23 19V5C23 3.89543 22.1046 3 21 3Z"></path><path d="M10 4V20"></path><path d="M4 7H7"></path><path d="M4 10H7"></path><path d="M4 13H7"></path></svg></div></div><div class="sidebar-content"><div class="search-input-container"><input enterkeyhint="search" type="search" spellcheck="false" placeholder="Search..."><div class="search-input-clear-button" aria-label="Clear search"></div></div><include src="lib/html/file-tree.html"></include></div><script defer="">let ls = document.querySelector(".sidebar-left"); ls.classList.add("is-collapsed"); if (window.innerWidth > 768) ls.classList.remove("is-collapsed"); ls.style.setProperty("--sidebar-width", localStorage.getItem("sidebar-left-width"));</script></div><div class="document-container markdown-reading-view hide"><div class="markdown-preview-view markdown-rendered allow-fold-headings allow-fold-lists is-readable-line-width"><style id="MJX-CHTML-styles"></style><div class="markdown-preview-sizer markdown-preview-section"><h1 class="page-title heading inline-title" id="Advanced C binding using ocaml-ctypes and dune"><p dir="auto">Advanced C binding using ocaml-ctypes and dune</p></h1><div class="el-p"><p dir="auto"><a href="?query=tag:ocaml" class="tag" target="_blank" rel="noopener nofollow">#ocaml</a> <a href="?query=tag:fp" class="tag" target="_blank" rel="noopener nofollow">#fp</a></p></div><div class="el-p"><p dir="auto">I was working on a OCaml binding for <a data-tooltip-position="top" aria-label="https://github.com/Haivision/srt" rel="noopener nofollow" class="external-link" href="https://github.com/Haivision/srt" target="_blank">libsrt</a> last summer, to add support for SRT real-time input and output to <a data-tooltip-position="top" aria-label="https://github.com/savonet/liquidsoap" rel="noopener nofollow" class="external-link" href="https://github.com/savonet/liquidsoap" target="_blank">liquidsoap</a>, and came across the need to access the <code>[sys/socket.h](https://pubs.opengroup.org/onlinepubs/7908799/xns/syssocket.h.html)</code> C API.</p></div><div class="el-p"><p dir="auto">I had already decided to use the very elegant <code>[ocaml-ctypes](https://github.com/ocamllabs/ocaml-ctypes)</code> module for the SRT binding so I went with it and created a <code>[ocaml-sys-socket](https://github.com/toots/ocaml-sys-socket)</code> module using it as well. It was a very interesting experience that I would like to describe here!</p></div><div class="el-h1 heading-wrapper"><h1 data-heading="ocaml-ctypes" dir="auto" class="heading" id="ocaml-ctypes">ocaml-ctypes</h1><div class="heading-children"><div class="el-p"><p dir="auto">The idea behind OCaml ctypes is to create a binding against a C library without having to write C code, or as least as possible. The most straight-forward way of using it is via <code>[libffi](https://github.com/libffi/libffi)</code> , providing access to dynamically-loaded libraries.</p></div><div class="el-p"><p dir="auto">The second way of using it is by letting the module generate the basic C stubs required to build and link against a shared library. This is the mode that we’re going to use here. In this mode, the programmer has to describe the C headers of the library they intent to bind to using dedicated OCaml modules, operators and types. From that description, ocaml-ctypes is able to generate the required glue for the binding.</p></div><div class="el-p"><p dir="auto">One advantage of using ocaml-ctypes is that the created bindings make as few assumptions as possible about the <a data-tooltip-position="top" aria-label="https://caml.inria.fr/pub/docs/manual-ocaml/intfc.html" rel="noopener nofollow" class="external-link" href="https://caml.inria.fr/pub/docs/manual-ocaml/intfc.html" target="_blank">OCaml C interfacing API</a>. This is pretty nice, in particular since the <a data-tooltip-position="top" aria-label="https://github.com/ocaml/ocaml" rel="noopener nofollow" class="external-link" href="https://github.com/ocaml/ocaml" target="_blank">OCaml compiler</a> is moving pretty quickly these days (which is awesome!) and also if, perhaps one day, <a data-tooltip-position="top" aria-label="https://github.com/ocaml-multicore/ocaml-multicore" rel="noopener nofollow" class="external-link" href="https://github.com/ocaml-multicore/ocaml-multicore" target="_blank">support for multi-core</a> is added to the compiler, which will undoubtedly change the C interface API quite a bit.</p></div></div></div><div class="el-h1 heading-wrapper"><h1 data-heading="dune" dir="auto" class="heading" id="dune">dune</h1><div class="heading-children"><div class="el-p"><p dir="auto"><code>[dune](https://github.com/ocaml/dune)</code> (formally <code>jbuilder</code> ) is a build system for OCaml projects that has recently raised to much popularity, particularly due to its tight integration with the rest of the OCaml ecosystem, such as <code>[ocamlfind](http://projects.camlcity.org/projects/findlib.html)</code> and <code>[opam](https://opam.ocaml.org/)</code> .</p></div><div class="el-p"><p dir="auto">My personal motto in programming in general is that <em>“Simple things should be simple, but complex things should be possible”</em>. <code>dune</code> certainly does not fit into that category but, rather, makes some complex things extremely easy to setup. It’s the kind of tool that will make your life incredibly easier when what you intent to do fits well within their workflow but might not be easy to bend to some very specific niche use. We will see one such case below.</p></div><div class="el-p"><p dir="auto">At any rate, it’s been an amazing experience getting to learn how to use <code>dune</code> and the resulting code and build system is remarkably short and elegant, yet very powerful.</p></div></div></div><div class="el-h1 heading-wrapper"><h1 data-heading="socket.h" dir="auto" class="heading" id="socket.h">socket.h</h1><div class="heading-children"><div class="el-p"><p dir="auto"><code>socket.h</code> is the Unix header that describes the C API to various socket operations, IP version 4 and 6 as well as unix file sockets. There is also a windows API mimicking it, which makes most code using it easily portable to&nbsp;windows.</p></div><div class="el-p"><p dir="auto">Most network-based C libraries refer to <code>socket.h</code> to describe the type of socket that can be used with their API so it’s an important entry point for a lot of network operations and one that would be nice to support as generically as possible in OCaml.</p></div><div class="el-p"><p dir="auto">The catch, though, is that, most likely for historical reasons¹, the <a data-tooltip-position="top" aria-label="https://pubs.opengroup.org/onlinepubs/7908799/xns/syssocket.h.html" rel="noopener nofollow" class="external-link" href="https://pubs.opengroup.org/onlinepubs/7908799/xns/syssocket.h.html" target="_blank">POSIX specifications</a> only <em>partially</em> defines some of the required data structures and types, which makes it possible to write C code using them but does not give enough information to write C bindings without having to use the compiler to parse the actual system-specific headers of the running host.</p></div><div class="el-p"><p dir="auto">For instance, here’s how the <code>sockaddr</code> structure is specified:</p></div><div class="el-p"><p dir="auto">The <em>&lt;sys/socket.h&gt;</em> header defines the <strong>sockaddr</strong> structure that includes at least the following members:sa_family_t   sa_family       address family<br>
char          sa_data[]       socket address (variable-length data)</p></div><div class="el-p"><p dir="auto">Likewise, here’s what is specified about the size of the <code>socklen_t</code> data type:</p></div><div class="el-p"><p dir="auto"><em>&lt;sys/socket.h&gt;</em> makes available a type, <strong>socklen_t</strong>, which is an unsigned opaque integral type of length of at least 32 bits.</p></div><div class="el-p"><p dir="auto">Thus, in order to know the exact offset of <code>sa_family</code> inside the <code>sockaddr</code> structure or the actual size of a <code>socklen_t</code> integer, one has to include the OS-specific header, parse its definitions for that specific OS and, only then, is it possible to compute that offset or data size. Let’s see how it’s done in our binding now!</p></div></div></div><div class="el-h1 heading-wrapper"><h1 data-heading="Putting it together" dir="auto" class="heading" id="Putting_it_together">Putting it together</h1><div class="heading-children"><div class="el-p"><p dir="auto">The C binding requires 4 separate passes:</p></div><div class="el-ul"><ul>
<li data-line="0" dir="auto">The <code>[constants](https://github.com/toots/ocaml-sys-socket/tree/master/src/sys-socket/constants)</code> pass, which computes and exports some specific constant and data sizes, computed from the C headers</li>
<li data-line="1" dir="auto">The <code>[types](https://github.com/toots/ocaml-sys-socket/tree/master/src/sys-socket/types)</code> pass, which, given the system-specific constants and sizes exported in the previous phase, defines the actual C data structure bindings.</li>
<li data-line="2" dir="auto">The <code>[stubs](https://github.com/toots/ocaml-sys-socket/tree/master/src/sys-socket/stubs)</code> pass, where we define the actual bindings to the C functions that we wish to export in our API.</li>
<li data-line="3" dir="auto">Finally, the <a data-tooltip-position="top" aria-label="https://github.com/toots/ocaml-sys-socket/blob/master/src/sys-socket/sys_socket.mli" rel="noopener nofollow" class="external-link" href="https://github.com/toots/ocaml-sys-socket/blob/master/src/sys-socket/sys_socket.mli" target="_blank">last pass</a> does a cleanup of the <code>stubs</code> pass to export a relevant and OCaml- (and <code>ocaml-ctypes</code>) specific public API that is to be used by users of the module.</li>
</ul></div><div class="el-p"><p dir="auto"><code>dune</code> makes each of these steps fairly easy to integrate into the next one, defining compilation elements and binaries to build before moving to the next pass.</p></div><div class="el-h2 heading-wrapper"><h2 data-heading="Constants pass" dir="auto" class="heading" id="Constants_pass"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>Constants pass</h2><div class="heading-children"><div class="el-p"><p dir="auto">During that pass, we compute and export all required C values defined in the headers. We also add our own constants, which give us the sizes that the POSIX specifications leave up to the OS. Here’s the OCaml code for it:</p></div><div class="el-pre"><pre class="language-ocaml" tabindex="0"><code data-line="0" class="language-ocaml is-loaded"><span class="token keyword">module</span> Def <span class="token punctuation">(</span>S <span class="token punctuation">:</span> Cstubs<span class="token punctuation">.</span>Types<span class="token punctuation">.</span>TYPE<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token keyword">struct</span>
  <span class="token keyword">let</span> af_inet <span class="token operator">=</span> S<span class="token punctuation">.</span>constant <span class="token string">"AF_INET"</span> S<span class="token punctuation">.</span>int
  <span class="token keyword">let</span> af_inet6 <span class="token operator">=</span> S<span class="token punctuation">.</span>constant <span class="token string">"AF_INET6"</span> S<span class="token punctuation">.</span>int
  <span class="token keyword">let</span> af_unix <span class="token operator">=</span> S<span class="token punctuation">.</span>constant <span class="token string">"AF_UNIX"</span> S<span class="token punctuation">.</span>int
  <span class="token keyword">let</span> af_unspec <span class="token operator">=</span> S<span class="token punctuation">.</span>constant <span class="token string">"AF_UNSPEC"</span> S<span class="token punctuation">.</span>int
  <span class="token keyword">let</span> sa_data_len <span class="token operator">=</span> S<span class="token punctuation">.</span>constant <span class="token string">"SA_DATA_LEN"</span> S<span class="token punctuation">.</span>int
  <span class="token keyword">let</span> sa_family_len <span class="token operator">=</span> S<span class="token punctuation">.</span>constant <span class="token string">"SA_FAMILY_LEN"</span> S<span class="token punctuation">.</span>int
  <span class="token keyword">let</span> sock_dgram <span class="token operator">=</span> S<span class="token punctuation">.</span>constant <span class="token string">"SOCK_DGRAM"</span> S<span class="token punctuation">.</span>int
  <span class="token keyword">let</span> sock_stream <span class="token operator">=</span> S<span class="token punctuation">.</span>constant <span class="token string">"SOCK_STREAM"</span> S<span class="token punctuation">.</span>int
  <span class="token keyword">let</span> sock_seqpacket <span class="token operator">=</span> S<span class="token punctuation">.</span>constant <span class="token string">"SOCK_STREAM"</span> S<span class="token punctuation">.</span>int
  <span class="token keyword">let</span> socklen_t_len <span class="token operator">=</span> S<span class="token punctuation">.</span>constant <span class="token string">"SOCKLEN_T_LEN"</span> S<span class="token punctuation">.</span>int
  <span class="token keyword">let</span> ni_maxserv <span class="token operator">=</span> S<span class="token punctuation">.</span>constant <span class="token string">"NI_MAXSERV"</span> S<span class="token punctuation">.</span>int
  <span class="token keyword">let</span> ni_maxhost <span class="token operator">=</span> S<span class="token punctuation">.</span>constant <span class="token string">"NI_MAXHOST"</span> S<span class="token punctuation">.</span>int
  <span class="token keyword">let</span> ni_numerichost <span class="token operator">=</span> S<span class="token punctuation">.</span>constant <span class="token string">"NI_NUMERICHOST"</span> S<span class="token punctuation">.</span>int
  <span class="token keyword">let</span> ni_numericserv <span class="token operator">=</span> S<span class="token punctuation">.</span>constant <span class="token string">"NI_NUMERICSERV"</span> S<span class="token punctuation">.</span>int
<span class="token keyword">end</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">Pretty straightforward! Some of these constants are defined by the POSIX headers and some are custom defined for our needs, for instance <code>SOCKLEN_T_LEN</code> . Here’s how they are extracted, using the <code>dune</code> build configuration for <code>[gen_constants_c](https://github.com/toots/ocaml-sys-socket/blob/master/src/sys-socket/generator/gen_constants_c.ml)</code>:</p></div><div class="el-pre"><pre class="language-ocaml" tabindex="0"><code data-line="0" class="language-ocaml is-loaded"><span class="token keyword">let</span> c_headers <span class="token operator">=</span> "
<span class="token directive property">#ifdef</span> _WIN32
  <span class="token directive property">#include</span> <span class="token operator">&lt;</span>winsock2<span class="token punctuation">.</span>h<span class="token operator">&gt;</span>
  <span class="token directive property">#include</span> <span class="token operator">&lt;</span>ws2tcpip<span class="token punctuation">.</span>h<span class="token operator">&gt;</span>
<span class="token directive property">#else</span>
  <span class="token directive property">#include</span> <span class="token operator">&lt;</span>sys<span class="token operator">/</span>socket<span class="token punctuation">.</span>h<span class="token operator">&gt;</span>
  <span class="token directive property">#include</span> <span class="token operator">&lt;</span>sys<span class="token operator">/</span>un<span class="token punctuation">.</span>h<span class="token operator">&gt;</span>
  <span class="token directive property">#include</span> <span class="token operator">&lt;</span>netdb<span class="token punctuation">.</span>h<span class="token operator">&gt;</span>
<span class="token directive property">#endif</span>
<span class="token directive property">#define</span> SA_DATA_LEN <span class="token punctuation">(</span>sizeof<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">struct</span> sockaddr<span class="token operator">*</span><span class="token punctuation">)</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span>sa_data<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token directive property">#define</span> SA_FAMILY_LEN <span class="token punctuation">(</span>sizeof<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">struct</span> sockaddr<span class="token operator">*</span><span class="token punctuation">)</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span>sa_family<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token directive property">#define</span> SOCKLEN_T_LEN <span class="token punctuation">(</span>sizeof<span class="token punctuation">(</span>socklen_t<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token directive property">#ifndef</span> NI_MAXHOST
  <span class="token directive property">#define</span> NI_MAXHOST <span class="token number">1025</span>
<span class="token directive property">#endif</span>
<span class="token directive property">#ifndef</span> NI_MAXSERV
  <span class="token directive property">#define</span> NI_MAXSERV <span class="token number">32</span>
<span class="token directive property">#endif</span>
"
<span class="token keyword">let</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span>
  <span class="token keyword">let</span> fname <span class="token operator">=</span> Sys<span class="token punctuation">.</span>argv<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">in</span>
  <span class="token keyword">let</span> oc <span class="token operator">=</span> open_out_bin fname <span class="token keyword">in</span>
  <span class="token keyword">let</span> format <span class="token operator">=</span>
    Format<span class="token punctuation">.</span>formatter_of_out_channel oc
  <span class="token keyword">in</span>
  Format<span class="token punctuation">.</span>fprintf format <span class="token string">"%s@\n"</span> c_headers<span class="token punctuation">;</span>
  Cstubs<span class="token punctuation">.</span>Types<span class="token punctuation">.</span>write_c format <span class="token punctuation">(</span><span class="token keyword">module</span> Sys_socket_constants<span class="token punctuation">.</span>Def<span class="token punctuation">)</span><span class="token punctuation">;</span>
  Format<span class="token punctuation">.</span>pp_print_flush format <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  close_out oc
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">This OCaml code makes use of <code>ocaml-ctypes</code> to build a binary that exports the OCaml interface defined by <code>Sys_socket_constants.Def</code> . Once compiled, its output looks like this:</p></div><div class="el-pre"><pre class="language-ocaml" tabindex="0"><code data-line="0" class="language-ocaml is-loaded"><span class="token keyword">include</span> Ctypes
<span class="token keyword">let</span> lift x <span class="token operator">=</span> x
<span class="token keyword">open</span> Ctypes_static

<span class="token keyword">let</span> <span class="token keyword">rec</span> field <span class="token punctuation">:</span> <span class="token keyword">type</span> t a<span class="token punctuation">.</span> t typ <span class="token operator">-&gt;</span> string <span class="token operator">-&gt;</span> a typ <span class="token operator">-&gt;</span> <span class="token punctuation">(</span>a<span class="token punctuation">,</span> t<span class="token punctuation">)</span> field <span class="token operator">=</span>
  <span class="token keyword">fun</span> s fname ftype <span class="token operator">-&gt;</span> <span class="token keyword">match</span> s<span class="token punctuation">,</span> fname <span class="token keyword">with</span>
  <span class="token operator">|</span> View <span class="token punctuation">{</span> ty <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">_</span> <span class="token operator">-&gt;</span>
    <span class="token keyword">let</span> <span class="token punctuation">{</span> ftype<span class="token punctuation">;</span> foffset<span class="token punctuation">;</span> fname <span class="token punctuation">}</span> <span class="token operator">=</span> field ty fname ftype <span class="token keyword">in</span>
    <span class="token punctuation">{</span> ftype<span class="token punctuation">;</span> foffset<span class="token punctuation">;</span> fname <span class="token punctuation">}</span>
  <span class="token operator">|</span> <span class="token punctuation">_</span> <span class="token operator">-&gt;</span> failwith <span class="token punctuation">(</span><span class="token string">"Unexpected field "</span><span class="token operator">^</span> fname<span class="token punctuation">)</span>

<span class="token keyword">let</span> <span class="token keyword">rec</span> seal <span class="token punctuation">:</span> <span class="token keyword">type</span> a<span class="token punctuation">.</span> a typ <span class="token operator">-&gt;</span> unit <span class="token operator">=</span> <span class="token keyword">function</span>
  <span class="token operator">|</span> Struct <span class="token punctuation">{</span> tag<span class="token punctuation">;</span> spec <span class="token operator">=</span> Complete <span class="token punctuation">_</span> <span class="token punctuation">}</span> <span class="token operator">-&gt;</span>
    raise <span class="token punctuation">(</span>ModifyingSealedType tag<span class="token punctuation">)</span>
  <span class="token operator">|</span> Union <span class="token punctuation">{</span> utag<span class="token punctuation">;</span> uspec <span class="token operator">=</span> Some <span class="token punctuation">_</span> <span class="token punctuation">}</span> <span class="token operator">-&gt;</span>
    raise <span class="token punctuation">(</span>ModifyingSealedType utag<span class="token punctuation">)</span>
  <span class="token operator">|</span> View <span class="token punctuation">{</span> ty <span class="token punctuation">}</span> <span class="token operator">-&gt;</span> seal ty
  <span class="token operator">|</span> <span class="token punctuation">_</span> <span class="token operator">-&gt;</span>
    raise <span class="token punctuation">(</span>Unsupported <span class="token string">"Sealing a non-structured type"</span><span class="token punctuation">)</span>

<span class="token keyword">type</span> <span class="token type-variable function">'a</span> const <span class="token operator">=</span> <span class="token type-variable function">'a</span>
<span class="token keyword">let</span> constant <span class="token punctuation">(</span><span class="token keyword">type</span> t<span class="token punctuation">)</span> name <span class="token punctuation">(</span>t <span class="token punctuation">:</span> t typ<span class="token punctuation">)</span> <span class="token punctuation">:</span> t <span class="token operator">=</span> <span class="token keyword">match</span> t<span class="token punctuation">,</span> name <span class="token keyword">with</span>
  <span class="token operator">|</span> Ctypes_static<span class="token punctuation">.</span>Primitive Cstubs_internals<span class="token punctuation">.</span>Int<span class="token punctuation">,</span> <span class="token string">"NI_NUMERICSERV"</span> <span class="token operator">-&gt;</span>
    <span class="token number">8</span>
  <span class="token operator">|</span> Ctypes_static<span class="token punctuation">.</span>Primitive Cstubs_internals<span class="token punctuation">.</span>Int<span class="token punctuation">,</span> <span class="token string">"NI_NUMERICHOST"</span> <span class="token operator">-&gt;</span>
    <span class="token number">2</span>
  <span class="token operator">|</span> Ctypes_static<span class="token punctuation">.</span>Primitive Cstubs_internals<span class="token punctuation">.</span>Int<span class="token punctuation">,</span> <span class="token string">"NI_MAXHOST"</span> <span class="token operator">-&gt;</span>
    <span class="token number">1025</span>
  <span class="token operator">|</span> Ctypes_static<span class="token punctuation">.</span>Primitive Cstubs_internals<span class="token punctuation">.</span>Int<span class="token punctuation">,</span> <span class="token string">"NI_MAXSERV"</span> <span class="token operator">-&gt;</span>
    <span class="token number">32</span>
  <span class="token operator">|</span> Ctypes_static<span class="token punctuation">.</span>Primitive Cstubs_internals<span class="token punctuation">.</span>Int<span class="token punctuation">,</span> <span class="token string">"SOCKLEN_T_LEN"</span> <span class="token operator">-&gt;</span>
    <span class="token number">4</span>
  <span class="token operator">|</span> Ctypes_static<span class="token punctuation">.</span>Primitive Cstubs_internals<span class="token punctuation">.</span>Int<span class="token punctuation">,</span> <span class="token string">"SOCK_STREAM"</span> <span class="token operator">-&gt;</span>
    <span class="token number">1</span>
  <span class="token operator">|</span> Ctypes_static<span class="token punctuation">.</span>Primitive Cstubs_internals<span class="token punctuation">.</span>Int<span class="token punctuation">,</span> <span class="token string">"SOCK_STREAM"</span> <span class="token operator">-&gt;</span>
    <span class="token number">1</span>
  <span class="token operator">|</span> Ctypes_static<span class="token punctuation">.</span>Primitive Cstubs_internals<span class="token punctuation">.</span>Int<span class="token punctuation">,</span> <span class="token string">"SOCK_DGRAM"</span> <span class="token operator">-&gt;</span>
    <span class="token number">2</span>
  <span class="token operator">|</span> Ctypes_static<span class="token punctuation">.</span>Primitive Cstubs_internals<span class="token punctuation">.</span>Int<span class="token punctuation">,</span> <span class="token string">"SA_FAMILY_LEN"</span> <span class="token operator">-&gt;</span>
    <span class="token number">1</span>
  <span class="token operator">|</span> Ctypes_static<span class="token punctuation">.</span>Primitive Cstubs_internals<span class="token punctuation">.</span>Int<span class="token punctuation">,</span> <span class="token string">"SA_DATA_LEN"</span> <span class="token operator">-&gt;</span>
    <span class="token number">14</span>
  <span class="token operator">|</span> Ctypes_static<span class="token punctuation">.</span>Primitive Cstubs_internals<span class="token punctuation">.</span>Int<span class="token punctuation">,</span> <span class="token string">"AF_UNSPEC"</span> <span class="token operator">-&gt;</span>
    <span class="token number">0</span>
  <span class="token operator">|</span> Ctypes_static<span class="token punctuation">.</span>Primitive Cstubs_internals<span class="token punctuation">.</span>Int<span class="token punctuation">,</span> <span class="token string">"AF_UNIX"</span> <span class="token operator">-&gt;</span>
    <span class="token number">1</span>
  <span class="token operator">|</span> Ctypes_static<span class="token punctuation">.</span>Primitive Cstubs_internals<span class="token punctuation">.</span>Int<span class="token punctuation">,</span> <span class="token string">"AF_INET6"</span> <span class="token operator">-&gt;</span>
    <span class="token number">30</span>
  <span class="token operator">|</span> Ctypes_static<span class="token punctuation">.</span>Primitive Cstubs_internals<span class="token punctuation">.</span>Int<span class="token punctuation">,</span> <span class="token string">"AF_INET"</span> <span class="token operator">-&gt;</span>
    <span class="token number">2</span>
  <span class="token operator">|</span> <span class="token punctuation">_</span><span class="token punctuation">,</span> s <span class="token operator">-&gt;</span> failwith <span class="token punctuation">(</span><span class="token string">"unmatched constant: "</span><span class="token operator">^</span> s<span class="token punctuation">)</span>

<span class="token keyword">let</span> enum <span class="token punctuation">(</span><span class="token keyword">type</span> a<span class="token punctuation">)</span> name <span class="token operator">?</span>typedef <span class="token operator">?</span>unexpected <span class="token punctuation">(</span>alist <span class="token punctuation">:</span> <span class="token punctuation">(</span>a <span class="token operator">*</span> int64<span class="token punctuation">)</span> list<span class="token punctuation">)</span> <span class="token operator">=</span>
  <span class="token keyword">match</span> name <span class="token keyword">with</span>
  <span class="token operator">|</span> s <span class="token operator">-&gt;</span>
    failwith <span class="token punctuation">(</span><span class="token string">"unmatched enum: "</span><span class="token operator">^</span> s<span class="token punctuation">)</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">The files used to describe how to build this binary using <code>dune</code> are located in a separate <code>[generator](https://github.com/toots/ocaml-sys-socket/tree/master/src/sys-socket/generator)</code> directory. Here’s the entry to build this one:</p></div><div class="el-pre"><pre class="language-dune" tabindex="0"><code data-line="0" class="language-dune is-loaded">(executable
 (name gen_constants_c)
 (modules gen_constants_c)
 (libraries sys-socket.constants ctypes.stubs))

(rule
 (targets gen_constants.c)
 (deps    (:gen ./gen_constants_c.exe))
 (action  (run %{gen} %{targets})))

(rule
 (targets gen_constants_c)
 (deps    (:c_code ./gen_constants.c))
 (action  (run %{ocaml-config:c_compiler} -I %{lib:ctypes:} -I %{ocaml-config:standard_library} -o %{targets} %{c_code})))
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">This executable is compiled during the next phase. Let’s move into it now!</p></div></div></div><div class="el-h2 heading-wrapper"><h2 data-heading="Types pass" dir="auto" class="heading" id="Types_pass"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>Types pass</h2><div class="heading-children"><div class="el-p"><p dir="auto">During that phase, we use the constants exported during the previous phase to describe the various C structures and types. This is by far the most complex part of the code, making use of first-class modules and several OCaml tricks.</p></div><div class="el-p"><p dir="auto">First, let’s look at how we tell <code>dune</code> that we need to generate the <code>.ml</code> file exporting our required constants from the previous pass:</p></div><div class="el-pre"><pre class="language-dune" tabindex="0"><code data-line="0" class="language-dune is-loaded">(rule
 (targets sys_socket_generated_constants.ml)
 (deps    (:exec ../generator/exec.sh)
          (:gen ../generator/gen_constants_c))
 (action  (with-stdout-to %{targets}
            (system "%{exec} %{ocaml-config:system} %{gen}"))))
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">With only this information, if the code refers to a <code>Sys_socket_generated_constants</code> module, <code>dune</code> will know that this module needs to be generated and how to do it. We will explain later the use of the <code>exec.sh</code> wrapper here.</p></div><div class="el-p"><p dir="auto">Now that we can make use of the exported constants in our OCaml code, let’s see how we define the <code>Socklen</code> module, exporting abstract types and interface to use <code>socklen_t</code> integers:</p></div><div class="el-pre"><pre class="language-ocaml" tabindex="0"><code data-line="0" class="language-ocaml is-loaded"><span class="token keyword">module</span> Constants <span class="token operator">=</span> Sys_socket_constants<span class="token punctuation">.</span>Def<span class="token punctuation">(</span>Sys_socket_generated_constants<span class="token punctuation">)</span>

<span class="token keyword">module</span> <span class="token keyword">type</span> Socklen <span class="token operator">=</span> <span class="token keyword">functor</span> <span class="token punctuation">(</span>S <span class="token punctuation">:</span> Cstubs<span class="token punctuation">.</span>Types<span class="token punctuation">.</span>TYPE<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token keyword">sig</span>
  <span class="token keyword">type</span> socklen
  <span class="token keyword">val</span> socklen_t <span class="token punctuation">:</span> socklen S<span class="token punctuation">.</span>typ
  <span class="token keyword">val</span> int_of_socklen <span class="token punctuation">:</span> socklen <span class="token operator">-&gt;</span> int
  <span class="token keyword">val</span> socklen_of_int <span class="token punctuation">:</span> int <span class="token operator">-&gt;</span> socklen
<span class="token keyword">end</span>

<span class="token keyword">let</span> socklen <span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token keyword">module</span> Socklen<span class="token punctuation">)</span>  <span class="token operator">=</span>
    <span class="token keyword">match</span> Constants<span class="token punctuation">.</span>socklen_t_len <span class="token keyword">with</span>
      <span class="token operator">|</span> <span class="token number">4</span> <span class="token operator">-&gt;</span> <span class="token punctuation">(</span><span class="token keyword">module</span> <span class="token keyword">functor</span> <span class="token punctuation">(</span>S <span class="token punctuation">:</span> Cstubs<span class="token punctuation">.</span>Types<span class="token punctuation">.</span>TYPE<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token keyword">struct</span>
                 <span class="token keyword">type</span> socklen <span class="token operator">=</span> Unsigned<span class="token punctuation">.</span>uint32
                 <span class="token keyword">let</span> socklen_t <span class="token operator">=</span> S<span class="token punctuation">.</span>uint32_t
                 <span class="token keyword">let</span> int_of_socklen <span class="token operator">=</span> Unsigned<span class="token punctuation">.</span>UInt32<span class="token punctuation">.</span>to_int
                 <span class="token keyword">let</span> socklen_of_int <span class="token operator">=</span> Unsigned<span class="token punctuation">.</span>UInt32<span class="token punctuation">.</span>of_int
               <span class="token keyword">end</span><span class="token punctuation">)</span>
      <span class="token operator">|</span> <span class="token number">8</span> <span class="token operator">-&gt;</span> <span class="token punctuation">(</span><span class="token keyword">module</span> <span class="token keyword">functor</span> <span class="token punctuation">(</span>S <span class="token punctuation">:</span> Cstubs<span class="token punctuation">.</span>Types<span class="token punctuation">.</span>TYPE<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token keyword">struct</span>
                 <span class="token keyword">type</span> socklen <span class="token operator">=</span> Unsigned<span class="token punctuation">.</span>uint64
                 <span class="token keyword">let</span> socklen_t <span class="token operator">=</span> S<span class="token punctuation">.</span>uint64_t
                 <span class="token keyword">let</span> int_of_socklen <span class="token operator">=</span> Unsigned<span class="token punctuation">.</span>UInt64<span class="token punctuation">.</span>to_int
                 <span class="token keyword">let</span> socklen_of_int <span class="token operator">=</span> Unsigned<span class="token punctuation">.</span>UInt64<span class="token punctuation">.</span>of_int
               <span class="token keyword">end</span><span class="token punctuation">)</span>
      <span class="token operator">|</span> <span class="token punctuation">_</span> <span class="token operator">-&gt;</span> <span class="token keyword">assert</span> <span class="token boolean">false</span>

<span class="token keyword">module</span> Socklen <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">val</span> socklen <span class="token punctuation">:</span> Socklen<span class="token punctuation">)</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">As you can see, we make use of first-order modules and the size of the <code>socklen_t</code> integer to define the right API for the compiling host. Now let’s see how we define the <code>sockaddr</code> interface:</p></div><div class="el-pre"><pre class="language-ocaml" tabindex="0"><code data-line="0" class="language-ocaml is-loaded"><span class="token keyword">module</span> <span class="token keyword">type</span> SaFamily <span class="token operator">=</span> <span class="token keyword">sig</span>
  <span class="token keyword">type</span> sa_family
  <span class="token keyword">val</span> int_of_sa_family <span class="token punctuation">:</span> sa_family <span class="token operator">-&gt;</span> int
  <span class="token keyword">val</span> sa_family_of_int <span class="token punctuation">:</span> int <span class="token operator">-&gt;</span> sa_family
  
  <span class="token keyword">module</span> T <span class="token punctuation">:</span> <span class="token keyword">functor</span> <span class="token punctuation">(</span>S <span class="token punctuation">:</span> Cstubs<span class="token punctuation">.</span>Types<span class="token punctuation">.</span>TYPE<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token keyword">sig</span>
    <span class="token keyword">val</span> t <span class="token punctuation">:</span> sa_family S<span class="token punctuation">.</span>typ
  <span class="token keyword">end</span>
<span class="token keyword">end</span>

<span class="token keyword">let</span> saFamily <span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token keyword">module</span> SaFamily<span class="token punctuation">)</span>  <span class="token operator">=</span>
    <span class="token keyword">match</span> Constants<span class="token punctuation">.</span>sa_family_len <span class="token keyword">with</span>
      <span class="token operator">|</span> <span class="token number">1</span> <span class="token operator">-&gt;</span>  <span class="token punctuation">(</span><span class="token keyword">module</span> <span class="token keyword">struct</span>
                 <span class="token keyword">type</span> sa_family <span class="token operator">=</span> Unsigned<span class="token punctuation">.</span>uint8
                 <span class="token keyword">let</span> int_of_sa_family <span class="token operator">=</span> Unsigned<span class="token punctuation">.</span>UInt8<span class="token punctuation">.</span>to_int
                 <span class="token keyword">let</span> sa_family_of_int <span class="token operator">=</span> Unsigned<span class="token punctuation">.</span>UInt8<span class="token punctuation">.</span>of_int                 
                 <span class="token keyword">module</span> T <span class="token punctuation">(</span>S <span class="token punctuation">:</span> Cstubs<span class="token punctuation">.</span>Types<span class="token punctuation">.</span>TYPE<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token keyword">struct</span>
                   <span class="token keyword">let</span> t <span class="token operator">=</span> S<span class="token punctuation">.</span>uint8_t
                 <span class="token keyword">end</span>
               <span class="token keyword">end</span><span class="token punctuation">)</span>
<span class="token operator">..</span><span class="token punctuation">.</span>

<span class="token keyword">module</span> SaFamily <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">val</span> saFamily <span class="token punctuation">:</span> SaFamily<span class="token punctuation">)</span>

<span class="token keyword">module</span> Def <span class="token punctuation">(</span>S <span class="token punctuation">:</span> Cstubs<span class="token punctuation">.</span>Types<span class="token punctuation">.</span>TYPE<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token keyword">struct</span>
  <span class="token keyword">include</span> Constants

  <span class="token keyword">include</span> Socklen<span class="token punctuation">(</span>S<span class="token punctuation">)</span>

  <span class="token keyword">include</span> SaFamily

  <span class="token keyword">module</span> SaFamilyT <span class="token operator">=</span> SaFamily<span class="token punctuation">.</span>T<span class="token punctuation">(</span>S<span class="token punctuation">)</span>

  <span class="token keyword">let</span> sa_family_t <span class="token operator">=</span> S<span class="token punctuation">.</span>typedef SaFamilyT<span class="token punctuation">.</span>t <span class="token string">"sa_family_t"</span>

  <span class="token keyword">module</span> Sockaddr <span class="token operator">=</span> <span class="token keyword">struct</span>
    <span class="token keyword">type</span> t <span class="token operator">=</span> unit
    <span class="token keyword">let</span> t <span class="token operator">=</span> S<span class="token punctuation">.</span>structure <span class="token string">"sockaddr"</span>
    <span class="token keyword">let</span> sa_family <span class="token operator">=</span> S<span class="token punctuation">.</span>field t <span class="token string">"sa_family"</span> sa_family_t
    <span class="token keyword">let</span> sa_data <span class="token operator">=</span> S<span class="token punctuation">.</span>field t <span class="token string">"sa_data"</span> <span class="token punctuation">(</span>S<span class="token punctuation">.</span>array sa_data_len S<span class="token punctuation">.</span>char<span class="token punctuation">)</span>
    <span class="token keyword">let</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> S<span class="token punctuation">.</span>seal t
  <span class="token keyword">end</span>
  
  <span class="token operator">..</span><span class="token punctuation">.</span>
<span class="token keyword">end</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">Here, too, we make use of the size of <code>sa_family</code> as exported previously to define the right structure fields.</p></div><div class="el-p"><p dir="auto">Next step, we need to compile this interface again to export the right offset for the various structures that have been defined. That’s <code>dune</code>’s job again!</p></div><div class="el-p"><p dir="auto">First, the generator code:</p></div><div class="el-pre"><pre class="language-ocaml" tabindex="0"><code data-line="0" class="language-ocaml is-loaded"><span class="token keyword">let</span> c_headers <span class="token operator">=</span> "
<span class="token directive property">#ifdef</span> _WIN32
  <span class="token directive property">#include</span> <span class="token operator">&lt;</span>winsock2<span class="token punctuation">.</span>h<span class="token operator">&gt;</span>
  <span class="token directive property">#include</span> <span class="token operator">&lt;</span>ws2tcpip<span class="token punctuation">.</span>h<span class="token operator">&gt;</span>
<span class="token directive property">#else</span>
  <span class="token directive property">#include</span> <span class="token operator">&lt;</span>sys<span class="token operator">/</span>socket<span class="token punctuation">.</span>h<span class="token operator">&gt;</span>
  <span class="token directive property">#include</span> <span class="token operator">&lt;</span>sys<span class="token operator">/</span>un<span class="token punctuation">.</span>h<span class="token operator">&gt;</span>
  <span class="token directive property">#include</span> <span class="token operator">&lt;</span>netinet<span class="token operator">/</span><span class="token keyword">in</span><span class="token punctuation">.</span>h<span class="token operator">&gt;</span>
  <span class="token directive property">#include</span> <span class="token operator">&lt;</span>netdb<span class="token punctuation">.</span>h<span class="token operator">&gt;</span>
<span class="token directive property">#endif</span>
"

<span class="token keyword">let</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span>
  <span class="token keyword">let</span> fname <span class="token operator">=</span> Sys<span class="token punctuation">.</span>argv<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">in</span>
  <span class="token keyword">let</span> oc <span class="token operator">=</span> open_out_bin fname <span class="token keyword">in</span>
  <span class="token keyword">let</span> format <span class="token operator">=</span>
    Format<span class="token punctuation">.</span>formatter_of_out_channel oc
  <span class="token keyword">in</span>
  Format<span class="token punctuation">.</span>fprintf format <span class="token string">"%s@\n"</span> c_headers<span class="token punctuation">;</span>
  Cstubs<span class="token punctuation">.</span>Types<span class="token punctuation">.</span>write_c format <span class="token punctuation">(</span><span class="token keyword">module</span> Sys_socket_types<span class="token punctuation">.</span>Def<span class="token punctuation">)</span><span class="token punctuation">;</span>
  Format<span class="token punctuation">.</span>pp_print_flush format <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  close_out oc
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">And the build instructions:</p></div><div class="el-pre"><pre class="language-dune" tabindex="0"><code data-line="0" class="language-dune is-loaded">(executable
 (name gen_types_c)
 (modules gen_types_c)
 (libraries sys-socket.types ctypes.stubs))

(rule
 (targets gen_types.c)
 (deps    (:gen ./gen_types_c.exe))
 (action  (run %{gen} %{targets})))

(rule
 (targets gen_types_c)
 (deps    (:c_code ./gen_types.c))
 (action  (run %{ocaml-config:c_compiler} -I %{lib:ctypes:} -I %{ocaml-config:standard_library} -o %{targets} %{c_code})))
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">Once, compiled, the exported <code>.ml</code> looks like this:</p></div><div class="el-pre"><pre class="language-ocaml" tabindex="0"><code data-line="0" class="language-ocaml is-loaded"><span class="token keyword">include</span> Ctypes
<span class="token keyword">let</span> lift x <span class="token operator">=</span> x
<span class="token keyword">open</span> Ctypes_static

<span class="token keyword">let</span> <span class="token keyword">rec</span> field <span class="token punctuation">:</span> <span class="token keyword">type</span> t a<span class="token punctuation">.</span> t typ <span class="token operator">-&gt;</span> string <span class="token operator">-&gt;</span> a typ <span class="token operator">-&gt;</span> <span class="token punctuation">(</span>a<span class="token punctuation">,</span> t<span class="token punctuation">)</span> field <span class="token operator">=</span>
  <span class="token keyword">fun</span> s fname ftype <span class="token operator">-&gt;</span> <span class="token keyword">match</span> s<span class="token punctuation">,</span> fname <span class="token keyword">with</span>
<span class="token operator">..</span><span class="token punctuation">.</span>
  <span class="token operator">|</span> Struct <span class="token punctuation">(</span><span class="token punctuation">{</span> tag <span class="token operator">=</span> <span class="token string">"sockaddr"</span><span class="token punctuation">}</span> <span class="token keyword">as</span> s'<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"sa_data"</span> <span class="token operator">-&gt;</span>
    <span class="token keyword">let</span> f <span class="token operator">=</span> <span class="token punctuation">{</span>ftype<span class="token punctuation">;</span> fname<span class="token punctuation">;</span> foffset <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">}</span> <span class="token keyword">in</span>
    <span class="token punctuation">(</span>s'<span class="token punctuation">.</span>fields <span class="token operator">&lt;-</span> BoxedField f <span class="token punctuation">::</span> s'<span class="token punctuation">.</span>fields<span class="token punctuation">;</span> f<span class="token punctuation">)</span>
  <span class="token operator">|</span> Struct <span class="token punctuation">(</span><span class="token punctuation">{</span> tag <span class="token operator">=</span> <span class="token string">"sockaddr"</span><span class="token punctuation">}</span> <span class="token keyword">as</span> s'<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"sa_family"</span> <span class="token operator">-&gt;</span>
    <span class="token keyword">let</span> f <span class="token operator">=</span> <span class="token punctuation">{</span>ftype<span class="token punctuation">;</span> fname<span class="token punctuation">;</span> foffset <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">}</span> <span class="token keyword">in</span>
    <span class="token punctuation">(</span>s'<span class="token punctuation">.</span>fields <span class="token operator">&lt;-</span> BoxedField f <span class="token punctuation">::</span> s'<span class="token punctuation">.</span>fields<span class="token punctuation">;</span> f<span class="token punctuation">)</span>
  <span class="token operator">|</span> View <span class="token punctuation">{</span> ty <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">_</span> <span class="token operator">-&gt;</span>
    <span class="token keyword">let</span> <span class="token punctuation">{</span> ftype<span class="token punctuation">;</span> foffset<span class="token punctuation">;</span> fname <span class="token punctuation">}</span> <span class="token operator">=</span> field ty fname ftype <span class="token keyword">in</span>
    <span class="token punctuation">{</span> ftype<span class="token punctuation">;</span> foffset<span class="token punctuation">;</span> fname <span class="token punctuation">}</span>
  <span class="token operator">|</span> <span class="token punctuation">_</span> <span class="token operator">-&gt;</span> failwith <span class="token punctuation">(</span><span class="token string">"Unexpected field "</span><span class="token operator">^</span> fname<span class="token punctuation">)</span>

<span class="token keyword">let</span> <span class="token keyword">rec</span> seal <span class="token punctuation">:</span> <span class="token keyword">type</span> a<span class="token punctuation">.</span> a typ <span class="token operator">-&gt;</span> unit <span class="token operator">=</span> <span class="token keyword">function</span>
<span class="token operator">..</span><span class="token punctuation">.</span>
  <span class="token operator">|</span> Struct <span class="token punctuation">(</span><span class="token punctuation">{</span> tag <span class="token operator">=</span> <span class="token string">"sockaddr_storage"</span><span class="token punctuation">;</span> spec <span class="token operator">=</span> Incomplete <span class="token punctuation">_</span> <span class="token punctuation">}</span> <span class="token keyword">as</span> s'<span class="token punctuation">)</span> <span class="token operator">-&gt;</span>
    s'<span class="token punctuation">.</span>spec <span class="token operator">&lt;-</span> Complete <span class="token punctuation">{</span> size <span class="token operator">=</span> <span class="token number">128</span><span class="token punctuation">;</span> align <span class="token operator">=</span> <span class="token number">8</span> <span class="token punctuation">}</span>
  <span class="token operator">|</span> Struct <span class="token punctuation">(</span><span class="token punctuation">{</span> tag <span class="token operator">=</span> <span class="token string">"sockaddr"</span><span class="token punctuation">;</span> spec <span class="token operator">=</span> Incomplete <span class="token punctuation">_</span> <span class="token punctuation">}</span> <span class="token keyword">as</span> s'<span class="token punctuation">)</span> <span class="token operator">-&gt;</span>
    s'<span class="token punctuation">.</span>spec <span class="token operator">&lt;-</span> Complete <span class="token punctuation">{</span> size <span class="token operator">=</span> <span class="token number">16</span><span class="token punctuation">;</span> align <span class="token operator">=</span> <span class="token number">1</span> <span class="token punctuation">}</span>
  <span class="token operator">|</span> Struct <span class="token punctuation">{</span> tag<span class="token punctuation">;</span> spec <span class="token operator">=</span> Complete <span class="token punctuation">_</span> <span class="token punctuation">}</span> <span class="token operator">-&gt;</span>
    raise <span class="token punctuation">(</span>ModifyingSealedType tag<span class="token punctuation">)</span>
  <span class="token operator">|</span> Union <span class="token punctuation">{</span> utag<span class="token punctuation">;</span> uspec <span class="token operator">=</span> Some <span class="token punctuation">_</span> <span class="token punctuation">}</span> <span class="token operator">-&gt;</span>
    raise <span class="token punctuation">(</span>ModifyingSealedType utag<span class="token punctuation">)</span>
  <span class="token operator">|</span> View <span class="token punctuation">{</span> ty <span class="token punctuation">}</span> <span class="token operator">-&gt;</span> seal ty
  <span class="token operator">|</span> <span class="token punctuation">_</span> <span class="token operator">-&gt;</span>
    raise <span class="token punctuation">(</span>Unsupported <span class="token string">"Sealing a non-structured type"</span><span class="token punctuation">)</span>

<span class="token keyword">type</span> <span class="token type-variable function">'a</span> const <span class="token operator">=</span> <span class="token type-variable function">'a</span>
<span class="token keyword">let</span> constant <span class="token punctuation">(</span><span class="token keyword">type</span> t<span class="token punctuation">)</span> name <span class="token punctuation">(</span>t <span class="token punctuation">:</span> t typ<span class="token punctuation">)</span> <span class="token punctuation">:</span> t <span class="token operator">=</span> <span class="token keyword">match</span> t<span class="token punctuation">,</span> name <span class="token keyword">with</span>
  <span class="token operator">|</span> <span class="token punctuation">_</span><span class="token punctuation">,</span> s <span class="token operator">-&gt;</span> failwith <span class="token punctuation">(</span><span class="token string">"unmatched constant: "</span><span class="token operator">^</span> s<span class="token punctuation">)</span>

<span class="token keyword">let</span> enum <span class="token punctuation">(</span><span class="token keyword">type</span> a<span class="token punctuation">)</span> name <span class="token operator">?</span>typedef <span class="token operator">?</span>unexpected <span class="token punctuation">(</span>alist <span class="token punctuation">:</span> <span class="token punctuation">(</span>a <span class="token operator">*</span> int64<span class="token punctuation">)</span> list<span class="token punctuation">)</span> <span class="token operator">=</span>
  <span class="token keyword">match</span> name <span class="token keyword">with</span>
  <span class="token operator">|</span> s <span class="token operator">-&gt;</span>
    failwith <span class="token punctuation">(</span><span class="token string">"unmatched enum: "</span><span class="token operator">^</span> s<span class="token punctuation">)</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">As you can see, this exports all the offsets required to access the fields inside a <code>sockaddr_t</code> structure. We’re now ready to move to the final stage, which is the actual binding stubs!</p></div></div></div><div class="el-h2 heading-wrapper"><h2 data-heading="Binding stubs" dir="auto" class="heading" id="Binding_stubs"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>Binding stubs</h2><div class="heading-children"><div class="el-p"><p dir="auto">First step in this pass, just like with the previous ones, we need to configure <code>dune</code> to be able to build the exported <code>.ml</code> code from the <code>types</code> pass:</p></div><div class="el-pre"><pre class="language-dune" tabindex="0"><code data-line="0" class="language-dune is-loaded">(rule
 (targets sys_socket_generated_types.ml)
 (deps    (:exec ../generator/exec.sh)
          (:gen ../generator/gen_types_c))
 (action  (with-stdout-to %{targets}
            (system "%{exec} %{ocaml-config:system} %{gen}"))))
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">And we can now define the proper bindings. Here’s how it looks like:</p></div><div class="el-pre"><pre class="language-ocaml" tabindex="0"><code data-line="0" class="language-ocaml is-loaded"><span class="token keyword">open</span> Ctypes

<span class="token keyword">module</span> Def <span class="token punctuation">(</span>F <span class="token punctuation">:</span> Cstubs<span class="token punctuation">.</span>FOREIGN<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token keyword">struct</span>
  <span class="token keyword">open</span> F

  <span class="token keyword">module</span> Types <span class="token operator">=</span> Sys_socket_types<span class="token punctuation">.</span>Def<span class="token punctuation">(</span>Sys_socket_generated_types<span class="token punctuation">)</span>

  <span class="token keyword">open</span> Types

  <span class="token keyword">let</span> getnameinfo <span class="token operator">=</span> foreign <span class="token string">"getnameinfo"</span> <span class="token punctuation">(</span>ptr sockaddr_t <span class="token operator">@-&gt;</span> socklen_t <span class="token operator">@-&gt;</span> ptr char <span class="token operator">@-&gt;</span> socklen_t <span class="token operator">@-&gt;</span> ptr char <span class="token operator">@-&gt;</span> socklen_t <span class="token operator">@-&gt;</span> int <span class="token operator">@-&gt;</span> <span class="token punctuation">(</span>returning int<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token operator">..</span><span class="token punctuation">.</span>
<span class="token keyword">end</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">As you can see, we’re exporting the <code>getnameinfo</code> function, taking various arguments, including a pointer to a <code>sockaddr_t</code> structure and a couple of <code>socklen_t</code> integers, making use of all the various data types and structures previously defined. The exact specifications of this function can be found <a data-tooltip-position="top" aria-label="https://pubs.opengroup.org/onlinepubs/009695399/functions/getnameinfo.html" rel="noopener nofollow" class="external-link" href="https://pubs.opengroup.org/onlinepubs/009695399/functions/getnameinfo.html" target="_blank">here</a>. We can now define out top-level API..</p></div></div></div><div class="el-h2 heading-wrapper"><h2 data-heading="Final API" dir="auto" class="heading" id="Final_API"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>Final API</h2><div class="heading-children"><div class="el-p"><p dir="auto">Building upon the previous modules, we export various OCaml idiomatic APIs that the binding user can now use to build new bindings against the <code>socket.h</code> APIs.</p></div><div class="el-p"><p dir="auto">Just like with the previous steps, first we need to configure the build system:</p></div><div class="el-pre"><pre class="language-dune" tabindex="0"><code data-line="0" class="language-dune is-loaded">(rule
 (targets sys_socket_generated_stubs.ml)
 (deps    (:gen ./generator/gen_stubs.exe))
 (action  (run %{gen} ml %{targets})))

(rule
 (targets sys_socket_generated_stubs.c)
 (deps    (:gen ./generator/gen_stubs.exe))
 (action  (run %{gen} c %{targets})))
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">This time, we need <code>ocaml-ctypes</code> to generate two compilation units: a <code>.ml</code> file describing the API exported during the <code>stubs</code> phase, as well as the C code to glue it with the C APIs. Here’s the code for that generator:</p></div><div class="el-pre"><pre class="language-ocaml" tabindex="0"><code data-line="0" class="language-ocaml is-loaded"><span class="token keyword">let</span> c_headers <span class="token operator">=</span> "
<span class="token directive property">#ifdef</span> _WIN32
  <span class="token directive property">#include</span> <span class="token operator">&lt;</span>winsock2<span class="token punctuation">.</span>h<span class="token operator">&gt;</span>
  <span class="token directive property">#include</span> <span class="token operator">&lt;</span>ws2tcpip<span class="token punctuation">.</span>h<span class="token operator">&gt;</span>
<span class="token directive property">#else</span>
  <span class="token directive property">#include</span> <span class="token operator">&lt;</span>sys<span class="token operator">/</span>socket<span class="token punctuation">.</span>h<span class="token operator">&gt;</span>
  <span class="token directive property">#include</span> <span class="token operator">&lt;</span>netinet<span class="token operator">/</span><span class="token keyword">in</span><span class="token punctuation">.</span>h<span class="token operator">&gt;</span>
  <span class="token directive property">#include</span> <span class="token operator">&lt;</span>arpa<span class="token operator">/</span>inet<span class="token punctuation">.</span>h<span class="token operator">&gt;</span>
  <span class="token directive property">#include</span> <span class="token operator">&lt;</span>netdb<span class="token punctuation">.</span>h<span class="token operator">&gt;</span>
<span class="token directive property">#endif</span>
<span class="token directive property">#include</span> <span class="token operator">&lt;</span>string<span class="token punctuation">.</span>h<span class="token operator">&gt;</span>
"

<span class="token keyword">let</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span>
  <span class="token keyword">let</span> mode <span class="token operator">=</span> Sys<span class="token punctuation">.</span>argv<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">in</span>
  <span class="token keyword">let</span> fname <span class="token operator">=</span> Sys<span class="token punctuation">.</span>argv<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">in</span>
  <span class="token keyword">let</span> oc <span class="token operator">=</span> open_out_bin fname <span class="token keyword">in</span>
  <span class="token keyword">let</span> format <span class="token operator">=</span>
    Format<span class="token punctuation">.</span>formatter_of_out_channel oc
  <span class="token keyword">in</span>
  <span class="token keyword">let</span> fn <span class="token operator">=</span>
    <span class="token keyword">match</span> mode <span class="token keyword">with</span>
      <span class="token operator">|</span> <span class="token string">"ml"</span> <span class="token operator">-&gt;</span> Cstubs<span class="token punctuation">.</span>write_ml
      <span class="token operator">|</span> <span class="token string">"c"</span>  <span class="token operator">-&gt;</span>
         Format<span class="token punctuation">.</span>fprintf format <span class="token string">"%s@\n"</span> c_headers<span class="token punctuation">;</span>
         Cstubs<span class="token punctuation">.</span>write_c
      <span class="token operator">|</span> <span class="token punctuation">_</span>    <span class="token operator">-&gt;</span> <span class="token keyword">assert</span> <span class="token boolean">false</span>
  <span class="token keyword">in</span>
  fn <span class="token label property">~concurrency</span><span class="token punctuation">:</span>Cstubs<span class="token punctuation">.</span>unlocked format <span class="token label property">~prefix</span><span class="token punctuation">:</span><span class="token string">"sys_socket"</span> <span class="token punctuation">(</span><span class="token keyword">module</span> Sys_socket_stubs<span class="token punctuation">.</span>Def<span class="token punctuation">)</span><span class="token punctuation">;</span>
  Format<span class="token punctuation">.</span>pp_print_flush format <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  close_out oc
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">The exported <code>.ml</code> and <code>.c</code> files are omitted here for simplicity but the reader can generated them themselves from the <code>[ocaml-sys-socket](https://github.com/toots/ocaml-sys-socket)</code> repository if they are curious about their actual content.</p></div><div class="el-p"><p dir="auto">We can now export our top-level API:</p></div><div class="el-pre"><pre class="language-ocaml" tabindex="0"><code data-line="0" class="language-ocaml is-loaded"><span class="token keyword">open</span> Ctypes

<span class="token keyword">include</span> Sys_socket_types<span class="token punctuation">.</span>SaFamily

<span class="token keyword">include</span> Sys_socket_stubs<span class="token punctuation">.</span>Def<span class="token punctuation">(</span>Sys_socket_generated_stubs<span class="token punctuation">)</span>

<span class="token keyword">type</span> socklen <span class="token operator">=</span> Types<span class="token punctuation">.</span>socklen
<span class="token keyword">let</span> socklen_t <span class="token operator">=</span> Types<span class="token punctuation">.</span>socklen_t
<span class="token keyword">let</span> int_of_socklen <span class="token operator">=</span> Types<span class="token punctuation">.</span>int_of_socklen
<span class="token keyword">let</span> socklen_of_int <span class="token operator">=</span> Types<span class="token punctuation">.</span>socklen_of_int

<span class="token keyword">module</span> Sockaddr <span class="token operator">=</span> <span class="token keyword">struct</span>
  <span class="token keyword">include</span> Types<span class="token punctuation">.</span>Sockaddr
  <span class="token keyword">let</span> from_sockaddr_storage <span class="token operator">=</span> from_sockaddr_storage t
  <span class="token keyword">let</span> sa_data_len <span class="token operator">=</span> Types<span class="token punctuation">.</span>sa_data_len
<span class="token keyword">end</span>

<span class="token keyword">let</span> getnameinfo sockaddr_ptr <span class="token operator">=</span>
  <span class="token keyword">let</span> maxhost <span class="token operator">=</span> Types<span class="token punctuation">.</span>ni_maxhost <span class="token keyword">in</span>
  <span class="token keyword">let</span> s <span class="token operator">=</span> allocate_n char <span class="token label property">~count</span><span class="token punctuation">:</span>maxhost <span class="token keyword">in</span>
  <span class="token keyword">let</span> maxserv <span class="token operator">=</span> Types<span class="token punctuation">.</span>ni_maxserv <span class="token keyword">in</span>
  <span class="token keyword">let</span> p <span class="token operator">=</span> allocate_n char <span class="token label property">~count</span><span class="token punctuation">:</span>maxserv <span class="token keyword">in</span>
  <span class="token keyword">match</span> getnameinfo sockaddr_ptr <span class="token punctuation">(</span>socklen_of_int <span class="token punctuation">(</span>sizeof sockaddr_t<span class="token punctuation">)</span><span class="token punctuation">)</span>
                    s <span class="token punctuation">(</span>socklen_of_int maxhost<span class="token punctuation">)</span> 
                    p <span class="token punctuation">(</span>socklen_of_int maxserv<span class="token punctuation">)</span>
                    <span class="token punctuation">(</span>Types<span class="token punctuation">.</span>ni_numerichost <span class="token operator">lor</span>
                     Types<span class="token punctuation">.</span>ni_numericserv<span class="token punctuation">)</span>  <span class="token keyword">with</span>
    <span class="token operator">|</span> <span class="token number">0</span> <span class="token operator">-&gt;</span>
      <span class="token keyword">let</span> host <span class="token operator">=</span>
        <span class="token keyword">let</span> length <span class="token operator">=</span>
          Unsigned<span class="token punctuation">.</span>Size_t<span class="token punctuation">.</span>to_int
            <span class="token punctuation">(</span>strnlen s <span class="token punctuation">(</span>Unsigned<span class="token punctuation">.</span>Size_t<span class="token punctuation">.</span>of_int maxhost<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">in</span>
        string_from_ptr s <span class="token label property">~length</span>
      <span class="token keyword">in</span>
      <span class="token keyword">let</span> port <span class="token operator">=</span>
        <span class="token keyword">let</span> length <span class="token operator">=</span>
          Unsigned<span class="token punctuation">.</span>Size_t<span class="token punctuation">.</span>to_int
            <span class="token punctuation">(</span>strnlen p <span class="token punctuation">(</span>Unsigned<span class="token punctuation">.</span>Size_t<span class="token punctuation">.</span>of_int maxserv<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">in</span>
        <span class="token keyword">let</span> port <span class="token operator">=</span>
          string_from_ptr p <span class="token label property">~length</span>
        <span class="token keyword">in</span>
        <span class="token keyword">try</span>
          int_of_string port
        <span class="token keyword">with</span> <span class="token punctuation">_</span> <span class="token operator">-&gt;</span>
          <span class="token keyword">match</span> getservbyname p null <span class="token keyword">with</span>
            <span class="token operator">|</span> ptr <span class="token keyword">when</span> is_null ptr <span class="token operator">-&gt;</span> failwith <span class="token string">"getnameinfo"</span>
            <span class="token operator">|</span> ptr <span class="token operator">-&gt;</span>
               Unsigned<span class="token punctuation">.</span>UInt16<span class="token punctuation">.</span>to_int
                 <span class="token punctuation">(</span>ntohs <span class="token punctuation">(</span><span class="token operator">!@</span> <span class="token punctuation">(</span>ptr <span class="token operator">|-&gt;</span> Types<span class="token punctuation">.</span>Servent<span class="token punctuation">.</span>s_port<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token keyword">in</span>
      host<span class="token punctuation">,</span> port
    <span class="token operator">|</span> <span class="token punctuation">_</span> <span class="token operator">-&gt;</span> failwith <span class="token string">"getnameinfo"</span>

<span class="token operator">..</span><span class="token punctuation">.</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-pre"><pre class="language-ocaml" tabindex="0"><code data-line="0" class="language-ocaml is-loaded"><span class="token keyword">open</span> Ctypes

<span class="token comment">(** Ctypes routines for C type socklen_t. *)</span>
<span class="token keyword">type</span> socklen
<span class="token keyword">val</span> socklen_t <span class="token punctuation">:</span> socklen typ
<span class="token keyword">val</span> int_of_socklen <span class="token punctuation">:</span> socklen <span class="token operator">-&gt;</span> int
<span class="token keyword">val</span> socklen_of_int <span class="token punctuation">:</span> int <span class="token operator">-&gt;</span> socklen

<span class="token comment">(** Generic sockaddr_t structure. *)</span>
<span class="token keyword">module</span> Sockaddr <span class="token punctuation">:</span> <span class="token keyword">sig</span>
  <span class="token keyword">type</span> t
  <span class="token keyword">val</span> t <span class="token punctuation">:</span> t structure typ
  <span class="token keyword">val</span> sa_family <span class="token punctuation">:</span> <span class="token punctuation">(</span>sa_family<span class="token punctuation">,</span> t structure<span class="token punctuation">)</span> field
  <span class="token keyword">val</span> sa_data <span class="token punctuation">:</span> <span class="token punctuation">(</span>char carray<span class="token punctuation">,</span> t structure<span class="token punctuation">)</span> field
  <span class="token keyword">val</span> sa_data_len  <span class="token punctuation">:</span> int

  <span class="token keyword">val</span> from_sockaddr_storage <span class="token punctuation">:</span> SockaddrStorage<span class="token punctuation">.</span>t structure ptr <span class="token operator">-&gt;</span> t structure ptr
<span class="token keyword">end</span>

<span class="token comment">(** IP address conversion functions. *)</span>
<span class="token keyword">val</span> getnameinfo <span class="token punctuation">:</span> sockaddr ptr <span class="token operator">-&gt;</span> string <span class="token operator">*</span> int

<span class="token operator">..</span><span class="token punctuation">.</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">That’s it! We now have <code>ocaml-ctypes</code> specific data types and structures that can be used to interface with the host’s native <code>socket.h</code> APIs. Note that we also worked on top of the original low-level binding to <code>getnameinfo</code> to export a higher-level function more idiomatic to the OCaml language.</p></div></div></div></div></div><div class="el-h1 heading-wrapper"><h1 data-heading="Lagniappe: cross-compilation to Windows" dir="auto" class="heading" id="Lagniappe:_cross-compilation_to_Windows">Lagniappe: cross-compilation to Windows</h1><div class="heading-children"><div class="el-p"><p dir="auto">On windows platforms, <code>liquidsoap</code> is compiled using <code>[ocaml-cross-windows](https://github.com/ocaml-cross/opam-cross-windows)</code> and, since windows does have compatible socket APIs, we wanted to also look at cross-compiling for the windows target, which is where we hit a snag on the current <code>dune</code> support.</p></div><div class="el-p"><p dir="auto">The problem is that, at each intermediary steps, in the case of a cross-compilation, the compiled binaries need to use the target’s OS headers and not the host’s headers, otherwise we end up using offsets specific to e.g. Debian but for a windows binary.</p></div><div class="el-p"><p dir="auto">In this case, this means that the compiled <code>.exe</code> binaries need to be windows binaries and that we need to execute them as windows native binaries, using <code>[wine](https://www.winehq.org/)</code> .</p></div><div class="el-p"><p dir="auto"><code>dune</code> has a truly amazing <a data-tooltip-position="top" aria-label="https://dune.readthedocs.io/en/latest/cross-compilation.html" rel="noopener nofollow" class="external-link" href="https://dune.readthedocs.io/en/latest/cross-compilation.html" target="_blank">support for cross-compiling</a>, which we do not cover here, but, unfortunately, its primitives for building and executing binaries do not yet cover this use case. Thus we had to trick it into compiling things the way we wanted to do, which why we are using the <code>exec.sh</code> wrapper. Here’s its code:</p></div><div class="el-pre"><pre class="language-sh" tabindex="0"><code data-line="0" class="language-sh is-loaded"><span class="token shebang important">#!/bin/sh</span>

<span class="token assign-left variable">SYSTEM</span><span class="token operator">=</span><span class="token variable">$1</span>
<span class="token assign-left variable">CMD</span><span class="token operator">=</span><span class="token variable">$2</span>
<span class="token assign-left variable">ARG</span><span class="token operator">=</span><span class="token variable">$3</span>

<span class="token keyword">if</span> <span class="token builtin class-name">test</span> <span class="token string">"<span class="token variable">${SYSTEM}</span>"</span> <span class="token operator">=</span> <span class="token string">"mingw"</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
  wine <span class="token variable">$CMD</span> <span class="token variable">$ARG</span>
<span class="token keyword">elif</span> <span class="token builtin class-name">test</span> <span class="token string">"<span class="token variable">${SYSTEM}</span>"</span> <span class="token operator">=</span> <span class="token string">"mingw64"</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
  wine64 <span class="token variable">$CMD</span> <span class="token variable">$ARG</span>
<span class="token keyword">else</span>
  <span class="token variable">$CMD</span> <span class="token variable">$ARG</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">Now, you can go back to the previous <code>dune</code> files and see how this wrapper allows to execute binaries according to the system that the corresponding <code>ocamlopt</code> compiler has been configured to build for.</p></div></div></div><div class="el-h1 heading-wrapper"><h1 data-heading="Conclusion" dir="auto" class="heading" id="Conclusion">Conclusion</h1><div class="heading-children"><div class="el-p"><p dir="auto">It’s been a fun time working on this binding! It’s amazing to see the level of details that can be built through <code>ocaml-ctypes</code> using their provided primitives. Ultimately, the binding is very clean and elegant, with very few low-level assumptions.</p></div><div class="el-p"><p dir="auto">Likewise, the simplicity and power of the <code>dune</code> build system makes this very fluid to build. Without it, each of the described steps above would have been much more painful to execute and compile.</p></div><div class="el-p"><p dir="auto">[1]: My bet is that, at the time the POSIX specifications were being written, there we already several inconsistent <code>socket.h</code> headers out in the wild among the various historical UNIX flavors..</p></div><div class="mod-footer mod-ui"></div></div></div></div></div></div><div class="sidebar-right sidebar"><div class="sidebar-handle"></div><div class="sidebar-topbar"><div class="topbar-content"></div><div class="clickable-icon sidebar-collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" class="svg-icon"><path d="M21 3H3C1.89543 3 1 3.89543 1 5V19C1 20.1046 1.89543 21 3 21H21C22.1046 21 23 20.1046 23 19V5C23 3.89543 22.1046 3 21 3Z"></path><path d="M10 4V20"></path><path d="M4 7H7"></path><path d="M4 10H7"></path><path d="M4 13H7"></path></svg></div></div><div class="sidebar-content"><div class="graph-view-wrapper"><div class="sidebar-section-header">Interactive Graph</div><div class="graph-view-placeholder">
		<div class="graph-view-container">
			<div class="graph-icon graph-expand" role="button" aria-label="Expand" data-tooltip-position="top"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon"><line x1="7" y1="17" x2="17" y2="7"></line><polyline points="7 7 17 7 17 17"></polyline></svg></div>
			<canvas id="graph-canvas" class="hide" width="512px" height="512px"></canvas>
		</div>
		</div></div><div class="tree-container mod-root nav-folder tree-item outline-tree" data-depth="0"><div class="tree-header"><span class="sidebar-section-header">Table Of Contents</span><button class="clickable-icon collapse-tree-button" aria-label="Collapse All"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></svg></button></div><div class="tree-scroll-area tree-item-children nav-folder-children"><div class="tree-item mod-tree-folder nav-folder mod-collapsible is-collapsed" style="display: none;"></div><div class="tree-item" data-depth="1"><a class="tree-link" href="computer-science/programming-language/ocaml/advanced-c-binding-using-ocaml-ctypes-and-dune.html#Advanced C binding using ocaml-ctypes and dune"><div class="tree-item-contents heading-link" heading-name="Advanced C binding using ocaml-ctypes and dune"><span class="tree-item-title">Advanced C binding using ocaml-ctypes and dune</span></div></a><div class="tree-item-children nav-folder-children"></div></div><div class="tree-item" data-depth="1"><a class="tree-link" href="computer-science/programming-language/ocaml/advanced-c-binding-using-ocaml-ctypes-and-dune.html#ocaml-ctypes"><div class="tree-item-contents heading-link" heading-name="ocaml-ctypes"><span class="tree-item-title">ocaml-ctypes</span></div></a><div class="tree-item-children nav-folder-children"></div></div><div class="tree-item" data-depth="1"><a class="tree-link" href="computer-science/programming-language/ocaml/advanced-c-binding-using-ocaml-ctypes-and-dune.html#dune"><div class="tree-item-contents heading-link" heading-name="dune"><span class="tree-item-title">dune</span></div></a><div class="tree-item-children nav-folder-children"></div></div><div class="tree-item" data-depth="1"><a class="tree-link" href="computer-science/programming-language/ocaml/advanced-c-binding-using-ocaml-ctypes-and-dune.html#socket.h"><div class="tree-item-contents heading-link" heading-name="socket.h"><span class="tree-item-title">socket.h</span></div></a><div class="tree-item-children nav-folder-children"></div></div><div class="tree-item" data-depth="1"><a class="tree-link" href="computer-science/programming-language/ocaml/advanced-c-binding-using-ocaml-ctypes-and-dune.html#Putting_it_together"><div class="tree-item-contents heading-link" heading-name="Putting it together"><span class="tree-item-title">Putting it together</span></div></a><div class="tree-item-children nav-folder-children"><div class="tree-item" data-depth="2"><a class="tree-link" href="computer-science/programming-language/ocaml/advanced-c-binding-using-ocaml-ctypes-and-dune.html#Constants_pass"><div class="tree-item-contents heading-link" heading-name="Constants pass"><span class="tree-item-title">Constants pass</span></div></a><div class="tree-item-children nav-folder-children"></div></div><div class="tree-item" data-depth="2"><a class="tree-link" href="computer-science/programming-language/ocaml/advanced-c-binding-using-ocaml-ctypes-and-dune.html#Types_pass"><div class="tree-item-contents heading-link" heading-name="Types pass"><span class="tree-item-title">Types pass</span></div></a><div class="tree-item-children nav-folder-children"></div></div><div class="tree-item" data-depth="2"><a class="tree-link" href="computer-science/programming-language/ocaml/advanced-c-binding-using-ocaml-ctypes-and-dune.html#Binding_stubs"><div class="tree-item-contents heading-link" heading-name="Binding stubs"><span class="tree-item-title">Binding stubs</span></div></a><div class="tree-item-children nav-folder-children"></div></div><div class="tree-item" data-depth="2"><a class="tree-link" href="computer-science/programming-language/ocaml/advanced-c-binding-using-ocaml-ctypes-and-dune.html#Final_API"><div class="tree-item-contents heading-link" heading-name="Final API"><span class="tree-item-title">Final API</span></div></a><div class="tree-item-children nav-folder-children"></div></div></div></div><div class="tree-item" data-depth="1"><a class="tree-link" href="computer-science/programming-language/ocaml/advanced-c-binding-using-ocaml-ctypes-and-dune.html#Lagniappe:_cross-compilation_to_Windows"><div class="tree-item-contents heading-link" heading-name="Lagniappe: cross-compilation to Windows"><span class="tree-item-title">Lagniappe: cross-compilation to Windows</span></div></a><div class="tree-item-children nav-folder-children"></div></div><div class="tree-item" data-depth="1"><a class="tree-link" href="computer-science/programming-language/ocaml/advanced-c-binding-using-ocaml-ctypes-and-dune.html#Conclusion"><div class="tree-item-contents heading-link" heading-name="Conclusion"><span class="tree-item-title">Conclusion</span></div></a><div class="tree-item-children nav-folder-children"></div></div></div></div></div><script defer="">let rs = document.querySelector(".sidebar-right"); rs.classList.add("is-collapsed"); if (window.innerWidth > 768) rs.classList.remove("is-collapsed"); rs.style.setProperty("--sidebar-width", localStorage.getItem("sidebar-right-width"));</script></div></div></body></html>