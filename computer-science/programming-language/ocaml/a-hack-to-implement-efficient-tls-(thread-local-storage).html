<!DOCTYPE html> <html><head>
		<title>A hack to implement efficient TLS (thread-local-storage)</title>
		<base href="../../../">
		<meta id="root-path" root-path="../../../">
		<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes, minimum-scale=1.0, maximum-scale=5.0">
		<meta charset="UTF-8">
		<meta name="description" content="韩暮秋的个人维基 - A hack to implement efficient TLS (thread-local-storage)">
		<meta property="og:title" content="A hack to implement efficient TLS (thread-local-storage)">
		<meta property="og:description" content="韩暮秋的个人维基 - A hack to implement efficient TLS (thread-local-storage)">
		<meta property="og:type" content="website">
		<meta property="og:url" content="https://muqiuhan.github.io/wiki/computer-science/programming-language/ocaml/a-hack-to-implement-efficient-tls-(thread-local-storage).html">
		<meta property="og:image" content="undefined">
		<meta property="og:site_name" content="韩暮秋的个人维基">
		<meta name="author" content="韩暮秋"><script async="" id="webpage-script" src="lib/scripts/webpage.js" onload="this.onload=null;this.setAttribute(&quot;loaded&quot;, &quot;true&quot;)"></script><script type="module" async="" id="graph-view-script" src="lib/scripts/graph-view.js"></script><script async="" id="graph-wasm-script" src="lib/scripts/graph-wasm.js" onload="this.onload=null;this.setAttribute(&quot;loaded&quot;, &quot;true&quot;)"></script><script async="" id="graph-render-worker-script" src="lib/scripts/graph-render-worker.js" onload="this.onload=null;this.setAttribute(&quot;loaded&quot;, &quot;true&quot;)"></script><script async="" id="tinycolor-script" src="lib/scripts/tinycolor.js" onload="this.onload=null;this.setAttribute(&quot;loaded&quot;, &quot;true&quot;)"></script><script async="" id="pixi-script" src="lib/scripts/pixi.js" onload="this.onload=null;this.setAttribute(&quot;loaded&quot;, &quot;true&quot;)"></script><script async="" id="minisearch-script" src="lib/scripts/minisearch.js" onload="this.onload=null;this.setAttribute(&quot;loaded&quot;, &quot;true&quot;)"></script><link rel="icon" href="lib/media/favicon.jpg"><script async="" id="graph-data-script" src="lib/scripts/graph-data.js" onload="this.onload=null;this.setAttribute(&quot;loaded&quot;, &quot;true&quot;)"></script><style>body{--line-width:40em;--line-width-adaptive:40em;--file-line-width:40em;--sidebar-width:min(20em, 80vw);--collapse-arrow-size:11px;--tree-horizontal-spacing:0.6em;--tree-vertical-spacing:0.6em;--sidebar-margin:12px}.sidebar{height:100%;min-width:calc(var(--sidebar-width) + var(--divider-width-hover));max-width:calc(var(--sidebar-width) + var(--divider-width-hover));font-size:14px;z-index:10;position:relative;overflow:hidden;transition:min-width ease-in-out,max-width ease-in-out;transition-duration:.2s;contain:size}.sidebar-left{left:0}.sidebar-right{right:0}.sidebar.is-collapsed{min-width:0;max-width:0}body.floating-sidebars .sidebar{position:absolute}.sidebar-content{height:100%;min-width:calc(var(--sidebar-width) - var(--divider-width-hover));top:0;padding:var(--sidebar-margin);padding-top:4em;line-height:var(--line-height-tight);background-color:var(--background-secondary);transition:background-color,border-right,border-left,box-shadow;transition-duration:var(--color-fade-speed);transition-timing-function:ease-in-out;position:absolute;display:flex;flex-direction:column}.sidebar:not(.is-collapsed) .sidebar-content{min-width:calc(max(100%,var(--sidebar-width)) - 3px);max-width:calc(max(100%,var(--sidebar-width)) - 3px)}.sidebar-left .sidebar-content{left:0;border-top-right-radius:var(--radius-l);border-bottom-right-radius:var(--radius-l)}.sidebar-right .sidebar-content{right:0;border-top-left-radius:var(--radius-l);border-bottom-left-radius:var(--radius-l)}.sidebar:has(.sidebar-content:empty):has(.topbar-content:empty){display:none}.sidebar-topbar{height:2em;width:var(--sidebar-width);top:var(--sidebar-margin);padding-inline:var(--sidebar-margin);z-index:1;position:fixed;display:flex;align-items:center;transition:width ease-in-out;transition-duration:inherit}.sidebar.is-collapsed .sidebar-topbar{width:calc(2.3em + var(--sidebar-margin) * 2)}.sidebar .sidebar-topbar.is-collapsed{width:0}.sidebar-left .sidebar-topbar{left:0}.sidebar-right .sidebar-topbar{right:0}.topbar-content{overflow:hidden;overflow:clip;width:100%;height:100%;display:flex;align-items:center;transition:inherit}.sidebar.is-collapsed .topbar-content{width:0;transition:inherit}.clickable-icon.sidebar-collapse-icon{background-color:transparent;color:var(--icon-color-focused);padding:0!important;margin:0!important;height:100%!important;width:2.3em!important;margin-inline:0.14em!important;position:absolute}.sidebar-left .clickable-icon.sidebar-collapse-icon{transform:rotateY(180deg);right:var(--sidebar-margin)}.sidebar-right .clickable-icon.sidebar-collapse-icon{transform:rotateY(180deg);left:var(--sidebar-margin)}.clickable-icon.sidebar-collapse-icon svg.svg-icon{width:100%;height:100%}.sidebar-section-header{margin:0 0 1em 0;text-transform:uppercase;letter-spacing:.06em;font-weight:600}body{transition:background-color var(--color-fade-speed) ease-in-out}.webpage-container{display:flex;flex-direction:row;height:100%;width:100%;align-items:stretch;justify-content:center}.document-container{opacity:1;flex-basis:100%;max-width:100%;width:100%;height:100%;display:flex;flex-direction:column;align-items:center;transition:opacity .2s ease-in-out;contain:inline-size}.hide{opacity:0;transition:opacity .2s ease-in-out}.document-container>.markdown-preview-view{margin:var(--sidebar-margin);margin-bottom:0;width:100%;width:-webkit-fill-available;width:-moz-available;width:fill-available;background-color:var(--background-primary);transition:background-color var(--color-fade-speed) ease-in-out;border-top-right-radius:var(--window-radius,var(--radius-m));border-top-left-radius:var(--window-radius,var(--radius-m));overflow-x:hidden!important;overflow-y:auto!important;display:flex!important;flex-direction:column!important;align-items:center!important;contain:inline-size}.document-container>.markdown-preview-view>.markdown-preview-sizer{padding-bottom:80vh!important;width:100%!important;max-width:var(--line-width)!important;flex-basis:var(--line-width)!important;transition:background-color var(--color-fade-speed) ease-in-out;contain:inline-size}.markdown-rendered img:not([width]),.view-content img:not([width]){max-width:100%;outline:0}.document-container>.view-content.embed{display:flex;padding:1em;height:100%;width:100%;align-items:center;justify-content:center}.document-container>.view-content.embed>*{max-width:100%;max-height:100%;object-fit:contain}:has(> :is(.math,table)){overflow-x:auto!important}.document-container>.view-content{overflow-x:auto;contain:content;padding:0;margin:0;height:100%}.scroll-highlight{position:absolute;width:100%;height:100%;pointer-events:none;z-index:1000;background-color:hsla(var(--color-accent-hsl),.25);opacity:0;padding:1em;inset:50%;translate:-50% -50%;border-radius:var(--radius-s)}</style><script defer="">async function loadIncludes(){if("file:"!=location.protocol){let e=document.querySelectorAll("include");for(let t=0;t<e.length;t++){let o=e[t],l=o.getAttribute("src");try{const e=await fetch(l);if(!e.ok){console.log("Could not include file: "+l),o?.remove();continue}let t=await e.text(),n=document.createRange().createContextualFragment(t),i=Array.from(n.children);for(let e of i)e.classList.add("hide"),e.style.transition="opacity 0.5s ease-in-out",setTimeout((()=>{e.classList.remove("hide")}),10);o.before(n),o.remove(),console.log("Included file: "+l)}catch(e){o?.remove(),console.log("Could not include file: "+l,e);continue}}}else{if(document.querySelectorAll("include").length>0){var e=document.createElement("div");e.id="error",e.textContent="Web server exports must be hosted on an http / web server to be viewed correctly.",e.style.position="fixed",e.style.top="50%",e.style.left="50%",e.style.transform="translate(-50%, -50%)",e.style.fontSize="1.5em",e.style.fontWeight="bold",e.style.textAlign="center",document.body.appendChild(e),document.querySelector(".document-container")?.classList.remove("hide")}}}document.addEventListener("DOMContentLoaded",(()=>{loadIncludes()}));let isFileProtocol="file:"==location.protocol;function waitLoadScripts(e,t){let o=e.map((e=>document.getElementById(e+"-script"))),l=0;!function e(){let n=o[l];l++,n&&"true"!=n.getAttribute("loaded")||l<o.length&&e(),l<o.length?n.addEventListener("load",e):t()}()}</script><link rel="stylesheet" href="lib/styles/obsidian.css"><link rel="preload" href="lib/styles/other-plugins.css" as="style" onload="this.onload=null;this.rel='stylesheet'"><noscript><link rel="stylesheet" href="lib/styles/other-plugins.css"></noscript><link rel="stylesheet" href="lib/styles/theme.css"><link rel="preload" href="lib/styles/global-variable-styles.css" as="style" onload="this.onload=null;this.rel='stylesheet'"><noscript><link rel="stylesheet" href="lib/styles/global-variable-styles.css"></noscript><link rel="preload" href="lib/styles/supported-plugins.css" as="style" onload="this.onload=null;this.rel='stylesheet'"><noscript><link rel="stylesheet" href="lib/styles/supported-plugins.css"></noscript><link rel="preload" href="lib/styles/main-styles.css" as="style" onload="this.onload=null;this.rel='stylesheet'"><noscript><link rel="stylesheet" href="lib/styles/main-styles.css"></noscript></head><body class="publish css-settings-manager theme-dark show-inline-title show-ribbon oled-black lst-fab-b2-1 is-css-guide list-d-c-d lst-fm-compact lst-prop-super-compact"><script defer="">let theme=localStorage.getItem("theme")||(window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light");"dark"==theme?(document.body.classList.add("theme-dark"),document.body.classList.remove("theme-light")):(document.body.classList.add("theme-light"),document.body.classList.remove("theme-dark")),window.innerWidth<480?document.body.classList.add("is-phone"):window.innerWidth<768?document.body.classList.add("is-tablet"):window.innerWidth<1024?document.body.classList.add("is-small-screen"):document.body.classList.add("is-large-screen")</script><div class="webpage-container workspace"><div class="sidebar-left sidebar"><div class="sidebar-handle"></div><div class="sidebar-topbar"><div class="topbar-content"><label class="theme-toggle-container" for="theme_toggle"><input class="theme-toggle-input" type="checkbox" id="theme_toggle"><div class="toggle-background"></div></label></div><div class="clickable-icon sidebar-collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" class="svg-icon"><path d="M21 3H3C1.89543 3 1 3.89543 1 5V19C1 20.1046 1.89543 21 3 21H21C22.1046 21 23 20.1046 23 19V5C23 3.89543 22.1046 3 21 3Z"></path><path d="M10 4V20"></path><path d="M4 7H7"></path><path d="M4 10H7"></path><path d="M4 13H7"></path></svg></div></div><div class="sidebar-content"><div class="search-input-container"><input enterkeyhint="search" type="search" spellcheck="false" placeholder="Search..."><div class="search-input-clear-button" aria-label="Clear search"></div></div><include src="lib/html/file-tree.html"></include></div><script defer="">let ls = document.querySelector(".sidebar-left"); ls.classList.add("is-collapsed"); if (window.innerWidth > 768) ls.classList.remove("is-collapsed"); ls.style.setProperty("--sidebar-width", localStorage.getItem("sidebar-left-width"));</script></div><div class="document-container markdown-reading-view hide"><div class="markdown-preview-view markdown-rendered allow-fold-headings allow-fold-lists is-readable-line-width"><style id="MJX-CHTML-styles"></style><div class="markdown-preview-sizer markdown-preview-section"><h1 class="page-title heading inline-title" id="A hack to implement efficient TLS (thread-local-storage)"><p dir="auto">A hack to implement efficient TLS (thread-local-storage)</p></h1><div><p dir="auto"><a href="?query=tag:ocaml" class="tag" target="_blank" rel="noopener">#ocaml</a> <a href="?query=tag:fp" class="tag" target="_blank" rel="noopener">#fp</a></p></div><div><p dir="auto">Currently OCaml 5 provides a <a data-tooltip-position="top" aria-label="https://v2.ocaml.org/api/Domain.DLS.html" rel="noopener" class="external-link" href="https://v2.ocaml.org/api/Domain.DLS.html" target="_blank"><code>Domain.DLS</code> 2</a> module for domain-local storage.</p></div><div><p dir="auto">Unfortunately,</p></div><div><ol>
<li data-line="0" dir="auto"><a data-tooltip-position="top" aria-label="https://github.com/ocaml/ocaml/issues/11770" rel="noopener" class="external-link" href="https://github.com/ocaml/ocaml/issues/11770" target="_blank">there is no corresponding <code>Thread.TLS</code> 7</a> for (sys)thread-local storage, and</li>
<li data-line="2" dir="auto">the current implementation of <code>Domain.DLS</code> is not thread-safe.</li>
</ol></div><div><p dir="auto">I don’t want to spend time to motivate this topic, but for many of the use cases of <code>Domain.DLS</code>, what you actually want, is to use a <code>Thread.TLS</code>. IOW, many of the uses of <code>Domain.DLS</code> are probably “wrong” and should actually use a <code>Thread.TLS</code>, because, when using <code>Domain.DLS</code>, the implicit assumption is often that you don’t have multiple threads on the domain, but that is typically decided at a higher level in the application and so making such an assumption is typically not safe.</p></div><div class="heading-wrapper"><h2 data-heading="[](https://discuss.ocaml.org/t/a-hack-to-implement-efficient-tls-thread-local-storage/13264/1#domaindls-is-not-thread-safe-1)`Domain.DLS` is not thread-safe" dir="auto" class="heading" id="[](https://discuss.ocaml.org/t/a-hack-to-implement-efficient-tls-thread-local-storage/13264/1#domaindls-is-not-thread-safe-1)`Domain.DLS`_is_not_thread-safe"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div><a data-tooltip-position="top" aria-label="https://discuss.ocaml.org/t/a-hack-to-implement-efficient-tls-thread-local-storage/13264/1#domaindls-is-not-thread-safe-1" rel="noopener" class="external-link" href="https://discuss.ocaml.org/t/a-hack-to-implement-efficient-tls-thread-local-storage/13264/1#domaindls-is-not-thread-safe-1" target="_blank"></a><code>Domain.DLS</code> is not thread-safe</h2><div class="heading-children"><div><p dir="auto">I mentioned that the current implementation of <code>Domain.DLS</code> is not thread-safe. What I mean by that is that <a data-tooltip-position="top" aria-label="https://github.com/ocaml/ocaml/issues/12677" rel="noopener" class="external-link" href="https://github.com/ocaml/ocaml/issues/12677" target="_blank">the current implementation is literally not thread-safe at all</a> in the sense that unrelated concurrent <code>Domain.DLS</code> accesses can actually break the DLS. That is because the state updates performed by <code>Domain.DLS</code> contain safe-points during which the OCaml runtime may switch between (sys)threads.</p></div><div><p dir="auto">Consider <a data-tooltip-position="top" aria-label="https://github.com/ocaml/ocaml/blob/e397ed28bcef85fdc1f0f007af481ef201fb1fd7/stdlib/domain.ml#L120-L127" rel="noopener" class="external-link" href="https://github.com/ocaml/ocaml/blob/e397ed28bcef85fdc1f0f007af481ef201fb1fd7/stdlib/domain.ml#L120-L127" target="_blank">the implementation of <code>Domain.DLS.get</code> 1</a>:</p></div><div><pre class="language-ocaml" tabindex="0"><code class="language-ocaml is-loaded">  <span class="token keyword">let</span> get <span class="token punctuation">(</span>idx<span class="token punctuation">,</span> init<span class="token punctuation">)</span> <span class="token operator">=</span>
    <span class="token keyword">let</span> st <span class="token operator">=</span> maybe_grow idx <span class="token keyword">in</span>
    <span class="token keyword">let</span> v <span class="token operator">=</span> st<span class="token punctuation">.</span><span class="token punctuation">(</span>idx<span class="token punctuation">)</span> <span class="token keyword">in</span>
    <span class="token keyword">if</span> v <span class="token operator">==</span> unique_value <span class="token keyword">then</span>
      <span class="token keyword">let</span> v' <span class="token operator">=</span> Obj<span class="token punctuation">.</span>repr <span class="token punctuation">(</span>init <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">in</span>
      st<span class="token punctuation">.</span><span class="token punctuation">(</span>idx<span class="token punctuation">)</span> <span class="token operator">&lt;-</span> <span class="token punctuation">(</span>Sys<span class="token punctuation">.</span>opaque_identity v'<span class="token punctuation">)</span><span class="token punctuation">;</span>
      Obj<span class="token punctuation">.</span>magic v'
    <span class="token keyword">else</span> Obj<span class="token punctuation">.</span>magic v
</code><button class="copy-code-button">Copy</button></pre></div><div><p dir="auto">If there are two (or more) threads on a single domain that concurrently call <code>get</code> before <code>init</code> has been called initially, then what might happen is that <code>init</code> gets called twice (or more) and the threads get different values which could e.g. be pointers to two different mutable objects.</p></div><div><p dir="auto">Consider <a data-tooltip-position="top" aria-label="https://github.com/ocaml/ocaml/blob/e397ed28bcef85fdc1f0f007af481ef201fb1fd7/stdlib/domain.ml#L98-L111" rel="noopener" class="external-link" href="https://github.com/ocaml/ocaml/blob/e397ed28bcef85fdc1f0f007af481ef201fb1fd7/stdlib/domain.ml#L98-L111" target="_blank">the implementation of <code>maybe_grow</code></a>:</p></div><div><pre class="language-ocaml" tabindex="0"><code class="language-ocaml is-loaded">  <span class="token keyword">let</span> maybe_grow idx <span class="token operator">=</span>
    <span class="token keyword">let</span> st <span class="token operator">=</span> get_dls_state <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">in</span>
    <span class="token keyword">let</span> sz <span class="token operator">=</span> Array<span class="token punctuation">.</span>length st <span class="token keyword">in</span>
    <span class="token keyword">if</span> idx <span class="token operator">&lt;</span> sz <span class="token keyword">then</span> st
    <span class="token keyword">else</span> <span class="token keyword">begin</span>
      <span class="token keyword">let</span> <span class="token keyword">rec</span> compute_new_size s <span class="token operator">=</span>
        <span class="token keyword">if</span> idx <span class="token operator">&lt;</span> s <span class="token keyword">then</span> s <span class="token keyword">else</span> compute_new_size <span class="token punctuation">(</span><span class="token number">2</span> <span class="token operator">*</span> s<span class="token punctuation">)</span>
      <span class="token keyword">in</span>
      <span class="token keyword">let</span> new_sz <span class="token operator">=</span> compute_new_size sz <span class="token keyword">in</span>
      <span class="token keyword">let</span> new_st <span class="token operator">=</span> Array<span class="token punctuation">.</span>make new_sz unique_value <span class="token keyword">in</span>
      Array<span class="token punctuation">.</span>blit st <span class="token number">0</span> new_st <span class="token number">0</span> sz<span class="token punctuation">;</span>
      set_dls_state new_st<span class="token punctuation">;</span>
      new_st
    <span class="token keyword">end</span>

</code><button class="copy-code-button">Copy</button></pre></div><div><p dir="auto">Imagine calling <code>get</code> (which calls <code>maybe_grow</code>) with two different keys from two different threads concurrently. The end result might be that two different arrays are allocated and only one of them “wins”. What this means, for example, is that effects of <code>set</code> calls may effectively be undone by concurrent calls of <code>get</code>.</p></div><div><p dir="auto">In other words, the <code>Domain.DLS</code>, as it is currently implemented, is not thread-safe.</p></div></div></div><div class="heading-wrapper"><h2 data-heading="[](https://discuss.ocaml.org/t/a-hack-to-implement-efficient-tls-thread-local-storage/13264/1#how-to-implement-an-efficient-threadtls-2)How to implement an efficient `Thread.TLS`?" dir="auto" class="heading" id="[](https://discuss.ocaml.org/t/a-hack-to-implement-efficient-tls-thread-local-storage/13264/1#how-to-implement-an-efficient-threadtls-2)How_to_implement_an_efficient_`Thread.TLS`?"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div><a data-tooltip-position="top" aria-label="https://discuss.ocaml.org/t/a-hack-to-implement-efficient-tls-thread-local-storage/13264/1#how-to-implement-an-efficient-threadtls-2" rel="noopener" class="external-link" href="https://discuss.ocaml.org/t/a-hack-to-implement-efficient-tls-thread-local-storage/13264/1#how-to-implement-an-efficient-threadtls-2" target="_blank"></a>How to implement an efficient <code>Thread.TLS</code>?</h2><div class="heading-children"><div><p dir="auto">If you dig into the implementation of threads, you will notice that the opaque <a data-tooltip-position="top" aria-label="https://github.com/ocaml/ocaml/blob/e397ed28bcef85fdc1f0f007af481ef201fb1fd7/otherlibs/systhreads/thread.mli#L18" rel="noopener" class="external-link" href="https://github.com/ocaml/ocaml/blob/e397ed28bcef85fdc1f0f007af481ef201fb1fd7/otherlibs/systhreads/thread.mli#L18" target="_blank"><code>Thread.t</code> type</a> is actually a heap block (record) of three fields. You can see the <a data-tooltip-position="top" aria-label="https://github.com/ocaml/ocaml/blob/e397ed28bcef85fdc1f0f007af481ef201fb1fd7/otherlibs/systhreads/st_stubs.c#L66-L68" rel="noopener" class="external-link" href="https://github.com/ocaml/ocaml/blob/e397ed28bcef85fdc1f0f007af481ef201fb1fd7/otherlibs/systhreads/st_stubs.c#L66-L68" target="_blank"><code>Thread.t</code> accessors</a>:</p></div><div><pre><code>#define Ident(v) Field(v, 0)
#define Start_closure(v) Field(v, 1)
#define Terminated(v) Field(v, 2)
</code><button class="copy-code-button">Copy</button></pre></div><div><p dir="auto">and the <a data-tooltip-position="top" aria-label="https://github.com/ocaml/ocaml/blob/e397ed28bcef85fdc1f0f007af481ef201fb1fd7/otherlibs/systhreads/st_stubs.c#L335-L346" rel="noopener" class="external-link" href="https://github.com/ocaml/ocaml/blob/e397ed28bcef85fdc1f0f007af481ef201fb1fd7/otherlibs/systhreads/st_stubs.c#L335-L346" target="_blank"><code>Thread.t</code> allocation 1</a>:</p></div><div><pre><code>static value caml_thread_new_descriptor(value clos)
{
  CAMLparam1(clos);
  CAMLlocal1(mu);
  value descr;
  /* Create and initialize the termination semaphore */
  mu = caml_threadstatus_new();
  /* Create a descriptor for the new thread */
  descr = caml_alloc_3(0, Val_long(atomic_fetch_add(&amp;thread_next_id, +1)),
                       clos, mu);
  CAMLreturn(descr);
}
</code><button class="copy-code-button">Copy</button></pre></div><div><p dir="auto">The second field, <code>Start_closure</code>, is used to pass the closure to the thread start:</p></div><div><pre><code>static void * caml_thread_start(void * v)
{
  caml_thread_t th = (caml_thread_t) v;
  int dom_id = th-&gt;domain_id;
  value clos;
  void * signal_stack;

  caml_init_domain_self(dom_id);

  st_tls_set(caml_thread_key, th);

  thread_lock_acquire(dom_id);
  restore_runtime_state(th);
  signal_stack = caml_init_signal_stack();

  clos = Start_closure(Active_thread-&gt;descr);
  caml_modify(&amp;(Start_closure(Active_thread-&gt;descr)), Val_unit);
  caml_callback_exn(clos, Val_unit);
  caml_thread_stop();
  caml_free_signal_stack(signal_stack);
  return 0;
}

</code><button class="copy-code-button">Copy</button></pre></div><div><p dir="auto">and, as seen above, <a data-tooltip-position="top" aria-label="https://github.com/ocaml/ocaml/blob/e397ed28bcef85fdc1f0f007af481ef201fb1fd7/otherlibs/systhreads/st_stubs.c#L575" rel="noopener" class="external-link" href="https://github.com/ocaml/ocaml/blob/e397ed28bcef85fdc1f0f007af481ef201fb1fd7/otherlibs/systhreads/st_stubs.c#L575" target="_blank">it is overwritten with the unit value</a> before the closure is called.</p></div><div><p dir="auto">What this means is that when you call <code>Thread.self ()</code> and get a reference to the current <code>Thread.t</code>, the <code>Start_closure</code> field of that heap block will be the unit value:</p></div><div><pre class="language-ocaml" tabindex="0"><code class="language-ocaml is-loaded"><span class="token keyword">assert</span> <span class="token punctuation">(</span>Obj<span class="token punctuation">.</span>field <span class="token punctuation">(</span>Obj<span class="token punctuation">.</span>repr <span class="token punctuation">(</span>Thread<span class="token punctuation">.</span>self <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token number">1</span> <span class="token operator">=</span> Obj<span class="token punctuation">.</span>repr <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code><button class="copy-code-button">Copy</button></pre></div><div><p dir="auto">Let’s hijack that field for the purpose of implementing an efficient TLS!</p></div><div><p dir="auto">Here is the full hack:</p></div><div><pre class="language-ocaml" tabindex="0"><code class="language-ocaml is-loaded"><span class="token keyword">module</span> TLS <span class="token punctuation">:</span> <span class="token keyword">sig</span>
  <span class="token keyword">type</span> <span class="token type-variable function">'a</span> key
  <span class="token keyword">val</span> new_key <span class="token punctuation">:</span> <span class="token punctuation">(</span>unit <span class="token operator">-&gt;</span> <span class="token type-variable function">'a</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token type-variable function">'a</span> key
  <span class="token keyword">val</span> get <span class="token punctuation">:</span> <span class="token type-variable function">'a</span> key <span class="token operator">-&gt;</span> <span class="token type-variable function">'a</span>
  <span class="token keyword">val</span> set <span class="token punctuation">:</span> <span class="token type-variable function">'a</span> key <span class="token operator">-&gt;</span> <span class="token type-variable function">'a</span> <span class="token operator">-&gt;</span> unit
<span class="token keyword">end</span> <span class="token operator">=</span> <span class="token keyword">struct</span>
  <span class="token keyword">type</span> <span class="token type-variable function">'a</span> key <span class="token operator">=</span> <span class="token punctuation">{</span> index <span class="token punctuation">:</span> int<span class="token punctuation">;</span> compute <span class="token punctuation">:</span> unit <span class="token operator">-&gt;</span> <span class="token type-variable function">'a</span> <span class="token punctuation">}</span>

  <span class="token keyword">let</span> counter <span class="token operator">=</span> Atomic<span class="token punctuation">.</span>make <span class="token number">0</span>
  <span class="token keyword">let</span> unique <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> Obj<span class="token punctuation">.</span>repr counter

  <span class="token keyword">let</span> new_key compute <span class="token operator">=</span>
    <span class="token keyword">let</span> index <span class="token operator">=</span> Atomic<span class="token punctuation">.</span>fetch_and_add counter <span class="token number">1</span> <span class="token keyword">in</span>
    <span class="token punctuation">{</span> index<span class="token punctuation">;</span> compute <span class="token punctuation">}</span>

  <span class="token keyword">type</span> t <span class="token operator">=</span> <span class="token punctuation">{</span> _id <span class="token punctuation">:</span> int<span class="token punctuation">;</span> <span class="token keyword">mutable</span> tls <span class="token punctuation">:</span> Obj<span class="token punctuation">.</span>t <span class="token punctuation">}</span>

  <span class="token keyword">let</span> ceil_pow_2_minus_1 n <span class="token operator">=</span>
    <span class="token keyword">let</span> n <span class="token operator">=</span> n <span class="token operator">lor</span> <span class="token punctuation">(</span>n <span class="token operator">lsr</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">in</span>
    <span class="token keyword">let</span> n <span class="token operator">=</span> n <span class="token operator">lor</span> <span class="token punctuation">(</span>n <span class="token operator">lsr</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">in</span>
    <span class="token keyword">let</span> n <span class="token operator">=</span> n <span class="token operator">lor</span> <span class="token punctuation">(</span>n <span class="token operator">lsr</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token keyword">in</span>
    <span class="token keyword">let</span> n <span class="token operator">=</span> n <span class="token operator">lor</span> <span class="token punctuation">(</span>n <span class="token operator">lsr</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token keyword">in</span>
    <span class="token keyword">let</span> n <span class="token operator">=</span> n <span class="token operator">lor</span> <span class="token punctuation">(</span>n <span class="token operator">lsr</span> <span class="token number">16</span><span class="token punctuation">)</span> <span class="token keyword">in</span>
    <span class="token keyword">if</span> Sys<span class="token punctuation">.</span>int_size <span class="token operator">&gt;</span> <span class="token number">32</span> <span class="token keyword">then</span> n <span class="token operator">lor</span> <span class="token punctuation">(</span>n <span class="token operator">lsr</span> <span class="token number">32</span><span class="token punctuation">)</span> <span class="token keyword">else</span> n

  <span class="token keyword">let</span><span class="token punctuation">[</span><span class="token operator">@</span>inline never<span class="token punctuation">]</span> grow_tls t before index <span class="token operator">=</span>
    <span class="token keyword">let</span> new_length <span class="token operator">=</span> ceil_pow_2_minus_1 <span class="token punctuation">(</span>index <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">in</span>
    <span class="token keyword">let</span> after <span class="token operator">=</span> Array<span class="token punctuation">.</span>make new_length <span class="token punctuation">(</span>unique <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">in</span>
    Array<span class="token punctuation">.</span>blit before <span class="token number">0</span> after <span class="token number">0</span> <span class="token punctuation">(</span>Array<span class="token punctuation">.</span>length before<span class="token punctuation">)</span><span class="token punctuation">;</span>
    t<span class="token punctuation">.</span>tls <span class="token operator">&lt;-</span> Obj<span class="token punctuation">.</span>repr after<span class="token punctuation">;</span>
    after

  <span class="token keyword">let</span><span class="token punctuation">[</span><span class="token operator">@</span>inline<span class="token punctuation">]</span> get_tls index <span class="token operator">=</span>
    <span class="token keyword">let</span> t <span class="token operator">=</span> Obj<span class="token punctuation">.</span>magic <span class="token punctuation">(</span>Thread<span class="token punctuation">.</span>self <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">in</span>
    <span class="token keyword">let</span> tls <span class="token operator">=</span> t<span class="token punctuation">.</span>tls <span class="token keyword">in</span>
    <span class="token keyword">if</span> Obj<span class="token punctuation">.</span>is_int tls <span class="token keyword">then</span> grow_tls t <span class="token operator-like-punctuation punctuation">[|</span><span class="token operator-like-punctuation punctuation">|]</span> index
    <span class="token keyword">else</span>
      <span class="token keyword">let</span> tls <span class="token operator">=</span> <span class="token punctuation">(</span>Obj<span class="token punctuation">.</span>magic tls <span class="token punctuation">:</span> Obj<span class="token punctuation">.</span>t array<span class="token punctuation">)</span> <span class="token keyword">in</span>
      <span class="token keyword">if</span> index <span class="token operator">&lt;</span> Array<span class="token punctuation">.</span>length tls <span class="token keyword">then</span> tls <span class="token keyword">else</span> grow_tls t tls index

  <span class="token keyword">let</span> get key <span class="token operator">=</span>
    <span class="token keyword">let</span> tls <span class="token operator">=</span> get_tls key<span class="token punctuation">.</span>index <span class="token keyword">in</span>
    <span class="token keyword">let</span> <span class="token keyword">value</span> <span class="token operator">=</span> Array<span class="token punctuation">.</span>unsafe_get tls key<span class="token punctuation">.</span>index <span class="token keyword">in</span>
    <span class="token keyword">if</span> <span class="token keyword">value</span> <span class="token operator">!=</span> unique <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">then</span> Obj<span class="token punctuation">.</span>magic <span class="token keyword">value</span>
    <span class="token keyword">else</span>
      <span class="token keyword">let</span> <span class="token keyword">value</span> <span class="token operator">=</span> key<span class="token punctuation">.</span>compute <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">in</span>
      Array<span class="token punctuation">.</span>unsafe_set tls key<span class="token punctuation">.</span>index <span class="token punctuation">(</span>Obj<span class="token punctuation">.</span>repr <span class="token punctuation">(</span>Sys<span class="token punctuation">.</span>opaque_identity <span class="token keyword">value</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">value</span>

  <span class="token keyword">let</span> set key <span class="token keyword">value</span> <span class="token operator">=</span>
    <span class="token keyword">let</span> tls <span class="token operator">=</span> get_tls key<span class="token punctuation">.</span>index <span class="token keyword">in</span>
    Array<span class="token punctuation">.</span>unsafe_set tls key<span class="token punctuation">.</span>index <span class="token punctuation">(</span>Obj<span class="token punctuation">.</span>repr <span class="token punctuation">(</span>Sys<span class="token punctuation">.</span>opaque_identity <span class="token keyword">value</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">end</span>
</code><button class="copy-code-button">Copy</button></pre></div><div><p dir="auto">The above achieves about 80% of the performance of <code>Domain.DLS</code> allowing roughly 241M <code>TLS.get</code>s/s (vs 296M <code>Domain.DLS.get</code>s/s) on my laptop.</p></div><div class="mod-footer"></div></div></div></div></div></div><div class="sidebar-right sidebar"><div class="sidebar-handle"></div><div class="sidebar-topbar"><div class="topbar-content"></div><div class="clickable-icon sidebar-collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" class="svg-icon"><path d="M21 3H3C1.89543 3 1 3.89543 1 5V19C1 20.1046 1.89543 21 3 21H21C22.1046 21 23 20.1046 23 19V5C23 3.89543 22.1046 3 21 3Z"></path><path d="M10 4V20"></path><path d="M4 7H7"></path><path d="M4 10H7"></path><path d="M4 13H7"></path></svg></div></div><div class="sidebar-content"><div class="graph-view-wrapper"><div class="sidebar-section-header">Interactive Graph</div><div class="graph-view-placeholder">
		<div class="graph-view-container">
			<div class="graph-icon graph-expand" role="button" aria-label="Expand" data-tooltip-position="top"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon"><line x1="7" y1="17" x2="17" y2="7"></line><polyline points="7 7 17 7 17 17"></polyline></svg></div>
			<canvas id="graph-canvas" class="hide" width="512px" height="512px"></canvas>
		</div>
		</div></div><div class="tree-container mod-root nav-folder tree-item outline-tree" data-depth="0"><div class="tree-header"><span class="sidebar-section-header">Table Of Contents</span><button class="clickable-icon collapse-tree-button" aria-label="Collapse All"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></svg></button></div><div class="tree-scroll-area tree-item-children nav-folder-children"><div class="tree-item mod-tree-folder nav-folder mod-collapsible is-collapsed" style="display: none;"></div><div class="tree-item" data-depth="1"><a class="tree-link" href="computer-science/programming-language/ocaml/a-hack-to-implement-efficient-tls-(thread-local-storage).html#A hack to implement efficient TLS (thread-local-storage)"><div class="tree-item-contents heading-link" heading-name="A hack to implement efficient TLS (thread-local-storage)"><span class="tree-item-title">A hack to implement efficient TLS (thread-local-storage)</span></div></a><div class="tree-item-children nav-folder-children"><div class="tree-item" data-depth="2"><a class="tree-link" href="computer-science/programming-language/ocaml/a-hack-to-implement-efficient-tls-(thread-local-storage).html#[](https://discuss.ocaml.org/t/a-hack-to-implement-efficient-tls-thread-local-storage/13264/1#domaindls-is-not-thread-safe-1)`Domain.DLS`_is_not_thread-safe"><div class="tree-item-contents heading-link" heading-name="[](https://discuss.ocaml.org/t/a-hack-to-implement-efficient-tls-thread-local-storage/13264/1#domaindls-is-not-thread-safe-1)`Domain.DLS` is not thread-safe"><span class="tree-item-title"><a data-tooltip-position="top" aria-label="https://discuss.ocaml.org/t/a-hack-to-implement-efficient-tls-thread-local-storage/13264/1#domaindls-is-not-thread-safe-1" rel="noopener" class="external-link" href="https://discuss.ocaml.org/t/a-hack-to-implement-efficient-tls-thread-local-storage/13264/1#domaindls-is-not-thread-safe-1" target="_blank"></a><code>Domain.DLS</code> is not thread-safe</span></div></a><div class="tree-item-children nav-folder-children"></div></div><div class="tree-item" data-depth="2"><a class="tree-link" href="computer-science/programming-language/ocaml/a-hack-to-implement-efficient-tls-(thread-local-storage).html#[](https://discuss.ocaml.org/t/a-hack-to-implement-efficient-tls-thread-local-storage/13264/1#how-to-implement-an-efficient-threadtls-2)How_to_implement_an_efficient_`Thread.TLS`?"><div class="tree-item-contents heading-link" heading-name="[](https://discuss.ocaml.org/t/a-hack-to-implement-efficient-tls-thread-local-storage/13264/1#how-to-implement-an-efficient-threadtls-2)How to implement an efficient `Thread.TLS`?"><span class="tree-item-title"><a data-tooltip-position="top" aria-label="https://discuss.ocaml.org/t/a-hack-to-implement-efficient-tls-thread-local-storage/13264/1#how-to-implement-an-efficient-threadtls-2" rel="noopener" class="external-link" href="https://discuss.ocaml.org/t/a-hack-to-implement-efficient-tls-thread-local-storage/13264/1#how-to-implement-an-efficient-threadtls-2" target="_blank"></a>How to implement an efficient <code>Thread.TLS</code>?</span></div></a><div class="tree-item-children nav-folder-children"></div></div></div></div></div></div></div><script defer="">let rs = document.querySelector(".sidebar-right"); rs.classList.add("is-collapsed"); if (window.innerWidth > 768) rs.classList.remove("is-collapsed"); rs.style.setProperty("--sidebar-width", localStorage.getItem("sidebar-right-width"));</script></div></div></body></html>