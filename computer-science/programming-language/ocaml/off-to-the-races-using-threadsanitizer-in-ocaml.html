<!DOCTYPE html> <html><head>
		<title>Off to the Races Using ThreadSanitizer in OCaml</title>
		<base href="../../../">
		<meta id="root-path" root-path="../../../">
		<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes, minimum-scale=1.0, maximum-scale=5.0">
		<meta charset="UTF-8">
		<meta name="description" content="韩暮秋的个人维基 - Off to the Races Using ThreadSanitizer in OCaml">
		<meta property="og:title" content="Off to the Races Using ThreadSanitizer in OCaml">
		<meta property="og:description" content="韩暮秋的个人维基 - Off to the Races Using ThreadSanitizer in OCaml">
		<meta property="og:type" content="website">
		<meta property="og:url" content="https://muqiuhan.github.io/wiki/computer-science/programming-language/ocaml/off-to-the-races-using-threadsanitizer-in-ocaml.html">
		<meta property="og:image" content="https://tarides.com/static/0bf64db362ac972b1285ab93f569b53a/c5bb3/vector-clocks.png">
		<meta property="og:site_name" content="韩暮秋的个人维基">
		<meta name="author" content="韩暮秋"><script async="" id="webpage-script" src="lib/scripts/webpage.js" onload="this.onload=null;this.setAttribute(&quot;loaded&quot;, &quot;true&quot;)"></script><script type="module" async="" id="graph-view-script" src="lib/scripts/graph-view.js"></script><script async="" id="graph-wasm-script" src="lib/scripts/graph-wasm.js" onload="this.onload=null;this.setAttribute(&quot;loaded&quot;, &quot;true&quot;)"></script><script async="" id="graph-render-worker-script" src="lib/scripts/graph-render-worker.js" onload="this.onload=null;this.setAttribute(&quot;loaded&quot;, &quot;true&quot;)"></script><script async="" id="tinycolor-script" src="lib/scripts/tinycolor.js" onload="this.onload=null;this.setAttribute(&quot;loaded&quot;, &quot;true&quot;)"></script><script async="" id="pixi-script" src="lib/scripts/pixi.js" onload="this.onload=null;this.setAttribute(&quot;loaded&quot;, &quot;true&quot;)"></script><script async="" id="minisearch-script" src="lib/scripts/minisearch.js" onload="this.onload=null;this.setAttribute(&quot;loaded&quot;, &quot;true&quot;)"></script><link rel="icon" href="lib/media/favicon.jpg"><script async="" id="graph-data-script" src="lib/scripts/graph-data.js" onload="this.onload=null;this.setAttribute(&quot;loaded&quot;, &quot;true&quot;)"></script><style>body{--line-width:40em;--line-width-adaptive:40em;--file-line-width:40em;--sidebar-width:min(20em, 80vw);--collapse-arrow-size:11px;--tree-horizontal-spacing:0.6em;--tree-vertical-spacing:0.6em;--sidebar-margin:12px}.sidebar{height:100%;min-width:calc(var(--sidebar-width) + var(--divider-width-hover));max-width:calc(var(--sidebar-width) + var(--divider-width-hover));font-size:14px;z-index:10;position:relative;overflow:hidden;transition:min-width ease-in-out,max-width ease-in-out;transition-duration:.2s;contain:size}.sidebar-left{left:0}.sidebar-right{right:0}.sidebar.is-collapsed{min-width:0;max-width:0}body.floating-sidebars .sidebar{position:absolute}.sidebar-content{height:100%;min-width:calc(var(--sidebar-width) - var(--divider-width-hover));top:0;padding:var(--sidebar-margin);padding-top:4em;line-height:var(--line-height-tight);background-color:var(--background-secondary);transition:background-color,border-right,border-left,box-shadow;transition-duration:var(--color-fade-speed);transition-timing-function:ease-in-out;position:absolute;display:flex;flex-direction:column}.sidebar:not(.is-collapsed) .sidebar-content{min-width:calc(max(100%,var(--sidebar-width)) - 3px);max-width:calc(max(100%,var(--sidebar-width)) - 3px)}.sidebar-left .sidebar-content{left:0;border-top-right-radius:var(--radius-l);border-bottom-right-radius:var(--radius-l)}.sidebar-right .sidebar-content{right:0;border-top-left-radius:var(--radius-l);border-bottom-left-radius:var(--radius-l)}.sidebar:has(.sidebar-content:empty):has(.topbar-content:empty){display:none}.sidebar-topbar{height:2em;width:var(--sidebar-width);top:var(--sidebar-margin);padding-inline:var(--sidebar-margin);z-index:1;position:fixed;display:flex;align-items:center;transition:width ease-in-out;transition-duration:inherit}.sidebar.is-collapsed .sidebar-topbar{width:calc(2.3em + var(--sidebar-margin) * 2)}.sidebar .sidebar-topbar.is-collapsed{width:0}.sidebar-left .sidebar-topbar{left:0}.sidebar-right .sidebar-topbar{right:0}.topbar-content{overflow:hidden;overflow:clip;width:100%;height:100%;display:flex;align-items:center;transition:inherit}.sidebar.is-collapsed .topbar-content{width:0;transition:inherit}.clickable-icon.sidebar-collapse-icon{background-color:transparent;color:var(--icon-color-focused);padding:0!important;margin:0!important;height:100%!important;width:2.3em!important;margin-inline:0.14em!important;position:absolute}.sidebar-left .clickable-icon.sidebar-collapse-icon{transform:rotateY(180deg);right:var(--sidebar-margin)}.sidebar-right .clickable-icon.sidebar-collapse-icon{transform:rotateY(180deg);left:var(--sidebar-margin)}.clickable-icon.sidebar-collapse-icon svg.svg-icon{width:100%;height:100%}.sidebar-section-header{margin:0 0 1em 0;text-transform:uppercase;letter-spacing:.06em;font-weight:600}body{transition:background-color var(--color-fade-speed) ease-in-out}.webpage-container{display:flex;flex-direction:row;height:100%;width:100%;align-items:stretch;justify-content:center}.document-container{opacity:1;flex-basis:100%;max-width:100%;width:100%;height:100%;display:flex;flex-direction:column;align-items:center;transition:opacity .2s ease-in-out;contain:inline-size}.hide{opacity:0;transition:opacity .2s ease-in-out}.document-container>.markdown-preview-view{margin:var(--sidebar-margin);margin-bottom:0;width:100%;width:-webkit-fill-available;width:-moz-available;width:fill-available;background-color:var(--background-primary);transition:background-color var(--color-fade-speed) ease-in-out;border-top-right-radius:var(--window-radius,var(--radius-m));border-top-left-radius:var(--window-radius,var(--radius-m));overflow-x:hidden!important;overflow-y:auto!important;display:flex!important;flex-direction:column!important;align-items:center!important;contain:inline-size}.document-container>.markdown-preview-view>.markdown-preview-sizer{padding-bottom:80vh!important;width:100%!important;max-width:var(--line-width)!important;flex-basis:var(--line-width)!important;transition:background-color var(--color-fade-speed) ease-in-out;contain:inline-size}.markdown-rendered img:not([width]),.view-content img:not([width]){max-width:100%;outline:0}.document-container>.view-content.embed{display:flex;padding:1em;height:100%;width:100%;align-items:center;justify-content:center}.document-container>.view-content.embed>*{max-width:100%;max-height:100%;object-fit:contain}:has(> :is(.math,table)){overflow-x:auto!important}.document-container>.view-content{overflow-x:auto;contain:content;padding:0;margin:0;height:100%}.scroll-highlight{position:absolute;width:100%;height:100%;pointer-events:none;z-index:1000;background-color:hsla(var(--color-accent-hsl),.25);opacity:0;padding:1em;inset:50%;translate:-50% -50%;border-radius:var(--radius-s)}</style><script defer="">async function loadIncludes(){if("file:"!=location.protocol){let e=document.querySelectorAll("include");for(let t=0;t<e.length;t++){let o=e[t],l=o.getAttribute("src");try{const e=await fetch(l);if(!e.ok){console.log("Could not include file: "+l),o?.remove();continue}let t=await e.text(),n=document.createRange().createContextualFragment(t),i=Array.from(n.children);for(let e of i)e.classList.add("hide"),e.style.transition="opacity 0.5s ease-in-out",setTimeout((()=>{e.classList.remove("hide")}),10);o.before(n),o.remove(),console.log("Included file: "+l)}catch(e){o?.remove(),console.log("Could not include file: "+l,e);continue}}}else{if(document.querySelectorAll("include").length>0){var e=document.createElement("div");e.id="error",e.textContent="Web server exports must be hosted on an http / web server to be viewed correctly.",e.style.position="fixed",e.style.top="50%",e.style.left="50%",e.style.transform="translate(-50%, -50%)",e.style.fontSize="1.5em",e.style.fontWeight="bold",e.style.textAlign="center",document.body.appendChild(e),document.querySelector(".document-container")?.classList.remove("hide")}}}document.addEventListener("DOMContentLoaded",(()=>{loadIncludes()}));let isFileProtocol="file:"==location.protocol;function waitLoadScripts(e,t){let o=e.map((e=>document.getElementById(e+"-script"))),l=0;!function e(){let n=o[l];l++,n&&"true"!=n.getAttribute("loaded")||l<o.length&&e(),l<o.length?n.addEventListener("load",e):t()}()}</script><link rel="stylesheet" href="lib/styles/obsidian.css"><link rel="preload" href="lib/styles/other-plugins.css" as="style" onload="this.onload=null;this.rel='stylesheet'"><noscript><link rel="stylesheet" href="lib/styles/other-plugins.css"></noscript><link rel="stylesheet" href="lib/styles/theme.css"><link rel="preload" href="lib/styles/global-variable-styles.css" as="style" onload="this.onload=null;this.rel='stylesheet'"><noscript><link rel="stylesheet" href="lib/styles/global-variable-styles.css"></noscript><link rel="preload" href="lib/styles/supported-plugins.css" as="style" onload="this.onload=null;this.rel='stylesheet'"><noscript><link rel="stylesheet" href="lib/styles/supported-plugins.css"></noscript><link rel="preload" href="lib/styles/main-styles.css" as="style" onload="this.onload=null;this.rel='stylesheet'"><noscript><link rel="stylesheet" href="lib/styles/main-styles.css"></noscript></head><body class="publish css-settings-manager theme-dark show-inline-title show-ribbon oled-black lst-fab-b2-1 is-css-guide list-d-c-d lst-fm-compact lst-prop-super-compact"><script defer="">let theme=localStorage.getItem("theme")||(window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light");"dark"==theme?(document.body.classList.add("theme-dark"),document.body.classList.remove("theme-light")):(document.body.classList.add("theme-light"),document.body.classList.remove("theme-dark")),window.innerWidth<480?document.body.classList.add("is-phone"):window.innerWidth<768?document.body.classList.add("is-tablet"):window.innerWidth<1024?document.body.classList.add("is-small-screen"):document.body.classList.add("is-large-screen")</script><div class="webpage-container workspace"><div class="sidebar-left sidebar"><div class="sidebar-handle"></div><div class="sidebar-topbar"><div class="topbar-content"><label class="theme-toggle-container" for="theme_toggle"><input class="theme-toggle-input" type="checkbox" id="theme_toggle"><div class="toggle-background"></div></label></div><div class="clickable-icon sidebar-collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" class="svg-icon"><path d="M21 3H3C1.89543 3 1 3.89543 1 5V19C1 20.1046 1.89543 21 3 21H21C22.1046 21 23 20.1046 23 19V5C23 3.89543 22.1046 3 21 3Z"></path><path d="M10 4V20"></path><path d="M4 7H7"></path><path d="M4 10H7"></path><path d="M4 13H7"></path></svg></div></div><div class="sidebar-content"><div class="search-input-container"><input enterkeyhint="search" type="search" spellcheck="false" placeholder="Search..."><div class="search-input-clear-button" aria-label="Clear search"></div></div><include src="lib/html/file-tree.html"></include></div><script defer="">let ls = document.querySelector(".sidebar-left"); ls.classList.add("is-collapsed"); if (window.innerWidth > 768) ls.classList.remove("is-collapsed"); ls.style.setProperty("--sidebar-width", localStorage.getItem("sidebar-left-width"));</script></div><div class="document-container markdown-reading-view hide"><div class="markdown-preview-view markdown-rendered allow-fold-headings allow-fold-lists is-readable-line-width"><style id="MJX-CHTML-styles"></style><div class="markdown-preview-sizer markdown-preview-section"><h1 class="page-title heading inline-title" id="Off to the Races Using ThreadSanitizer in OCaml"><p dir="auto">Off to the Races Using ThreadSanitizer in OCaml</p></h1><div><p dir="auto"><a href="?query=tag:ocaml" class="tag" target="_blank" rel="noopener">#ocaml</a> <a href="?query=tag:fp" class="tag" target="_blank" rel="noopener">#fp</a></p></div><div><p dir="auto">OCaml Multicore opened up a new world of performance for developers, something that <a data-tooltip-position="top" aria-label="https://tarides.com/blog/2022-12-20-how-nomadic-labs-used-multicore-processing-to-create-a-faster-blockchain/" rel="noopener" class="external-link" href="https://tarides.com/blog/2022-12-20-how-nomadic-labs-used-multicore-processing-to-create-a-faster-blockchain/" target="_blank">Nomadic Labs has tested with great results.</a> Rather than relying on one core to do everything, the program can take advantage of multiple cores simultaneously for a significant performance boost.</p></div><div><p dir="auto">With new programming possibilities come new classes of bugs, which require updated detection methods. One of these types of bugs is called a data race. A data race is a race condition that occurs when two accesses are made to the same memory location, at least one is a write, and no order is enforced between them.</p></div><div><p dir="auto">Data races can be dangerous as they are easy to miss and capable of yielding unexpected results. Consequently, integrating a tool to detect data races has been a high priority for the teams working on OCaml 5.0 with Multicore support. Whilst data races in OCaml are less problematic than in many other languages (for example, data races in OCaml do not cause crashes and do not constitute undefined behaviour), developers still want to be made aware of possible data races so that they can remove them from their programs. More about this below.</p></div><div class="heading-wrapper"><h2 data-heading="[](https://tarides.com/blog/2023-10-18-off-to-the-races-using-threadsanitizer-in-ocaml/#what-is-tsan)" dir="auto" class="heading" id="[](https://tarides.com/blog/2023-10-18-off-to-the-races-using-threadsanitizer-in-ocaml/#what-is-tsan)"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div><a data-tooltip-position="top" aria-label="https://tarides.com/blog/2023-10-18-off-to-the-races-using-threadsanitizer-in-ocaml/#what-is-tsan" rel="noopener" class="external-link" href="https://tarides.com/blog/2023-10-18-off-to-the-races-using-threadsanitizer-in-ocaml/#what-is-tsan" target="_blank"></a></h2><div class="heading-children"></div></div><div class="heading-wrapper"><h2 data-heading="What is TSan?" dir="auto" class="heading" id="What_is_TSan?"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>What is TSan?</h2><div class="heading-children"><div><p dir="auto"><a data-tooltip-position="top" aria-label="https://clang.llvm.org/docs/ThreadSanitizer.html" rel="noopener" class="external-link" href="https://clang.llvm.org/docs/ThreadSanitizer.html" target="_blank">ThreadSanitizer</a>, or TSan, is an open-source tool that reliably detects data races at runtime. It consists of instrumenting programs with calls to a dedicated runtime that performs the detection.</p></div><div><p dir="auto">Support for TSan will officially be part of the OCaml 5.2 release, and there is already a backport for OCaml 5.1.</p></div><div><p dir="auto">This blog post will demonstrate the benefits of using TSan, offer insight into how TSan works, and outline the challenges of integrating it with OCaml. For a more practically oriented guide on how to use TSan in your own projects, the <a data-tooltip-position="top" aria-label="https://ocaml.org/docs/multicore-transition" rel="noopener" class="external-link" href="https://ocaml.org/docs/multicore-transition" target="_blank">tutorial on using TSan with OCaml Multicore</a> is a great place to start.</p></div><div><p dir="auto">We will begin by examining what a data race looks like, both before and after using TSan.</p></div><div class="heading-wrapper"><h3 data-heading="[](https://tarides.com/blog/2023-10-18-off-to-the-races-using-threadsanitizer-in-ocaml/#a-practical-example)" dir="auto" class="heading" id="[](https://tarides.com/blog/2023-10-18-off-to-the-races-using-threadsanitizer-in-ocaml/#a-practical-example)"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div><a data-tooltip-position="top" aria-label="https://tarides.com/blog/2023-10-18-off-to-the-races-using-threadsanitizer-in-ocaml/#a-practical-example" rel="noopener" class="external-link" href="https://tarides.com/blog/2023-10-18-off-to-the-races-using-threadsanitizer-in-ocaml/#a-practical-example" target="_blank"></a></h3><div class="heading-children"></div></div><div class="heading-wrapper"><h3 data-heading="A Practical Example" dir="auto" class="heading" id="A_Practical_Example"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>A Practical Example</h3><div class="heading-children"><div><p dir="auto">Let us consider how a data race might occur. Say an OCaml programmer writes code to populate a table of clients from several sources. They decide to make it Multicore to improve performance by using two <code>Domain</code>s for two data sources:</p></div><div><pre class="language-ocaml" tabindex="0"><code class="language-ocaml is-loaded"><span class="token keyword">let</span> clients <span class="token operator">=</span> Hashtbl<span class="token punctuation">.</span>create <span class="token number">16</span>
<span class="token keyword">let</span> free_id <span class="token operator">=</span> Atomic<span class="token punctuation">.</span>make <span class="token number">0</span>

<span class="token keyword">let</span> clients1 <span class="token operator">=</span> <span class="token comment">(* Some data source *)</span>

<span class="token keyword">let</span> clients2 <span class="token operator">=</span> <span class="token comment">(* Some data source *)</span>

<span class="token keyword">let</span> record_clients <span class="token operator">=</span>
  Seq<span class="token punctuation">.</span>iter
    <span class="token punctuation">(</span><span class="token keyword">fun</span> c <span class="token operator">-&gt;</span> Hashtbl<span class="token punctuation">.</span>add clients <span class="token punctuation">(</span>Atomic<span class="token punctuation">.</span>fetch_and_add free_id <span class="token number">1</span><span class="token punctuation">)</span> c<span class="token punctuation">)</span>

<span class="token keyword">let</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span>
  <span class="token keyword">let</span> d <span class="token operator">=</span> Domain<span class="token punctuation">.</span>spawn <span class="token punctuation">(</span><span class="token keyword">fun</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> record_clients clients1<span class="token punctuation">)</span> <span class="token keyword">in</span>
  record_clients clients2<span class="token punctuation">;</span>
  Domain<span class="token punctuation">.</span>join d
</code><button class="copy-code-button">Copy</button></pre></div><div><p dir="auto">As we can tell, each incoming client is bound to a unique ID. The programmer correctly used the <code>Atomic</code> module for ID generation, ensuring the IDs are truly unique. However, they have failed to use a domain-safe module designed for concurrency, instead opting for <code>Hashtbl</code>. Unfortunately, this module is unsafe for concurrent use: using <code>Hashtbl.t</code> in parallel can cause data races and lead to surprising results.</p></div><div><p dir="auto">For example, when two domains add elements in parallel it may cause some elements to be silently dropped. To make matters worse, the resulting bugs would be non-deterministic and as such be hard to detect and track down. Furthermore, if the programmer's project depends on libraries that use <code>Hashtbl</code>, it would make them unsafe to use in parallel without it necessarily being clear from their documentation.</p></div><div><p dir="auto">If, however, the programmer were to build their program on a special <code>opam</code> switch with a TSan-enabled compiler like this:</p></div><div><pre class="language-text" tabindex="0"><code class="language-text is-loaded">$ opam switch create 5.1.0+tsan
$ opam install dune
$ dune exec ./clients.exe
</code><button class="copy-code-button">Copy</button></pre></div><div><p dir="auto">(Side note: the <code>5.1.0+tsan</code> switch is the most convenient way to use TSan with OCaml at the time of writing. Once OCaml 5.2 is released, the blessed command will be <code>opam switch create &lt;switch name&gt; ocaml-option-tsan</code>.)</p></div><div><p dir="auto">All memory accesses would be instrumented with calls to the TSan runtime, and TSan would detect the data race condition and output a data race report:</p></div><div><pre class="language-text" tabindex="0"><code class="language-text is-loaded">==================
WARNING: ThreadSanitizer: data race (pid=790576)
  Write of size 8 at 0x7f42b37f57e0 by main thread (mutexes: write M86):
    #0 caml_modify runtime/memory.c:166 (clients.exe+0x58b87d)
    #1 camlStdlib__Hashtbl.resize_749 stdlib/hashtbl.ml:152 (clients.exe+0x536766)
    #2 camlStdlib__Seq.iter_329 stdlib/seq.ml:76 (clients.exe+0x4c8a87)
    #3 camlDune__exe__Clients.entry /workspace_root/clients.ml:9 (clients.exe+0x4650ef)
    #4 caml_program &lt;null&gt; (clients.exe+0x45fefe)
    #5 caml_start_program &lt;null&gt; (clients.exe+0x5a0ae7)

  Previous read of size 8 at 0x7f42b37f57e0 by thread T1 (mutexes: write M90):
    #0 camlStdlib__Hashtbl.key_index_1308 stdlib/hashtbl.ml:507 (clients.exe+0x53a625)
    #1 camlStdlib__Hashtbl.add_1312 stdlib/hashtbl.ml:511 (clients.exe+0x53a6f8)
    #2 camlStdlib__Seq.iter_329 stdlib/seq.ml:76 (clients.exe+0x4c8a87)
    #3 camlStdlib__Domain.body_703 stdlib/domain.ml:202 (clients.exe+0x50bf60)
    #4 caml_start_program &lt;null&gt; (clients.exe+0x5a0ae7)
    #5 caml_callback_exn runtime/callback.c:197 (clients.exe+0x56917b)
    #6 caml_callback runtime/callback.c:293 (clients.exe+0x569cb0)
    #7 domain_thread_func runtime/domain.c:1100 (clients.exe+0x56d37f)
    [...]

SUMMARY: ThreadSanitizer: data race runtime/memory.c:166 in caml_modify
==================
[...]
ThreadSanitizer: reported 2 warnings
</code><button class="copy-code-button">Copy</button></pre><div><pre class="dataview dataview-error">Dataview (inline field '=================
WARNING: ThreadSanitizer: data race (pid=790576)
  Write of size 8 at 0x7f42b37f57e0 by main thread (mutexes: write M86):
    #0 caml_modify runtime/memory.c:166 (clients.exe+0x58b87d)
    #1 camlStdlib__Hashtbl.resize_749 stdlib/hashtbl.ml:152 (clients.exe+0x536766)
    #2 camlStdlib__Seq.iter_329 stdlib/seq.ml:76 (clients.exe+0x4c8a87)
    #3 camlDune__exe__Clients.entry /workspace_root/clients.ml:9 (clients.exe+0x4650ef)
    #4 caml_program &lt;null&gt; (clients.exe+0x45fefe)
    #5 caml_start_program &lt;null&gt; (clients.exe+0x5a0ae7)

  Previous read of size 8 at 0x7f42b37f57e0 by thread T1 (mutexes: write M90):
    #0 camlStdlib__Hashtbl.key_index_1308 stdlib/hashtbl.ml:507 (clients.exe+0x53a625)
    #1 camlStdlib__Hashtbl.add_1312 stdlib/hashtbl.ml:511 (clients.exe+0x53a6f8)
    #2 camlStdlib__Seq.iter_329 stdlib/seq.ml:76 (clients.exe+0x4c8a87)
    #3 camlStdlib__Domain.body_703 stdlib/domain.ml:202 (clients.exe+0x50bf60)
    #4 caml_start_program &lt;null&gt; (clients.exe+0x5a0ae7)
    #5 caml_callback_exn runtime/callback.c:197 (clients.exe+0x56917b)
    #6 caml_callback runtime/callback.c:293 (clients.exe+0x569cb0)
    #7 domain_thread_func runtime/domain.c:1100 (clients.exe+0x56d37f)
    [...]

SUMMARY: ThreadSanitizer: data race runtime/memory.c:166 in caml_modify
==================
[...]
ThreadSanitizer: reported 2 warnings'): Error: 
-- PARSING FAILED --------------------------------------------------

&gt; 1 | =================
    | ^
  2 | WARNING: ThreadSanitizer: data race (pid=790576)
  3 |   Write of size 8 at 0x7f42b37f57e0 by main thread (mutexes: write M86):

Expected one of the following: 

'(', 'null', boolean, date, duration, file link, list ('[1, 2, 3]'), negated field, number, object ('{ a: 1, b: 2 }'), string, variable
</pre></div></div><div><p dir="auto">Above is a truncated view of what the TSan report, warning of a data race, looks like in this case. TSan has detected two memory accesses, a write and a read, made to one memory location. As they are also unordered, this constitutes a data race and TSan reports it along with the backtraces of both accesses.</p></div><div><p dir="auto">In this case it would be evident that something has gone wrong with <code>Hashtbl.add</code> – a big hint to the programmer.</p></div></div></div></div></div><div class="heading-wrapper"><h2 data-heading="[](https://tarides.com/blog/2023-10-18-off-to-the-races-using-threadsanitizer-in-ocaml/#under-the-hood)" dir="auto" class="heading" id="[](https://tarides.com/blog/2023-10-18-off-to-the-races-using-threadsanitizer-in-ocaml/#under-the-hood)"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div><a data-tooltip-position="top" aria-label="https://tarides.com/blog/2023-10-18-off-to-the-races-using-threadsanitizer-in-ocaml/#under-the-hood" rel="noopener" class="external-link" href="https://tarides.com/blog/2023-10-18-off-to-the-races-using-threadsanitizer-in-ocaml/#under-the-hood" target="_blank"></a></h2><div class="heading-children"></div></div><div class="heading-wrapper"><h2 data-heading="Under the Hood" dir="auto" class="heading" id="Under_the_Hood"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>Under the Hood</h2><div class="heading-children"><div><p dir="auto">Now that we know what TSan is used for, it's time to explore how it works. Compiling a program with TSan enabled causes the executable to be instrumented with calls to the TSan runtime library. The runtime library tracks memory accesses and ordering relations between these accesses.</p></div><div><p dir="auto">Internally, the TSan runtime assigns a vector clock to each OCaml domain or system thread. Each thread holds a vector clock – a vector clock being an array of <em>n</em> integers, where <em>n</em> is the number of threads – and increments its clock upon each event (memory access, mutex operation, etc.). Certain operations like mutex locks, atomic reads, and so on, will synchronise clocks between threads.</p></div><div><p dir="auto"><a data-tooltip-position="top" aria-label="https://tarides.com/static/0bf64db362ac972b1285ab93f569b53a/798d4/vector-clocks.png" rel="noopener" class="external-link" href="https://tarides.com/static/0bf64db362ac972b1285ab93f569b53a/798d4/vector-clocks.png" target="_blank"><img alt="A mutex lock synchronising the clock between two threads." src="https://tarides.com/static/0bf64db362ac972b1285ab93f569b53a/c5bb3/vector-clocks.png" referrerpolicy="no-referrer"></a></p></div><div><p dir="auto">Comparing vector clocks allows TSan to establish an order between events, so-called <a data-tooltip-position="top" aria-label="https://jameshfisher.com/2017/02/10/happened-before/" rel="noopener" class="external-link" href="https://jameshfisher.com/2017/02/10/happened-before/" target="_blank">happens-before relations.</a> TSan reports a data race every time two memory accesses are made to overlapping memory regions, <strong>if:</strong></p></div><div><ul>
<li data-line="0" dir="auto">At least one of them is a write, and</li>
<li data-line="1" dir="auto">There is no established happens-before relation between them.</li>
</ul></div><div class="heading-wrapper"><h3 data-heading="[](https://tarides.com/blog/2023-10-18-off-to-the-races-using-threadsanitizer-in-ocaml/#shadow-state)" dir="auto" class="heading" id="[](https://tarides.com/blog/2023-10-18-off-to-the-races-using-threadsanitizer-in-ocaml/#shadow-state)"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div><a data-tooltip-position="top" aria-label="https://tarides.com/blog/2023-10-18-off-to-the-races-using-threadsanitizer-in-ocaml/#shadow-state" rel="noopener" class="external-link" href="https://tarides.com/blog/2023-10-18-off-to-the-races-using-threadsanitizer-in-ocaml/#shadow-state" target="_blank"></a></h3><div class="heading-children"></div></div><div class="heading-wrapper"><h3 data-heading="Shadow State" dir="auto" class="heading" id="Shadow_State"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>Shadow State</h3><div class="heading-children"><div><p dir="auto">Let us look at this process in more detail. Each word of application memory is associated with one or more 'shadow words'. Each shadow word contains information about a recent memory access to that word. This information points to the vector clock's state at the moment the access was performed.</p></div><div><p dir="auto"><a data-tooltip-position="top" aria-label="https://tarides.com/static/805211c514eae2a5f8a8410fd26f476a/d125e/shadow-state.png" rel="noopener" class="external-link" href="https://tarides.com/static/805211c514eae2a5f8a8410fd26f476a/d125e/shadow-state.png" target="_blank"><img alt="A box labelled application with an arrow to a box labeled shadow state." src="https://tarides.com/static/805211c514eae2a5f8a8410fd26f476a/c5bb3/shadow-state.png" referrerpolicy="no-referrer"></a></p></div><div><p dir="auto">This information (called the 'shadow state') is updated at every instrumented memory access: TSan compares the accessor's clock with each existing shadow word, and checks the following:</p></div><div><ul>
<li data-line="0" dir="auto">Do the accesses overlap?</li>
<li data-line="1" dir="auto">Is one of them a write?</li>
<li data-line="2" dir="auto">Are the thread IDs different?</li>
<li data-line="3" dir="auto">Are they unordered by happens-before?</li>
</ul></div><div><p dir="auto">If these conditions are met, TSan detects and reports a data race.</p></div><div><p dir="auto">In addition to memory access, operations like <code>Domain.spawn</code> and <code>Domain.join</code> (as well as mutex operations) are relevant for operation ordering. As such, TSan also instruments these operations.</p></div></div></div></div></div><div class="heading-wrapper"><h2 data-heading="[](https://tarides.com/blog/2023-10-18-off-to-the-races-using-threadsanitizer-in-ocaml/#integrating-tsan-with-ocaml)" dir="auto" class="heading" id="[](https://tarides.com/blog/2023-10-18-off-to-the-races-using-threadsanitizer-in-ocaml/#integrating-tsan-with-ocaml)"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div><a data-tooltip-position="top" aria-label="https://tarides.com/blog/2023-10-18-off-to-the-races-using-threadsanitizer-in-ocaml/#integrating-tsan-with-ocaml" rel="noopener" class="external-link" href="https://tarides.com/blog/2023-10-18-off-to-the-races-using-threadsanitizer-in-ocaml/#integrating-tsan-with-ocaml" target="_blank"></a></h2><div class="heading-children"></div></div><div class="heading-wrapper"><h2 data-heading="Integrating TSan with OCaml" dir="auto" class="heading" id="Integrating_TSan_with_OCaml"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>Integrating TSan with OCaml</h2><div class="heading-children"><div><p dir="auto">The core of TSan support is instrumentation of memory acceses with calls to the TSan runtime. The OCaml compiler performs this instrumentation in a dedicated pass.</p></div><div class="heading-wrapper"><h3 data-heading="[](https://tarides.com/blog/2023-10-18-off-to-the-races-using-threadsanitizer-in-ocaml/#exceptions)" dir="auto" class="heading" id="[](https://tarides.com/blog/2023-10-18-off-to-the-races-using-threadsanitizer-in-ocaml/#exceptions)"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div><a data-tooltip-position="top" aria-label="https://tarides.com/blog/2023-10-18-off-to-the-races-using-threadsanitizer-in-ocaml/#exceptions" rel="noopener" class="external-link" href="https://tarides.com/blog/2023-10-18-off-to-the-races-using-threadsanitizer-in-ocaml/#exceptions" target="_blank"></a></h3><div class="heading-children"></div></div><div class="heading-wrapper"><h3 data-heading="Exceptions" dir="auto" class="heading" id="Exceptions"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>Exceptions</h3><div class="heading-children"><div><p dir="auto">For TSan to show a backtrace of past events, function entries and exits must also be instrumented. This is done as part of the instrumentation pass.</p></div><div><p dir="auto">However, in OCaml, a function can also be exited by an <a data-tooltip-position="top" aria-label="https://github.com/fabbing/obts_exn" rel="noopener" class="external-link" href="https://github.com/fabbing/obts_exn" target="_blank">exception</a>, bypassing part of the instrumentation. When that happens, for TSan’s view of the backtrace to remain up-to-date, the OCaml runtime informs TSan about every exited function.</p></div></div></div><div class="heading-wrapper"><h3 data-heading="[](https://tarides.com/blog/2023-10-18-off-to-the-races-using-threadsanitizer-in-ocaml/#effect-handlers)" dir="auto" class="heading" id="[](https://tarides.com/blog/2023-10-18-off-to-the-races-using-threadsanitizer-in-ocaml/#effect-handlers)"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div><a data-tooltip-position="top" aria-label="https://tarides.com/blog/2023-10-18-off-to-the-races-using-threadsanitizer-in-ocaml/#effect-handlers" rel="noopener" class="external-link" href="https://tarides.com/blog/2023-10-18-off-to-the-races-using-threadsanitizer-in-ocaml/#effect-handlers" target="_blank"></a></h3><div class="heading-children"></div></div><div class="heading-wrapper"><h3 data-heading="Effect Handlers" dir="auto" class="heading" id="Effect_Handlers"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>Effect Handlers</h3><div class="heading-children"><div><p dir="auto"><a data-tooltip-position="top" aria-label="https://v2.ocaml.org/manual/effects.html" rel="noopener" class="external-link" href="https://v2.ocaml.org/manual/effects.html" target="_blank">Effect handlers</a> are a generalisation of exception handlers. Performing an effect results in a jump to the associated effect handler, and then a delimited continuation makes it possible to resume the computation. In the same way as with exceptions, the OCaml runtime must signal to TSan which functions are exited when an effect is performed and re-entered when a continuation is resumed.</p></div></div></div><div class="heading-wrapper"><h3 data-heading="[](https://tarides.com/blog/2023-10-18-off-to-the-races-using-threadsanitizer-in-ocaml/#memory-model)" dir="auto" class="heading" id="[](https://tarides.com/blog/2023-10-18-off-to-the-races-using-threadsanitizer-in-ocaml/#memory-model)"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div><a data-tooltip-position="top" aria-label="https://tarides.com/blog/2023-10-18-off-to-the-races-using-threadsanitizer-in-ocaml/#memory-model" rel="noopener" class="external-link" href="https://tarides.com/blog/2023-10-18-off-to-the-races-using-threadsanitizer-in-ocaml/#memory-model" target="_blank"></a></h3><div class="heading-children"></div></div><div class="heading-wrapper"><h3 data-heading="Memory Model" dir="auto" class="heading" id="Memory_Model"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>Memory Model</h3><div class="heading-children"><div><p dir="auto">Each language specifies how memory behaves in parallel programs using what is known as a memory model. Incidentally, what counts as a data race in a given language also depends on its memory model.</p></div><div><p dir="auto">TSan can detect data races in programs that follow the C memory model. OCaml 5's memory model is different from the C model, however, and it offers more guarantees: data races in C and C++ cause <em>undefined behaviour</em> (i.e., anything can happen), which is not the case in OCaml. OCaml's semantics are “fully defined” (see the <a data-tooltip-position="top" aria-label="https://v2.ocaml.org/manual/memorymodel.html" rel="noopener" class="external-link" href="https://v2.ocaml.org/manual/memorymodel.html" target="_blank">manual page</a> about the memory model). In particular, a program with data races in OCaml will not crash, unlike in C++. In addition, there can be no <a data-tooltip-position="top" aria-label="https://www.hboehm.info/c++mm/thin_air.html" rel="noopener" class="external-link" href="https://www.hboehm.info/c++mm/thin_air.html" target="_blank">out-of-thin-air values</a>: the only values that can be observed are values that are previously written to that location. The OCaml memory model guarantees that even for programs with data races, memory safety is preserved.</p></div><div><p dir="auto">Data races in OCaml can still result in unexpected surprises for the OCaml programmer. A multi-threaded execution may produce behaviours that cannot be explained by the mere interleaving of actions from different threads. The only way such behaviours can be explained is through a reordering of actions in the same thread. Such reasoning is quite unintuitive for a programmer who will be more used to thinking about program behaviour as being an interleaving of actions from different threads.</p></div><div><p dir="auto">However, if the program is data-race free, then the observed behaviour can be explained by a simple interleaving of operations from different threads (a property known as <em>sequential consistency</em>). Eliminating data races reduces non-determinism in the program and hence it is beneficial to remove data races whenever possible. Note that we do not completely eliminate non-determinism from a parallel program.</p></div><div><p dir="auto">In essence, because of the differences between the C and OCaml memory models, in order for TSan to detect data races in OCaml the instrumentation of memory accesses must <em>conceptually</em> map OCaml programs to C programs. During development, the team took care to ensure that this mapping preserved the detection of data races (in the OCaml sense) and did not introduce false positives.</p></div><div><p dir="auto">You can find more details about the inner workings of TSan and its OCaml support in this <a data-tooltip-position="top" aria-label="https://github.com/fabbing/ocaml_tsan_icfp/blob/master/presentation/presentation.pdf" rel="noopener" class="external-link" href="https://github.com/fabbing/ocaml_tsan_icfp/blob/master/presentation/presentation.pdf" target="_blank">OCaml Workshop 2023 talk</a>.</p></div></div></div><div class="heading-wrapper"><h3 data-heading="[](https://tarides.com/blog/2023-10-18-off-to-the-races-using-threadsanitizer-in-ocaml/#performance-and-limitations)" dir="auto" class="heading" id="[](https://tarides.com/blog/2023-10-18-off-to-the-races-using-threadsanitizer-in-ocaml/#performance-and-limitations)"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div><a data-tooltip-position="top" aria-label="https://tarides.com/blog/2023-10-18-off-to-the-races-using-threadsanitizer-in-ocaml/#performance-and-limitations" rel="noopener" class="external-link" href="https://tarides.com/blog/2023-10-18-off-to-the-races-using-threadsanitizer-in-ocaml/#performance-and-limitations" target="_blank"></a></h3><div class="heading-children"></div></div><div class="heading-wrapper"><h3 data-heading="Performance and Limitations" dir="auto" class="heading" id="Performance_and_Limitations"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>Performance and Limitations</h3><div class="heading-children"><div><p dir="auto">In terms of the cost of running TSan, currently, it affects memory and performance in the following ways:</p></div><div><ul>
<li data-line="0" dir="auto">Performance cost: about a 2-7x slowdown (compared to 5-15x for C/C++)</li>
<li data-line="1" dir="auto">Memory consumption: increased by about 4-7x (compared to 5-10x for C++)</li>
</ul></div><div><p dir="auto">As with all tools, TSan has some limitations. These are due to how TSan is built and are unlikely to change. With TSan, data races are only detected on visited code paths. In addition, TSan only remembers a finite amount of memory accesses for space-saving reasons, which can in principle cause TSan to miss some races. TSan also does not currently support Windows.</p></div><div><p dir="auto">TSan support for OCaml is currently only implemented for x86-64 Linux and macOS, but will hopefully be extended to include more architectures such as arm64.</p></div></div></div></div></div><div class="heading-wrapper"><h2 data-heading="[](https://tarides.com/blog/2023-10-18-off-to-the-races-using-threadsanitizer-in-ocaml/#use-cases)" dir="auto" class="heading" id="[](https://tarides.com/blog/2023-10-18-off-to-the-races-using-threadsanitizer-in-ocaml/#use-cases)"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div><a data-tooltip-position="top" aria-label="https://tarides.com/blog/2023-10-18-off-to-the-races-using-threadsanitizer-in-ocaml/#use-cases" rel="noopener" class="external-link" href="https://tarides.com/blog/2023-10-18-off-to-the-races-using-threadsanitizer-in-ocaml/#use-cases" target="_blank"></a></h2><div class="heading-children"></div></div><div class="heading-wrapper"><h2 data-heading="Use Cases" dir="auto" class="heading" id="Use_Cases"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>Use Cases</h2><div class="heading-children"><div><p dir="auto">Knowing the limitations, let us explore TSan's use cases. So far, TSan has helped by unearthing data races in several OCaml libraries:</p></div><div><ul>
<li data-line="0" dir="auto"><a data-tooltip-position="top" aria-label="https://github.com/ocaml-multicore/saturn" rel="noopener" class="external-link" href="https://github.com/ocaml-multicore/saturn" target="_blank">Saturn (formerly known as Lockfree):</a> TSan <a data-tooltip-position="top" aria-label="https://github.com/ocaml-multicore/saturn/issues/39" rel="noopener" class="external-link" href="https://github.com/ocaml-multicore/saturn/issues/39" target="_blank">found a benign data race</a>, as well as a data race occuring from the use of <a data-tooltip-position="top" aria-label="https://github.com/ocaml-multicore/saturn/pull/40" rel="noopener" class="external-link" href="https://github.com/ocaml-multicore/saturn/pull/40" target="_blank">semaphores</a>.</li>
<li data-line="1" dir="auto"><a data-tooltip-position="top" aria-label="https://github.com/ocaml-multicore/domainslib" rel="noopener" class="external-link" href="https://github.com/ocaml-multicore/domainslib" target="_blank">Domainslib:</a> TSan found benign data races in Chan, not just <a data-tooltip-position="top" aria-label="https://github.com/ocaml-multicore/domainslib/issues/72" rel="noopener" class="external-link" href="https://github.com/ocaml-multicore/domainslib/issues/72" target="_blank">once</a> but <a data-tooltip-position="top" aria-label="https://github.com/ocaml-multicore/domainslib/pull/103" rel="noopener" class="external-link" href="https://github.com/ocaml-multicore/domainslib/pull/103" target="_blank">twice</a>.</li>
<li data-line="2" dir="auto"><a data-tooltip-position="top" aria-label="https://github.com/ocaml/ocaml" rel="noopener" class="external-link" href="https://github.com/ocaml/ocaml" target="_blank">The OCaml runtime system</a> itself: TSan warned about a <a data-tooltip-position="top" aria-label="https://github.com/ocaml/ocaml/issues/11040" rel="noopener" class="external-link" href="https://github.com/ocaml/ocaml/issues/11040" target="_blank">number of race conditions</a> in the OCaml runtime.</li>
</ul></div><div><p dir="auto">In addition, TSan has been a great help in transitioning the effects-based I/O library <a data-tooltip-position="top" aria-label="https://github.com/ocaml-multicore/eio" rel="noopener" class="external-link" href="https://github.com/ocaml-multicore/eio" target="_blank">Eio</a> and the distributed database <a data-tooltip-position="top" aria-label="https://github.com/mirage/irmin" rel="noopener" class="external-link" href="https://github.com/mirage/irmin" target="_blank">Irmin</a> to Multicore. It allowed teams to detect potential data races and fix them as required.</p></div></div></div><div class="heading-wrapper"><h2 data-heading="[](https://tarides.com/blog/2023-10-18-off-to-the-races-using-threadsanitizer-in-ocaml/#feedback)" dir="auto" class="heading" id="[](https://tarides.com/blog/2023-10-18-off-to-the-races-using-threadsanitizer-in-ocaml/#feedback)"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div><a data-tooltip-position="top" aria-label="https://tarides.com/blog/2023-10-18-off-to-the-races-using-threadsanitizer-in-ocaml/#feedback" rel="noopener" class="external-link" href="https://tarides.com/blog/2023-10-18-off-to-the-races-using-threadsanitizer-in-ocaml/#feedback" target="_blank"></a></h2><div class="heading-children"></div></div><div class="heading-wrapper"><h2 data-heading="Feedback!" dir="auto" class="heading" id="Feedback!"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>Feedback!</h2><div class="heading-children"><div><p dir="auto">We want to hear from you – are you using TSan for your OCaml projects? Please get in touch and let us know about your experience, whether you have encountered any problems, and if you have any suggestions for how it could be improved.</p></div><div><p dir="auto">You can share your thoughts on the <a data-tooltip-position="top" aria-label="https://discuss.ocaml.org" rel="noopener" class="external-link" href="https://discuss.ocaml.org" target="_blank">OCaml Discuss Forum</a> or contact Tarides directly <a data-tooltip-position="top" aria-label="https://tarides.com/contact/" rel="noopener" class="external-link" href="https://tarides.com/contact/" target="_blank">on our website</a>. Don't forget to check out the <a data-tooltip-position="top" aria-label="https://ocaml.org/docs/multicore-transition" rel="noopener" class="external-link" href="https://ocaml.org/docs/multicore-transition" target="_blank">TSan tutorial</a> as well. Happy hacking!</p></div><div class="mod-footer"></div></div></div></div></div></div><div class="sidebar-right sidebar"><div class="sidebar-handle"></div><div class="sidebar-topbar"><div class="topbar-content"></div><div class="clickable-icon sidebar-collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" class="svg-icon"><path d="M21 3H3C1.89543 3 1 3.89543 1 5V19C1 20.1046 1.89543 21 3 21H21C22.1046 21 23 20.1046 23 19V5C23 3.89543 22.1046 3 21 3Z"></path><path d="M10 4V20"></path><path d="M4 7H7"></path><path d="M4 10H7"></path><path d="M4 13H7"></path></svg></div></div><div class="sidebar-content"><div class="graph-view-wrapper"><div class="sidebar-section-header">Interactive Graph</div><div class="graph-view-placeholder">
		<div class="graph-view-container">
			<div class="graph-icon graph-expand" role="button" aria-label="Expand" data-tooltip-position="top"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon"><line x1="7" y1="17" x2="17" y2="7"></line><polyline points="7 7 17 7 17 17"></polyline></svg></div>
			<canvas id="graph-canvas" class="hide" width="512px" height="512px"></canvas>
		</div>
		</div></div><div class="tree-container mod-root nav-folder tree-item outline-tree" data-depth="0"><div class="tree-header"><span class="sidebar-section-header">Table Of Contents</span><button class="clickable-icon collapse-tree-button" aria-label="Collapse All"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></svg></button></div><div class="tree-scroll-area tree-item-children nav-folder-children"><div class="tree-item mod-tree-folder nav-folder mod-collapsible is-collapsed" style="display: none;"></div><div class="tree-item" data-depth="1"><a class="tree-link" href="computer-science/programming-language/ocaml/off-to-the-races-using-threadsanitizer-in-ocaml.html#Off to the Races Using ThreadSanitizer in OCaml"><div class="tree-item-contents heading-link" heading-name="Off to the Races Using ThreadSanitizer in OCaml"><span class="tree-item-title">Off to the Races Using ThreadSanitizer in OCaml</span></div></a><div class="tree-item-children nav-folder-children"><div class="tree-item" data-depth="2"><a class="tree-link" href="computer-science/programming-language/ocaml/off-to-the-races-using-threadsanitizer-in-ocaml.html#[](https://tarides.com/blog/2023-10-18-off-to-the-races-using-threadsanitizer-in-ocaml/#what-is-tsan)"><div class="tree-item-contents heading-link" heading-name="[](https://tarides.com/blog/2023-10-18-off-to-the-races-using-threadsanitizer-in-ocaml/#what-is-tsan)"><span class="tree-item-title"><a data-tooltip-position="top" aria-label="https://tarides.com/blog/2023-10-18-off-to-the-races-using-threadsanitizer-in-ocaml/#what-is-tsan" rel="noopener" class="external-link" href="https://tarides.com/blog/2023-10-18-off-to-the-races-using-threadsanitizer-in-ocaml/#what-is-tsan" target="_blank"></a></span></div></a><div class="tree-item-children nav-folder-children"></div></div><div class="tree-item mod-collapsible" data-depth="2"><a class="tree-link" href="computer-science/programming-language/ocaml/off-to-the-races-using-threadsanitizer-in-ocaml.html#What_is_TSan?"><div class="tree-item-contents heading-link" heading-name="What is TSan?"><div class="collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div><span class="tree-item-title">What is TSan?</span></div></a><div class="tree-item-children nav-folder-children"><div class="tree-item" data-depth="3"><a class="tree-link" href="computer-science/programming-language/ocaml/off-to-the-races-using-threadsanitizer-in-ocaml.html#[](https://tarides.com/blog/2023-10-18-off-to-the-races-using-threadsanitizer-in-ocaml/#a-practical-example)"><div class="tree-item-contents heading-link" heading-name="[](https://tarides.com/blog/2023-10-18-off-to-the-races-using-threadsanitizer-in-ocaml/#a-practical-example)"><span class="tree-item-title"><a data-tooltip-position="top" aria-label="https://tarides.com/blog/2023-10-18-off-to-the-races-using-threadsanitizer-in-ocaml/#a-practical-example" rel="noopener" class="external-link" href="https://tarides.com/blog/2023-10-18-off-to-the-races-using-threadsanitizer-in-ocaml/#a-practical-example" target="_blank"></a></span></div></a><div class="tree-item-children nav-folder-children"></div></div><div class="tree-item" data-depth="3"><a class="tree-link" href="computer-science/programming-language/ocaml/off-to-the-races-using-threadsanitizer-in-ocaml.html#A_Practical_Example"><div class="tree-item-contents heading-link" heading-name="A Practical Example"><span class="tree-item-title">A Practical Example</span></div></a><div class="tree-item-children nav-folder-children"></div></div></div></div><div class="tree-item" data-depth="2"><a class="tree-link" href="computer-science/programming-language/ocaml/off-to-the-races-using-threadsanitizer-in-ocaml.html#[](https://tarides.com/blog/2023-10-18-off-to-the-races-using-threadsanitizer-in-ocaml/#under-the-hood)"><div class="tree-item-contents heading-link" heading-name="[](https://tarides.com/blog/2023-10-18-off-to-the-races-using-threadsanitizer-in-ocaml/#under-the-hood)"><span class="tree-item-title"><a data-tooltip-position="top" aria-label="https://tarides.com/blog/2023-10-18-off-to-the-races-using-threadsanitizer-in-ocaml/#under-the-hood" rel="noopener" class="external-link" href="https://tarides.com/blog/2023-10-18-off-to-the-races-using-threadsanitizer-in-ocaml/#under-the-hood" target="_blank"></a></span></div></a><div class="tree-item-children nav-folder-children"></div></div><div class="tree-item mod-collapsible" data-depth="2"><a class="tree-link" href="computer-science/programming-language/ocaml/off-to-the-races-using-threadsanitizer-in-ocaml.html#Under_the_Hood"><div class="tree-item-contents heading-link" heading-name="Under the Hood"><div class="collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div><span class="tree-item-title">Under the Hood</span></div></a><div class="tree-item-children nav-folder-children"><div class="tree-item" data-depth="3"><a class="tree-link" href="computer-science/programming-language/ocaml/off-to-the-races-using-threadsanitizer-in-ocaml.html#[](https://tarides.com/blog/2023-10-18-off-to-the-races-using-threadsanitizer-in-ocaml/#shadow-state)"><div class="tree-item-contents heading-link" heading-name="[](https://tarides.com/blog/2023-10-18-off-to-the-races-using-threadsanitizer-in-ocaml/#shadow-state)"><span class="tree-item-title"><a data-tooltip-position="top" aria-label="https://tarides.com/blog/2023-10-18-off-to-the-races-using-threadsanitizer-in-ocaml/#shadow-state" rel="noopener" class="external-link" href="https://tarides.com/blog/2023-10-18-off-to-the-races-using-threadsanitizer-in-ocaml/#shadow-state" target="_blank"></a></span></div></a><div class="tree-item-children nav-folder-children"></div></div><div class="tree-item" data-depth="3"><a class="tree-link" href="computer-science/programming-language/ocaml/off-to-the-races-using-threadsanitizer-in-ocaml.html#Shadow_State"><div class="tree-item-contents heading-link" heading-name="Shadow State"><span class="tree-item-title">Shadow State</span></div></a><div class="tree-item-children nav-folder-children"></div></div></div></div><div class="tree-item" data-depth="2"><a class="tree-link" href="computer-science/programming-language/ocaml/off-to-the-races-using-threadsanitizer-in-ocaml.html#[](https://tarides.com/blog/2023-10-18-off-to-the-races-using-threadsanitizer-in-ocaml/#integrating-tsan-with-ocaml)"><div class="tree-item-contents heading-link" heading-name="[](https://tarides.com/blog/2023-10-18-off-to-the-races-using-threadsanitizer-in-ocaml/#integrating-tsan-with-ocaml)"><span class="tree-item-title"><a data-tooltip-position="top" aria-label="https://tarides.com/blog/2023-10-18-off-to-the-races-using-threadsanitizer-in-ocaml/#integrating-tsan-with-ocaml" rel="noopener" class="external-link" href="https://tarides.com/blog/2023-10-18-off-to-the-races-using-threadsanitizer-in-ocaml/#integrating-tsan-with-ocaml" target="_blank"></a></span></div></a><div class="tree-item-children nav-folder-children"></div></div><div class="tree-item mod-collapsible" data-depth="2"><a class="tree-link" href="computer-science/programming-language/ocaml/off-to-the-races-using-threadsanitizer-in-ocaml.html#Integrating_TSan_with_OCaml"><div class="tree-item-contents heading-link" heading-name="Integrating TSan with OCaml"><div class="collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div><span class="tree-item-title">Integrating TSan with OCaml</span></div></a><div class="tree-item-children nav-folder-children"><div class="tree-item" data-depth="3"><a class="tree-link" href="computer-science/programming-language/ocaml/off-to-the-races-using-threadsanitizer-in-ocaml.html#[](https://tarides.com/blog/2023-10-18-off-to-the-races-using-threadsanitizer-in-ocaml/#exceptions)"><div class="tree-item-contents heading-link" heading-name="[](https://tarides.com/blog/2023-10-18-off-to-the-races-using-threadsanitizer-in-ocaml/#exceptions)"><span class="tree-item-title"><a data-tooltip-position="top" aria-label="https://tarides.com/blog/2023-10-18-off-to-the-races-using-threadsanitizer-in-ocaml/#exceptions" rel="noopener" class="external-link" href="https://tarides.com/blog/2023-10-18-off-to-the-races-using-threadsanitizer-in-ocaml/#exceptions" target="_blank"></a></span></div></a><div class="tree-item-children nav-folder-children"></div></div><div class="tree-item" data-depth="3"><a class="tree-link" href="computer-science/programming-language/ocaml/off-to-the-races-using-threadsanitizer-in-ocaml.html#Exceptions"><div class="tree-item-contents heading-link" heading-name="Exceptions"><span class="tree-item-title">Exceptions</span></div></a><div class="tree-item-children nav-folder-children"></div></div><div class="tree-item" data-depth="3"><a class="tree-link" href="computer-science/programming-language/ocaml/off-to-the-races-using-threadsanitizer-in-ocaml.html#[](https://tarides.com/blog/2023-10-18-off-to-the-races-using-threadsanitizer-in-ocaml/#effect-handlers)"><div class="tree-item-contents heading-link" heading-name="[](https://tarides.com/blog/2023-10-18-off-to-the-races-using-threadsanitizer-in-ocaml/#effect-handlers)"><span class="tree-item-title"><a data-tooltip-position="top" aria-label="https://tarides.com/blog/2023-10-18-off-to-the-races-using-threadsanitizer-in-ocaml/#effect-handlers" rel="noopener" class="external-link" href="https://tarides.com/blog/2023-10-18-off-to-the-races-using-threadsanitizer-in-ocaml/#effect-handlers" target="_blank"></a></span></div></a><div class="tree-item-children nav-folder-children"></div></div><div class="tree-item" data-depth="3"><a class="tree-link" href="computer-science/programming-language/ocaml/off-to-the-races-using-threadsanitizer-in-ocaml.html#Effect_Handlers"><div class="tree-item-contents heading-link" heading-name="Effect Handlers"><span class="tree-item-title">Effect Handlers</span></div></a><div class="tree-item-children nav-folder-children"></div></div><div class="tree-item" data-depth="3"><a class="tree-link" href="computer-science/programming-language/ocaml/off-to-the-races-using-threadsanitizer-in-ocaml.html#[](https://tarides.com/blog/2023-10-18-off-to-the-races-using-threadsanitizer-in-ocaml/#memory-model)"><div class="tree-item-contents heading-link" heading-name="[](https://tarides.com/blog/2023-10-18-off-to-the-races-using-threadsanitizer-in-ocaml/#memory-model)"><span class="tree-item-title"><a data-tooltip-position="top" aria-label="https://tarides.com/blog/2023-10-18-off-to-the-races-using-threadsanitizer-in-ocaml/#memory-model" rel="noopener" class="external-link" href="https://tarides.com/blog/2023-10-18-off-to-the-races-using-threadsanitizer-in-ocaml/#memory-model" target="_blank"></a></span></div></a><div class="tree-item-children nav-folder-children"></div></div><div class="tree-item" data-depth="3"><a class="tree-link" href="computer-science/programming-language/ocaml/off-to-the-races-using-threadsanitizer-in-ocaml.html#Memory_Model"><div class="tree-item-contents heading-link" heading-name="Memory Model"><span class="tree-item-title">Memory Model</span></div></a><div class="tree-item-children nav-folder-children"></div></div><div class="tree-item" data-depth="3"><a class="tree-link" href="computer-science/programming-language/ocaml/off-to-the-races-using-threadsanitizer-in-ocaml.html#[](https://tarides.com/blog/2023-10-18-off-to-the-races-using-threadsanitizer-in-ocaml/#performance-and-limitations)"><div class="tree-item-contents heading-link" heading-name="[](https://tarides.com/blog/2023-10-18-off-to-the-races-using-threadsanitizer-in-ocaml/#performance-and-limitations)"><span class="tree-item-title"><a data-tooltip-position="top" aria-label="https://tarides.com/blog/2023-10-18-off-to-the-races-using-threadsanitizer-in-ocaml/#performance-and-limitations" rel="noopener" class="external-link" href="https://tarides.com/blog/2023-10-18-off-to-the-races-using-threadsanitizer-in-ocaml/#performance-and-limitations" target="_blank"></a></span></div></a><div class="tree-item-children nav-folder-children"></div></div><div class="tree-item" data-depth="3"><a class="tree-link" href="computer-science/programming-language/ocaml/off-to-the-races-using-threadsanitizer-in-ocaml.html#Performance_and_Limitations"><div class="tree-item-contents heading-link" heading-name="Performance and Limitations"><span class="tree-item-title">Performance and Limitations</span></div></a><div class="tree-item-children nav-folder-children"></div></div></div></div><div class="tree-item" data-depth="2"><a class="tree-link" href="computer-science/programming-language/ocaml/off-to-the-races-using-threadsanitizer-in-ocaml.html#[](https://tarides.com/blog/2023-10-18-off-to-the-races-using-threadsanitizer-in-ocaml/#use-cases)"><div class="tree-item-contents heading-link" heading-name="[](https://tarides.com/blog/2023-10-18-off-to-the-races-using-threadsanitizer-in-ocaml/#use-cases)"><span class="tree-item-title"><a data-tooltip-position="top" aria-label="https://tarides.com/blog/2023-10-18-off-to-the-races-using-threadsanitizer-in-ocaml/#use-cases" rel="noopener" class="external-link" href="https://tarides.com/blog/2023-10-18-off-to-the-races-using-threadsanitizer-in-ocaml/#use-cases" target="_blank"></a></span></div></a><div class="tree-item-children nav-folder-children"></div></div><div class="tree-item" data-depth="2"><a class="tree-link" href="computer-science/programming-language/ocaml/off-to-the-races-using-threadsanitizer-in-ocaml.html#Use_Cases"><div class="tree-item-contents heading-link" heading-name="Use Cases"><span class="tree-item-title">Use Cases</span></div></a><div class="tree-item-children nav-folder-children"></div></div><div class="tree-item" data-depth="2"><a class="tree-link" href="computer-science/programming-language/ocaml/off-to-the-races-using-threadsanitizer-in-ocaml.html#[](https://tarides.com/blog/2023-10-18-off-to-the-races-using-threadsanitizer-in-ocaml/#feedback)"><div class="tree-item-contents heading-link" heading-name="[](https://tarides.com/blog/2023-10-18-off-to-the-races-using-threadsanitizer-in-ocaml/#feedback)"><span class="tree-item-title"><a data-tooltip-position="top" aria-label="https://tarides.com/blog/2023-10-18-off-to-the-races-using-threadsanitizer-in-ocaml/#feedback" rel="noopener" class="external-link" href="https://tarides.com/blog/2023-10-18-off-to-the-races-using-threadsanitizer-in-ocaml/#feedback" target="_blank"></a></span></div></a><div class="tree-item-children nav-folder-children"></div></div><div class="tree-item" data-depth="2"><a class="tree-link" href="computer-science/programming-language/ocaml/off-to-the-races-using-threadsanitizer-in-ocaml.html#Feedback!"><div class="tree-item-contents heading-link" heading-name="Feedback!"><span class="tree-item-title">Feedback!</span></div></a><div class="tree-item-children nav-folder-children"></div></div></div></div></div></div></div><script defer="">let rs = document.querySelector(".sidebar-right"); rs.classList.add("is-collapsed"); if (window.innerWidth > 768) rs.classList.remove("is-collapsed"); rs.style.setProperty("--sidebar-width", localStorage.getItem("sidebar-right-width"));</script></div></div></body></html>