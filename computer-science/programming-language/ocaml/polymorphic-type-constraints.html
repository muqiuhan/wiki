<!DOCTYPE html> <html><head>
		<title>Polymorphic type constraints</title>
		<base href="../../../">
		<meta id="root-path" root-path="../../../">
		<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes, minimum-scale=1.0, maximum-scale=5.0">
		<meta charset="UTF-8">
		<meta name="description" content="韩暮秋的个人维基 - Polymorphic type constraints">
		<meta property="og:title" content="Polymorphic type constraints">
		<meta property="og:description" content="韩暮秋的个人维基 - Polymorphic type constraints">
		<meta property="og:type" content="website">
		<meta property="og:url" content="https://muqiuhan.github.io/wiki/computer-science/programming-language/ocaml/polymorphic-type-constraints.html">
		<meta property="og:image" content="undefined">
		<meta property="og:site_name" content="韩暮秋的个人维基">
		<meta name="author" content="韩暮秋"><link rel="alternate" type="application/rss+xml" title="RSS Feed" href="https://muqiuhan.github.io/wiki/lib/rss.xml"><script async="" id="webpage-script" src="lib/scripts/webpage.js" onload="this.onload=null;this.setAttribute(&quot;loaded&quot;, &quot;true&quot;)"></script><script type="module" async="" id="graph-view-script" src="lib/scripts/graph-view.js"></script><script async="" id="graph-wasm-script" src="lib/scripts/graph-wasm.js" onload="this.onload=null;this.setAttribute(&quot;loaded&quot;, &quot;true&quot;)"></script><script async="" id="graph-render-worker-script" src="lib/scripts/graph-render-worker.js" onload="this.onload=null;this.setAttribute(&quot;loaded&quot;, &quot;true&quot;)"></script><script async="" id="tinycolor-script" src="lib/scripts/tinycolor.js" onload="this.onload=null;this.setAttribute(&quot;loaded&quot;, &quot;true&quot;)"></script><script async="" id="pixi-script" src="lib/scripts/pixi.js" onload="this.onload=null;this.setAttribute(&quot;loaded&quot;, &quot;true&quot;)"></script><script async="" id="minisearch-script" src="lib/scripts/minisearch.js" onload="this.onload=null;this.setAttribute(&quot;loaded&quot;, &quot;true&quot;)"></script><link rel="icon" href="lib/media/favicon.png"><script async="" id="graph-data-script" src="lib/scripts/graph-data.js" onload="this.onload=null;this.setAttribute(&quot;loaded&quot;, &quot;true&quot;)"></script><style>body{--line-width:40em;--line-width-adaptive:40em;--file-line-width:40em;--sidebar-width:min(20em, 80vw);--collapse-arrow-size:11px;--tree-horizontal-spacing:0.6em;--tree-vertical-spacing:0.6em;--sidebar-margin:12px}.sidebar{height:100%;min-width:calc(var(--sidebar-width) + var(--divider-width-hover));max-width:calc(var(--sidebar-width) + var(--divider-width-hover));font-size:14px;z-index:10;position:relative;overflow:hidden;transition:min-width ease-in-out,max-width ease-in-out;transition-duration:.2s;contain:size}.sidebar-left{left:0}.sidebar-right{right:0}.sidebar.is-collapsed{min-width:0;max-width:0}body.floating-sidebars .sidebar{position:absolute}.sidebar-content{height:100%;min-width:calc(var(--sidebar-width) - var(--divider-width-hover));top:0;padding:var(--sidebar-margin);padding-top:4em;line-height:var(--line-height-tight);background-color:var(--background-secondary);transition:background-color,border-right,border-left,box-shadow;transition-duration:var(--color-fade-speed);transition-timing-function:ease-in-out;position:absolute;display:flex;flex-direction:column}.sidebar:not(.is-collapsed) .sidebar-content{min-width:calc(max(100%,var(--sidebar-width)) - 3px);max-width:calc(max(100%,var(--sidebar-width)) - 3px)}.sidebar-left .sidebar-content{left:0;border-top-right-radius:var(--radius-l);border-bottom-right-radius:var(--radius-l)}.sidebar-right .sidebar-content{right:0;border-top-left-radius:var(--radius-l);border-bottom-left-radius:var(--radius-l)}.sidebar:has(.sidebar-content:empty):has(.topbar-content:empty){display:none}.sidebar-topbar{height:2em;width:var(--sidebar-width);top:var(--sidebar-margin);padding-inline:var(--sidebar-margin);z-index:1;position:fixed;display:flex;align-items:center;transition:width ease-in-out;transition-duration:inherit}.sidebar.is-collapsed .sidebar-topbar{width:calc(2.3em + var(--sidebar-margin) * 2)}.sidebar .sidebar-topbar.is-collapsed{width:0}.sidebar-left .sidebar-topbar{left:0}.sidebar-right .sidebar-topbar{right:0}.topbar-content{overflow:hidden;overflow:clip;width:100%;height:100%;display:flex;align-items:center;transition:inherit}.sidebar.is-collapsed .topbar-content{width:0;transition:inherit}.clickable-icon.sidebar-collapse-icon{background-color:transparent;color:var(--icon-color-focused);padding:0!important;margin:0!important;height:100%!important;width:2.3em!important;margin-inline:0.14em!important;position:absolute}.sidebar-left .clickable-icon.sidebar-collapse-icon{transform:rotateY(180deg);right:var(--sidebar-margin)}.sidebar-right .clickable-icon.sidebar-collapse-icon{transform:rotateY(180deg);left:var(--sidebar-margin)}.clickable-icon.sidebar-collapse-icon svg.svg-icon{width:100%;height:100%}.sidebar-section-header{margin:0 0 1em 0;text-transform:uppercase;letter-spacing:.06em;font-weight:600}body{transition:background-color var(--color-fade-speed) ease-in-out}.webpage-container{display:flex;flex-direction:row;height:100%;width:100%;align-items:stretch;justify-content:center}.document-container{opacity:1;flex-basis:100%;max-width:100%;width:100%;height:100%;display:flex;flex-direction:column;align-items:center;transition:opacity .2s ease-in-out;contain:inline-size}.hide{opacity:0;transition:opacity .2s ease-in-out}.document-container>.markdown-preview-view{margin:var(--sidebar-margin);margin-bottom:0;width:100%;width:-webkit-fill-available;width:-moz-available;width:fill-available;background-color:var(--background-primary);transition:background-color var(--color-fade-speed) ease-in-out;border-top-right-radius:var(--window-radius,var(--radius-m));border-top-left-radius:var(--window-radius,var(--radius-m));overflow-x:hidden!important;overflow-y:auto!important;display:flex!important;flex-direction:column!important;align-items:center!important;contain:inline-size}.document-container>.markdown-preview-view>.markdown-preview-sizer{padding-bottom:80vh!important;width:100%!important;max-width:var(--line-width)!important;flex-basis:var(--line-width)!important;transition:background-color var(--color-fade-speed) ease-in-out;contain:inline-size}.markdown-rendered img:not([width]),.view-content img:not([width]){max-width:100%;outline:0}.document-container>.view-content.embed{display:flex;padding:1em;height:100%;width:100%;align-items:center;justify-content:center}.document-container>.view-content.embed>*{max-width:100%;max-height:100%;object-fit:contain}:has(> :is(.math,table)){overflow-x:auto!important}.document-container>.view-content{overflow-x:auto;contain:content;padding:0;margin:0;height:100%}.scroll-highlight{position:absolute;width:100%;height:100%;pointer-events:none;z-index:1000;background-color:hsla(var(--color-accent-hsl),.25);opacity:0;padding:1em;inset:50%;translate:-50% -50%;border-radius:var(--radius-s)}</style><script defer="">async function loadIncludes(){if("file:"!=location.protocol){let e=document.querySelectorAll("include");for(let t=0;t<e.length;t++){let o=e[t],l=o.getAttribute("src");try{const e=await fetch(l);if(!e.ok){console.log("Could not include file: "+l),o?.remove();continue}let t=await e.text(),n=document.createRange().createContextualFragment(t),i=Array.from(n.children);for(let e of i)e.classList.add("hide"),e.style.transition="opacity 0.5s ease-in-out",setTimeout((()=>{e.classList.remove("hide")}),10);o.before(n),o.remove(),console.log("Included file: "+l)}catch(e){o?.remove(),console.log("Could not include file: "+l,e);continue}}}else{if(document.querySelectorAll("include").length>0){var e=document.createElement("div");e.id="error",e.textContent="Web server exports must be hosted on an http / web server to be viewed correctly.",e.style.position="fixed",e.style.top="50%",e.style.left="50%",e.style.transform="translate(-50%, -50%)",e.style.fontSize="1.5em",e.style.fontWeight="bold",e.style.textAlign="center",document.body.appendChild(e),document.querySelector(".document-container")?.classList.remove("hide")}}}document.addEventListener("DOMContentLoaded",(()=>{loadIncludes()}));let isFileProtocol="file:"==location.protocol;function waitLoadScripts(e,t){let o=e.map((e=>document.getElementById(e+"-script"))),l=0;!function e(){let n=o[l];l++,n&&"true"!=n.getAttribute("loaded")||l<o.length&&e(),l<o.length?n.addEventListener("load",e):t()}()}</script><link rel="stylesheet" href="lib/styles/obsidian.css"><link rel="preload" href="lib/styles/other-plugins.css" as="style" onload="this.onload=null;this.rel='stylesheet'"><noscript><link rel="stylesheet" href="lib/styles/other-plugins.css"></noscript><link rel="stylesheet" href="lib/styles/theme.css"><link rel="preload" href="lib/styles/global-variable-styles.css" as="style" onload="this.onload=null;this.rel='stylesheet'"><noscript><link rel="stylesheet" href="lib/styles/global-variable-styles.css"></noscript><link rel="preload" href="lib/styles/main-styles.css" as="style" onload="this.onload=null;this.rel='stylesheet'"><noscript><link rel="stylesheet" href="lib/styles/main-styles.css"></noscript></head><body class="publish css-settings-manager theme-light show-inline-title show-ribbon outliner-plugin-dnd h2-underline"><script defer="">let theme=localStorage.getItem("theme")||(window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light");"dark"==theme?(document.body.classList.add("theme-dark"),document.body.classList.remove("theme-light")):(document.body.classList.add("theme-light"),document.body.classList.remove("theme-dark")),window.innerWidth<480?document.body.classList.add("is-phone"):window.innerWidth<768?document.body.classList.add("is-tablet"):window.innerWidth<1024?document.body.classList.add("is-small-screen"):document.body.classList.add("is-large-screen")</script><div class="webpage-container workspace"><div class="sidebar-left sidebar"><div class="sidebar-handle"></div><div class="sidebar-topbar"><div class="topbar-content"><label class="theme-toggle-container" for="theme_toggle"><input class="theme-toggle-input" type="checkbox" id="theme_toggle"><div class="toggle-background"></div></label></div><div class="clickable-icon sidebar-collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" class="svg-icon"><path d="M21 3H3C1.89543 3 1 3.89543 1 5V19C1 20.1046 1.89543 21 3 21H21C22.1046 21 23 20.1046 23 19V5C23 3.89543 22.1046 3 21 3Z"></path><path d="M10 4V20"></path><path d="M4 7H7"></path><path d="M4 10H7"></path><path d="M4 13H7"></path></svg></div></div><div class="sidebar-content"><div class="search-input-container"><input enterkeyhint="search" type="search" spellcheck="false" placeholder="Search..."><div class="search-input-clear-button" aria-label="Clear search"></div></div><include src="lib/html/file-tree.html"></include></div><script defer="">let ls = document.querySelector(".sidebar-left"); ls.classList.add("is-collapsed"); if (window.innerWidth > 768) ls.classList.remove("is-collapsed"); ls.style.setProperty("--sidebar-width", localStorage.getItem("sidebar-left-width"));</script></div><div class="document-container markdown-reading-view hide"><div class="markdown-preview-view markdown-rendered allow-fold-headings allow-fold-lists is-readable-line-width"><style id="MJX-CHTML-styles"></style><div class="markdown-preview-sizer markdown-preview-section"><h1 class="page-title heading inline-title" id="Polymorphic type constraints"><p dir="auto">Polymorphic type constraints</p></h1><div class="el-p"><p dir="auto"><a href="?query=tag:ocaml" class="tag" target="_blank" rel="noopener nofollow">#ocaml</a> <a href="?query=tag:fp" class="tag" target="_blank" rel="noopener nofollow">#fp</a> <a href="?query=tag:typesystem" class="tag" target="_blank" rel="noopener nofollow">#typesystem</a></p></div><div class="el-blockquote"><blockquote dir="auto">
<p><em>In this post, I explain a common mistake when writing constraints of polymorphic functions in OCaml programs, then show how to correct it.</em></p>
</blockquote></div><div class="el-h2 heading-wrapper"><h2 data-heading="Not-so-polymorphic constraints" dir="auto" class="heading" id="Not-so-polymorphic_constraints"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>Not-so-polymorphic constraints</h2><div class="heading-children"><div class="el-p"><p dir="auto">One of the earliest lessons of any functional programming tutorial is how to write polymorphic functions and their signatures:</p></div><div class="el-pre"><pre class="language-ocaml" tabindex="0"><code data-line="0" class="language-ocaml is-loaded"><span class="token keyword">val</span> id  <span class="token punctuation">:</span> <span class="token type-variable function">'a</span> <span class="token operator">-&gt;</span> <span class="token type-variable function">'a</span>
<span class="token keyword">val</span> fst <span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token type-variable function">'a</span> <span class="token operator">*</span> <span class="token type-variable function">'b</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token type-variable function">'a</span>
<span class="token keyword">val</span> map <span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token type-variable function">'a</span> <span class="token operator">-&gt;</span> <span class="token type-variable function">'b</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token type-variable function">'a</span> list <span class="token operator">-&gt;</span> <span class="token type-variable function">'b</span> list
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">A typical explanation of these type signatures goes along the lines of:</p></div><div class="el-blockquote"><blockquote dir="auto">
<p><em>Types of the form <code>'a</code>, <code>'b</code>, ..., known as <strong>type variables</strong>, stand for an unknown type. They allow us to describe functions that work uniformly over many possible input types. This is known as "parametric polymorphism".</em></p>
<p>— Hypothetical education resource<a data-tooltip-position="top" aria-label="https://www.craigfe.io/posts/polymorphic-type-constraints#fn-1" rel="noopener nofollow" class="external-link" href="https://www.craigfe.io/posts/polymorphic-type-constraints#fn-1" target="_blank">1</a></p>
</blockquote></div><div class="el-p"><p dir="auto">As is often the case with introductory explanations, this is <em>just</em> specific enough to be technically correct without introducing too many new concepts, letting us hurry on to demonstrating useful examples before the student gets bored. Unfortunately, we've laid a trap: when our reader learns about type constraints, they naturally try to combine these two "intuitive" features and get bitten:</p></div><div class="el-pre"><pre class="language-ocaml" tabindex="0"><code data-line="0" class="language-ocaml is-loaded">ᐅ <span class="token keyword">let</span> id1 <span class="token punctuation">:</span> <span class="token type-variable function">'a</span> <span class="token operator">-&gt;</span> <span class="token type-variable function">'a</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">fun</span> x <span class="token operator">-&gt;</span> x<span class="token punctuation">)</span> <span class="token punctuation">;;</span>        <span class="token comment">(* Accepted. So far so good... *)</span>
  <span class="token keyword">val</span> id1 <span class="token punctuation">:</span> <span class="token type-variable function">'a</span> <span class="token operator">-&gt;</span> <span class="token type-variable function">'a</span> <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token keyword">fun</span><span class="token operator">&gt;</span>

ᐅ <span class="token keyword">let</span> id2 <span class="token punctuation">:</span> <span class="token type-variable function">'a</span> <span class="token operator">-&gt;</span> <span class="token type-variable function">'a</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">fun</span> x <span class="token operator">-&gt;</span> x <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">;;</span>    <span class="token comment">(* Also accepted. Uh oh... *)</span>
  <span class="token keyword">val</span> id2 <span class="token punctuation">:</span> int <span class="token operator">-&gt;</span> int <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token keyword">fun</span><span class="token operator">&gt;</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">In this case, the student finds that <code>'a -&gt; 'a</code> is a valid constraint for a function of type <code>int -&gt; int</code>, and their mental model is broken almost immediately. It's quite natural to expect <code>id2</code> to be rejected as a non-polymorphic function, particularly given our vague explanation of what <code>'a</code> actually means.</p></div><div class="el-p"><p dir="auto">Our hypothetical student's mistake stems from the fact that type variables in signatures are implicitly <em>universally-quantified</em> – that is, they stand for <em>all</em> types – whereas type variables in constraints are not. To understand what this means, let's try to pin down a more precise idea of what type variables <em>are</em>. If you're already &nbsp;<del>indoctrinated</del>&nbsp; comfortable with type variables, you may wish to <a data-tooltip-position="top" aria-label="https://www.craigfe.io/posts/polymorphic-type-constraints#true-polymorphic-constraints" rel="noopener nofollow" class="external-link" href="https://www.craigfe.io/posts/polymorphic-type-constraints#true-polymorphic-constraints" target="_blank">cut to the chase</a>.</p></div></div></div><div class="el-h2 heading-wrapper"><h2 data-heading="What is a type variable anyway?" dir="auto" class="heading" id="What_is_a_type_variable_anyway?"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>What is a type variable anyway?</h2><div class="heading-children"><div class="el-p"><p dir="auto">Type variables in constraints are referred to as being "unbound" (or "free"), meaning that they stand for <em>some</em> type that is not yet known to the type-checker: they are placeholders that can later be filled by a particular type. Without going into <a data-tooltip-position="top" aria-label="http://dev.stephendiehl.com/fun/006_hindley_milner.html" rel="noopener nofollow" class="external-link" href="http://dev.stephendiehl.com/fun/006_hindley_milner.html" target="_blank">the details</a>, these placeholders are gradually determined as the type-checker resolves constraints. For instance, in our <code>id2</code> example, the type-checker decides that <code>'a</code> equals <code>int</code> by first reconciling the user-supplied constraint <code>'a -&gt; 'a</code> with the constraint <code>int -&gt; int</code> that it inferred from the implementation.</p></div><div class="el-p"><p dir="auto">To a theorist (or type-system developer), who regularly has to worry about types that are not yet fully known, the notion of a "placeholder" is a sensible default meaning of an unbound type variable. Such people also tend to use explicit syntax to disambiguate the alternative case, type variables that <em>are</em> bound:</p></div><div class="el-blockquote"><blockquote dir="auto">
<p><code>∀ a. a -&gt; a</code> (read as: <em>"For all <code>a</code>, <code>a -&gt; a</code>"</em>)</p>
</blockquote></div><div class="el-p"><p dir="auto">We call "<code>∀ a</code>" a <em>universal quantifier</em> because it introduces a variable <code>a</code>, bound inside the quantifier, that can stand for any type in the universe of OCaml types. It's this flavour of type variable that enables parametric polymorphism and – although the OCaml syntax often tries to hide it from you – these quantifiers exist everywhere in your programs. As I already mentioned, all unbound variables in <em>signatures</em> are implicitly quantified in this way:</p></div><div class="el-blockquote"><blockquote dir="auto">
<p><code>val length : 'a list -&gt; int</code></p>
<p><em>... secretly means ...</em></p>
<p><code>val length : ∀ a. a list -&gt; int</code></p>
</blockquote></div><div class="el-p"><p dir="auto">On the implementation side of <code>length</code>, the compiler will check to see if there are any placeholder variables left after type-checking the definition and wrap them in universal quantifiers (if it's sure that it's safe to do so<a data-tooltip-position="top" aria-label="https://www.craigfe.io/posts/polymorphic-type-constraints#fn-2" rel="noopener nofollow" class="external-link" href="https://www.craigfe.io/posts/polymorphic-type-constraints#fn-2" target="_blank">2</a>). When this happens, we say that those type variables have been <em>generalised</em>. Once <code>length</code> has been given its polymorphic type, the user gets to pick a specific type <code>a</code> at each call-site by passing it a list of any element type they want. This idea of choosing the instantiation of <code>a</code> at each call-site is what is "parametric" about "parametric polymorphism".</p></div><div class="el-p"><p dir="auto">Taking a step back, we can now see what went wrong with our hypothetical introduction to type variables above: it led our student to think of all type variables as being implicitly universally-quantified, when this is not true in constraints<a data-tooltip-position="top" aria-label="https://www.craigfe.io/posts/polymorphic-type-constraints#fn-3" rel="noopener nofollow" class="external-link" href="https://www.craigfe.io/posts/polymorphic-type-constraints#fn-3" target="_blank">3</a>. So, given that we can't rely on implicit generalisation in constraints, what <em>can</em> we do to declare that our code is polymorphic within the implementation itself?</p></div></div></div><div class="el-h2 heading-wrapper"><h2 data-heading="True polymorphic constraints" dir="auto" class="heading" id="True_polymorphic_constraints"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>True polymorphic constraints</h2><div class="heading-children"><div class="el-p"><p dir="auto">The punchline is that OCaml actually <em>does</em> have syntax for expressing polymorphic constraints – and it even involves an explicit quantifier – but sadly it's not often taught to beginners:</p></div><div class="el-pre"><pre class="language-ocaml" tabindex="0"><code data-line="0" class="language-ocaml is-loaded"><span class="token keyword">let</span> id <span class="token punctuation">:</span> <span class="token type-variable function">'a</span><span class="token punctuation">.</span> <span class="token type-variable function">'a</span> <span class="token operator">-&gt;</span> <span class="token type-variable function">'a</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">fun</span> x <span class="token operator">-&gt;</span> x <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">The syntax <code>'a. 'a -&gt; 'a</code> denotes an <a data-tooltip-position="top" aria-label="https://caml.inria.fr/pub/docs/manual-ocaml/types.html#poly-typexpr" rel="noopener nofollow" class="external-link" href="https://caml.inria.fr/pub/docs/manual-ocaml/types.html#poly-typexpr" target="_blank">explicitly-polymorphic type</a>, where <code>'a.</code> corresponds directly with the <code>∀ a.</code> quantifier we've been using so far. Applying it here gives us a satisfyingly readable error message:</p></div><div class="el-pre"><pre class="language-text" tabindex="0"><code data-line="0" class="language-text is-loaded">Error: This definition has type int -&gt; int which is less general than
         'a. 'a -&gt; 'a
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">The caveat of polymorphic constraints is that we can only apply them directly to <code>let</code>-bindings, not to function bodies or other forms of expression:</p></div><div class="el-pre"><pre class="language-ocaml" tabindex="0"><code data-line="0" class="language-ocaml is-loaded"><span class="token keyword">let</span> panic <span class="token punctuation">:</span> <span class="token type-variable function">'a</span><span class="token punctuation">.</span> unit <span class="token operator">-&gt;</span> <span class="token type-variable function">'a</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">fun</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> raise Crisis<span class="token punctuation">)</span>  <span class="token comment">(* Works fine... *)</span>

<span class="token keyword">let</span> panic <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token type-variable function">'a</span><span class="token punctuation">.</span> <span class="token type-variable function">'a</span> <span class="token operator">=</span> raise Crisis                   <span class="token comment">(* Uh oh... *)</span>
<span class="token comment">(*               ^
 *  Error: Syntax error  *)</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">This somewhat unhelpful error message arises because OCaml will never infer a polymorphic type for a value that is not <code>let</code>-bound. Trying to make your type inference algorithm cleverer than this quickly runs into certain <a data-tooltip-position="top" aria-label="https://www.microsoft.com/en-us/research/wp-content/uploads/2016/02/putting.pdf" rel="noopener nofollow" class="external-link" href="https://www.microsoft.com/en-us/research/wp-content/uploads/2016/02/putting.pdf" target="_blank">undecidable problems</a>; the parser knows that the type-checker is afraid of undecidable problems, and so rejects the program straight away<a data-tooltip-position="top" aria-label="https://www.craigfe.io/posts/polymorphic-type-constraints#fn-4" rel="noopener nofollow" class="external-link" href="https://www.craigfe.io/posts/polymorphic-type-constraints#fn-4" target="_blank">4</a>.</p></div><div class="el-p"><p dir="auto">In spite of their limitations, explicitly-polymorphic type constraints are a great way to express polymorphic intent in your OCaml programs, either as internal documentation or to have more productive conversations with the type-checker when debugging. I recommend using them frequently and teaching them to beginners as soon as possible.</p></div><div class="el-p"><p dir="auto">At this point, if you suffered through my explanation of type variables in the previous section, you may be thinking the following:</p></div><div class="el-blockquote"><blockquote dir="auto">
<p><em>"If introducing type variables properly requires so many paragraphs of jargon, we <strong>shouldn't</strong> burden beginners with the details right away."</em></p>
<p>— Straw-man argument</p>
</blockquote></div><div class="el-p"><p dir="auto">Personally, I find that introducing these terms early on in the learning process is easily worthwhile in avoiding early roadblocks, but that discussion can wait for another time. In the spirit of functional programming for the masses, let's summarise with a less jargon-heavy attempt at redrafting our hypothetical education resource:</p></div><div class="el-blockquote"><blockquote dir="auto">
<p><em>Types of the form <code>'a</code>, <code>'b</code>, ..., known as type variables, are placeholders for an undetermined type. When bound by for-all quantifiers (of the form <code>'a.</code>), they can be used to describe values that can take on many possible types. For instance, we can write the type of <code>(fun x -&gt; x)</code> as <code>'a. 'a -&gt; 'a</code>, meaning:</em></p>
<blockquote dir="auto">
<p><em>"For any type <code>'a</code>, this function can take on type <code>'a -&gt; 'a</code>."</em></p>
</blockquote>
<p><em>The OCaml type-checker will infer polymorphic types wherever it is safe, but we can also explicitly specify a polymorphic type for a <code>let</code>-binding:</em></p>
<pre class="language-ocaml" tabindex="0"><code data-line="6" class="language-ocaml is-loaded">ᐅ <span class="token keyword">let</span> fst <span class="token punctuation">:</span> <span class="token type-variable function">'a</span> <span class="token type-variable function">'b</span><span class="token punctuation">.</span> <span class="token punctuation">(</span><span class="token type-variable function">'a</span> <span class="token operator">*</span> <span class="token type-variable function">'b</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token type-variable function">'a</span> <span class="token operator">=</span> <span class="token comment">(* "For all ['a] and ['b], ..." *)</span>
    <span class="token keyword">fun</span> <span class="token punctuation">(</span>x<span class="token punctuation">,</span> <span class="token punctuation">_</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> x <span class="token punctuation">;;</span>

<span class="token keyword">val</span> fst <span class="token punctuation">:</span> <span class="token type-variable function">'a</span> <span class="token operator">*</span> <span class="token type-variable function">'b</span> <span class="token operator">-&gt;</span> <span class="token type-variable function">'a</span> <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token keyword">fun</span><span class="token operator">&gt;</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre>
<p><em>Note that all type variables in signatures are implicitly universally-quantified: it's not necessary (or even possible) to write <code>'a 'b.</code> before the type.</em></p>
</blockquote></div><div class="el-p"><p dir="auto">The explanation is undeniably still longer and more technical than the one we started with, but crucially it uses the extra space to give the reader a clue as to how to debug their polymorphic functions.</p></div><div class="el-p"><p dir="auto">The story doesn't end here. We haven't discussed <a data-tooltip-position="top" aria-label="https://caml.inria.fr/pub/docs/manual-ocaml/gadts.html" rel="noopener nofollow" class="external-link" href="https://caml.inria.fr/pub/docs/manual-ocaml/gadts.html" target="_blank">existential quantifiers</a>, the other type of type variable binding; or <a data-tooltip-position="top" aria-label="https://caml.inria.fr/pub/docs/manual-ocaml/polymorphism.html#s:polymorphic-recursion" rel="noopener nofollow" class="external-link" href="https://caml.inria.fr/pub/docs/manual-ocaml/polymorphism.html#s:polymorphic-recursion" target="_blank">polymorphic recursion</a>, where polymorphic annotations become compulsory; or <a data-tooltip-position="top" aria-label="https://caml.inria.fr/pub/docs/manual-ocaml/locallyabstract.html" rel="noopener nofollow" class="external-link" href="https://caml.inria.fr/pub/docs/manual-ocaml/locallyabstract.html" target="_blank">locally-abstract types</a>, which offer other useful syntaxes for constraining your OCaml programs to be polymorphic. These will all have to wait for future posts. For now, thanks for reading!</p></div><div class="el-hr"><hr></div><div class="el-ol"><ol>
<li data-line="0" dir="auto">
<p>Very similar equivalents of this explanation exist in <a data-tooltip-position="top" aria-label="http://dev.realworldocaml.org/guided-tour.html" rel="noopener nofollow" class="external-link" href="http://dev.realworldocaml.org/guided-tour.html" target="_blank">Real World OCaml</a>, <a data-tooltip-position="top" aria-label="https://www.cs.cornell.edu/courses/cs3110/2020sp/textbook/" rel="noopener nofollow" class="external-link" href="https://www.cs.cornell.edu/courses/cs3110/2020sp/textbook/" target="_blank">Cornell's OCaml course</a>, and <a data-tooltip-position="top" aria-label="https://www.cl.cam.ac.uk/teaching/1920/FoundsCS/focs-201920-v1.1.pdf" rel="noopener nofollow" class="external-link" href="https://www.cl.cam.ac.uk/teaching/1920/FoundsCS/focs-201920-v1.1.pdf" target="_blank">Cambridge's OCaml course</a>. Type variables are variously described as representing <em>"any type"</em>, <em>"an unknown type"</em> or <em>"a generic type"</em>; explanations that are all as different as they are vague.<a data-tooltip-position="top" aria-label="https://www.craigfe.io/posts/polymorphic-type-constraints#fnref-1" rel="noopener nofollow" class="external-link" href="https://www.craigfe.io/posts/polymorphic-type-constraints#fnref-1" target="_blank">↩</a></p>
</li>
<li data-line="2" dir="auto">
<p>The most famous example of a type variable that is unsafe to generalise is one that has been captured in mutable state:</p>
<pre class="language-ocaml" tabindex="0"><code data-line="4" class="language-ocaml is-loaded">ᐅ <span class="token keyword">let</span> state <span class="token operator">=</span> ref <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">;;</span>
ᐅ <span class="token keyword">let</span> sneaky_id x <span class="token operator">=</span> <span class="token punctuation">(</span>state <span class="token operator">:=</span> x <span class="token punctuation">::</span> <span class="token operator">!</span>state<span class="token punctuation">)</span><span class="token punctuation">;</span> x <span class="token punctuation">;;</span>

<span class="token keyword">val</span> sneaky_id <span class="token punctuation">:</span> <span class="token type-variable function">'_weak1</span> <span class="token operator">-&gt;</span> <span class="token type-variable function">'_weak1</span> <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token keyword">fun</span><span class="token operator">&gt;</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre>
<p>In this case, it's not possible to give <code>sneaky_id</code> the type <code>∀ a. a -&gt; a</code> because different choices of the type <code>a</code> are not independent: passing a string to <code>sneaky_id</code>, followed by an integer, would build a list containing both strings and integers, violating type safety. Instead, <code>sneaky_id</code> is given a type containing a "<a data-tooltip-position="top" aria-label="https://caml.inria.fr/pub/docs/manual-ocaml/polymorphism.html#ss:weak-types" rel="noopener nofollow" class="external-link" href="https://caml.inria.fr/pub/docs/manual-ocaml/polymorphism.html#ss:weak-types" target="_blank">weak type variable</a>" which represents a single, unknown type. This meaning of type variables should be familiar to you; it's exactly the same as the "unbound" type variables we've been discussing!</p>
<p>In general, it's not easy to decide if it's safe to generalise a particular type variable. OCaml makes a quick under-approximation called the <a data-tooltip-position="top" aria-label="https://caml.inria.fr/pub/docs/manual-ocaml/polymorphism.html#ss:valuerestriction" rel="noopener nofollow" class="external-link" href="https://caml.inria.fr/pub/docs/manual-ocaml/polymorphism.html#ss:valuerestriction" target="_blank">(relaxed) value restriction</a>.</p>
<p><a data-tooltip-position="top" aria-label="https://www.craigfe.io/posts/polymorphic-type-constraints#fnref-2" rel="noopener nofollow" class="external-link" href="https://www.craigfe.io/posts/polymorphic-type-constraints#fnref-2" target="_blank">↩</a></p>
</li>
<li data-line="17" dir="auto">
<p>As an aside, there's no profound reason why constraints must behave differently with respect to implicit quantification. Both SML and Haskell choose to generalise variables in constraints:</p>
<pre class="language-ocaml" tabindex="0"><code data-line="19" class="language-ocaml is-loaded"><span class="token keyword">val</span> id1 <span class="token punctuation">:</span> <span class="token type-variable function">'a</span> <span class="token operator">-&gt;</span> <span class="token type-variable function">'a</span> <span class="token operator">=</span> <span class="token punctuation">(</span>fn x <span class="token operator">=&gt;</span> x <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">(*  Error: pattern and expression in val dec do not agree

pattern:    'a -&gt; 'a
expression: 'Z[INT] -&gt; 'Z[INT] *)</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre>
<blockquote dir="auto">
<p>(Note: <code>val f : t = e</code> in SML is analogous to <code>let f : t = e</code> in OCaml.)</p>
</blockquote>
<p>I suspect that constraints having the same quantification behaviour as signatures is more intuitive, at least for simple examples. In complex cases, the exact point at which type variables are implicitly quantified can be surprising, and so SML '97 provides an explicit quantification syntax for taking control of this behaviour. See <a data-tooltip-position="top" aria-label="https://www.smlnj.org/doc/Conversion/types.html#Explicit" rel="noopener nofollow" class="external-link" href="https://www.smlnj.org/doc/Conversion/types.html#Explicit" target="_blank">the SML/NJ guide (§ 1.1.3)</a> for much more detail.</p>
<p>The advantage of OCaml's approach is that it enables constraining <em>subcomponents</em> of types without needing to specify the entire thing (as in <code>(1, x) : (int * _)</code>), which can be useful when quickly constraining types as a sanity check or for code clarity. As far as I'm aware, SML has no equivalent feature.</p>
<p><a data-tooltip-position="top" aria-label="https://www.craigfe.io/posts/polymorphic-type-constraints#fnref-3" rel="noopener nofollow" class="external-link" href="https://www.craigfe.io/posts/polymorphic-type-constraints#fnref-3" target="_blank">↩</a></p>
</li>
<li data-line="35" dir="auto">
<p>This limitation of the type-checker can artificially limit the polymorphism that can be extracted from your programs. If you want to take polymorphism to its limits – as God intended – it's sometimes necessary to exploit another point where explicitly-polymorphic types can appear: <a data-tooltip-position="top" aria-label="https://caml.inria.fr/pub/docs/manual-ocaml/polymorphism.html#s%3Ahigher-rank-poly" rel="noopener nofollow" class="external-link" href="https://caml.inria.fr/pub/docs/manual-ocaml/polymorphism.html#s%3Ahigher-rank-poly" target="_blank">record and object fields</a>.<a data-tooltip-position="top" aria-label="https://www.craigfe.io/posts/polymorphic-type-constraints#fnref-4" rel="noopener nofollow" class="external-link" href="https://www.craigfe.io/posts/polymorphic-type-constraints#fnref-4" target="_blank">↩</a></p>
</li>
</ol></div><div class="mod-footer mod-ui"></div></div></div></div></div></div><div class="sidebar-right sidebar"><div class="sidebar-handle"></div><div class="sidebar-topbar"><div class="topbar-content"></div><div class="clickable-icon sidebar-collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" class="svg-icon"><path d="M21 3H3C1.89543 3 1 3.89543 1 5V19C1 20.1046 1.89543 21 3 21H21C22.1046 21 23 20.1046 23 19V5C23 3.89543 22.1046 3 21 3Z"></path><path d="M10 4V20"></path><path d="M4 7H7"></path><path d="M4 10H7"></path><path d="M4 13H7"></path></svg></div></div><div class="sidebar-content"><div class="graph-view-wrapper"><div class="sidebar-section-header">Interactive Graph</div><div class="graph-view-placeholder">
		<div class="graph-view-container">
			<div class="graph-icon graph-expand" role="button" aria-label="Expand" data-tooltip-position="top"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon"><line x1="7" y1="17" x2="17" y2="7"></line><polyline points="7 7 17 7 17 17"></polyline></svg></div>
			<canvas id="graph-canvas" class="hide" width="512px" height="512px"></canvas>
		</div>
		</div></div><div class="tree-container mod-root nav-folder tree-item outline-tree" data-depth="0"><div class="tree-header"><span class="sidebar-section-header">Table Of Contents</span><button class="clickable-icon collapse-tree-button" aria-label="Collapse All"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></svg></button></div><div class="tree-scroll-area tree-item-children nav-folder-children"><div class="tree-item mod-tree-folder nav-folder mod-collapsible is-collapsed" style="display: none;"></div><div class="tree-item" data-depth="1"><a class="tree-link" href="computer-science/programming-language/ocaml/polymorphic-type-constraints.html#Polymorphic type constraints"><div class="tree-item-contents heading-link" heading-name="Polymorphic type constraints"><span class="tree-item-title">Polymorphic type constraints</span></div></a><div class="tree-item-children nav-folder-children"><div class="tree-item" data-depth="2"><a class="tree-link" href="computer-science/programming-language/ocaml/polymorphic-type-constraints.html#Not-so-polymorphic_constraints"><div class="tree-item-contents heading-link" heading-name="Not-so-polymorphic constraints"><span class="tree-item-title">Not-so-polymorphic constraints</span></div></a><div class="tree-item-children nav-folder-children"></div></div><div class="tree-item" data-depth="2"><a class="tree-link" href="computer-science/programming-language/ocaml/polymorphic-type-constraints.html#What_is_a_type_variable_anyway?"><div class="tree-item-contents heading-link" heading-name="What is a type variable anyway?"><span class="tree-item-title">What is a type variable anyway?</span></div></a><div class="tree-item-children nav-folder-children"></div></div><div class="tree-item" data-depth="2"><a class="tree-link" href="computer-science/programming-language/ocaml/polymorphic-type-constraints.html#True_polymorphic_constraints"><div class="tree-item-contents heading-link" heading-name="True polymorphic constraints"><span class="tree-item-title">True polymorphic constraints</span></div></a><div class="tree-item-children nav-folder-children"></div></div></div></div></div></div></div><script defer="">let rs = document.querySelector(".sidebar-right"); rs.classList.add("is-collapsed"); if (window.innerWidth > 768) rs.classList.remove("is-collapsed"); rs.style.setProperty("--sidebar-width", localStorage.getItem("sidebar-right-width"));</script></div></div></body></html>