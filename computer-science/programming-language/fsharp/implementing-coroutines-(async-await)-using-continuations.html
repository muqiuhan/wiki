<!DOCTYPE html> <html><head>
		<title>Implementing Coroutines (async await) using continuations</title>
		<base href="../../../">
		<meta id="root-path" root-path="../../../">
		<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes, minimum-scale=1.0, maximum-scale=5.0">
		<meta charset="UTF-8">
		<meta name="description" content="韩暮秋的个人维基 - Implementing Coroutines (async await) using continuations">
		<meta property="og:title" content="Implementing Coroutines (async await) using continuations">
		<meta property="og:description" content="韩暮秋的个人维基 - Implementing Coroutines (async await) using continuations">
		<meta property="og:type" content="website">
		<meta property="og:url" content="https://muqiuhan.github.io/wiki/computer-science/programming-language/fsharp/implementing-coroutines-(async-await)-using-continuations.html">
		<meta property="og:image" content="undefined">
		<meta property="og:site_name" content="韩暮秋的个人维基">
		<meta name="author" content="韩暮秋"><script async="" id="webpage-script" src="lib/scripts/webpage.js" onload="this.onload=null;this.setAttribute(&quot;loaded&quot;, &quot;true&quot;)"></script><script type="module" async="" id="graph-view-script" src="lib/scripts/graph-view.js"></script><script async="" id="graph-wasm-script" src="lib/scripts/graph-wasm.js" onload="this.onload=null;this.setAttribute(&quot;loaded&quot;, &quot;true&quot;)"></script><script async="" id="graph-render-worker-script" src="lib/scripts/graph-render-worker.js" onload="this.onload=null;this.setAttribute(&quot;loaded&quot;, &quot;true&quot;)"></script><script async="" id="tinycolor-script" src="lib/scripts/tinycolor.js" onload="this.onload=null;this.setAttribute(&quot;loaded&quot;, &quot;true&quot;)"></script><script async="" id="pixi-script" src="lib/scripts/pixi.js" onload="this.onload=null;this.setAttribute(&quot;loaded&quot;, &quot;true&quot;)"></script><script async="" id="minisearch-script" src="lib/scripts/minisearch.js" onload="this.onload=null;this.setAttribute(&quot;loaded&quot;, &quot;true&quot;)"></script><link rel="icon" href="lib/media/favicon.jpg"><script async="" id="graph-data-script" src="lib/scripts/graph-data.js" onload="this.onload=null;this.setAttribute(&quot;loaded&quot;, &quot;true&quot;)"></script><style>body{--line-width:40em;--line-width-adaptive:40em;--file-line-width:40em;--sidebar-width:min(20em, 80vw);--collapse-arrow-size:11px;--tree-horizontal-spacing:0.6em;--tree-vertical-spacing:0.6em;--sidebar-margin:12px}.sidebar{height:100%;min-width:calc(var(--sidebar-width) + var(--divider-width-hover));max-width:calc(var(--sidebar-width) + var(--divider-width-hover));font-size:14px;z-index:10;position:relative;overflow:hidden;transition:min-width ease-in-out,max-width ease-in-out;transition-duration:.2s;contain:size}.sidebar-left{left:0}.sidebar-right{right:0}.sidebar.is-collapsed{min-width:0;max-width:0}body.floating-sidebars .sidebar{position:absolute}.sidebar-content{height:100%;min-width:calc(var(--sidebar-width) - var(--divider-width-hover));top:0;padding:var(--sidebar-margin);padding-top:4em;line-height:var(--line-height-tight);background-color:var(--background-secondary);transition:background-color,border-right,border-left,box-shadow;transition-duration:var(--color-fade-speed);transition-timing-function:ease-in-out;position:absolute;display:flex;flex-direction:column}.sidebar:not(.is-collapsed) .sidebar-content{min-width:calc(max(100%,var(--sidebar-width)) - 3px);max-width:calc(max(100%,var(--sidebar-width)) - 3px)}.sidebar-left .sidebar-content{left:0;border-top-right-radius:var(--radius-l);border-bottom-right-radius:var(--radius-l)}.sidebar-right .sidebar-content{right:0;border-top-left-radius:var(--radius-l);border-bottom-left-radius:var(--radius-l)}.sidebar:has(.sidebar-content:empty):has(.topbar-content:empty){display:none}.sidebar-topbar{height:2em;width:var(--sidebar-width);top:var(--sidebar-margin);padding-inline:var(--sidebar-margin);z-index:1;position:fixed;display:flex;align-items:center;transition:width ease-in-out;transition-duration:inherit}.sidebar.is-collapsed .sidebar-topbar{width:calc(2.3em + var(--sidebar-margin) * 2)}.sidebar .sidebar-topbar.is-collapsed{width:0}.sidebar-left .sidebar-topbar{left:0}.sidebar-right .sidebar-topbar{right:0}.topbar-content{overflow:hidden;overflow:clip;width:100%;height:100%;display:flex;align-items:center;transition:inherit}.sidebar.is-collapsed .topbar-content{width:0;transition:inherit}.clickable-icon.sidebar-collapse-icon{background-color:transparent;color:var(--icon-color-focused);padding:0!important;margin:0!important;height:100%!important;width:2.3em!important;margin-inline:0.14em!important;position:absolute}.sidebar-left .clickable-icon.sidebar-collapse-icon{transform:rotateY(180deg);right:var(--sidebar-margin)}.sidebar-right .clickable-icon.sidebar-collapse-icon{transform:rotateY(180deg);left:var(--sidebar-margin)}.clickable-icon.sidebar-collapse-icon svg.svg-icon{width:100%;height:100%}.sidebar-section-header{margin:0 0 1em 0;text-transform:uppercase;letter-spacing:.06em;font-weight:600}body{transition:background-color var(--color-fade-speed) ease-in-out}.webpage-container{display:flex;flex-direction:row;height:100%;width:100%;align-items:stretch;justify-content:center}.document-container{opacity:1;flex-basis:100%;max-width:100%;width:100%;height:100%;display:flex;flex-direction:column;align-items:center;transition:opacity .2s ease-in-out;contain:inline-size}.hide{opacity:0;transition:opacity .2s ease-in-out}.document-container>.markdown-preview-view{margin:var(--sidebar-margin);margin-bottom:0;width:100%;width:-webkit-fill-available;width:-moz-available;width:fill-available;background-color:var(--background-primary);transition:background-color var(--color-fade-speed) ease-in-out;border-top-right-radius:var(--window-radius,var(--radius-m));border-top-left-radius:var(--window-radius,var(--radius-m));overflow-x:hidden!important;overflow-y:auto!important;display:flex!important;flex-direction:column!important;align-items:center!important;contain:inline-size}.document-container>.markdown-preview-view>.markdown-preview-sizer{padding-bottom:80vh!important;width:100%!important;max-width:var(--line-width)!important;flex-basis:var(--line-width)!important;transition:background-color var(--color-fade-speed) ease-in-out;contain:inline-size}.markdown-rendered img:not([width]),.view-content img:not([width]){max-width:100%;outline:0}.document-container>.view-content.embed{display:flex;padding:1em;height:100%;width:100%;align-items:center;justify-content:center}.document-container>.view-content.embed>*{max-width:100%;max-height:100%;object-fit:contain}:has(> :is(.math,table)){overflow-x:auto!important}.document-container>.view-content{overflow-x:auto;contain:content;padding:0;margin:0;height:100%}.scroll-highlight{position:absolute;width:100%;height:100%;pointer-events:none;z-index:1000;background-color:hsla(var(--color-accent-hsl),.25);opacity:0;padding:1em;inset:50%;translate:-50% -50%;border-radius:var(--radius-s)}</style><script defer="">async function loadIncludes(){if("file:"!=location.protocol){let e=document.querySelectorAll("include");for(let t=0;t<e.length;t++){let o=e[t],l=o.getAttribute("src");try{const e=await fetch(l);if(!e.ok){console.log("Could not include file: "+l),o?.remove();continue}let t=await e.text(),n=document.createRange().createContextualFragment(t),i=Array.from(n.children);for(let e of i)e.classList.add("hide"),e.style.transition="opacity 0.5s ease-in-out",setTimeout((()=>{e.classList.remove("hide")}),10);o.before(n),o.remove(),console.log("Included file: "+l)}catch(e){o?.remove(),console.log("Could not include file: "+l,e);continue}}}else{if(document.querySelectorAll("include").length>0){var e=document.createElement("div");e.id="error",e.textContent="Web server exports must be hosted on an http / web server to be viewed correctly.",e.style.position="fixed",e.style.top="50%",e.style.left="50%",e.style.transform="translate(-50%, -50%)",e.style.fontSize="1.5em",e.style.fontWeight="bold",e.style.textAlign="center",document.body.appendChild(e),document.querySelector(".document-container")?.classList.remove("hide")}}}document.addEventListener("DOMContentLoaded",(()=>{loadIncludes()}));let isFileProtocol="file:"==location.protocol;function waitLoadScripts(e,t){let o=e.map((e=>document.getElementById(e+"-script"))),l=0;!function e(){let n=o[l];l++,n&&"true"!=n.getAttribute("loaded")||l<o.length&&e(),l<o.length?n.addEventListener("load",e):t()}()}</script><link rel="stylesheet" href="lib/styles/obsidian.css"><link rel="preload" href="lib/styles/other-plugins.css" as="style" onload="this.onload=null;this.rel='stylesheet'"><noscript><link rel="stylesheet" href="lib/styles/other-plugins.css"></noscript><link rel="stylesheet" href="lib/styles/theme.css"><link rel="preload" href="lib/styles/global-variable-styles.css" as="style" onload="this.onload=null;this.rel='stylesheet'"><noscript><link rel="stylesheet" href="lib/styles/global-variable-styles.css"></noscript><link rel="preload" href="lib/styles/supported-plugins.css" as="style" onload="this.onload=null;this.rel='stylesheet'"><noscript><link rel="stylesheet" href="lib/styles/supported-plugins.css"></noscript><link rel="preload" href="lib/styles/main-styles.css" as="style" onload="this.onload=null;this.rel='stylesheet'"><noscript><link rel="stylesheet" href="lib/styles/main-styles.css"></noscript></head><body class="publish css-settings-manager theme-dark show-inline-title show-ribbon oled-black lst-fab-b2-1 is-css-guide list-d-c-d lst-fm-compact lst-prop-super-compact"><script defer="">let theme=localStorage.getItem("theme")||(window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light");"dark"==theme?(document.body.classList.add("theme-dark"),document.body.classList.remove("theme-light")):(document.body.classList.add("theme-light"),document.body.classList.remove("theme-dark")),window.innerWidth<480?document.body.classList.add("is-phone"):window.innerWidth<768?document.body.classList.add("is-tablet"):window.innerWidth<1024?document.body.classList.add("is-small-screen"):document.body.classList.add("is-large-screen")</script><div class="webpage-container workspace"><div class="sidebar-left sidebar"><div class="sidebar-handle"></div><div class="sidebar-topbar"><div class="topbar-content"><label class="theme-toggle-container" for="theme_toggle"><input class="theme-toggle-input" type="checkbox" id="theme_toggle"><div class="toggle-background"></div></label></div><div class="clickable-icon sidebar-collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" class="svg-icon"><path d="M21 3H3C1.89543 3 1 3.89543 1 5V19C1 20.1046 1.89543 21 3 21H21C22.1046 21 23 20.1046 23 19V5C23 3.89543 22.1046 3 21 3Z"></path><path d="M10 4V20"></path><path d="M4 7H7"></path><path d="M4 10H7"></path><path d="M4 13H7"></path></svg></div></div><div class="sidebar-content"><div class="search-input-container"><input enterkeyhint="search" type="search" spellcheck="false" placeholder="Search..."><div class="search-input-clear-button" aria-label="Clear search"></div></div><include src="lib/html/file-tree.html"></include></div><script defer="">let ls = document.querySelector(".sidebar-left"); ls.classList.add("is-collapsed"); if (window.innerWidth > 768) ls.classList.remove("is-collapsed"); ls.style.setProperty("--sidebar-width", localStorage.getItem("sidebar-left-width"));</script></div><div class="document-container markdown-reading-view hide"><div class="markdown-preview-view markdown-rendered allow-fold-headings allow-fold-lists is-readable-line-width"><style id="MJX-CHTML-styles"></style><div class="markdown-preview-sizer markdown-preview-section"><h1 class="page-title heading inline-title" id="Implementing Coroutines (async await) using continuations"><p dir="auto">Implementing Coroutines (async await) using continuations</p></h1><div><p dir="auto"><a href="?query=tag:fsharp" class="tag" target="_blank" rel="noopener">#fsharp</a> <a href="?query=tag:pl" class="tag" target="_blank" rel="noopener">#pl</a> <a href="?query=tag:fp" class="tag" target="_blank" rel="noopener">#fp</a> <a href="?query=tag:coroutines" class="tag" target="_blank" rel="noopener">#coroutines</a></p></div><div><p dir="auto"><a data-tooltip-position="top" aria-label="https://en.wikipedia.org/wiki/Coroutine" rel="noopener" class="external-link" href="https://en.wikipedia.org/wiki/Coroutine" target="_blank">Coroutines</a> or async/await is not a new concept as it was named in 1958 by Melvin Conway. Coroutines had support in languages such as Simula(1962), Smalltalk(1972) and Modula-2(1978) but I think one can argue that coroutines came into mainstream with C# 5(2012) when Microsoft added async/await to C#.</p></div><div class="heading-wrapper"><h2 data-heading="The problem with subroutines" dir="auto" class="heading" id="The_problem_with_subroutines"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>The problem with subroutines</h2><div class="heading-children"><div><p dir="auto">A thread can only execute a single subroutine at a time as a subroutine starts and then runs to completion. In a server environment subroutines can be problematic as in order to service connections concurrently we would usually would start a thread per connection, this was the idiom a few years ago. A thread depending on the operating system and settings needs about 1 MiB of user stack space meaning 1,024 threads needs 1 GiB of for just user stack space. In addition there's the cost of kernel stack space, book-keeping and scheduling of threads. This drives cost of VM/hardware. This is sometimes known as the <a data-tooltip-position="top" aria-label="https://en.wikipedia.org/wiki/C10k_problem" rel="noopener" class="external-link" href="https://en.wikipedia.org/wiki/C10k_problem" target="_blank">C10K problem</a>.</p></div></div></div><div class="heading-wrapper"><h2 data-heading="Why coroutines can help" dir="auto" class="heading" id="Why_coroutines_can_help"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>Why coroutines can help</h2><div class="heading-children"><div><p dir="auto">A coroutine is like a subroutine except it can also pause/yield the execution when the coroutine begins an asynchronous IO operation to let the executing thread do something else while we are waiting for the IO operation to complete. Once the IO operation is completed the coroutine gets picked up by an idle thread and continues to execute. This enables us to service say 1 million connections by having 1 million coroutines executed by 100 threads.</p></div><div><p dir="auto">Coroutines are cheaper than threads because the memory footprint requirement is smaller and doesn't require lots of <em>continuous</em> RAM (a rather steep requirement). In addition, the scheduling is simpler because it is cooperative rather than preemptive.</p></div></div></div><div class="heading-wrapper"><h2 data-heading="Why coroutines sometimes hurts" dir="auto" class="heading" id="Why_coroutines_sometimes_hurts"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>Why coroutines sometimes hurts</h2><div class="heading-children"><div><p dir="auto">What the C# community has learnt over the years is that the niceness of coroutines has a price.</p></div><div><p dir="auto">For one thing the call stack is gone which has huge implications for debugging. Microsoft has improved the tooling over the years to give us back the illusion of call stack.</p></div><div><p dir="auto">Another common issue is that we sometimes try to fit the round shape of the coroutine peg into the square hole of a subroutine like so:</p></div><div><pre class="language-cs" tabindex="0"><code class="language-cs is-loaded"><span class="token class-name"><span class="token keyword">var</span></span> task <span class="token operator">=</span> <span class="token function">MyFunctionIsAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Returns a coroutine as a Task</span>
<span class="token class-name"><span class="token keyword">var</span></span> result <span class="token operator">=</span> task<span class="token punctuation">.</span>Result<span class="token punctuation">;</span> <span class="token comment">// Sometimes result in a dead-lock?!?!</span>
</code><button class="copy-code-button">Copy</button></pre></div><div><p dir="auto">A coroutine might yield execution and to later resume it but by calling <code>Task.Result</code> this thread is now blocked waiting for the coroutine to complete. Depending on the <code>SynchronizationContext</code> it can mean that the coroutine can only execute on the thread that started it but this thread is blocked waiting for the coroutine to finish =&gt; dead-lock.</p></div><div><p dir="auto">IMHO; it was a mistake to add <code>Task.Result</code> because it made it easy to use coroutines wrongly but what is done is done. It is quite simple; don't call <code>Task.Result</code> or <code>Task.Wait</code>.</p></div></div></div><div class="heading-wrapper"><h2 data-heading="Implementing coroutines using continuations" dir="auto" class="heading" id="Implementing_coroutines_using_continuations"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>Implementing coroutines using continuations</h2><div class="heading-children"><div><p dir="auto">C# has specific compiler support to support coroutines and behind the scenes generates state machines when it can and uses continuation when it can't.</p></div><div><p dir="auto">I want to demonstrate how to implement coroutines in F# using continuations. This is how F# <code>Async</code> works internally but I will skip exception support and accept that there is potential for stack overflow for long coroutine chains. There are solutions for this which are used by F# <code>Async</code> but I want to keep the code clean to not hide the simple underlying idea.</p></div><div><p dir="auto">A simple coroutine definition in F# could look like this:</p></div><div><pre class="language-fsharp" tabindex="0"><code class="language-fsharp is-loaded"><span class="token keyword">type</span> <span class="token annotation"><span class="token punctuation">[&lt;</span><span class="token class-name">Struct</span><span class="token punctuation">&gt;]</span></span> Coroutine<span class="token operator">&lt;</span>'T<span class="token operator">&gt;</span> <span class="token operator">=</span> Co <span class="token keyword">of</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>'T <span class="token operator">-&gt;</span> unit<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> unit<span class="token punctuation">)</span>
</code><button class="copy-code-button">Copy</button></pre></div><div><p dir="auto">We start the <code>Coroutine&lt;_&gt;</code> by giving it a continuation/callback function: <code>r: 'T -&gt; unit</code> that the <code>Coroutine&lt;_&gt;</code> invokes when the result <code>'T</code> is available.</p></div><div class="heading-wrapper"><h3 data-heading="The basics" dir="auto" class="heading" id="The_basics"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>The basics</h3><div class="heading-children"><div><p dir="auto">When the result is available the <code>Coroutine&lt;_&gt;</code> invokes the continuation <code>r</code> immediately like in the <code>result</code> coroutine.</p></div><div><pre class="language-fsharp" tabindex="0"><code class="language-fsharp is-loaded"><span class="token keyword">let</span> result v <span class="token operator">=</span>
  Co <span class="token operator">&lt;|</span> <span class="token keyword">fun</span> r <span class="token operator">-&gt;</span>
    r v
</code><button class="copy-code-button">Copy</button></pre></div><div><p dir="auto">Sometimes we have to wait on a <code>Task&lt;_&gt;</code> to complete before we can execute the continuation <code>r</code>:</p></div><div><pre class="language-fsharp" tabindex="0"><code class="language-fsharp is-loaded"><span class="token comment">// Creates a Coroutine&lt;_&gt; from a Task&lt;_&gt;</span>
<span class="token keyword">let</span> ofTask <span class="token punctuation">(</span>t <span class="token punctuation">:</span> <span class="token class-name">Task</span><span class="token operator">&lt;</span>_<span class="token operator">&gt;</span><span class="token punctuation">)</span> <span class="token operator">=</span>
  Co <span class="token operator">&lt;|</span> <span class="token keyword">fun</span> r <span class="token operator">-&gt;</span>
    <span class="token keyword">let</span> cw <span class="token punctuation">(</span>t <span class="token punctuation">:</span> <span class="token class-name">Task</span><span class="token operator">&lt;</span>_<span class="token operator">&gt;</span><span class="token punctuation">)</span> <span class="token operator">=</span> r t<span class="token punctuation">.</span>Result
    t<span class="token punctuation">.</span>ContinueWith <span class="token punctuation">(</span>Action<span class="token operator">&lt;</span>Task<span class="token operator">&lt;</span>'T<span class="token operator">&gt;&gt;</span> cw<span class="token punctuation">)</span> <span class="token operator">|&gt;</span> ignore

<span class="token comment">// Creates a Coroutine&lt;unit&gt; from a Task</span>
<span class="token keyword">let</span> ofUnitTask <span class="token punctuation">(</span>t <span class="token punctuation">:</span> <span class="token class-name">Task</span><span class="token punctuation">)</span> <span class="token operator">=</span>
  Co <span class="token operator">&lt;|</span> <span class="token keyword">fun</span> r <span class="token operator">-&gt;</span>
    <span class="token keyword">let</span> cw <span class="token punctuation">(</span>_ <span class="token punctuation">:</span> <span class="token class-name">Task</span><span class="token punctuation">)</span> <span class="token operator">=</span> r <span class="token punctuation">(</span><span class="token punctuation">)</span>
    t<span class="token punctuation">.</span>ContinueWith <span class="token punctuation">(</span>Action<span class="token operator">&lt;</span>Task<span class="token operator">&gt;</span> cw<span class="token punctuation">)</span> <span class="token operator">|&gt;</span> ignore
</code><button class="copy-code-button">Copy</button></pre></div><div><p dir="auto">There's an important difference between <code>Task&lt;_&gt;</code> and <code>Coroutine&lt;_&gt;</code>. The task begins executing immediately on creation but <code>Coroutine&lt;_&gt;</code> begins executing once it receives the continuation <code>r</code>.</p></div></div></div><div class="heading-wrapper"><h3 data-heading="The Monad" dir="auto" class="heading" id="The_Monad"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>The Monad</h3><div class="heading-children"><div><p dir="auto">In order to complete the <code>Coroutine&lt;_&gt;</code> Monad we define <code>bind</code> and <code>combine</code>:</p></div><div><pre class="language-fsharp" tabindex="0"><code class="language-fsharp is-loaded"><span class="token keyword">let</span> bind <span class="token punctuation">(</span>Co c<span class="token punctuation">)</span> f <span class="token operator">=</span>
  Co <span class="token operator">&lt;|</span>
    <span class="token keyword">fun</span> r <span class="token operator">-&gt;</span>
      <span class="token keyword">let</span> cr v <span class="token operator">=</span>
        <span class="token keyword">let</span> <span class="token punctuation">(</span>Co d<span class="token punctuation">)</span> <span class="token operator">=</span> f v
        d r
      c cr

<span class="token keyword">let</span> combine <span class="token punctuation">(</span>Co c<span class="token punctuation">)</span> <span class="token punctuation">(</span>Co d<span class="token punctuation">)</span> <span class="token operator">=</span>
  Co <span class="token operator">&lt;|</span>
    <span class="token keyword">fun</span> r <span class="token operator">-&gt;</span>
      <span class="token keyword">let</span> cr _ <span class="token operator">=</span>
        d r
      c cr
</code><button class="copy-code-button">Copy</button></pre></div></div></div><div class="heading-wrapper"><h3 data-heading="Supporting let! syntax" dir="auto" class="heading" id="Supporting_let!_syntax"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>Supporting let! syntax</h3><div class="heading-children"><div><p dir="auto">In order to support an experience that looks like async/await in C# we can now define a <a data-tooltip-position="top" aria-label="https://docs.microsoft.com/en-us/dotnet/fsharp/language-reference/computation-expressions" rel="noopener" class="external-link" href="https://docs.microsoft.com/en-us/dotnet/fsharp/language-reference/computation-expressions" target="_blank">computation expression builder</a>:</p></div><div><pre class="language-fsharp" tabindex="0"><code class="language-fsharp is-loaded"><span class="token keyword">type</span> <span class="token class-name">CoroutineBuilder</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span>
  <span class="token keyword">class</span>
    <span class="token comment">// To support let!</span>
    <span class="token keyword">member</span> x<span class="token punctuation">.</span>Bind       <span class="token punctuation">(</span>c<span class="token punctuation">,</span> f<span class="token punctuation">)</span>  <span class="token punctuation">:</span> Coroutine<span class="token operator">&lt;</span>_<span class="token operator">&gt;</span> <span class="token operator">=</span> bind     c               f
    <span class="token keyword">member</span> x<span class="token punctuation">.</span>Bind       <span class="token punctuation">(</span>t<span class="token punctuation">,</span> f<span class="token punctuation">)</span>  <span class="token punctuation">:</span> Coroutine<span class="token operator">&lt;</span>_<span class="token operator">&gt;</span> <span class="token operator">=</span> bind     <span class="token punctuation">(</span>ofTask t<span class="token punctuation">)</span>      f
    <span class="token keyword">member</span> x<span class="token punctuation">.</span>Bind       <span class="token punctuation">(</span>t<span class="token punctuation">,</span> f<span class="token punctuation">)</span>  <span class="token punctuation">:</span> Coroutine<span class="token operator">&lt;</span>_<span class="token operator">&gt;</span> <span class="token operator">=</span> bind     <span class="token punctuation">(</span>ofUnitTask t<span class="token punctuation">)</span>  f
    <span class="token comment">// To support do!</span>
    <span class="token keyword">member</span> x<span class="token punctuation">.</span>Combine    <span class="token punctuation">(</span>c<span class="token punctuation">,</span> d<span class="token punctuation">)</span>  <span class="token punctuation">:</span> Coroutine<span class="token operator">&lt;</span>_<span class="token operator">&gt;</span> <span class="token operator">=</span> combine  c               d
    <span class="token keyword">member</span> x<span class="token punctuation">.</span>Combine    <span class="token punctuation">(</span>t<span class="token punctuation">,</span> d<span class="token punctuation">)</span>  <span class="token punctuation">:</span> Coroutine<span class="token operator">&lt;</span>_<span class="token operator">&gt;</span> <span class="token operator">=</span> combine  <span class="token punctuation">(</span>ofUnitTask t<span class="token punctuation">)</span>  d
    <span class="token comment">// To support return</span>
    <span class="token keyword">member</span> x<span class="token punctuation">.</span>Return     v       <span class="token punctuation">:</span> <span class="token class-name">Coroutine</span><span class="token operator">&lt;</span>_<span class="token operator">&gt;</span> <span class="token operator">=</span> result   v
    <span class="token comment">// To support return!</span>
    <span class="token keyword">member</span> x<span class="token punctuation">.</span>ReturnFrom c       <span class="token punctuation">:</span> <span class="token class-name">Coroutine</span><span class="token operator">&lt;</span>_<span class="token operator">&gt;</span> <span class="token operator">=</span> c
    <span class="token keyword">member</span> x<span class="token punctuation">.</span>ReturnFrom t       <span class="token punctuation">:</span> <span class="token class-name">Coroutine</span><span class="token operator">&lt;</span>_<span class="token operator">&gt;</span> <span class="token operator">=</span> ofTask   t
    <span class="token keyword">member</span> x<span class="token punctuation">.</span>Zero       <span class="token punctuation">(</span><span class="token punctuation">)</span>      <span class="token punctuation">:</span> Coroutine<span class="token operator">&lt;</span>_<span class="token operator">&gt;</span> <span class="token operator">=</span> result   <span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">end</span>
<span class="token keyword">let</span> coroutine <span class="token operator">=</span> CoroutineBuilder <span class="token punctuation">(</span><span class="token punctuation">)</span>
</code><button class="copy-code-button">Copy</button></pre></div></div></div><div class="heading-wrapper"><h3 data-heading="Running a `Coroutine<_>`" dir="auto" class="heading" id="Running_a_`Coroutine<_>`"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>Running a <code>Coroutine&lt;_&gt;</code></h3><div class="heading-children"><div><p dir="auto">We also need a way to invoke a <code>Coroutine&lt;_&gt;</code></p></div><div><pre class="language-fsharp" tabindex="0"><code class="language-fsharp is-loaded"><span class="token keyword">let</span> invoke <span class="token punctuation">(</span>Co c<span class="token punctuation">)</span> r <span class="token operator">=</span>
  <span class="token keyword">let</span> wc _ <span class="token operator">=</span> c r
  ThreadPool<span class="token punctuation">.</span>QueueUserWorkItem <span class="token punctuation">(</span>WaitCallback wc<span class="token punctuation">)</span> <span class="token operator">|&gt;</span> ignore
</code><button class="copy-code-button">Copy</button></pre></div><div><p dir="auto">The <code>Coroutine&lt;_&gt;</code> will execute in the thread pool to begin with and when done it will call the continuation <code>r</code> with the result.</p></div><div><p dir="auto">By design we don't expose a <code>.Result</code> property, the only way to receive the result of <code>Coroutine&lt;_&gt;</code> is through the continuation <code>r</code>. This design is to ensure there's no surprise dead-locks from trying to force a coroutine into a subroutine. Note; the continuation <code>r</code> can be executed by any thread.</p></div></div></div><div class="heading-wrapper"><h3 data-heading="Downloading google homepage" dir="auto" class="heading" id="Downloading_google_homepage"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>Downloading google homepage</h3><div class="heading-children"><div><p dir="auto">All of this enables us to write a simple <code>Coroutine&lt;_&gt;</code> like this:</p></div><div><pre class="language-fsharp" tabindex="0"><code class="language-fsharp is-loaded"><span class="token keyword">let</span> downloadFromUri uri <span class="token operator">=</span>
  <span class="token computation-expression keyword">coroutine</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> wc    <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WebClient</span> <span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">let!</span> txt  <span class="token operator">=</span> wc<span class="token punctuation">.</span>DownloadStringTaskAsync <span class="token punctuation">(</span>Uri uri<span class="token punctuation">)</span>
    <span class="token comment">// Coroutine&lt;_&gt; doesn't support use!</span>
    wc<span class="token punctuation">.</span>Dispose <span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> txt
  <span class="token punctuation">}</span>

<span class="token keyword">let</span> exampleDownloadFromGoogle <span class="token operator">=</span>
  <span class="token computation-expression keyword">coroutine</span> <span class="token punctuation">{</span>
    <span class="token keyword">let!</span> txt <span class="token operator">=</span> downloadFromUri <span class="token string">"https://www.google.com/"</span>
    <span class="token keyword">return</span> txt<span class="token punctuation">.</span>Length
  <span class="token punctuation">}</span>

<span class="token annotation"><span class="token punctuation">[&lt;</span><span class="token class-name">EntryPoint</span><span class="token punctuation">&gt;]</span></span>
<span class="token keyword">let</span> main argv <span class="token operator">=</span>
  invoke exampleDownloadFromGoogle <span class="token operator">&lt;|</span> printfn <span class="token string">"Result: %A"</span>

  printfn <span class="token string">"Press any key to exit"</span>
  Console<span class="token punctuation">.</span>ReadKey <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">|&gt;</span> ignore

  <span class="token number">0</span>
</code><button class="copy-code-button">Copy</button></pre></div><div><p dir="auto">Prints the size of the google home that at the time of writing was:</p></div><div><pre><code>Press any key to exit
Result: 45782
</code><button class="copy-code-button">Copy</button></pre></div><div><p dir="auto">Note; <code>Press any key to exit</code> is printed before the result, this is because <code>invoke</code> enqueues a <code>Coroutine&lt;_&gt;</code> to be executed by the thread pool and immediately returns. After google responds the <code>Coroutine&lt;_&gt;</code> continues executing on the thread pool and ultimately prints the size of the google homepage.</p></div></div></div><div class="heading-wrapper"><h3 data-heading="Downloading google &amp; bing homepages" dir="auto" class="heading" id="Downloading_google_&amp;_bing_homepages"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>Downloading google &amp; bing homepages</h3><div class="heading-children"><div><p dir="auto">We can download from both google &amp; bing:</p></div><div><pre class="language-fsharp" tabindex="0"><code class="language-fsharp is-loaded"><span class="token keyword">let</span> exampleDownloadFromGoogleAndBing <span class="token operator">=</span>
  <span class="token computation-expression keyword">coroutine</span> <span class="token punctuation">{</span>
    <span class="token keyword">let!</span> google <span class="token operator">=</span> downloadFromUri <span class="token string">"https://www.google.com/"</span>
    <span class="token keyword">let!</span> bing   <span class="token operator">=</span> downloadFromUri <span class="token string">"https://www.bing.com/"</span>
    <span class="token keyword">return</span> google<span class="token punctuation">.</span>Length<span class="token punctuation">,</span> bing<span class="token punctuation">.</span>Length
  <span class="token punctuation">}</span>
</code><button class="copy-code-button">Copy</button></pre></div><div><p dir="auto">Prints:</p></div><div><pre><code>Press any key to exit
Result: (45748, 90632)
</code><button class="copy-code-button">Copy</button></pre></div><div><p dir="auto">This is good because it doesn't block the executing thread while downloading the homepage, this is bad because we download the homepages sequentially. It would be better to download both at the same time.</p></div></div></div><div class="heading-wrapper"><h3 data-heading="Downloading google &amp; bing homepage in parallel" dir="auto" class="heading" id="Downloading_google_&amp;_bing_homepage_in_parallel"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>Downloading google &amp; bing homepage in parallel</h3><div class="heading-children"><div><p dir="auto">Using <code>runInParallel</code> this is easy to do.</p></div><div><pre class="language-fsharp" tabindex="0"><code class="language-fsharp is-loaded"><span class="token keyword">let</span> exampleDownloadFromGoogleAndBingInParallel <span class="token operator">=</span>
  <span class="token computation-expression keyword">coroutine</span> <span class="token punctuation">{</span>
    <span class="token comment">// Start the download coroutines in parallel</span>
    <span class="token keyword">let!</span> cgoogle <span class="token operator">=</span> runInParallel <span class="token operator">&lt;|</span> downloadFromUri <span class="token string">"https://www.google.com/"</span>
    <span class="token keyword">let!</span> cbing   <span class="token operator">=</span> runInParallel <span class="token operator">&lt;|</span> downloadFromUri <span class="token string">"https://www.bing.com/"</span>

    <span class="token comment">// Wait for the coroutines to complete</span>
    <span class="token keyword">let!</span> google  <span class="token operator">=</span> cgoogle
    <span class="token keyword">let!</span> bing    <span class="token operator">=</span> cbing

    <span class="token keyword">return</span> google<span class="token punctuation">.</span>Length<span class="token punctuation">,</span> bing<span class="token punctuation">.</span>Length
  <span class="token punctuation">}</span>
</code><button class="copy-code-button">Copy</button></pre></div><div><p dir="auto">This downloads the homepages in parallel. How does it work?</p></div><div><p dir="auto"><code>runInParallel</code> has the signature: <code>Coroutine&lt;'T&gt; -&gt; Coroutine&lt;Coroutine&lt;'T&gt;&gt;</code>. The reason for this is that a <code>Coroutine&lt;_&gt;</code> is started when it is passed the continuation <code>r</code> but in this case we like the continuation to start additional <code>Coroutine&lt;_&gt;</code> before the first <code>Coroutine&lt;_&gt;</code> is done. So <code>runInParallel</code> starts the <code>Coroutine&lt;_&gt;</code> it is passed and then immediately returns a new <code>Coroutine&lt;_&gt;</code> that we can wait on for the result. This enables the continuation to start multiple <code>Coroutine&lt;_&gt;</code> and then wait for the results.</p></div><div><p dir="auto">This is how <code>Async.StartChild</code> works as well.</p></div><div><p dir="auto">The implementation of <code>runInParallel</code> is a bit more intricate than the previous functions but the basic idea is this:</p></div><div><ol>
<li data-line="0" dir="auto">Start the <code>Coroutine&lt;_&gt;</code> passed to with a special continuation. This continuation checks a shared state if there's a receiver for the result? If yes, invoke the receiver with the result. Otherwise, store the result.</li>
<li data-line="1" dir="auto">Create a new <code>Coroutine&lt;_&gt;</code> that once it receives a receiver checks the shared state to see if there's a result available. If yes, invoke the receiver with the value. Otherwise, store the receiver.</li>
</ol></div><div><p dir="auto">We have to account for multiple executing threads which complicates the code even further.</p></div><div><pre class="language-fsharp" tabindex="0"><code class="language-fsharp is-loaded"><span class="token keyword">let</span> runInParallel <span class="token punctuation">(</span>Co c<span class="token punctuation">)</span> <span class="token operator">=</span>
  Co <span class="token operator">&lt;|</span> <span class="token keyword">fun</span> r <span class="token operator">-&gt;</span>
    <span class="token keyword">let</span> <span class="token keyword">mutable</span> state <span class="token operator">=</span> Initial

    <span class="token comment">// Some of the cases in the matches are error cases but as mentioned</span>
    <span class="token comment">//  for this blog I avoid handling error cases.</span>

    <span class="token keyword">let</span> cr v <span class="token operator">=</span>
      <span class="token keyword">let</span> update s <span class="token operator">=</span>
        <span class="token keyword">match</span> s <span class="token keyword">with</span>
        <span class="token operator">|</span> Initial       <span class="token operator">-&gt;</span> ValueNone    <span class="token punctuation">,</span> HasValue v
        <span class="token operator">|</span> HasReceiver r <span class="token operator">-&gt;</span> ValueSome r  <span class="token punctuation">,</span> Done
        <span class="token operator">|</span> HasValue    _ <span class="token operator">-&gt;</span> ValueNone    <span class="token punctuation">,</span> HasValue v
        <span class="token operator">|</span> Done          <span class="token operator">-&gt;</span> ValueNone    <span class="token punctuation">,</span> Done
      <span class="token keyword">match</span> cas <span class="token operator">&amp;</span>state update <span class="token keyword">with</span>
      <span class="token operator">|</span> ValueSome r <span class="token operator">-&gt;</span> r v
      <span class="token operator">|</span> ValueNone   <span class="token operator">-&gt;</span> <span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment">// Starts the coroutine</span>
    c <span class="token operator">&lt;|</span> cr

    <span class="token keyword">let</span> cco cr <span class="token operator">=</span>
      <span class="token keyword">let</span> update s <span class="token operator">=</span>
        <span class="token keyword">match</span> s <span class="token keyword">with</span>
          <span class="token operator">|</span> Initial       <span class="token operator">-&gt;</span> ValueNone   <span class="token punctuation">,</span> HasReceiver cr
          <span class="token operator">|</span> HasReceiver _ <span class="token operator">-&gt;</span> ValueNone   <span class="token punctuation">,</span> HasReceiver cr
          <span class="token operator">|</span> HasValue    v <span class="token operator">-&gt;</span> ValueSome v <span class="token punctuation">,</span> Done
          <span class="token operator">|</span> Done          <span class="token operator">-&gt;</span> ValueNone   <span class="token punctuation">,</span> Done
      <span class="token keyword">match</span> cas <span class="token operator">&amp;</span>state update <span class="token keyword">with</span>
      <span class="token operator">|</span> ValueSome v <span class="token operator">-&gt;</span> cr v
      <span class="token operator">|</span> ValueNone   <span class="token operator">-&gt;</span> <span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment">// Passes a new coroutine to the receiver immediately</span>
    r <span class="token operator">&lt;|</span> Co cco
</code><button class="copy-code-button">Copy</button></pre></div></div></div><div class="heading-wrapper"><h3 data-heading="Downloading many pages in parallel" dir="auto" class="heading" id="Downloading_many_pages_in_parallel"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>Downloading many pages in parallel</h3><div class="heading-children"><div><p dir="auto">We can make the pattern above a bit more general like so:</p></div><div><pre class="language-fsharp" tabindex="0"><code class="language-fsharp is-loaded"><span class="token keyword">let</span> exampleDownloadManyPagesInParallel <span class="token operator">=</span>
  <span class="token keyword">let</span> download uri <span class="token operator">=</span>
    <span class="token computation-expression keyword">coroutine</span> <span class="token punctuation">{</span>
      <span class="token keyword">let!</span> text <span class="token operator">=</span> downloadFromUri uri
      <span class="token keyword">return</span> text<span class="token punctuation">.</span>Length
    <span class="token punctuation">}</span> <span class="token operator">|&gt;</span> debugf <span class="token string">"Download: %s"</span> <span class="token punctuation">(</span>string uri<span class="token punctuation">)</span>
  <span class="token computation-expression keyword">coroutine</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> uris        <span class="token operator">=</span> Array<span class="token punctuation">.</span>init <span class="token number">10</span> <span class="token punctuation">(</span><span class="token keyword">fun</span> i <span class="token operator">-&gt;</span> sprintf <span class="token string">"https://gist.github.com/mrange?page=%d"</span> <span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">let!</span> allLengths <span class="token operator">=</span> uris <span class="token operator">|&gt;</span> Array<span class="token punctuation">.</span>map download <span class="token operator">|&gt;</span> runAllInParallel <span class="token number">3</span>
    <span class="token keyword">return</span> allLengths
  <span class="token punctuation">}</span> <span class="token operator">|&gt;</span> time
</code><button class="copy-code-button">Copy</button></pre></div><div><p dir="auto">This prints:</p></div><div><pre><code>Press any key to exit
DEBUG - Download: https://gist.github.com/mrange?page=1 - INVOKE
DEBUG - Download: https://gist.github.com/mrange?page=2 - INVOKE
DEBUG - Download: https://gist.github.com/mrange?page=3 - INVOKE
DEBUG - Download: https://gist.github.com/mrange?page=1 - RESULT: 93883
DEBUG - Download: https://gist.github.com/mrange?page=2 - RESULT: 94160
DEBUG - Download: https://gist.github.com/mrange?page=3 - RESULT: 94602
DEBUG - Download: https://gist.github.com/mrange?page=4 - INVOKE
DEBUG - Download: https://gist.github.com/mrange?page=5 - INVOKE
DEBUG - Download: https://gist.github.com/mrange?page=6 - INVOKE
DEBUG - Download: https://gist.github.com/mrange?page=4 - RESULT: 97397
DEBUG - Download: https://gist.github.com/mrange?page=5 - RESULT: 93125
DEBUG - Download: https://gist.github.com/mrange?page=6 - RESULT: 89598
DEBUG - Download: https://gist.github.com/mrange?page=7 - INVOKE
DEBUG - Download: https://gist.github.com/mrange?page=8 - INVOKE
DEBUG - Download: https://gist.github.com/mrange?page=9 - INVOKE
DEBUG - Download: https://gist.github.com/mrange?page=7 - RESULT: 95235
DEBUG - Download: https://gist.github.com/mrange?page=8 - RESULT: 92106
DEBUG - Download: https://gist.github.com/mrange?page=9 - RESULT: 94957
DEBUG - Download: https://gist.github.com/mrange?page=10 - INVOKE
DEBUG - Download: https://gist.github.com/mrange?page=10 - RESULT: 91992
Result: (2342L, [|93883; 94160; 94602; 97397; 93125; 89598; 95235; 92106; 94957; 91992|])
</code><button class="copy-code-button">Copy</button></pre></div><div><p dir="auto">Thanks to <code>debugf</code> we see that it seems tasks are invoked in batches of 3 as intended.</p></div><div><p dir="auto"><code>debugf</code> is used to debug <code>Coroutine&lt;_&gt;</code>. As mentioned in the prelude a <code>Coroutine&lt;_&gt;</code> implies no call stack (the elimination of the call stack is kind of the point), this makes debugging harder. <code>debugf</code> helps by printing to the console when a named <code>Coroutine&lt;_&gt;</code> is started and completed:</p></div><div><pre class="language-fsharp" tabindex="0"><code class="language-fsharp is-loaded"><span class="token keyword">let</span> debug nm <span class="token punctuation">(</span>Co c<span class="token punctuation">)</span> <span class="token operator">=</span>
  Co <span class="token operator">&lt;|</span> <span class="token keyword">fun</span> r <span class="token operator">-&gt;</span>
    printfn <span class="token string">"DEBUG - %s - INVOKE"</span> nm
    <span class="token keyword">let</span> cr v <span class="token operator">=</span>
      printfn <span class="token string">"DEBUG - %s - RESULT: %A"</span> nm v
      r v
    c cr

<span class="token keyword">let</span> debugf fmt <span class="token operator">=</span> kprintf debug fmt
</code><button class="copy-code-button">Copy</button></pre></div><div><p dir="auto"><code>runAllInParallel</code> has the signature: <code>int -&gt; Coroutine&lt;'T&gt; array -&gt; Coroutine&lt;'T array&gt;</code>. That is it runs the coroutines in the input array in parallel. The integer decides how many it runs in parallel at the same time.</p></div><div><p dir="auto"><code>runAllInParallel</code> works by creating batches of <code>Coroutine&lt;_&gt;</code>. All <code>Coroutine&lt;_&gt;</code> in a batch is executed in parallel, when all <code>Coroutine&lt;_&gt;</code> in the batch has run to completion the next batch is started.</p></div><div><p dir="auto">A better approach would be to keep always keep the maximum number of <code>Coroutine&lt;_&gt;</code> running at all times but batching was easier to implement for the purpose of this blog:</p></div><div><pre class="language-fsharp" tabindex="0"><code class="language-fsharp is-loaded"><span class="token keyword">let</span> runAllInParallel parallelism <span class="token punctuation">(</span>cos <span class="token punctuation">:</span> <span class="token class-name">_</span> array<span class="token punctuation">)</span> <span class="token operator">=</span>
  <span class="token keyword">let</span> chunks <span class="token operator">=</span> cos <span class="token operator">|&gt;</span> Array<span class="token punctuation">.</span>indexed <span class="token operator">|&gt;</span> Array<span class="token punctuation">.</span>chunkBySize parallelism
  Co <span class="token operator">&lt;|</span> <span class="token keyword">fun</span> r <span class="token operator">-&gt;</span>
    <span class="token keyword">let</span> result <span class="token operator">=</span> Array<span class="token punctuation">.</span>zeroCreate cos<span class="token punctuation">.</span>Length
    <span class="token keyword">let</span> <span class="token keyword">rec</span> loop i <span class="token operator">=</span>
      <span class="token keyword">if</span> i <span class="token operator">&lt;</span> chunks<span class="token punctuation">.</span>Length <span class="token keyword">then</span>
        <span class="token keyword">let</span> chunk <span class="token operator">=</span> chunks<span class="token punctuation">.</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span>
        <span class="token keyword">let</span> children <span class="token operator">=</span> chunk <span class="token operator">|&gt;</span> Array<span class="token punctuation">.</span>map <span class="token punctuation">(</span><span class="token keyword">fun</span> <span class="token punctuation">(</span>j<span class="token punctuation">,</span> co<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> runInParallel co <span class="token operator">|&gt;</span> join <span class="token operator">|&gt;</span> map <span class="token punctuation">(</span><span class="token keyword">fun</span> v <span class="token operator">-&gt;</span> j<span class="token punctuation">,</span> v<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">let</span> <span class="token keyword">mutable</span> remaining <span class="token operator">=</span> children<span class="token punctuation">.</span>Length
        <span class="token keyword">let</span> cr <span class="token punctuation">(</span>j<span class="token punctuation">,</span> v<span class="token punctuation">)</span> <span class="token operator">=</span>
          result<span class="token punctuation">.</span><span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">&lt;-</span> v
          <span class="token keyword">if</span> Interlocked<span class="token punctuation">.</span>Decrement <span class="token operator">&amp;</span>remaining <span class="token operator">=</span> <span class="token number">0</span> <span class="token keyword">then</span> loop <span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>Co c<span class="token punctuation">)</span> <span class="token keyword">in</span> children <span class="token keyword">do</span>
          c cr
      <span class="token keyword">else</span>
        r result
    loop <span class="token number">0</span>
</code><button class="copy-code-button">Copy</button></pre></div></div></div><div class="heading-wrapper"><h3 data-heading="What about CPU bound problems?" dir="auto" class="heading" id="What_about_CPU_bound_problems?"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>What about CPU bound problems?</h3><div class="heading-children"><div><p dir="auto"><code>Coroutine&lt;_&gt;</code> is intended for IO bound tasks where the CPU is sitting most of the time waiting on IO. It is possible using <code>Coroutine&lt;_&gt;</code> for CPU bound tasks but you need to explicitly switch to a worker thread. For example; let's say you want to compute the mandelbrot set:</p></div><div><pre class="language-fsharp" tabindex="0"><code class="language-fsharp is-loaded"><span class="token keyword">let</span> exampleCPUBoundProblem <span class="token operator">=</span>

  <span class="token keyword">let</span> d <span class="token operator">=</span> <span class="token number">2048</span>
  <span class="token keyword">let</span> lines <span class="token punctuation">(</span>pixels <span class="token punctuation">:</span> <span class="token class-name">byte</span> array<span class="token punctuation">)</span> f t <span class="token operator">=</span>
    <span class="token comment">// Mandelbrot specific code deleted, it's in the full source code below</span>
    <span class="token punctuation">(</span><span class="token punctuation">)</span>

  <span class="token keyword">let</span> colines <span class="token punctuation">(</span>pixels <span class="token punctuation">:</span> <span class="token class-name">byte</span> array<span class="token punctuation">)</span> f t <span class="token operator">=</span>
    <span class="token computation-expression keyword">coroutine</span> <span class="token punctuation">{</span>
      <span class="token comment">// Switches to a thread pool thread that will do the work</span>
      <span class="token keyword">do</span><span class="token operator">!</span> switchToThreadPool
      lines pixels f t
      <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token computation-expression keyword">coroutine</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> pixels <span class="token operator">=</span> Array<span class="token punctuation">.</span>zeroCreate <span class="token punctuation">(</span>r<span class="token operator">*</span>d<span class="token punctuation">)</span>

    <span class="token keyword">let</span>  s  <span class="token operator">=</span> d <span class="token operator">/</span> <span class="token number">4</span>
    <span class="token comment">// Run 4 Coroutine&lt;_&gt; in parallel</span>
    <span class="token keyword">let!</span> s0 <span class="token operator">=</span> runInParallel <span class="token operator">&lt;|</span> colines pixels <span class="token punctuation">(</span><span class="token number">0</span><span class="token operator">*</span>s<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">*</span>s<span class="token punctuation">)</span>
    <span class="token keyword">let!</span> s1 <span class="token operator">=</span> runInParallel <span class="token operator">&lt;|</span> colines pixels <span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">*</span>s<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">2</span><span class="token operator">*</span>s<span class="token punctuation">)</span>
    <span class="token keyword">let!</span> s2 <span class="token operator">=</span> runInParallel <span class="token operator">&lt;|</span> colines pixels <span class="token punctuation">(</span><span class="token number">2</span><span class="token operator">*</span>s<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">3</span><span class="token operator">*</span>s<span class="token punctuation">)</span>
    <span class="token keyword">let!</span> s3 <span class="token operator">=</span> runInParallel <span class="token operator">&lt;|</span> colines pixels <span class="token punctuation">(</span><span class="token number">3</span><span class="token operator">*</span>s<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">4</span><span class="token operator">*</span>s<span class="token punctuation">)</span>

    <span class="token keyword">do</span><span class="token operator">!</span> s0
    <span class="token keyword">do</span><span class="token operator">!</span> s1
    <span class="token keyword">do</span><span class="token operator">!</span> s2
    <span class="token keyword">do</span><span class="token operator">!</span> s3

    <span class="token keyword">let</span> img     <span class="token operator">=</span> File<span class="token punctuation">.</span>Create <span class="token string">"mandelbrot.pbm"</span>
    <span class="token keyword">let</span> sw      <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StreamWriter</span> <span class="token punctuation">(</span>img<span class="token punctuation">)</span>

    <span class="token keyword">do</span><span class="token operator">!</span> sw<span class="token punctuation">.</span>WriteAsync  <span class="token punctuation">(</span>sprintf <span class="token string">"P4\n%d %d\n"</span> d d<span class="token punctuation">)</span>
    <span class="token keyword">do</span><span class="token operator">!</span> sw<span class="token punctuation">.</span>FlushAsync  <span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">do</span><span class="token operator">!</span> img<span class="token punctuation">.</span>WriteAsync <span class="token punctuation">(</span>pixels<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> pixels<span class="token punctuation">.</span>Length<span class="token punctuation">)</span>

    <span class="token comment">// Coroutine&lt;_&gt; doesn't support use!</span>
    sw<span class="token punctuation">.</span>Dispose <span class="token punctuation">(</span><span class="token punctuation">)</span>
    img<span class="token punctuation">.</span>Dispose <span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token operator">|&gt;</span> time
</code><button class="copy-code-button">Copy</button></pre></div><div><p dir="auto">The key here is <code>do! switchToThreadPool</code>, without it the <code>colines</code> would execute on the calling thread until completion and then execute the next <code>colines</code> essentially a sequential operation. With <code>do! switchToThreadPool</code> the <code>colines</code> transfer execution to the thread pool and the continuation can start the other <code>colines</code> <code>Coroutine&lt;_&gt;</code> each running in the thread pool.</p></div><div><pre class="language-fsharp" tabindex="0"><code class="language-fsharp is-loaded"><span class="token keyword">let</span> switchToThreadPool <span class="token operator">=</span>
  Co <span class="token operator">&lt;|</span> <span class="token keyword">fun</span> r <span class="token operator">-&gt;</span>
    <span class="token comment">// This makes the continuation execute on the thread pool</span>
    <span class="token comment">//  the calling thread can continue executing other code</span>
    <span class="token keyword">let</span> wc _ <span class="token operator">=</span> r <span class="token punctuation">(</span><span class="token punctuation">)</span>
    ThreadPool<span class="token punctuation">.</span>QueueUserWorkItem <span class="token punctuation">(</span>WaitCallback wc<span class="token punctuation">)</span> <span class="token operator">|&gt;</span> ignore
</code><button class="copy-code-button">Copy</button></pre></div><div><p dir="auto">With <code>do! switchToThreadPool</code> it prints:</p></div><div><pre><code>Result: (748L, ())
</code><button class="copy-code-button">Copy</button></pre></div><div><p dir="auto">This means the execution took 748 ms.</p></div><div><p dir="auto">Without <code>do! switchToThreadPool</code> it prints:</p></div><div><pre><code>Result: (1648L, ())
</code><button class="copy-code-button">Copy</button></pre></div><div><p dir="auto">This means the execution took 1648 ms.</p></div><div><p dir="auto">The speed up we gain from utilizing multiple cores. The reason for the rather poor speed up is that we just split the problem into 4 chunks and starts executing but the way the mandelbrot works the chunks are not even in CPU demand so <code>colines</code> will complete unevenly giving poor usage of the CPU resources. Like mentioned; coroutines are intended for IO bound tasks. For CPU bound tasks we should look for other abstractions such as <code>Parallel.ForEach</code> which utilizes work stealing algorithms to mitigate the issue of uneven CPU demand.</p></div></div></div></div></div><div class="heading-wrapper"><h1 data-heading="Conclusion" dir="auto" class="heading" id="Conclusion">Conclusion</h1><div class="heading-children"><div><p dir="auto">There you have it, a functioning <code>Coroutine&lt;_&gt;</code> library in F# with the massive caveat that if a continuation throws an exception it all breaks down hard. This is fixable and <code>Async</code> in F# supports exceptions by having special continuation functions for exceptions and cancellation of coroutines.</p></div><div><p dir="auto">In addition; <code>Async</code> in F# also avoids stack overflows by implementing a common functional pattern called trampolines.</p></div><div><p dir="auto">As I wanted to keep down the complexity in order to not hide the idea of coroutines using continuations in a forest of error-handling code I just ignored all of it.</p></div><div><p dir="auto">To summarize, a coroutine based on continuations can look like this:</p></div><div><pre class="language-fsharp" tabindex="0"><code class="language-fsharp is-loaded"><span class="token keyword">type</span> <span class="token annotation"><span class="token punctuation">[&lt;</span><span class="token class-name">Struct</span><span class="token punctuation">&gt;]</span></span> Coroutine<span class="token operator">&lt;</span>'T<span class="token operator">&gt;</span> <span class="token operator">=</span> Co <span class="token keyword">of</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>'T <span class="token operator">-&gt;</span> unit<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> unit<span class="token punctuation">)</span>
</code><button class="copy-code-button">Copy</button></pre></div><div><p dir="auto">The coroutine is started when it is passed a continuation function, when the result is available the continuation function is invoked.</p></div></div></div><div class="heading-wrapper"><h1 data-heading="[F#] Full source code" dir="auto" class="heading" id="[F#]_Full_source_code">[F#] Full source code</h1><div class="heading-children"><div><pre class="language-fsharp" tabindex="0"><code class="language-fsharp is-loaded"><span class="token keyword">module</span> MinimalisticCoroutine <span class="token operator">=</span>

  <span class="token keyword">type</span> <span class="token annotation"><span class="token punctuation">[&lt;</span><span class="token class-name">Struct</span><span class="token punctuation">&gt;]</span></span> Coroutine<span class="token operator">&lt;</span>'T<span class="token operator">&gt;</span> <span class="token operator">=</span> Co <span class="token keyword">of</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>'T <span class="token operator">-&gt;</span> unit<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> unit<span class="token punctuation">)</span>

  <span class="token keyword">module</span> Coroutine <span class="token operator">=</span>
    <span class="token keyword">open</span> FSharp<span class="token punctuation">.</span>Core<span class="token punctuation">.</span>Printf

    <span class="token keyword">open</span> System
    <span class="token keyword">open</span> System<span class="token punctuation">.</span>Diagnostics
    <span class="token keyword">open</span> System<span class="token punctuation">.</span>Threading
    <span class="token keyword">open</span> System<span class="token punctuation">.</span>Threading<span class="token punctuation">.</span>Tasks

    <span class="token keyword">module</span> Details <span class="token operator">=</span>
      <span class="token keyword">let</span> <span class="token keyword">inline</span> refEq<span class="token operator">&lt;</span>'T <span class="token keyword">when</span> 'T <span class="token punctuation">:</span> <span class="token class-name">not</span> <span class="token keyword">struct</span><span class="token operator">&gt;</span> <span class="token punctuation">(</span>a <span class="token punctuation">:</span> 'T<span class="token punctuation">)</span> <span class="token punctuation">(</span>b <span class="token punctuation">:</span> 'T<span class="token punctuation">)</span> <span class="token operator">=</span> Object<span class="token punctuation">.</span>ReferenceEquals <span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span>

      <span class="token keyword">module</span> Loops <span class="token operator">=</span>
        <span class="token keyword">let</span> <span class="token keyword">rec</span> cas <span class="token punctuation">(</span>rs <span class="token punctuation">:</span> <span class="token class-name">byref</span><span class="token operator">&lt;</span>'T<span class="token operator">&gt;</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>cs <span class="token punctuation">:</span> 'T<span class="token punctuation">)</span> u <span class="token punctuation">:</span> 'U <span class="token operator">=</span>
          <span class="token keyword">let</span> v<span class="token punctuation">,</span> ns   <span class="token operator">=</span> u cs
          <span class="token keyword">let</span> acs     <span class="token operator">=</span> Interlocked<span class="token punctuation">.</span><span class="token function">CompareExchange</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>rs<span class="token punctuation">,</span> ns<span class="token punctuation">,</span> cs<span class="token punctuation">)</span>
          <span class="token keyword">if</span> refEq acs cs <span class="token keyword">then</span> v
          <span class="token keyword">else</span> cas <span class="token operator">&amp;</span>rs acs u

      <span class="token keyword">let</span> sw <span class="token operator">=</span>
        <span class="token keyword">let</span> sw <span class="token operator">=</span> Stopwatch <span class="token punctuation">(</span><span class="token punctuation">)</span>
        sw<span class="token punctuation">.</span>Start <span class="token punctuation">(</span><span class="token punctuation">)</span>
        sw

      <span class="token keyword">let</span> cas <span class="token punctuation">(</span>rs <span class="token punctuation">:</span> <span class="token class-name">byref</span><span class="token operator">&lt;</span>_<span class="token operator">&gt;</span><span class="token punctuation">)</span> u <span class="token operator">=</span>
        <span class="token keyword">let</span> cs <span class="token operator">=</span> rs
        Interlocked<span class="token punctuation">.</span>MemoryBarrier <span class="token punctuation">(</span><span class="token punctuation">)</span>
        Loops<span class="token punctuation">.</span>cas <span class="token operator">&amp;</span>rs cs u

      <span class="token keyword">type</span> <span class="token class-name">ChildState</span><span class="token operator">&lt;</span>'T<span class="token operator">&gt;</span> <span class="token operator">=</span>
        <span class="token operator">|</span> Initial
        <span class="token operator">|</span> HasReceiver <span class="token keyword">of</span> <span class="token punctuation">(</span>'T <span class="token operator">-&gt;</span> unit<span class="token punctuation">)</span>
        <span class="token operator">|</span> HasValue    <span class="token keyword">of</span> 'T
        <span class="token operator">|</span> Done

    <span class="token keyword">open</span> Details

    <span class="token keyword">let</span> result v <span class="token operator">=</span>
      Co <span class="token operator">&lt;|</span> <span class="token keyword">fun</span> r <span class="token operator">-&gt;</span>
        r v

    <span class="token keyword">let</span> bind <span class="token punctuation">(</span>Co c<span class="token punctuation">)</span> f <span class="token operator">=</span>
      Co <span class="token operator">&lt;|</span>
        <span class="token keyword">fun</span> r <span class="token operator">-&gt;</span>
          <span class="token keyword">let</span> cr v <span class="token operator">=</span>
            <span class="token keyword">let</span> <span class="token punctuation">(</span>Co d<span class="token punctuation">)</span> <span class="token operator">=</span> f v
            d r
          c cr

    <span class="token keyword">let</span> combine <span class="token punctuation">(</span>Co c<span class="token punctuation">)</span> <span class="token punctuation">(</span>Co d<span class="token punctuation">)</span> <span class="token operator">=</span>
      Co <span class="token operator">&lt;|</span>
        <span class="token keyword">fun</span> r <span class="token operator">-&gt;</span>
          <span class="token keyword">let</span> cr _ <span class="token operator">=</span>
            d r
          c cr

    <span class="token keyword">let</span> apply <span class="token punctuation">(</span>Co c<span class="token punctuation">)</span> <span class="token punctuation">(</span>Co d<span class="token punctuation">)</span> <span class="token operator">=</span>
      Co <span class="token operator">&lt;|</span>
        <span class="token keyword">fun</span> r <span class="token operator">-&gt;</span>
          <span class="token keyword">let</span> cr f <span class="token operator">=</span>
            <span class="token keyword">let</span> dr v <span class="token operator">=</span> r <span class="token punctuation">(</span>f v<span class="token punctuation">)</span>
            d dr
          c cr

    <span class="token keyword">let</span> map m <span class="token punctuation">(</span>Co c<span class="token punctuation">)</span> <span class="token operator">=</span>
      Co <span class="token operator">&lt;|</span> <span class="token keyword">fun</span> r <span class="token operator">-&gt;</span>
        <span class="token keyword">let</span> cr v <span class="token operator">=</span> r <span class="token punctuation">(</span>m v<span class="token punctuation">)</span>
        c cr

    <span class="token keyword">let</span> unfold uf z <span class="token operator">=</span>
      Co <span class="token operator">&lt;|</span> <span class="token keyword">fun</span> r <span class="token operator">-&gt;</span>
        <span class="token keyword">let</span> ra <span class="token operator">=</span> ResizeArray <span class="token number">16</span>
        <span class="token keyword">let</span> <span class="token keyword">rec</span> cr p <span class="token operator">=</span>
          <span class="token keyword">match</span> p <span class="token keyword">with</span>
          <span class="token operator">|</span> None        <span class="token operator">-&gt;</span> r <span class="token punctuation">(</span>ra<span class="token punctuation">.</span>ToArray <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
          <span class="token operator">|</span> Some <span class="token punctuation">(</span>s<span class="token punctuation">,</span> v<span class="token punctuation">)</span> <span class="token operator">-&gt;</span>
            ra<span class="token punctuation">.</span>Add v
            <span class="token keyword">let</span> <span class="token punctuation">(</span>Co c<span class="token punctuation">)</span> <span class="token operator">=</span> uf s
            c cr
        <span class="token keyword">let</span> <span class="token punctuation">(</span>Co c<span class="token punctuation">)</span> <span class="token operator">=</span> uf z
        c cr

    <span class="token keyword">let</span> debug nm <span class="token punctuation">(</span>Co c<span class="token punctuation">)</span> <span class="token operator">=</span>
      Co <span class="token operator">&lt;|</span> <span class="token keyword">fun</span> r <span class="token operator">-&gt;</span>
        printfn <span class="token string">"DEBUG - %s - INVOKE"</span> nm
        <span class="token keyword">let</span> cr v <span class="token operator">=</span>
          printfn <span class="token string">"DEBUG - %s - RESULT: %A"</span> nm v
          r v
        c cr

    <span class="token keyword">let</span> debugf fmt <span class="token operator">=</span> kprintf debug fmt

    <span class="token keyword">let</span> time <span class="token punctuation">(</span>Co c<span class="token punctuation">)</span> <span class="token operator">=</span>
      Co <span class="token operator">&lt;|</span> <span class="token keyword">fun</span> r <span class="token operator">-&gt;</span>
        <span class="token keyword">let</span> before <span class="token operator">=</span> sw<span class="token punctuation">.</span>ElapsedMilliseconds
        <span class="token keyword">let</span> cr v <span class="token operator">=</span>
          <span class="token keyword">let</span> after <span class="token operator">=</span> sw<span class="token punctuation">.</span>ElapsedMilliseconds
          r <span class="token punctuation">(</span>after <span class="token operator">-</span> before<span class="token punctuation">,</span> v<span class="token punctuation">)</span>
        c cr

    <span class="token keyword">let</span> switchToNewThread <span class="token operator">=</span>
      Co <span class="token operator">&lt;|</span> <span class="token keyword">fun</span> r <span class="token operator">-&gt;</span>
        <span class="token keyword">let</span> ts <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span>  r <span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">let</span> t <span class="token operator">=</span> Thread <span class="token punctuation">(</span>ThreadStart ts<span class="token punctuation">)</span>
        t<span class="token punctuation">.</span>IsBackground  <span class="token operator">&lt;-</span> <span class="token keyword">true</span>
        t<span class="token punctuation">.</span>Name          <span class="token operator">&lt;-</span> <span class="token string">"Coroutine thread"</span>
        t<span class="token punctuation">.</span>Start <span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">let</span> switchToThreadPool <span class="token operator">=</span>
      Co <span class="token operator">&lt;|</span> <span class="token keyword">fun</span> r <span class="token operator">-&gt;</span>
        <span class="token keyword">let</span> wc _ <span class="token operator">=</span> r <span class="token punctuation">(</span><span class="token punctuation">)</span>
        ThreadPool<span class="token punctuation">.</span>QueueUserWorkItem <span class="token punctuation">(</span>WaitCallback wc<span class="token punctuation">)</span> <span class="token operator">|&gt;</span> ignore

    <span class="token keyword">let</span> join <span class="token punctuation">(</span>Co c<span class="token punctuation">)</span> <span class="token operator">=</span>
      Co <span class="token operator">&lt;|</span> <span class="token keyword">fun</span> r <span class="token operator">-&gt;</span>
        <span class="token keyword">let</span> cr <span class="token punctuation">(</span>Co d<span class="token punctuation">)</span> <span class="token operator">=</span> d r
        c cr

    <span class="token keyword">let</span> runInParallel <span class="token punctuation">(</span>Co c<span class="token punctuation">)</span> <span class="token operator">=</span>
      Co <span class="token operator">&lt;|</span> <span class="token keyword">fun</span> r <span class="token operator">-&gt;</span>
        <span class="token keyword">let</span> <span class="token keyword">mutable</span> state <span class="token operator">=</span> Initial

        <span class="token keyword">let</span> cr v <span class="token operator">=</span>
          <span class="token keyword">let</span> update s <span class="token operator">=</span>
            <span class="token keyword">match</span> s <span class="token keyword">with</span>
            <span class="token operator">|</span> Initial       <span class="token operator">-&gt;</span> ValueNone    <span class="token punctuation">,</span> HasValue v
            <span class="token operator">|</span> HasReceiver r <span class="token operator">-&gt;</span> ValueSome r  <span class="token punctuation">,</span> Done
            <span class="token operator">|</span> HasValue    _ <span class="token operator">-&gt;</span> ValueNone    <span class="token punctuation">,</span> HasValue v
            <span class="token operator">|</span> Done          <span class="token operator">-&gt;</span> ValueNone    <span class="token punctuation">,</span> Done
          <span class="token keyword">match</span> cas <span class="token operator">&amp;</span>state update <span class="token keyword">with</span>
          <span class="token operator">|</span> ValueSome r <span class="token operator">-&gt;</span> r v
          <span class="token operator">|</span> ValueNone   <span class="token operator">-&gt;</span> <span class="token punctuation">(</span><span class="token punctuation">)</span>

        c <span class="token operator">&lt;|</span> cr

        <span class="token keyword">let</span> cco cr <span class="token operator">=</span>
          <span class="token keyword">let</span> update s <span class="token operator">=</span>
            <span class="token keyword">match</span> s <span class="token keyword">with</span>
              <span class="token operator">|</span> Initial       <span class="token operator">-&gt;</span> ValueNone   <span class="token punctuation">,</span> HasReceiver cr
              <span class="token operator">|</span> HasReceiver _ <span class="token operator">-&gt;</span> ValueNone   <span class="token punctuation">,</span> HasReceiver cr
              <span class="token operator">|</span> HasValue    v <span class="token operator">-&gt;</span> ValueSome v <span class="token punctuation">,</span> Done
              <span class="token operator">|</span> Done          <span class="token operator">-&gt;</span> ValueNone   <span class="token punctuation">,</span> Done
          <span class="token keyword">match</span> cas <span class="token operator">&amp;</span>state update <span class="token keyword">with</span>
          <span class="token operator">|</span> ValueSome v <span class="token operator">-&gt;</span> cr v
          <span class="token operator">|</span> ValueNone   <span class="token operator">-&gt;</span> <span class="token punctuation">(</span><span class="token punctuation">)</span>

        r <span class="token operator">&lt;|</span> Co cco

    <span class="token keyword">let</span> runAllInParallel parallelism <span class="token punctuation">(</span>cos <span class="token punctuation">:</span> <span class="token class-name">_</span> array<span class="token punctuation">)</span> <span class="token operator">=</span>
      <span class="token keyword">let</span> chunks <span class="token operator">=</span> cos <span class="token operator">|&gt;</span> Array<span class="token punctuation">.</span>indexed <span class="token operator">|&gt;</span> Array<span class="token punctuation">.</span>chunkBySize parallelism
      Co <span class="token operator">&lt;|</span> <span class="token keyword">fun</span> r <span class="token operator">-&gt;</span>
        <span class="token keyword">let</span> result <span class="token operator">=</span> Array<span class="token punctuation">.</span>zeroCreate cos<span class="token punctuation">.</span>Length
        <span class="token keyword">let</span> <span class="token keyword">rec</span> loop i <span class="token operator">=</span>
          <span class="token keyword">if</span> i <span class="token operator">&lt;</span> chunks<span class="token punctuation">.</span>Length <span class="token keyword">then</span>
            <span class="token keyword">let</span> chunk <span class="token operator">=</span> chunks<span class="token punctuation">.</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span>
            <span class="token keyword">let</span> children <span class="token operator">=</span> chunk <span class="token operator">|&gt;</span> Array<span class="token punctuation">.</span>map <span class="token punctuation">(</span><span class="token keyword">fun</span> <span class="token punctuation">(</span>j<span class="token punctuation">,</span> co<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> runInParallel co <span class="token operator">|&gt;</span> join <span class="token operator">|&gt;</span> map <span class="token punctuation">(</span><span class="token keyword">fun</span> v <span class="token operator">-&gt;</span> j<span class="token punctuation">,</span> v<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">let</span> <span class="token keyword">mutable</span> remaining <span class="token operator">=</span> children<span class="token punctuation">.</span>Length
            <span class="token keyword">let</span> cr <span class="token punctuation">(</span>j<span class="token punctuation">,</span> v<span class="token punctuation">)</span> <span class="token operator">=</span>
              result<span class="token punctuation">.</span><span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">&lt;-</span> v
              <span class="token keyword">if</span> Interlocked<span class="token punctuation">.</span>Decrement <span class="token operator">&amp;</span>remaining <span class="token operator">=</span> <span class="token number">0</span> <span class="token keyword">then</span> loop <span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span>Co c<span class="token punctuation">)</span> <span class="token keyword">in</span> children <span class="token keyword">do</span>
              c cr
          <span class="token keyword">else</span>
            r result
        loop <span class="token number">0</span>

    <span class="token keyword">let</span> ofTask <span class="token punctuation">(</span>t <span class="token punctuation">:</span> <span class="token class-name">Task</span><span class="token operator">&lt;</span>_<span class="token operator">&gt;</span><span class="token punctuation">)</span> <span class="token operator">=</span>
      Co <span class="token operator">&lt;|</span> <span class="token keyword">fun</span> r <span class="token operator">-&gt;</span>
        <span class="token keyword">let</span> cw <span class="token punctuation">(</span>t <span class="token punctuation">:</span> <span class="token class-name">Task</span><span class="token operator">&lt;</span>_<span class="token operator">&gt;</span><span class="token punctuation">)</span> <span class="token operator">=</span> r t<span class="token punctuation">.</span>Result
        t<span class="token punctuation">.</span>ContinueWith <span class="token punctuation">(</span>Action<span class="token operator">&lt;</span>Task<span class="token operator">&lt;</span>'T<span class="token operator">&gt;&gt;</span> cw<span class="token punctuation">)</span> <span class="token operator">|&gt;</span> ignore

    <span class="token keyword">let</span> ofUnitTask <span class="token punctuation">(</span>t <span class="token punctuation">:</span> <span class="token class-name">Task</span><span class="token punctuation">)</span> <span class="token operator">=</span>
      Co <span class="token operator">&lt;|</span> <span class="token keyword">fun</span> r <span class="token operator">-&gt;</span>
        <span class="token keyword">let</span> cw <span class="token punctuation">(</span>_ <span class="token punctuation">:</span> <span class="token class-name">Task</span><span class="token punctuation">)</span> <span class="token operator">=</span> r <span class="token punctuation">(</span><span class="token punctuation">)</span>
        t<span class="token punctuation">.</span>ContinueWith <span class="token punctuation">(</span>Action<span class="token operator">&lt;</span>Task<span class="token operator">&gt;</span> cw<span class="token punctuation">)</span> <span class="token operator">|&gt;</span> ignore

    <span class="token keyword">let</span> invoke <span class="token punctuation">(</span>Co c<span class="token punctuation">)</span> r <span class="token operator">=</span>
      <span class="token keyword">let</span> wc _ <span class="token operator">=</span> c r
      ThreadPool<span class="token punctuation">.</span>QueueUserWorkItem <span class="token punctuation">(</span>WaitCallback wc<span class="token punctuation">)</span> <span class="token operator">|&gt;</span> ignore

    <span class="token keyword">type</span> <span class="token class-name">Builder</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span>
      <span class="token keyword">class</span>
        <span class="token keyword">member</span> x<span class="token punctuation">.</span>Bind       <span class="token punctuation">(</span>c<span class="token punctuation">,</span> f<span class="token punctuation">)</span>  <span class="token punctuation">:</span> Coroutine<span class="token operator">&lt;</span>_<span class="token operator">&gt;</span> <span class="token operator">=</span> bind     c               f
        <span class="token keyword">member</span> x<span class="token punctuation">.</span>Bind       <span class="token punctuation">(</span>t<span class="token punctuation">,</span> f<span class="token punctuation">)</span>  <span class="token punctuation">:</span> Coroutine<span class="token operator">&lt;</span>_<span class="token operator">&gt;</span> <span class="token operator">=</span> bind     <span class="token punctuation">(</span>ofTask t<span class="token punctuation">)</span>      f
        <span class="token keyword">member</span> x<span class="token punctuation">.</span>Bind       <span class="token punctuation">(</span>t<span class="token punctuation">,</span> f<span class="token punctuation">)</span>  <span class="token punctuation">:</span> Coroutine<span class="token operator">&lt;</span>_<span class="token operator">&gt;</span> <span class="token operator">=</span> bind     <span class="token punctuation">(</span>ofUnitTask t<span class="token punctuation">)</span>  f
        <span class="token keyword">member</span> x<span class="token punctuation">.</span>Combine    <span class="token punctuation">(</span>c<span class="token punctuation">,</span> d<span class="token punctuation">)</span>  <span class="token punctuation">:</span> Coroutine<span class="token operator">&lt;</span>_<span class="token operator">&gt;</span> <span class="token operator">=</span> combine  c               d
        <span class="token keyword">member</span> x<span class="token punctuation">.</span>Combine    <span class="token punctuation">(</span>t<span class="token punctuation">,</span> d<span class="token punctuation">)</span>  <span class="token punctuation">:</span> Coroutine<span class="token operator">&lt;</span>_<span class="token operator">&gt;</span> <span class="token operator">=</span> combine  <span class="token punctuation">(</span>ofUnitTask t<span class="token punctuation">)</span>  d
        <span class="token keyword">member</span> x<span class="token punctuation">.</span>Return     v       <span class="token punctuation">:</span> <span class="token class-name">Coroutine</span><span class="token operator">&lt;</span>_<span class="token operator">&gt;</span> <span class="token operator">=</span> result   v
        <span class="token keyword">member</span> x<span class="token punctuation">.</span>ReturnFrom c       <span class="token punctuation">:</span> <span class="token class-name">Coroutine</span><span class="token operator">&lt;</span>_<span class="token operator">&gt;</span> <span class="token operator">=</span> c
        <span class="token keyword">member</span> x<span class="token punctuation">.</span>ReturnFrom t       <span class="token punctuation">:</span> <span class="token class-name">Coroutine</span><span class="token operator">&lt;</span>_<span class="token operator">&gt;</span> <span class="token operator">=</span> ofTask   t
        <span class="token keyword">member</span> x<span class="token punctuation">.</span>Zero       <span class="token punctuation">(</span><span class="token punctuation">)</span>      <span class="token punctuation">:</span> Coroutine<span class="token operator">&lt;</span>_<span class="token operator">&gt;</span> <span class="token operator">=</span> result   <span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token keyword">end</span>
  <span class="token keyword">let</span> coroutine <span class="token operator">=</span> Coroutine<span class="token punctuation">.</span>Builder <span class="token punctuation">(</span><span class="token punctuation">)</span>

  <span class="token keyword">type</span> <span class="token class-name">Coroutine</span><span class="token operator">&lt;</span>'T<span class="token operator">&gt;</span> <span class="token keyword">with</span>
    <span class="token keyword">static</span> <span class="token keyword">member</span> <span class="token punctuation">(</span><span class="token operator">&gt;&gt;</span><span class="token operator">=</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>c<span class="token punctuation">,</span> f<span class="token punctuation">)</span> <span class="token operator">=</span> Coroutine<span class="token punctuation">.</span>bind     f c
    <span class="token keyword">static</span> <span class="token keyword">member</span> <span class="token punctuation">(</span><span class="token operator">&gt;&gt;</span><span class="token punctuation">.</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>c<span class="token punctuation">,</span> d<span class="token punctuation">)</span> <span class="token operator">=</span> Coroutine<span class="token punctuation">.</span>combine  c d
    <span class="token keyword">static</span> <span class="token keyword">member</span> <span class="token punctuation">(</span><span class="token operator">&lt;</span><span class="token operator">*</span><span class="token operator">&gt;</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>c<span class="token punctuation">,</span> d<span class="token punctuation">)</span> <span class="token operator">=</span> Coroutine<span class="token punctuation">.</span>apply    c d
    <span class="token keyword">static</span> <span class="token keyword">member</span> <span class="token punctuation">(</span><span class="token operator">|&gt;</span><span class="token operator">&gt;</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>c<span class="token punctuation">,</span> m<span class="token punctuation">)</span> <span class="token operator">=</span> Coroutine<span class="token punctuation">.</span>map      m c

<span class="token keyword">open</span> MinimalisticCoroutine

<span class="token keyword">open</span> System
<span class="token keyword">open</span> System<span class="token punctuation">.</span>IO
<span class="token keyword">open</span> System<span class="token punctuation">.</span>Net
<span class="token keyword">open</span> System<span class="token punctuation">.</span>Threading<span class="token punctuation">.</span>Tasks

<span class="token keyword">open</span> Coroutine

<span class="token keyword">let</span> downloadFromUri uri <span class="token operator">=</span>
  <span class="token computation-expression keyword">coroutine</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> wc    <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WebClient</span> <span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">let!</span> txt  <span class="token operator">=</span> wc<span class="token punctuation">.</span>DownloadStringTaskAsync <span class="token punctuation">(</span>Uri uri<span class="token punctuation">)</span>
    wc<span class="token punctuation">.</span>Dispose <span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> txt
  <span class="token punctuation">}</span>

<span class="token keyword">let</span> exampleDownloadFromGoogle <span class="token operator">=</span>
  <span class="token computation-expression keyword">coroutine</span> <span class="token punctuation">{</span>
    <span class="token keyword">let!</span> txt <span class="token operator">=</span> downloadFromUri <span class="token string">"https://www.google.com/"</span>
    <span class="token keyword">return</span> txt<span class="token punctuation">.</span>Length
  <span class="token punctuation">}</span>

<span class="token keyword">let</span> exampleDownloadFromGoogleAndBing <span class="token operator">=</span>
  <span class="token computation-expression keyword">coroutine</span> <span class="token punctuation">{</span>
    <span class="token keyword">let!</span> google <span class="token operator">=</span> downloadFromUri <span class="token string">"https://www.google.com/"</span>
    <span class="token keyword">let!</span> bing   <span class="token operator">=</span> downloadFromUri <span class="token string">"https://www.bing.com/"</span>
    <span class="token keyword">return</span> google<span class="token punctuation">.</span>Length<span class="token punctuation">,</span> bing<span class="token punctuation">.</span>Length
  <span class="token punctuation">}</span>

<span class="token keyword">let</span> exampleDownloadFromGoogleAndBingInParallel <span class="token operator">=</span>
  <span class="token computation-expression keyword">coroutine</span> <span class="token punctuation">{</span>
    <span class="token comment">// Start the download coroutines in parallel</span>
    <span class="token keyword">let!</span> cgoogle <span class="token operator">=</span> runInParallel <span class="token operator">&lt;|</span> downloadFromUri <span class="token string">"https://www.google.com/"</span>
    <span class="token keyword">let!</span> cbing   <span class="token operator">=</span> runInParallel <span class="token operator">&lt;|</span> downloadFromUri <span class="token string">"https://www.bing.com/"</span>

    <span class="token comment">// Wait for the coroutines to complete</span>
    <span class="token keyword">let!</span> google  <span class="token operator">=</span> cgoogle
    <span class="token keyword">let!</span> bing    <span class="token operator">=</span> cbing

    <span class="token keyword">return</span> google<span class="token punctuation">.</span>Length<span class="token punctuation">,</span> bing<span class="token punctuation">.</span>Length
  <span class="token punctuation">}</span>

<span class="token keyword">let</span> exampleDownloadManyPagesInParallel <span class="token operator">=</span>
  <span class="token keyword">let</span> download uri <span class="token operator">=</span>
    <span class="token computation-expression keyword">coroutine</span> <span class="token punctuation">{</span>
      <span class="token keyword">let!</span> text <span class="token operator">=</span> downloadFromUri uri
      <span class="token keyword">return</span> text<span class="token punctuation">.</span>Length
    <span class="token punctuation">}</span> <span class="token operator">|&gt;</span> debugf <span class="token string">"Download: %s"</span> <span class="token punctuation">(</span>string uri<span class="token punctuation">)</span>
  <span class="token computation-expression keyword">coroutine</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> uris        <span class="token operator">=</span> Array<span class="token punctuation">.</span>init <span class="token number">10</span> <span class="token punctuation">(</span><span class="token keyword">fun</span> i <span class="token operator">-&gt;</span> sprintf <span class="token string">"https://gist.github.com/mrange?page=%d"</span> <span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">let!</span> allLengths <span class="token operator">=</span> uris <span class="token operator">|&gt;</span> Array<span class="token punctuation">.</span>map download <span class="token operator">|&gt;</span> runAllInParallel <span class="token number">3</span>
    <span class="token keyword">return</span> allLengths
  <span class="token punctuation">}</span> <span class="token operator">|&gt;</span> time

<span class="token keyword">let</span> exampleCPUBoundProblem <span class="token operator">=</span>
  <span class="token keyword">let</span> d <span class="token operator">=</span> <span class="token number">2048</span>
  <span class="token keyword">let</span> r <span class="token operator">=</span> d <span class="token operator">&gt;&gt;&gt;</span> <span class="token number">3</span>
  <span class="token keyword">let</span> m <span class="token operator">=</span> <span class="token number">250</span>
  <span class="token keyword">let</span> s <span class="token operator">=</span> <span class="token number">2.0</span> <span class="token operator">/</span> float d

  <span class="token keyword">let</span> <span class="token keyword">rec</span> mandelbrot re im cre cim i <span class="token operator">=</span>
    <span class="token keyword">if</span> i <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token keyword">then</span>
      <span class="token keyword">let</span> re2   <span class="token operator">=</span> re<span class="token operator">*</span>re
      <span class="token keyword">let</span> im2   <span class="token operator">=</span> im<span class="token operator">*</span>im
      <span class="token keyword">let</span> reim  <span class="token operator">=</span> re<span class="token operator">*</span>im
      <span class="token keyword">if</span> re2 <span class="token operator">+</span> im2 <span class="token operator">&gt;</span> <span class="token number">4.0</span> <span class="token keyword">then</span>
        i
      <span class="token keyword">else</span>
        mandelbrot <span class="token punctuation">(</span>re2 <span class="token operator">-</span> im2 <span class="token operator">+</span> cre<span class="token punctuation">)</span> <span class="token punctuation">(</span>reim <span class="token operator">+</span> reim <span class="token operator">+</span> cim<span class="token punctuation">)</span> cre cim <span class="token punctuation">(</span>i <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token keyword">else</span>
      i

  <span class="token keyword">let</span> lines <span class="token punctuation">(</span>pixels <span class="token punctuation">:</span> <span class="token class-name">byte</span> array<span class="token punctuation">)</span> f t <span class="token operator">=</span>
    <span class="token keyword">for</span> y <span class="token operator">=</span> f <span class="token keyword">to</span> <span class="token punctuation">(</span>t <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">do</span>
      <span class="token keyword">let</span> yo  <span class="token operator">=</span> y<span class="token operator">*</span>r
      <span class="token keyword">let</span> cim <span class="token operator">=</span> float y<span class="token operator">*</span>s <span class="token operator">-</span> <span class="token number">1.0</span>
      <span class="token keyword">for</span> xo <span class="token operator">=</span> <span class="token number">0</span> <span class="token keyword">to</span> <span class="token punctuation">(</span>r <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span>  <span class="token keyword">do</span>
        <span class="token keyword">let</span> x0            <span class="token operator">=</span> xo <span class="token operator">&lt;&lt;&lt;</span> <span class="token number">3</span>
        <span class="token keyword">let</span> <span class="token keyword">mutable</span> pixel <span class="token operator">=</span> <span class="token number">0uy</span>
        <span class="token keyword">for</span> p <span class="token operator">=</span> <span class="token number">0</span> <span class="token keyword">to</span> <span class="token number">7</span> <span class="token keyword">do</span>
          <span class="token keyword">let</span> x <span class="token operator">=</span> x0 <span class="token operator">+</span> p
          <span class="token keyword">let</span> cre <span class="token operator">=</span> float x<span class="token operator">*</span>s <span class="token operator">-</span> <span class="token number">1.5</span>
          <span class="token keyword">let</span> i   <span class="token operator">=</span> mandelbrot cre cim cre cim m
          <span class="token keyword">if</span> i <span class="token operator">=</span> <span class="token number">0</span> <span class="token keyword">then</span>
            pixel   <span class="token operator">&lt;-</span>pixel <span class="token operator">|||</span> <span class="token punctuation">(</span><span class="token number">1uy</span> <span class="token operator">&lt;&lt;&lt;</span> <span class="token punctuation">(</span><span class="token number">7</span> <span class="token operator">-</span> p<span class="token punctuation">)</span><span class="token punctuation">)</span>
        pixels<span class="token punctuation">.</span><span class="token punctuation">[</span>yo <span class="token operator">+</span> xo<span class="token punctuation">]</span> <span class="token operator">&lt;-</span> pixel

  <span class="token keyword">let</span> colines <span class="token punctuation">(</span>pixels <span class="token punctuation">:</span> <span class="token class-name">byte</span> array<span class="token punctuation">)</span> f t <span class="token operator">=</span>
    <span class="token computation-expression keyword">coroutine</span> <span class="token punctuation">{</span>
      <span class="token keyword">do</span><span class="token operator">!</span> switchToThreadPool
      lines pixels f t
      <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token computation-expression keyword">coroutine</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> pixels <span class="token operator">=</span> Array<span class="token punctuation">.</span>zeroCreate <span class="token punctuation">(</span>r<span class="token operator">*</span>d<span class="token punctuation">)</span>

    <span class="token keyword">let</span>  s  <span class="token operator">=</span> d <span class="token operator">/</span> <span class="token number">4</span>
    <span class="token keyword">let!</span> s0 <span class="token operator">=</span> runInParallel <span class="token operator">&lt;|</span> colines pixels <span class="token punctuation">(</span><span class="token number">0</span><span class="token operator">*</span>s<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">*</span>s<span class="token punctuation">)</span>
    <span class="token keyword">let!</span> s1 <span class="token operator">=</span> runInParallel <span class="token operator">&lt;|</span> colines pixels <span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">*</span>s<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">2</span><span class="token operator">*</span>s<span class="token punctuation">)</span>
    <span class="token keyword">let!</span> s2 <span class="token operator">=</span> runInParallel <span class="token operator">&lt;|</span> colines pixels <span class="token punctuation">(</span><span class="token number">2</span><span class="token operator">*</span>s<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">3</span><span class="token operator">*</span>s<span class="token punctuation">)</span>
    <span class="token keyword">let!</span> s3 <span class="token operator">=</span> runInParallel <span class="token operator">&lt;|</span> colines pixels <span class="token punctuation">(</span><span class="token number">3</span><span class="token operator">*</span>s<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">4</span><span class="token operator">*</span>s<span class="token punctuation">)</span>

    <span class="token keyword">do</span><span class="token operator">!</span> s0
    <span class="token keyword">do</span><span class="token operator">!</span> s1
    <span class="token keyword">do</span><span class="token operator">!</span> s2
    <span class="token keyword">do</span><span class="token operator">!</span> s3

    <span class="token keyword">let</span> img     <span class="token operator">=</span> File<span class="token punctuation">.</span>Create <span class="token string">"mandelbrot.pbm"</span>
    <span class="token keyword">let</span> sw      <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StreamWriter</span> <span class="token punctuation">(</span>img<span class="token punctuation">)</span>

    <span class="token keyword">do</span><span class="token operator">!</span> sw<span class="token punctuation">.</span>WriteAsync  <span class="token punctuation">(</span>sprintf <span class="token string">"P4\n%d %d\n"</span> d d<span class="token punctuation">)</span>
    <span class="token keyword">do</span><span class="token operator">!</span> sw<span class="token punctuation">.</span>FlushAsync  <span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">do</span><span class="token operator">!</span> img<span class="token punctuation">.</span>WriteAsync <span class="token punctuation">(</span>pixels<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> pixels<span class="token punctuation">.</span>Length<span class="token punctuation">)</span>

    sw<span class="token punctuation">.</span>Dispose <span class="token punctuation">(</span><span class="token punctuation">)</span>
    img<span class="token punctuation">.</span>Dispose <span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token operator">|&gt;</span> time

<span class="token annotation"><span class="token punctuation">[&lt;</span><span class="token class-name">EntryPoint</span><span class="token punctuation">&gt;]</span></span>
<span class="token keyword">let</span> main argv <span class="token operator">=</span>
  Environment<span class="token punctuation">.</span>CurrentDirectory <span class="token operator">&lt;-</span> AppDomain<span class="token punctuation">.</span>CurrentDomain<span class="token punctuation">.</span>BaseDirectory

  invoke exampleDownloadFromGoogleAndBingInParallel <span class="token operator">&lt;|</span> printfn <span class="token string">"Result: %A"</span>

  printfn <span class="token string">"Press any key to exit"</span>
  Console<span class="token punctuation">.</span>ReadKey <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">|&gt;</span> ignore

  <span class="token number">0</span>
</code><button class="copy-code-button">Copy</button></pre></div><div class="mod-footer"></div></div></div></div></div></div><div class="sidebar-right sidebar"><div class="sidebar-handle"></div><div class="sidebar-topbar"><div class="topbar-content"></div><div class="clickable-icon sidebar-collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" class="svg-icon"><path d="M21 3H3C1.89543 3 1 3.89543 1 5V19C1 20.1046 1.89543 21 3 21H21C22.1046 21 23 20.1046 23 19V5C23 3.89543 22.1046 3 21 3Z"></path><path d="M10 4V20"></path><path d="M4 7H7"></path><path d="M4 10H7"></path><path d="M4 13H7"></path></svg></div></div><div class="sidebar-content"><div class="graph-view-wrapper"><div class="sidebar-section-header">Interactive Graph</div><div class="graph-view-placeholder">
		<div class="graph-view-container">
			<div class="graph-icon graph-expand" role="button" aria-label="Expand" data-tooltip-position="top"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon"><line x1="7" y1="17" x2="17" y2="7"></line><polyline points="7 7 17 7 17 17"></polyline></svg></div>
			<canvas id="graph-canvas" class="hide" width="512px" height="512px"></canvas>
		</div>
		</div></div><div class="tree-container mod-root nav-folder tree-item outline-tree" data-depth="0"><div class="tree-header"><span class="sidebar-section-header">Table Of Contents</span><button class="clickable-icon collapse-tree-button" aria-label="Collapse All"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></svg></button></div><div class="tree-scroll-area tree-item-children nav-folder-children"><div class="tree-item mod-tree-folder nav-folder mod-collapsible is-collapsed" style="display: none;"></div><div class="tree-item" data-depth="1"><a class="tree-link" href="computer-science/programming-language/fsharp/implementing-coroutines-(async-await)-using-continuations.html#Implementing Coroutines (async await) using continuations"><div class="tree-item-contents heading-link" heading-name="Implementing Coroutines (async await) using continuations"><span class="tree-item-title">Implementing Coroutines (async await) using continuations</span></div></a><div class="tree-item-children nav-folder-children"><div class="tree-item" data-depth="2"><a class="tree-link" href="computer-science/programming-language/fsharp/implementing-coroutines-(async-await)-using-continuations.html#The_problem_with_subroutines"><div class="tree-item-contents heading-link" heading-name="The problem with subroutines"><span class="tree-item-title">The problem with subroutines</span></div></a><div class="tree-item-children nav-folder-children"></div></div><div class="tree-item" data-depth="2"><a class="tree-link" href="computer-science/programming-language/fsharp/implementing-coroutines-(async-await)-using-continuations.html#Why_coroutines_can_help"><div class="tree-item-contents heading-link" heading-name="Why coroutines can help"><span class="tree-item-title">Why coroutines can help</span></div></a><div class="tree-item-children nav-folder-children"></div></div><div class="tree-item" data-depth="2"><a class="tree-link" href="computer-science/programming-language/fsharp/implementing-coroutines-(async-await)-using-continuations.html#Why_coroutines_sometimes_hurts"><div class="tree-item-contents heading-link" heading-name="Why coroutines sometimes hurts"><span class="tree-item-title">Why coroutines sometimes hurts</span></div></a><div class="tree-item-children nav-folder-children"></div></div><div class="tree-item mod-collapsible" data-depth="2"><a class="tree-link" href="computer-science/programming-language/fsharp/implementing-coroutines-(async-await)-using-continuations.html#Implementing_coroutines_using_continuations"><div class="tree-item-contents heading-link" heading-name="Implementing coroutines using continuations"><div class="collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div><span class="tree-item-title">Implementing coroutines using continuations</span></div></a><div class="tree-item-children nav-folder-children"><div class="tree-item" data-depth="3"><a class="tree-link" href="computer-science/programming-language/fsharp/implementing-coroutines-(async-await)-using-continuations.html#The_basics"><div class="tree-item-contents heading-link" heading-name="The basics"><span class="tree-item-title">The basics</span></div></a><div class="tree-item-children nav-folder-children"></div></div><div class="tree-item" data-depth="3"><a class="tree-link" href="computer-science/programming-language/fsharp/implementing-coroutines-(async-await)-using-continuations.html#The_Monad"><div class="tree-item-contents heading-link" heading-name="The Monad"><span class="tree-item-title">The Monad</span></div></a><div class="tree-item-children nav-folder-children"></div></div><div class="tree-item" data-depth="3"><a class="tree-link" href="computer-science/programming-language/fsharp/implementing-coroutines-(async-await)-using-continuations.html#Supporting_let!_syntax"><div class="tree-item-contents heading-link" heading-name="Supporting let! syntax"><span class="tree-item-title">Supporting let! syntax</span></div></a><div class="tree-item-children nav-folder-children"></div></div><div class="tree-item" data-depth="3"><a class="tree-link" href="computer-science/programming-language/fsharp/implementing-coroutines-(async-await)-using-continuations.html#Running_a_`Coroutine<_>`"><div class="tree-item-contents heading-link" heading-name="Running a `Coroutine<_>`"><span class="tree-item-title">Running a <code>Coroutine&lt;_&gt;</code></span></div></a><div class="tree-item-children nav-folder-children"></div></div><div class="tree-item" data-depth="3"><a class="tree-link" href="computer-science/programming-language/fsharp/implementing-coroutines-(async-await)-using-continuations.html#Downloading_google_homepage"><div class="tree-item-contents heading-link" heading-name="Downloading google homepage"><span class="tree-item-title">Downloading google homepage</span></div></a><div class="tree-item-children nav-folder-children"></div></div><div class="tree-item" data-depth="3"><a class="tree-link" href="computer-science/programming-language/fsharp/implementing-coroutines-(async-await)-using-continuations.html#Downloading_google_&amp;_bing_homepages"><div class="tree-item-contents heading-link" heading-name="Downloading google &amp; bing homepages"><span class="tree-item-title">Downloading google &amp; bing homepages</span></div></a><div class="tree-item-children nav-folder-children"></div></div><div class="tree-item" data-depth="3"><a class="tree-link" href="computer-science/programming-language/fsharp/implementing-coroutines-(async-await)-using-continuations.html#Downloading_google_&amp;_bing_homepage_in_parallel"><div class="tree-item-contents heading-link" heading-name="Downloading google &amp; bing homepage in parallel"><span class="tree-item-title">Downloading google &amp; bing homepage in parallel</span></div></a><div class="tree-item-children nav-folder-children"></div></div><div class="tree-item" data-depth="3"><a class="tree-link" href="computer-science/programming-language/fsharp/implementing-coroutines-(async-await)-using-continuations.html#Downloading_many_pages_in_parallel"><div class="tree-item-contents heading-link" heading-name="Downloading many pages in parallel"><span class="tree-item-title">Downloading many pages in parallel</span></div></a><div class="tree-item-children nav-folder-children"></div></div><div class="tree-item" data-depth="3"><a class="tree-link" href="computer-science/programming-language/fsharp/implementing-coroutines-(async-await)-using-continuations.html#What_about_CPU_bound_problems?"><div class="tree-item-contents heading-link" heading-name="What about CPU bound problems?"><span class="tree-item-title">What about CPU bound problems?</span></div></a><div class="tree-item-children nav-folder-children"></div></div></div></div></div></div><div class="tree-item" data-depth="1"><a class="tree-link" href="computer-science/programming-language/fsharp/implementing-coroutines-(async-await)-using-continuations.html#Conclusion"><div class="tree-item-contents heading-link" heading-name="Conclusion"><span class="tree-item-title">Conclusion</span></div></a><div class="tree-item-children nav-folder-children"></div></div><div class="tree-item" data-depth="1"><a class="tree-link" href="computer-science/programming-language/fsharp/implementing-coroutines-(async-await)-using-continuations.html#[F#]_Full_source_code"><div class="tree-item-contents heading-link" heading-name="[F#] Full source code"><span class="tree-item-title">[F#] Full source code</span></div></a><div class="tree-item-children nav-folder-children"></div></div></div></div></div><script defer="">let rs = document.querySelector(".sidebar-right"); rs.classList.add("is-collapsed"); if (window.innerWidth > 768) rs.classList.remove("is-collapsed"); rs.style.setProperty("--sidebar-width", localStorage.getItem("sidebar-right-width"));</script></div></div></body></html>