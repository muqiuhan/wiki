<html><head>
		<title>Messages and Agents</title>
		<base href="../../../">
		<meta id="root-path" root-path="../../../">
		<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes, minimum-scale=1.0, maximum-scale=5.0">
		<meta charset="UTF-8">
		<meta name="description" content="韩暮秋的个人维基 - Messages and Agents">
		<meta property="og:title" content="Messages and Agents">
		<meta property="og:description" content="韩暮秋的个人维基 - Messages and Agents">
		<meta property="og:type" content="website">
		<meta property="og:url" content="https://muqiuhan.github.io/wiki/computer-science/programming-language/fsharp/messages-and-agents.html">
		<meta property="og:image" content="undefined">
		<meta property="og:site_name" content="韩暮秋的个人维基">
		<meta name="author" content="韩暮秋"><script async="" id="webpage-script" src="lib/scripts/webpage.js" onload="this.onload=null;this.setAttribute(&quot;loaded&quot;, &quot;true&quot;)"></script><script type="module" async="" id="graph-view-script" src="lib/scripts/graph-view.js"></script><script async="" id="graph-wasm-script" src="lib/scripts/graph-wasm.js" onload="this.onload=null;this.setAttribute(&quot;loaded&quot;, &quot;true&quot;)"></script><script async="" id="graph-render-worker-script" src="lib/scripts/graph-render-worker.js" onload="this.onload=null;this.setAttribute(&quot;loaded&quot;, &quot;true&quot;)"></script><script async="" id="tinycolor-script" src="lib/scripts/tinycolor.js" onload="this.onload=null;this.setAttribute(&quot;loaded&quot;, &quot;true&quot;)"></script><script async="" id="pixi-script" src="lib/scripts/pixi.js" onload="this.onload=null;this.setAttribute(&quot;loaded&quot;, &quot;true&quot;)"></script><script async="" id="minisearch-script" src="lib/scripts/minisearch.js" onload="this.onload=null;this.setAttribute(&quot;loaded&quot;, &quot;true&quot;)"></script><link rel="icon" href="lib/media/favicon.jpg"><script async="" id="graph-data-script" src="lib/scripts/graph-data.js" onload="this.onload=null;this.setAttribute(&quot;loaded&quot;, &quot;true&quot;)"></script><style>body{--line-width:40em;--line-width-adaptive:40em;--file-line-width:40em;--sidebar-width:min(20em, 80vw);--collapse-arrow-size:11px;--tree-horizontal-spacing:0.6em;--tree-vertical-spacing:0.6em;--sidebar-margin:12px}.sidebar{height:100%;min-width:calc(var(--sidebar-width) + var(--divider-width-hover));max-width:calc(var(--sidebar-width) + var(--divider-width-hover));font-size:14px;z-index:10;position:relative;overflow:hidden;transition:min-width ease-in-out,max-width ease-in-out;transition-duration:.2s;contain:size}.sidebar-left{left:0}.sidebar-right{right:0}.sidebar.is-collapsed{min-width:0;max-width:0}body.floating-sidebars .sidebar{position:absolute}.sidebar-content{height:100%;min-width:calc(var(--sidebar-width) - var(--divider-width-hover));top:0;padding:var(--sidebar-margin);padding-top:4em;line-height:var(--line-height-tight);background-color:var(--background-secondary);transition:background-color,border-right,border-left,box-shadow;transition-duration:var(--color-fade-speed);transition-timing-function:ease-in-out;position:absolute;display:flex;flex-direction:column}.sidebar:not(.is-collapsed) .sidebar-content{min-width:calc(max(100%,var(--sidebar-width)) - 3px);max-width:calc(max(100%,var(--sidebar-width)) - 3px)}.sidebar-left .sidebar-content{left:0;border-top-right-radius:var(--radius-l);border-bottom-right-radius:var(--radius-l)}.sidebar-right .sidebar-content{right:0;border-top-left-radius:var(--radius-l);border-bottom-left-radius:var(--radius-l)}.sidebar:has(.sidebar-content:empty):has(.topbar-content:empty){display:none}.sidebar-topbar{height:2em;width:var(--sidebar-width);top:var(--sidebar-margin);padding-inline:var(--sidebar-margin);z-index:1;position:fixed;display:flex;align-items:center;transition:width ease-in-out;transition-duration:inherit}.sidebar.is-collapsed .sidebar-topbar{width:calc(2.3em + var(--sidebar-margin) * 2)}.sidebar .sidebar-topbar.is-collapsed{width:0}.sidebar-left .sidebar-topbar{left:0}.sidebar-right .sidebar-topbar{right:0}.topbar-content{overflow:hidden;overflow:clip;width:100%;height:100%;display:flex;align-items:center;transition:inherit}.sidebar.is-collapsed .topbar-content{width:0;transition:inherit}.clickable-icon.sidebar-collapse-icon{background-color:transparent;color:var(--icon-color-focused);padding:0!important;margin:0!important;height:100%!important;width:2.3em!important;margin-inline:0.14em!important;position:absolute}.sidebar-left .clickable-icon.sidebar-collapse-icon{transform:rotateY(180deg);right:var(--sidebar-margin)}.sidebar-right .clickable-icon.sidebar-collapse-icon{transform:rotateY(180deg);left:var(--sidebar-margin)}.clickable-icon.sidebar-collapse-icon svg.svg-icon{width:100%;height:100%}.sidebar-section-header{margin:0 0 1em 0;text-transform:uppercase;letter-spacing:.06em;font-weight:600}body{transition:background-color var(--color-fade-speed) ease-in-out}.webpage-container{display:flex;flex-direction:row;height:100%;width:100%;align-items:stretch;justify-content:center}.document-container{opacity:1;flex-basis:100%;max-width:100%;width:100%;height:100%;display:flex;flex-direction:column;align-items:center;transition:opacity .2s ease-in-out;contain:inline-size}.hide{opacity:0;transition:opacity .2s ease-in-out}.document-container>.markdown-preview-view{margin:var(--sidebar-margin);margin-bottom:0;width:100%;width:-webkit-fill-available;width:-moz-available;width:fill-available;background-color:var(--background-primary);transition:background-color var(--color-fade-speed) ease-in-out;border-top-right-radius:var(--window-radius,var(--radius-m));border-top-left-radius:var(--window-radius,var(--radius-m));overflow-x:hidden!important;overflow-y:auto!important;display:flex!important;flex-direction:column!important;align-items:center!important;contain:inline-size}.document-container>.markdown-preview-view>.markdown-preview-sizer{padding-bottom:80vh!important;width:100%!important;max-width:var(--line-width)!important;flex-basis:var(--line-width)!important;transition:background-color var(--color-fade-speed) ease-in-out;contain:inline-size}.markdown-rendered img:not([width]),.view-content img:not([width]){max-width:100%;outline:0}.document-container>.view-content.embed{display:flex;padding:1em;height:100%;width:100%;align-items:center;justify-content:center}.document-container>.view-content.embed>*{max-width:100%;max-height:100%;object-fit:contain}:has(> :is(.math,table)){overflow-x:auto!important}.document-container>.view-content{overflow-x:auto;contain:content;padding:0;margin:0;height:100%}.scroll-highlight{position:absolute;width:100%;height:100%;pointer-events:none;z-index:1000;background-color:hsla(var(--color-accent-hsl),.25);opacity:0;padding:1em;inset:50%;translate:-50% -50%;border-radius:var(--radius-s)}</style><script defer="">async function loadIncludes(){if("file:"!=location.protocol){let e=document.querySelectorAll("include");for(let t=0;t<e.length;t++){let o=e[t],l=o.getAttribute("src");try{const e=await fetch(l);if(!e.ok){console.log("Could not include file: "+l),o?.remove();continue}let t=await e.text(),n=document.createRange().createContextualFragment(t),i=Array.from(n.children);for(let e of i)e.classList.add("hide"),e.style.transition="opacity 0.5s ease-in-out",setTimeout((()=>{e.classList.remove("hide")}),10);o.before(n),o.remove(),console.log("Included file: "+l)}catch(e){o?.remove(),console.log("Could not include file: "+l,e);continue}}}else{if(document.querySelectorAll("include").length>0){var e=document.createElement("div");e.id="error",e.textContent="Web server exports must be hosted on an http / web server to be viewed correctly.",e.style.position="fixed",e.style.top="50%",e.style.left="50%",e.style.transform="translate(-50%, -50%)",e.style.fontSize="1.5em",e.style.fontWeight="bold",e.style.textAlign="center",document.body.appendChild(e),document.querySelector(".document-container")?.classList.remove("hide")}}}document.addEventListener("DOMContentLoaded",(()=>{loadIncludes()}));let isFileProtocol="file:"==location.protocol;function waitLoadScripts(e,t){let o=e.map((e=>document.getElementById(e+"-script"))),l=0;!function e(){let n=o[l];l++,n&&"true"!=n.getAttribute("loaded")||l<o.length&&e(),l<o.length?n.addEventListener("load",e):t()}()}</script><link rel="stylesheet" href="lib/styles/obsidian.css"><link rel="preload" href="lib/styles/other-plugins.css" as="style" onload="this.onload=null;this.rel='stylesheet'"><noscript><link rel="stylesheet" href="lib/styles/other-plugins.css"></noscript><link rel="stylesheet" href="lib/styles/theme.css"><link rel="preload" href="lib/styles/global-variable-styles.css" as="style" onload="this.onload=null;this.rel='stylesheet'"><noscript><link rel="stylesheet" href="lib/styles/global-variable-styles.css"></noscript><link rel="preload" href="lib/styles/supported-plugins.css" as="style" onload="this.onload=null;this.rel='stylesheet'"><noscript><link rel="stylesheet" href="lib/styles/supported-plugins.css"></noscript><link rel="preload" href="lib/styles/main-styles.css" as="style" onload="this.onload=null;this.rel='stylesheet'"><noscript><link rel="stylesheet" href="lib/styles/main-styles.css"></noscript></head><body class="publish css-settings-manager theme-light show-inline-title show-ribbon show-file-explorer-navigation"><script defer="">let theme=localStorage.getItem("theme")||(window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light");"dark"==theme?(document.body.classList.add("theme-dark"),document.body.classList.remove("theme-light")):(document.body.classList.add("theme-light"),document.body.classList.remove("theme-dark")),window.innerWidth<480?document.body.classList.add("is-phone"):window.innerWidth<768?document.body.classList.add("is-tablet"):window.innerWidth<1024?document.body.classList.add("is-small-screen"):document.body.classList.add("is-large-screen")</script><div class="webpage-container workspace"><div class="sidebar-left sidebar"><div class="sidebar-handle"></div><div class="sidebar-topbar"><div class="topbar-content"><label class="theme-toggle-container" for="theme_toggle"><input class="theme-toggle-input" type="checkbox" id="theme_toggle"><div class="toggle-background"></div></label></div><div class="clickable-icon sidebar-collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" class="svg-icon"><path d="M21 3H3C1.89543 3 1 3.89543 1 5V19C1 20.1046 1.89543 21 3 21H21C22.1046 21 23 20.1046 23 19V5C23 3.89543 22.1046 3 21 3Z"></path><path d="M10 4V20"></path><path d="M4 7H7"></path><path d="M4 10H7"></path><path d="M4 13H7"></path></svg></div></div><div class="sidebar-content"><div class="search-input-container"><input enterkeyhint="search" type="search" spellcheck="false" placeholder="Search..."><div class="search-input-clear-button" aria-label="Clear search"></div></div><include src="lib/html/file-tree.html"></include></div><script defer="">let ls = document.querySelector(".sidebar-left"); ls.classList.add("is-collapsed"); if (window.innerWidth > 768) ls.classList.remove("is-collapsed"); ls.style.setProperty("--sidebar-width", localStorage.getItem("sidebar-left-width"));</script></div><div class="document-container markdown-reading-view hide"><div class="markdown-preview-view markdown-rendered allow-fold-headings allow-fold-lists is-readable-line-width"><style id="MJX-CHTML-styles"></style><div class="markdown-preview-sizer markdown-preview-section"><h1 class="page-title heading inline-title" id="Messages and Agents"><p dir="auto">Messages and Agents</p></h1><div><p dir="auto"><a href="?query=tag:fsharp" class="tag" target="_blank" rel="noopener">#fsharp</a> <a href="?query=tag:fp" class="tag" target="_blank" rel="noopener">#fp</a></p></div><div><p dir="auto">In this post, we’ll look at the message-based (or actor-based) approach to concurrency.</p></div><div><p dir="auto">In this approach, when one task wants to communicate with another, it sends it a message, rather than contacting it directly. The messages are put on a queue, and the receiving task (known as an “actor” or “agent”) pulls the messages off the queue one at a time to process them.</p></div><div><p dir="auto">This message-based approach has been applied to many situations, from low-level network sockets (built on TCP/IP) to enterprise wide application integration systems (for example RabbitMQ or IBM WebSphere MQ).</p></div><div><p dir="auto">From a software design point of view, a message-based approach has a number of benefits:</p></div><div><ul>
<li data-line="0" dir="auto">You can manage shared data and resources without locks.</li>
<li data-line="1" dir="auto">You can easily follow the “single responsibility principle”, because each agent can be designed to do only one thing.</li>
<li data-line="2" dir="auto"><div class="list-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>It encourages a “pipeline” model of programming with “producers” sending messages to decoupled “consumers”, which has additional benefits:
<ul>
<li data-line="3" dir="auto">The queue acts as a buffer, eliminating waiting on the client side.</li>
<li data-line="4" dir="auto">It is straightforward to scale up one side or the other of the queue as needed in order to maximize throughput.</li>
<li data-line="5" dir="auto">Errors can be handled gracefully, because the decoupling means that agents can be created and destroyed without affecting their clients.</li>
</ul>
</li>
</ul></div><div><p dir="auto">From a practical developer’s point of view, what I find most appealing about the message-based approach is that when writing the code for any given actor, you don’t have to hurt your brain by thinking about concurrency. The message queue forces a “serialization” of operations that otherwise might occur concurrently. And this in turn makes it much easier to think about (and write code for) the logic for processing a message, because you can be sure that your code will be isolated from other events that might interrupt your flow.</p></div><div><p dir="auto">With these advantages, it is not surprising that when a team inside Ericsson wanted to design a programming language for writing highly-concurrent telephony applications, they created one with a message-based approach, namely Erlang. Erlang has now become the poster child for the whole topic, and has created a lot of interest in implementing the same approach in other languages.</p></div><div class="heading-wrapper"><h2 data-heading="How F# implements a message-based approach[](https://fsharpforfunandprofit.com/posts/concurrency-actor-model/#how-f-implements-a-message-based-approach)" dir="auto" class="heading" id="How_F#_implements_a_message-based_approach[](https://fsharpforfunandprofit.com/posts/concurrency-actor-model/#how-f-implements-a-message-based-approach)"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>How F# implements a message-based approach<a data-tooltip-position="top" aria-label="https://fsharpforfunandprofit.com/posts/concurrency-actor-model/#how-f-implements-a-message-based-approach" rel="noopener" class="external-link" href="https://fsharpforfunandprofit.com/posts/concurrency-actor-model/#how-f-implements-a-message-based-approach" target="_blank"></a></h2><div class="heading-children"><div><p dir="auto">F# has a built-in agent class called <code>MailboxProcessor</code>. These agents are very lightweight compared with threads - you can instantiate tens of thousands of them at the same time.</p></div><div><p dir="auto">These are similar to the agents in Erlang, but unlike the Erlang ones, they do <em>not</em> work across process boundaries, only in the same process. And unlike a heavyweight queueing system such as RabbitMQ, the messages are not persistent. If your app crashes, the messages are lost.</p></div><div><p dir="auto">But these are minor issues, and can be worked around. In a future series, I will go into alternative implementations of message queues. The fundamental approach is the same in all cases.</p></div><div><p dir="auto">Let’s see a simple agent implementation in F#:</p></div><div><pre class="language-fsharp" tabindex="0"><code class="language-fsharp is-loaded">
<span class="token keyword">let</span> printerAgent <span class="token operator">=</span> MailboxProcessor<span class="token punctuation">.</span><span class="token function">Start</span><span class="token punctuation">(</span><span class="token keyword">fun</span> inbox<span class="token operator">-&gt;</span>

    <span class="token comment">// the message processing function</span>
    <span class="token keyword">let</span> <span class="token keyword">rec</span> <span class="token function">messageLoop</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token computation-expression keyword">async</span><span class="token punctuation">{</span>

        <span class="token comment">// read a message</span>
        <span class="token keyword">let!</span> msg <span class="token operator">=</span> inbox<span class="token punctuation">.</span><span class="token function">Receive</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token comment">// process a message</span>
        printfn <span class="token string">"message is: %s"</span> msg

        <span class="token comment">// loop to top</span>
        <span class="token keyword">return!</span> <span class="token function">messageLoop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>

    <span class="token comment">// start the loop</span>
    <span class="token function">messageLoop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span>

</code><button class="copy-code-button">Copy</button></pre></div><div><p dir="auto">The <code>MailboxProcessor.Start</code> function takes a simple function parameter. That function loops forever, reading messages from the queue (or “inbox”) and processing them.</p></div><div><p dir="auto">Here’s the example in use:</p></div><div><pre class="language-fsharp" tabindex="0"><code class="language-fsharp is-loaded"><span class="token comment">// test it</span>
printerAgent<span class="token punctuation">.</span>Post <span class="token string">"hello"</span>
printerAgent<span class="token punctuation">.</span>Post <span class="token string">"hello again"</span>
printerAgent<span class="token punctuation">.</span>Post <span class="token string">"hello a third time"</span>
</code><button class="copy-code-button">Copy</button></pre></div><div><p dir="auto">In the rest of this post we’ll look at two slightly more useful examples:</p></div><div><ul>
<li data-line="0" dir="auto">Managing shared state without locks</li>
<li data-line="1" dir="auto">Serialized and buffered access to shared IO</li>
</ul></div><div><p dir="auto">In both of these cases, a message based approach to concurrency is elegant, efficient, and easy to program.</p></div></div></div><div class="heading-wrapper"><h2 data-heading="Managing shared state[](https://fsharpforfunandprofit.com/posts/concurrency-actor-model/#managing-shared-state)" dir="auto" class="heading" id="Managing_shared_state[](https://fsharpforfunandprofit.com/posts/concurrency-actor-model/#managing-shared-state)"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>Managing shared state<a data-tooltip-position="top" aria-label="https://fsharpforfunandprofit.com/posts/concurrency-actor-model/#managing-shared-state" rel="noopener" class="external-link" href="https://fsharpforfunandprofit.com/posts/concurrency-actor-model/#managing-shared-state" target="_blank"></a></h2><div class="heading-children"><div><p dir="auto">Let’s look at the shared state problem first.</p></div><div><p dir="auto">A common scenario is that you have some state that needs to be accessed and changed by multiple concurrent tasks or threads. We’ll use a very simple case, and say that the requirements are:</p></div><div><ul>
<li data-line="0" dir="auto">A shared “counter” and “sum” that can be incremented by multiple tasks concurrently.</li>
<li data-line="1" dir="auto">Changes to the counter and sum must be atomic – we must guarantee that they will both be updated at the same time.</li>
</ul></div><div class="heading-wrapper"><h3 data-heading="The locking approach to shared state[](https://fsharpforfunandprofit.com/posts/concurrency-actor-model/#the-locking-approach-to-shared-state)" dir="auto" class="heading" id="The_locking_approach_to_shared_state[](https://fsharpforfunandprofit.com/posts/concurrency-actor-model/#the-locking-approach-to-shared-state)"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>The locking approach to shared state<a data-tooltip-position="top" aria-label="https://fsharpforfunandprofit.com/posts/concurrency-actor-model/#the-locking-approach-to-shared-state" rel="noopener" class="external-link" href="https://fsharpforfunandprofit.com/posts/concurrency-actor-model/#the-locking-approach-to-shared-state" target="_blank"></a></h3><div class="heading-children"><div><p dir="auto">Using locks or mutexes is a common solution for these requirements, so let’s write some code using a lock, and see how it performs.</p></div><div><p dir="auto">First let’s write a static <code>LockedCounter</code> class that protects the state with locks.</p></div><div><pre class="language-fsharp" tabindex="0"><code class="language-fsharp is-loaded"><span class="token keyword">open</span> System
<span class="token keyword">open</span> System<span class="token punctuation">.</span>Threading
<span class="token keyword">open</span> System<span class="token punctuation">.</span>Diagnostics

<span class="token comment">// a utility function</span>
<span class="token keyword">type</span> <span class="token class-name">Utility</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span>
    <span class="token keyword">static</span> <span class="token keyword">let</span> rand <span class="token operator">=</span> <span class="token function">Random</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">static</span> <span class="token keyword">member</span> <span class="token function">RandomSleep</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span>
        <span class="token keyword">let</span> ms <span class="token operator">=</span> rand<span class="token punctuation">.</span><span class="token function">Next</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">)</span>
        Thread<span class="token punctuation">.</span>Sleep ms

<span class="token comment">// an implementation of a shared counter using locks</span>
<span class="token keyword">type</span> <span class="token class-name">LockedCounter</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span>

    <span class="token keyword">static</span> <span class="token keyword">let</span> _lock <span class="token operator">=</span> <span class="token function">Object</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">static</span> <span class="token keyword">let</span> <span class="token keyword">mutable</span> count <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token keyword">static</span> <span class="token keyword">let</span> <span class="token keyword">mutable</span> sum <span class="token operator">=</span> <span class="token number">0</span>

    <span class="token keyword">static</span> <span class="token keyword">let</span> updateState i <span class="token operator">=</span>
        <span class="token comment">// increment the counters and...</span>
        sum <span class="token operator">&lt;-</span> sum <span class="token operator">+</span> i
        count <span class="token operator">&lt;-</span> count <span class="token operator">+</span> <span class="token number">1</span>
        printfn <span class="token string">"Count is: %i. Sum is: %i"</span> count sum

        <span class="token comment">// ...emulate a short delay</span>
        Utility<span class="token punctuation">.</span><span class="token function">RandomSleep</span><span class="token punctuation">(</span><span class="token punctuation">)</span>


    <span class="token comment">// public interface to hide the state</span>
    <span class="token keyword">static</span> <span class="token keyword">member</span> Add i <span class="token operator">=</span>
        <span class="token comment">// see how long a client has to wait</span>
        <span class="token keyword">let</span> stopwatch <span class="token operator">=</span> <span class="token function">Stopwatch</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        stopwatch<span class="token punctuation">.</span><span class="token function">Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token comment">// start lock. Same as C# lock{...}</span>
        lock _lock <span class="token punctuation">(</span><span class="token keyword">fun</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span>

            <span class="token comment">// see how long the wait was</span>
            stopwatch<span class="token punctuation">.</span><span class="token function">Stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            printfn <span class="token string">"Client waited %i"</span> stopwatch<span class="token punctuation">.</span>ElapsedMilliseconds

            <span class="token comment">// do the core logic</span>
            updateState i
            <span class="token punctuation">)</span>
        <span class="token comment">// release lock</span>
</code><button class="copy-code-button">Copy</button></pre></div><div><p dir="auto">Some notes on this code:</p></div><div><ul>
<li data-line="0" dir="auto">This code is written using a very imperative approach, with mutable variables and locks</li>
<li data-line="1" dir="auto">The public <code>Add</code> method has explicit <code>Monitor.Enter</code> and <code>Monitor.Exit</code> expressions to get and release the lock. This is the same as the <code>lock{...}</code> statement in C#.</li>
<li data-line="2" dir="auto">We’ve also added a stopwatch to measure how long a client has to wait to get the lock.</li>
<li data-line="3" dir="auto">The core “business logic” is the <code>updateState</code> method, which not only updates the state, but adds a small random wait as well to emulate the time taken to do the processing.</li>
</ul></div><div><p dir="auto">Let’s test it in isolation:</p></div><div><pre class="language-fsharp" tabindex="0"><code class="language-fsharp is-loaded"><span class="token comment">// test in isolation</span>
LockedCounter<span class="token punctuation">.</span>Add <span class="token number">4</span>
LockedCounter<span class="token punctuation">.</span>Add <span class="token number">5</span>
</code><button class="copy-code-button">Copy</button></pre></div><div><p dir="auto">Next, we’ll create a task that will try to access the counter:</p></div><div><pre class="language-fsharp" tabindex="0"><code class="language-fsharp is-loaded"><span class="token keyword">let</span> makeCountingTask addFunction taskId  <span class="token operator">=</span> <span class="token computation-expression keyword">async</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> name <span class="token operator">=</span> sprintf <span class="token string">"Task%i"</span> taskId
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">.</span><span class="token number">.3</span><span class="token punctuation">]</span> <span class="token keyword">do</span>
        addFunction i
    <span class="token punctuation">}</span>

<span class="token comment">// test in isolation</span>
<span class="token keyword">let</span> task <span class="token operator">=</span> makeCountingTask LockedCounter<span class="token punctuation">.</span>Add <span class="token number">1</span>
Async<span class="token punctuation">.</span>RunSynchronously task
</code><button class="copy-code-button">Copy</button></pre></div><div><p dir="auto">In this case, when there is no contention at all, the wait times are all 0.</p></div><div><p dir="auto">But what happens when we create 10 child tasks that all try to access the counter at once:</p></div><div><pre class="language-fsharp" tabindex="0"><code class="language-fsharp is-loaded"><span class="token keyword">let</span> lockedExample5 <span class="token operator">=</span>
    <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">.</span><span class="token number">.10</span><span class="token punctuation">]</span>
        <span class="token operator">|&gt;</span> List<span class="token punctuation">.</span>map <span class="token punctuation">(</span><span class="token keyword">fun</span> i <span class="token operator">-&gt;</span> makeCountingTask LockedCounter<span class="token punctuation">.</span>Add i<span class="token punctuation">)</span>
        <span class="token operator">|&gt;</span> Async<span class="token punctuation">.</span>Parallel
        <span class="token operator">|&gt;</span> Async<span class="token punctuation">.</span>RunSynchronously
        <span class="token operator">|&gt;</span> ignore
</code><button class="copy-code-button">Copy</button></pre></div><div><p dir="auto">Oh dear! Most tasks are now waiting quite a while. If two tasks want to update the state at the same time, one must wait for the other’s work to complete before it can do its own work, which affects performance.</p></div><div><p dir="auto">And if we add more and more tasks, the contention will increase, and the tasks will spend more and more time waiting rather than working.</p></div></div></div><div class="heading-wrapper"><h3 data-heading="The message-based approach to shared state[](https://fsharpforfunandprofit.com/posts/concurrency-actor-model/#the-message-based-approach-to-shared-state)" dir="auto" class="heading" id="The_message-based_approach_to_shared_state[](https://fsharpforfunandprofit.com/posts/concurrency-actor-model/#the-message-based-approach-to-shared-state)"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>The message-based approach to shared state<a data-tooltip-position="top" aria-label="https://fsharpforfunandprofit.com/posts/concurrency-actor-model/#the-message-based-approach-to-shared-state" rel="noopener" class="external-link" href="https://fsharpforfunandprofit.com/posts/concurrency-actor-model/#the-message-based-approach-to-shared-state" target="_blank"></a></h3><div class="heading-children"><div><p dir="auto">Let’s see how a message queue might help us. Here’s the message based version:</p></div><div><pre class="language-fsharp" tabindex="0"><code class="language-fsharp is-loaded"><span class="token keyword">type</span> <span class="token class-name">MessageBasedCounter</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span>

    <span class="token keyword">static</span> <span class="token keyword">let</span> updateState <span class="token punctuation">(</span>count<span class="token punctuation">,</span>sum<span class="token punctuation">)</span> msg <span class="token operator">=</span>

        <span class="token comment">// increment the counters and...</span>
        <span class="token keyword">let</span> newSum <span class="token operator">=</span> sum <span class="token operator">+</span> msg
        <span class="token keyword">let</span> newCount <span class="token operator">=</span> count <span class="token operator">+</span> <span class="token number">1</span>
        printfn <span class="token string">"Count is: %i. Sum is: %i"</span> newCount newSum

        <span class="token comment">// ...emulate a short delay</span>
        Utility<span class="token punctuation">.</span><span class="token function">RandomSleep</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token comment">// return the new state</span>
        <span class="token punctuation">(</span>newCount<span class="token punctuation">,</span>newSum<span class="token punctuation">)</span>

    <span class="token comment">// create the agent</span>
    <span class="token keyword">static</span> <span class="token keyword">let</span> agent <span class="token operator">=</span> MailboxProcessor<span class="token punctuation">.</span><span class="token function">Start</span><span class="token punctuation">(</span><span class="token keyword">fun</span> inbox <span class="token operator">-&gt;</span>

        <span class="token comment">// the message processing function</span>
        <span class="token keyword">let</span> <span class="token keyword">rec</span> messageLoop oldState <span class="token operator">=</span> <span class="token computation-expression keyword">async</span><span class="token punctuation">{</span>

            <span class="token comment">// read a message</span>
            <span class="token keyword">let!</span> msg <span class="token operator">=</span> inbox<span class="token punctuation">.</span><span class="token function">Receive</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

            <span class="token comment">// do the core logic</span>
            <span class="token keyword">let</span> newState <span class="token operator">=</span> updateState oldState msg

            <span class="token comment">// loop to top</span>
            <span class="token keyword">return!</span> messageLoop newState
            <span class="token punctuation">}</span>

        <span class="token comment">// start the loop</span>
        messageLoop <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span>

    <span class="token comment">// public interface to hide the implementation</span>
    <span class="token keyword">static</span> <span class="token keyword">member</span> Add i <span class="token operator">=</span> agent<span class="token punctuation">.</span>Post i
</code><button class="copy-code-button">Copy</button></pre></div><div><p dir="auto">Some notes on this code:</p></div><div><ul>
<li data-line="0" dir="auto">The core “business logic” is again in the <code>updateState</code> method, which has almost the same implementation as the earlier example, except the state is immutable, so that a new state is created and returned to the main loop.</li>
<li data-line="1" dir="auto">The agent reads messages (simple ints in this case) and then calls <code>updateState</code> method</li>
<li data-line="2" dir="auto">The public method <code>Add</code> posts a message to the agent, rather than calling the <code>updateState</code> method directly</li>
<li data-line="3" dir="auto">This code is written in a more functional way; there are no mutable variables and no locks anywhere. In fact, there is no code dealing with concurrency at all! The code only has to focus on the business logic, and is consequently much easier to understand.</li>
</ul></div><div><p dir="auto">Let’s test it in isolation:</p></div><div><pre class="language-fsharp" tabindex="0"><code class="language-fsharp is-loaded"><span class="token comment">// test in isolation</span>
MessageBasedCounter<span class="token punctuation">.</span>Add <span class="token number">4</span>
MessageBasedCounter<span class="token punctuation">.</span>Add <span class="token number">5</span>
</code><button class="copy-code-button">Copy</button></pre></div><div><p dir="auto">Next, we’ll reuse a task we defined earlier, but calling <code>MessageBasedCounter.Add</code> instead:</p></div><div><pre class="language-fsharp" tabindex="0"><code class="language-fsharp is-loaded"><span class="token keyword">let</span> task <span class="token operator">=</span> makeCountingTask MessageBasedCounter<span class="token punctuation">.</span>Add <span class="token number">1</span>
Async<span class="token punctuation">.</span>RunSynchronously task
</code><button class="copy-code-button">Copy</button></pre></div><div><p dir="auto">Finally let’s create 5 child tasks that try to access the counter at once.</p></div><div><pre class="language-fsharp" tabindex="0"><code class="language-fsharp is-loaded"><span class="token keyword">let</span> messageExample5 <span class="token operator">=</span>
    <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">.</span><span class="token number">.5</span><span class="token punctuation">]</span>
        <span class="token operator">|&gt;</span> List<span class="token punctuation">.</span>map <span class="token punctuation">(</span><span class="token keyword">fun</span> i <span class="token operator">-&gt;</span> makeCountingTask MessageBasedCounter<span class="token punctuation">.</span>Add i<span class="token punctuation">)</span>
        <span class="token operator">|&gt;</span> Async<span class="token punctuation">.</span>Parallel
        <span class="token operator">|&gt;</span> Async<span class="token punctuation">.</span>RunSynchronously
        <span class="token operator">|&gt;</span> ignore
</code><button class="copy-code-button">Copy</button></pre></div><div><p dir="auto">We can’t measure the waiting time for the clients, because there is none!</p></div></div></div></div></div><div class="heading-wrapper"><h2 data-heading="Shared IO[](https://fsharpforfunandprofit.com/posts/concurrency-actor-model/#shared-io)" dir="auto" class="heading" id="Shared_IO[](https://fsharpforfunandprofit.com/posts/concurrency-actor-model/#shared-io)"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>Shared IO<a data-tooltip-position="top" aria-label="https://fsharpforfunandprofit.com/posts/concurrency-actor-model/#shared-io" rel="noopener" class="external-link" href="https://fsharpforfunandprofit.com/posts/concurrency-actor-model/#shared-io" target="_blank"></a></h2><div class="heading-children"><div><p dir="auto">A similar concurrency problem occurs when accessing a shared IO resource such as a file:</p></div><div><ul>
<li data-line="0" dir="auto">If the IO is slow, the clients can spend a lot of time waiting, even without locks.</li>
<li data-line="1" dir="auto">If multiple threads write to the resource at the same time, you can get corrupted data.</li>
</ul></div><div><p dir="auto">Both problems can be solved by using asynchronous calls combined with buffering – exactly what a message queue does.</p></div><div><p dir="auto">In this next example, we’ll consider the example of a logging service that many clients will write to concurrently. (In this trivial case, we’ll just write directly to the Console.)</p></div><div><p dir="auto">We’ll first look at an implementation without concurrency control, and then at an implementation that uses message queues to serialize all requests.</p></div><div class="heading-wrapper"><h3 data-heading="IO without serialization[](https://fsharpforfunandprofit.com/posts/concurrency-actor-model/#io-without-serialization)" dir="auto" class="heading" id="IO_without_serialization[](https://fsharpforfunandprofit.com/posts/concurrency-actor-model/#io-without-serialization)"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>IO without serialization<a data-tooltip-position="top" aria-label="https://fsharpforfunandprofit.com/posts/concurrency-actor-model/#io-without-serialization" rel="noopener" class="external-link" href="https://fsharpforfunandprofit.com/posts/concurrency-actor-model/#io-without-serialization" target="_blank"></a></h3><div class="heading-children"><div><p dir="auto">In order to make the corruption very obvious and repeatable, let’s first create a “slow” console that writes each individual character in the log message and pauses for a millisecond between each character. During that millisecond, another thread could be writing as well, causing an undesirable interleaving of messages.</p></div><div><pre class="language-fsharp" tabindex="0"><code class="language-fsharp is-loaded"><span class="token keyword">let</span> slowConsoleWrite msg <span class="token operator">=</span>
    msg <span class="token operator">|&gt;</span> String<span class="token punctuation">.</span>iter <span class="token punctuation">(</span><span class="token keyword">fun</span> ch<span class="token operator">-&gt;</span>
        System<span class="token punctuation">.</span>Threading<span class="token punctuation">.</span>Thread<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
        System<span class="token punctuation">.</span>Console<span class="token punctuation">.</span>Write ch
        <span class="token punctuation">)</span>

<span class="token comment">// test in isolation</span>
slowConsoleWrite <span class="token string">"abc"</span>
</code><button class="copy-code-button">Copy</button></pre></div><div><p dir="auto">Next, we will create a simple task that loops a few times, writing its name each time to the logger:</p></div><div><pre class="language-fsharp" tabindex="0"><code class="language-fsharp is-loaded"><span class="token keyword">let</span> makeTask logger taskId <span class="token operator">=</span> <span class="token computation-expression keyword">async</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> name <span class="token operator">=</span> sprintf <span class="token string">"Task%i"</span> taskId
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">.</span><span class="token number">.3</span><span class="token punctuation">]</span> <span class="token keyword">do</span>
        <span class="token keyword">let</span> msg <span class="token operator">=</span> sprintf <span class="token string">"-%s:Loop%i-"</span> name i
        logger msg
    <span class="token punctuation">}</span>

<span class="token comment">// test in isolation</span>
<span class="token keyword">let</span> task <span class="token operator">=</span> makeTask slowConsoleWrite <span class="token number">1</span>
Async<span class="token punctuation">.</span>RunSynchronously task
</code><button class="copy-code-button">Copy</button></pre></div><div><p dir="auto">Next, we write a logging class that encapsulates access to the slow console. It has no locking or serialization, and is basically not thread-safe:</p></div><div><pre class="language-fsharp" tabindex="0"><code class="language-fsharp is-loaded"><span class="token keyword">type</span> <span class="token class-name">UnserializedLogger</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span>
    <span class="token comment">// interface</span>
    <span class="token keyword">member</span> this<span class="token punctuation">.</span>Log msg <span class="token operator">=</span> slowConsoleWrite msg

<span class="token comment">// test in isolation</span>
<span class="token keyword">let</span> unserializedLogger <span class="token operator">=</span> <span class="token function">UnserializedLogger</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
unserializedLogger<span class="token punctuation">.</span>Log <span class="token string">"hello"</span>
</code><button class="copy-code-button">Copy</button></pre></div><div><p dir="auto">Now let’s combine all these into a real example. We will create five child tasks and run them in parallel, all trying to write to the slow console.</p></div><div><pre class="language-fsharp" tabindex="0"><code class="language-fsharp is-loaded"><span class="token keyword">let</span> unserializedExample <span class="token operator">=</span>
    <span class="token keyword">let</span> logger <span class="token operator">=</span> <span class="token function">UnserializedLogger</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">.</span><span class="token number">.5</span><span class="token punctuation">]</span>
        <span class="token operator">|&gt;</span> List<span class="token punctuation">.</span>map <span class="token punctuation">(</span><span class="token keyword">fun</span> i <span class="token operator">-&gt;</span> makeTask logger<span class="token punctuation">.</span>Log i<span class="token punctuation">)</span>
        <span class="token operator">|&gt;</span> Async<span class="token punctuation">.</span>Parallel
        <span class="token operator">|&gt;</span> Async<span class="token punctuation">.</span>RunSynchronously
        <span class="token operator">|&gt;</span> ignore
</code><button class="copy-code-button">Copy</button></pre></div><div><p dir="auto">Ouch! The output is very garbled!</p></div></div></div><div class="heading-wrapper"><h3 data-heading="Serialized IO with messages[](https://fsharpforfunandprofit.com/posts/concurrency-actor-model/#serialized-io-with-messages)" dir="auto" class="heading" id="Serialized_IO_with_messages[](https://fsharpforfunandprofit.com/posts/concurrency-actor-model/#serialized-io-with-messages)"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>Serialized IO with messages<a data-tooltip-position="top" aria-label="https://fsharpforfunandprofit.com/posts/concurrency-actor-model/#serialized-io-with-messages" rel="noopener" class="external-link" href="https://fsharpforfunandprofit.com/posts/concurrency-actor-model/#serialized-io-with-messages" target="_blank"></a></h3><div class="heading-children"><div><p dir="auto">So what happens when we replace <code>UnserializedLogger</code> with a <code>SerializedLogger</code> class that encapsulates a message queue.</p></div><div><p dir="auto">The agent inside <code>SerializedLogger</code> simply reads a message from its input queue and writes it to the slow console. Again there is no code dealing with concurrency and no locks are used.</p></div><div><pre class="language-fsharp" tabindex="0"><code class="language-fsharp is-loaded"><span class="token keyword">type</span> <span class="token class-name">SerializedLogger</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span>

    <span class="token comment">// create the mailbox processor</span>
    <span class="token keyword">let</span> agent <span class="token operator">=</span> MailboxProcessor<span class="token punctuation">.</span><span class="token function">Start</span><span class="token punctuation">(</span><span class="token keyword">fun</span> inbox <span class="token operator">-&gt;</span>

        <span class="token comment">// the message processing function</span>
        <span class="token keyword">let</span> <span class="token keyword">rec</span> messageLoop <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token computation-expression keyword">async</span><span class="token punctuation">{</span>

            <span class="token comment">// read a message</span>
            <span class="token keyword">let!</span> msg <span class="token operator">=</span> inbox<span class="token punctuation">.</span><span class="token function">Receive</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

            <span class="token comment">// write it to the log</span>
            slowConsoleWrite msg

            <span class="token comment">// loop to top</span>
            <span class="token keyword">return!</span> messageLoop <span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>

        <span class="token comment">// start the loop</span>
        messageLoop <span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span>

    <span class="token comment">// public interface</span>
    <span class="token keyword">member</span> this<span class="token punctuation">.</span>Log msg <span class="token operator">=</span> agent<span class="token punctuation">.</span>Post msg

<span class="token comment">// test in isolation</span>
<span class="token keyword">let</span> serializedLogger <span class="token operator">=</span> <span class="token function">SerializedLogger</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
serializedLogger<span class="token punctuation">.</span>Log <span class="token string">"hello"</span>
</code><button class="copy-code-button">Copy</button></pre></div><div><p dir="auto">So now we can repeat the earlier unserialized example but using the <code>SerializedLogger</code> instead. Again, we create five child tasks and run them in parallel:</p></div><div><pre class="language-fsharp" tabindex="0"><code class="language-fsharp is-loaded"><span class="token keyword">let</span> serializedExample <span class="token operator">=</span>
    <span class="token keyword">let</span> logger <span class="token operator">=</span> <span class="token function">SerializedLogger</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">.</span><span class="token number">.5</span><span class="token punctuation">]</span>
        <span class="token operator">|&gt;</span> List<span class="token punctuation">.</span>map <span class="token punctuation">(</span><span class="token keyword">fun</span> i <span class="token operator">-&gt;</span> makeTask logger<span class="token punctuation">.</span>Log i<span class="token punctuation">)</span>
        <span class="token operator">|&gt;</span> Async<span class="token punctuation">.</span>Parallel
        <span class="token operator">|&gt;</span> Async<span class="token punctuation">.</span>RunSynchronously
        <span class="token operator">|&gt;</span> ignore
</code><button class="copy-code-button">Copy</button></pre></div><div><p dir="auto">What a difference! This time the output is perfect.</p></div></div></div></div></div><div class="heading-wrapper"><h2 data-heading="Summary[](https://fsharpforfunandprofit.com/posts/concurrency-actor-model/#summary)" dir="auto" class="heading" id="Summary[](https://fsharpforfunandprofit.com/posts/concurrency-actor-model/#summary)"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>Summary<a data-tooltip-position="top" aria-label="https://fsharpforfunandprofit.com/posts/concurrency-actor-model/#summary" rel="noopener" class="external-link" href="https://fsharpforfunandprofit.com/posts/concurrency-actor-model/#summary" target="_blank"></a></h2><div class="heading-children"><div><p dir="auto">There is much more to say about this message based approach. In a future series, I hope to go into much more detail, including discussion of topics such as:</p></div><div><ul>
<li data-line="0" dir="auto">alternative implementations of message queues with RabbitMQ and TPL Dataflow.</li>
<li data-line="1" dir="auto">cancellation and out of band messages.</li>
<li data-line="2" dir="auto">error handling and retries, and handling exceptions in general.</li>
<li data-line="3" dir="auto">how to scale up and down by creating or removing child agents.</li>
<li data-line="4" dir="auto">avoiding buffer overruns and detecting starvation or inactivity.</li>
</ul></div><div class="mod-footer"></div></div></div></div></div></div><div class="sidebar-right sidebar"><div class="sidebar-handle"></div><div class="sidebar-topbar"><div class="topbar-content"></div><div class="clickable-icon sidebar-collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" class="svg-icon"><path d="M21 3H3C1.89543 3 1 3.89543 1 5V19C1 20.1046 1.89543 21 3 21H21C22.1046 21 23 20.1046 23 19V5C23 3.89543 22.1046 3 21 3Z"></path><path d="M10 4V20"></path><path d="M4 7H7"></path><path d="M4 10H7"></path><path d="M4 13H7"></path></svg></div></div><div class="sidebar-content"><div class="graph-view-wrapper"><div class="sidebar-section-header">Interactive Graph</div><div class="graph-view-placeholder">
		<div class="graph-view-container">
			<div class="graph-icon graph-expand" role="button" aria-label="Expand" data-tooltip-position="top"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon"><line x1="7" y1="17" x2="17" y2="7"></line><polyline points="7 7 17 7 17 17"></polyline></svg></div>
			<canvas id="graph-canvas" class="hide" width="512px" height="512px"></canvas>
		</div>
		</div></div><div class="tree-container mod-root nav-folder tree-item outline-tree" data-depth="0"><div class="tree-header"><span class="sidebar-section-header">Table Of Contents</span><button class="clickable-icon collapse-tree-button" aria-label="Collapse All"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></svg></button></div><div class="tree-scroll-area tree-item-children nav-folder-children"><div class="tree-item mod-tree-folder nav-folder mod-collapsible is-collapsed" style="display: none;"></div><div class="tree-item" data-depth="1"><a class="tree-link" href="computer-science/programming-language/fsharp/messages-and-agents.html#Messages and Agents"><div class="tree-item-contents heading-link" heading-name="Messages and Agents"><span class="tree-item-title">Messages and Agents</span></div></a><div class="tree-item-children nav-folder-children"><div class="tree-item" data-depth="2"><a class="tree-link" href="computer-science/programming-language/fsharp/messages-and-agents.html#How_F#_implements_a_message-based_approach[](https://fsharpforfunandprofit.com/posts/concurrency-actor-model/#how-f-implements-a-message-based-approach)"></a><div class="tree-item-contents heading-link" heading-name="How F# implements a message-based approach[](https://fsharpforfunandprofit.com/posts/concurrency-actor-model/#how-f-implements-a-message-based-approach)"><a class="tree-link" href="computer-science/programming-language/fsharp/messages-and-agents.html#How_F#_implements_a_message-based_approach[](https://fsharpforfunandprofit.com/posts/concurrency-actor-model/#how-f-implements-a-message-based-approach)"><span class="tree-item-title">How F# implements a message-based approach</span></a><a data-tooltip-position="top" aria-label="https://fsharpforfunandprofit.com/posts/concurrency-actor-model/#how-f-implements-a-message-based-approach" rel="noopener" class="external-link" href="https://fsharpforfunandprofit.com/posts/concurrency-actor-model/#how-f-implements-a-message-based-approach" target="_blank"></a></div><div class="tree-item-children nav-folder-children"></div></div><div class="tree-item mod-collapsible" data-depth="2"><a class="tree-link" href="computer-science/programming-language/fsharp/messages-and-agents.html#Managing_shared_state[](https://fsharpforfunandprofit.com/posts/concurrency-actor-model/#managing-shared-state)"></a><div class="tree-item-contents heading-link" heading-name="Managing shared state[](https://fsharpforfunandprofit.com/posts/concurrency-actor-model/#managing-shared-state)"><a class="tree-link" href="computer-science/programming-language/fsharp/messages-and-agents.html#Managing_shared_state[](https://fsharpforfunandprofit.com/posts/concurrency-actor-model/#managing-shared-state)"><div class="collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div><span class="tree-item-title">Managing shared state</span></a><a data-tooltip-position="top" aria-label="https://fsharpforfunandprofit.com/posts/concurrency-actor-model/#managing-shared-state" rel="noopener" class="external-link" href="https://fsharpforfunandprofit.com/posts/concurrency-actor-model/#managing-shared-state" target="_blank"></a></div><div class="tree-item-children nav-folder-children"><div class="tree-item" data-depth="3"><a class="tree-link" href="computer-science/programming-language/fsharp/messages-and-agents.html#The_locking_approach_to_shared_state[](https://fsharpforfunandprofit.com/posts/concurrency-actor-model/#the-locking-approach-to-shared-state)"></a><div class="tree-item-contents heading-link" heading-name="The locking approach to shared state[](https://fsharpforfunandprofit.com/posts/concurrency-actor-model/#the-locking-approach-to-shared-state)"><a class="tree-link" href="computer-science/programming-language/fsharp/messages-and-agents.html#The_locking_approach_to_shared_state[](https://fsharpforfunandprofit.com/posts/concurrency-actor-model/#the-locking-approach-to-shared-state)"><span class="tree-item-title">The locking approach to shared state</span></a><a data-tooltip-position="top" aria-label="https://fsharpforfunandprofit.com/posts/concurrency-actor-model/#the-locking-approach-to-shared-state" rel="noopener" class="external-link" href="https://fsharpforfunandprofit.com/posts/concurrency-actor-model/#the-locking-approach-to-shared-state" target="_blank"></a></div><div class="tree-item-children nav-folder-children"></div></div><div class="tree-item" data-depth="3"><a class="tree-link" href="computer-science/programming-language/fsharp/messages-and-agents.html#The_message-based_approach_to_shared_state[](https://fsharpforfunandprofit.com/posts/concurrency-actor-model/#the-message-based-approach-to-shared-state)"></a><div class="tree-item-contents heading-link" heading-name="The message-based approach to shared state[](https://fsharpforfunandprofit.com/posts/concurrency-actor-model/#the-message-based-approach-to-shared-state)"><a class="tree-link" href="computer-science/programming-language/fsharp/messages-and-agents.html#The_message-based_approach_to_shared_state[](https://fsharpforfunandprofit.com/posts/concurrency-actor-model/#the-message-based-approach-to-shared-state)"><span class="tree-item-title">The message-based approach to shared state</span></a><a data-tooltip-position="top" aria-label="https://fsharpforfunandprofit.com/posts/concurrency-actor-model/#the-message-based-approach-to-shared-state" rel="noopener" class="external-link" href="https://fsharpforfunandprofit.com/posts/concurrency-actor-model/#the-message-based-approach-to-shared-state" target="_blank"></a></div><div class="tree-item-children nav-folder-children"></div></div></div></div><div class="tree-item mod-collapsible" data-depth="2"><a class="tree-link" href="computer-science/programming-language/fsharp/messages-and-agents.html#Shared_IO[](https://fsharpforfunandprofit.com/posts/concurrency-actor-model/#shared-io)"></a><div class="tree-item-contents heading-link" heading-name="Shared IO[](https://fsharpforfunandprofit.com/posts/concurrency-actor-model/#shared-io)"><a class="tree-link" href="computer-science/programming-language/fsharp/messages-and-agents.html#Shared_IO[](https://fsharpforfunandprofit.com/posts/concurrency-actor-model/#shared-io)"><div class="collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div><span class="tree-item-title">Shared IO</span></a><a data-tooltip-position="top" aria-label="https://fsharpforfunandprofit.com/posts/concurrency-actor-model/#shared-io" rel="noopener" class="external-link" href="https://fsharpforfunandprofit.com/posts/concurrency-actor-model/#shared-io" target="_blank"></a></div><div class="tree-item-children nav-folder-children"><div class="tree-item" data-depth="3"><a class="tree-link" href="computer-science/programming-language/fsharp/messages-and-agents.html#IO_without_serialization[](https://fsharpforfunandprofit.com/posts/concurrency-actor-model/#io-without-serialization)"></a><div class="tree-item-contents heading-link" heading-name="IO without serialization[](https://fsharpforfunandprofit.com/posts/concurrency-actor-model/#io-without-serialization)"><a class="tree-link" href="computer-science/programming-language/fsharp/messages-and-agents.html#IO_without_serialization[](https://fsharpforfunandprofit.com/posts/concurrency-actor-model/#io-without-serialization)"><span class="tree-item-title">IO without serialization</span></a><a data-tooltip-position="top" aria-label="https://fsharpforfunandprofit.com/posts/concurrency-actor-model/#io-without-serialization" rel="noopener" class="external-link" href="https://fsharpforfunandprofit.com/posts/concurrency-actor-model/#io-without-serialization" target="_blank"></a></div><div class="tree-item-children nav-folder-children"></div></div><div class="tree-item" data-depth="3"><a class="tree-link" href="computer-science/programming-language/fsharp/messages-and-agents.html#Serialized_IO_with_messages[](https://fsharpforfunandprofit.com/posts/concurrency-actor-model/#serialized-io-with-messages)"></a><div class="tree-item-contents heading-link" heading-name="Serialized IO with messages[](https://fsharpforfunandprofit.com/posts/concurrency-actor-model/#serialized-io-with-messages)"><a class="tree-link" href="computer-science/programming-language/fsharp/messages-and-agents.html#Serialized_IO_with_messages[](https://fsharpforfunandprofit.com/posts/concurrency-actor-model/#serialized-io-with-messages)"><span class="tree-item-title">Serialized IO with messages</span></a><a data-tooltip-position="top" aria-label="https://fsharpforfunandprofit.com/posts/concurrency-actor-model/#serialized-io-with-messages" rel="noopener" class="external-link" href="https://fsharpforfunandprofit.com/posts/concurrency-actor-model/#serialized-io-with-messages" target="_blank"></a></div><div class="tree-item-children nav-folder-children"></div></div></div></div><div class="tree-item" data-depth="2"><a class="tree-link" href="computer-science/programming-language/fsharp/messages-and-agents.html#Summary[](https://fsharpforfunandprofit.com/posts/concurrency-actor-model/#summary)"></a><div class="tree-item-contents heading-link" heading-name="Summary[](https://fsharpforfunandprofit.com/posts/concurrency-actor-model/#summary)"><a class="tree-link" href="computer-science/programming-language/fsharp/messages-and-agents.html#Summary[](https://fsharpforfunandprofit.com/posts/concurrency-actor-model/#summary)"><span class="tree-item-title">Summary</span></a><a data-tooltip-position="top" aria-label="https://fsharpforfunandprofit.com/posts/concurrency-actor-model/#summary" rel="noopener" class="external-link" href="https://fsharpforfunandprofit.com/posts/concurrency-actor-model/#summary" target="_blank"></a></div><div class="tree-item-children nav-folder-children"></div></div></div></div></div></div></div><script defer="">let rs = document.querySelector(".sidebar-right"); rs.classList.add("is-collapsed"); if (window.innerWidth > 768) rs.classList.remove("is-collapsed"); rs.style.setProperty("--sidebar-width", localStorage.getItem("sidebar-right-width"));</script></div></div></body></html>