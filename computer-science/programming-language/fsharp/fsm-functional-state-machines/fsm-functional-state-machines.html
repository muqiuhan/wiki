<!DOCTYPE html> <html><head>
		<title>FSM - Functional State Machines</title>
		<base href="../../../../">
		<meta id="root-path" root-path="../../../../">
		<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes, minimum-scale=1.0, maximum-scale=5.0">
		<meta charset="UTF-8">
		<meta name="description" content="韩暮秋的个人维基 - FSM - Functional State Machines">
		<meta property="og:title" content="FSM - Functional State Machines">
		<meta property="og:description" content="韩暮秋的个人维基 - FSM - Functional State Machines">
		<meta property="og:type" content="website">
		<meta property="og:url" content="https://muqiuhan.github.io/wiki/computer-science/programming-language/fsharp/fsm-functional-state-machines/fsm-functional-state-machines.html">
		<meta property="og:image" content="https://muqiuhan.github.io/wiki/computer-science/programming-language/fsharp/fsm-functional-state-machines/attachments/pasted-image-20240912175130.png">
		<meta property="og:site_name" content="韩暮秋的个人维基">
		<meta name="author" content="韩暮秋"><link rel="alternate" type="application/rss+xml" title="RSS Feed" href="https://muqiuhan.github.io/wiki/lib/rss.xml"><script async="" id="webpage-script" src="lib/scripts/webpage.js" onload="this.onload=null;this.setAttribute(&quot;loaded&quot;, &quot;true&quot;)"></script><script type="module" async="" id="graph-view-script" src="lib/scripts/graph-view.js"></script><script async="" id="graph-wasm-script" src="lib/scripts/graph-wasm.js" onload="this.onload=null;this.setAttribute(&quot;loaded&quot;, &quot;true&quot;)"></script><script async="" id="graph-render-worker-script" src="lib/scripts/graph-render-worker.js" onload="this.onload=null;this.setAttribute(&quot;loaded&quot;, &quot;true&quot;)"></script><script async="" id="tinycolor-script" src="lib/scripts/tinycolor.js" onload="this.onload=null;this.setAttribute(&quot;loaded&quot;, &quot;true&quot;)"></script><script async="" id="pixi-script" src="lib/scripts/pixi.js" onload="this.onload=null;this.setAttribute(&quot;loaded&quot;, &quot;true&quot;)"></script><script async="" id="minisearch-script" src="lib/scripts/minisearch.js" onload="this.onload=null;this.setAttribute(&quot;loaded&quot;, &quot;true&quot;)"></script><link rel="icon" href="lib/media/favicon.png"><script async="" id="graph-data-script" src="lib/scripts/graph-data.js" onload="this.onload=null;this.setAttribute(&quot;loaded&quot;, &quot;true&quot;)"></script><style>body{--line-width:40em;--line-width-adaptive:40em;--file-line-width:40em;--sidebar-width:min(20em, 80vw);--collapse-arrow-size:11px;--tree-horizontal-spacing:0.6em;--tree-vertical-spacing:0.6em;--sidebar-margin:12px}.sidebar{height:100%;min-width:calc(var(--sidebar-width) + var(--divider-width-hover));max-width:calc(var(--sidebar-width) + var(--divider-width-hover));font-size:14px;z-index:10;position:relative;overflow:hidden;transition:min-width ease-in-out,max-width ease-in-out;transition-duration:.2s;contain:size}.sidebar-left{left:0}.sidebar-right{right:0}.sidebar.is-collapsed{min-width:0;max-width:0}body.floating-sidebars .sidebar{position:absolute}.sidebar-content{height:100%;min-width:calc(var(--sidebar-width) - var(--divider-width-hover));top:0;padding:var(--sidebar-margin);padding-top:4em;line-height:var(--line-height-tight);background-color:var(--background-secondary);transition:background-color,border-right,border-left,box-shadow;transition-duration:var(--color-fade-speed);transition-timing-function:ease-in-out;position:absolute;display:flex;flex-direction:column}.sidebar:not(.is-collapsed) .sidebar-content{min-width:calc(max(100%,var(--sidebar-width)) - 3px);max-width:calc(max(100%,var(--sidebar-width)) - 3px)}.sidebar-left .sidebar-content{left:0;border-top-right-radius:var(--radius-l);border-bottom-right-radius:var(--radius-l)}.sidebar-right .sidebar-content{right:0;border-top-left-radius:var(--radius-l);border-bottom-left-radius:var(--radius-l)}.sidebar:has(.sidebar-content:empty):has(.topbar-content:empty){display:none}.sidebar-topbar{height:2em;width:var(--sidebar-width);top:var(--sidebar-margin);padding-inline:var(--sidebar-margin);z-index:1;position:fixed;display:flex;align-items:center;transition:width ease-in-out;transition-duration:inherit}.sidebar.is-collapsed .sidebar-topbar{width:calc(2.3em + var(--sidebar-margin) * 2)}.sidebar .sidebar-topbar.is-collapsed{width:0}.sidebar-left .sidebar-topbar{left:0}.sidebar-right .sidebar-topbar{right:0}.topbar-content{overflow:hidden;overflow:clip;width:100%;height:100%;display:flex;align-items:center;transition:inherit}.sidebar.is-collapsed .topbar-content{width:0;transition:inherit}.clickable-icon.sidebar-collapse-icon{background-color:transparent;color:var(--icon-color-focused);padding:0!important;margin:0!important;height:100%!important;width:2.3em!important;margin-inline:0.14em!important;position:absolute}.sidebar-left .clickable-icon.sidebar-collapse-icon{transform:rotateY(180deg);right:var(--sidebar-margin)}.sidebar-right .clickable-icon.sidebar-collapse-icon{transform:rotateY(180deg);left:var(--sidebar-margin)}.clickable-icon.sidebar-collapse-icon svg.svg-icon{width:100%;height:100%}.sidebar-section-header{margin:0 0 1em 0;text-transform:uppercase;letter-spacing:.06em;font-weight:600}body{transition:background-color var(--color-fade-speed) ease-in-out}.webpage-container{display:flex;flex-direction:row;height:100%;width:100%;align-items:stretch;justify-content:center}.document-container{opacity:1;flex-basis:100%;max-width:100%;width:100%;height:100%;display:flex;flex-direction:column;align-items:center;transition:opacity .2s ease-in-out;contain:inline-size}.hide{opacity:0;transition:opacity .2s ease-in-out}.document-container>.markdown-preview-view{margin:var(--sidebar-margin);margin-bottom:0;width:100%;width:-webkit-fill-available;width:-moz-available;width:fill-available;background-color:var(--background-primary);transition:background-color var(--color-fade-speed) ease-in-out;border-top-right-radius:var(--window-radius,var(--radius-m));border-top-left-radius:var(--window-radius,var(--radius-m));overflow-x:hidden!important;overflow-y:auto!important;display:flex!important;flex-direction:column!important;align-items:center!important;contain:inline-size}.document-container>.markdown-preview-view>.markdown-preview-sizer{padding-bottom:80vh!important;width:100%!important;max-width:var(--line-width)!important;flex-basis:var(--line-width)!important;transition:background-color var(--color-fade-speed) ease-in-out;contain:inline-size}.markdown-rendered img:not([width]),.view-content img:not([width]){max-width:100%;outline:0}.document-container>.view-content.embed{display:flex;padding:1em;height:100%;width:100%;align-items:center;justify-content:center}.document-container>.view-content.embed>*{max-width:100%;max-height:100%;object-fit:contain}:has(> :is(.math,table)){overflow-x:auto!important}.document-container>.view-content{overflow-x:auto;contain:content;padding:0;margin:0;height:100%}.scroll-highlight{position:absolute;width:100%;height:100%;pointer-events:none;z-index:1000;background-color:hsla(var(--color-accent-hsl),.25);opacity:0;padding:1em;inset:50%;translate:-50% -50%;border-radius:var(--radius-s)}</style><script defer="">async function loadIncludes(){if("file:"!=location.protocol){let e=document.querySelectorAll("include");for(let t=0;t<e.length;t++){let o=e[t],l=o.getAttribute("src");try{const e=await fetch(l);if(!e.ok){console.log("Could not include file: "+l),o?.remove();continue}let t=await e.text(),n=document.createRange().createContextualFragment(t),i=Array.from(n.children);for(let e of i)e.classList.add("hide"),e.style.transition="opacity 0.5s ease-in-out",setTimeout((()=>{e.classList.remove("hide")}),10);o.before(n),o.remove(),console.log("Included file: "+l)}catch(e){o?.remove(),console.log("Could not include file: "+l,e);continue}}}else{if(document.querySelectorAll("include").length>0){var e=document.createElement("div");e.id="error",e.textContent="Web server exports must be hosted on an http / web server to be viewed correctly.",e.style.position="fixed",e.style.top="50%",e.style.left="50%",e.style.transform="translate(-50%, -50%)",e.style.fontSize="1.5em",e.style.fontWeight="bold",e.style.textAlign="center",document.body.appendChild(e),document.querySelector(".document-container")?.classList.remove("hide")}}}document.addEventListener("DOMContentLoaded",(()=>{loadIncludes()}));let isFileProtocol="file:"==location.protocol;function waitLoadScripts(e,t){let o=e.map((e=>document.getElementById(e+"-script"))),l=0;!function e(){let n=o[l];l++,n&&"true"!=n.getAttribute("loaded")||l<o.length&&e(),l<o.length?n.addEventListener("load",e):t()}()}</script><link rel="stylesheet" href="lib/styles/obsidian.css"><link rel="preload" href="lib/styles/other-plugins.css" as="style" onload="this.onload=null;this.rel='stylesheet'"><noscript><link rel="stylesheet" href="lib/styles/other-plugins.css"></noscript><link rel="stylesheet" href="lib/styles/theme.css"><link rel="preload" href="lib/styles/global-variable-styles.css" as="style" onload="this.onload=null;this.rel='stylesheet'"><noscript><link rel="stylesheet" href="lib/styles/global-variable-styles.css"></noscript><link rel="preload" href="lib/styles/supported-plugins.css" as="style" onload="this.onload=null;this.rel='stylesheet'"><noscript><link rel="stylesheet" href="lib/styles/supported-plugins.css"></noscript><link rel="preload" href="lib/styles/main-styles.css" as="style" onload="this.onload=null;this.rel='stylesheet'"><noscript><link rel="stylesheet" href="lib/styles/main-styles.css"></noscript></head><body class="publish css-settings-manager theme-light show-inline-title show-ribbon outliner-plugin-dnd custom-accent ribbon-default special-h6 float-center"><script defer="">let theme=localStorage.getItem("theme")||(window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light");"dark"==theme?(document.body.classList.add("theme-dark"),document.body.classList.remove("theme-light")):(document.body.classList.add("theme-light"),document.body.classList.remove("theme-dark")),window.innerWidth<480?document.body.classList.add("is-phone"):window.innerWidth<768?document.body.classList.add("is-tablet"):window.innerWidth<1024?document.body.classList.add("is-small-screen"):document.body.classList.add("is-large-screen")</script><div class="webpage-container workspace"><div class="sidebar-left sidebar"><div class="sidebar-handle"></div><div class="sidebar-topbar"><div class="topbar-content"><label class="theme-toggle-container" for="theme_toggle"><input class="theme-toggle-input" type="checkbox" id="theme_toggle"><div class="toggle-background"></div></label></div><div class="clickable-icon sidebar-collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" class="svg-icon"><path d="M21 3H3C1.89543 3 1 3.89543 1 5V19C1 20.1046 1.89543 21 3 21H21C22.1046 21 23 20.1046 23 19V5C23 3.89543 22.1046 3 21 3Z"></path><path d="M10 4V20"></path><path d="M4 7H7"></path><path d="M4 10H7"></path><path d="M4 13H7"></path></svg></div></div><div class="sidebar-content"><div class="search-input-container"><input enterkeyhint="search" type="search" spellcheck="false" placeholder="Search..."><div class="search-input-clear-button" aria-label="Clear search"></div></div><include src="lib/html/file-tree.html"></include></div><script defer="">let ls = document.querySelector(".sidebar-left"); ls.classList.add("is-collapsed"); if (window.innerWidth > 768) ls.classList.remove("is-collapsed"); ls.style.setProperty("--sidebar-width", localStorage.getItem("sidebar-left-width"));</script></div><div class="document-container markdown-reading-view hide"><div class="markdown-preview-view markdown-rendered allow-fold-headings allow-fold-lists is-readable-line-width"><style id="MJX-CHTML-styles">mjx-munder{display:inline-block;text-align:left}mjx-over{text-align:left}mjx-munder:not([limits=false]){display:inline-table}mjx-munder>mjx-row{text-align:left}mjx-under{padding-bottom:.1em}mjx-msub{display:inline-block;text-align:left}mjx-c.mjx-c1D436.TEX-I::before{padding:.705em .76em .022em 0;content:"C"}mjx-c.mjx-c3D::before{padding:.583em .778em .082em 0;content:"="}mjx-c.mjx-c2211.TEX-S2::before{padding:.95em 1.444em .45em 0;content:"∑"}mjx-c.mjx-c1D45D.TEX-I::before{padding:.442em .503em .194em 0;content:"p"}mjx-c.mjx-c1D461.TEX-I::before{padding:.626em .361em .011em 0;content:"t"}mjx-mtext{display:inline-block;text-align:left}mjx-container[jax=CHTML]{line-height:0}mjx-container [space="1"]{margin-left:.111em}mjx-container [space="2"]{margin-left:.167em}mjx-container [space="3"]{margin-left:.222em}mjx-container [space="4"]{margin-left:.278em}mjx-container [space="5"]{margin-left:.333em}mjx-container [rspace="1"]{margin-right:.111em}mjx-container [rspace="2"]{margin-right:.167em}mjx-container [rspace="3"]{margin-right:.222em}mjx-container [rspace="4"]{margin-right:.278em}mjx-container [rspace="5"]{margin-right:.333em}mjx-container [size="s"]{font-size:70.7%}mjx-container [size=ss]{font-size:50%}mjx-container [size=Tn]{font-size:60%}mjx-container [size=sm]{font-size:85%}mjx-container [size=lg]{font-size:120%}mjx-container [size=Lg]{font-size:144%}mjx-container [size=LG]{font-size:173%}mjx-container [size=hg]{font-size:207%}mjx-container [size=HG]{font-size:249%}mjx-container [width=full]{width:100%}mjx-box{display:inline-block}mjx-block{display:block}mjx-itable{display:inline-table}mjx-row{display:table-row}mjx-row>*{display:table-cell}mjx-mtext{display:inline-block}mjx-mstyle{display:inline-block}mjx-merror{display:inline-block;color:red;background-color:#ff0}mjx-mphantom{visibility:hidden}mjx-assistive-mml{top:0;left:0;clip:rect(1px,1px,1px,1px);user-select:none;position:absolute!important;padding:1px 0 0!important;border:0!important;display:block!important;width:auto!important;overflow:hidden!important}mjx-assistive-mml[display=block]{width:100%!important}mjx-math{display:inline-block;text-align:left;line-height:0;text-indent:0;font-style:normal;font-weight:400;font-size:100%;font-size-adjust:none;letter-spacing:normal;border-collapse:collapse;overflow-wrap:normal;word-spacing:normal;white-space:nowrap;direction:ltr;padding:1px 0}mjx-container[jax=CHTML][display=true]{display:block;text-align:center;margin:1em 0}mjx-container[jax=CHTML][display=true][width=full]{display:flex}mjx-container[jax=CHTML][display=true] mjx-math{padding:0}mjx-container[jax=CHTML][justify=left]{text-align:left}mjx-container[jax=CHTML][justify=right]{text-align:right}mjx-msup{display:inline-block;text-align:left}mjx-mi{display:inline-block;text-align:left}mjx-c{display:inline-block}mjx-utext{display:inline-block;padding:.75em 0 .2em}mjx-texatom{display:inline-block;text-align:left}mjx-mo{display:inline-block;text-align:left}mjx-stretchy-h{display:inline-table;width:100%}mjx-stretchy-h>*{display:table-cell;width:0}mjx-stretchy-h>*>mjx-c{display:inline-block;transform:scaleX(1)}mjx-stretchy-h>*>mjx-c::before{display:inline-block;width:initial}mjx-stretchy-h>mjx-ext{overflow:clip visible;width:100%}mjx-stretchy-h>mjx-ext>mjx-c::before{transform:scaleX(500)}mjx-stretchy-h>mjx-ext>mjx-c{width:0}mjx-stretchy-h>mjx-beg>mjx-c{margin-right:-.1em}mjx-stretchy-h>mjx-end>mjx-c{margin-left:-.1em}mjx-stretchy-v{display:inline-block}mjx-stretchy-v>*{display:block}mjx-stretchy-v>mjx-beg{height:0}mjx-stretchy-v>mjx-end>mjx-c{display:block}mjx-stretchy-v>*>mjx-c{transform:scaleY(1);transform-origin:left center;overflow:hidden}mjx-stretchy-v>mjx-ext{display:block;height:100%;box-sizing:border-box;border:0 solid transparent;overflow:visible clip}mjx-stretchy-v>mjx-ext>mjx-c::before{width:initial;box-sizing:border-box}mjx-stretchy-v>mjx-ext>mjx-c{transform:scaleY(500) translateY(.075em);overflow:visible}mjx-mark{display:inline-block;height:0}mjx-c::before{display:block;width:0}.MJX-TEX{font-family:MJXZERO,MJXTEX}.TEX-B{font-family:MJXZERO,MJXTEX-B}.TEX-I{font-family:MJXZERO,MJXTEX-I}.TEX-MI{font-family:MJXZERO,MJXTEX-MI}.TEX-BI{font-family:MJXZERO,MJXTEX-BI}.TEX-S1{font-family:MJXZERO,MJXTEX-S1}.TEX-S2{font-family:MJXZERO,MJXTEX-S2}.TEX-S3{font-family:MJXZERO,MJXTEX-S3}.TEX-S4{font-family:MJXZERO,MJXTEX-S4}.TEX-A{font-family:MJXZERO,MJXTEX-A}.TEX-C{font-family:MJXZERO,MJXTEX-C}.TEX-CB{font-family:MJXZERO,MJXTEX-CB}.TEX-FR{font-family:MJXZERO,MJXTEX-FR}.TEX-FRB{font-family:MJXZERO,MJXTEX-FRB}.TEX-SS{font-family:MJXZERO,MJXTEX-SS}.TEX-SSB{font-family:MJXZERO,MJXTEX-SSB}.TEX-SSI{font-family:MJXZERO,MJXTEX-SSI}.TEX-SC{font-family:MJXZERO,MJXTEX-SC}.TEX-T{font-family:MJXZERO,MJXTEX-T}.TEX-V{font-family:MJXZERO,MJXTEX-V}.TEX-VB{font-family:MJXZERO,MJXTEX-VB}mjx-stretchy-h mjx-c,mjx-stretchy-v mjx-c{font-family:MJXZERO,MJXTEX-S1,MJXTEX-S4,MJXTEX,MJXTEX-A!important}@font-face{font-family:MJXZERO;src:url("lib/fonts/mathjax_zero.woff") format("woff")}@font-face{font-family:MJXTEX;src:url("lib/fonts/mathjax_main-regular.woff") format("woff")}@font-face{font-family:MJXTEX-B;src:url("lib/fonts/mathjax_main-bold.woff") format("woff")}@font-face{font-family:MJXTEX-I;src:url("lib/fonts/mathjax_math-italic.woff") format("woff")}@font-face{font-family:MJXTEX-MI;src:url("lib/fonts/mathjax_main-italic.woff") format("woff")}@font-face{font-family:MJXTEX-BI;src:url("lib/fonts/mathjax_math-bolditalic.woff") format("woff")}@font-face{font-family:MJXTEX-S1;src:url("lib/fonts/mathjax_size1-regular.woff") format("woff")}@font-face{font-family:MJXTEX-S2;src:url("lib/fonts/mathjax_size2-regular.woff") format("woff")}@font-face{font-family:MJXTEX-S3;src:url("lib/fonts/mathjax_size3-regular.woff") format("woff")}@font-face{font-family:MJXTEX-S4;src:url("lib/fonts/mathjax_size4-regular.woff") format("woff")}@font-face{font-family:MJXTEX-A;src:url("lib/fonts/mathjax_ams-regular.woff") format("woff")}@font-face{font-family:MJXTEX-C;src:url("lib/fonts/mathjax_calligraphic-regular.woff") format("woff")}@font-face{font-family:MJXTEX-CB;src:url("lib/fonts/mathjax_calligraphic-bold.woff") format("woff")}@font-face{font-family:MJXTEX-FR;src:url("lib/fonts/mathjax_fraktur-regular.woff") format("woff")}@font-face{font-family:MJXTEX-FRB;src:url("lib/fonts/mathjax_fraktur-bold.woff") format("woff")}@font-face{font-family:MJXTEX-SS;src:url("lib/fonts/mathjax_sansserif-regular.woff") format("woff")}@font-face{font-family:MJXTEX-SSB;src:url("lib/fonts/mathjax_sansserif-bold.woff") format("woff")}@font-face{font-family:MJXTEX-SSI;src:url("lib/fonts/mathjax_sansserif-italic.woff") format("woff")}@font-face{font-family:MJXTEX-SC;src:url("lib/fonts/mathjax_script-regular.woff") format("woff")}@font-face{font-family:MJXTEX-T;src:url("lib/fonts/mathjax_typewriter-regular.woff") format("woff")}@font-face{font-family:MJXTEX-V;src:url("lib/fonts/mathjax_vector-regular.woff") format("woff")}@font-face{font-family:MJXTEX-VB;src:url("lib/fonts/mathjax_vector-bold.woff") format("woff")}mjx-c.mjx-c1D447.TEX-I::before{padding:.677em .704em 0 0;content:"T"}mjx-c.mjx-c1D450.TEX-I::before{padding:.442em .433em .011em 0;content:"c"}mjx-c.mjx-c2C::before{padding:.121em .278em .194em 0;content:","}mjx-c.mjx-c2E::before{padding:.12em .278em 0 0;content:"."}</style><div class="markdown-preview-sizer markdown-preview-section"><h1 class="page-title heading inline-title" id="FSM - Functional State Machines"><p dir="auto">FSM - Functional State Machines</p></h1><div class="el-p"><p dir="auto"><a href="?query=tag:fp" class="tag" target="_blank" rel="noopener nofollow">#fp</a></p></div><div class="el-h3 heading-wrapper"><h3 data-heading="Functional, State Machine-like approach" dir="auto" class="heading" id="Functional,_State_Machine-like_approach"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>Functional, State Machine-like approach</h3><div class="heading-children"><div class="el-p"><p dir="auto">Let's refer to a type descriptions of a finite state machine (FSM) that we saw in <a data-tooltip-position="top" aria-label="https://talesfrom.dev/blog/many-faces-of-ddd-aggregates-in-fsharp#solution-3-functional-state-machine-like-approach" rel="noopener nofollow" class="external-link" href="https://talesfrom.dev/blog/many-faces-of-ddd-aggregates-in-fsharp#solution-3-functional-state-machine-like-approach" target="_blank">Functional, State Machine-like approach</a>:</p></div><div class="el-pre"><pre class="language-fsharp" tabindex="0"><code data-line="0" class="language-fsharp is-loaded"><span class="token keyword">module</span> StateMachines <span class="token operator">=</span>
    <span class="token keyword">type</span> <span class="token class-name">FSM</span><span class="token operator">&lt;</span>'Input<span class="token punctuation">,</span> 'Output<span class="token operator">&gt;</span> <span class="token operator">=</span> FSM <span class="token keyword">of</span> 'Output
    <span class="token comment">//          \______ used  mostly for documentation - what input is possible</span>
    <span class="token keyword">type</span> <span class="token class-name">Evolve</span><span class="token operator">&lt;</span>'Input<span class="token punctuation">,</span> 'Output<span class="token punctuation">,</span> 'FSM<span class="token operator">&gt;</span> <span class="token operator">=</span> 'Input <span class="token operator">-&gt;</span> 'FSM <span class="token operator">-&gt;</span> 'Output <span class="token operator">*</span> 'FSM
    <span class="token keyword">type</span> <span class="token class-name">Aggregate</span><span class="token operator">&lt;</span>'Command<span class="token punctuation">,</span> 'Event<span class="token punctuation">,</span> 'State<span class="token operator">&gt;</span> <span class="token operator">=</span> FSM<span class="token operator">&lt;</span>'Command<span class="token punctuation">,</span> 'Event list <span class="token operator">*</span> 'State<span class="token operator">&gt;</span>
    <span class="token comment">//                           'Input   ____________/                \________ 'Output with implicit state</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">It captures the story behind our intentions - <code>Evolve&lt;'Input, 'Output, 'FSM&gt;</code> function expresses what we can do with a finite state machine (<code>FSM&lt;'Input, 'Output&gt;</code>).</p></div><div class="el-p"><p dir="auto">Imagine that we have a magical device that no one ever dreamed of - Func-o-meter.</p></div><div class="el-p"><p dir="auto">Func-o-meter can measure and tell us how functional the given piece of code is.</p></div><div class="el-p"><p dir="auto"><span alt="Pasted image 20240912175130.png" src="Pasted image 20240912175130.png" class="internal-embed media-embed image-embed is-loaded"><img alt="Pasted image 20240912175130.png" src="computer-science/programming-language/fsharp/fsm-functional-state-machines/attachments/pasted-image-20240912175130.png"></span></p></div><div class="el-blockquote"><blockquote dir="auto">
<p>A device for measuring functional levels of a given piece of code</p>
</blockquote></div><div class="el-p"><p dir="auto">Regarding the symbols on the screen:</p></div><div class="el-ul"><ul>
<li data-line="0" dir="auto">L means Low</li>
<li data-line="1" dir="auto">M means Medium</li>
<li data-line="2" dir="auto">H means High</li>
</ul></div><div class="el-p"><p dir="auto">Sounds magical?</p></div><div class="el-p"><p dir="auto">Good, because it is pure (pun intended) magic.</p></div><div class="el-p"><p dir="auto">We just need to point at the code with those two strangely looking antennas and we can get the measurement result back.</p></div><div class="el-p"><p dir="auto">The result you just saw, dear Reader, was me trying to use our Func-o-meter on <a data-tooltip-position="top" aria-label="https://talesfrom.dev/blog/many-faces-of-ddd-aggregates-in-fsharp#solution-1-object-oriented-approach" rel="noopener nofollow" class="external-link" href="https://talesfrom.dev/blog/many-faces-of-ddd-aggregates-in-fsharp#solution-1-object-oriented-approach" target="_blank">Object-Oriented approach</a> from previous tale.</p></div><div class="el-p"><p dir="auto">Well, it's not that functional, isn't it?</p></div><div class="el-p"><p dir="auto">Let's try to use Func-o-meter on our little snippet, presented just before.</p></div><div class="el-p"><p dir="auto"><span alt="Pasted image 20240912175307.png" src="Pasted image 20240912175307.png" class="internal-embed media-embed image-embed is-loaded"><img alt="Pasted image 20240912175307.png" src="computer-science/programming-language/fsharp/fsm-functional-state-machines/attachments/pasted-image-20240912175307.png"></span></p></div><div class="el-blockquote"><blockquote dir="auto">
<p>Showing how much our FSM-like implementation is functional</p>
</blockquote></div><div class="el-p"><p dir="auto">And here we are - it's pretty functional in comparison to OO one.</p></div><div class="el-p"><p dir="auto">We are on the good path, aren't we?</p></div><div class="el-p"><p dir="auto">Actually, it's really neat function (pun intended) of Func-o-meter - you are able to compare results of two consecutive measurements.</p></div><div class="el-p"><p dir="auto">But wait, do you have any problem?</p></div></div></div><div class="el-h3 heading-wrapper"><h3 data-heading="[](https://talesfrom.dev/blog/fsm-functional-state-machines#problem)Problem?" dir="auto" class="heading" id="[](https://talesfrom.dev/blog/fsm-functional-state-machines#problem)Problem?"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div><a data-tooltip-position="top" aria-label="https://talesfrom.dev/blog/fsm-functional-state-machines#problem" rel="noopener nofollow" class="external-link" href="https://talesfrom.dev/blog/fsm-functional-state-machines#problem" target="_blank"></a>Problem?</h3><div class="heading-children"><div class="el-p"><p dir="auto">Building something just to build something is really interesting idea, but no.</p></div><div class="el-p"><p dir="auto">We need to have a goal.</p></div><div class="el-p"><p dir="auto">A problem to solve.</p></div><div class="el-p"><p dir="auto">This time our "problem" is pretty straightforward - we are going to try to model door mechanism.</p></div><div class="el-p"><p dir="auto">That mechanism can be either opened, or closed or locked.</p></div><div class="el-p"><p dir="auto">As you probably can predict, dear Reader, only some actions are able to be applied to a door mechanism in a certain state.</p></div><div class="el-p"><p dir="auto">We could conclude the rules in the following list:</p></div><div class="el-ul"><ul>
<li data-line="0" dir="auto">door mechanism starts as <code>Closed</code></li>
<li data-line="1" dir="auto">only when it's <code>Closed</code>, when trying to <code>Open</code> it, it becomes <code>Opened</code></li>
<li data-line="2" dir="auto">only when it's <code>Opened</code>, when trying to <code>Close</code> it, it becomes <code>Closed</code></li>
<li data-line="3" dir="auto">only when it's <code>Closed</code>, when trying to <code>Lock</code> it, it becomes <code>Locked</code></li>
<li data-line="4" dir="auto">only when it's <code>Locked</code>, when trying to <code>Unlock</code> it, it becomes <code>Closed</code></li>
</ul></div><div class="el-p"><p dir="auto">If one could visualize it, it might look as follows:</p></div><div class="el-p"><p dir="auto"><span alt="Pasted image 20240912175321.png" src="Pasted image 20240912175321.png" class="internal-embed media-embed image-embed is-loaded"><img alt="Pasted image 20240912175321.png" src="computer-science/programming-language/fsharp/fsm-functional-state-machines/attachments/pasted-image-20240912175321.png"></span></p></div><div class="el-blockquote"><blockquote dir="auto">
<p>A specification of how a door mechanism could work</p>
</blockquote></div><div class="el-p"><p dir="auto">Is it too naive example?</p></div><div class="el-p"><p dir="auto">We need to have a simple problem to focus more on the modeling aspect.</p></div><div class="el-p"><p dir="auto">Ok, fasten your seat belts, and let's start!</p></div></div></div><div class="el-h3 heading-wrapper"><h3 data-heading="Solution #1: Mealy State Machines" dir="auto" class="heading" id="Solution_#1:_Mealy_State_Machines"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>Solution #1: Mealy State Machines</h3><div class="heading-children"><div class="el-p"><p dir="auto">Our first attempt, for gaining more functional points, will be by using <a data-tooltip-position="top" aria-label="https://en.wikipedia.org/wiki/Mealy_machine" rel="noopener nofollow" class="external-link" href="https://en.wikipedia.org/wiki/Mealy_machine" target="_blank">Mealy machines</a>.</p></div><div class="el-p"><p dir="auto">As you probably know me a bit, dear Reader, I like to focus on language when modeling and solving problems.</p></div><div class="el-p"><p dir="auto">Let's then use mathematical language and a bit of the theory to define a Mealy machine:</p></div><div class="el-p"><p dir="auto">(S,S0​,Σ,Λ,T,G)</p></div><div class="el-p"><p dir="auto">As we are diving into functional stuff, things <strong>must</strong> be mathematical in its purest form (as our functions, right?) - and also difficult.</p></div><div class="el-p"><p dir="auto">Of course, I am joking.</p></div><div class="el-p"><p dir="auto">We won't go into a theory that much.</p></div><div class="el-p"><p dir="auto">Let's be pragmatic and focus on our goal - solving a real problem!</p></div><div class="el-p"><p dir="auto">We could think of a Mealy finite state machine as such that its outputs are determined both by their current state and their current input.</p></div><div class="el-p"><p dir="auto">A little computer that has some internal state and based on a given input, it change its internal state to one of finite states set.</p></div><div class="el-p"><p dir="auto">We could represent it as follows:</p></div><div class="el-pre"><pre class="language-fsharp" tabindex="0"><code data-line="0" class="language-fsharp is-loaded"><span class="token keyword">type</span> <span class="token class-name">Mealy</span><span class="token operator">&lt;</span>'Input<span class="token punctuation">,</span> 'Output<span class="token operator">&gt;</span> <span class="token operator">=</span> 'Input <span class="token operator">-&gt;</span> 'Output <span class="token operator">*</span> Mealy<span class="token operator">&lt;</span>'Input<span class="token punctuation">,</span> 'Output<span class="token operator">&gt;</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">So it basically gets input and does some magic to move to next state, based on some logic, and as an output it returns current state and itself.</p></div><div class="el-p"><p dir="auto">But it's not really the same "self".</p></div><div class="el-p"><p dir="auto">Our little machine got transformed by utilizing input and internal state - and we got "new existing" machine.</p></div><div class="el-p"><p dir="auto">Immutability in its greatness.</p></div><div class="el-p"><p dir="auto">No mutability, just transformation.</p></div><div class="el-p"><p dir="auto">Turns out that it's a pretty well-known "problem" of representing Mealy state machines.</p></div><div class="el-p"><p dir="auto">In one of my discussions with <a data-tooltip-position="top" aria-label="https://twitter.com/Savlambda" rel="noopener nofollow" class="external-link" href="https://twitter.com/Savlambda" target="_blank">borar</a>, he referred to <a data-tooltip-position="top" aria-label="https://github.com/purescript-contrib/purescript-machines" rel="noopener nofollow" class="external-link" href="https://github.com/purescript-contrib/purescript-machines" target="_blank">purescript-machines</a>.</p></div><div class="el-p"><p dir="auto">It is a PureScript implementation of Mealy machines with halting.</p></div><div class="el-p"><p dir="auto">Really briefly - halting means that that our machine can "stop" when reaching a termination state (it's on us when we define so).</p></div><div class="el-p"><p dir="auto">I must admit it was a great resource to understand how to implement it correctly in F#.</p></div><div class="el-p"><p dir="auto">With <a data-tooltip-position="top" aria-label="https://twitter.com/Savlambda" rel="noopener nofollow" class="external-link" href="https://twitter.com/Savlambda" target="_blank">borar</a>'s help, it was even easier.</p></div><div class="el-p"><p dir="auto">So let's introduce "stopping a machine" concept and Mealy finite state machine properly:</p></div><div class="el-pre"><pre class="language-fsharp" tabindex="0"><code data-line="0" class="language-fsharp is-loaded"><span class="token keyword">type</span> <span class="token class-name">Step</span><span class="token operator">&lt;</span>'Output<span class="token punctuation">,</span> 'Continue<span class="token operator">&gt;</span> <span class="token operator">=</span>
<span class="token operator">|</span> Stop
<span class="token operator">|</span> ContinueWith <span class="token keyword">of</span> <span class="token punctuation">(</span>'Output <span class="token operator">*</span> 'Continue<span class="token punctuation">)</span>

<span class="token keyword">type</span> <span class="token class-name">Mealy</span><span class="token operator">&lt;</span>'Input<span class="token punctuation">,</span> 'Output<span class="token operator">&gt;</span> <span class="token operator">=</span> 
    Mealy <span class="token keyword">of</span> <span class="token punctuation">(</span>'Input <span class="token operator">-&gt;</span> Step<span class="token operator">&lt;</span>'Output<span class="token punctuation">,</span> Mealy<span class="token operator">&lt;</span>'Input<span class="token punctuation">,</span>'Output<span class="token operator">&gt;&gt;</span><span class="token punctuation">)</span>
<span class="token comment">//       THIS IS OUR CONTINUATION! ______/</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">In order to utilize "stopping a machine", we need to introduce a concept of <code>Step</code>.</p></div><div class="el-p"><p dir="auto">It represents intention of how state machine should behave.</p></div><div class="el-p"><p dir="auto">The most interesting part is <code>ContinueWith</code> because it yields information about the output and a continuation.</p></div><div class="el-p"><p dir="auto">Typically a continuation is a function that contains description of what needs to be done next.</p></div><div class="el-p"><p dir="auto">And now we have our precious machinery - <code>Mealy</code>.</p></div><div class="el-p"><p dir="auto">It keeps a function from an input to a step.</p></div><div class="el-p"><p dir="auto">An avid Reader might notice that <code>Step</code>, as a second type parameter, uses a continuation.</p></div><div class="el-p"><p dir="auto">In our example its another <code>Mealy</code> type...Which holds a function.</p></div><div class="el-p"><p dir="auto">Isn't it weird? Shocking?</p></div><div class="el-p"><p dir="auto">So our Mealy is keeping a function that produces a pair of output (from a state machine) and a Mealy, that keeps a function that produces a pair of...</p></div><div class="el-p"><p dir="auto">...I hope you see where it goes.</p></div><div class="el-p"><p dir="auto">We are going to create a recursive function there.</p></div><div class="el-p"><p dir="auto">Isn' it too dangerous to build such recursive construct in that particular way?</p></div><div class="el-p"><p dir="auto">Well, in case we couldn't stop it, it might be a bit interesting to see how stack is exploding.</p></div><div class="el-p"><p dir="auto">But thanks to <code>Stop</code> case of a <code>Step</code> type, any time our state machine yields <code>Stop</code> - no more steps are possible.</p></div><div class="el-p"><p dir="auto">But where were we - we have the problem to solve!</p></div></div></div><div class="el-h3 heading-wrapper"><h3 data-heading="Modeling a domain: door mechanism" dir="auto" class="heading" id="Modeling_a_domain:_door_mechanism"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>Modeling a domain: door mechanism</h3><div class="heading-children"><div class="el-p"><p dir="auto">Let's move to the most intersting part - modeling.</p></div><div class="el-p"><p dir="auto">Nothing gives so much adrenaline like modeling, isn't it?</p></div><div class="el-p"><p dir="auto">Let's start with possible actions and states that are possible in our little area of activity.</p></div><div class="el-p"><p dir="auto">Just so you know, from now on I am going to use "commands", instead of actions.</p></div><div class="el-pre"><pre class="language-fsharp" tabindex="0"><code data-line="0" class="language-fsharp is-loaded"><span class="token keyword">type</span> <span class="token class-name">DoorMechanismState</span> <span class="token operator">=</span> Closed <span class="token operator">|</span> Opened <span class="token operator">|</span> Locked

<span class="token keyword">type</span> <span class="token class-name">DoorMechanismCommand</span> <span class="token operator">=</span> Open <span class="token operator">|</span> Close <span class="token operator">|</span> Lock <span class="token operator">|</span> Unlock

<span class="token keyword">type</span> <span class="token class-name">DoorMechanism</span> <span class="token operator">=</span> Mealy<span class="token operator">&lt;</span>DoorMechanismCommand<span class="token punctuation">,</span> DoorMechanismState<span class="token operator">&gt;</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">Simple, clean, understandable - F#.</p></div><div class="el-p"><p dir="auto">We have our basic building concepts that work inside our domain.</p></div><div class="el-p"><p dir="auto">Here is our recursive function we talked about:</p></div><div class="el-pre"><pre class="language-fsharp" tabindex="0"><code data-line="0" class="language-fsharp is-loaded"><span class="token keyword">let</span> <span class="token keyword">rec</span> <span class="token keyword">private</span> continueAs <span class="token punctuation">(</span>doorMechanism<span class="token punctuation">:</span> <span class="token class-name">DoorMechanismState</span><span class="token punctuation">)</span><span class="token punctuation">:</span> DoorMechanism <span class="token operator">=</span>
    <span class="token function">Mealy</span><span class="token punctuation">(</span><span class="token keyword">fun</span> doorMachineCommand <span class="token operator">-&gt;</span>
        <span class="token keyword">match</span> doorMechanism<span class="token punctuation">,</span> doorMachineCommand <span class="token keyword">with</span>
        <span class="token operator">|</span> Closed<span class="token punctuation">,</span> Open <span class="token operator">-&gt;</span> <span class="token function">ContinueWith</span><span class="token punctuation">(</span>Opened<span class="token punctuation">,</span> continueAs Opened<span class="token punctuation">)</span>
        <span class="token operator">|</span> Opened<span class="token punctuation">,</span> Close <span class="token operator">-&gt;</span> <span class="token function">ContinueWith</span><span class="token punctuation">(</span>Closed<span class="token punctuation">,</span> continueAs Closed<span class="token punctuation">)</span>
        <span class="token operator">|</span> Closed<span class="token punctuation">,</span> Lock <span class="token operator">-&gt;</span> <span class="token function">ContinueWith</span><span class="token punctuation">(</span>Locked<span class="token punctuation">,</span> continueAs Locked<span class="token punctuation">)</span>
        <span class="token operator">|</span> Locked<span class="token punctuation">,</span> Unlock <span class="token operator">-&gt;</span> <span class="token function">ContinueWith</span><span class="token punctuation">(</span>Closed<span class="token punctuation">,</span> continueAs Closed<span class="token punctuation">)</span>
        <span class="token operator">|</span> _<span class="token punctuation">,</span> _ <span class="token operator">-&gt;</span> <span class="token function">ContinueWith</span><span class="token punctuation">(</span>doorMechanism<span class="token punctuation">,</span> continueAs doorMechanism<span class="token punctuation">)</span>
<span class="token comment">//  this is external "output" ____/              \___ here recursion happens!</span>
    <span class="token punctuation">)</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">The most interesting part here is that this function (<code>continueAs</code>) creates a function, that accepts a <code>doorMachineCommand</code> as input (which actually is input for our state machine), and gets "packaged" into a <code>Mealy</code> type.</p></div><div class="el-p"><p dir="auto">Inside, we are modeling all rules and transitions.</p></div><div class="el-p"><p dir="auto">As you can see, dear Reader, our little door mechanism is not yielding <code>Stop</code>.</p></div><div class="el-p"><p dir="auto">In this tiny tale, our state machine will "never terminate".</p></div><div class="el-p"><p dir="auto">Right now, we can't yet use our state machine.</p></div><div class="el-p"><p dir="auto">Let's fix it by defining a <code>Send</code> function</p></div><div class="el-pre"><pre class="language-fsharp" tabindex="0"><code data-line="0" class="language-fsharp is-loaded"><span class="token keyword">type</span> <span class="token class-name">Send</span><span class="token operator">&lt;</span>'Command<span class="token punctuation">,</span> 'State<span class="token operator">&gt;</span> <span class="token operator">=</span>
    'Command <span class="token operator">-&gt;</span> Mealy<span class="token operator">&lt;</span>'Command<span class="token punctuation">,</span> 'State<span class="token operator">&gt;</span> <span class="token operator">-&gt;</span> Step<span class="token operator">&lt;</span>'State<span class="token punctuation">,</span> Mealy<span class="token operator">&lt;</span>'Command<span class="token punctuation">,</span> 'State<span class="token operator">&gt;&gt;</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">This function takes a command and a <code>Mealy</code> state machine and returns a <code>Step</code>.</p></div><div class="el-p"><p dir="auto">Provided that state machine returned <code>ContinueWith</code> case, <code>Step</code> is going to keep a continuation function that will enable further state machine "evolution".</p></div><div class="el-p"><p dir="auto">Let's implement it.</p></div><div class="el-pre"><pre class="language-fsharp" tabindex="0"><code data-line="0" class="language-fsharp is-loaded"><span class="token keyword">let</span> send<span class="token punctuation">:</span> <span class="token class-name">Send</span><span class="token operator">&lt;</span>DoorMechanismCommand<span class="token punctuation">,</span> DoorMechanismState<span class="token operator">&gt;</span> <span class="token operator">=</span>
        <span class="token keyword">fun</span> doorMachineCommand <span class="token punctuation">(</span>Mealy runDoorMechanismWith<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> 
            runDoorMechanismWith doorMachineCommand
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">It's not the most advanced piece of the code.</p></div><div class="el-p"><p dir="auto">"Unwrapping" a <code>Mealy</code> machine in order to "run" our door mechanism with a given command.</p></div><div class="el-p"><p dir="auto">We're almost there.</p></div><div class="el-p"><p dir="auto">We somehow need to create a new door mechanism, right?</p></div><div class="el-pre"><pre class="language-fsharp" tabindex="0"><code data-line="0" class="language-fsharp is-loaded"><span class="token keyword">let</span> create <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> continueAs Closed
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div></div></div><div class="el-h3 heading-wrapper"><h3 data-heading="Running Mealy door mechanism" dir="auto" class="heading" id="Running_Mealy_door_mechanism"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>Running Mealy door mechanism</h3><div class="heading-children"><div class="el-p"><p dir="auto">Let's create a simple mechanism:</p></div><div class="el-pre"><pre class="language-fsharp" tabindex="0"><code data-line="0" class="language-fsharp is-loaded"><span class="token keyword">let</span> doorMechanism <span class="token operator">=</span> DoorMechanism<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">FSI shows the following result (on my local):</p></div><div class="el-pre"><pre class="language-fsharp" tabindex="0"><code data-line="0" class="language-fsharp is-loaded"><span class="token keyword">val</span> doorMechanism<span class="token punctuation">:</span> <span class="token class-name">DoorMechanism</span> <span class="token operator">=</span> Mealy <span class="token operator">&lt;</span><span class="token keyword">fun</span><span class="token punctuation">:</span><span class="token class-name">continueAs</span>@<span class="token number">23</span><span class="token operator">&gt;</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">Woah, perfect encapsulation!</p></div><div class="el-p"><p dir="auto">Ok, let's make it moving by sending <code>Open</code> to it:</p></div><div class="el-pre"><pre class="language-fsharp" tabindex="0"><code data-line="0" class="language-fsharp is-loaded">doorMechanism
<span class="token operator">|&gt;</span> DoorMechanism<span class="token punctuation">.</span>send Open
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">In return, this gave:</p></div><div class="el-pre"><pre class="language-sh" tabindex="0"><code data-line="0" class="language-sh is-loaded">val it:
  StateMachines.Mealy.Step<span class="token operator">&lt;</span>DoorMechanismState,
                           StateMachines.Mealy.Mealy<span class="token operator">&lt;</span>DoorMechanismCommand,
                                                     DoorMechanismState<span class="token operator">&gt;&gt;</span> <span class="token operator">=</span>
  ContinueWith <span class="token punctuation">(</span>Opened, Mealy <span class="token operator">&lt;</span>fun:continueAs@2<span class="token operator"><span class="token file-descriptor important">3</span>&gt;</span><span class="token punctuation">)</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">That's interesting, isn't it?</p></div><div class="el-p"><p dir="auto">We got a <code>Step</code> that can be continued and it yielded <code>Opened</code> state of a state machine and...</p></div><div class="el-p"><p dir="auto">...A continuation!</p></div><div class="el-p"><p dir="auto">As it's opened, let's try to close it.</p></div><div class="el-pre"><pre class="language-fsharp" tabindex="0"><code data-line="0" class="language-fsharp is-loaded">doorMechanism
<span class="token operator">|&gt;</span> DoorMechanism<span class="token punctuation">.</span>send Open
<span class="token operator">|&gt;</span> DoorMechanism<span class="token punctuation">.</span>send Close <span class="token comment">// ❌ bzzzzt, compile-time error!</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">Oops, something isn't working correctly.</p></div><div class="el-p"><p dir="auto">Shouldn't we be able to send another command?</p></div><div class="el-p"><p dir="auto">Well, yes.</p></div><div class="el-p"><p dir="auto">But we didn't get a <code>Mealy</code> state machine back!</p></div><div class="el-p"><p dir="auto">We have information that a state machine can continue processing. What's more, we also got a pair of current state and state machine continuation.</p></div><div class="el-p"><p dir="auto">Could we just pattern match on <code>ContinueWith</code> and continue processing?</p></div><div class="el-p"><p dir="auto">Well, not really.</p></div><div class="el-p"><p dir="auto">We might eventually get <code>Step</code> and then we won't get a continuation back.</p></div><div class="el-p"><p dir="auto">Hey, we are doing serious functional programming here!</p></div><div class="el-p"><p dir="auto">What would you say, dear Reader, if we pass a function into <code>Step</code>, instead of "getting a state machine" out of the step?</p></div><div class="el-p"><p dir="auto">One could say that we "bind" a function to a given <code>Step</code>, so this <code>Step</code> will have the responsibility to run this function <strong>inside</strong>.</p></div><div class="el-p"><p dir="auto">Let's then define <code>bind</code> function:</p></div><div class="el-pre"><pre class="language-fsharp" tabindex="0"><code data-line="0" class="language-fsharp is-loaded"><span class="token keyword">let</span> bind f <span class="token punctuation">(</span>step<span class="token punctuation">:</span> <span class="token class-name">Step</span><span class="token operator">&lt;</span>'State<span class="token punctuation">,</span> Mealy<span class="token operator">&lt;</span>'Command<span class="token punctuation">,</span>'State<span class="token operator">&gt;&gt;</span><span class="token punctuation">)</span> <span class="token operator">=</span>
    <span class="token keyword">match</span> step <span class="token keyword">with</span>
    <span class="token operator">|</span> Stop <span class="token operator">-&gt;</span> Stop
    <span class="token operator">|</span> ContinueWith continueWith <span class="token operator">-&gt;</span> f continueWith
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto"><code>bind</code> takes a function and a <code>Step</code> and provided that this <code>Step</code> can be continued, it applies a function to a continuation (yet another function).</p></div><div class="el-p"><p dir="auto">So let's utilize it and fix compile-time error:</p></div><div class="el-pre"><pre class="language-fsharp" tabindex="0"><code data-line="0" class="language-fsharp is-loaded">doorMechanism
<span class="token operator">|&gt;</span> DoorMechanism<span class="token punctuation">.</span>send Open
<span class="token operator">|&gt;</span> bind <span class="token punctuation">(</span>snd <span class="token operator">&gt;&gt;</span> DoorMechanism<span class="token punctuation">.</span>send Close<span class="token punctuation">)</span> <span class="token comment">// ✅ works!</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">As a result we get:</p></div><div class="el-pre"><pre class="language-sh" tabindex="0"><code data-line="0" class="language-sh is-loaded">val it:
  StateMachines.Mealy.Step<span class="token operator">&lt;</span>DoorMechanismState,
                           StateMachines.Mealy.Mealy<span class="token operator">&lt;</span>DoorMechanismCommand,
                                                     DoorMechanismState<span class="token operator">&gt;&gt;</span> <span class="token operator">=</span>
  ContinueWith <span class="token punctuation">(</span>Closed, Mealy <span class="token operator">&lt;</span>fun:continueAs@23-<span class="token operator"><span class="token file-descriptor important">1</span>&gt;</span><span class="token punctuation">)</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">As expected, our door mechanism is closed.</p></div><div class="el-p"><p dir="auto">As you probably noticed, dear Reader, we used <code>snd</code> function that takes the second item from a pair.</p></div><div class="el-p"><p dir="auto">That's because the result of <code>send</code> is a pair - current state machine state and "state machine itself" (in fact it's a continuation function but let's say it's a state machine).</p></div><div class="el-p"><p dir="auto">So we just "discard" the current state, as we are not using it anywhere.</p></div><div class="el-p"><p dir="auto">An avid Reader might correlate "bind" verb with Haskell community and well-known <code>&gt;&gt;=</code> operator.</p></div><div class="el-p"><p dir="auto">Our language, F#, is so powerful that we can define such operator that will enable smoother usage:</p></div><div class="el-pre"><pre class="language-fsharp" tabindex="0"><code data-line="0" class="language-fsharp is-loaded"><span class="token keyword">let</span> <span class="token punctuation">(</span><span class="token operator">&gt;&gt;</span><span class="token operator">=</span><span class="token punctuation">)</span> step f <span class="token operator">=</span> bind f step
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">Yup, that's it - we are reordering the arguments.</p></div><div class="el-p"><p dir="auto">And finally, the usage:</p></div><div class="el-pre"><pre class="language-fsharp" tabindex="0"><code data-line="0" class="language-fsharp is-loaded">doorMechanism
<span class="token operator">|&gt;</span> DoorMechanism<span class="token punctuation">.</span>send Open
<span class="token operator">&gt;&gt;</span><span class="token operator">=</span> <span class="token punctuation">(</span>discardOutput <span class="token operator">&gt;&gt;</span> DoorMechanism<span class="token punctuation">.</span>send Close<span class="token punctuation">)</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">=</span> <span class="token punctuation">(</span>discardOutput <span class="token operator">&gt;&gt;</span> DoorMechanism<span class="token punctuation">.</span>send Lock<span class="token punctuation">)</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">=</span> <span class="token punctuation">(</span>discardOutput <span class="token operator">&gt;&gt;</span> DoorMechanism<span class="token punctuation">.</span>send Open<span class="token punctuation">)</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">Our final output is as follows:</p></div><div class="el-pre"><pre class="language-sh" tabindex="0"><code data-line="0" class="language-sh is-loaded">val it:
  StateMachines.Mealy.Step<span class="token operator">&lt;</span>DoorMechanismState,
                           StateMachines.Mealy.Mealy<span class="token operator">&lt;</span>DoorMechanismCommand,
                                                     DoorMechanismState<span class="token operator">&gt;&gt;</span> <span class="token operator">=</span>
  ContinueWith <span class="token punctuation">(</span>Locked, Mealy <span class="token operator">&lt;</span>fun:continueAs@23-<span class="token operator"><span class="token file-descriptor important">1</span>&gt;</span><span class="token punctuation">)</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">I added an alias <code>discardOutput</code> for <code>snd</code> so that it communicates the intention (actually, that's the most important principle in software design!)</p></div></div></div><div class="el-h3 heading-wrapper"><h3 data-heading="How functional are we?" dir="auto" class="heading" id="How_functional_are_we?"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>How functional are we?</h3><div class="heading-children"><div class="el-p"><p dir="auto">Tired?</p></div><div class="el-p"><p dir="auto">I hope not.</p></div><div class="el-p"><p dir="auto">We have things to explore!</p></div><div class="el-p"><p dir="auto">Let's use our Func-o-meter and check how functional we are!</p></div><div class="el-p"><p dir="auto">How many functional points will we get?!</p></div><div class="el-p"><p dir="auto"><span alt="Pasted image 20240912175449.png" src="Pasted image 20240912175449.png" class="internal-embed media-embed image-embed is-loaded"><img alt="Pasted image 20240912175449.png" src="computer-science/programming-language/fsharp/fsm-functional-state-machines/attachments/pasted-image-20240912175449.png"></span></p></div><div class="el-blockquote"><blockquote dir="auto">
<p>Showing how much our Mealy implementation is functional</p>
</blockquote></div><div class="el-p"><p dir="auto">That's just fantastic!</p></div><div class="el-p"><p dir="auto">Mealy state machine implementation beats <a data-tooltip-position="top" aria-label="https://talesfrom.dev/blog/many-faces-of-ddd-aggregates-in-fsharp#solution-3-functional-state-machine-like-approach" rel="noopener nofollow" class="external-link" href="https://talesfrom.dev/blog/many-faces-of-ddd-aggregates-in-fsharp#solution-3-functional-state-machine-like-approach" target="_blank">Functional, State Machine-like approach</a>!</p></div><div class="el-p"><p dir="auto">Hurray!</p></div><div class="el-p"><p dir="auto">Steady, gradual progress!</p></div><div class="el-p"><p dir="auto">It's much more functional - we utilized recursion, pattern matching, we encoded invariants what does it mean "to stop a running state machine".</p></div><div class="el-p"><p dir="auto">That's the engineering we are looking for!</p></div><div class="el-p"><p dir="auto">Strange, I thought it will be close to High.</p></div><div class="el-p"><p dir="auto">Can we be more functional?</p></div></div></div><div class="el-h3 heading-wrapper"><h3 data-heading="[](https://talesfrom.dev/blog/fsm-functional-state-machines#solution-2-domain-specific-language-for-defining-state-machines)Solution #2: Domain-specific language for defining state machines" dir="auto" class="heading" id="[](https://talesfrom.dev/blog/fsm-functional-state-machines#solution-2-domain-specific-language-for-defining-state-machines)Solution_#2:_Domain-specific_language_for_defining_state_machines"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div><a data-tooltip-position="top" aria-label="https://talesfrom.dev/blog/fsm-functional-state-machines#solution-2-domain-specific-language-for-defining-state-machines" rel="noopener nofollow" class="external-link" href="https://talesfrom.dev/blog/fsm-functional-state-machines#solution-2-domain-specific-language-for-defining-state-machines" target="_blank"></a>Solution #2: Domain-specific language for defining state machines</h3><div class="heading-children"><div class="el-p"><p dir="auto">Previous solution for sure is functional but is it readable?</p></div><div class="el-p"><p dir="auto">Could we do a litmus test and show it to any "door mechanisms" expert and ask if we modelled it correctly?</p></div><div class="el-p"><p dir="auto">Well, recursion does not help, for sure.</p></div><div class="el-p"><p dir="auto">Maybe we should revisit our problem that we are trying to provide a solution for.</p></div><div class="el-p"><p dir="auto">Let's bring the rules we started with:</p></div><div class="el-ul"><ul>
<li data-line="0" dir="auto">door mechanism starts as <code>Closed</code></li>
<li data-line="1" dir="auto">only when it's <code>Closed</code>, when trying to <code>Open</code> it, it becomes <code>Opened</code></li>
<li data-line="2" dir="auto">only when it's <code>Opened</code>, when trying to <code>Close</code> it, it becomes <code>Closed</code></li>
<li data-line="3" dir="auto">only when it's <code>Closed</code>, when trying to <code>Lock</code> it, it becomes <code>Locked</code></li>
<li data-line="4" dir="auto">only when it's <code>Locked</code>, when trying to <code>Unlock</code> it, it becomes <code>Closed</code></li>
</ul></div><div class="el-p"><p dir="auto">I really believe that modelling "around" the language has superpowers included in it.</p></div><div class="el-p"><p dir="auto">Ubiquitous language should live not only in spoken language, in models in our heads, but also in the code.</p></div><div class="el-p"><p dir="auto">Ideally, we should be able to translate those rules into a specification on how the door mechanism works.</p></div><div class="el-p"><p dir="auto">By using pseudocode, we could achieve something like this:</p></div><div class="el-pre"><pre class="language-sh" tabindex="0"><code data-line="0" class="language-sh is-loaded">door mechanism:
    starts as Closed
    on Closed when trying to Open <span class="token keyword">then</span> becomes Closed
    on Opened when trying to Close <span class="token keyword">then</span> becomes Opened
    on Closed when trying to Lock <span class="token keyword">then</span> becomes Locked
    on Locked when trying to Unlock <span class="token keyword">then</span> becomes Closed
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">It's very readable, even non-technical experts will be able to comprehend it.</p></div><div class="el-p"><p dir="auto">Also, it's very declarative - we state what happens and all "hows" are hidden, "abstracted away".</p></div><div class="el-p"><p dir="auto">All the words we have used in our specification - they form a domain-specific language (DSL).</p></div><div class="el-p"><p dir="auto">If we call it a ubiquitous language or domain-specific language - those are just labels for the same concept - efficient communication and smoother collaboration.</p></div><div class="el-p"><p dir="auto">Ok, enough talking, let's build such declarative DSL in F#!</p></div><div class="el-p"><p dir="auto">We are going to employ very powerful feature of F# - <a data-tooltip-position="top" aria-label="https://learn.microsoft.com/en-us/dotnet/fsharp/language-reference/computation-expressions" rel="noopener nofollow" class="external-link" href="https://learn.microsoft.com/en-us/dotnet/fsharp/language-reference/computation-expressions" target="_blank">Computation Expressions</a> (or CEs, shortly).</p></div><div class="el-p"><p dir="auto">Computation Expressions empower us to create domain-specific languages, e.g.:</p></div><div class="el-ul"><ul>
<li data-line="0" dir="auto"><a data-tooltip-position="top" aria-label="https://compositionalit.github.io/farmer/" rel="noopener nofollow" class="external-link" href="https://compositionalit.github.io/farmer/" target="_blank">Farmer</a> for expressing Infrastructure as Code (IaC)</li>
<li data-line="1" dir="auto"><a data-tooltip-position="top" aria-label="https://github.com/slaveOftime/Fun.Build" rel="noopener nofollow" class="external-link" href="https://github.com/slaveOftime/Fun.Build" target="_blank">Fun.Build</a> for expressing CI/CD build scripts (and pipelines)</li>
<li data-line="2" dir="auto"><a data-tooltip-position="top" aria-label="https://github.com/sleepyfran/sharp-point" rel="noopener nofollow" class="external-link" href="https://github.com/sleepyfran/sharp-point" target="_blank">sharp-point</a> for building presentations</li>
<li data-line="3" dir="auto">and more!</li>
</ul></div><div class="el-p"><p dir="auto">It sounds like a perfect match - we want to express a specific language, coming from our tiny toy domain.</p></div></div></div><div class="el-h3 heading-wrapper"><h3 data-heading="[](https://talesfrom.dev/blog/fsm-functional-state-machines#expressing-state-machine)Expressing state machine" dir="auto" class="heading" id="[](https://talesfrom.dev/blog/fsm-functional-state-machines#expressing-state-machine)Expressing_state_machine"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div><a data-tooltip-position="top" aria-label="https://talesfrom.dev/blog/fsm-functional-state-machines#expressing-state-machine" rel="noopener nofollow" class="external-link" href="https://talesfrom.dev/blog/fsm-functional-state-machines#expressing-state-machine" target="_blank"></a>Expressing state machine</h3><div class="heading-children"><div class="el-p"><p dir="auto">Yet again, let's remind ourselves main words (types) used in our "door mechanism area":</p></div><div class="el-pre"><pre class="language-fsharp" tabindex="0"><code data-line="0" class="language-fsharp is-loaded"><span class="token keyword">type</span> <span class="token class-name">DoorState</span> <span class="token operator">=</span> Closed <span class="token operator">|</span> Opened <span class="token operator">|</span> Locked
<span class="token keyword">type</span> <span class="token class-name">DoorCommand</span> <span class="token operator">=</span> Open <span class="token operator">|</span> Close <span class="token operator">|</span> Lock <span class="token operator">|</span> Unlock
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">We know what are the core concepts.</p></div><div class="el-p"><p dir="auto">Our first specification, we want to implement, is creating a state machine that starts in a certain state:</p></div><div class="el-pre"><pre class="language-fsharp" tabindex="0"><code data-line="0" class="language-fsharp is-loaded"><span class="token keyword">let</span> machine <span class="token operator">=</span> stateMachine <span class="token string">"doorMechanism"</span> <span class="token punctuation">{</span>
    startsAs Closed
<span class="token punctuation">}</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">We have the following words to cover:</p></div><div class="el-ul"><ul>
<li data-line="0" dir="auto"><code>stateMachine</code></li>
<li data-line="1" dir="auto"><code>startsAs</code></li>
</ul></div><div class="el-p"><p dir="auto"><code>stateMachine</code> is actual computation expression, whereas <code>startAs</code> is a custom operator within this computation expression.</p></div><div class="el-p"><p dir="auto">Let's define the following core building blocks for our DSL:</p></div><div class="el-pre"><pre class="language-fsharp" tabindex="0"><code data-line="0" class="language-fsharp is-loaded"><span class="token keyword">type</span> <span class="token class-name">HandleCommand</span><span class="token operator">&lt;</span>'State<span class="token punctuation">,</span> 'Command<span class="token operator">&gt;</span> <span class="token operator">=</span> 'Command <span class="token operator">-&gt;</span> 'State
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">It simply represents a something that we're going to call a command handler.</p></div><div class="el-p"><p dir="auto">Let's now add low-level contexts that will constitue our state machine:</p></div><div class="el-pre"><pre class="language-fsharp" tabindex="0"><code data-line="0" class="language-fsharp is-loaded"><span class="token keyword">type</span> <span class="token class-name">StateMachineContext</span><span class="token operator">&lt;</span>'State<span class="token punctuation">,</span> 'Command <span class="token keyword">when</span> 'Command <span class="token punctuation">:</span> <span class="token class-name">comparison</span> <span class="token keyword">and</span> 'State <span class="token punctuation">:</span> <span class="token class-name">comparison</span><span class="token operator">&gt;</span> <span class="token operator">=</span>
<span class="token punctuation">{</span>
    State<span class="token punctuation">:</span> 'State
    Transitions<span class="token punctuation">:</span> <span class="token class-name">Map</span><span class="token operator">&lt;</span>'State<span class="token punctuation">,</span> Map<span class="token operator">&lt;</span>'Command<span class="token punctuation">,</span> HandleCommand<span class="token operator">&lt;</span>'State<span class="token punctuation">,</span> 'Command<span class="token operator">&gt;&gt;&gt;</span>
<span class="token punctuation">}</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">It should be self explanatory - it's a context with current state and map of all defined transitions.</p></div><div class="el-p"><p dir="auto">Transitions are modeled as <code>Map</code> of possible states that lead to <code>Map</code> of commands, leading to functions for handling commands.</p></div><div class="el-p"><p dir="auto">I think being "low-level" here will express the details (not the intentions) might be interesting to see that "there's no magic" (the only magical thing in this tale is our Func-o-meter, remember about it dear Reader).</p></div><div class="el-p"><p dir="auto">And finally our state machine, that will be created from specification (we are wishing to build):</p></div><div class="el-pre"><pre class="language-fsharp" tabindex="0"><code data-line="0" class="language-fsharp is-loaded"><span class="token keyword">and</span> StateMachine<span class="token operator">&lt;</span>'State<span class="token punctuation">,</span> 'Command <span class="token keyword">when</span> 'Command <span class="token punctuation">:</span> <span class="token class-name">comparison</span> <span class="token keyword">and</span> 'State <span class="token punctuation">:</span> <span class="token class-name">comparison</span><span class="token operator">&gt;</span> <span class="token operator">=</span> StateMachine <span class="token keyword">of</span> stateMachine<span class="token punctuation">:</span> <span class="token class-name">StateMachineContext</span><span class="token operator">&lt;</span>'State<span class="token punctuation">,</span> 'Command<span class="token operator">&gt;</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">Now we are ready to roll out the implementation for <code>stateMachine</code> computation expression:</p></div><div class="el-pre"><pre class="language-fsharp" tabindex="0"><code data-line="0" class="language-fsharp is-loaded"><span class="token keyword">type</span> <span class="token class-name">StateMachineAssembler</span><span class="token operator">&lt;</span>'State<span class="token punctuation">,</span> 'Command <span class="token keyword">when</span> 'Command <span class="token punctuation">:</span> <span class="token class-name">comparison</span> <span class="token keyword">and</span> 'State <span class="token punctuation">:</span> <span class="token class-name">comparison</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>name<span class="token punctuation">:</span> <span class="token class-name">string</span><span class="token punctuation">)</span> <span class="token operator">=</span>
    <span class="token keyword">member</span> this<span class="token punctuation">.</span><span class="token function">Yield</span><span class="token punctuation">(</span>_<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token computation-expression keyword">StateMachine</span> <span class="token punctuation">{</span> CurrentState <span class="token operator">=</span> Unchecked<span class="token punctuation">.</span>defaultof<span class="token operator">&lt;</span>_<span class="token operator">&gt;</span><span class="token punctuation">;</span> Transitions <span class="token operator">=</span> Map<span class="token punctuation">.</span>empty <span class="token punctuation">}</span> 

    <span class="token comment">// 👇🏻 more members will come!</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">Our state machine assembler accepts a name, but it isn't used anywhere.</p></div><div class="el-p"><p dir="auto">Then we have a first method, that are "natively" supported (and in some cases required) - <code>Yield</code>.</p></div><div class="el-p"><p dir="auto">It helps returning a value from the computation expression.</p></div><div class="el-p"><p dir="auto">This partical overloading of <code>Yield</code> says that given any argument, it's going to yield a broken state machine.</p></div><div class="el-p"><p dir="auto">Why broken?</p></div><div class="el-p"><p dir="auto">The fact we used <code>Unchecked.defaultof&lt;_&gt;</code> which does not look functional, and safe.</p></div><div class="el-p"><p dir="auto">"Functional" might mean predictive, readable, safe and explicit.</p></div><div class="el-p"><p dir="auto">Are we really dealing with <code>StateMachine</code>? Or maybe it's something different?</p></div><div class="el-p"><p dir="auto">Of course, it turns out that we got a hint from our computation expression - in our lingo, the operation of building a state machine can be named as "assembling a state machine".</p></div><div class="el-p"><p dir="auto">This pesky and implicit <code>Unchecked.defaultof&lt;_&gt;</code> (which in fact will manifest as dreaded <code>null</code>) expresses a concept which is missing in our code but for sure lives in the area of our problem.</p></div><div class="el-p"><p dir="auto">Let's make it explicit!</p></div><div class="el-pre"><pre class="language-fsharp" tabindex="0"><code data-line="0" class="language-fsharp is-loaded"><span class="token keyword">type</span> <span class="token class-name">NotAssembledStateMachineContext</span><span class="token operator">&lt;</span>'State<span class="token punctuation">,</span> 'Command <span class="token keyword">when</span> 'Command <span class="token punctuation">:</span> <span class="token class-name">comparison</span> <span class="token keyword">and</span> 'State <span class="token punctuation">:</span> <span class="token class-name">comparison</span><span class="token operator">&gt;</span> <span class="token operator">=</span>
<span class="token punctuation">{</span>
    CurrentState<span class="token punctuation">:</span> 'State option
    Transitions<span class="token punctuation">:</span> <span class="token class-name">Map</span><span class="token operator">&lt;</span>'State<span class="token punctuation">,</span> Map<span class="token operator">&lt;</span>'Command<span class="token punctuation">,</span> HandleCommand<span class="token operator">&lt;</span>'State<span class="token punctuation">,</span> 'Command<span class="token operator">&gt;&gt;&gt;</span>
<span class="token punctuation">}</span>
<span class="token keyword">and</span> NotAssembledMachine<span class="token operator">&lt;</span>'State<span class="token punctuation">,</span> 'Command <span class="token keyword">when</span> 'Command <span class="token punctuation">:</span> <span class="token class-name">comparison</span> <span class="token keyword">and</span> 'State <span class="token punctuation">:</span> <span class="token class-name">comparison</span><span class="token operator">&gt;</span> <span class="token operator">=</span> NotAssembledMachine <span class="token keyword">of</span> stateMachine<span class="token punctuation">:</span> <span class="token class-name">NotAssembledStateMachineContext</span><span class="token operator">&lt;</span>'State<span class="token punctuation">,</span> 'Command<span class="token operator">&gt;</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">Let's introduce <code>NotAssembledMachine</code> concept as type - it will be available only when specifying and assembling a state machine.</p></div><div class="el-p"><p dir="auto">The external world should deal with <code>StateMachine</code> - which is ready to function (pun intended) and provide value to our consumers!</p></div><div class="el-pre"><pre class="language-fsharp" tabindex="0"><code data-line="0" class="language-fsharp is-loaded"><span class="token keyword">type</span> <span class="token class-name">StateMachineAssembler</span><span class="token operator">&lt;</span>'State<span class="token punctuation">,</span> 'Command <span class="token keyword">when</span> 'Command <span class="token punctuation">:</span> <span class="token class-name">comparison</span> <span class="token keyword">and</span> 'State <span class="token punctuation">:</span> <span class="token class-name">comparison</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>name<span class="token punctuation">:</span> <span class="token class-name">string</span><span class="token punctuation">)</span> <span class="token operator">=</span>
        <span class="token keyword">member</span> this<span class="token punctuation">.</span><span class="token function">Yield</span><span class="token punctuation">(</span>_<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token computation-expression keyword">NotAssembledMachine</span> <span class="token punctuation">{</span> CurrentState <span class="token operator">=</span> None<span class="token punctuation">;</span> Transitions <span class="token operator">=</span> Map<span class="token punctuation">.</span>empty <span class="token punctuation">}</span> 
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">Sounds like we are both having fun and modeling the domain of our tiny problem - neat!</p></div></div></div><div class="el-h3 heading-wrapper"><h3 data-heading="[](https://talesfrom.dev/blog/fsm-functional-state-machines#defining-initial-state)Defining initial state" dir="auto" class="heading" id="[](https://talesfrom.dev/blog/fsm-functional-state-machines#defining-initial-state)Defining_initial_state"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div><a data-tooltip-position="top" aria-label="https://talesfrom.dev/blog/fsm-functional-state-machines#defining-initial-state" rel="noopener nofollow" class="external-link" href="https://talesfrom.dev/blog/fsm-functional-state-machines#defining-initial-state" target="_blank"></a>Defining initial state</h3><div class="heading-children"><div class="el-p"><p dir="auto">It's time for our first custom operator: <code>startsAs</code>:</p></div><div class="el-pre"><pre class="language-fsharp" tabindex="0"><code data-line="0" class="language-fsharp is-loaded"><span class="token keyword">type</span> <span class="token class-name">StateMachineAssembler</span><span class="token operator">&lt;</span>'State<span class="token punctuation">,</span> 'Command <span class="token keyword">when</span> 'Command <span class="token punctuation">:</span> <span class="token class-name">comparison</span> <span class="token keyword">and</span> 'State <span class="token punctuation">:</span> <span class="token class-name">comparison</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>name<span class="token punctuation">:</span> <span class="token class-name">string</span><span class="token punctuation">)</span> <span class="token operator">=</span>
    <span class="token comment">// previous methods</span>
    
    <span class="token annotation"><span class="token punctuation">[&lt;</span><span class="token annotation-content">CustomOperation <span class="token string">"startsAs"</span></span><span class="token punctuation">&gt;]</span></span>
    <span class="token keyword">member</span>  this<span class="token punctuation">.</span>startsAs <span class="token punctuation">(</span><span class="token punctuation">(</span>NotAssembledMachine machine<span class="token punctuation">)</span><span class="token punctuation">:</span> NotAssembledMachine<span class="token operator">&lt;</span>'State<span class="token punctuation">,</span> 'Command<span class="token operator">&gt;</span><span class="token punctuation">,</span> state<span class="token punctuation">:</span> 'State<span class="token punctuation">)</span> <span class="token punctuation">:</span> NotAssembledMachine<span class="token operator">&lt;</span>'State<span class="token punctuation">,</span> 'Command<span class="token operator">&gt;</span> <span class="token operator">=</span>
        <span class="token computation-expression keyword">NotAssembledMachine</span> <span class="token punctuation">{</span> machine <span class="token keyword">with</span> CurrentState <span class="token operator">=</span> Some state <span class="token punctuation">}</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">Looks quite simple - it accepts "previously" yielded/returned not assembled machine and makes it current state defined.</p></div><div class="el-p"><p dir="auto">In fact - that the only requirement we have for each machine - it won't be able to do anything but at least it does no harm.</p></div><div class="el-p"><p dir="auto">Now let's assemble our machine!</p></div></div></div><div class="el-h3 heading-wrapper"><h3 data-heading="[](https://talesfrom.dev/blog/fsm-functional-state-machines#turning-not-assembled-machine-into-assembled-one)Turning not assembled machine into assembled one" dir="auto" class="heading" id="[](https://talesfrom.dev/blog/fsm-functional-state-machines#turning-not-assembled-machine-into-assembled-one)Turning_not_assembled_machine_into_assembled_one"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div><a data-tooltip-position="top" aria-label="https://talesfrom.dev/blog/fsm-functional-state-machines#turning-not-assembled-machine-into-assembled-one" rel="noopener nofollow" class="external-link" href="https://talesfrom.dev/blog/fsm-functional-state-machines#turning-not-assembled-machine-into-assembled-one" target="_blank"></a>Turning not assembled machine into assembled one</h3><div class="heading-children"><div class="el-pre"><pre class="language-fsharp" tabindex="0"><code data-line="0" class="language-fsharp is-loaded"><span class="token keyword">type</span> <span class="token class-name">StateMachineAssembler</span><span class="token operator">&lt;</span>'State<span class="token punctuation">,</span> 'Command <span class="token keyword">when</span> 'Command <span class="token punctuation">:</span> <span class="token class-name">comparison</span> <span class="token keyword">and</span> 'State <span class="token punctuation">:</span> <span class="token class-name">comparison</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>name<span class="token punctuation">:</span> <span class="token class-name">string</span><span class="token punctuation">)</span> <span class="token operator">=</span>
    <span class="token comment">// previous method</span>
    <span class="token keyword">member</span> this<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">(</span>NotAssembledMachine machine<span class="token punctuation">)</span><span class="token punctuation">:</span> NotAssembledMachine<span class="token operator">&lt;</span>'State<span class="token punctuation">,</span> 'Command<span class="token operator">&gt;</span><span class="token punctuation">)</span> <span class="token operator">=</span>
        <span class="token keyword">match</span> machine<span class="token punctuation">.</span>CurrentState <span class="token keyword">with</span>
        <span class="token operator">|</span> None <span class="token operator">-&gt;</span> failwith <span class="token string">"You need to provide initial state for a state machine using `startsAs` operator."</span>
        <span class="token operator">|</span> Some state <span class="token operator">-&gt;</span> <span class="token computation-expression keyword">StateMachine</span> <span class="token punctuation">{</span> CurrentState <span class="token operator">=</span> state<span class="token punctuation">;</span> Transitions <span class="token operator">=</span> machine<span class="token punctuation">.</span>Transitions <span class="token punctuation">}</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">We used another "native" and built-in operator - <code>Run</code> - it executes a computation expression and the type returned from this method is exactly what consumers are getting.</p></div><div class="el-p"><p dir="auto">So we need to be careful and provide working state machine!</p></div><div class="el-p"><p dir="auto">As you can see, dear Reader, we check if <code>CurrentState</code> is available.</p></div><div class="el-p"><p dir="auto">Eventually, we should get correctly assembled <code>StateMachine</code> (or runtime exception, in case we didn't cover initial state).</p></div><div class="el-p"><p dir="auto">Let's create "an instance" of state machine assembler:</p></div><div class="el-pre"><pre class="language-fsharp" tabindex="0"><code data-line="0" class="language-fsharp is-loaded"><span class="token keyword">let</span> stateMachine<span class="token operator">&lt;</span>'State<span class="token punctuation">,</span> 'Command <span class="token keyword">when</span> 'Command <span class="token punctuation">:</span> <span class="token class-name">comparison</span> <span class="token keyword">and</span> 'State <span class="token punctuation">:</span> <span class="token class-name">comparison</span><span class="token operator">&gt;</span> <span class="token punctuation">(</span>name<span class="token punctuation">:</span> <span class="token class-name">string</span><span class="token punctuation">)</span>  <span class="token operator">=</span>
    StateMachineAssembler<span class="token operator">&lt;</span>'State<span class="token punctuation">,</span> 'Command<span class="token operator">&gt;</span>  name
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">When we use our specification:</p></div><div class="el-pre"><pre class="language-fsharp" tabindex="0"><code data-line="0" class="language-fsharp is-loaded"><span class="token keyword">let</span> machine <span class="token operator">=</span> stateMachine <span class="token string">"doorMechanism"</span> <span class="token punctuation">{</span>
    startsAs Closed
<span class="token punctuation">}</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">Everything compiles correctly!</p></div><div class="el-p"><p dir="auto">Hurray!</p></div><div class="el-p"><p dir="auto">Then, let's see what FSI tells us, when we "run" our machine assembler:</p></div><div class="el-pre"><pre class="language-sh" tabindex="0"><code data-line="0" class="language-sh is-loaded">val machine: StateMachine<span class="token operator">&lt;</span>DoorState,DoorCommand<span class="token operator">&gt;</span> <span class="token operator">=</span>
    StateMachine <span class="token punctuation">{</span> CurrentState <span class="token operator">=</span> Closed
                   Transitions <span class="token operator">=</span> map <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">}</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div></div></div><div class="el-h3 heading-wrapper"><h3 data-heading="[](https://talesfrom.dev/blog/fsm-functional-state-machines#handling-state-transitions)Handling state transitions" dir="auto" class="heading" id="[](https://talesfrom.dev/blog/fsm-functional-state-machines#handling-state-transitions)Handling_state_transitions"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div><a data-tooltip-position="top" aria-label="https://talesfrom.dev/blog/fsm-functional-state-machines#handling-state-transitions" rel="noopener nofollow" class="external-link" href="https://talesfrom.dev/blog/fsm-functional-state-machines#handling-state-transitions" target="_blank"></a>Handling state transitions</h3><div class="heading-children"><div class="el-p"><p dir="auto">Our machine works but not works.</p></div><div class="el-p"><p dir="auto">We are able to assemble it, require it to start in certain state aaaand that's it.</p></div><div class="el-p"><p dir="auto">We need specification of state transitions!</p></div><div class="el-p"><p dir="auto">Now, we are going to add new computation expression - <code>states</code> that will accept more computation expressions!</p></div><div class="el-p"><p dir="auto">Our goal is to provide <code>states</code> description in the given form:</p></div><div class="el-pre"><pre class="language-fsharp" tabindex="0"><code data-line="0" class="language-fsharp is-loaded"><span class="token keyword">let</span> machine <span class="token operator">=</span> stateMachine <span class="token string">"doorMechanism"</span> <span class="token punctuation">{</span>
    startsAs Closed
    <span class="token computation-expression keyword">states</span> <span class="token punctuation">{</span>
        on <span class="token computation-expression keyword">Closed</span> <span class="token punctuation">{</span>
            whenTryingTo Open <span class="token punctuation">(</span>thenBecomes Opened<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">As you can see, dear Reader, we introduced the following concepts: <code>states</code>, <code>on</code>, <code>whenTryingTo</code> and <code>thenBecomes</code>.</p></div><div class="el-p"><p dir="auto">Let's start with <code>on</code> computation expression.</p></div><div class="el-p"><p dir="auto">Yet again, we need to have to have a "context" that will be evolving, as someone is going to use <code>on</code> computation expression.</p></div><div class="el-p"><p dir="auto">Here's its type definition:</p></div><div class="el-pre"><pre class="language-fsharp" tabindex="0"><code data-line="0" class="language-fsharp is-loaded"><span class="token keyword">and</span> StateTransitions<span class="token operator">&lt;</span>'State<span class="token punctuation">,</span> 'Command <span class="token keyword">when</span> 'Command <span class="token punctuation">:</span> <span class="token class-name">comparison</span> <span class="token keyword">and</span> 'State <span class="token punctuation">:</span> <span class="token class-name">comparison</span><span class="token operator">&gt;</span> <span class="token operator">=</span>
<span class="token punctuation">{</span>
    OnState<span class="token punctuation">:</span> 'State
    Transitions<span class="token punctuation">:</span> <span class="token class-name">Map</span><span class="token operator">&lt;</span>'Command<span class="token punctuation">,</span> HandleCommand<span class="token operator">&lt;</span>'State<span class="token punctuation">,</span> 'Command<span class="token operator">&gt;&gt;</span>
<span class="token punctuation">}</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto"><code>on</code> computation expression is represented by <code>StateTransitionsBuilder</code> and looks as follows:</p></div><div class="el-pre"><pre class="language-fsharp" tabindex="0"><code data-line="0" class="language-fsharp is-loaded"><span class="token keyword">type</span> <span class="token class-name">StateTransitionsBuilder</span><span class="token operator">&lt;</span>'State<span class="token punctuation">,</span> 'Command <span class="token keyword">when</span> 'Command <span class="token punctuation">:</span> <span class="token class-name">comparison</span> <span class="token keyword">and</span> 'State <span class="token punctuation">:</span> <span class="token class-name">comparison</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>fromState<span class="token punctuation">:</span> 'State<span class="token punctuation">)</span> <span class="token operator">=</span>
    <span class="token keyword">member</span> _<span class="token punctuation">.</span>Yield _ <span class="token operator">=</span> Map<span class="token punctuation">.</span>empty
    
    <span class="token annotation"><span class="token punctuation">[&lt;</span><span class="token annotation-content">CustomOperation <span class="token string">"whenTryingTo"</span></span><span class="token punctuation">&gt;]</span></span>
    <span class="token keyword">member</span> _<span class="token punctuation">.</span>whenTryingTo <span class="token punctuation">(</span>ctx<span class="token punctuation">:</span> <span class="token class-name">Map</span><span class="token operator">&lt;</span>'Command<span class="token punctuation">,</span> HandleCommand<span class="token operator">&lt;</span>'State<span class="token punctuation">,</span> 'Command<span class="token operator">&gt;&gt;</span><span class="token punctuation">,</span> command<span class="token punctuation">:</span> 'Command<span class="token punctuation">,</span> handleCommand<span class="token punctuation">:</span>  <span class="token class-name">HandleCommand</span><span class="token operator">&lt;</span>'State<span class="token punctuation">,</span> 'Command<span class="token operator">&gt;</span><span class="token punctuation">)</span><span class="token punctuation">:</span> Map<span class="token operator">&lt;</span>'Command<span class="token punctuation">,</span> HandleCommand<span class="token operator">&lt;</span>'State<span class="token punctuation">,</span> 'Command<span class="token operator">&gt;&gt;</span> <span class="token operator">=</span>
        ctx <span class="token operator">|&gt;</span> Map<span class="token punctuation">.</span>add command handleCommand
    
    <span class="token keyword">member</span> this<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span>ctx<span class="token punctuation">:</span> <span class="token class-name">Map</span><span class="token operator">&lt;</span>'Command<span class="token punctuation">,</span> HandleCommand<span class="token operator">&lt;</span>'State<span class="token punctuation">,</span> 'Command<span class="token operator">&gt;&gt;</span><span class="token punctuation">)</span><span class="token punctuation">:</span> StateTransitions<span class="token operator">&lt;</span>'State<span class="token punctuation">,</span> 'Command<span class="token operator">&gt;</span> <span class="token operator">=</span>
        <span class="token punctuation">{</span> OnState <span class="token operator">=</span> fromState<span class="token punctuation">;</span> Transitions <span class="token operator">=</span> ctx <span class="token punctuation">}</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">It looks pretty similar to our <code>StateMachineAssembler</code>.</p></div><div class="el-p"><p dir="auto">What's worth noticing is that we are able to capture specific concepts through custom operators - as we saw just before.</p></div><div class="el-p"><p dir="auto">We define <code>whenTryingTo</code> operator - it basically adds a new handle command function by a command to a map of all command handlers <code>Map</code>.</p></div><div class="el-p"><p dir="auto">Eventually, we return <code>StateTransitions</code> for a particular state.</p></div><div class="el-p"><p dir="auto">Now, we can define <code>on</code>:</p></div><div class="el-pre"><pre class="language-fsharp" tabindex="0"><code data-line="0" class="language-fsharp is-loaded"><span class="token keyword">let</span> on<span class="token operator">&lt;</span>'State<span class="token punctuation">,</span> 'Command <span class="token keyword">when</span> 'Command <span class="token punctuation">:</span> <span class="token class-name">comparison</span> <span class="token keyword">and</span> 'State <span class="token punctuation">:</span> <span class="token class-name">comparison</span><span class="token operator">&gt;</span> state <span class="token operator">=</span>
    StateTransitionsBuilder<span class="token operator">&lt;</span>'State<span class="token punctuation">,</span> 'Command<span class="token operator">&gt;</span> state
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">Also, let's define a helper function that nicely captures the language:</p></div><div class="el-pre"><pre class="language-fsharp" tabindex="0"><code data-line="0" class="language-fsharp is-loaded"><span class="token keyword">let</span> thenBecomes nextState command  <span class="token operator">=</span> nextState
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">It's dumb simple - just takes the state and returns it.</p></div><div class="el-p"><p dir="auto">Time to check if our state transitions specification compiles!</p></div><div class="el-pre"><pre class="language-fsharp" tabindex="0"><code data-line="0" class="language-fsharp is-loaded"><span class="token keyword">let</span> onClosedTransitions <span class="token operator">=</span> on <span class="token computation-expression keyword">Closed</span> <span class="token punctuation">{</span>
    whenTryingTo Open <span class="token punctuation">(</span>thenBecomes Opened<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">All green, we are good!</p></div><div class="el-p"><p dir="auto">Let's define the last computation expression that will appear in this tiny tale - <code>states</code></p></div></div></div><div class="el-h3 heading-wrapper"><h3 data-heading="[](https://talesfrom.dev/blog/fsm-functional-state-machines#expressing-all-state-transitions)Expressing all state transitions" dir="auto" class="heading" id="[](https://talesfrom.dev/blog/fsm-functional-state-machines#expressing-all-state-transitions)Expressing_all_state_transitions"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div><a data-tooltip-position="top" aria-label="https://talesfrom.dev/blog/fsm-functional-state-machines#expressing-all-state-transitions" rel="noopener nofollow" class="external-link" href="https://talesfrom.dev/blog/fsm-functional-state-machines#expressing-all-state-transitions" target="_blank"></a>Expressing all state transitions</h3><div class="heading-children"><div class="el-p"><p dir="auto">Now we were dealing with transitions for a single state.</p></div><div class="el-p"><p dir="auto">Time to handle all state transitions!</p></div><div class="el-p"><p dir="auto">We're going to start with a builder:</p></div><div class="el-pre"><pre class="language-fsharp" tabindex="0"><code data-line="0" class="language-fsharp is-loaded"><span class="token keyword">type</span> <span class="token class-name">StateMachineStateTransitionsBuilder</span><span class="token char">'&lt;'</span>State<span class="token punctuation">,</span> 'Command <span class="token keyword">when</span> 'Command <span class="token punctuation">:</span> <span class="token class-name">comparison</span> <span class="token keyword">and</span> 'State <span class="token punctuation">:</span> <span class="token class-name">comparison</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span>
    <span class="token keyword">member</span> _<span class="token punctuation">.</span><span class="token function">Yield</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">Nothing fancy - just a "default" <code>Yield</code> that actually will forbid using <code>states</code> computation expression without any state transitions.</p></div><div class="el-p"><p dir="auto">Let's add another <code>Yield</code>, but this time for single state transitions:</p></div><div class="el-pre"><pre class="language-fsharp" tabindex="0"><code data-line="0" class="language-fsharp is-loaded"><span class="token keyword">type</span> <span class="token class-name">StateMachineStateTransitionsBuilder</span><span class="token char">'&lt;'</span>State<span class="token punctuation">,</span> 'Command <span class="token keyword">when</span> 'Command <span class="token punctuation">:</span> <span class="token class-name">comparison</span> <span class="token keyword">and</span> 'State <span class="token punctuation">:</span> <span class="token class-name">comparison</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span>
    <span class="token comment">// previous methods</span>

    <span class="token keyword">member</span> _<span class="token punctuation">.</span><span class="token function">Yield</span><span class="token punctuation">(</span>stateTransitions<span class="token punctuation">:</span> <span class="token class-name">StateTransitions</span><span class="token operator">&lt;</span>'State<span class="token punctuation">,</span> 'Command<span class="token operator">&gt;</span><span class="token punctuation">)</span> <span class="token operator">=</span>
            Map<span class="token punctuation">.</span>ofArray <span class="token punctuation">[</span><span class="token operator">|</span> stateTransitions<span class="token punctuation">.</span>OnState<span class="token punctuation">,</span> stateTransitions<span class="token punctuation">.</span>Transitions <span class="token operator">|</span><span class="token punctuation">]</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">Quite verbose.</p></div><div class="el-p"><p dir="auto">Let's move on.</p></div><div class="el-p"><p dir="auto">We know that each our state transitions specification might have many different possible state transitions.</p></div><div class="el-p"><p dir="auto">Then we need to handle "multiple" values being yielded when specying our state machine.</p></div><div class="el-pre"><pre class="language-fsharp" tabindex="0"><code data-line="0" class="language-fsharp is-loaded"><span class="token keyword">type</span> <span class="token class-name">StateMachineStateTransitionsBuilder</span><span class="token char">'&lt;'</span>State<span class="token punctuation">,</span> 'Command <span class="token keyword">when</span> 'Command <span class="token punctuation">:</span> <span class="token class-name">comparison</span> <span class="token keyword">and</span> 'State <span class="token punctuation">:</span> <span class="token class-name">comparison</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span>
    <span class="token comment">// previous methods</span>

    <span class="token keyword">member</span> _<span class="token punctuation">.</span><span class="token function">Delay</span><span class="token punctuation">(</span>f<span class="token punctuation">:</span> <span class="token class-name">unit <span class="token operator">-&gt;</span> Map</span><span class="token operator">&lt;</span>'State<span class="token punctuation">,</span> Map<span class="token operator">&lt;</span>'Command<span class="token punctuation">,</span> HandleCommand<span class="token operator">&lt;</span>'State<span class="token punctuation">,</span> 'Command<span class="token operator">&gt;&gt;&gt;</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">member</span> _<span class="token punctuation">.</span><span class="token function">Combine</span><span class="token punctuation">(</span>newTransitions<span class="token punctuation">:</span> <span class="token class-name">Map</span><span class="token operator">&lt;</span>'State<span class="token punctuation">,</span> Map<span class="token operator">&lt;</span>'Command<span class="token punctuation">,</span> HandleCommand<span class="token operator">&lt;</span>'State<span class="token punctuation">,</span> 'Command<span class="token operator">&gt;&gt;&gt;</span><span class="token punctuation">,</span> previousTransitions<span class="token punctuation">:</span> <span class="token class-name">Map</span><span class="token operator">&lt;</span>'State<span class="token punctuation">,</span> Map<span class="token operator">&lt;</span>'Command<span class="token punctuation">,</span> HandleCommand<span class="token operator">&lt;</span>'State<span class="token punctuation">,</span> 'Command<span class="token operator">&gt;&gt;&gt;</span><span class="token punctuation">)</span> <span class="token operator">=</span>
            newTransitions <span class="token operator">|&gt;</span> Map<span class="token punctuation">.</span>fold <span class="token punctuation">(</span><span class="token keyword">fun</span> acc key value <span class="token operator">-&gt;</span> Map<span class="token punctuation">.</span>add key value acc<span class="token punctuation">)</span> previousTransitions
    <span class="token keyword">member</span> x<span class="token punctuation">.</span><span class="token function">For</span><span class="token punctuation">(</span>transitions<span class="token punctuation">:</span> <span class="token class-name">Map</span><span class="token operator">&lt;</span>'State<span class="token punctuation">,</span> Map<span class="token operator">&lt;</span>'Command<span class="token punctuation">,</span> HandleCommand<span class="token operator">&lt;</span>'State<span class="token punctuation">,</span> 'Command<span class="token operator">&gt;&gt;&gt;</span><span class="token punctuation">,</span> f<span class="token punctuation">:</span> <span class="token class-name">unit <span class="token operator">-&gt;</span> Map</span><span class="token operator">&lt;</span>'State<span class="token punctuation">,</span> Map<span class="token operator">&lt;</span>'Command<span class="token punctuation">,</span> HandleCommand<span class="token operator">&lt;</span>'State<span class="token punctuation">,</span> 'Command<span class="token operator">&gt;&gt;&gt;</span><span class="token punctuation">)</span> <span class="token operator">=</span>
            x<span class="token punctuation">.</span><span class="token function">Combine</span><span class="token punctuation">(</span>transitions<span class="token punctuation">,</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">Yet again, we need to define three "native" methods - <code>Delay</code>, <code>Combine</code> and <code>For</code>.</p></div><div class="el-p"><p dir="auto">I omit describing them for brevity.</p></div><div class="el-p"><p dir="auto">The most important part is the intention behind it - we are merging all incoming transitions for a single state into a map of such descriptions.</p></div><div class="el-p"><p dir="auto">Eventually, we need to <code>Run</code> our builder to return a value from computation expression:</p></div><div class="el-pre"><pre class="language-fsharp" tabindex="0"><code data-line="0" class="language-fsharp is-loaded"><span class="token keyword">type</span> <span class="token class-name">StateMachineStateTransitionsBuilder</span><span class="token char">'&lt;'</span>State<span class="token punctuation">,</span> 'Command <span class="token keyword">when</span> 'Command <span class="token punctuation">:</span> <span class="token class-name">comparison</span> <span class="token keyword">and</span> 'State <span class="token punctuation">:</span> <span class="token class-name">comparison</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span>
        <span class="token comment">// previous methods</span>
        <span class="token keyword">member</span> x<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span>transitions<span class="token punctuation">:</span> <span class="token class-name">Map</span><span class="token operator">&lt;</span>'State<span class="token punctuation">,</span> Map<span class="token operator">&lt;</span>'Command<span class="token punctuation">,</span> HandleCommand<span class="token operator">&lt;</span>'State<span class="token punctuation">,</span> 'Command<span class="token operator">&gt;&gt;&gt;</span><span class="token punctuation">)</span> <span class="token operator">=</span> transitions 
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">Time to define <code>states</code>!</p></div><div class="el-pre"><pre class="language-fsharp" tabindex="0"><code data-line="0" class="language-fsharp is-loaded"><span class="token keyword">let</span> states<span class="token operator">&lt;</span>'State<span class="token punctuation">,</span> 'Command <span class="token keyword">when</span> 'Command <span class="token punctuation">:</span> <span class="token class-name">comparison</span> <span class="token keyword">and</span> 'State <span class="token punctuation">:</span> <span class="token class-name">comparison</span><span class="token operator">&gt;</span> <span class="token operator">=</span>
    StateMachineStateTransitionsBuilder<span class="token operator">&lt;</span>'State<span class="token punctuation">,</span> 'Command<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">Finally!</p></div><div class="el-p"><p dir="auto">Let's use our newly created DSL to assemble a state machine!</p></div></div></div><div class="el-h3 heading-wrapper"><h3 data-heading="[](https://talesfrom.dev/blog/fsm-functional-state-machines#yet-again-assembling-a-state-machine)(Yet again) Assembling a state machine" dir="auto" class="heading" id="[](https://talesfrom.dev/blog/fsm-functional-state-machines#yet-again-assembling-a-state-machine)(Yet_again)_Assembling_a_state_machine"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div><a data-tooltip-position="top" aria-label="https://talesfrom.dev/blog/fsm-functional-state-machines#yet-again-assembling-a-state-machine" rel="noopener nofollow" class="external-link" href="https://talesfrom.dev/blog/fsm-functional-state-machines#yet-again-assembling-a-state-machine" target="_blank"></a>(Yet again) Assembling a state machine</h3><div class="heading-children"><div class="el-p"><p dir="auto">WHAT?!</p></div><div class="el-p"><p dir="auto">A compile-time error? How could this be?!</p></div><div class="el-pre"><pre class="language-fsharp" tabindex="0"><code data-line="0" class="language-fsharp is-loaded"><span class="token keyword">let</span> machine <span class="token operator">=</span> stateMachine <span class="token string">"doorMechanism"</span> <span class="token punctuation">{</span>
    startsAs Closed <span class="token comment">// ❌ bzzzzt, compile-time error!</span>
    <span class="token computation-expression keyword">states</span> <span class="token punctuation">{</span>
        on <span class="token computation-expression keyword">Closed</span> <span class="token punctuation">{</span>
            whenTryingTo Open <span class="token punctuation">(</span>thenBecomes Opened<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">Inspecting the error message, one could see:</p></div><div class="el-pre"><pre class="language-sh" tabindex="0"><code data-line="0" class="language-sh is-loaded">This control construct may only be used <span class="token keyword">if</span> the computation expression builder defines a <span class="token string">'For'</span> method
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">Hmmm, it actually makes sense.</p></div><div class="el-p"><p dir="auto">Our state machine assembler can handle only single value that gets yielded.</p></div><div class="el-p"><p dir="auto">Each expression within computation expression returns something - if we put more expressions, we need to handle all the values.</p></div><div class="el-p"><p dir="auto">Ok, let's come back to our <code>StateMachineAssembler</code> and provide methods for handling multiple values being return from expressions, inside of a computation expression.</p></div><div class="el-pre"><pre class="language-fsharp" tabindex="0"><code data-line="0" class="language-fsharp is-loaded"><span class="token keyword">type</span> <span class="token class-name">StateMachineAssembler</span><span class="token operator">&lt;</span>'State<span class="token punctuation">,</span> 'Command <span class="token keyword">when</span> 'Command <span class="token punctuation">:</span> <span class="token class-name">comparison</span> <span class="token keyword">and</span> 'State <span class="token punctuation">:</span> <span class="token class-name">comparison</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>name<span class="token punctuation">:</span> <span class="token class-name">string</span><span class="token punctuation">)</span> <span class="token operator">=</span>
        <span class="token comment">// previous methods</span>
            
        <span class="token keyword">member</span> this<span class="token punctuation">.</span><span class="token function">Yield</span><span class="token punctuation">(</span><span class="token punctuation">(</span>transitions<span class="token punctuation">)</span><span class="token punctuation">:</span> Map<span class="token operator">&lt;</span>'State<span class="token punctuation">,</span> Map<span class="token operator">&lt;</span>'Command<span class="token punctuation">,</span> HandleCommand<span class="token operator">&lt;</span>'State<span class="token punctuation">,</span> 'Command<span class="token operator">&gt;&gt;&gt;</span><span class="token punctuation">)</span> <span class="token operator">=</span>
            <span class="token computation-expression keyword">NotAssembledMachine</span> <span class="token punctuation">{</span> CurrentState <span class="token operator">=</span> None<span class="token punctuation">;</span> Transitions <span class="token operator">=</span> transitions <span class="token punctuation">}</span>
        
        <span class="token keyword">member</span> this<span class="token punctuation">.</span><span class="token function">Delay</span><span class="token punctuation">(</span>f<span class="token punctuation">:</span> <span class="token class-name">unit <span class="token operator">-&gt;</span> NotAssembledMachine</span><span class="token operator">&lt;</span>'State<span class="token punctuation">,</span> 'Command<span class="token operator">&gt;</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">member</span> this<span class="token punctuation">.</span><span class="token function">For</span><span class="token punctuation">(</span><span class="token punctuation">(</span>NotAssembledMachine machine<span class="token punctuation">)</span><span class="token punctuation">:</span> NotAssembledMachine<span class="token operator">&lt;</span>'State<span class="token punctuation">,</span> 'Command<span class="token operator">&gt;</span><span class="token punctuation">,</span> f<span class="token punctuation">:</span> <span class="token class-name">unit <span class="token operator">-&gt;</span> NotAssembledMachine</span><span class="token operator">&lt;</span>'State<span class="token punctuation">,</span> 'Command<span class="token operator">&gt;</span><span class="token punctuation">)</span> <span class="token operator">=</span>
            this<span class="token punctuation">.</span><span class="token function">Combine</span><span class="token punctuation">(</span>NotAssembledMachine machine<span class="token punctuation">,</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">member</span> this<span class="token punctuation">.</span><span class="token function">Combine</span><span class="token punctuation">(</span><span class="token punctuation">(</span>NotAssembledMachine newMachine<span class="token punctuation">)</span><span class="token punctuation">:</span> NotAssembledMachine<span class="token operator">&lt;</span>'State<span class="token punctuation">,</span> 'Command<span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>NotAssembledMachine existingMachine<span class="token punctuation">)</span><span class="token punctuation">:</span> NotAssembledMachine<span class="token operator">&lt;</span>'State<span class="token punctuation">,</span> 'Command<span class="token operator">&gt;</span><span class="token punctuation">)</span> <span class="token operator">=</span>
            <span class="token keyword">let</span> newTransitions <span class="token operator">=</span>
                newMachine<span class="token punctuation">.</span>Transitions
                <span class="token operator">|&gt;</span> Map<span class="token punctuation">.</span>fold <span class="token punctuation">(</span><span class="token keyword">fun</span> acc key value <span class="token operator">-&gt;</span> Map<span class="token punctuation">.</span>add key value acc<span class="token punctuation">)</span> existingMachine<span class="token punctuation">.</span>Transitions
            
            <span class="token computation-expression keyword">NotAssembledMachine</span> <span class="token punctuation">{</span> CurrentState <span class="token operator">=</span>  newMachine<span class="token punctuation">.</span>CurrentState<span class="token punctuation">;</span> Transitions <span class="token operator">=</span> newTransitions  <span class="token punctuation">}</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">It's pretty similar to what we saw in <code>StateMachineStateTransitionsBuilder</code>, when creating <code>states</code> computation expression.</p></div><div class="el-p"><p dir="auto">All those methods are required to deal with many values.</p></div><div class="el-p"><p dir="auto">What is worth noticing is the implementation of <code>Combine</code>:</p></div><div class="el-pre"><pre class="language-fsharp" tabindex="0"><code data-line="0" class="language-fsharp is-loaded"><span class="token comment">// ...rest of computation expression</span>
<span class="token keyword">member</span> this<span class="token punctuation">.</span><span class="token function">Combine</span><span class="token punctuation">(</span><span class="token punctuation">(</span>NotAssembledMachine newMachine<span class="token punctuation">)</span><span class="token punctuation">:</span> NotAssembledMachine<span class="token operator">&lt;</span>'State<span class="token punctuation">,</span> 'Command<span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>NotAssembledMachine existingMachine<span class="token punctuation">)</span><span class="token punctuation">:</span> NotAssembledMachine<span class="token operator">&lt;</span>'State<span class="token punctuation">,</span> 'Command<span class="token operator">&gt;</span><span class="token punctuation">)</span> <span class="token operator">=</span>
    <span class="token keyword">let</span> newTransitions <span class="token operator">=</span>
        newMachine<span class="token punctuation">.</span>Transitions
        <span class="token operator">|&gt;</span> Map<span class="token punctuation">.</span>fold <span class="token punctuation">(</span><span class="token keyword">fun</span> acc key value <span class="token operator">-&gt;</span> Map<span class="token punctuation">.</span>add key value acc<span class="token punctuation">)</span> existingMachine<span class="token punctuation">.</span>Transitions
<span class="token comment">// ...rest of computation expression</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">It takes two not assembled machines and combines their state transitions - literally it merges them.</p></div><div class="el-p"><p dir="auto">After handling all the methods, required to support multiple values returned from expressions, it's all green!</p></div><div class="el-pre"><pre class="language-fsharp" tabindex="0"><code data-line="0" class="language-fsharp is-loaded"><span class="token keyword">let</span> machine <span class="token operator">=</span> stateMachine <span class="token string">"doorMechanism"</span> <span class="token punctuation">{</span>
    startsAs Closed <span class="token comment">// ✅ compiles!</span>
    <span class="token computation-expression keyword">states</span> <span class="token punctuation">{</span>
        on <span class="token computation-expression keyword">Closed</span> <span class="token punctuation">{</span>
            whenTryingTo Open <span class="token punctuation">(</span>thenBecomes Opened<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div></div></div><div class="el-h3 heading-wrapper"><h3 data-heading="[](https://talesfrom.dev/blog/fsm-functional-state-machines#final-state-machine)Final State Machine!" dir="auto" class="heading" id="[](https://talesfrom.dev/blog/fsm-functional-state-machines#final-state-machine)Final_State_Machine!"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div><a data-tooltip-position="top" aria-label="https://talesfrom.dev/blog/fsm-functional-state-machines#final-state-machine" rel="noopener nofollow" class="external-link" href="https://talesfrom.dev/blog/fsm-functional-state-machines#final-state-machine" target="_blank"></a>Final State Machine!</h3><div class="heading-children"><div class="el-p"><p dir="auto">We are ready to express, using our DSL, the rules of a door mechanism:</p></div><div class="el-ul"><ul>
<li data-line="0" dir="auto">door mechanism starts as <code>Closed</code></li>
<li data-line="1" dir="auto">only when it's <code>Closed</code>, when trying to <code>Open</code> it, it becomes <code>Opened</code></li>
<li data-line="2" dir="auto">only when it's <code>Opened</code>, when trying to <code>Close</code> it, it becomes <code>Closed</code></li>
<li data-line="3" dir="auto">only when it's <code>Closed</code>, when trying to <code>Lock</code> it, it becomes <code>Locked</code></li>
<li data-line="4" dir="auto">only when it's <code>Locked</code>, when trying to <code>Unlock</code> it, it becomes <code>Closed</code></li>
</ul></div><div class="el-pre"><pre class="language-fsharp" tabindex="0"><code data-line="0" class="language-fsharp is-loaded"><span class="token keyword">let</span> machine <span class="token operator">=</span> stateMachine <span class="token string">"doorMechanism"</span> <span class="token punctuation">{</span>
    startsAs Closed
    <span class="token computation-expression keyword">states</span> <span class="token punctuation">{</span>
        on <span class="token computation-expression keyword">Closed</span> <span class="token punctuation">{</span>
            whenTryingTo Open <span class="token punctuation">(</span>thenBecomes Opened<span class="token punctuation">)</span>
            whenTryingTo Lock <span class="token punctuation">(</span>thenBecomes Locked<span class="token punctuation">)</span>
        <span class="token punctuation">}</span> 
        on <span class="token computation-expression keyword">Opened</span> <span class="token punctuation">{</span>
            whenTryingTo Close <span class="token punctuation">(</span>thenBecomes Closed<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        on <span class="token computation-expression keyword">Locked</span> <span class="token punctuation">{</span>
            whenTryingTo Unlock <span class="token punctuation">(</span>thenBecomes Closed<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">And it all compiles!</p></div><div class="el-p"><p dir="auto">It sounds very natural!</p></div><div class="el-p"><p dir="auto">It is very explicit!</p></div><div class="el-p"><p dir="auto">F# in its purest form ❤️</p></div><div class="el-p"><p dir="auto">LET'S RUN OUR STATE MACHINE!</p></div><div class="el-pre"><pre class="language-sh" tabindex="0"><code data-line="0" class="language-sh is-loaded">val machine: StateMachine<span class="token operator">&lt;</span>DoorState,DoorCommand<span class="token operator">&gt;</span> <span class="token operator">=</span>
    StateMachine
      <span class="token punctuation">{</span> CurrentState <span class="token operator">=</span> Closed
        Transitions <span class="token operator">=</span>
         map
           <span class="token punctuation">[</span><span class="token punctuation">(</span>Closed,
             map <span class="token punctuation">[</span><span class="token punctuation">(</span>Open, <span class="token operator">&lt;</span>fun:machine@86-3<span class="token operator"><span class="token file-descriptor important">2</span>&gt;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">(</span>Lock, <span class="token operator">&lt;</span>fun:machine@87-3<span class="token operator"><span class="token file-descriptor important">3</span>&gt;</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">(</span>Opened, map <span class="token punctuation">[</span><span class="token punctuation">(</span>Close, <span class="token operator">&lt;</span>fun:machine@90-3<span class="token operator"><span class="token file-descriptor important">4</span>&gt;</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">(</span>Locked, map <span class="token punctuation">[</span><span class="token punctuation">(</span>Unlock, <span class="token operator">&lt;</span>fun:machine@93-3<span class="token operator"><span class="token file-descriptor important">5</span>&gt;</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token punctuation">}</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">Specification of how our state machine works.</p></div><div class="el-p"><p dir="auto">Isn't it beautiful?</p></div><div class="el-p"><p dir="auto">But wait, we are not done yet.</p></div><div class="el-p"><p dir="auto">We actually need to execute this specification!</p></div><div class="el-p"><p dir="auto">As in the <a data-tooltip-position="top" aria-label="https://talesfrom.dev/blog/fsm-functional-state-machines#solution-1-mealy-state-machines" rel="noopener nofollow" class="external-link" href="https://talesfrom.dev/blog/fsm-functional-state-machines#solution-1-mealy-state-machines" target="_blank">Solution #1: Mealy State Machines</a>, we are going to define <code>Send</code> action:</p></div><div class="el-pre"><pre class="language-fsharp" tabindex="0"><code data-line="0" class="language-fsharp is-loaded"><span class="token keyword">type</span> <span class="token class-name">Send</span><span class="token operator">&lt;</span>'State<span class="token punctuation">,</span> 'Command <span class="token keyword">when</span> 'State <span class="token punctuation">:</span> <span class="token class-name">comparison</span> <span class="token keyword">and</span> 'Command <span class="token punctuation">:</span> <span class="token class-name">comparison</span><span class="token operator">&gt;</span> <span class="token operator">=</span>
    'Command <span class="token operator">-&gt;</span> StateMachine<span class="token operator">&lt;</span>'State<span class="token punctuation">,</span> 'Command<span class="token operator">&gt;</span> <span class="token operator">-&gt;</span> StateMachine<span class="token operator">&lt;</span>'State<span class="token punctuation">,</span> 'Command<span class="token operator">&gt;</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">Pretty straightforward.</p></div><div class="el-p"><p dir="auto">Now implementation of a <code>send</code> function:</p></div><div class="el-pre"><pre class="language-fsharp" tabindex="0"><code data-line="0" class="language-fsharp is-loaded"><span class="token keyword">let</span> send<span class="token punctuation">:</span> <span class="token class-name">Send</span><span class="token operator">&lt;</span>DoorState<span class="token punctuation">,</span> DoorCommand<span class="token operator">&gt;</span> <span class="token operator">=</span>
        <span class="token keyword">fun</span> command <span class="token punctuation">(</span>StateMachine fsm<span class="token punctuation">)</span> <span class="token operator">-&gt;</span>
            <span class="token keyword">let</span> newState <span class="token operator">=</span>
                <span class="token keyword">match</span> fsm<span class="token punctuation">.</span>Transitions <span class="token operator">|&gt;</span> Map<span class="token punctuation">.</span>tryFind fsm<span class="token punctuation">.</span>CurrentState <span class="token keyword">with</span>
                <span class="token operator">|</span> Some transitions <span class="token operator">-&gt;</span>
                    <span class="token keyword">match</span> transitions <span class="token operator">|&gt;</span> Map<span class="token punctuation">.</span>tryFind command <span class="token keyword">with</span>
                    <span class="token operator">|</span> Some transition <span class="token operator">-&gt;</span> transition command
                    <span class="token operator">|</span> None <span class="token operator">-&gt;</span> fsm<span class="token punctuation">.</span>CurrentState
                <span class="token operator">|</span> None <span class="token operator">-&gt;</span> fsm<span class="token punctuation">.</span>CurrentState
            
            <span class="token computation-expression keyword">StateMachine</span> <span class="token punctuation">{</span> fsm <span class="token keyword">with</span> CurrentState <span class="token operator">=</span> newState <span class="token punctuation">}</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">This function takes a command and finds all specified transitions for a current state, subsequently trying to find a command handler for a given command.</p></div><div class="el-p"><p dir="auto">In case it was found - it applies a transition function to the command (in our tiny tale it's just returning a new state), else it remains in the same state.</p></div><div class="el-p"><p dir="auto">Are you ready?</p></div><div class="el-p"><p dir="auto">This is the final of the all finals!</p></div><div class="el-p"><p dir="auto">Let's send some commands to our door mechanism state machine:</p></div><div class="el-pre"><pre class="language-fsharp" tabindex="0"><code data-line="0" class="language-fsharp is-loaded"><span class="token keyword">let</span> machine' <span class="token operator">=</span>
    machine
    <span class="token operator">|&gt;</span> send Open
    <span class="token operator">|&gt;</span> send Close
    <span class="token operator">|&gt;</span> send Lock
    <span class="token operator">|&gt;</span> send Open
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">FSI quickly gives us feedback:</p></div><div class="el-pre"><pre class="language-sh" tabindex="0"><code data-line="0" class="language-sh is-loaded">  val machine': StateMachine<span class="token operator">&lt;</span>DoorState,DoorCommand<span class="token operator">&gt;</span> <span class="token operator">=</span>
    StateMachine
      <span class="token punctuation">{</span> CurrentState <span class="token operator">=</span> Locked
        Transitions <span class="token operator">=</span>
         map
           <span class="token punctuation">[</span><span class="token punctuation">(</span>Closed,
             map <span class="token punctuation">[</span><span class="token punctuation">(</span>Open, <span class="token operator">&lt;</span>fun:machine@86-2<span class="token operator"><span class="token file-descriptor important">2</span>&gt;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">(</span>Lock, <span class="token operator">&lt;</span>fun:machine@87-2<span class="token operator"><span class="token file-descriptor important">3</span>&gt;</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">(</span>Opened, map <span class="token punctuation">[</span><span class="token punctuation">(</span>Close, <span class="token operator">&lt;</span>fun:machine@90-2<span class="token operator"><span class="token file-descriptor important">4</span>&gt;</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">(</span>Locked, map <span class="token punctuation">[</span><span class="token punctuation">(</span>Unlock, <span class="token operator">&lt;</span>fun:machine@93-2<span class="token operator"><span class="token file-descriptor important">5</span>&gt;</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token punctuation">}</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">As expected, we can't open a locked door mechanism!</p></div><div class="el-p"><p dir="auto">Also, we clearly can see all transitions that need to be interpreted (which we already did!), but it nice to have it in a quite readable form.</p></div></div></div><div class="el-h3 heading-wrapper"><h3 data-heading="[](https://talesfrom.dev/blog/fsm-functional-state-machines#how-functional-are-we-1)How functional are we?" dir="auto" class="heading" id="[](https://talesfrom.dev/blog/fsm-functional-state-machines#how-functional-are-we-1)How_functional_are_we?"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div><a data-tooltip-position="top" aria-label="https://talesfrom.dev/blog/fsm-functional-state-machines#how-functional-are-we-1" rel="noopener nofollow" class="external-link" href="https://talesfrom.dev/blog/fsm-functional-state-machines#how-functional-are-we-1" target="_blank"></a>How functional are we?</h3><div class="heading-children"><div class="el-p"><p dir="auto">Wait!</p></div><div class="el-p"><p dir="auto">We need to measure how functional is our DSL approach to create and run state machines!</p></div><div class="el-p"><p dir="auto">Let's me pull Func-o-meter and check it.</p></div><div class="el-p"><p dir="auto"><span alt="Pasted image 20240912175517.png" src="Pasted image 20240912175517.png" class="internal-embed media-embed image-embed is-loaded"><img alt="Pasted image 20240912175517.png" src="computer-science/programming-language/fsharp/fsm-functional-state-machines/attachments/pasted-image-20240912175517.png"></span></p></div><div class="el-blockquote"><blockquote dir="auto">
<p>Showing how much our DSL implementation is functional</p>
</blockquote></div><div class="el-p"><p dir="auto">CAN YOU BELIEVE THAT?!</p></div><div class="el-p"><p dir="auto">We attained functional enlightment, and our work is a masterpiece.</p></div><div class="el-p"><p dir="auto">DSL-based state machine specification beats everything in the world (in our tiny world of this tiny tale, but still).</p></div><div class="el-p"><p dir="auto">Are you feeling boosted?</p></div><div class="el-p"><p dir="auto">Empowered?!</p></div></div></div><div class="el-h3 heading-wrapper"><h3 data-heading="[](https://talesfrom.dev/blog/fsm-functional-state-machines#what-the-hell-just-happened)WHAT THE HELL JUST HAPPENED?!" dir="auto" class="heading" id="[](https://talesfrom.dev/blog/fsm-functional-state-machines#what-the-hell-just-happened)WHAT_THE_HELL_JUST_HAPPENED?!"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div><a data-tooltip-position="top" aria-label="https://talesfrom.dev/blog/fsm-functional-state-machines#what-the-hell-just-happened" rel="noopener nofollow" class="external-link" href="https://talesfrom.dev/blog/fsm-functional-state-machines#what-the-hell-just-happened" target="_blank"></a>WHAT THE HELL JUST HAPPENED?!</h3><div class="heading-children"><div class="el-p"><p dir="auto">Well, we experienced and encountered maaaany things, along our journey.</p></div><div class="el-p"><p dir="auto">We defined the domain of our problem and we tried to provide as functional solutions as possible.</p></div><div class="el-p"><p dir="auto">We used helpful device called Func-o-meter to measure how functional solutions are:</p></div><div class="el-ul"><ul>
<li data-line="0" dir="auto">Mealy State Machines</li>
<li data-line="1" dir="auto">Domain-specific language for defining state machines</li>
</ul></div><div class="el-p"><p dir="auto">Unfortunately, I need to disappoint you, dear and patient Reader...</p></div><div class="el-p"><p dir="auto">...Func-o-meter does not exist.</p></div><div class="el-p"><p dir="auto">I must appologize you - I can't measure how functional the code is.</p></div><div class="el-p"><p dir="auto">What does it really mean?</p></div><div class="el-p"><p dir="auto">Recently, more and more languages are getting functional flavors (I am not calling them features, purposefully).</p></div><div class="el-p"><p dir="auto">And that's good - but its worth keeping that in mind they might be "flavors", add-ins - not core concepts in which the language was forged.</p></div><div class="el-p"><p dir="auto">Nothing wrong with that!</p></div><div class="el-p"><p dir="auto">The language is a tool, and of course it shapes the way one is thinking, modeling and reasoning - still, the most important thing is delivering value to our users/customers, with software (or without it, actually).</p></div><div class="el-p"><p dir="auto">So all the comparisons and measurements our imaginary Func-o-meter did, are farfetched.</p></div><div class="el-p"><p dir="auto">Still we could define some tenets or attributes, that are attracted by functional-first thinking.</p></div><div class="el-p"><p dir="auto">As I concluded in <a data-tooltip-position="top" aria-label="https://talesfrom.dev/blog/many-faces-of-ddd-aggregates-in-fsharp" rel="noopener nofollow" class="external-link" href="https://talesfrom.dev/blog/many-faces-of-ddd-aggregates-in-fsharp" target="_blank">Many faces of DDD Aggregates in F#</a></p></div><div class="el-p"><p dir="auto">Conclusion 🔍</p></div><div class="el-p"><p dir="auto">FP achieves evolvability through immutability</p></div><div class="el-p"><p dir="auto">And we were able to see this phenomenon, while experiencing our tiny journey.</p></div><div class="el-p"><p dir="auto">Another one I would add to "functional-first thinking" basket is composition - on all levels - function composition, type composition.</p></div><div class="el-p"><p dir="auto">Both immutability and composition, in my mind, express the most fundamental part of functional-first thinking - transformative nature.</p></div><div class="el-p"><p dir="auto">Processes have a transformative nature too.</p></div><div class="el-p"><p dir="auto">They make one thing become another and we literally saw that, especially in our lovely DSL.</p></div><div class="el-p"><p dir="auto">Of course, we don't need to model everything in such a way - there's <a data-tooltip-position="top" aria-label="https://talesfrom.dev/blog/the-cost-of-modeling" rel="noopener nofollow" class="external-link" href="https://talesfrom.dev/blog/the-cost-of-modeling" target="_blank">The cost of modeling</a> for each model we build.</p></div><div class="el-p"><p dir="auto">But I believe functional-first thinking helps us to perform modeling on the "highest" possible level - "becoming" level (you don't know what I am talking about? you might be interested in <a data-tooltip-position="top" aria-label="https://talesfrom.dev/blog/modeling-maturity-levels" rel="noopener nofollow" class="external-link" href="https://talesfrom.dev/blog/modeling-maturity-levels" target="_blank">Modeling Maturity Levels</a>).</p></div><div class="el-p"><p dir="auto">So what I would suggest is to think in the "functional-first" way (immutability, composition and "transformatively") and not to "be" functional.</p></div></div></div><div class="el-h3 heading-wrapper"><h3 data-heading="[](https://talesfrom.dev/blog/fsm-functional-state-machines#closing)Closing" dir="auto" class="heading" id="[](https://talesfrom.dev/blog/fsm-functional-state-machines#closing)Closing"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div><a data-tooltip-position="top" aria-label="https://talesfrom.dev/blog/fsm-functional-state-machines#closing" rel="noopener nofollow" class="external-link" href="https://talesfrom.dev/blog/fsm-functional-state-machines#closing" target="_blank"></a>Closing</h3><div class="heading-children"><div class="el-p"><p dir="auto">Thank you for your patience, dear Reader.</p></div><div class="el-p"><p dir="auto">I hope you found it interesting to see the same problem from many different perspectives and to model the solutions on various levels.</p></div><div class="el-p"><p dir="auto">One thing that is so important and it would be a shame for me if I didn't mention it.</p></div><div class="el-p"><p dir="auto">We played with the powerful, functional-first language that F# is, but still the most important aspect of our job is understanding the problem we need to solve.</p></div><div class="el-p"><p dir="auto">This reminds me the following saying:</p></div><div class="el-p"><p dir="auto">Conclusion 🔍</p></div><div class="el-p"><p dir="auto">Well-defined problem contains half of the solution</p></div><div class="el-p"><p dir="auto">As always, there's half truth, half "myth", but it gives the impression that we really need to be careful how we define our problems.</p></div><div class="el-p"><p dir="auto">I feel it's a nice moment to stop our little journey, dear Reader.</p></div><div class="el-p"><p dir="auto">Thank you and see you soon!</p></div><div class="el-p"><p dir="auto"><strong>NOTE</strong>: source code will be shared soon</p></div><div class="mod-footer mod-ui"></div></div></div></div></div></div><div class="sidebar-right sidebar"><div class="sidebar-handle"></div><div class="sidebar-topbar"><div class="topbar-content"></div><div class="clickable-icon sidebar-collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" class="svg-icon"><path d="M21 3H3C1.89543 3 1 3.89543 1 5V19C1 20.1046 1.89543 21 3 21H21C22.1046 21 23 20.1046 23 19V5C23 3.89543 22.1046 3 21 3Z"></path><path d="M10 4V20"></path><path d="M4 7H7"></path><path d="M4 10H7"></path><path d="M4 13H7"></path></svg></div></div><div class="sidebar-content"><div class="graph-view-wrapper"><div class="sidebar-section-header">Interactive Graph</div><div class="graph-view-placeholder">
		<div class="graph-view-container">
			<div class="graph-icon graph-expand" role="button" aria-label="Expand" data-tooltip-position="top"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon"><line x1="7" y1="17" x2="17" y2="7"></line><polyline points="7 7 17 7 17 17"></polyline></svg></div>
			<canvas id="graph-canvas" class="hide" width="512px" height="512px"></canvas>
		</div>
		</div></div><div class="tree-container mod-root nav-folder tree-item outline-tree" data-depth="0"><div class="tree-header"><span class="sidebar-section-header">Table Of Contents</span><button class="clickable-icon collapse-tree-button" aria-label="Collapse All"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></svg></button></div><div class="tree-scroll-area tree-item-children nav-folder-children"><div class="tree-item mod-tree-folder nav-folder mod-collapsible is-collapsed" style="display: none;"></div><div class="tree-item" data-depth="1"><a class="tree-link" href="computer-science/programming-language/fsharp/fsm-functional-state-machines/fsm-functional-state-machines.html#FSM - Functional State Machines"><div class="tree-item-contents heading-link" heading-name="FSM - Functional State Machines"><span class="tree-item-title">FSM - Functional State Machines</span></div></a><div class="tree-item-children nav-folder-children"><div class="tree-item" data-depth="3"><a class="tree-link" href="computer-science/programming-language/fsharp/fsm-functional-state-machines/fsm-functional-state-machines.html#Functional,_State_Machine-like_approach"><div class="tree-item-contents heading-link" heading-name="Functional, State Machine-like approach"><span class="tree-item-title">Functional, State Machine-like approach</span></div></a><div class="tree-item-children nav-folder-children"></div></div><div class="tree-item" data-depth="3"><a class="tree-link" href="computer-science/programming-language/fsharp/fsm-functional-state-machines/fsm-functional-state-machines.html#[](https://talesfrom.dev/blog/fsm-functional-state-machines#problem)Problem?"><div class="tree-item-contents heading-link" heading-name="[](https://talesfrom.dev/blog/fsm-functional-state-machines#problem)Problem?"><span class="tree-item-title"><a data-tooltip-position="top" aria-label="https://talesfrom.dev/blog/fsm-functional-state-machines#problem" rel="noopener nofollow" class="external-link" href="https://talesfrom.dev/blog/fsm-functional-state-machines#problem" target="_blank"></a>Problem?</span></div></a><div class="tree-item-children nav-folder-children"></div></div><div class="tree-item" data-depth="3"><a class="tree-link" href="computer-science/programming-language/fsharp/fsm-functional-state-machines/fsm-functional-state-machines.html#Solution_#1:_Mealy_State_Machines"><div class="tree-item-contents heading-link" heading-name="Solution #1: Mealy State Machines"><span class="tree-item-title">Solution #1: Mealy State Machines</span></div></a><div class="tree-item-children nav-folder-children"></div></div><div class="tree-item" data-depth="3"><a class="tree-link" href="computer-science/programming-language/fsharp/fsm-functional-state-machines/fsm-functional-state-machines.html#Modeling_a_domain:_door_mechanism"><div class="tree-item-contents heading-link" heading-name="Modeling a domain: door mechanism"><span class="tree-item-title">Modeling a domain: door mechanism</span></div></a><div class="tree-item-children nav-folder-children"></div></div><div class="tree-item" data-depth="3"><a class="tree-link" href="computer-science/programming-language/fsharp/fsm-functional-state-machines/fsm-functional-state-machines.html#Running_Mealy_door_mechanism"><div class="tree-item-contents heading-link" heading-name="Running Mealy door mechanism"><span class="tree-item-title">Running Mealy door mechanism</span></div></a><div class="tree-item-children nav-folder-children"></div></div><div class="tree-item" data-depth="3"><a class="tree-link" href="computer-science/programming-language/fsharp/fsm-functional-state-machines/fsm-functional-state-machines.html#How_functional_are_we?"><div class="tree-item-contents heading-link" heading-name="How functional are we?"><span class="tree-item-title">How functional are we?</span></div></a><div class="tree-item-children nav-folder-children"></div></div><div class="tree-item" data-depth="3"><a class="tree-link" href="computer-science/programming-language/fsharp/fsm-functional-state-machines/fsm-functional-state-machines.html#[](https://talesfrom.dev/blog/fsm-functional-state-machines#solution-2-domain-specific-language-for-defining-state-machines)Solution_#2:_Domain-specific_language_for_defining_state_machines"><div class="tree-item-contents heading-link" heading-name="[](https://talesfrom.dev/blog/fsm-functional-state-machines#solution-2-domain-specific-language-for-defining-state-machines)Solution #2: Domain-specific language for defining state machines"><span class="tree-item-title"><a data-tooltip-position="top" aria-label="https://talesfrom.dev/blog/fsm-functional-state-machines#solution-2-domain-specific-language-for-defining-state-machines" rel="noopener nofollow" class="external-link" href="https://talesfrom.dev/blog/fsm-functional-state-machines#solution-2-domain-specific-language-for-defining-state-machines" target="_blank"></a>Solution #2: Domain-specific language for defining state machines</span></div></a><div class="tree-item-children nav-folder-children"></div></div><div class="tree-item" data-depth="3"><a class="tree-link" href="computer-science/programming-language/fsharp/fsm-functional-state-machines/fsm-functional-state-machines.html#[](https://talesfrom.dev/blog/fsm-functional-state-machines#expressing-state-machine)Expressing_state_machine"><div class="tree-item-contents heading-link" heading-name="[](https://talesfrom.dev/blog/fsm-functional-state-machines#expressing-state-machine)Expressing state machine"><span class="tree-item-title"><a data-tooltip-position="top" aria-label="https://talesfrom.dev/blog/fsm-functional-state-machines#expressing-state-machine" rel="noopener nofollow" class="external-link" href="https://talesfrom.dev/blog/fsm-functional-state-machines#expressing-state-machine" target="_blank"></a>Expressing state machine</span></div></a><div class="tree-item-children nav-folder-children"></div></div><div class="tree-item" data-depth="3"><a class="tree-link" href="computer-science/programming-language/fsharp/fsm-functional-state-machines/fsm-functional-state-machines.html#[](https://talesfrom.dev/blog/fsm-functional-state-machines#defining-initial-state)Defining_initial_state"><div class="tree-item-contents heading-link" heading-name="[](https://talesfrom.dev/blog/fsm-functional-state-machines#defining-initial-state)Defining initial state"><span class="tree-item-title"><a data-tooltip-position="top" aria-label="https://talesfrom.dev/blog/fsm-functional-state-machines#defining-initial-state" rel="noopener nofollow" class="external-link" href="https://talesfrom.dev/blog/fsm-functional-state-machines#defining-initial-state" target="_blank"></a>Defining initial state</span></div></a><div class="tree-item-children nav-folder-children"></div></div><div class="tree-item" data-depth="3"><a class="tree-link" href="computer-science/programming-language/fsharp/fsm-functional-state-machines/fsm-functional-state-machines.html#[](https://talesfrom.dev/blog/fsm-functional-state-machines#turning-not-assembled-machine-into-assembled-one)Turning_not_assembled_machine_into_assembled_one"><div class="tree-item-contents heading-link" heading-name="[](https://talesfrom.dev/blog/fsm-functional-state-machines#turning-not-assembled-machine-into-assembled-one)Turning not assembled machine into assembled one"><span class="tree-item-title"><a data-tooltip-position="top" aria-label="https://talesfrom.dev/blog/fsm-functional-state-machines#turning-not-assembled-machine-into-assembled-one" rel="noopener nofollow" class="external-link" href="https://talesfrom.dev/blog/fsm-functional-state-machines#turning-not-assembled-machine-into-assembled-one" target="_blank"></a>Turning not assembled machine into assembled one</span></div></a><div class="tree-item-children nav-folder-children"></div></div><div class="tree-item" data-depth="3"><a class="tree-link" href="computer-science/programming-language/fsharp/fsm-functional-state-machines/fsm-functional-state-machines.html#[](https://talesfrom.dev/blog/fsm-functional-state-machines#handling-state-transitions)Handling_state_transitions"><div class="tree-item-contents heading-link" heading-name="[](https://talesfrom.dev/blog/fsm-functional-state-machines#handling-state-transitions)Handling state transitions"><span class="tree-item-title"><a data-tooltip-position="top" aria-label="https://talesfrom.dev/blog/fsm-functional-state-machines#handling-state-transitions" rel="noopener nofollow" class="external-link" href="https://talesfrom.dev/blog/fsm-functional-state-machines#handling-state-transitions" target="_blank"></a>Handling state transitions</span></div></a><div class="tree-item-children nav-folder-children"></div></div><div class="tree-item" data-depth="3"><a class="tree-link" href="computer-science/programming-language/fsharp/fsm-functional-state-machines/fsm-functional-state-machines.html#[](https://talesfrom.dev/blog/fsm-functional-state-machines#expressing-all-state-transitions)Expressing_all_state_transitions"><div class="tree-item-contents heading-link" heading-name="[](https://talesfrom.dev/blog/fsm-functional-state-machines#expressing-all-state-transitions)Expressing all state transitions"><span class="tree-item-title"><a data-tooltip-position="top" aria-label="https://talesfrom.dev/blog/fsm-functional-state-machines#expressing-all-state-transitions" rel="noopener nofollow" class="external-link" href="https://talesfrom.dev/blog/fsm-functional-state-machines#expressing-all-state-transitions" target="_blank"></a>Expressing all state transitions</span></div></a><div class="tree-item-children nav-folder-children"></div></div><div class="tree-item" data-depth="3"><a class="tree-link" href="computer-science/programming-language/fsharp/fsm-functional-state-machines/fsm-functional-state-machines.html#[](https://talesfrom.dev/blog/fsm-functional-state-machines#yet-again-assembling-a-state-machine)(Yet_again)_Assembling_a_state_machine"><div class="tree-item-contents heading-link" heading-name="[](https://talesfrom.dev/blog/fsm-functional-state-machines#yet-again-assembling-a-state-machine)(Yet again) Assembling a state machine"><span class="tree-item-title"><a data-tooltip-position="top" aria-label="https://talesfrom.dev/blog/fsm-functional-state-machines#yet-again-assembling-a-state-machine" rel="noopener nofollow" class="external-link" href="https://talesfrom.dev/blog/fsm-functional-state-machines#yet-again-assembling-a-state-machine" target="_blank"></a>(Yet again) Assembling a state machine</span></div></a><div class="tree-item-children nav-folder-children"></div></div><div class="tree-item" data-depth="3"><a class="tree-link" href="computer-science/programming-language/fsharp/fsm-functional-state-machines/fsm-functional-state-machines.html#[](https://talesfrom.dev/blog/fsm-functional-state-machines#final-state-machine)Final_State_Machine!"><div class="tree-item-contents heading-link" heading-name="[](https://talesfrom.dev/blog/fsm-functional-state-machines#final-state-machine)Final State Machine!"><span class="tree-item-title"><a data-tooltip-position="top" aria-label="https://talesfrom.dev/blog/fsm-functional-state-machines#final-state-machine" rel="noopener nofollow" class="external-link" href="https://talesfrom.dev/blog/fsm-functional-state-machines#final-state-machine" target="_blank"></a>Final State Machine!</span></div></a><div class="tree-item-children nav-folder-children"></div></div><div class="tree-item" data-depth="3"><a class="tree-link" href="computer-science/programming-language/fsharp/fsm-functional-state-machines/fsm-functional-state-machines.html#[](https://talesfrom.dev/blog/fsm-functional-state-machines#how-functional-are-we-1)How_functional_are_we?"><div class="tree-item-contents heading-link" heading-name="[](https://talesfrom.dev/blog/fsm-functional-state-machines#how-functional-are-we-1)How functional are we?"><span class="tree-item-title"><a data-tooltip-position="top" aria-label="https://talesfrom.dev/blog/fsm-functional-state-machines#how-functional-are-we-1" rel="noopener nofollow" class="external-link" href="https://talesfrom.dev/blog/fsm-functional-state-machines#how-functional-are-we-1" target="_blank"></a>How functional are we?</span></div></a><div class="tree-item-children nav-folder-children"></div></div><div class="tree-item" data-depth="3"><a class="tree-link" href="computer-science/programming-language/fsharp/fsm-functional-state-machines/fsm-functional-state-machines.html#[](https://talesfrom.dev/blog/fsm-functional-state-machines#what-the-hell-just-happened)WHAT_THE_HELL_JUST_HAPPENED?!"><div class="tree-item-contents heading-link" heading-name="[](https://talesfrom.dev/blog/fsm-functional-state-machines#what-the-hell-just-happened)WHAT THE HELL JUST HAPPENED?!"><span class="tree-item-title"><a data-tooltip-position="top" aria-label="https://talesfrom.dev/blog/fsm-functional-state-machines#what-the-hell-just-happened" rel="noopener nofollow" class="external-link" href="https://talesfrom.dev/blog/fsm-functional-state-machines#what-the-hell-just-happened" target="_blank"></a>WHAT THE HELL JUST HAPPENED?!</span></div></a><div class="tree-item-children nav-folder-children"></div></div><div class="tree-item" data-depth="3"><a class="tree-link" href="computer-science/programming-language/fsharp/fsm-functional-state-machines/fsm-functional-state-machines.html#[](https://talesfrom.dev/blog/fsm-functional-state-machines#closing)Closing"><div class="tree-item-contents heading-link" heading-name="[](https://talesfrom.dev/blog/fsm-functional-state-machines#closing)Closing"><span class="tree-item-title"><a data-tooltip-position="top" aria-label="https://talesfrom.dev/blog/fsm-functional-state-machines#closing" rel="noopener nofollow" class="external-link" href="https://talesfrom.dev/blog/fsm-functional-state-machines#closing" target="_blank"></a>Closing</span></div></a><div class="tree-item-children nav-folder-children"></div></div></div></div></div></div></div><script defer="">let rs = document.querySelector(".sidebar-right"); rs.classList.add("is-collapsed"); if (window.innerWidth > 768) rs.classList.remove("is-collapsed"); rs.style.setProperty("--sidebar-width", localStorage.getItem("sidebar-right-width"));</script></div></div></body></html>