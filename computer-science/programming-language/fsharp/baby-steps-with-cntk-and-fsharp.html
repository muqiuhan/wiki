<!DOCTYPE html> <html><head>
		<title>Baby steps with CNTK and FSharp</title>
		<base href="../../../">
		<meta id="root-path" root-path="../../../">
		<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes, minimum-scale=1.0, maximum-scale=5.0">
		<meta charset="UTF-8">
		<meta name="description" content="韩暮秋的个人维基 - Baby steps with CNTK and FSharp">
		<meta property="og:title" content="Baby steps with CNTK and FSharp">
		<meta property="og:description" content="韩暮秋的个人维基 - Baby steps with CNTK and FSharp">
		<meta property="og:type" content="website">
		<meta property="og:url" content="https://muqiuhan.github.io/wiki/computer-science/programming-language/fsharp/baby-steps-with-cntk-and-fsharp.html">
		<meta property="og:image" content="undefined">
		<meta property="og:site_name" content="韩暮秋的个人维基">
		<meta name="author" content="韩暮秋"><link rel="alternate" type="application/rss+xml" title="RSS Feed" href="https://muqiuhan.github.io/wiki/lib/rss.xml"><script async="" id="webpage-script" src="lib/scripts/webpage.js" onload="this.onload=null;this.setAttribute(&quot;loaded&quot;, &quot;true&quot;)"></script><script type="module" async="" id="graph-view-script" src="lib/scripts/graph-view.js"></script><script async="" id="graph-wasm-script" src="lib/scripts/graph-wasm.js" onload="this.onload=null;this.setAttribute(&quot;loaded&quot;, &quot;true&quot;)"></script><script async="" id="graph-render-worker-script" src="lib/scripts/graph-render-worker.js" onload="this.onload=null;this.setAttribute(&quot;loaded&quot;, &quot;true&quot;)"></script><script async="" id="tinycolor-script" src="lib/scripts/tinycolor.js" onload="this.onload=null;this.setAttribute(&quot;loaded&quot;, &quot;true&quot;)"></script><script async="" id="pixi-script" src="lib/scripts/pixi.js" onload="this.onload=null;this.setAttribute(&quot;loaded&quot;, &quot;true&quot;)"></script><script async="" id="minisearch-script" src="lib/scripts/minisearch.js" onload="this.onload=null;this.setAttribute(&quot;loaded&quot;, &quot;true&quot;)"></script><link rel="icon" href="lib/media/favicon.png"><script async="" id="graph-data-script" src="lib/scripts/graph-data.js" onload="this.onload=null;this.setAttribute(&quot;loaded&quot;, &quot;true&quot;)"></script><style>body{--line-width:40em;--line-width-adaptive:40em;--file-line-width:40em;--sidebar-width:min(20em, 80vw);--collapse-arrow-size:11px;--tree-horizontal-spacing:0.6em;--tree-vertical-spacing:0.6em;--sidebar-margin:12px}.sidebar{height:100%;min-width:calc(var(--sidebar-width) + var(--divider-width-hover));max-width:calc(var(--sidebar-width) + var(--divider-width-hover));font-size:14px;z-index:10;position:relative;overflow:hidden;transition:min-width ease-in-out,max-width ease-in-out;transition-duration:.2s;contain:size}.sidebar-left{left:0}.sidebar-right{right:0}.sidebar.is-collapsed{min-width:0;max-width:0}body.floating-sidebars .sidebar{position:absolute}.sidebar-content{height:100%;min-width:calc(var(--sidebar-width) - var(--divider-width-hover));top:0;padding:var(--sidebar-margin);padding-top:4em;line-height:var(--line-height-tight);background-color:var(--background-secondary);transition:background-color,border-right,border-left,box-shadow;transition-duration:var(--color-fade-speed);transition-timing-function:ease-in-out;position:absolute;display:flex;flex-direction:column}.sidebar:not(.is-collapsed) .sidebar-content{min-width:calc(max(100%,var(--sidebar-width)) - 3px);max-width:calc(max(100%,var(--sidebar-width)) - 3px)}.sidebar-left .sidebar-content{left:0;border-top-right-radius:var(--radius-l);border-bottom-right-radius:var(--radius-l)}.sidebar-right .sidebar-content{right:0;border-top-left-radius:var(--radius-l);border-bottom-left-radius:var(--radius-l)}.sidebar:has(.sidebar-content:empty):has(.topbar-content:empty){display:none}.sidebar-topbar{height:2em;width:var(--sidebar-width);top:var(--sidebar-margin);padding-inline:var(--sidebar-margin);z-index:1;position:fixed;display:flex;align-items:center;transition:width ease-in-out;transition-duration:inherit}.sidebar.is-collapsed .sidebar-topbar{width:calc(2.3em + var(--sidebar-margin) * 2)}.sidebar .sidebar-topbar.is-collapsed{width:0}.sidebar-left .sidebar-topbar{left:0}.sidebar-right .sidebar-topbar{right:0}.topbar-content{overflow:hidden;overflow:clip;width:100%;height:100%;display:flex;align-items:center;transition:inherit}.sidebar.is-collapsed .topbar-content{width:0;transition:inherit}.clickable-icon.sidebar-collapse-icon{background-color:transparent;color:var(--icon-color-focused);padding:0!important;margin:0!important;height:100%!important;width:2.3em!important;margin-inline:0.14em!important;position:absolute}.sidebar-left .clickable-icon.sidebar-collapse-icon{transform:rotateY(180deg);right:var(--sidebar-margin)}.sidebar-right .clickable-icon.sidebar-collapse-icon{transform:rotateY(180deg);left:var(--sidebar-margin)}.clickable-icon.sidebar-collapse-icon svg.svg-icon{width:100%;height:100%}.sidebar-section-header{margin:0 0 1em 0;text-transform:uppercase;letter-spacing:.06em;font-weight:600}body{transition:background-color var(--color-fade-speed) ease-in-out}.webpage-container{display:flex;flex-direction:row;height:100%;width:100%;align-items:stretch;justify-content:center}.document-container{opacity:1;flex-basis:100%;max-width:100%;width:100%;height:100%;display:flex;flex-direction:column;align-items:center;transition:opacity .2s ease-in-out;contain:inline-size}.hide{opacity:0;transition:opacity .2s ease-in-out}.document-container>.markdown-preview-view{margin:var(--sidebar-margin);margin-bottom:0;width:100%;width:-webkit-fill-available;width:-moz-available;width:fill-available;background-color:var(--background-primary);transition:background-color var(--color-fade-speed) ease-in-out;border-top-right-radius:var(--window-radius,var(--radius-m));border-top-left-radius:var(--window-radius,var(--radius-m));overflow-x:hidden!important;overflow-y:auto!important;display:flex!important;flex-direction:column!important;align-items:center!important;contain:inline-size}.document-container>.markdown-preview-view>.markdown-preview-sizer{padding-bottom:80vh!important;width:100%!important;max-width:var(--line-width)!important;flex-basis:var(--line-width)!important;transition:background-color var(--color-fade-speed) ease-in-out;contain:inline-size}.markdown-rendered img:not([width]),.view-content img:not([width]){max-width:100%;outline:0}.document-container>.view-content.embed{display:flex;padding:1em;height:100%;width:100%;align-items:center;justify-content:center}.document-container>.view-content.embed>*{max-width:100%;max-height:100%;object-fit:contain}:has(> :is(.math,table)){overflow-x:auto!important}.document-container>.view-content{overflow-x:auto;contain:content;padding:0;margin:0;height:100%}.scroll-highlight{position:absolute;width:100%;height:100%;pointer-events:none;z-index:1000;background-color:hsla(var(--color-accent-hsl),.25);opacity:0;padding:1em;inset:50%;translate:-50% -50%;border-radius:var(--radius-s)}</style><script defer="">async function loadIncludes(){if("file:"!=location.protocol){let e=document.querySelectorAll("include");for(let t=0;t<e.length;t++){let o=e[t],l=o.getAttribute("src");try{const e=await fetch(l);if(!e.ok){console.log("Could not include file: "+l),o?.remove();continue}let t=await e.text(),n=document.createRange().createContextualFragment(t),i=Array.from(n.children);for(let e of i)e.classList.add("hide"),e.style.transition="opacity 0.5s ease-in-out",setTimeout((()=>{e.classList.remove("hide")}),10);o.before(n),o.remove(),console.log("Included file: "+l)}catch(e){o?.remove(),console.log("Could not include file: "+l,e);continue}}}else{if(document.querySelectorAll("include").length>0){var e=document.createElement("div");e.id="error",e.textContent="Web server exports must be hosted on an http / web server to be viewed correctly.",e.style.position="fixed",e.style.top="50%",e.style.left="50%",e.style.transform="translate(-50%, -50%)",e.style.fontSize="1.5em",e.style.fontWeight="bold",e.style.textAlign="center",document.body.appendChild(e),document.querySelector(".document-container")?.classList.remove("hide")}}}document.addEventListener("DOMContentLoaded",(()=>{loadIncludes()}));let isFileProtocol="file:"==location.protocol;function waitLoadScripts(e,t){let o=e.map((e=>document.getElementById(e+"-script"))),l=0;!function e(){let n=o[l];l++,n&&"true"!=n.getAttribute("loaded")||l<o.length&&e(),l<o.length?n.addEventListener("load",e):t()}()}</script><link rel="stylesheet" href="lib/styles/obsidian.css"><link rel="preload" href="lib/styles/other-plugins.css" as="style" onload="this.onload=null;this.rel='stylesheet'"><noscript><link rel="stylesheet" href="lib/styles/other-plugins.css"></noscript><link rel="stylesheet" href="lib/styles/theme.css"><link rel="preload" href="lib/styles/global-variable-styles.css" as="style" onload="this.onload=null;this.rel='stylesheet'"><noscript><link rel="stylesheet" href="lib/styles/global-variable-styles.css"></noscript><link rel="preload" href="lib/styles/supported-plugins.css" as="style" onload="this.onload=null;this.rel='stylesheet'"><noscript><link rel="stylesheet" href="lib/styles/supported-plugins.css"></noscript><link rel="preload" href="lib/styles/main-styles.css" as="style" onload="this.onload=null;this.rel='stylesheet'"><noscript><link rel="stylesheet" href="lib/styles/main-styles.css"></noscript></head><body class="publish css-settings-manager theme-light show-inline-title show-ribbon outliner-plugin-dnd custom-accent ribbon-default special-h6 float-center"><script defer="">let theme=localStorage.getItem("theme")||(window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light");"dark"==theme?(document.body.classList.add("theme-dark"),document.body.classList.remove("theme-light")):(document.body.classList.add("theme-light"),document.body.classList.remove("theme-dark")),window.innerWidth<480?document.body.classList.add("is-phone"):window.innerWidth<768?document.body.classList.add("is-tablet"):window.innerWidth<1024?document.body.classList.add("is-small-screen"):document.body.classList.add("is-large-screen")</script><div class="webpage-container workspace"><div class="sidebar-left sidebar"><div class="sidebar-handle"></div><div class="sidebar-topbar"><div class="topbar-content"><label class="theme-toggle-container" for="theme_toggle"><input class="theme-toggle-input" type="checkbox" id="theme_toggle"><div class="toggle-background"></div></label></div><div class="clickable-icon sidebar-collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" class="svg-icon"><path d="M21 3H3C1.89543 3 1 3.89543 1 5V19C1 20.1046 1.89543 21 3 21H21C22.1046 21 23 20.1046 23 19V5C23 3.89543 22.1046 3 21 3Z"></path><path d="M10 4V20"></path><path d="M4 7H7"></path><path d="M4 10H7"></path><path d="M4 13H7"></path></svg></div></div><div class="sidebar-content"><div class="search-input-container"><input enterkeyhint="search" type="search" spellcheck="false" placeholder="Search..."><div class="search-input-clear-button" aria-label="Clear search"></div></div><include src="lib/html/file-tree.html"></include></div><script defer="">let ls = document.querySelector(".sidebar-left"); ls.classList.add("is-collapsed"); if (window.innerWidth > 768) ls.classList.remove("is-collapsed"); ls.style.setProperty("--sidebar-width", localStorage.getItem("sidebar-left-width"));</script></div><div class="document-container markdown-reading-view hide"><div class="markdown-preview-view markdown-rendered allow-fold-headings allow-fold-lists is-readable-line-width"><style id="MJX-CHTML-styles">mjx-munder{display:inline-block;text-align:left}mjx-over{text-align:left}mjx-munder:not([limits=false]){display:inline-table}mjx-munder>mjx-row{text-align:left}mjx-under{padding-bottom:.1em}mjx-msub{display:inline-block;text-align:left}mjx-c.mjx-c1D436.TEX-I::before{padding:.705em .76em .022em 0;content:"C"}mjx-c.mjx-c3D::before{padding:.583em .778em .082em 0;content:"="}mjx-c.mjx-c2211.TEX-S2::before{padding:.95em 1.444em .45em 0;content:"∑"}mjx-c.mjx-c1D45D.TEX-I::before{padding:.442em .503em .194em 0;content:"p"}mjx-c.mjx-c1D461.TEX-I::before{padding:.626em .361em .011em 0;content:"t"}mjx-mtext{display:inline-block;text-align:left}mjx-container[jax=CHTML]{line-height:0}mjx-container [space="1"]{margin-left:.111em}mjx-container [space="2"]{margin-left:.167em}mjx-container [space="3"]{margin-left:.222em}mjx-container [space="4"]{margin-left:.278em}mjx-container [space="5"]{margin-left:.333em}mjx-container [rspace="1"]{margin-right:.111em}mjx-container [rspace="2"]{margin-right:.167em}mjx-container [rspace="3"]{margin-right:.222em}mjx-container [rspace="4"]{margin-right:.278em}mjx-container [rspace="5"]{margin-right:.333em}mjx-container [size="s"]{font-size:70.7%}mjx-container [size=ss]{font-size:50%}mjx-container [size=Tn]{font-size:60%}mjx-container [size=sm]{font-size:85%}mjx-container [size=lg]{font-size:120%}mjx-container [size=Lg]{font-size:144%}mjx-container [size=LG]{font-size:173%}mjx-container [size=hg]{font-size:207%}mjx-container [size=HG]{font-size:249%}mjx-container [width=full]{width:100%}mjx-box{display:inline-block}mjx-block{display:block}mjx-itable{display:inline-table}mjx-row{display:table-row}mjx-row>*{display:table-cell}mjx-mtext{display:inline-block}mjx-mstyle{display:inline-block}mjx-merror{display:inline-block;color:red;background-color:#ff0}mjx-mphantom{visibility:hidden}mjx-assistive-mml{top:0;left:0;clip:rect(1px,1px,1px,1px);user-select:none;position:absolute!important;padding:1px 0 0!important;border:0!important;display:block!important;width:auto!important;overflow:hidden!important}mjx-assistive-mml[display=block]{width:100%!important}mjx-math{display:inline-block;text-align:left;line-height:0;text-indent:0;font-style:normal;font-weight:400;font-size:100%;font-size-adjust:none;letter-spacing:normal;border-collapse:collapse;overflow-wrap:normal;word-spacing:normal;white-space:nowrap;direction:ltr;padding:1px 0}mjx-container[jax=CHTML][display=true]{display:block;text-align:center;margin:1em 0}mjx-container[jax=CHTML][display=true][width=full]{display:flex}mjx-container[jax=CHTML][display=true] mjx-math{padding:0}mjx-container[jax=CHTML][justify=left]{text-align:left}mjx-container[jax=CHTML][justify=right]{text-align:right}mjx-msup{display:inline-block;text-align:left}mjx-mi{display:inline-block;text-align:left}mjx-c{display:inline-block}mjx-utext{display:inline-block;padding:.75em 0 .2em}mjx-texatom{display:inline-block;text-align:left}mjx-mo{display:inline-block;text-align:left}mjx-stretchy-h{display:inline-table;width:100%}mjx-stretchy-h>*{display:table-cell;width:0}mjx-stretchy-h>*>mjx-c{display:inline-block;transform:scaleX(1)}mjx-stretchy-h>*>mjx-c::before{display:inline-block;width:initial}mjx-stretchy-h>mjx-ext{overflow:clip visible;width:100%}mjx-stretchy-h>mjx-ext>mjx-c::before{transform:scaleX(500)}mjx-stretchy-h>mjx-ext>mjx-c{width:0}mjx-stretchy-h>mjx-beg>mjx-c{margin-right:-.1em}mjx-stretchy-h>mjx-end>mjx-c{margin-left:-.1em}mjx-stretchy-v{display:inline-block}mjx-stretchy-v>*{display:block}mjx-stretchy-v>mjx-beg{height:0}mjx-stretchy-v>mjx-end>mjx-c{display:block}mjx-stretchy-v>*>mjx-c{transform:scaleY(1);transform-origin:left center;overflow:hidden}mjx-stretchy-v>mjx-ext{display:block;height:100%;box-sizing:border-box;border:0 solid transparent;overflow:visible clip}mjx-stretchy-v>mjx-ext>mjx-c::before{width:initial;box-sizing:border-box}mjx-stretchy-v>mjx-ext>mjx-c{transform:scaleY(500) translateY(.075em);overflow:visible}mjx-mark{display:inline-block;height:0}mjx-c::before{display:block;width:0}.MJX-TEX{font-family:MJXZERO,MJXTEX}.TEX-B{font-family:MJXZERO,MJXTEX-B}.TEX-I{font-family:MJXZERO,MJXTEX-I}.TEX-MI{font-family:MJXZERO,MJXTEX-MI}.TEX-BI{font-family:MJXZERO,MJXTEX-BI}.TEX-S1{font-family:MJXZERO,MJXTEX-S1}.TEX-S2{font-family:MJXZERO,MJXTEX-S2}.TEX-S3{font-family:MJXZERO,MJXTEX-S3}.TEX-S4{font-family:MJXZERO,MJXTEX-S4}.TEX-A{font-family:MJXZERO,MJXTEX-A}.TEX-C{font-family:MJXZERO,MJXTEX-C}.TEX-CB{font-family:MJXZERO,MJXTEX-CB}.TEX-FR{font-family:MJXZERO,MJXTEX-FR}.TEX-FRB{font-family:MJXZERO,MJXTEX-FRB}.TEX-SS{font-family:MJXZERO,MJXTEX-SS}.TEX-SSB{font-family:MJXZERO,MJXTEX-SSB}.TEX-SSI{font-family:MJXZERO,MJXTEX-SSI}.TEX-SC{font-family:MJXZERO,MJXTEX-SC}.TEX-T{font-family:MJXZERO,MJXTEX-T}.TEX-V{font-family:MJXZERO,MJXTEX-V}.TEX-VB{font-family:MJXZERO,MJXTEX-VB}mjx-stretchy-h mjx-c,mjx-stretchy-v mjx-c{font-family:MJXZERO,MJXTEX-S1,MJXTEX-S4,MJXTEX,MJXTEX-A!important}@font-face{font-family:MJXZERO;src:url("lib/fonts/mathjax_zero.woff") format("woff")}@font-face{font-family:MJXTEX;src:url("lib/fonts/mathjax_main-regular.woff") format("woff")}@font-face{font-family:MJXTEX-B;src:url("lib/fonts/mathjax_main-bold.woff") format("woff")}@font-face{font-family:MJXTEX-I;src:url("lib/fonts/mathjax_math-italic.woff") format("woff")}@font-face{font-family:MJXTEX-MI;src:url("lib/fonts/mathjax_main-italic.woff") format("woff")}@font-face{font-family:MJXTEX-BI;src:url("lib/fonts/mathjax_math-bolditalic.woff") format("woff")}@font-face{font-family:MJXTEX-S1;src:url("lib/fonts/mathjax_size1-regular.woff") format("woff")}@font-face{font-family:MJXTEX-S2;src:url("lib/fonts/mathjax_size2-regular.woff") format("woff")}@font-face{font-family:MJXTEX-S3;src:url("lib/fonts/mathjax_size3-regular.woff") format("woff")}@font-face{font-family:MJXTEX-S4;src:url("lib/fonts/mathjax_size4-regular.woff") format("woff")}@font-face{font-family:MJXTEX-A;src:url("lib/fonts/mathjax_ams-regular.woff") format("woff")}@font-face{font-family:MJXTEX-C;src:url("lib/fonts/mathjax_calligraphic-regular.woff") format("woff")}@font-face{font-family:MJXTEX-CB;src:url("lib/fonts/mathjax_calligraphic-bold.woff") format("woff")}@font-face{font-family:MJXTEX-FR;src:url("lib/fonts/mathjax_fraktur-regular.woff") format("woff")}@font-face{font-family:MJXTEX-FRB;src:url("lib/fonts/mathjax_fraktur-bold.woff") format("woff")}@font-face{font-family:MJXTEX-SS;src:url("lib/fonts/mathjax_sansserif-regular.woff") format("woff")}@font-face{font-family:MJXTEX-SSB;src:url("lib/fonts/mathjax_sansserif-bold.woff") format("woff")}@font-face{font-family:MJXTEX-SSI;src:url("lib/fonts/mathjax_sansserif-italic.woff") format("woff")}@font-face{font-family:MJXTEX-SC;src:url("lib/fonts/mathjax_script-regular.woff") format("woff")}@font-face{font-family:MJXTEX-T;src:url("lib/fonts/mathjax_typewriter-regular.woff") format("woff")}@font-face{font-family:MJXTEX-V;src:url("lib/fonts/mathjax_vector-regular.woff") format("woff")}@font-face{font-family:MJXTEX-VB;src:url("lib/fonts/mathjax_vector-bold.woff") format("woff")}mjx-c.mjx-c1D447.TEX-I::before{padding:.677em .704em 0 0;content:"T"}mjx-c.mjx-c1D450.TEX-I::before{padding:.442em .433em .011em 0;content:"c"}mjx-c.mjx-c2C::before{padding:.121em .278em .194em 0;content:","}mjx-c.mjx-c2E::before{padding:.12em .278em 0 0;content:"."}</style><div class="markdown-preview-sizer markdown-preview-section"><h1 class="page-title heading inline-title" id="Baby steps with CNTK and FSharp"><p dir="auto">Baby steps with CNTK and FSharp</p></h1><div class="el-p"><p dir="auto"><a href="?query=tag:fsharp" class="tag" target="_blank" rel="noopener nofollow">#fsharp</a> <a href="?query=tag:fp" class="tag" target="_blank" rel="noopener nofollow">#fp</a> <a href="?query=tag:deep-learning" class="tag" target="_blank" rel="noopener nofollow">#deep-learning</a></p></div><div class="el-p"><p dir="auto">So what have I been up to lately? Obsessing over <a data-tooltip-position="top" aria-label="https://www.microsoft.com/en-us/cognitive-toolkit/" rel="noopener nofollow" class="external-link" href="https://www.microsoft.com/en-us/cognitive-toolkit/" target="_blank">CNTK, the Microsoft deep-learning library</a>. Specifically, the team released a <a data-tooltip-position="top" aria-label="https://docs.microsoft.com/en-us/cognitive-toolkit/cntk-library-managed-api" rel="noopener nofollow" class="external-link" href="https://docs.microsoft.com/en-us/cognitive-toolkit/cntk-library-managed-api" target="_blank">.NET API</a>, which got me interested in exploring how usable this would be from the F# scripting environment. I started a <a data-tooltip-position="top" aria-label="https://github.com/mathias-brandewinder/CNTK.FSharp" rel="noopener nofollow" class="external-link" href="https://github.com/mathias-brandewinder/CNTK.FSharp" target="_blank">repository to try out some ideas already</a>, but, before diving into that in later posts, I figure I could start by a simple introduction, to set some context.</p></div><div class="el-p"><p dir="auto">First, what problem does CNTK solve?</p></div><div class="el-p"><p dir="auto">Imagine that you are interested in predicting something, and that you have data available, both inputs you can observe (the <code>features</code>), and the values you are trying to predict (the <code>labels</code>). Imagine now that you have an idea of the type of relationship between the input and the output, something along the lines of:</p></div><div class="el-p"><p dir="auto"><code>labels ≈ function(features, parameters)</code>.</p></div><div class="el-p"><p dir="auto">To make this more concrete, that function could be quite complex, and involve multiple layers of input transformation into the final output (“deep learning”), or it could be quite simple, for instance a traditional linear regression, something along the lines of:</p></div><div class="el-p"><p dir="auto"><code>car price ≈ car years * coefficient1 + car engine size * coefficient2 + constant</code>.</p></div><div class="el-p"><p dir="auto">In this particular case, we have 2 features (<code>car years</code> and <code>car engine size</code>), 1 label (<code>car price</code>), and 3 parameters (<code>coefficient1</code>, <code>coefficient2</code> and <code>constant</code>) - and we would like to find “good” values for the 3 parameters so that the predicted value is in general close to the correct value.</p></div><div class="el-p"><p dir="auto">The purpose of CNTK is to:</p></div><div class="el-ul"><ul>
<li data-line="0" dir="auto">let you specify a function connecting input and output,</li>
<li data-line="1" dir="auto">let you specify how to read example data to learn from,</li>
<li data-line="2" dir="auto">learn good parameter values from the example data,</li>
<li data-line="3" dir="auto">let you learn parameters on CPU or GPU, for large datasets and complex functions.</li>
</ul></div><div class="el-p"><p dir="auto">With that in mind, let’s take a look at a very basic example, a simple linear regression. Using CNTK here is complete overkill, and not worth the overhead; I would not use it for something that simple. Our goal here is simply to illustrate the basics of how CNTK works, from F#. In future posts, we will look into scenarios where CNTK is actually useful. As a secondary goal, I want to discuss some of the aspects that make building a nice F# API on top of the current .NET one tricky.</p></div><div class="el-h2 heading-wrapper"><h2 data-heading="Loading CNTK into the F# scripting environment" dir="auto" class="heading" id="Loading_CNTK_into_the_F#_scripting_environment"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>Loading CNTK into the F# scripting environment</h2><div class="heading-children"><div class="el-p"><p dir="auto">First order of business: let’s load this thing into VS Code.</p></div><div class="el-p"><p dir="auto">CNTK has a few packages on Nuget, based on what environment you want to run on. In our case, we will focus on a <a data-tooltip-position="top" aria-label="https://www.nuget.org/packages/CNTK.CPUOnly/" rel="noopener nofollow" class="external-link" href="https://www.nuget.org/packages/CNTK.CPUOnly/" target="_blank">CPU-only scenario, using the CNTK.CPUOnly 2.3.1 package</a>.</p></div><div class="el-p"><p dir="auto">We assume that the <a data-tooltip-position="top" aria-label="https://marketplace.visualstudio.com/items?itemName=Ionide.Ionide-fsharp" rel="noopener nofollow" class="external-link" href="https://marketplace.visualstudio.com/items?itemName=Ionide.Ionide-fsharp" target="_blank">Ionide-fsharp</a> and <a data-tooltip-position="top" aria-label="https://marketplace.visualstudio.com/items?itemName=Ionide.Ionide-Paket" rel="noopener nofollow" class="external-link" href="https://marketplace.visualstudio.com/items?itemName=Ionide.Ionide-Paket" target="_blank">Ionide-Paket</a> extensions are installed in VS Code. Open the Folder where you want to work, and run the <code>Paket: Init</code> command (CTRL+SHIFT+P reveals the available commands). This will create a <code>paket.dependencies</code> file in the folder, where you can now specify what packages are needed, like this:</p></div><div class="el-pre"><pre><code data-line="0">framework:net46
source https://www.nuget.org/api/v2
nuget CNTK.CPUOnly
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">Run <code>Paket: Install</code> next, and let Paket do its magic, and download the required packages. Once the operation completes, you should see a new folder, <code>packages</code>, with the following structure:</p></div><div class="el-pre"><pre><code data-line="0">packages
  CNTK.CPUOnly
    lib
      net45
        x64
          Cntk.Core.Managed-2.3.1.dll
    support
      x64
        Debug
        Dependency
        Release
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">Let’s start creating the script we will be working with now, by adding an F# script file <code>CNTK.fsx</code> to our folder. Unfortunately, CNTK depends on a few native libraries to run properly. As a result, the setup is a bit more involved than the usual <code>#r "path/to/library.dll</code>. We’ll follow <a data-tooltip-position="top" aria-label="https://twitter.com/cdrnet" rel="noopener nofollow" class="external-link" href="https://twitter.com/cdrnet" target="_blank">@cdrnet</a> <a data-tooltip-position="top" aria-label="http://christoph.ruegg.name/blog/loading-native-dlls-in-fsharp-interactive.html" rel="noopener nofollow" class="external-link" href="http://christoph.ruegg.name/blog/loading-native-dlls-in-fsharp-interactive.html" target="_blank">approach to load native libraries described here</a>, and add to the <code>PATH</code> every folder that contains the dlls we need, so <code>Cntk.Core.Managed-2.3.1.dll</code> can find them:</p></div><div class="el-blockquote"><blockquote dir="auto">
<p>Note: I put the <a data-tooltip-position="top" aria-label="https://gist.github.com/mathias-brandewinder/d48abe4a571c53a4a70c709c3121a566" rel="noopener nofollow" class="external-link" href="https://gist.github.com/mathias-brandewinder/d48abe4a571c53a4a70c709c3121a566" target="_blank">full code used in the post on a gist here</a></p>
</blockquote></div><div class="el-pre"><pre><code data-line="0">open System
open System.IO

Environment.SetEnvironmentVariable("Path",
    Environment.GetEnvironmentVariable("Path") + ";" + __SOURCE_DIRECTORY__)

let dependencies = [
        "./packages/CNTK.CPUOnly/lib/net45/x64/"
        "./packages/CNTK.CPUOnly/support/x64/Dependency/"
        "./packages/CNTK.CPUOnly/support/x64/Dependency/Release/"
        "./packages/CNTK.CPUOnly/support/x64/Release/"    
    ]

dependencies 
|&gt; Seq.iter (fun dep -&gt; 
    let path = Path.Combine(__SOURCE_DIRECTORY__,dep)
    Environment.SetEnvironmentVariable("Path",
        Environment.GetEnvironmentVariable("Path") + ";" + path)
    )    

#I "./packages/CNTK.CPUOnly/lib/net45/x64/"
#I "./packages/CNTK.CPUOnly/support/x64/Dependency/"
#I "./packages/CNTK.CPUOnly/support/x64/Dependency/Release/"
#I "./packages/CNTK.CPUOnly/support/x64/Release/"

#r "./packages/CNTK.CPUOnly/lib/net45/x64/Cntk.Core.Managed-2.3.1.dll"
open CNTK
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div></div></div><div class="el-h2 heading-wrapper"><h2 data-heading="Creating a Function" dir="auto" class="heading" id="Creating_a_Function"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>Creating a Function</h2><div class="heading-children"><div class="el-p"><p dir="auto">We can now start using CNTK in our script. Let’s build a function that takes 2 floats as input, and returns a float as an output, multiplying each of the inputs by a parameter.</p></div><div class="el-p"><p dir="auto">A core element in CNTK is the <code>NDShape</code>, for n-dimensional shape. Think of an <code>NDShape</code> as an n-dimensional array. A vector of size 5 would be an NDShape of dimension [ 5 ] (rank 1), a 12x18 image a NDShape [ 12; 18 ] (rank 2), a 10 x 10 RGB image a NDShape [ 10; 10; 3 channels ] (rank 3), and so on. In our case, the input is an array of size 2, and the output an array of size 1:</p></div><div class="el-pre"><pre><code data-line="0">let inputDim = 2
let outputDim = 1
let input = Variable.InputVariable(NDShape.CreateNDShape [inputDim], DataType.Double, "input")
let output = Variable.InputVariable(NDShape.CreateNDShape [outputDim], DataType.Double, "output")
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">Which produces the following output:</p></div><div class="el-pre"><pre><code data-line="0">val inputDim : int = 2
val outputDim : int = 1
val input = Variable
val output = Variable
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">Note how the numeric type of the <code>Variable</code>, <code>DataType.Double</code>, is passed in as a argument, and not generic. Note also how the numeric types are aligned with the C# convention; that is, a <code>DataType.Double</code> is an F# <code>float</code>, and a <code>DataType.Float</code> is an F# <code>single</code>.</p></div><div class="el-p"><p dir="auto">We can ask a <code>Variable</code> about its shape, for instance <code>input.Shape</code>:</p></div><div class="el-pre"><pre><code data-line="0">val it : NDShape = CNTK.NDShape { Dimensions = seq [2]; (* more stuff *) Rank = 1; }
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">Let’s create our <code>Function</code> now:</p></div><div class="el-pre"><pre><code data-line="0">let device = DeviceDescriptor.CPUDevice

let predictor =
    let dim = input.Shape.[0]
    let weights = new Parameter(NDShape.CreateNDShape [dim], DataType.Double, 0.0, device, "weights")
    // create an intermediate Function
    let product = CNTKLib.TransposeTimes(input, weights)    
    let constant = new Parameter(NDShape.CreateNDShape [ outputDim ], DataType.Double, 0.0, device, "constant") 
    CNTKLib.Plus(new Variable(product), constant)
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-pre"><pre><code data-line="0">val device : DeviceDescriptor
val predictor : Function
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">A couple of comments here. Our <code>predictor</code> creates a named <code>Parameter</code> weights of dimension and type matching the input <code>Variable</code>, with values initialized at <code>0.0</code>. We multiply the two shapes together, by calling <code>CNTKLib.TransposeTimes</code>, computing <code>x1 * w1 + x2 * w2</code>, which returns a <code>Function</code>. We then create another <code>Parameter</code> for our constant, and sum them up, using <code>CNTKLib.Plus</code>.</p></div><div class="el-p"><p dir="auto">Note how we have to explicitly convert <code>product</code> into a <code>Variable</code> in the final step, using <code>new Variable(product)</code>. <code>CNTKLib.Plus</code> (and the other functions built in <code>CNTKLib</code>) expects 2 <code>Variable</code> arguments. Unfortunately, a <code>Function</code> is not a <code>Variable</code>, and they do not derive from a common class or interface. The .NET API supports implicit conversion between these 2 types, which works well in C#, where you could just sum these up directly, like this: <code>CNTKLib.Plus(product, constant)</code>. F# doesn’t support implicit conversion, and as a result, this requires an annoying amount of explicit manual conversion to combine operations together.</p></div><div class="el-p"><p dir="auto">Note also how we passed in <code>device</code>, a <code>DeviceDescriptor</code>, to the <code>Parameter</code> constructor. A CNTK <code>Function</code> is intended to run on a device, which must be specified. In this case, we could have omitted the device, in what case it would have picked up by default <code>CPU</code>.</p></div></div></div><div class="el-h2 heading-wrapper"><h2 data-heading="Working with CNTK Functions" dir="auto" class="heading" id="Working_with_CNTK_Functions"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>Working with CNTK Functions</h2><div class="heading-children"><div class="el-p"><p dir="auto">Now that we have a <code>Function</code> - what can we do with it?</p></div><div class="el-p"><p dir="auto">Unsuprisingly, we can pass input to a function, and compute the resulting value. We will do that next. However, before doing that, it’s perhaps useful to put things in perspective, to understand why this isn’t as straightforward as you might expect from something named a function. Once an F# function has been instantiated, its whole purpose is to transform an input value into an output value. The intent of a CNTK <code>Function</code> is subtly different: the objective here is to take a function, and modify its <code>Parameters</code> so that when passed in some input, the output it produces is close to some desired output, the <code>Labels</code>. In other words, we want a <code>Function</code> to be “trainable”: we want to be able to pass it known input/output pairs, and adjust the function parameters to fit the data better.</p></div><div class="el-p"><p dir="auto">With that said, let’s evaluate our <code>predictor</code> function. To do that, we will need to do 3 things:</p></div><div class="el-ul"><ul>
<li data-line="0" dir="auto">Supply values to fill in the “input” placeholder shape,</li>
<li data-line="1" dir="auto">Specify what values we want to observe - we might be interested in the output, but also the weights, for instance,</li>
<li data-line="2" dir="auto">Specify what device we want the function to run on.</li>
</ul></div><div class="el-p"><p dir="auto">Let’s do that:</p></div><div class="el-pre"><pre><code data-line="0">open System.Collections.Generic

let inputValue = Value.CreateBatch(NDShape.CreateNDShape [inputDim], [| 3.0; 5.0 |], device)
let inputMap = 
    let map = Dictionary&lt;Variable,Value&gt;()
    map.Add(input, inputValue)
    map

let predictedOutput = predictor.Output
let weights = 
    predictor.Parameters () 
    |&gt; Seq.find (fun p -&gt; p.Name = "weights")
let constant = 
    predictor.Parameters () 
    |&gt; Seq.find (fun p -&gt; p.Name = "constant")
let outputMap =
    let map = Dictionary&lt;Variable,Value&gt;()
    map.Add(predictedOutput, null)
    map.Add(weights, null)
    map.Add(constant, null)
    map

predictor.Evaluate(inputMap,outputMap,device)
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">To evaluate a <code>Function</code>, we pass it the input we care about, a <code>Dictionary&lt;Variable,Value&gt;</code>, which we fill in with <code>input</code>, the <code>Variable</code> we defined earlier. We provide (completely arbitrarily) a value of <code>[3.0;5.0]</code> as an input value. In a similar fashion, we specify what we want to observe: the predicted value, <code>predictor.Output</code>, as well as the 2 named parameters we created, “weights” and “constant”, which we also retrieve from the <code>Function</code> itself. In this case, we set the <code>Value</code> to <code>null</code>, because we have no input to supply. Finally, we run <code>predictor.Evaluate</code>, which will take the <code>inputMap</code> and fill in the missing values in the <code>outputMap</code>.</p></div><div class="el-p"><p dir="auto">We can now review the outputs:</p></div><div class="el-pre"><pre><code data-line="0">let currentPrediction = 
    outputMap.[predictedOutput].GetDenseData&lt;float&gt;(predictedOutput) 
    |&gt; Seq.map (fun x -&gt; x |&gt; Seq.toArray)
    |&gt; Seq.toArray

let currentWeights = 
    outputMap.[weights].GetDenseData&lt;float&gt;(weights) 
    |&gt; Seq.map (fun x -&gt; x |&gt; Seq.toArray)
    |&gt; Seq.toArray

let currentConstant = 
    outputMap.[constant].GetDenseData&lt;float&gt;(constant) 
    |&gt; Seq.map (fun x -&gt; x |&gt; Seq.toArray)
    |&gt; Seq.toArray
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">This is not pretty, but… we have values.</p></div><div class="el-pre"><pre><code data-line="0">val currentPrediction : float [] [] = [| [| 0.0 |] |]
val currentWeights : float [] [] = [| [| 0.0; 0.0 |] |] 
val currentConstant : float [] [] = [| [| 0.0 |] |] 
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">The values we get back are pretty unexciting, but at least they are what we would expect to see. Given that both weights and constant were initialized at 0.0, the function should produce a <code>currentPrediction</code> of <code>0.0 * 3.0 + 0.0 * 5.0 + 0.0</code>, which is indeed <code>0.0</code>.</p></div><div class="el-p"><p dir="auto">Two quick notes here. First, because a value could be of any <code>DataType</code>, we have to manually specify a type when retrieving the values, as in <code>GetDenseData&lt;float&gt;</code>. Then, this is a very stateful model: when we fill in values for the input in the <code>inputMap</code>, we pass in the <code>input</code> instance we initially created to construct the <code>Function</code>. In a similar fashion, we are retrieving values from the instances we passed into the <code>outputMap</code>.</p></div></div></div><div class="el-h2 heading-wrapper"><h2 data-heading="Training a model" dir="auto" class="heading" id="Training_a_model"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>Training a model</h2><div class="heading-children"><div class="el-p"><p dir="auto">This was pretty painful. So what is our reward for that pain?</p></div><div class="el-p"><p dir="auto">As I stated earlier, one defining feature of a <code>Function</code> is that it can be trained. What we mean by that is the following: we can take a <code>Function</code>, supply it batches of input and desired output pairs, and progressively adjust the internal <code>Parameter</code>(s) of the <code>Function</code> so that the values computed by the <code>Function</code> become close(r) to the desired output.</p></div><div class="el-p"><p dir="auto">Let’s start with a simple illustration. Suppose for a minute that, for our input <code>[ 3.0; 5.0 ]</code>, we expected a result of <code>10.0</code>. Currently, our weights and constant are set to <code>0.0</code>. By modifying these 3 values, we should be able to tune our <code>predictor</code> to get an answer of <code>10.0</code>.</p></div><div class="el-p"><p dir="auto">This is, of course, a silly example. There are many ways I could change the parameters to produce <code>10.0</code> - I could set the constant to <code>10.0</code>, or the second weight to <code>2.0</code>, or infinitely many other combinations. To get something meaningful, I would need many different input/output pairs. However, we’ll start with this, strictly to illustrate the mechanics involved.</p></div><div class="el-p"><p dir="auto">Training a <code>Function</code> involves 3 elements:</p></div><div class="el-ul"><ul>
<li data-line="0" dir="auto">Supplying a batch of input / output pairs (features and labels),</li>
<li data-line="1" dir="auto">Defining a measure of fit, that is, how to measure if a value is close to the desired value,</li>
<li data-line="2" dir="auto">Specifying how parameters should be adjusted to improve the function.</li>
</ul></div><div class="el-pre"><pre><code data-line="0">let batchInputValue = Value.CreateBatch(NDShape.CreateNDShape [inputDim], [| 3.0; 5.0 |], device)
let batchOutputValue = Value.CreateBatch(NDShape.CreateNDShape [outputDim], [| 10.0 |], device)

let batch =
    [
        input,batchInputValue
        output,batchOutputValue
    ]
    |&gt; dict

let loss = CNTKLib.SquaredError(new Variable(predictor), output, "loss")
let evaluation = CNTKLib.SquaredError(new Variable(predictor), output, "evaluation")

let learningRatePerSample = new TrainingParameterScheduleDouble(0.01, uint32 1)
let learners = 
    ResizeArray&lt;Learner&gt;(
        [
            Learner.SGDLearner(predictor.Parameters(), learningRatePerSample)
        ]
        )

let trainer = Trainer.CreateTrainer(predictor, loss, evaluation, learners)

for i in 0 .. 10 do
    let _ = trainer.TrainMinibatch(batch, true, device)
    trainer.PreviousMinibatchLossAverage () |&gt; printfn "Loss: %f"
    trainer.PreviousMinibatchEvaluationAverage () |&gt; printfn "Eval: %f"
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">First, we create a batch of input/output values (<code>[ 3.0; 5.0 ]</code> and <code>[ 10.0 ]</code>), and link them to the <code>input</code> and <code>output</code> <code>Variable</code>(s) we created. Then we define what measure we want to use to determine if a prediction is close or not from the target value. In this case, we use the built-in <code>CNTKLib.SquaredError</code>, which computes the square difference between the predicted value (<code>new Variable(predictor)</code>) and the target value (<code>output</code>). For instance, with the initial weights and constant, the predicted value will be <code>0.0</code>, and we specified that the desired value was <code>10.0</code>, so the <code>loss</code> function will evaluate to <code>(0.0 - 10.0)^2</code>, that is, <code>100.0</code> - and a perfect prediction of <code>10.0</code> would result in a loss of <code>0.0</code>. Finally, without going into much detail, we specify in learners which strategy to apply when updating the function parameters. In this case, we use the built-in Stochastic Gradient Descent (SGD) strategy, with a learning rate of <code>0.01</code> (how aggressively to update the parameters) and a batch size of 1, using only one input/output pair at a time when performing adjustments.</p></div><div class="el-p"><p dir="auto">We feed all that into a <code>Trainer</code>, and perform 10 updates (<code>trainer.TrainMinibatch</code>), using the same example input/output each time, and writing out the current value of the loss function:</p></div><div class="el-pre"><pre><code data-line="0">Loss: 100.000000
Eval: 100.000000
Loss: 9.000000
Eval: 9.000000
// omitted intermediate results for brevity 
Loss: 0.000000
Eval: 0.000000
Loss: 0.000000
Eval: 0.000000
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">As you can observe, the prediction error decreases rapidly, from <code>100.0</code> initially (as expected), to basically <code>0.0</code> after only 10 steps.</p></div><div class="el-p"><p dir="auto">Let’s make this a bit more interesting, by feeding different examples to the model:</p></div><div class="el-pre"><pre><code data-line="0">let realModel (features:float[]) =
    3.0 * features.[0] - 2.0 * features.[1] + 5.0

let rng = Random(123456)
let batch () =        
    let batchSize = 32        
    let features = [| rng.NextDouble(); rng.NextDouble() |]
    let labels = [| realModel features |]
    let inputValues = Value.CreateBatch(NDShape.CreateNDShape [inputDim], features, device)
    let outputValues = Value.CreateBatch(NDShape.CreateNDShape [outputDim], labels, device)
    [
        input,inputValues
        output,outputValues
    ]
    |&gt; dict
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">Here we simply create a “true” function, <code>realModel</code>, which we use to generate synthetic data. We then modify our previous example, to feed 1,000 different examples for training:</p></div><div class="el-pre"><pre><code data-line="0">#time "on"

for _ in 1 .. 1000 do
    
    let example = batch ()
    trainer.TrainMinibatch(example,true,device) |&gt; ignore
    trainer.PreviousMinibatchLossAverage () |&gt; printfn "Loss: %f"
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">On my machine, extracting the weights and constant from the <code>Function</code> after training yields <code>3.0019</code>, <code>-1.9978</code> and <code>4.9975</code> - pretty close to the correct values of <code>3.0</code>, <code>-2.0</code> and <code>5.0</code> that we used in <code>realModel</code>.</p></div><div class="el-blockquote"><blockquote dir="auto">
<p>Note: I put the <a data-tooltip-position="top" aria-label="https://gist.github.com/mathias-brandewinder/d48abe4a571c53a4a70c709c3121a566" rel="noopener nofollow" class="external-link" href="https://gist.github.com/mathias-brandewinder/d48abe4a571c53a4a70c709c3121a566" target="_blank">full code used in the post on a gist here</a></p>
</blockquote></div></div></div><div class="el-h2 heading-wrapper"><h2 data-heading="Parting thoughts" dir="auto" class="heading" id="Parting_thoughts"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>Parting thoughts</h2><div class="heading-children"><div class="el-p"><p dir="auto">First, I want to re-iterate that the example we went through is not showcasing a good example of where and how to use CNTK. It is intended primarily as an illustration of CNTK’s building blocks and how they work together. For a trivial linear regression example like this one (shallow learning, if you will), you would be better served with a standard library such as <a data-tooltip-position="top" aria-label="http://accord-framework.net/" rel="noopener nofollow" class="external-link" href="http://accord-framework.net/" target="_blank">Accord.NET</a>. CNTK becomes interesting if you have a deeper, more complex model, and a larger dataset - we’ll explore this in later posts.</p></div><div class="el-blockquote"><blockquote dir="auto">
<p>As a side-note, my initial intent was to use real batches for the final example, passing in multiple examples at once, but for reasons I couldn’t figure out yet, the code kept crashing.</p>
</blockquote></div><div class="el-p"><p dir="auto">My second goal was to explore the design of the current .NET API, as a preliminary step before trying to build an F#-scripting friendly layer on top of it.</p></div><div class="el-p"><p dir="auto">In its current state, the CNTK .NET library is fairly low-level, and rather unpleasant to work with from F#. Ideally, one would like to be able to create re-usable blocks and compose them easily, along the lines of the Keras model, using a DSL to, for instance, define a network by stacking standard transformation layers on top of each other.</p></div><div class="el-p"><p dir="auto">Such a DSL seems quite possible to achieve in F#, but requires taking into account a few design considerations. First, the choice to use implicit conversion between <code>Variable</code> and <code>Function</code> makes composition of functions in F# painful. This choice is reasonable for C#, but requires re-wrapping every <code>Function</code> into a <code>Variable</code> to string operations together on the F# side.</p></div><div class="el-p"><p dir="auto">One aspect I am not a fan of in the library is how the <code>DeviceDescriptor</code> leaks all the way down. With the current model, I could create 2 parameters, one on CPU, one on GPU, and combine them together, which doesn’t make a lot of sense. In an ideal world, I would like to define a <code>Function</code> independently of any device, and only then decide whether I want to train that model on a CPU or a GPU.</p></div><div class="el-p"><p dir="auto">Finally, the fact that a <code>Variable</code> or a <code>Function</code> cannot be named after it was instantiated, as far as I can tell, introduces complications in composing blocks together. If naming was separate from instantiation, we could create a function like <code>named : string -&gt; Function -&gt; Function</code>, which could be inserted anywhere.</p></div><div class="el-p"><p dir="auto">I haven’t had much time yet to dig into the data readers; so far, most of my efforts have gone into exploring possible directions to address the questions above. If you are interested, the <a data-tooltip-position="top" aria-label="https://github.com/mathias-brandewinder/CNTK.FSharp" rel="noopener nofollow" class="external-link" href="https://github.com/mathias-brandewinder/CNTK.FSharp" target="_blank">master branch of my repository</a> contains working, straight conversions of the <a data-tooltip-position="top" aria-label="https://github.com/Microsoft/CNTK/tree/master/Examples/TrainingCSharp/Common" rel="noopener nofollow" class="external-link" href="https://github.com/Microsoft/CNTK/tree/master/Examples/TrainingCSharp/Common" target="_blank">C# examples published by the CNTK team</a>; the results of my explorations can be found in the 3 branches <a data-tooltip-position="top" aria-label="https://github.com/mathias-brandewinder/CNTK.FSharp/tree/experiment-varorfun" rel="noopener nofollow" class="external-link" href="https://github.com/mathias-brandewinder/CNTK.FSharp/tree/experiment-varorfun" target="_blank">experiment-varorfun</a>, <a data-tooltip-position="top" aria-label="https://github.com/mathias-brandewinder/CNTK.FSharp/tree/experiment-interpreter" rel="noopener nofollow" class="external-link" href="https://github.com/mathias-brandewinder/CNTK.FSharp/tree/experiment-interpreter" target="_blank">experiment-interpreter</a> and <a data-tooltip-position="top" aria-label="https://github.com/mathias-brandewinder/CNTK.FSharp/tree/experiment-stacking" rel="noopener nofollow" class="external-link" href="https://github.com/mathias-brandewinder/CNTK.FSharp/tree/experiment-stacking" target="_blank">experiment-stacking</a>.</p></div><div class="el-p"><p dir="auto">I hope you found something of interest in this post! If you have feedback or suggestions, I would be quite interested to hear about them :) In the meanwhile, I will keep exploring - expect more on the topic in the near future!</p></div><div class="mod-footer mod-ui"></div></div></div></div></div></div><div class="sidebar-right sidebar"><div class="sidebar-handle"></div><div class="sidebar-topbar"><div class="topbar-content"></div><div class="clickable-icon sidebar-collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" class="svg-icon"><path d="M21 3H3C1.89543 3 1 3.89543 1 5V19C1 20.1046 1.89543 21 3 21H21C22.1046 21 23 20.1046 23 19V5C23 3.89543 22.1046 3 21 3Z"></path><path d="M10 4V20"></path><path d="M4 7H7"></path><path d="M4 10H7"></path><path d="M4 13H7"></path></svg></div></div><div class="sidebar-content"><div class="graph-view-wrapper"><div class="sidebar-section-header">Interactive Graph</div><div class="graph-view-placeholder">
		<div class="graph-view-container">
			<div class="graph-icon graph-expand" role="button" aria-label="Expand" data-tooltip-position="top"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon"><line x1="7" y1="17" x2="17" y2="7"></line><polyline points="7 7 17 7 17 17"></polyline></svg></div>
			<canvas id="graph-canvas" class="hide" width="512px" height="512px"></canvas>
		</div>
		</div></div><div class="tree-container mod-root nav-folder tree-item outline-tree" data-depth="0"><div class="tree-header"><span class="sidebar-section-header">Table Of Contents</span><button class="clickable-icon collapse-tree-button" aria-label="Collapse All"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></svg></button></div><div class="tree-scroll-area tree-item-children nav-folder-children"><div class="tree-item mod-tree-folder nav-folder mod-collapsible is-collapsed" style="display: none;"></div><div class="tree-item" data-depth="1"><a class="tree-link" href="computer-science/programming-language/fsharp/baby-steps-with-cntk-and-fsharp.html#Baby steps with CNTK and FSharp"><div class="tree-item-contents heading-link" heading-name="Baby steps with CNTK and FSharp"><span class="tree-item-title">Baby steps with CNTK and FSharp</span></div></a><div class="tree-item-children nav-folder-children"><div class="tree-item" data-depth="2"><a class="tree-link" href="computer-science/programming-language/fsharp/baby-steps-with-cntk-and-fsharp.html#Loading_CNTK_into_the_F#_scripting_environment"><div class="tree-item-contents heading-link" heading-name="Loading CNTK into the F# scripting environment"><span class="tree-item-title">Loading CNTK into the F# scripting environment</span></div></a><div class="tree-item-children nav-folder-children"></div></div><div class="tree-item" data-depth="2"><a class="tree-link" href="computer-science/programming-language/fsharp/baby-steps-with-cntk-and-fsharp.html#Creating_a_Function"><div class="tree-item-contents heading-link" heading-name="Creating a Function"><span class="tree-item-title">Creating a Function</span></div></a><div class="tree-item-children nav-folder-children"></div></div><div class="tree-item" data-depth="2"><a class="tree-link" href="computer-science/programming-language/fsharp/baby-steps-with-cntk-and-fsharp.html#Working_with_CNTK_Functions"><div class="tree-item-contents heading-link" heading-name="Working with CNTK Functions"><span class="tree-item-title">Working with CNTK Functions</span></div></a><div class="tree-item-children nav-folder-children"></div></div><div class="tree-item" data-depth="2"><a class="tree-link" href="computer-science/programming-language/fsharp/baby-steps-with-cntk-and-fsharp.html#Training_a_model"><div class="tree-item-contents heading-link" heading-name="Training a model"><span class="tree-item-title">Training a model</span></div></a><div class="tree-item-children nav-folder-children"></div></div><div class="tree-item" data-depth="2"><a class="tree-link" href="computer-science/programming-language/fsharp/baby-steps-with-cntk-and-fsharp.html#Parting_thoughts"><div class="tree-item-contents heading-link" heading-name="Parting thoughts"><span class="tree-item-title">Parting thoughts</span></div></a><div class="tree-item-children nav-folder-children"></div></div></div></div></div></div></div><script defer="">let rs = document.querySelector(".sidebar-right"); rs.classList.add("is-collapsed"); if (window.innerWidth > 768) rs.classList.remove("is-collapsed"); rs.style.setProperty("--sidebar-width", localStorage.getItem("sidebar-right-width"));</script></div></div></body></html>