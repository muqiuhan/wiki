<!DOCTYPE html> <html><head>
		<title>Signaling in WebRTC with Ably and Fable</title>
		<base href="../../../">
		<meta id="root-path" root-path="../../../">
		<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes, minimum-scale=1.0, maximum-scale=5.0">
		<meta charset="UTF-8">
		<meta name="description" content="韩暮秋的个人维基 - Signaling in WebRTC with Ably and Fable">
		<meta property="og:title" content="Signaling in WebRTC with Ably and Fable">
		<meta property="og:description" content="韩暮秋的个人维基 - Signaling in WebRTC with Ably and Fable">
		<meta property="og:type" content="website">
		<meta property="og:url" content="https://muqiuhan.github.io/wiki/computer-science/programming-language/fsharp/signaling-in-webrtc-with-ably-and-fable.html">
		<meta property="og:image" content="https://mnie.github.com/img/2021_01_05_webrtc_ably/initialize.png">
		<meta property="og:site_name" content="韩暮秋的个人维基">
		<meta name="author" content="韩暮秋"><link rel="alternate" type="application/rss+xml" title="RSS Feed" href="https://muqiuhan.github.io/wiki/lib/rss.xml"><script async="" id="webpage-script" src="lib/scripts/webpage.js" onload="this.onload=null;this.setAttribute(&quot;loaded&quot;, &quot;true&quot;)"></script><script type="module" async="" id="graph-view-script" src="lib/scripts/graph-view.js"></script><script async="" id="graph-wasm-script" src="lib/scripts/graph-wasm.js" onload="this.onload=null;this.setAttribute(&quot;loaded&quot;, &quot;true&quot;)"></script><script async="" id="graph-render-worker-script" src="lib/scripts/graph-render-worker.js" onload="this.onload=null;this.setAttribute(&quot;loaded&quot;, &quot;true&quot;)"></script><script async="" id="tinycolor-script" src="lib/scripts/tinycolor.js" onload="this.onload=null;this.setAttribute(&quot;loaded&quot;, &quot;true&quot;)"></script><script async="" id="pixi-script" src="lib/scripts/pixi.js" onload="this.onload=null;this.setAttribute(&quot;loaded&quot;, &quot;true&quot;)"></script><script async="" id="minisearch-script" src="lib/scripts/minisearch.js" onload="this.onload=null;this.setAttribute(&quot;loaded&quot;, &quot;true&quot;)"></script><link rel="icon" href="lib/media/favicon.png"><script async="" id="graph-data-script" src="lib/scripts/graph-data.js" onload="this.onload=null;this.setAttribute(&quot;loaded&quot;, &quot;true&quot;)"></script><style>body{--line-width:40em;--line-width-adaptive:40em;--file-line-width:40em;--sidebar-width:min(20em, 80vw);--collapse-arrow-size:11px;--tree-horizontal-spacing:0.6em;--tree-vertical-spacing:0.6em;--sidebar-margin:12px}.sidebar{height:100%;min-width:calc(var(--sidebar-width) + var(--divider-width-hover));max-width:calc(var(--sidebar-width) + var(--divider-width-hover));font-size:14px;z-index:10;position:relative;overflow:hidden;transition:min-width ease-in-out,max-width ease-in-out;transition-duration:.2s;contain:size}.sidebar-left{left:0}.sidebar-right{right:0}.sidebar.is-collapsed{min-width:0;max-width:0}body.floating-sidebars .sidebar{position:absolute}.sidebar-content{height:100%;min-width:calc(var(--sidebar-width) - var(--divider-width-hover));top:0;padding:var(--sidebar-margin);padding-top:4em;line-height:var(--line-height-tight);background-color:var(--background-secondary);transition:background-color,border-right,border-left,box-shadow;transition-duration:var(--color-fade-speed);transition-timing-function:ease-in-out;position:absolute;display:flex;flex-direction:column}.sidebar:not(.is-collapsed) .sidebar-content{min-width:calc(max(100%,var(--sidebar-width)) - 3px);max-width:calc(max(100%,var(--sidebar-width)) - 3px)}.sidebar-left .sidebar-content{left:0;border-top-right-radius:var(--radius-l);border-bottom-right-radius:var(--radius-l)}.sidebar-right .sidebar-content{right:0;border-top-left-radius:var(--radius-l);border-bottom-left-radius:var(--radius-l)}.sidebar:has(.sidebar-content:empty):has(.topbar-content:empty){display:none}.sidebar-topbar{height:2em;width:var(--sidebar-width);top:var(--sidebar-margin);padding-inline:var(--sidebar-margin);z-index:1;position:fixed;display:flex;align-items:center;transition:width ease-in-out;transition-duration:inherit}.sidebar.is-collapsed .sidebar-topbar{width:calc(2.3em + var(--sidebar-margin) * 2)}.sidebar .sidebar-topbar.is-collapsed{width:0}.sidebar-left .sidebar-topbar{left:0}.sidebar-right .sidebar-topbar{right:0}.topbar-content{overflow:hidden;overflow:clip;width:100%;height:100%;display:flex;align-items:center;transition:inherit}.sidebar.is-collapsed .topbar-content{width:0;transition:inherit}.clickable-icon.sidebar-collapse-icon{background-color:transparent;color:var(--icon-color-focused);padding:0!important;margin:0!important;height:100%!important;width:2.3em!important;margin-inline:0.14em!important;position:absolute}.sidebar-left .clickable-icon.sidebar-collapse-icon{transform:rotateY(180deg);right:var(--sidebar-margin)}.sidebar-right .clickable-icon.sidebar-collapse-icon{transform:rotateY(180deg);left:var(--sidebar-margin)}.clickable-icon.sidebar-collapse-icon svg.svg-icon{width:100%;height:100%}.sidebar-section-header{margin:0 0 1em 0;text-transform:uppercase;letter-spacing:.06em;font-weight:600}body{transition:background-color var(--color-fade-speed) ease-in-out}.webpage-container{display:flex;flex-direction:row;height:100%;width:100%;align-items:stretch;justify-content:center}.document-container{opacity:1;flex-basis:100%;max-width:100%;width:100%;height:100%;display:flex;flex-direction:column;align-items:center;transition:opacity .2s ease-in-out;contain:inline-size}.hide{opacity:0;transition:opacity .2s ease-in-out}.document-container>.markdown-preview-view{margin:var(--sidebar-margin);margin-bottom:0;width:100%;width:-webkit-fill-available;width:-moz-available;width:fill-available;background-color:var(--background-primary);transition:background-color var(--color-fade-speed) ease-in-out;border-top-right-radius:var(--window-radius,var(--radius-m));border-top-left-radius:var(--window-radius,var(--radius-m));overflow-x:hidden!important;overflow-y:auto!important;display:flex!important;flex-direction:column!important;align-items:center!important;contain:inline-size}.document-container>.markdown-preview-view>.markdown-preview-sizer{padding-bottom:80vh!important;width:100%!important;max-width:var(--line-width)!important;flex-basis:var(--line-width)!important;transition:background-color var(--color-fade-speed) ease-in-out;contain:inline-size}.markdown-rendered img:not([width]),.view-content img:not([width]){max-width:100%;outline:0}.document-container>.view-content.embed{display:flex;padding:1em;height:100%;width:100%;align-items:center;justify-content:center}.document-container>.view-content.embed>*{max-width:100%;max-height:100%;object-fit:contain}:has(> :is(.math,table)){overflow-x:auto!important}.document-container>.view-content{overflow-x:auto;contain:content;padding:0;margin:0;height:100%}.scroll-highlight{position:absolute;width:100%;height:100%;pointer-events:none;z-index:1000;background-color:hsla(var(--color-accent-hsl),.25);opacity:0;padding:1em;inset:50%;translate:-50% -50%;border-radius:var(--radius-s)}</style><script defer="">async function loadIncludes(){if("file:"!=location.protocol){let e=document.querySelectorAll("include");for(let t=0;t<e.length;t++){let o=e[t],l=o.getAttribute("src");try{const e=await fetch(l);if(!e.ok){console.log("Could not include file: "+l),o?.remove();continue}let t=await e.text(),n=document.createRange().createContextualFragment(t),i=Array.from(n.children);for(let e of i)e.classList.add("hide"),e.style.transition="opacity 0.5s ease-in-out",setTimeout((()=>{e.classList.remove("hide")}),10);o.before(n),o.remove(),console.log("Included file: "+l)}catch(e){o?.remove(),console.log("Could not include file: "+l,e);continue}}}else{if(document.querySelectorAll("include").length>0){var e=document.createElement("div");e.id="error",e.textContent="Web server exports must be hosted on an http / web server to be viewed correctly.",e.style.position="fixed",e.style.top="50%",e.style.left="50%",e.style.transform="translate(-50%, -50%)",e.style.fontSize="1.5em",e.style.fontWeight="bold",e.style.textAlign="center",document.body.appendChild(e),document.querySelector(".document-container")?.classList.remove("hide")}}}document.addEventListener("DOMContentLoaded",(()=>{loadIncludes()}));let isFileProtocol="file:"==location.protocol;function waitLoadScripts(e,t){let o=e.map((e=>document.getElementById(e+"-script"))),l=0;!function e(){let n=o[l];l++,n&&"true"!=n.getAttribute("loaded")||l<o.length&&e(),l<o.length?n.addEventListener("load",e):t()}()}</script><link rel="stylesheet" href="lib/styles/obsidian.css"><link rel="preload" href="lib/styles/other-plugins.css" as="style" onload="this.onload=null;this.rel='stylesheet'"><noscript><link rel="stylesheet" href="lib/styles/other-plugins.css"></noscript><link rel="stylesheet" href="lib/styles/theme.css"><link rel="preload" href="lib/styles/global-variable-styles.css" as="style" onload="this.onload=null;this.rel='stylesheet'"><noscript><link rel="stylesheet" href="lib/styles/global-variable-styles.css"></noscript><link rel="preload" href="lib/styles/supported-plugins.css" as="style" onload="this.onload=null;this.rel='stylesheet'"><noscript><link rel="stylesheet" href="lib/styles/supported-plugins.css"></noscript><link rel="preload" href="lib/styles/main-styles.css" as="style" onload="this.onload=null;this.rel='stylesheet'"><noscript><link rel="stylesheet" href="lib/styles/main-styles.css"></noscript></head><body class="publish css-settings-manager theme-light show-inline-title show-ribbon outliner-plugin-dnd custom-accent ribbon-default special-h6 float-center"><script defer="">let theme=localStorage.getItem("theme")||(window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light");"dark"==theme?(document.body.classList.add("theme-dark"),document.body.classList.remove("theme-light")):(document.body.classList.add("theme-light"),document.body.classList.remove("theme-dark")),window.innerWidth<480?document.body.classList.add("is-phone"):window.innerWidth<768?document.body.classList.add("is-tablet"):window.innerWidth<1024?document.body.classList.add("is-small-screen"):document.body.classList.add("is-large-screen")</script><div class="webpage-container workspace"><div class="sidebar-left sidebar"><div class="sidebar-handle"></div><div class="sidebar-topbar"><div class="topbar-content"><label class="theme-toggle-container" for="theme_toggle"><input class="theme-toggle-input" type="checkbox" id="theme_toggle"><div class="toggle-background"></div></label></div><div class="clickable-icon sidebar-collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" class="svg-icon"><path d="M21 3H3C1.89543 3 1 3.89543 1 5V19C1 20.1046 1.89543 21 3 21H21C22.1046 21 23 20.1046 23 19V5C23 3.89543 22.1046 3 21 3Z"></path><path d="M10 4V20"></path><path d="M4 7H7"></path><path d="M4 10H7"></path><path d="M4 13H7"></path></svg></div></div><div class="sidebar-content"><div class="search-input-container"><input enterkeyhint="search" type="search" spellcheck="false" placeholder="Search..."><div class="search-input-clear-button" aria-label="Clear search"></div></div><include src="lib/html/file-tree.html"></include></div><script defer="">let ls = document.querySelector(".sidebar-left"); ls.classList.add("is-collapsed"); if (window.innerWidth > 768) ls.classList.remove("is-collapsed"); ls.style.setProperty("--sidebar-width", localStorage.getItem("sidebar-left-width"));</script></div><div class="document-container markdown-reading-view hide"><div class="markdown-preview-view markdown-rendered allow-fold-headings allow-fold-lists is-readable-line-width"><style id="MJX-CHTML-styles">mjx-munder{display:inline-block;text-align:left}mjx-over{text-align:left}mjx-munder:not([limits=false]){display:inline-table}mjx-munder>mjx-row{text-align:left}mjx-under{padding-bottom:.1em}mjx-msub{display:inline-block;text-align:left}mjx-c.mjx-c1D436.TEX-I::before{padding:.705em .76em .022em 0;content:"C"}mjx-c.mjx-c3D::before{padding:.583em .778em .082em 0;content:"="}mjx-c.mjx-c2211.TEX-S2::before{padding:.95em 1.444em .45em 0;content:"∑"}mjx-c.mjx-c1D45D.TEX-I::before{padding:.442em .503em .194em 0;content:"p"}mjx-c.mjx-c1D461.TEX-I::before{padding:.626em .361em .011em 0;content:"t"}mjx-mtext{display:inline-block;text-align:left}mjx-container[jax=CHTML]{line-height:0}mjx-container [space="1"]{margin-left:.111em}mjx-container [space="2"]{margin-left:.167em}mjx-container [space="3"]{margin-left:.222em}mjx-container [space="4"]{margin-left:.278em}mjx-container [space="5"]{margin-left:.333em}mjx-container [rspace="1"]{margin-right:.111em}mjx-container [rspace="2"]{margin-right:.167em}mjx-container [rspace="3"]{margin-right:.222em}mjx-container [rspace="4"]{margin-right:.278em}mjx-container [rspace="5"]{margin-right:.333em}mjx-container [size="s"]{font-size:70.7%}mjx-container [size=ss]{font-size:50%}mjx-container [size=Tn]{font-size:60%}mjx-container [size=sm]{font-size:85%}mjx-container [size=lg]{font-size:120%}mjx-container [size=Lg]{font-size:144%}mjx-container [size=LG]{font-size:173%}mjx-container [size=hg]{font-size:207%}mjx-container [size=HG]{font-size:249%}mjx-container [width=full]{width:100%}mjx-box{display:inline-block}mjx-block{display:block}mjx-itable{display:inline-table}mjx-row{display:table-row}mjx-row>*{display:table-cell}mjx-mtext{display:inline-block}mjx-mstyle{display:inline-block}mjx-merror{display:inline-block;color:red;background-color:#ff0}mjx-mphantom{visibility:hidden}mjx-assistive-mml{top:0;left:0;clip:rect(1px,1px,1px,1px);user-select:none;position:absolute!important;padding:1px 0 0!important;border:0!important;display:block!important;width:auto!important;overflow:hidden!important}mjx-assistive-mml[display=block]{width:100%!important}mjx-math{display:inline-block;text-align:left;line-height:0;text-indent:0;font-style:normal;font-weight:400;font-size:100%;font-size-adjust:none;letter-spacing:normal;border-collapse:collapse;overflow-wrap:normal;word-spacing:normal;white-space:nowrap;direction:ltr;padding:1px 0}mjx-container[jax=CHTML][display=true]{display:block;text-align:center;margin:1em 0}mjx-container[jax=CHTML][display=true][width=full]{display:flex}mjx-container[jax=CHTML][display=true] mjx-math{padding:0}mjx-container[jax=CHTML][justify=left]{text-align:left}mjx-container[jax=CHTML][justify=right]{text-align:right}mjx-msup{display:inline-block;text-align:left}mjx-mi{display:inline-block;text-align:left}mjx-c{display:inline-block}mjx-utext{display:inline-block;padding:.75em 0 .2em}mjx-texatom{display:inline-block;text-align:left}mjx-mo{display:inline-block;text-align:left}mjx-stretchy-h{display:inline-table;width:100%}mjx-stretchy-h>*{display:table-cell;width:0}mjx-stretchy-h>*>mjx-c{display:inline-block;transform:scaleX(1)}mjx-stretchy-h>*>mjx-c::before{display:inline-block;width:initial}mjx-stretchy-h>mjx-ext{overflow:clip visible;width:100%}mjx-stretchy-h>mjx-ext>mjx-c::before{transform:scaleX(500)}mjx-stretchy-h>mjx-ext>mjx-c{width:0}mjx-stretchy-h>mjx-beg>mjx-c{margin-right:-.1em}mjx-stretchy-h>mjx-end>mjx-c{margin-left:-.1em}mjx-stretchy-v{display:inline-block}mjx-stretchy-v>*{display:block}mjx-stretchy-v>mjx-beg{height:0}mjx-stretchy-v>mjx-end>mjx-c{display:block}mjx-stretchy-v>*>mjx-c{transform:scaleY(1);transform-origin:left center;overflow:hidden}mjx-stretchy-v>mjx-ext{display:block;height:100%;box-sizing:border-box;border:0 solid transparent;overflow:visible clip}mjx-stretchy-v>mjx-ext>mjx-c::before{width:initial;box-sizing:border-box}mjx-stretchy-v>mjx-ext>mjx-c{transform:scaleY(500) translateY(.075em);overflow:visible}mjx-mark{display:inline-block;height:0}mjx-c::before{display:block;width:0}.MJX-TEX{font-family:MJXZERO,MJXTEX}.TEX-B{font-family:MJXZERO,MJXTEX-B}.TEX-I{font-family:MJXZERO,MJXTEX-I}.TEX-MI{font-family:MJXZERO,MJXTEX-MI}.TEX-BI{font-family:MJXZERO,MJXTEX-BI}.TEX-S1{font-family:MJXZERO,MJXTEX-S1}.TEX-S2{font-family:MJXZERO,MJXTEX-S2}.TEX-S3{font-family:MJXZERO,MJXTEX-S3}.TEX-S4{font-family:MJXZERO,MJXTEX-S4}.TEX-A{font-family:MJXZERO,MJXTEX-A}.TEX-C{font-family:MJXZERO,MJXTEX-C}.TEX-CB{font-family:MJXZERO,MJXTEX-CB}.TEX-FR{font-family:MJXZERO,MJXTEX-FR}.TEX-FRB{font-family:MJXZERO,MJXTEX-FRB}.TEX-SS{font-family:MJXZERO,MJXTEX-SS}.TEX-SSB{font-family:MJXZERO,MJXTEX-SSB}.TEX-SSI{font-family:MJXZERO,MJXTEX-SSI}.TEX-SC{font-family:MJXZERO,MJXTEX-SC}.TEX-T{font-family:MJXZERO,MJXTEX-T}.TEX-V{font-family:MJXZERO,MJXTEX-V}.TEX-VB{font-family:MJXZERO,MJXTEX-VB}mjx-stretchy-h mjx-c,mjx-stretchy-v mjx-c{font-family:MJXZERO,MJXTEX-S1,MJXTEX-S4,MJXTEX,MJXTEX-A!important}@font-face{font-family:MJXZERO;src:url("lib/fonts/mathjax_zero.woff") format("woff")}@font-face{font-family:MJXTEX;src:url("lib/fonts/mathjax_main-regular.woff") format("woff")}@font-face{font-family:MJXTEX-B;src:url("lib/fonts/mathjax_main-bold.woff") format("woff")}@font-face{font-family:MJXTEX-I;src:url("lib/fonts/mathjax_math-italic.woff") format("woff")}@font-face{font-family:MJXTEX-MI;src:url("lib/fonts/mathjax_main-italic.woff") format("woff")}@font-face{font-family:MJXTEX-BI;src:url("lib/fonts/mathjax_math-bolditalic.woff") format("woff")}@font-face{font-family:MJXTEX-S1;src:url("lib/fonts/mathjax_size1-regular.woff") format("woff")}@font-face{font-family:MJXTEX-S2;src:url("lib/fonts/mathjax_size2-regular.woff") format("woff")}@font-face{font-family:MJXTEX-S3;src:url("lib/fonts/mathjax_size3-regular.woff") format("woff")}@font-face{font-family:MJXTEX-S4;src:url("lib/fonts/mathjax_size4-regular.woff") format("woff")}@font-face{font-family:MJXTEX-A;src:url("lib/fonts/mathjax_ams-regular.woff") format("woff")}@font-face{font-family:MJXTEX-C;src:url("lib/fonts/mathjax_calligraphic-regular.woff") format("woff")}@font-face{font-family:MJXTEX-CB;src:url("lib/fonts/mathjax_calligraphic-bold.woff") format("woff")}@font-face{font-family:MJXTEX-FR;src:url("lib/fonts/mathjax_fraktur-regular.woff") format("woff")}@font-face{font-family:MJXTEX-FRB;src:url("lib/fonts/mathjax_fraktur-bold.woff") format("woff")}@font-face{font-family:MJXTEX-SS;src:url("lib/fonts/mathjax_sansserif-regular.woff") format("woff")}@font-face{font-family:MJXTEX-SSB;src:url("lib/fonts/mathjax_sansserif-bold.woff") format("woff")}@font-face{font-family:MJXTEX-SSI;src:url("lib/fonts/mathjax_sansserif-italic.woff") format("woff")}@font-face{font-family:MJXTEX-SC;src:url("lib/fonts/mathjax_script-regular.woff") format("woff")}@font-face{font-family:MJXTEX-T;src:url("lib/fonts/mathjax_typewriter-regular.woff") format("woff")}@font-face{font-family:MJXTEX-V;src:url("lib/fonts/mathjax_vector-regular.woff") format("woff")}@font-face{font-family:MJXTEX-VB;src:url("lib/fonts/mathjax_vector-bold.woff") format("woff")}mjx-c.mjx-c1D447.TEX-I::before{padding:.677em .704em 0 0;content:"T"}mjx-c.mjx-c1D450.TEX-I::before{padding:.442em .433em .011em 0;content:"c"}mjx-c.mjx-c2C::before{padding:.121em .278em .194em 0;content:","}mjx-c.mjx-c2E::before{padding:.12em .278em 0 0;content:"."}</style><div class="markdown-preview-sizer markdown-preview-section"><h1 class="page-title heading inline-title" id="Signaling in WebRTC with Ably and Fable"><p dir="auto">Signaling in WebRTC with Ably and Fable</p></h1><div class="el-p"><p dir="auto"><a href="?query=tag:fsharp" class="tag" target="_blank" rel="noopener nofollow">#fsharp</a> <a href="?query=tag:fp" class="tag" target="_blank" rel="noopener nofollow">#fp</a> <a href="?query=tag:web" class="tag" target="_blank" rel="noopener nofollow">#web</a> <a href="?query=tag:network" class="tag" target="_blank" rel="noopener nofollow">#network</a> <a href="?query=tag:dotnet" class="tag" target="_blank" rel="noopener nofollow">#dotnet</a><br>
Hi,</p></div><div class="el-p"><p dir="auto">I try to combine a WebRTC and Fable for some time in my daily work. I want to describe the process of implementing a signaling mechanism for it.</p></div><div class="el-p"><p dir="auto">But at first, what is a WebRTC? <a data-tooltip-position="top" aria-label="https://webrtc.org/" rel="noopener nofollow" class="external-link" href="https://webrtc.org/" target="_blank">WebRTC</a> is a technology that allows exchanging data between N peers via UDP or TCP protocols. Exchange means that there is no server in the middle, but peers talk to each other (except situation when Relay connection is used). WebRTC is a native API available in all modern browsers. One of the things that are not ready by default is the signaling process. About which will be this article.</p></div><div class="el-p"><p dir="auto">Before we go into details of implementation. Let’s explain some basic concepts around signaling. To establish a connection between 2 Peers they need to exchange messages with <a data-tooltip-position="top" aria-label="https://developer.mozilla.org/en-US/docs/Glossary/SDP" rel="noopener nofollow" class="external-link" href="https://developer.mozilla.org/en-US/docs/Glossary/SDP" target="_blank">SDP</a> (Session description protocol) information. The number of those messages depends on:</p></div><div class="el-ul"><ul>
<li data-line="0" dir="auto">the number of STUN/TURN server,</li>
<li data-line="1" dir="auto">type of connection (P2P/Relay).</li>
</ul></div><div class="el-p"><p dir="auto">SDP contains a lot of information needed to start a connection. Messages that would be exchanged are called Offer, Answer, and Candidates. We gonna use a <a data-tooltip-position="top" aria-label="https://webrtcglossary.com/trickle-ice/" rel="noopener nofollow" class="external-link" href="https://webrtcglossary.com/trickle-ice/" target="_blank">Trickle-Ice</a> mechanism. It means that the offer, answer, and candidates will be sent separately in an async manner. Candidates have information about “how to connect to a peer which create them” (more about them <a data-tooltip-position="top" aria-label="https://developer.mozilla.org/en-US/docs/Web/API/RTCIceCandidate" rel="noopener nofollow" class="external-link" href="https://developer.mozilla.org/en-US/docs/Web/API/RTCIceCandidate" target="_blank">here</a>). There is also a simpler way of establishing a connection where Answer and Offer would contain all needed candidates. But I want to focus on an async version because we are using it in our product because of better performance.</p></div><div class="el-p"><p dir="auto">Switching messages as described above are named “signaling”. When I was looking for some ready to go solution for signaling I find out <a data-tooltip-position="top" aria-label="https://www.ably.io/" rel="noopener nofollow" class="external-link" href="https://www.ably.io/" target="_blank">Ably.io</a>. I decided to give it a try in case of my base application, which should send a file from one peer to another.</p></div><div class="el-p"><p dir="auto">When I was reading the Ably.io documentation. I realized that the only functions that I will need would be <code>publish</code> and <code>subscribe</code>. Which are used in a message channel context. Because of that, I created an Ably interface in F# which is a port of JS interfaces from their official lib.</p></div><div class="el-pre"><pre class="language-fsharp" tabindex="0"><code data-line="0" class="language-fsharp is-loaded"><span class="token keyword">module</span> AblyMapping <span class="token operator">=</span>
  <span class="token keyword">type</span> <span class="token class-name">IMessage</span> <span class="token operator">=</span>
    <span class="token keyword">abstract</span> name<span class="token punctuation">:</span> <span class="token class-name">string</span>
    <span class="token keyword">abstract</span> data<span class="token punctuation">:</span> <span class="token class-name">string</span>

  <span class="token keyword">type</span> <span class="token class-name">IChannel</span> <span class="token operator">=</span>
    <span class="token keyword">abstract</span> publish<span class="token punctuation">:</span> <span class="token class-name">string <span class="token operator">*</span> string <span class="token operator">-&gt;</span> unit</span>
    <span class="token keyword">abstract</span> subscribe<span class="token punctuation">:</span> <span class="token class-name">string</span> <span class="token operator">*</span> <span class="token punctuation">(</span>IMessage <span class="token operator">-&gt;</span> unit<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> unit

  <span class="token keyword">type</span> <span class="token class-name">IChannels</span> <span class="token operator">=</span>
    <span class="token keyword">abstract</span> ``get``<span class="token punctuation">:</span> string <span class="token operator">-&gt;</span> IChannel

  <span class="token keyword">type</span> <span class="token class-name">IRealTime</span> <span class="token operator">=</span>
    <span class="token keyword">abstract</span> channels<span class="token punctuation">:</span> <span class="token class-name">IChannels</span>

  <span class="token keyword">type</span> <span class="token class-name">IAbly</span> <span class="token operator">=</span>
    <span class="token keyword">abstract</span> Realtime<span class="token punctuation">:</span> <span class="token punctuation">(</span>string<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> IRealTime

  <span class="token keyword">let</span> Ably<span class="token punctuation">:</span> <span class="token class-name">IAbly</span> <span class="token operator">=</span> importAll <span class="token string">"Ably"</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">Changes in packages.json.</p></div><div class="el-pre"><pre class="language-javascript" tabindex="0"><code data-line="0" class="language-javascript is-loaded"><span class="token punctuation">{</span>
  …
  <span class="token literal-property property">”ably”</span><span class="token operator">:</span> <span class="token string">"^1.2.4"</span>
<span class="token punctuation">}</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">I believe that the above code is self-explanatory when we look at the JS example from the Ably site.</p></div><div class="el-pre"><pre class="language-javascript" tabindex="0"><code data-line="0" class="language-javascript is-loaded"><span class="token keyword">var</span> ably <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Ably<span class="token punctuation">.</span>Realtime</span><span class="token punctuation">(</span><span class="token string">'apikey'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> channel <span class="token operator">=</span> ably<span class="token punctuation">.</span><span class="token property-access">channels</span><span class="token punctuation">.</span><span class="token method function property-access">get</span><span class="token punctuation">(</span><span class="token string">'gut-tub'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Publish a message to the gut-tub channel</span>
channel<span class="token punctuation">.</span><span class="token method function property-access">publish</span><span class="token punctuation">(</span><span class="token string">'greeting'</span><span class="token punctuation">,</span> <span class="token string">'hello'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> ably <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Ably<span class="token punctuation">.</span>Realtime</span><span class="token punctuation">(</span><span class="token string">'apikey'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> channel <span class="token operator">=</span> ably<span class="token punctuation">.</span><span class="token property-access">channels</span><span class="token punctuation">.</span><span class="token method function property-access">get</span><span class="token punctuation">(</span><span class="token string">'gut-tub'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Subscribe to messages on channel</span>
channel<span class="token punctuation">.</span><span class="token method function property-access">subscribe</span><span class="token punctuation">(</span><span class="token string">'greeting'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">message</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">alert</span><span class="token punctuation">(</span>message<span class="token punctuation">.</span><span class="token property-access">data</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">Initialization of ably could be found in <code>init</code> method.</p></div><div class="el-pre"><pre class="language-fsharp" tabindex="0"><code data-line="0" class="language-fsharp is-loaded"><span class="token keyword">let</span> init <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span> Model <span class="token operator">*</span> Cmd<span class="token operator">&lt;</span>Msg<span class="token operator">&gt;</span> <span class="token operator">=</span>
  <span class="token keyword">let</span> channel <span class="token operator">=</span>
    AblyMapping<span class="token punctuation">.</span>Ably<span class="token punctuation">.</span>Realtime “api<span class="token operator">-</span>key”
    <span class="token operator">|&gt;</span> <span class="token keyword">fun</span> x <span class="token operator">-&gt;</span> x<span class="token punctuation">.</span>channels<span class="token punctuation">.</span>get “channel name"
  <span class="token keyword">let</span> model <span class="token operator">=</span> <span class="token punctuation">{</span>
    Role <span class="token operator">=</span> None
    Channel <span class="token operator">=</span> channel
    ConnectionState <span class="token operator">=</span> WebRTC<span class="token punctuation">.</span>ConnectionState<span class="token punctuation">.</span>NotConnected
    WaitingCandidates <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">}</span>
  model<span class="token punctuation">,</span> Cmd<span class="token punctuation">.</span>none
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">Right now, we could go to sending and receiving messages via Ably, but I start with installing the <a data-tooltip-position="top" aria-label="https://www.npmjs.com/package/webrtc-adapter" rel="noopener nofollow" class="external-link" href="https://www.npmjs.com/package/webrtc-adapter" target="_blank">WebRTC-adapter</a> library. This library gives me confidence that what I want to achieve with native API would work the same way in every browser. Since there are some slight differences between implementations.</p></div><div class="el-p"><p dir="auto">I add the following line to the packages.json with the <code>webrtc-adapter</code> library.</p></div><div class="el-pre"><pre class="language-javascript" tabindex="0"><code data-line="0" class="language-javascript is-loaded"><span class="token punctuation">{</span>
  …
  <span class="token string-property property">"webrtc-adapter"</span><span class="token operator">:</span> <span class="token string">"^7.7.0"</span>
<span class="token punctuation">}</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">Usage in F# code.</p></div><div class="el-pre"><pre class="language-fsharp" tabindex="0"><code data-line="0" class="language-fsharp is-loaded"><span class="token keyword">module</span> WebRTC <span class="token operator">=</span>
  <span class="token keyword">let</span> <span class="token keyword">private</span> adapter<span class="token punctuation">:</span> <span class="token class-name">obj</span> <span class="token operator">=</span> importAll <span class="token string">"webrtc-adapter"</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">Thanks to the above. I’m sure that the interfaces are compatible across all supported browsers. We could switch to the code which is responsible for handling WebRTC. The code snippet is big because we need to distinguish the <code>sender</code> and <code>receiver</code> of a file. It is because we don’t have an application on the server-side. I started with the creation of a <code>PeerConnection</code> object with a communication server address.</p></div><div class="el-pre"><pre class="language-fsharp" tabindex="0"><code data-line="0" class="language-fsharp is-loaded"><span class="token keyword">let</span> create <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span>
  <span class="token keyword">let</span> conf <span class="token operator">=</span>
    <span class="token punctuation">[</span><span class="token operator">|</span> RTCIceServer<span class="token punctuation">.</span><span class="token function">Create</span><span class="token punctuation">(</span> <span class="token punctuation">[</span><span class="token operator">|</span> <span class="token string">"turn:location:443"</span> <span class="token operator">|</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">"user"</span><span class="token punctuation">,</span> <span class="token string">"pass"</span><span class="token punctuation">,</span> RTCIceCredentialType<span class="token punctuation">.</span>Password <span class="token punctuation">)</span> <span class="token operator">|</span><span class="token punctuation">]</span>
    <span class="token operator">|&gt;</span> RTCConfiguration<span class="token punctuation">.</span>Create
    <span class="token operator">|&gt;</span> <span class="token keyword">fun</span> x <span class="token operator">-&gt;</span>
      x<span class="token punctuation">.</span>iceTransportPolicy <span class="token operator">&lt;-</span> Some RTCIceTransportPolicy<span class="token punctuation">.</span>Relay
      x

    <span class="token keyword">let</span> pc <span class="token operator">=</span> RTCPeerConnection<span class="token punctuation">.</span><span class="token function">Create</span><span class="token punctuation">(</span>conf<span class="token punctuation">)</span>

    <span class="token punctuation">{</span> Peer <span class="token operator">=</span> pc<span class="token punctuation">;</span> Channel <span class="token operator">=</span> None <span class="token punctuation">}</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">Because I test everything locally, I force using a Relay connection. Otherwise, communication would be done via a local network. That would result in skipping the signaling phase (host candidates would be used). Worth mentioning is that using public STUN/TURN servers is not recommended. We are not sure how the configuration looks like and who owns them.</p></div><div class="el-p"><p dir="auto">We create a <code>LifecycleModel</code> object which contains a <code>PeerConnection</code> and <code>RTCDataChannel</code> inside. And create an instance of it. It is created as a mutable field instead of part of the Elmish model. It is because of simplicity (default Thoth serializer couldn’t handle serializing <code>PeerConnection</code> also passing the whole big object wouldn’t be something that we want to do).</p></div><div class="el-pre"><pre class="language-fsharp" tabindex="0"><code data-line="0" class="language-fsharp is-loaded"><span class="token keyword">type</span> <span class="token class-name">LifecycleModel</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
  Peer<span class="token punctuation">:</span> <span class="token class-name">RTCPeerConnection</span>
  Channel<span class="token punctuation">:</span> <span class="token class-name">RTCDataChannel</span> option
<span class="token punctuation">}</span>

<span class="token operator">..</span><span class="token punctuation">.</span>

<span class="token keyword">let</span> <span class="token keyword">mutable</span> peer<span class="token punctuation">:</span> <span class="token class-name">LifecycleModel</span> <span class="token operator">=</span> Unchecked<span class="token punctuation">.</span>defaultof<span class="token operator">&lt;</span>_<span class="token operator">&gt;</span>

<span class="token operator">..</span><span class="token punctuation">.</span>

peer <span class="token operator">&lt;-</span> WebRTC<span class="token punctuation">.</span>create <span class="token punctuation">(</span><span class="token punctuation">)</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">After the creation of the <code>PeerConnection</code> object. We see that in the UI we have a possibility to connect as <code>sender</code> or <code>receiver</code>.</p></div><div class="el-p"><p dir="auto"><img alt="initialize" src="https://mnie.github.com/img/2021_01_05_webrtc_ably/initialize.png" referrerpolicy="no-referrer"></p></div><div class="el-p"><p dir="auto">It would result in a distinction of how WebRTC is working and a different value for a <code>Role</code> field in a model. When we look at how the <code>sender</code> logic is implemented we start with the creation of <code>RTCDataChannel</code>. It would be used as a transfer channel between users. The creation of a channel is located in the <code>createChannel</code> function.</p></div><div class="el-pre"><pre class="language-fsharp" tabindex="0"><code data-line="0" class="language-fsharp is-loaded"><span class="token keyword">let</span> createChannel pc name <span class="token operator">=</span>
  <span class="token keyword">let</span> channel <span class="token operator">=</span> pc<span class="token punctuation">.</span>Peer<span class="token punctuation">.</span>createDataChannel <span class="token computation-expression keyword">name</span>
  <span class="token punctuation">{</span> pc <span class="token keyword">with</span> Channel <span class="token operator">=</span> Some channel<span class="token punctuation">}</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">Going to the configuration of messages send and received via <code>Ably</code>. When we are a <code>sender</code> we want to listen to <code>Answer</code> and <code>Candidate</code>(from the receiver) messages. How it is achieved is visible in below code snippet.</p></div><div class="el-pre"><pre class="language-fsharp" tabindex="0"><code data-line="0" class="language-fsharp is-loaded"><span class="token keyword">let</span> subs <span class="token operator">=</span>
  <span class="token punctuation">[</span>
      <span class="token string">"answer"</span><span class="token punctuation">,</span> <span class="token keyword">fun</span> <span class="token punctuation">(</span>msg<span class="token punctuation">:</span> <span class="token class-name">AblyMapping<span class="token punctuation">.</span>IMessage</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> dispatch <span class="token punctuation">(</span>Msg<span class="token punctuation">.</span>WebRTC <span class="token punctuation">(</span>WebRTC<span class="token punctuation">.</span>Msg<span class="token punctuation">.</span>Answer msg<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token string">"receiver-candidate"</span><span class="token punctuation">,</span> <span class="token keyword">fun</span> <span class="token punctuation">(</span>msg<span class="token punctuation">:</span> <span class="token class-name">AblyMapping<span class="token punctuation">.</span>IMessage</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> dispatch <span class="token punctuation">(</span>Msg<span class="token punctuation">.</span>WebRTC <span class="token punctuation">(</span>WebRTC<span class="token punctuation">.</span>Msg<span class="token punctuation">.</span>Candidate msg<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">]</span> <span class="token operator">|&gt;</span> Map<span class="token punctuation">.</span>ofList
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">And combination with <code>Ably</code> channel is visible in <code>init</code> method from <code>Signaling</code> module.</p></div><div class="el-pre"><pre class="language-fsharp" tabindex="0"><code data-line="0" class="language-fsharp is-loaded"><span class="token keyword">let</span> init <span class="token punctuation">(</span>channel<span class="token punctuation">:</span> <span class="token class-name">IChannel</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>subscribers<span class="token punctuation">:</span> <span class="token class-name">Map</span><span class="token operator">&lt;</span>string<span class="token punctuation">,</span> IMessage <span class="token operator">-&gt;</span> unit<span class="token operator">&gt;</span><span class="token punctuation">)</span> <span class="token operator">=</span>
  subscribers
  <span class="token operator">|&gt;</span> Map<span class="token punctuation">.</span>iter <span class="token punctuation">(</span><span class="token keyword">fun</span> subscriberKey subscriberFunc <span class="token operator">-&gt;</span>
      channel<span class="token punctuation">.</span>subscribe <span class="token punctuation">(</span>subscriberKey<span class="token punctuation">,</span> subscriberFunc<span class="token punctuation">)</span>
  <span class="token punctuation">)</span>
  channel
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">As we could see we subscribe to all messages with the given keys <code>answer</code> and <code>receiver-candidate</code>. When they occur we propagate Elmish messages that would be handle in the <code>update</code> method.</p></div><div class="el-p"><p dir="auto">In the <code>receiver</code> scenario the difference is that we don’t create <code>RTCDataChannel</code> (this is why it is marked as <code>option</code> in <code>LifecycleModel</code>). We gather it when the connection would be in a <code>connecting</code> phase. If it would be created on its own we would receive an invalid state error. This is why we only subscribe to messages <code>Offer</code> and <code>Candidate</code>(from Sender).</p></div><div class="el-p"><p dir="auto">When a subscription to Ably messages is ready we send an Elmish message <code>Signaling</code> with a ready channel which is updated in the application model. Whereas the WebRTC configuration is updated with callbacks to functions that need to be handled in a connection/data transfer process.</p></div><div class="el-p"><p dir="auto">Assignment of those callbacks and how they are handled is visible in a <code>subscribe</code> function. Which should:</p></div><div class="el-ul"><ul>
<li data-line="0" dir="auto">Initialize <code>RTCDataChannel</code> through which data (file) would be transferred.</li>
</ul></div><div class="el-pre"><pre class="language-fsharp" tabindex="0"><code data-line="0" class="language-fsharp is-loaded"><span class="token keyword">let</span> <span class="token keyword">private</span> initReceiverChannel <span class="token punctuation">(</span>pc<span class="token punctuation">:</span> <span class="token class-name">RTCPeerConnection</span><span class="token punctuation">)</span> msgHandler dispatch <span class="token operator">=</span>
  <span class="token keyword">let</span> <span class="token keyword">mutable</span> updatedChannel<span class="token punctuation">:</span> <span class="token class-name">RTCDataChannel</span> <span class="token operator">=</span> Unchecked<span class="token punctuation">.</span>defaultof<span class="token operator">&lt;</span>_<span class="token operator">&gt;</span>
  <span class="token keyword">let</span> callback <span class="token punctuation">(</span>ev<span class="token punctuation">:</span> <span class="token class-name">RTCDataChannelEvent</span><span class="token punctuation">)</span> <span class="token operator">=</span>
    <span class="token keyword">let</span> receiveChannel <span class="token operator">=</span> subscribeChannel ev<span class="token punctuation">.</span>channel msgHandler dispatch
    internalLog <span class="token punctuation">(</span>sprintf <span class="token string">"updating channel: %A"</span> ev<span class="token punctuation">.</span>channel<span class="token punctuation">.</span>id<span class="token punctuation">)</span>
    peer <span class="token operator">&lt;-</span> <span class="token punctuation">{</span> peer <span class="token keyword">with</span> Channel <span class="token operator">=</span> Some receiveChannel <span class="token punctuation">}</span>

  pc<span class="token punctuation">.</span>ondatachannel <span class="token operator">&lt;-</span> callback
  updatedChannel

<span class="token keyword">let</span> updatedChannel <span class="token operator">=</span>
  <span class="token keyword">if</span> role <span class="token operator">=</span> Role<span class="token punctuation">.</span>Sender <span class="token keyword">then</span>
    <span class="token keyword">match</span> channel <span class="token keyword">with</span>
    <span class="token operator">|</span> Some c <span class="token operator">-&gt;</span>
      internalLog <span class="token punctuation">(</span>sprintf <span class="token string">"initialize channel for: %A"</span> role<span class="token punctuation">)</span>
      subscribeChannel c msgHandler dispatch
    <span class="token operator">|</span> None <span class="token operator">-&gt;</span> failwith <span class="token string">"Channel is not initilized for sender"</span>
  <span class="token keyword">else</span>
      internalLog <span class="token punctuation">(</span>sprintf <span class="token string">"initialize channel2 for: %A"</span> role<span class="token punctuation">)</span>
      initReceiverChannel pc msgHandler dispatch
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-ul"><ul>
<li data-line="0" dir="auto">Handling connection state (only for diagnostic purposes).</li>
</ul></div><div class="el-pre"><pre class="language-fsharp" tabindex="0"><code data-line="0" class="language-fsharp is-loaded">pc<span class="token punctuation">.</span>oniceconnectionstatechange <span class="token operator">&lt;-</span>
  <span class="token keyword">fun</span> _ <span class="token operator">-&gt;</span>
    internalLog <span class="token punctuation">(</span>sprintf <span class="token string">"Connection state changed to: %A"</span> pc<span class="token punctuation">.</span>iceConnectionState<span class="token punctuation">)</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-ul"><ul>
<li data-line="0" dir="auto">Handling exchange of candidates.</li>
</ul></div><div class="el-pre"><pre class="language-fsharp" tabindex="0"><code data-line="0" class="language-fsharp is-loaded">pc<span class="token punctuation">.</span>onicecandidate <span class="token operator">&lt;-</span>
  <span class="token keyword">fun</span> e <span class="token operator">-&gt;</span>
    <span class="token keyword">match</span> e<span class="token punctuation">.</span>candidate <span class="token keyword">with</span>
    <span class="token operator">|</span> None <span class="token operator">-&gt;</span> internalLog <span class="token string">"Trickle ICE Completed"</span>
    <span class="token operator">|</span> Some cand <span class="token operator">-&gt;</span>
      cand<span class="token punctuation">.</span><span class="token function">toJSON</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token operator">|&gt;</span> Base64<span class="token punctuation">.</span>``<span class="token keyword">to</span>``
      <span class="token operator">|&gt;</span> Signaling<span class="token punctuation">.</span>WebRTCCandidate<span class="token punctuation">.</span>Candidate
      <span class="token operator">|&gt;</span>
        <span class="token keyword">if</span> role <span class="token operator">=</span> Role<span class="token punctuation">.</span>Sender <span class="token keyword">then</span>
            Signaling<span class="token punctuation">.</span>Notification<span class="token punctuation">.</span>SenderCandidate
        <span class="token keyword">else</span> Signaling<span class="token punctuation">.</span>Notification<span class="token punctuation">.</span>ReceiverCandidate
      <span class="token operator">|&gt;</span> onSignal
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">Configuration of WebRTC is ready on the <code>sender</code> and <code>receiver</code> side.</p></div><div class="el-p"><p dir="auto"><img alt="connect" src="https://mnie.github.com/img/2021_01_05_webrtc_ably/connect.png" referrerpolicy="no-referrer"></p></div><div class="el-p"><p dir="auto">We could initiate a connection by clicking the <code>Connect</code> button. After clicking it the <code>init</code> method from the <code>WebRTC</code> module would be called.</p></div><div class="el-pre"><pre class="language-fsharp" tabindex="0"><code data-line="0" class="language-fsharp is-loaded"><span class="token keyword">let</span> init connection onSignal <span class="token operator">=</span>
  <span class="token keyword">let</span> pc<span class="token punctuation">,</span> channel <span class="token operator">=</span> connection<span class="token punctuation">.</span>Peer<span class="token punctuation">,</span> connection<span class="token punctuation">.</span>Channel
  pc<span class="token punctuation">.</span><span class="token function">createOffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>``<span class="token keyword">then</span>``<span class="token punctuation">(</span><span class="token keyword">fun</span> desc <span class="token operator">-&gt;</span>
    pc<span class="token punctuation">.</span>setLocalDescription <span class="token punctuation">(</span>desc<span class="token punctuation">)</span> <span class="token operator">|&gt;</span> Promise<span class="token punctuation">.</span>start
    <span class="token keyword">if</span> isNull desc<span class="token punctuation">.</span>sdp <span class="token keyword">then</span>
      internalLog <span class="token string">"Local description is empty"</span>
    <span class="token keyword">else</span>
      desc
      <span class="token operator">|&gt;</span> Base64<span class="token punctuation">.</span>``<span class="token keyword">to</span>``
      <span class="token operator">|&gt;</span> Signaling<span class="token punctuation">.</span>WebRTCOffer<span class="token punctuation">.</span>Offer
      <span class="token operator">|&gt;</span> Signaling<span class="token punctuation">.</span>Notification<span class="token punctuation">.</span>Offer
      <span class="token operator">|&gt;</span> onSignal<span class="token punctuation">)</span>

  <span class="token operator">|&gt;</span> Promise<span class="token punctuation">.</span>catch <span class="token punctuation">(</span>sprintf <span class="token string">"On negotation needed return error: %A"</span> <span class="token operator">&gt;&gt;</span> internalLog<span class="token punctuation">)</span>
  <span class="token operator">|&gt;</span> Promise<span class="token punctuation">.</span><span class="token computation-expression keyword">start</span>

  <span class="token punctuation">{</span> Peer <span class="token operator">=</span> pc
    Channel <span class="token operator">=</span> channel <span class="token punctuation">}</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">We send <code>Offer</code> via Ably channel and set it as <code>LocalDescription</code> via <code>setLocalDescription</code> method on <code>PeerConnection</code> object. Right now the application flow is not visible when we look at the code at first. The other side of communication should receive <code>Offer</code> via Ably channel which would be then propagated as <code>Offer</code> Elmish message and handle in <code>update</code> method.</p></div><div class="el-pre"><pre class="language-fsharp" tabindex="0"><code data-line="0" class="language-fsharp is-loaded"><span class="token keyword">let</span> setOffer <span class="token punctuation">(</span>lifecycle<span class="token punctuation">:</span> <span class="token class-name">LifecycleModel</span><span class="token punctuation">)</span> onSignal remote <span class="token operator">=</span>
  <span class="token keyword">try</span>
    <span class="token keyword">let</span> desc <span class="token operator">=</span> rtcSessionDescription remote
    internalLog <span class="token punctuation">(</span>sprintf <span class="token string">"setting offer: %A"</span> desc<span class="token punctuation">)</span>
    lifecycle<span class="token punctuation">.</span>Peer<span class="token punctuation">.</span>setRemoteDescription desc
    <span class="token operator">|&gt;</span> Promise<span class="token punctuation">.</span>catch <span class="token punctuation">(</span>sprintf <span class="token string">"Failed to set remote description: %A"</span> <span class="token operator">&gt;&gt;</span> internalLog<span class="token punctuation">)</span>
    <span class="token operator">|&gt;</span> Promise<span class="token punctuation">.</span>start
    lifecycle<span class="token punctuation">.</span>Peer<span class="token punctuation">.</span><span class="token function">createAnswer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>``<span class="token keyword">then</span>``<span class="token punctuation">(</span><span class="token keyword">fun</span> desc <span class="token operator">-&gt;</span>
      lifecycle<span class="token punctuation">.</span>Peer<span class="token punctuation">.</span>setLocalDescription <span class="token punctuation">(</span>desc<span class="token punctuation">)</span> <span class="token operator">|&gt;</span> Promise<span class="token punctuation">.</span>start
      <span class="token keyword">if</span> isNull desc<span class="token punctuation">.</span>sdp <span class="token keyword">then</span>
        internalLog <span class="token string">"Local description is empty"</span>
      <span class="token keyword">else</span>
        internalLog <span class="token punctuation">(</span>sprintf <span class="token string">"sending answer: %A"</span> desc<span class="token punctuation">)</span>
        desc
        <span class="token operator">|&gt;</span> Base64<span class="token punctuation">.</span>``<span class="token keyword">to</span>``
        <span class="token operator">|&gt;</span> Signaling<span class="token punctuation">.</span>WebRTCAnswer<span class="token punctuation">.</span>Answer
        <span class="token operator">|&gt;</span> Signaling<span class="token punctuation">.</span>Notification<span class="token punctuation">.</span>Answer
        <span class="token operator">|&gt;</span> onSignal<span class="token punctuation">)</span>

    <span class="token operator">|&gt;</span> Promise<span class="token punctuation">.</span>catch <span class="token punctuation">(</span>sprintf <span class="token string">"On negotation needed errored with: %A"</span> <span class="token operator">&gt;&gt;</span> internalLog<span class="token punctuation">)</span>
    <span class="token operator">|&gt;</span> Promise<span class="token punctuation">.</span>start
  <span class="token keyword">with</span> e <span class="token operator">-&gt;</span>
    internalLog <span class="token punctuation">(</span>sprintf <span class="token string">"Error occured while adding remote description: %A"</span> e<span class="token punctuation">)</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">It should set <code>Offer</code> from a <code>sender</code> as a <code>RemoteDescription</code> on a <code>receiver</code> side and in case of success generate <code>Answer</code>. It would be sent to the <code>sender</code> via Ably. The important thing to mention here is that after the creation of <code>Offer</code>/<code>Answer</code> <code>Candidates</code> are generated. They shouldn’t be set on the <code>PeerConnection</code> object before setting <code>Local</code> and <code>Remote</code> descriptions. Because of that Elmish model has a buffer for <code>Candidates</code> that could be received before setting <code>Remote</code>/<code>Local</code> descriptions.</p></div><div class="el-p"><p dir="auto">Buffor handling:</p></div><div class="el-pre"><pre class="language-fsharp" tabindex="0"><code data-line="0" class="language-fsharp is-loaded"><span class="token keyword">if</span> model<span class="token punctuation">.</span>WaitingCandidates<span class="token punctuation">.</span>Length <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token keyword">then</span>
  model<span class="token punctuation">.</span>WaitingCandidates
  <span class="token operator">|&gt;</span> List<span class="token punctuation">.</span>iter <span class="token punctuation">(</span>WebRTC<span class="token punctuation">.</span>setCandidate peer <span class="token punctuation">)</span>
  <span class="token punctuation">{</span> model <span class="token keyword">with</span>
              ConnectionState <span class="token operator">=</span> WebRTC<span class="token punctuation">.</span>ConnectionState<span class="token punctuation">.</span>Connecting
              WaitingCandidates <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> Cmd<span class="token punctuation">.</span>none
<span class="token keyword">else</span>
  <span class="token punctuation">{</span> model <span class="token keyword">with</span> ConnectionState <span class="token operator">=</span> WebRTC<span class="token punctuation">.</span>ConnectionState<span class="token punctuation">.</span>Connecting <span class="token punctuation">}</span><span class="token punctuation">,</span> Cmd<span class="token punctuation">.</span>none
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">Handling a message that contains <code>Candidates</code> looks like that.</p></div><div class="el-pre"><pre class="language-fsharp" tabindex="0"><code data-line="0" class="language-fsharp is-loaded"><span class="token keyword">if</span> model<span class="token punctuation">.</span>ConnectionState <span class="token operator">&lt;&gt;</span> WebRTC<span class="token punctuation">.</span>ConnectionState<span class="token punctuation">.</span>NotConnected <span class="token keyword">then</span>
  WebRTC<span class="token punctuation">.</span>setCandidate peer candidate
  model<span class="token punctuation">,</span> Cmd<span class="token punctuation">.</span>none
<span class="token keyword">else</span>
  <span class="token punctuation">{</span> model <span class="token keyword">with</span> WaitingCandidates <span class="token operator">=</span> candidate<span class="token operator">::</span>model<span class="token punctuation">.</span>WaitingCandidates <span class="token punctuation">}</span><span class="token punctuation">,</span> Cmd<span class="token punctuation">.</span>none
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto"><code>ConnectionState</code> is set when <code>Offer</code> or <code>Answer</code> are received or when the <code>DataChannel</code> is open.</p></div><div class="el-p"><p dir="auto">Handling <code>Answer</code>.</p></div><div class="el-pre"><pre class="language-fsharp" tabindex="0"><code data-line="0" class="language-fsharp is-loaded"><span class="token operator">|</span> WebRTC <span class="token punctuation">(</span>WebRTC<span class="token punctuation">.</span>Msg<span class="token punctuation">.</span>Answer answer<span class="token punctuation">)</span> <span class="token operator">-&gt;</span>
  WebRTC<span class="token punctuation">.</span>setAnswer peer <span class="token computation-expression keyword">answer</span>
  <span class="token punctuation">{</span> model <span class="token keyword">with</span> ConnectionState <span class="token operator">=</span> WebRTC<span class="token punctuation">.</span>ConnectionState<span class="token punctuation">.</span>Connecting <span class="token punctuation">}</span><span class="token punctuation">,</span> Cmd<span class="token punctuation">.</span>none
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">Going to <code>setAnswer</code> implementation.</p></div><div class="el-pre"><pre class="language-fsharp" tabindex="0"><code data-line="0" class="language-fsharp is-loaded"><span class="token keyword">let</span> setAnswer <span class="token punctuation">(</span>lifecycle<span class="token punctuation">:</span> <span class="token class-name">LifecycleModel</span><span class="token punctuation">)</span> remote <span class="token operator">=</span>
  <span class="token keyword">try</span>
    <span class="token keyword">let</span> desc <span class="token operator">=</span> rtcSessionDescription remote
    internalLog <span class="token punctuation">(</span>sprintf <span class="token string">"setting answer: %A"</span> desc<span class="token punctuation">)</span>
    lifecycle<span class="token punctuation">.</span>Peer<span class="token punctuation">.</span>setRemoteDescription desc
    <span class="token operator">|&gt;</span> Promise<span class="token punctuation">.</span>catch <span class="token punctuation">(</span>sprintf <span class="token string">"Failed to set remote description: %A"</span> <span class="token operator">&gt;&gt;</span> internalLog<span class="token punctuation">)</span>
    <span class="token operator">|&gt;</span> Promise<span class="token punctuation">.</span>start
  <span class="token keyword">with</span> e <span class="token operator">-&gt;</span>
    internalLog <span class="token punctuation">(</span>sprintf <span class="token string">"Error occured while adding remote description: %A"</span> e<span class="token punctuation">)</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">As we could see, we only set <code>RemoteDescription</code> on a <code>PeerConnection</code> object here.</p></div><div class="el-p"><p dir="auto">Right now, if everything succeeds, we should have a WebRTC connection ready. DataChannel is open between our peers. We could go to the code which is responsible for sending files. In UI, there should be a <code>textBox</code> that reacts on a file drop.</p></div><div class="el-p"><p dir="auto"><img alt="send" src="https://mnie.github.com/img/2021_01_05_webrtc_ably/send.png" referrerpolicy="no-referrer"></p></div><div class="el-p"><p dir="auto">Which is handled in the following way.</p></div><div class="el-pre"><pre class="language-fsharp" tabindex="0"><code data-line="0" class="language-fsharp is-loaded">Field<span class="token punctuation">.</span>div <span class="token punctuation">[</span>
  Field<span class="token punctuation">.</span>IsGrouped <span class="token punctuation">]</span> <span class="token punctuation">[</span>
  Control<span class="token punctuation">.</span>p <span class="token punctuation">[</span> Control<span class="token punctuation">.</span>IsExpanded <span class="token punctuation">]</span> <span class="token punctuation">[</span>
    div <span class="token punctuation">[</span>   
      Class <span class="token string">"card border-primary"</span>
      Draggable <span class="token keyword">true</span>
      Style <span class="token punctuation">[</span> Height <span class="token string">"100px"</span> <span class="token punctuation">]</span>
      OnDragOver <span class="token punctuation">(</span> <span class="token keyword">fun</span> e <span class="token operator">-&gt;</span>
        e<span class="token punctuation">.</span><span class="token function">preventDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">)</span>
      OnDrop <span class="token punctuation">(</span> <span class="token keyword">fun</span> e <span class="token operator">-&gt;</span>
        e<span class="token punctuation">.</span><span class="token function">preventDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> e<span class="token punctuation">.</span>dataTransfer<span class="token punctuation">.</span>files<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token keyword">then</span>
          <span class="token keyword">let</span> file <span class="token operator">=</span> e<span class="token punctuation">.</span>dataTransfer<span class="token punctuation">.</span>files<span class="token punctuation">.</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
          <span class="token punctuation">{</span> Name <span class="token operator">=</span> file<span class="token punctuation">.</span>name<span class="token punctuation">;</span> Data <span class="token operator">=</span> file<span class="token punctuation">.</span>slice <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">}</span>
          <span class="token operator">|&gt;</span> SendFile
          <span class="token operator">|&gt;</span> dispatch
      <span class="token punctuation">)</span>
    <span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">]</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto"><code>SendFile</code> message handling.</p></div><div class="el-pre"><pre class="language-fsharp" tabindex="0"><code data-line="0" class="language-fsharp is-loaded"><span class="token operator">|</span> SendFile file <span class="token operator">-&gt;</span>
  MessageTransfer<span class="token punctuation">.</span>send peer <span class="token punctuation">(</span>ChannelMessage<span class="token punctuation">.</span>File file<span class="token punctuation">.</span>Data<span class="token punctuation">)</span>
  model<span class="token punctuation">,</span> Cmd<span class="token punctuation">.</span>none
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">Method <code>send</code> in <code>MessageTransfer</code>.</p></div><div class="el-pre"><pre class="language-fsharp" tabindex="0"><code data-line="0" class="language-fsharp is-loaded"><span class="token keyword">let</span> send <span class="token punctuation">(</span>lifecycle<span class="token punctuation">:</span> <span class="token class-name">LifecycleModel</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>msg<span class="token punctuation">:</span> <span class="token class-name">ChannelMessage</span><span class="token punctuation">)</span> <span class="token operator">=</span>
  <span class="token keyword">match</span> msg<span class="token punctuation">,</span> lifecycle<span class="token punctuation">.</span>Channel <span class="token keyword">with</span>
  <span class="token operator">|</span> File blob<span class="token punctuation">,</span> Some channel <span class="token operator">-&gt;</span>
    blob
    <span class="token operator">|&gt;</span> U4<span class="token punctuation">.</span>Case2
    <span class="token operator">|&gt;</span> channel<span class="token punctuation">.</span>send
  <span class="token operator">|</span> _<span class="token punctuation">,</span> _ <span class="token operator">-&gt;</span> log <span class="token string">"MessageTransfer"</span> <span class="token punctuation">(</span>sprintf <span class="token string">"Unable to process: %A channel is: %A"</span> msg lifecycle<span class="token punctuation">.</span>Channel<span class="token punctuation">)</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">On a <code>receiver</code> side <code>onmessage</code> handling on <code>DataChannel</code> object looks as follows.</p></div><div class="el-pre"><pre class="language-fsharp" tabindex="0"><code data-line="0" class="language-fsharp is-loaded">channel<span class="token punctuation">.</span>onmessage <span class="token operator">&lt;-</span>
  <span class="token keyword">fun</span> e <span class="token operator">-&gt;</span>
    internalLog <span class="token punctuation">(</span>sprintf <span class="token string">"received msg in channel: %A"</span> e<span class="token punctuation">.</span>data<span class="token punctuation">)</span>
    <span class="token keyword">let</span> blob <span class="token operator">=</span> e<span class="token punctuation">.</span>data <span class="token operator">:?&gt;</span> <span class="token class-name">Blob</span>
    msgHandler blob
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">As we could see, just for simplicity we assume that only javascript <code>blob</code> would be sent via <code>DataChannel</code>. We pass there also a <code>msgHandler</code> which is implemented in the following way.</p></div><div class="el-pre"><pre class="language-fsharp" tabindex="0"><code data-line="0" class="language-fsharp is-loaded"><span class="token keyword">let</span> download <span class="token punctuation">(</span>data<span class="token punctuation">:</span> <span class="token class-name">Blob</span><span class="token punctuation">)</span> <span class="token operator">=</span>
  <span class="token keyword">let</span> url <span class="token operator">=</span> Browser<span class="token punctuation">.</span>Url<span class="token punctuation">.</span>URL<span class="token punctuation">.</span>createObjectURL data
  <span class="token keyword">let</span> <span class="token keyword">mutable</span> anchor <span class="token operator">=</span> document<span class="token punctuation">.</span>createElement <span class="token string">"a"</span>
  anchor<span class="token punctuation">.</span>hidden <span class="token operator">&lt;-</span> <span class="token keyword">true</span>
  anchor<span class="token punctuation">.</span>setAttribute <span class="token punctuation">(</span><span class="token string">"href"</span><span class="token punctuation">,</span> url<span class="token punctuation">)</span>
  anchor<span class="token punctuation">.</span>setAttribute <span class="token punctuation">(</span><span class="token string">"download"</span><span class="token punctuation">,</span> <span class="token string">"image.png"</span><span class="token punctuation">)</span>
  document<span class="token punctuation">.</span>body<span class="token punctuation">.</span>appendChild anchor <span class="token operator">|&gt;</span> ignore
  anchor<span class="token punctuation">.</span>click <span class="token punctuation">(</span><span class="token punctuation">)</span>
  document<span class="token punctuation">.</span>body<span class="token punctuation">.</span>removeChild anchor <span class="token operator">|&gt;</span> ignore
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">Its responsibility is to receive a <code>FileBlob</code> and immediately download it. We assume that the file would be always a <code>png</code> with the name <code>image</code>.</p></div><div class="el-p"><p dir="auto">To sum up, thanks to the <code>Ably</code> platform I was able to implement <code>Signaling</code> in a simple way which would be worth consideration during the decision-making phase about “how to achieve Signaling in a most performant way” in my daily work. During some initial tests to compare it with standard HTTP request/response, it looks promising.</p></div><div class="el-p"><p dir="auto">Another interesting thing is that a user can see how the messages/connections flow and work on the <code>Ably</code> dashboard. There is also an information about used quota.</p></div><div class="el-p"><p dir="auto"><img alt="chart" src="https://mnie.github.com/img/2021_01_05_webrtc_ably/chart.png" referrerpolicy="no-referrer"> <img alt="quota" src="https://mnie.github.com/img/2021_01_05_webrtc_ably/quota.png" referrerpolicy="no-referrer"></p></div><div class="el-p"><p dir="auto">Because there are no built-in signaling solutions Ably is for sure an almost <code>ready to go</code> alternative which we could use in our scenario. I hope I would be able to compare it with other ways to do signaling in the next articles.</p></div><div class="el-p"><p dir="auto"><a data-tooltip-position="top" aria-label="https://github.com/MNie/WebRTCSignaling" rel="noopener nofollow" class="external-link" href="https://github.com/MNie/WebRTCSignaling" target="_blank">Repository</a></p></div><div class="el-p"><p dir="auto">I hope you enjoy it. Thanks for reading!</p></div><div class="mod-footer mod-ui"></div></div></div></div><div class="sidebar-right sidebar"><div class="sidebar-handle"></div><div class="sidebar-topbar"><div class="topbar-content"></div><div class="clickable-icon sidebar-collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" class="svg-icon"><path d="M21 3H3C1.89543 3 1 3.89543 1 5V19C1 20.1046 1.89543 21 3 21H21C22.1046 21 23 20.1046 23 19V5C23 3.89543 22.1046 3 21 3Z"></path><path d="M10 4V20"></path><path d="M4 7H7"></path><path d="M4 10H7"></path><path d="M4 13H7"></path></svg></div></div><div class="sidebar-content"><div class="graph-view-wrapper"><div class="sidebar-section-header">Interactive Graph</div><div class="graph-view-placeholder">
		<div class="graph-view-container">
			<div class="graph-icon graph-expand" role="button" aria-label="Expand" data-tooltip-position="top"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon"><line x1="7" y1="17" x2="17" y2="7"></line><polyline points="7 7 17 7 17 17"></polyline></svg></div>
			<canvas id="graph-canvas" class="hide" width="512px" height="512px"></canvas>
		</div>
		</div></div><div class="tree-container mod-root nav-folder tree-item outline-tree" data-depth="0"><div class="tree-header"><span class="sidebar-section-header">Table Of Contents</span><button class="clickable-icon collapse-tree-button" aria-label="Collapse All"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></svg></button></div><div class="tree-scroll-area tree-item-children nav-folder-children"><div class="tree-item mod-tree-folder nav-folder mod-collapsible is-collapsed" style="display: none;"></div><div class="tree-item" data-depth="1"><a class="tree-link" href="computer-science/programming-language/fsharp/signaling-in-webrtc-with-ably-and-fable.html#Signaling in WebRTC with Ably and Fable"><div class="tree-item-contents heading-link" heading-name="Signaling in WebRTC with Ably and Fable"><span class="tree-item-title">Signaling in WebRTC with Ably and Fable</span></div></a><div class="tree-item-children nav-folder-children"></div></div></div></div></div><script defer="">let rs = document.querySelector(".sidebar-right"); rs.classList.add("is-collapsed"); if (window.innerWidth > 768) rs.classList.remove("is-collapsed"); rs.style.setProperty("--sidebar-width", localStorage.getItem("sidebar-right-width"));</script></div></div></body></html>