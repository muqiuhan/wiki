<!DOCTYPE html> <html><head>
		<title>Building custom fibers library in FSharp</title>
		<base href="../../../">
		<meta id="root-path" root-path="../../../">
		<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes, minimum-scale=1.0, maximum-scale=5.0">
		<meta charset="UTF-8">
		<meta name="description" content="韩暮秋的个人维基 - Building custom fibers library in FSharp">
		<meta property="og:title" content="Building custom fibers library in FSharp">
		<meta property="og:description" content="韩暮秋的个人维基 - Building custom fibers library in FSharp">
		<meta property="og:type" content="website">
		<meta property="og:url" content="https://muqiuhan.github.io/wiki/computer-science/programming-language/fsharp/building-custom-fibers-library-in-fsharp.html">
		<meta property="og:image" content="undefined">
		<meta property="og:site_name" content="韩暮秋的个人维基">
		<meta name="author" content="韩暮秋"><link rel="alternate" type="application/rss+xml" title="RSS Feed" href="https://muqiuhan.github.io/wiki/lib/rss.xml"><script async="" id="webpage-script" src="lib/scripts/webpage.js" onload="this.onload=null;this.setAttribute(&quot;loaded&quot;, &quot;true&quot;)"></script><script type="module" async="" id="graph-view-script" src="lib/scripts/graph-view.js"></script><script async="" id="graph-wasm-script" src="lib/scripts/graph-wasm.js" onload="this.onload=null;this.setAttribute(&quot;loaded&quot;, &quot;true&quot;)"></script><script async="" id="graph-render-worker-script" src="lib/scripts/graph-render-worker.js" onload="this.onload=null;this.setAttribute(&quot;loaded&quot;, &quot;true&quot;)"></script><script async="" id="tinycolor-script" src="lib/scripts/tinycolor.js" onload="this.onload=null;this.setAttribute(&quot;loaded&quot;, &quot;true&quot;)"></script><script async="" id="pixi-script" src="lib/scripts/pixi.js" onload="this.onload=null;this.setAttribute(&quot;loaded&quot;, &quot;true&quot;)"></script><script async="" id="minisearch-script" src="lib/scripts/minisearch.js" onload="this.onload=null;this.setAttribute(&quot;loaded&quot;, &quot;true&quot;)"></script><link rel="icon" href="lib/media/favicon.png"><script async="" id="graph-data-script" src="lib/scripts/graph-data.js" onload="this.onload=null;this.setAttribute(&quot;loaded&quot;, &quot;true&quot;)"></script><style>body{--line-width:40em;--line-width-adaptive:40em;--file-line-width:40em;--sidebar-width:min(20em, 80vw);--collapse-arrow-size:11px;--tree-horizontal-spacing:0.6em;--tree-vertical-spacing:0.6em;--sidebar-margin:12px}.sidebar{height:100%;min-width:calc(var(--sidebar-width) + var(--divider-width-hover));max-width:calc(var(--sidebar-width) + var(--divider-width-hover));font-size:14px;z-index:10;position:relative;overflow:hidden;transition:min-width ease-in-out,max-width ease-in-out;transition-duration:.2s;contain:size}.sidebar-left{left:0}.sidebar-right{right:0}.sidebar.is-collapsed{min-width:0;max-width:0}body.floating-sidebars .sidebar{position:absolute}.sidebar-content{height:100%;min-width:calc(var(--sidebar-width) - var(--divider-width-hover));top:0;padding:var(--sidebar-margin);padding-top:4em;line-height:var(--line-height-tight);background-color:var(--background-secondary);transition:background-color,border-right,border-left,box-shadow;transition-duration:var(--color-fade-speed);transition-timing-function:ease-in-out;position:absolute;display:flex;flex-direction:column}.sidebar:not(.is-collapsed) .sidebar-content{min-width:calc(max(100%,var(--sidebar-width)) - 3px);max-width:calc(max(100%,var(--sidebar-width)) - 3px)}.sidebar-left .sidebar-content{left:0;border-top-right-radius:var(--radius-l);border-bottom-right-radius:var(--radius-l)}.sidebar-right .sidebar-content{right:0;border-top-left-radius:var(--radius-l);border-bottom-left-radius:var(--radius-l)}.sidebar:has(.sidebar-content:empty):has(.topbar-content:empty){display:none}.sidebar-topbar{height:2em;width:var(--sidebar-width);top:var(--sidebar-margin);padding-inline:var(--sidebar-margin);z-index:1;position:fixed;display:flex;align-items:center;transition:width ease-in-out;transition-duration:inherit}.sidebar.is-collapsed .sidebar-topbar{width:calc(2.3em + var(--sidebar-margin) * 2)}.sidebar .sidebar-topbar.is-collapsed{width:0}.sidebar-left .sidebar-topbar{left:0}.sidebar-right .sidebar-topbar{right:0}.topbar-content{overflow:hidden;overflow:clip;width:100%;height:100%;display:flex;align-items:center;transition:inherit}.sidebar.is-collapsed .topbar-content{width:0;transition:inherit}.clickable-icon.sidebar-collapse-icon{background-color:transparent;color:var(--icon-color-focused);padding:0!important;margin:0!important;height:100%!important;width:2.3em!important;margin-inline:0.14em!important;position:absolute}.sidebar-left .clickable-icon.sidebar-collapse-icon{transform:rotateY(180deg);right:var(--sidebar-margin)}.sidebar-right .clickable-icon.sidebar-collapse-icon{transform:rotateY(180deg);left:var(--sidebar-margin)}.clickable-icon.sidebar-collapse-icon svg.svg-icon{width:100%;height:100%}.sidebar-section-header{margin:0 0 1em 0;text-transform:uppercase;letter-spacing:.06em;font-weight:600}body{transition:background-color var(--color-fade-speed) ease-in-out}.webpage-container{display:flex;flex-direction:row;height:100%;width:100%;align-items:stretch;justify-content:center}.document-container{opacity:1;flex-basis:100%;max-width:100%;width:100%;height:100%;display:flex;flex-direction:column;align-items:center;transition:opacity .2s ease-in-out;contain:inline-size}.hide{opacity:0;transition:opacity .2s ease-in-out}.document-container>.markdown-preview-view{margin:var(--sidebar-margin);margin-bottom:0;width:100%;width:-webkit-fill-available;width:-moz-available;width:fill-available;background-color:var(--background-primary);transition:background-color var(--color-fade-speed) ease-in-out;border-top-right-radius:var(--window-radius,var(--radius-m));border-top-left-radius:var(--window-radius,var(--radius-m));overflow-x:hidden!important;overflow-y:auto!important;display:flex!important;flex-direction:column!important;align-items:center!important;contain:inline-size}.document-container>.markdown-preview-view>.markdown-preview-sizer{padding-bottom:80vh!important;width:100%!important;max-width:var(--line-width)!important;flex-basis:var(--line-width)!important;transition:background-color var(--color-fade-speed) ease-in-out;contain:inline-size}.markdown-rendered img:not([width]),.view-content img:not([width]){max-width:100%;outline:0}.document-container>.view-content.embed{display:flex;padding:1em;height:100%;width:100%;align-items:center;justify-content:center}.document-container>.view-content.embed>*{max-width:100%;max-height:100%;object-fit:contain}:has(> :is(.math,table)){overflow-x:auto!important}.document-container>.view-content{overflow-x:auto;contain:content;padding:0;margin:0;height:100%}.scroll-highlight{position:absolute;width:100%;height:100%;pointer-events:none;z-index:1000;background-color:hsla(var(--color-accent-hsl),.25);opacity:0;padding:1em;inset:50%;translate:-50% -50%;border-radius:var(--radius-s)}</style><script defer="">async function loadIncludes(){if("file:"!=location.protocol){let e=document.querySelectorAll("include");for(let t=0;t<e.length;t++){let o=e[t],l=o.getAttribute("src");try{const e=await fetch(l);if(!e.ok){console.log("Could not include file: "+l),o?.remove();continue}let t=await e.text(),n=document.createRange().createContextualFragment(t),i=Array.from(n.children);for(let e of i)e.classList.add("hide"),e.style.transition="opacity 0.5s ease-in-out",setTimeout((()=>{e.classList.remove("hide")}),10);o.before(n),o.remove(),console.log("Included file: "+l)}catch(e){o?.remove(),console.log("Could not include file: "+l,e);continue}}}else{if(document.querySelectorAll("include").length>0){var e=document.createElement("div");e.id="error",e.textContent="Web server exports must be hosted on an http / web server to be viewed correctly.",e.style.position="fixed",e.style.top="50%",e.style.left="50%",e.style.transform="translate(-50%, -50%)",e.style.fontSize="1.5em",e.style.fontWeight="bold",e.style.textAlign="center",document.body.appendChild(e),document.querySelector(".document-container")?.classList.remove("hide")}}}document.addEventListener("DOMContentLoaded",(()=>{loadIncludes()}));let isFileProtocol="file:"==location.protocol;function waitLoadScripts(e,t){let o=e.map((e=>document.getElementById(e+"-script"))),l=0;!function e(){let n=o[l];l++,n&&"true"!=n.getAttribute("loaded")||l<o.length&&e(),l<o.length?n.addEventListener("load",e):t()}()}</script><link rel="stylesheet" href="lib/styles/obsidian.css"><link rel="preload" href="lib/styles/other-plugins.css" as="style" onload="this.onload=null;this.rel='stylesheet'"><noscript><link rel="stylesheet" href="lib/styles/other-plugins.css"></noscript><link rel="stylesheet" href="lib/styles/theme.css"><link rel="preload" href="lib/styles/global-variable-styles.css" as="style" onload="this.onload=null;this.rel='stylesheet'"><noscript><link rel="stylesheet" href="lib/styles/global-variable-styles.css"></noscript><link rel="preload" href="lib/styles/supported-plugins.css" as="style" onload="this.onload=null;this.rel='stylesheet'"><noscript><link rel="stylesheet" href="lib/styles/supported-plugins.css"></noscript><link rel="preload" href="lib/styles/main-styles.css" as="style" onload="this.onload=null;this.rel='stylesheet'"><noscript><link rel="stylesheet" href="lib/styles/main-styles.css"></noscript></head><body class="publish css-settings-manager theme-light show-inline-title show-ribbon outliner-plugin-dnd custom-accent ribbon-default special-h6 float-center"><script defer="">let theme=localStorage.getItem("theme")||(window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light");"dark"==theme?(document.body.classList.add("theme-dark"),document.body.classList.remove("theme-light")):(document.body.classList.add("theme-light"),document.body.classList.remove("theme-dark")),window.innerWidth<480?document.body.classList.add("is-phone"):window.innerWidth<768?document.body.classList.add("is-tablet"):window.innerWidth<1024?document.body.classList.add("is-small-screen"):document.body.classList.add("is-large-screen")</script><div class="webpage-container workspace"><div class="sidebar-left sidebar"><div class="sidebar-handle"></div><div class="sidebar-topbar"><div class="topbar-content"><label class="theme-toggle-container" for="theme_toggle"><input class="theme-toggle-input" type="checkbox" id="theme_toggle"><div class="toggle-background"></div></label></div><div class="clickable-icon sidebar-collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" class="svg-icon"><path d="M21 3H3C1.89543 3 1 3.89543 1 5V19C1 20.1046 1.89543 21 3 21H21C22.1046 21 23 20.1046 23 19V5C23 3.89543 22.1046 3 21 3Z"></path><path d="M10 4V20"></path><path d="M4 7H7"></path><path d="M4 10H7"></path><path d="M4 13H7"></path></svg></div></div><div class="sidebar-content"><div class="search-input-container"><input enterkeyhint="search" type="search" spellcheck="false" placeholder="Search..."><div class="search-input-clear-button" aria-label="Clear search"></div></div><include src="lib/html/file-tree.html"></include></div><script defer="">let ls = document.querySelector(".sidebar-left"); ls.classList.add("is-collapsed"); if (window.innerWidth > 768) ls.classList.remove("is-collapsed"); ls.style.setProperty("--sidebar-width", localStorage.getItem("sidebar-left-width"));</script></div><div class="document-container markdown-reading-view hide"><div class="markdown-preview-view markdown-rendered allow-fold-headings allow-fold-lists is-readable-line-width"><style id="MJX-CHTML-styles">mjx-munder{display:inline-block;text-align:left}mjx-over{text-align:left}mjx-munder:not([limits=false]){display:inline-table}mjx-munder>mjx-row{text-align:left}mjx-under{padding-bottom:.1em}mjx-msub{display:inline-block;text-align:left}mjx-c.mjx-c1D436.TEX-I::before{padding:.705em .76em .022em 0;content:"C"}mjx-c.mjx-c3D::before{padding:.583em .778em .082em 0;content:"="}mjx-c.mjx-c2211.TEX-S2::before{padding:.95em 1.444em .45em 0;content:"∑"}mjx-c.mjx-c1D45D.TEX-I::before{padding:.442em .503em .194em 0;content:"p"}mjx-c.mjx-c1D461.TEX-I::before{padding:.626em .361em .011em 0;content:"t"}mjx-mtext{display:inline-block;text-align:left}mjx-container[jax=CHTML]{line-height:0}mjx-container [space="1"]{margin-left:.111em}mjx-container [space="2"]{margin-left:.167em}mjx-container [space="3"]{margin-left:.222em}mjx-container [space="4"]{margin-left:.278em}mjx-container [space="5"]{margin-left:.333em}mjx-container [rspace="1"]{margin-right:.111em}mjx-container [rspace="2"]{margin-right:.167em}mjx-container [rspace="3"]{margin-right:.222em}mjx-container [rspace="4"]{margin-right:.278em}mjx-container [rspace="5"]{margin-right:.333em}mjx-container [size="s"]{font-size:70.7%}mjx-container [size=ss]{font-size:50%}mjx-container [size=Tn]{font-size:60%}mjx-container [size=sm]{font-size:85%}mjx-container [size=lg]{font-size:120%}mjx-container [size=Lg]{font-size:144%}mjx-container [size=LG]{font-size:173%}mjx-container [size=hg]{font-size:207%}mjx-container [size=HG]{font-size:249%}mjx-container [width=full]{width:100%}mjx-box{display:inline-block}mjx-block{display:block}mjx-itable{display:inline-table}mjx-row{display:table-row}mjx-row>*{display:table-cell}mjx-mtext{display:inline-block}mjx-mstyle{display:inline-block}mjx-merror{display:inline-block;color:red;background-color:#ff0}mjx-mphantom{visibility:hidden}mjx-assistive-mml{top:0;left:0;clip:rect(1px,1px,1px,1px);user-select:none;position:absolute!important;padding:1px 0 0!important;border:0!important;display:block!important;width:auto!important;overflow:hidden!important}mjx-assistive-mml[display=block]{width:100%!important}mjx-math{display:inline-block;text-align:left;line-height:0;text-indent:0;font-style:normal;font-weight:400;font-size:100%;font-size-adjust:none;letter-spacing:normal;border-collapse:collapse;overflow-wrap:normal;word-spacing:normal;white-space:nowrap;direction:ltr;padding:1px 0}mjx-container[jax=CHTML][display=true]{display:block;text-align:center;margin:1em 0}mjx-container[jax=CHTML][display=true][width=full]{display:flex}mjx-container[jax=CHTML][display=true] mjx-math{padding:0}mjx-container[jax=CHTML][justify=left]{text-align:left}mjx-container[jax=CHTML][justify=right]{text-align:right}mjx-msup{display:inline-block;text-align:left}mjx-mi{display:inline-block;text-align:left}mjx-c{display:inline-block}mjx-utext{display:inline-block;padding:.75em 0 .2em}mjx-texatom{display:inline-block;text-align:left}mjx-mo{display:inline-block;text-align:left}mjx-stretchy-h{display:inline-table;width:100%}mjx-stretchy-h>*{display:table-cell;width:0}mjx-stretchy-h>*>mjx-c{display:inline-block;transform:scaleX(1)}mjx-stretchy-h>*>mjx-c::before{display:inline-block;width:initial}mjx-stretchy-h>mjx-ext{overflow:clip visible;width:100%}mjx-stretchy-h>mjx-ext>mjx-c::before{transform:scaleX(500)}mjx-stretchy-h>mjx-ext>mjx-c{width:0}mjx-stretchy-h>mjx-beg>mjx-c{margin-right:-.1em}mjx-stretchy-h>mjx-end>mjx-c{margin-left:-.1em}mjx-stretchy-v{display:inline-block}mjx-stretchy-v>*{display:block}mjx-stretchy-v>mjx-beg{height:0}mjx-stretchy-v>mjx-end>mjx-c{display:block}mjx-stretchy-v>*>mjx-c{transform:scaleY(1);transform-origin:left center;overflow:hidden}mjx-stretchy-v>mjx-ext{display:block;height:100%;box-sizing:border-box;border:0 solid transparent;overflow:visible clip}mjx-stretchy-v>mjx-ext>mjx-c::before{width:initial;box-sizing:border-box}mjx-stretchy-v>mjx-ext>mjx-c{transform:scaleY(500) translateY(.075em);overflow:visible}mjx-mark{display:inline-block;height:0}mjx-c::before{display:block;width:0}.MJX-TEX{font-family:MJXZERO,MJXTEX}.TEX-B{font-family:MJXZERO,MJXTEX-B}.TEX-I{font-family:MJXZERO,MJXTEX-I}.TEX-MI{font-family:MJXZERO,MJXTEX-MI}.TEX-BI{font-family:MJXZERO,MJXTEX-BI}.TEX-S1{font-family:MJXZERO,MJXTEX-S1}.TEX-S2{font-family:MJXZERO,MJXTEX-S2}.TEX-S3{font-family:MJXZERO,MJXTEX-S3}.TEX-S4{font-family:MJXZERO,MJXTEX-S4}.TEX-A{font-family:MJXZERO,MJXTEX-A}.TEX-C{font-family:MJXZERO,MJXTEX-C}.TEX-CB{font-family:MJXZERO,MJXTEX-CB}.TEX-FR{font-family:MJXZERO,MJXTEX-FR}.TEX-FRB{font-family:MJXZERO,MJXTEX-FRB}.TEX-SS{font-family:MJXZERO,MJXTEX-SS}.TEX-SSB{font-family:MJXZERO,MJXTEX-SSB}.TEX-SSI{font-family:MJXZERO,MJXTEX-SSI}.TEX-SC{font-family:MJXZERO,MJXTEX-SC}.TEX-T{font-family:MJXZERO,MJXTEX-T}.TEX-V{font-family:MJXZERO,MJXTEX-V}.TEX-VB{font-family:MJXZERO,MJXTEX-VB}mjx-stretchy-h mjx-c,mjx-stretchy-v mjx-c{font-family:MJXZERO,MJXTEX-S1,MJXTEX-S4,MJXTEX,MJXTEX-A!important}@font-face{font-family:MJXZERO;src:url("lib/fonts/mathjax_zero.woff") format("woff")}@font-face{font-family:MJXTEX;src:url("lib/fonts/mathjax_main-regular.woff") format("woff")}@font-face{font-family:MJXTEX-B;src:url("lib/fonts/mathjax_main-bold.woff") format("woff")}@font-face{font-family:MJXTEX-I;src:url("lib/fonts/mathjax_math-italic.woff") format("woff")}@font-face{font-family:MJXTEX-MI;src:url("lib/fonts/mathjax_main-italic.woff") format("woff")}@font-face{font-family:MJXTEX-BI;src:url("lib/fonts/mathjax_math-bolditalic.woff") format("woff")}@font-face{font-family:MJXTEX-S1;src:url("lib/fonts/mathjax_size1-regular.woff") format("woff")}@font-face{font-family:MJXTEX-S2;src:url("lib/fonts/mathjax_size2-regular.woff") format("woff")}@font-face{font-family:MJXTEX-S3;src:url("lib/fonts/mathjax_size3-regular.woff") format("woff")}@font-face{font-family:MJXTEX-S4;src:url("lib/fonts/mathjax_size4-regular.woff") format("woff")}@font-face{font-family:MJXTEX-A;src:url("lib/fonts/mathjax_ams-regular.woff") format("woff")}@font-face{font-family:MJXTEX-C;src:url("lib/fonts/mathjax_calligraphic-regular.woff") format("woff")}@font-face{font-family:MJXTEX-CB;src:url("lib/fonts/mathjax_calligraphic-bold.woff") format("woff")}@font-face{font-family:MJXTEX-FR;src:url("lib/fonts/mathjax_fraktur-regular.woff") format("woff")}@font-face{font-family:MJXTEX-FRB;src:url("lib/fonts/mathjax_fraktur-bold.woff") format("woff")}@font-face{font-family:MJXTEX-SS;src:url("lib/fonts/mathjax_sansserif-regular.woff") format("woff")}@font-face{font-family:MJXTEX-SSB;src:url("lib/fonts/mathjax_sansserif-bold.woff") format("woff")}@font-face{font-family:MJXTEX-SSI;src:url("lib/fonts/mathjax_sansserif-italic.woff") format("woff")}@font-face{font-family:MJXTEX-SC;src:url("lib/fonts/mathjax_script-regular.woff") format("woff")}@font-face{font-family:MJXTEX-T;src:url("lib/fonts/mathjax_typewriter-regular.woff") format("woff")}@font-face{font-family:MJXTEX-V;src:url("lib/fonts/mathjax_vector-regular.woff") format("woff")}@font-face{font-family:MJXTEX-VB;src:url("lib/fonts/mathjax_vector-bold.woff") format("woff")}mjx-c.mjx-c1D447.TEX-I::before{padding:.677em .704em 0 0;content:"T"}mjx-c.mjx-c1D450.TEX-I::before{padding:.442em .433em .011em 0;content:"c"}mjx-c.mjx-c2C::before{padding:.121em .278em .194em 0;content:","}mjx-c.mjx-c2E::before{padding:.12em .278em 0 0;content:"."}</style><div class="markdown-preview-sizer markdown-preview-section"><h1 class="page-title heading inline-title" id="Building custom fibers library in FSharp"><p dir="auto">Building custom fibers library in FSharp</p></h1><div class="el-p"><p dir="auto"><a href="?query=tag:fp" class="tag" target="_blank" rel="noopener nofollow">#fp</a> <a href="?query=tag:coroutines" class="tag" target="_blank" rel="noopener nofollow">#coroutines</a> <a href="?query=tag:fsharp" class="tag" target="_blank" rel="noopener nofollow">#fsharp</a></p></div><div class="el-p"><p dir="auto">Over the course of last few months on this blog post, I've been sharing about internals and how-to of different concurrency patters. We discussed how to <a data-tooltip-position="top" aria-label="https://www.bartoszsypytkowski.com/build-your-own-actor-model/" rel="noopener nofollow" class="external-link" href="https://www.bartoszsypytkowski.com/build-your-own-actor-model/" target="_blank">implement our own actors</a> and specific <a data-tooltip-position="top" aria-label="https://www.bartoszsypytkowski.com/thread-safety-with-affine-thread-pools/" rel="noopener nofollow" class="external-link" href="https://www.bartoszsypytkowski.com/thread-safety-with-affine-thread-pools/" target="_blank">affinity-based thread pool</a>. Today we'll focus of the most dominant pattern present in modern programming nowadays: fibers, also known as coroutines, futures, tasks, green threads or user-space threads.</p></div><div class="el-p"><p dir="auto">The general idea is simple - we want a fine-grained concurrency primitive, that will let us easily compose chain of operations in sequential manner. Of course we could use threads here, but the question is: are threads fine-grained? In many managed languages with OS threads exposed, they can be quite heavy eg. by default in .NET each thread takes around 1MB of memory and requires calling kernel code to cooperate with other threads, which is an expensive operation on its own.</p></div><div class="el-p"><p dir="auto">What we're after, are more lightweight structures (less than 1kB), that can live fully in a user space, so that we can have even millions of them cooperating frequently with each other without heavy performance penalties.</p></div><div class="el-p"><p dir="auto">Before we begin, I think it's good to discuss different designs. We'll cover several different topics to be able to make more informed decisions, that we're up to apply to our own solution.</p></div><div class="el-h3 heading-wrapper"><h3 data-heading="Preemptive vs cooperative scheduler" dir="auto" class="heading" id="Preemptive_vs_cooperative_scheduler"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>Preemptive vs cooperative scheduler</h3><div class="heading-children"><div class="el-p"><p dir="auto">Scheduler is a subsystem, which direct responsibility is to assign CPU core processing power to a particular fiber. It's also responsible for coordinating fibers execution. The two most common categories of schedulers are preemptive and cooperative.</p></div><div class="el-p"><p dir="auto">A <strong>preemptive</strong> scheduler is the one, that's always in control of fiber execution. It's able to decide on its own, when fiber can be started and stopped. The most obvious example of such is a thread scheduler existing on most operating systems.</p></div><div class="el-p"><p dir="auto">Preemptive scheduler usually works in one of two ways:</p></div><div class="el-ul"><ul>
<li data-line="0" dir="auto">Time based scheduler takes a quant of CPU time and gives it to a given fiber, which ten can execute its logic until it reaches its execution time limit (of course, it can finish earlier). This is how OS thread scheduler, but also how Go goroutine scheduler works.</li>
<li data-line="1" dir="auto">Another variant is step-based scheduler, which splits fiber's function body into series of (more or less equal) steps. Then each fiber is given a number of steps to execute before preemption occurs. Example of such is Erlang's BEAM - it simply allows each process to execute up to 2000 "reductions", where each reduction is basically a function call. <em>And since in Erlang there are no loops, only tail-recursive functions, this approach works well for long-living iterative processes as well.</em></li>
</ul></div><div class="el-p"><p dir="auto">One of the problems with preemptive schedulers is that they usually need some kind of involvement from the compiler or hosting virtual machine in order to work. For this reason, most of the fiber libraries use <strong>cooperative</strong> schedulers to perform their work.</p></div><div class="el-p"><p dir="auto">A <strong>cooperative</strong> scheduler doesn't have a concept of preemption - once started by the scheduler, a fiber will execute until it doesn't give back the control willingly. This is often done with dedicated programming constructs, and often is known as yielding, parking or awaiting.</p></div><div class="el-p"><p dir="auto">In cooperative variant, a fiber body is usually split into series of discrete steps, between which fiber gives control back to the scheduler.</p></div><div class="el-p"><p dir="auto">Keep in mind that these two are not mutually exclusive - a preemptive scheduler often provides a way for a fiber to return control back to it when it's known that fiber won't be executing any longer eg. because it has been put to sleep for a while.</p></div></div></div><div class="el-h3 heading-wrapper"><h3 data-heading="Stackless vs. stackful" dir="auto" class="heading" id="Stackless_vs._stackful"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>Stackless vs. stackful</h3><div class="heading-children"><div class="el-p"><p dir="auto">A concept, that's somewhat related to a topic above is the idea of stackless and stackful coroutines.</p></div><div class="el-p"><p dir="auto">A stackful variant is aware of underlying execution stack and can preserve/restore parts of it when yielding/continuing a fiber. Examples of this approach could be Go, Lua, Python asyncio and in the future, also <a data-tooltip-position="top" aria-label="https://www.youtube.com/watch?v=NV46KFV1m-4&amp;ref=bartoszsypytkowski.com" rel="noopener nofollow" class="external-link" href="https://www.youtube.com/watch?v=NV46KFV1m-4&amp;ref=bartoszsypytkowski.com" target="_blank">Java Loom</a> project. Implementing such option (if it's not implemented by a runtime already) usually requires diving deep into low-level internals, since execution stack is not something that most managed languages offers the users to play with, and doing so without coordination with runtime can cause problems - like determining liveness of objects for GC purposes.</p></div><div class="el-p"><p dir="auto">Stackless coroutine usually captures locals that we want to preserve as part of callback object (lambda), that is allocated as an object on the heap and scheduled on yield continuation. These steps are usually visible directly in code (eg. await in C#, Rust and JavaScript, but also joints of Scala for-comprehensions, bang-suffix in F# or Haskell do-notation), but sometimes can be implicit like in case of Kotlin. Take into account that while many languages offer syntax support for those constructs, it's not explicitly necessary to work - take a look at JavaScript and <code>Promise.then</code> as an example.</p></div><div class="el-p"><p dir="auto">Stackless coroutines usually construct their logic around one of two concepts:</p></div><div class="el-ol"><ol>
<li data-line="0" dir="auto">Finite state machines - this variant is usually faster and can be encoded manually (example of such case is Akka actors), but for a human eye it usually doesn't really read as a sequential step-by-step program execution, unless it has some support from the compiler itself (see: C# and Rust).</li>
<li data-line="1" dir="auto">Monadic sequencing via bind/flatMap operator, which is very popular in functional languages. While we cover it in more details in the rest of this blog post, for now it's enough to say that it's a way to chain callback-based behaviors together in a way, that resembles standard sequential code.</li>
</ol></div><div class="el-p"><p dir="auto">For sure one of the advantages of stackful coroutines is that they're <em>mono-colored</em>: you can yield/continue coroutine execution from within any other function, while in the stackless variant splits your world into <em>two-colored</em> functions - synchronous and <strong>async</strong>hronous - where async one can be only called and yielded safely (without blocking underlying OS thread) from within another async function.</p></div></div></div><div class="el-h3 heading-wrapper"><h3 data-heading="Eager vs lazy fibers" dir="auto" class="heading" id="Eager_vs_lazy_fibers"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>Eager vs lazy fibers</h3><div class="heading-children"><div class="el-p"><p dir="auto">We already mentioned two important events in fiber execution life cycle - starting and parking. Here I briefly discuss about different design decisions on when to start a fiber execution.</p></div><div class="el-p"><p dir="auto"><strong>Eager</strong> execution means, that fiber is started automatically after its creation. An example of such are Scala <code>Future[A]</code> and JavaScript <code>Promise</code>. Since execution process starts right away, we're willingly resign from a certain degree of control over how or when to execute given fiber. Usually this is solved by wrapping a fiber creation into another function or lambda.</p></div><div class="el-p"><p dir="auto"><strong>Lazy</strong> execution is much more common and preferred way of work, as it allows us to separate place where we want to define our asynchronous sequence of steps from the place, where the execution details are defined. It's used in C# TPL as well as pretty much in all functional languages implementations (excluding Scala futures mentioned earlier).</p></div></div></div><div class="el-h3 heading-wrapper"><h3 data-heading="Interruption" dir="auto" class="heading" id="Interruption"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>Interruption</h3><div class="heading-children"><div class="el-p"><p dir="auto">There are also few decisions regarding premature escaping the fiber execution, also known as interruption/cancelation: one of them requires passing special object - a <strong>token</strong> - between method calls and explicit checking for its completion. It is how C# Tasks work. However putting such requirement onto the API user can be cumbersome and error-prone option. Therefore pretty much every other coroutine library either allows to direcly interrupt a fiber or (like in case of F# Async) passes cancelation tokens and check if they were triggered under the hood.</p></div></div></div><div class="el-h2 heading-wrapper"><h2 data-heading="Implementation" dir="auto" class="heading" id="Implementation"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>Implementation</h2><div class="heading-children"><div class="el-p"><p dir="auto">Since we talked a bit about various approaches, let's get to the meat of this blog post: implementing our own coroutine library in F#. So, what properties will it have?:</p></div><div class="el-ol"><ol>
<li data-line="0" dir="auto">We use cooperative scheduling (we don't want to tweak the compiler) of stackless fibers with support from F# computation expression for nice syntax.</li>
<li data-line="1" dir="auto">We use simple approach by defining custom <code>bind</code> operator with support from F# computation expressions. No state machines.</li>
<li data-line="2" dir="auto">We'll use lazy invocation.</li>
<li data-line="3" dir="auto">We'll make use of implicitly passed cancelation tokens. We'll handle them directly inside the linking code.</li>
</ol></div><div class="el-p"><p dir="auto">All of these give us in very similar approach to that found inside of native F# <code>Async</code> data type. To begin with, we'll simply define the shape of our fiber.</p></div><div class="el-p"><p dir="auto">Underneath, pretty much every cooperative stackless coroutine approach uses callbacks to drive the flow of synchronous segments of code to be executed one after another. So what we need is a callback which takes a result of previous coroutine and schedules in within some context of execution:</p></div><div class="el-pre"><pre class="language-fsharp" tabindex="0"><code data-line="0" class="language-fsharp is-loaded"><span class="token keyword">type</span> <span class="token class-name">Fiber</span><span class="token operator">&lt;</span>'a<span class="token operator">&gt;</span> <span class="token operator">=</span> Fiber <span class="token keyword">of</span> <span class="token punctuation">(</span>ExecutionContext <span class="token operator">-&gt;</span> FiberCallback<span class="token operator">&lt;</span>'a<span class="token operator">&gt;</span> <span class="token operator">-&gt;</span> unit<span class="token punctuation">)</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">Here we'll represent Fiber as a simple single-case discriminated union. We could as well define other specialized cases, like:</p></div><div class="el-ul"><ul>
<li data-line="0" dir="auto">Situation when coroutine is executed immediately and doesn't need to be awaited on: think about variant of <code>ValueTask</code> from C# Task Parallel Library.</li>
<li data-line="1" dir="auto">Case when coroutine fails - in that case we might want to store an artificial tracing context that would allow us to create nicely-formatted "stack traces": since .NET Core 2.1, C# already provides similar solution however AFAIK it's been solved differently.</li>
</ul></div><div class="el-p"><p dir="auto">Ok, but what are <code>ExecutionContext</code> and <code>FiberCallback&lt;'a&gt;</code>? Let's start from callback. We can represent it as follows:</p></div><div class="el-pre"><pre class="language-fsharp" tabindex="0"><code data-line="0" class="language-fsharp is-loaded"><span class="token keyword">type</span> <span class="token class-name">FiberCallback</span><span class="token operator">&lt;</span>'a<span class="token operator">&gt;</span> <span class="token operator">=</span> FiberResult<span class="token operator">&lt;</span>'a<span class="token operator">&gt;</span> <span class="token operator">-&gt;</span> unit
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">It's just a simple function, which takes result of previous fiber execution and handles it. What's the <code>FiberResult&lt;'a&gt;</code> then?</p></div><div class="el-p"><p dir="auto">Our fiber can complete successfully (returning a value) or fail with an exception. We'll be conservative here and won't go into more typed world of <a data-tooltip-position="top" aria-label="http://degoes.net/articles/bifunctor-io?ref=bartoszsypytkowski.com" rel="noopener nofollow" class="external-link" href="http://degoes.net/articles/bifunctor-io?ref=bartoszsypytkowski.com" target="_blank">IO bifunctor</a>. We can easy define these possible outputs in F# using <code>Result&lt;'a, exn&gt;</code>.</p></div><div class="el-p"><p dir="auto">Question is: is that exhaustive? Well... no. As we already mentioned, there's a 3rd state, often overlooked or conflated with failure: a canceled fiber. A canceled fiber doesn't produce any output - since it was canceled before completion. In F# we already know how to represent an absence of value - simply use an option. Therefore our ultimate Fiber result type could look like this:</p></div><div class="el-pre"><pre class="language-fsharp" tabindex="0"><code data-line="0" class="language-fsharp is-loaded"><span class="token keyword">type</span> <span class="token class-name">FiberResult</span><span class="token operator">&lt;</span>'a<span class="token operator">&gt;</span> <span class="token operator">=</span> Result<span class="token operator">&lt;</span>'a<span class="token punctuation">,</span> exn<span class="token operator">&gt;</span> option
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">Now, the <code>ExecutionContext</code>. While it can be compound of many different capabilities throughout the system - even to serve as functional equivalent of dependency injection - here I'll use it only for implicit passing of specific scheduler info and cancelation tokens from one fiber to another.</p></div><div class="el-pre"><pre class="language-fsharp" tabindex="0"><code data-line="0" class="language-fsharp is-loaded"><span class="token keyword">type</span> <span class="token class-name">ExecutionContext</span> <span class="token operator">=</span> IScheduler <span class="token operator">*</span> Cancel
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto"><code>IScheduler</code> interface is used to abstract component responsible for running our fibers. At the moment all we need is an ability to schedule fiber execution:</p></div><div class="el-pre"><pre class="language-fsharp" tabindex="0"><code data-line="0" class="language-fsharp is-loaded"><span class="token annotation"><span class="token punctuation">[&lt;</span><span class="token class-name">Interface</span><span class="token punctuation">&gt;]</span></span>
<span class="token keyword">type</span> <span class="token class-name">IScheduler</span> <span class="token operator">=</span> 
  <span class="token keyword">abstract</span> Schedule<span class="token punctuation">:</span> <span class="token punctuation">(</span>unit <span class="token operator">-&gt;</span> unit<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> unit
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">While the name and signature imply multithreaded execution model, it doesn't have to be the case. We can even implement scheduler which will simulate everything on a single core.</p></div><div class="el-p"><p dir="auto">For now, we can simply implement a scheduler API on top of our standard .NET thread pool:</p></div><div class="el-pre"><pre class="language-fsharp" tabindex="0"><code data-line="0" class="language-fsharp is-loaded"><span class="token keyword">module</span> Scheduler

<span class="token keyword">open</span> System<span class="token punctuation">.</span>Threading

<span class="token keyword">let</span> shared <span class="token operator">=</span> 
  <span class="token punctuation">{</span> <span class="token keyword">new</span> <span class="token class-name">ISchedule</span> <span class="token keyword">with</span>
      <span class="token keyword">member</span> __<span class="token punctuation">.</span>Schedule fn <span class="token operator">=</span> 
        ThreadPool<span class="token punctuation">.</span><span class="token function">QueueUserWorkItem</span><span class="token punctuation">(</span>WaitCallback <span class="token punctuation">(</span><span class="token keyword">fun</span> _ <span class="token operator">-&gt;</span> <span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">|&gt;</span> ignore  <span class="token punctuation">}</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-h3 heading-wrapper"><h3 data-heading="Cancellation" dir="auto" class="heading" id="Cancellation"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>Cancellation</h3><div class="heading-children"><div class="el-p"><p dir="auto">Now it's a time for cancellation tokens. Of course we could just make use of a flag - conceptually working like native .NET <code>CancellationToken</code>. However given implicit cancellation, it may not be enough. Example:</p></div><div class="el-blockquote"><blockquote dir="auto">
<p>Imagine, that inside our fiber we're scheduling the race between two other fibers ie. one writing data to a file and other which will complete after timeout. Now, whenever one of them completes first, we want to cancel another one to stop wasting resources for result that no longer matters.</p>
</blockquote></div><div class="el-p"><p dir="auto">This simple scenario is similar to what .NET <code>Task.WhenAny</code> is used - with a difference that, unlike TPL, we want to actually cancel other executing tasks instead of letting them run (potentially forever) :D</p></div><div class="el-p"><p dir="auto">Now, since our cancellation is not explicit, we need to deal with few things:</p></div><div class="el-ol"><ol>
<li data-line="0" dir="auto">Whenever parent fiber is cancelled, all child fibers it spawned are also cancelled.</li>
<li data-line="1" dir="auto">Whenever we cancel a fiber that loose the race, we <strong>don't want</strong> to accidentally cancel a token of its parent.</li>
</ol></div><div class="el-p"><p dir="auto">This behavior implies at least using two separate tokens, however in practice it will be more pragmatic to make our <code>Cancel</code> token work as a tree hierarchy - this way we can easily keep track of things and support more complex scenarios.</p></div><div class="el-pre"><pre class="language-fsharp" tabindex="0"><code data-line="0" class="language-fsharp is-loaded"><span class="token annotation"><span class="token punctuation">[&lt;</span><span class="token annotation-content">Sealed<span class="token punctuation">;</span>AllowNullLiteral</span><span class="token punctuation">&gt;]</span></span>
<span class="token keyword">type</span> <span class="token class-name">Cancel</span><span class="token punctuation">(</span>parent<span class="token punctuation">:</span> <span class="token class-name">Cancel</span><span class="token punctuation">)</span> <span class="token operator">=</span>
  <span class="token keyword">let</span> <span class="token keyword">mutable</span> flag<span class="token punctuation">:</span> <span class="token class-name">int</span> <span class="token operator">=</span> <span class="token number">0</span>
  <span class="token keyword">let</span> <span class="token keyword">mutable</span> children<span class="token punctuation">:</span> <span class="token class-name">Cancel</span> list <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token keyword">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">Cancel</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span>
  <span class="token doc-comment comment">/// Check if token was cancelled</span>
  <span class="token keyword">member</span> __<span class="token punctuation">.</span>Cancelled <span class="token operator">=</span> flag <span class="token operator">=</span> <span class="token number">1</span>
  <span class="token doc-comment comment">/// Remove child token</span>
  <span class="token keyword">member</span> <span class="token keyword">private</span> __<span class="token punctuation">.</span><span class="token function">RemoveChild</span><span class="token punctuation">(</span>child<span class="token punctuation">)</span> <span class="token operator">=</span> 
    <span class="token keyword">let</span> <span class="token keyword">rec</span> loop child <span class="token operator">=</span>
      <span class="token keyword">let</span> children' <span class="token operator">=</span> children
      <span class="token keyword">let</span> nval <span class="token operator">=</span> children' <span class="token operator">|&gt;</span> List<span class="token punctuation">.</span>filter <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">&lt;&gt;</span><span class="token punctuation">)</span> child<span class="token punctuation">)</span>
      <span class="token keyword">if</span> <span class="token keyword">not</span> <span class="token punctuation">(</span>obj<span class="token punctuation">.</span><span class="token function">ReferenceEquals</span><span class="token punctuation">(</span>children'<span class="token punctuation">,</span> Interlocked<span class="token punctuation">.</span><span class="token function">CompareExchange</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>children<span class="token punctuation">,</span> nval<span class="token punctuation">,</span> children'<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token keyword">then</span> loop child
    <span class="token keyword">if</span> <span class="token keyword">not</span> <span class="token punctuation">(</span>List<span class="token punctuation">.</span>isEmpty children<span class="token punctuation">)</span> <span class="token keyword">then</span> loop child
  <span class="token doc-comment comment">/// Create a new child token and return it.</span>
  <span class="token keyword">member</span> this<span class="token punctuation">.</span>AddChild <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span>
    <span class="token keyword">let</span> <span class="token keyword">rec</span> loop child <span class="token operator">=</span>
      <span class="token keyword">let</span> children' <span class="token operator">=</span> children
      <span class="token keyword">if</span> <span class="token punctuation">(</span>obj<span class="token punctuation">.</span><span class="token function">ReferenceEquals</span><span class="token punctuation">(</span>children'<span class="token punctuation">,</span> Interlocked<span class="token punctuation">.</span><span class="token function">CompareExchange</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>children<span class="token punctuation">,</span> child<span class="token operator">::</span>children'<span class="token punctuation">,</span> children'<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token keyword">then</span> child
      <span class="token keyword">else</span> loop child
    loop <span class="token punctuation">(</span>Cancel this<span class="token punctuation">)</span>
  <span class="token doc-comment comment">/// Cancel a token</span>
  <span class="token keyword">member</span> this<span class="token punctuation">.</span><span class="token function">Cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span>
    <span class="token keyword">if</span> Interlocked<span class="token punctuation">.</span><span class="token function">Exchange</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>flag<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span> <span class="token keyword">then</span>
      <span class="token keyword">for</span> child <span class="token keyword">in</span> Interlocked<span class="token punctuation">.</span><span class="token function">Exchange</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>children<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token keyword">do</span> child<span class="token punctuation">.</span><span class="token function">Cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token keyword">if</span> <span class="token keyword">not</span> <span class="token punctuation">(</span>isNull parent<span class="token punctuation">)</span> <span class="token keyword">then</span> parent<span class="token punctuation">.</span><span class="token function">RemoveChild</span><span class="token punctuation">(</span>this<span class="token punctuation">)</span>

</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">The general idea is simple: every new cancellation token (except root) may have a parent and a list of children. Canceling parent means canceling its children as well. After cancellation, we need to unpin child from its parent (therefore need for <code>RemveChild</code> operation) to avoid memory leaks.</p></div><div class="el-h5 heading-wrapper"><h5 data-heading="Lock-free updates" dir="auto" class="heading" id="Lock-free_updates"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>Lock-free updates</h5><div class="heading-children"><div class="el-p"><p dir="auto">What might be confusing for some in the code above, are recursive loops inside of <code>AddChild</code>/<code>RemoveChild</code> operations. This is a good place to introduce lock-free algorithms: we use atomic operations from <a data-tooltip-position="top" aria-label="https://www.bartoszsypytkowski.com/building-custom-fibers-library-in-f/docs.microsoft.com/en-us/dotnet/api/system.threading.interlocked" rel="noopener nofollow" class="external-link" href="https://www.bartoszsypytkowski.com/building-custom-fibers-library-in-f/docs.microsoft.com/en-us/dotnet/api/system.threading.interlocked" target="_blank">Interlocked</a> class to make sure that we can replace field references within a single CPU instruction, therefore making such field update safe without synchronized access. This is also known as Compare-And-Swap semantics.</p></div><div class="el-p"><p dir="auto">This alone however is not enough, as <code>Interlocked.CompareExchange(&amp;field, new', old)</code> can only safely replace a single field with new value if it contained an old one. This means that you cannot safely add or remove element to the list. So what can we do?</p></div><div class="el-ol"><ol>
<li data-line="0" dir="auto">We're taking a value from the field.</li>
<li data-line="1" dir="auto">Update that value.</li>
<li data-line="2" dir="auto">Conditionally put it back again. What if in the meantime the field was already replaced by another concurrently running thread? In that case <code>Interlocked.CompareExchange</code> will return field value other that the one we read in step 1. This is why we compare its result with the variable we expected.</li>
<li data-line="3" dir="auto">If the expectation fails, we'll retry - hence a recursive loop. Eventually even in high contention scenarios we should be able to complete after few retries. Given cheap and idempotent update operation, this still will be way faster than trying to call kernel code to obtain mutex/semaphore lock.</li>
</ol></div><div class="el-p"><p dir="auto">While this may sound like something error prone - we can potentially add the same element multiple times - in practice it's safe, because our collection here is an immutable data structure. Adding the same element multiple times without updating the reference will always produce the same result.</p></div></div></div></div></div><div class="el-h3 heading-wrapper"><h3 data-heading="Back on track..." dir="auto" class="heading" id="Back_on_track..."><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>Back on track...</h3><div class="heading-children"><div class="el-p"><p dir="auto">Now we have pretty much all core structures. We're ready to start building our fiber operators. Starting from the basic ones - a successfully completed fiber and the failed one:</p></div><div class="el-pre"><pre class="language-fsharp" tabindex="0"><code data-line="0" class="language-fsharp is-loaded"><span class="token keyword">let</span> success r <span class="token operator">=</span> Fiber <span class="token operator">&lt;|</span> <span class="token keyword">fun</span> <span class="token punctuation">(</span>_<span class="token punctuation">,</span> c<span class="token punctuation">)</span> next <span class="token operator">-&gt;</span> 
  <span class="token keyword">if</span> c<span class="token punctuation">.</span>Cancelled <span class="token keyword">then</span> next None <span class="token keyword">else</span> next <span class="token punctuation">(</span>Some <span class="token punctuation">(</span>Ok r<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">let</span> fail ex <span class="token operator">=</span> Fiber <span class="token operator">&lt;|</span> <span class="token keyword">fun</span> <span class="token punctuation">(</span>_<span class="token punctuation">,</span> c<span class="token punctuation">)</span> next <span class="token operator">-&gt;</span> 
  <span class="token keyword">if</span> c<span class="token punctuation">.</span>Cancelled <span class="token keyword">then</span> next None <span class="token keyword">else</span> next <span class="token punctuation">(</span>Some <span class="token punctuation">(</span>Error ex<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">Here, we simply pass a result/error to our Fiber callback:</p></div><div class="el-ul"><ul>
<li data-line="0" dir="auto">Cancelled fiber call <code>next</code> callback with <code>None</code> - as fibers cancelled before completion produce output .</li>
<li data-line="1" dir="auto">Successful call results in passing <code>Some (Ok result)</code> to a callback...</li>
<li data-line="2" dir="auto">... while failed result can be identified with <code>Some (Error exception)</code>.</li>
</ul></div><div class="el-p"><p dir="auto">You'll be able to see a cancellation check made here as preamble of pretty much every operator body, which we'll define. While it may sound cumbersome remember: we do that so that users of our fibers won't have to :)</p></div><div class="el-p"><p dir="auto">Next very important operation is result mapping - we want to map result of one fiber into something else, returning another (lazy) fiber:</p></div><div class="el-pre"><pre class="language-fsharp" tabindex="0"><code data-line="0" class="language-fsharp is-loaded"><span class="token keyword">let</span> mapResult <span class="token punctuation">(</span>fn<span class="token punctuation">:</span> <span class="token class-name">Result</span><span class="token operator">&lt;</span>'a<span class="token operator">&gt;</span> <span class="token operator">-&gt;</span> Result<span class="token operator">&lt;</span>'b<span class="token operator">&gt;</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>Fiber call<span class="token punctuation">)</span> <span class="token operator">=</span> Fiber <span class="token operator">&lt;|</span> <span class="token keyword">fun</span> <span class="token punctuation">(</span>s<span class="token punctuation">,</span> c<span class="token punctuation">)</span> next <span class="token operator">-&gt;</span>
  <span class="token keyword">if</span> c<span class="token punctuation">.</span>Cancelled <span class="token keyword">then</span> next None
  <span class="token keyword">else</span> 
    <span class="token keyword">try</span> 
      call <span class="token punctuation">(</span>s<span class="token punctuation">,</span> c<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">fun</span> result <span class="token operator">-&gt;</span>
        <span class="token keyword">if</span> c<span class="token punctuation">.</span>Cancelled <span class="token keyword">then</span> next None
        <span class="token keyword">else</span> next <span class="token punctuation">(</span>Option<span class="token punctuation">.</span>map fn result<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">with</span> e <span class="token operator">-&gt;</span> next <span class="token punctuation">(</span>Some <span class="token punctuation">(</span>Error e<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">We can use this function to compose more traditionally-looking <code>map</code> function...</p></div><div class="el-pre"><pre class="language-fsharp" tabindex="0"><code data-line="0" class="language-fsharp is-loaded"><span class="token keyword">let</span> map <span class="token punctuation">(</span>fn<span class="token punctuation">:</span> 'a <span class="token operator">-&gt;</span> 'b<span class="token punctuation">)</span> fiber <span class="token operator">=</span> mapResult <span class="token punctuation">(</span>Result<span class="token punctuation">.</span>map fn<span class="token punctuation">)</span> fiber
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">... however <code>mapResult</code> is more powerful - you could easily imagine using to apply failure recovery (a.k.a <code>try</code>/<code>catch</code> semantics) by simply mapping <code>Error exception</code> → <code>Ok recoveredValue</code>:</p></div><div class="el-pre"><pre class="language-fsharp" tabindex="0"><code data-line="0" class="language-fsharp is-loaded"><span class="token keyword">let</span> catch fn fiber <span class="token operator">=</span> mapResult <span class="token punctuation">(</span><span class="token keyword">function</span> Error e <span class="token operator">-&gt;</span> fn e <span class="token operator">|</span> ok <span class="token operator">-&gt;</span> ok<span class="token punctuation">)</span> fiber
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">Another must-have function is binding operator (also know as <code>flatMap</code> in other languages like Scala, or <code>Promise.then</code> in JavaScript). It gives us the ability to compose fibers together - we'll also use it when we come up to building a computation expression for our fibers.</p></div><div class="el-pre"><pre class="language-fsharp" tabindex="0"><code data-line="0" class="language-fsharp is-loaded"><span class="token keyword">let</span> bind <span class="token punctuation">(</span>fn<span class="token punctuation">:</span> 'a <span class="token operator">-&gt;</span> Fiber<span class="token operator">&lt;</span>'b<span class="token operator">&gt;</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>Fiber call<span class="token punctuation">)</span> <span class="token operator">=</span> Fiber <span class="token operator">&lt;|</span> <span class="token keyword">fun</span> <span class="token punctuation">(</span>s<span class="token punctuation">,</span> c<span class="token punctuation">)</span> next <span class="token operator">-&gt;</span>
   <span class="token keyword">if</span> c<span class="token punctuation">.</span>Cancelled <span class="token keyword">then</span> next None 
   <span class="token keyword">else</span> 
     <span class="token keyword">try</span>
       call <span class="token punctuation">(</span>s<span class="token punctuation">,</span> c<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">fun</span> result <span class="token operator">-&gt;</span>
         <span class="token keyword">if</span> c<span class="token punctuation">.</span>Cancelled <span class="token keyword">then</span> next None
         <span class="token keyword">else</span> <span class="token keyword">match</span> result <span class="token keyword">with</span>
              <span class="token operator">|</span> Some <span class="token punctuation">(</span>Ok r<span class="token punctuation">)</span> <span class="token operator">-&gt;</span>
                 <span class="token keyword">let</span> <span class="token punctuation">(</span>Fiber call2<span class="token punctuation">)</span> <span class="token operator">=</span> fn r
                 call2 <span class="token punctuation">(</span>s<span class="token punctuation">,</span> c<span class="token punctuation">)</span> next <span class="token comment">// pass `next` callback over to next fiber</span>
              <span class="token operator">|</span> None <span class="token operator">-&gt;</span> next None
              <span class="token operator">|</span> Some <span class="token punctuation">(</span>Error e<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> next <span class="token punctuation">(</span><span class="token function">Some</span><span class="token punctuation">(</span>Error e<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
     <span class="token keyword">with</span> e <span class="token operator">-&gt;</span> next <span class="token punctuation">(</span><span class="token function">Some</span><span class="token punctuation">(</span>Error e<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">It's simple - we execute one fiber from within another, passing the <code>next</code> callback from outer function as an argument to inner one.</p></div></div></div><div class="el-h3 heading-wrapper"><h3 data-heading="Fiber computation expressions" dir="auto" class="heading" id="Fiber_computation_expressions"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>Fiber computation expressions</h3><div class="heading-children"><div class="el-p"><p dir="auto">With these few functions we're already prepared to build a basic computation expression, that will enable us programming with fibers in pleasant way:</p></div><div class="el-pre"><pre class="language-fsharp" tabindex="0"><code data-line="0" class="language-fsharp is-loaded"><span class="token annotation"><span class="token punctuation">[&lt;</span><span class="token class-name">Struct</span><span class="token punctuation">&gt;]</span></span>
<span class="token keyword">type</span> <span class="token class-name">FiberBuilder</span> <span class="token operator">=</span>
    <span class="token keyword">member</span> <span class="token keyword">inline</span> __<span class="token punctuation">.</span>Zero <span class="token operator">=</span> Fiber<span class="token punctuation">.</span>success <span class="token punctuation">(</span>Unchecked<span class="token punctuation">.</span>defaultof<span class="token operator">&lt;</span>_<span class="token operator">&gt;</span><span class="token punctuation">)</span>
    <span class="token keyword">member</span> <span class="token keyword">inline</span> __<span class="token punctuation">.</span>ReturnFrom fib <span class="token operator">=</span> fib
    <span class="token keyword">member</span> <span class="token keyword">inline</span> __<span class="token punctuation">.</span>Return value <span class="token operator">=</span> Fiber<span class="token punctuation">.</span>success value
    <span class="token keyword">member</span> <span class="token keyword">inline</span> __<span class="token punctuation">.</span><span class="token function">Bind</span><span class="token punctuation">(</span>fib<span class="token punctuation">,</span> fn<span class="token punctuation">)</span> <span class="token operator">=</span> Fiber<span class="token punctuation">.</span>bind fn fib

<span class="token annotation"><span class="token punctuation">[&lt;</span><span class="token class-name">AutoOpen</span><span class="token punctuation">&gt;]</span></span>
<span class="token keyword">module</span> FiberBuilder <span class="token operator">=</span>

    <span class="token keyword">let</span> fib <span class="token operator">=</span> <span class="token function">FiberBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">While in F# <a data-tooltip-position="top" aria-label="https://docs.microsoft.com/en-us/dotnet/fsharp/language-reference/computation-expressions?ref=bartoszsypytkowski.com" rel="noopener nofollow" class="external-link" href="https://docs.microsoft.com/en-us/dotnet/fsharp/language-reference/computation-expressions?ref=bartoszsypytkowski.com" target="_blank">there are many more operators</a> we could pack into our computation expression, these are basic ones that will let it work. With such construct, we'll be able to write programs like:</p></div><div class="el-pre"><pre class="language-fsharp" tabindex="0"><code data-line="0" class="language-fsharp is-loaded"><span class="token keyword">let</span> <span class="token keyword">inline</span> millis n <span class="token operator">=</span> TimeSpan<span class="token punctuation">.</span>FromMilliseconds <span class="token punctuation">(</span>float n<span class="token punctuation">)</span>

<span class="token keyword">let</span> program<span class="token punctuation">:</span> <span class="token class-name">Fiber</span><span class="token operator">&lt;</span>int<span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token computation-expression keyword">fib</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> a <span class="token operator">=</span> <span class="token computation-expression keyword">fib</span> <span class="token punctuation">{</span>
    <span class="token keyword">do</span><span class="token operator">!</span> Fiber<span class="token punctuation">.</span>delay <span class="token punctuation">(</span>millis <span class="token number">1000</span><span class="token punctuation">)</span> <span class="token comment">// create some artificial delay</span>
    <span class="token keyword">return</span> <span class="token number">3</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">let!</span> b <span class="token operator">=</span> a <span class="token operator">|&gt;</span> Fiber<span class="token punctuation">.</span>timeout <span class="token punctuation">(</span>millis <span class="token number">3000</span><span class="token punctuation">)</span> <span class="token comment">// execute task within specified timeout</span>
  <span class="token keyword">return</span> b <span class="token punctuation">}</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">Sure, we have neither delay nor timeout operators at the moment, but at least you know where are we heading now :)</p></div></div></div><div class="el-h3 heading-wrapper"><h3 data-heading="Delayed execution" dir="auto" class="heading" id="Delayed_execution"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>Delayed execution</h3><div class="heading-children"><div class="el-p"><p dir="auto">In order to implement delays, we could theoretically just call <code>Thread.Sleep</code> and get over it, but this approach is devastating from any coroutine library point of view. Most user-space thread libraries work by using a predefined fixed pool of OS-level threads and scheduling coroutines on them - you can read more about building thread pools <a data-tooltip-position="top" aria-label="https://www.bartoszsypytkowski.com/thread-safety-with-affine-thread-pools/" rel="noopener nofollow" class="external-link" href="https://www.bartoszsypytkowski.com/thread-safety-with-affine-thread-pools/" target="_blank">here</a>.</p></div><div class="el-p"><p dir="auto">However, <code>Thread.Sleep(timeout)</code> doesn't know thread pooling mechanism - all it knows about is that we called suspending current OS thread of execution. This means, that this thread will not be awoken by kernel until timeout completes. What it means, is that none of our fibers will be able to use that thread. This is bad, because usually thread pools are made to fit in-line with number of machine CPU cores. In practice, <code>Thread.Sleep</code> may keep one of our CPU cores idle, wasting machine power in the process.</p></div><div class="el-p"><p dir="auto">For this reason we usually want to build a suspendable fibers, that will respect our thread pool. This however cannot be done without cooperation with scheduler itself. Therefore, we need to extend API of our scheduler:</p></div><div class="el-pre"><pre class="language-fsharp" tabindex="0"><code data-line="0" class="language-fsharp is-loaded"><span class="token keyword">type</span> <span class="token class-name">IScheduler</span> <span class="token operator">=</span>
  <span class="token keyword">abstract</span> Schedule<span class="token punctuation">:</span> <span class="token punctuation">(</span>unit <span class="token operator">-&gt;</span> unit<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> unit
  <span class="token keyword">abstract</span> Delay<span class="token punctuation">:</span> <span class="token class-name">TimeSpan</span> <span class="token operator">*</span> <span class="token punctuation">(</span>unit <span class="token operator">-&gt;</span> unit<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> unit
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">And our simple implementation of it as well:</p></div><div class="el-pre"><pre class="language-fsharp" tabindex="0"><code data-line="0" class="language-fsharp is-loaded"><span class="token keyword">let</span> shared <span class="token operator">=</span> 
    <span class="token punctuation">{</span> <span class="token keyword">new</span> <span class="token class-name">IScheduler</span> <span class="token keyword">with</span>
      <span class="token keyword">member</span> __<span class="token punctuation">.</span>Schedule fn <span class="token operator">=</span> <span class="token operator">..</span><span class="token operator">..</span>
      <span class="token keyword">member</span> this<span class="token punctuation">.</span>Delay <span class="token punctuation">(</span>timeout<span class="token punctuation">:</span> <span class="token class-name">TimeSpan</span><span class="token punctuation">,</span> fn<span class="token punctuation">)</span> <span class="token operator">=</span> 
        <span class="token keyword">let</span> <span class="token keyword">mutable</span> t <span class="token operator">=</span> Unchecked<span class="token punctuation">.</span>defaultof<span class="token operator">&lt;</span>Timer<span class="token operator">&gt;</span>
        <span class="token keyword">let</span> callback <span class="token operator">=</span> <span class="token keyword">fun</span> _ <span class="token operator">-&gt;</span> 
          t<span class="token punctuation">.</span><span class="token function">Dispose</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
          <span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
          <span class="token punctuation">(</span><span class="token punctuation">)</span>
        t <span class="token operator">&lt;-</span> <span class="token keyword">new</span> <span class="token class-name">Timer</span><span class="token punctuation">(</span>callback<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> int timeout<span class="token punctuation">.</span>TotalMilliseconds<span class="token punctuation">,</span> Timeout<span class="token punctuation">.</span>Infinite<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">We'll use a .NET timers here to implement our delays. With these in our hands, our<code>Fiber.delay</code> operation is trivial to implement:</p></div><div class="el-pre"><pre class="language-fsharp" tabindex="0"><code data-line="0" class="language-fsharp is-loaded"><span class="token keyword">let</span> delay <span class="token punctuation">(</span>timeout<span class="token punctuation">)</span><span class="token punctuation">:</span> Fiber<span class="token operator">&lt;</span>unit<span class="token operator">&gt;</span> <span class="token operator">=</span>
  Fiber <span class="token operator">&lt;|</span> <span class="token keyword">fun</span> <span class="token punctuation">(</span>s<span class="token punctuation">,</span> c<span class="token punctuation">)</span> next <span class="token operator">-&gt;</span>
    <span class="token keyword">if</span> c<span class="token punctuation">.</span>Cancelled <span class="token keyword">then</span> next None
    <span class="token keyword">else</span> s<span class="token punctuation">.</span><span class="token function">Delay</span><span class="token punctuation">(</span>timeout<span class="token punctuation">,</span> <span class="token keyword">fun</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> 
      <span class="token keyword">if</span> c<span class="token punctuation">.</span>Cancelled 
      <span class="token keyword">then</span> next None 
      <span class="token keyword">else</span> next <span class="token punctuation">(</span>Some <span class="token punctuation">(</span>Ok <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div></div></div><div class="el-h3 heading-wrapper"><h3 data-heading="Composing parallel fibers" dir="auto" class="heading" id="Composing_parallel_fibers"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>Composing parallel fibers</h3><div class="heading-children"><div class="el-p"><p dir="auto">We're slowly getting to the end. What I left for this blog post was to implement two basic operators, that are prevalent in most coroutine libraries:</p></div><div class="el-ul"><ul>
<li data-line="0" dir="auto"><code>Fiber.parallel</code> which will schedule multiple fibers to run in parallel and returns a fiber which aggregates their results.</li>
<li data-line="1" dir="auto">Running two fibers in parallel and returning the result of whichever completes first, while cancelling a second one. We already discussed this approach before. Here I'll call it <code>Fiber.race</code>.</li>
</ul></div><div class="el-h4 heading-wrapper"><h4 data-heading="Aggregating parallel results" dir="auto" class="heading" id="Aggregating_parallel_results"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>Aggregating parallel results</h4><div class="heading-children"><div class="el-p"><p dir="auto">We'll start from building a parallel operator, which will change our array of fibers into fiber with an array of results. But let's define the semantics of that operation first:</p></div><div class="el-ul"><ul>
<li data-line="0" dir="auto">Our result fiber completes only when all of the aggregated fibers completed with successful result.</li>
<li data-line="1" dir="auto">If any of the fibers fails, the resulting fiber also fails.</li>
<li data-line="2" dir="auto">If any of the fibers fails or get cancelled, all pending ones are also cancelled.</li>
</ul></div><div class="el-p"><p dir="auto">The core skeleton of that operation could look like following:</p></div><div class="el-pre"><pre class="language-fsharp" tabindex="0"><code data-line="0" class="language-fsharp is-loaded"><span class="token keyword">let</span> <span class="token keyword">parallel</span> <span class="token punctuation">(</span>fibers<span class="token punctuation">:</span> <span class="token class-name">Fiber</span><span class="token operator">&lt;</span>'a<span class="token operator">&gt;</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span> Fiber<span class="token operator">&lt;</span>'a<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">&gt;</span> <span class="token operator">=</span>
  Fiber <span class="token operator">&lt;|</span> <span class="token keyword">fun</span> <span class="token punctuation">(</span>s<span class="token punctuation">,</span> c<span class="token punctuation">)</span> next <span class="token operator">-&gt;</span>
    <span class="token keyword">if</span> c<span class="token punctuation">.</span>Cancelled <span class="token keyword">then</span> next None
    <span class="token keyword">else</span> 
      <span class="token keyword">let</span> child <span class="token operator">=</span> c<span class="token punctuation">.</span><span class="token function">AddChild</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token keyword">let</span> successes <span class="token operator">=</span> Array<span class="token punctuation">.</span>zeroCreate remaining
      <span class="token keyword">let</span> <span class="token keyword">mutable</span> remaining <span class="token operator">=</span> Array<span class="token punctuation">.</span>length fibs
      fibers <span class="token operator">|&gt;</span> Array<span class="token punctuation">.</span>iteri <span class="token punctuation">(</span><span class="token keyword">fun</span> idx <span class="token punctuation">(</span>Fiber call<span class="token punctuation">)</span> <span class="token operator">-&gt;</span>
        s<span class="token punctuation">.</span>Schedule <span class="token punctuation">(</span><span class="token keyword">fun</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token comment">(* to be defined *)</span><span class="token punctuation">)</span>
      <span class="token punctuation">)</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">Here, we create a dedicated cancellation token, an array of results and a countdown counter - we're going to decrement it every time one of our fibers completes to know when we're ready to return a complete result. I've left a placeholder for a lambda body that we actually want to schedule. We're going to fill it right away:</p></div><div class="el-pre"><pre class="language-fsharp" tabindex="0"><code data-line="0" class="language-fsharp is-loaded"><span class="token comment">// defined above: s.Schedule &lt;| fun () -&gt;</span>
call <span class="token punctuation">(</span>s<span class="token punctuation">,</span> child<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">fun</span> result <span class="token operator">-&gt;</span> 
<span class="token keyword">match</span> result <span class="token keyword">with</span>
<span class="token operator">|</span> Some <span class="token punctuation">(</span>Ok success<span class="token punctuation">)</span> <span class="token operator">-&gt;</span>
  <span class="token comment">// fill the result array</span>
  successes<span class="token punctuation">.</span><span class="token punctuation">[</span>idx<span class="token punctuation">]</span> <span class="token operator">&lt;-</span> success
  <span class="token keyword">if</span> c<span class="token punctuation">.</span>Cancelled <span class="token operator">&amp;&amp;</span> Interlocked<span class="token punctuation">.</span><span class="token function">Exchange</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>remaining<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token keyword">then</span>
    next None
  <span class="token keyword">elif</span> Interlocked<span class="token punctuation">.</span><span class="token function">Decrement</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>remaining<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span> <span class="token keyword">then</span>
    <span class="token comment">// if all results have been returned, call the `next` callback</span>
    <span class="token keyword">if</span> c<span class="token punctuation">.</span>Cancelled <span class="token keyword">then</span> next None
    <span class="token keyword">else</span> next <span class="token punctuation">(</span>Some <span class="token punctuation">(</span>Ok successes<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token operator">|</span> Some <span class="token punctuation">(</span>Error fail<span class="token punctuation">)</span> <span class="token operator">-&gt;</span>
  <span class="token keyword">if</span> Interlocked<span class="token punctuation">.</span><span class="token function">Exchange</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>remaining<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token keyword">then</span> 
    child<span class="token punctuation">.</span><span class="token function">Cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// we failed, cancel other fibers</span>
    <span class="token keyword">if</span> c<span class="token punctuation">.</span>Cancelled <span class="token keyword">then</span> next None
    <span class="token keyword">else</span> next <span class="token punctuation">(</span>Some <span class="token punctuation">(</span>Error fail<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token operator">|</span> None <span class="token operator">-&gt;</span>
  <span class="token keyword">if</span> Interlocked<span class="token punctuation">.</span><span class="token function">Exchange</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>remaining<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token keyword">then</span> next None<span class="token punctuation">)</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">As you probably noticed, we're using <code>Interlocked</code> class again - that's because now we have multiple fibers running in parallel, therefore our access to shared mutable values is not thread safe. This includes <code>remaining</code> counter decrement operation. This however doesn't apply to <code>successes.[i] &lt;- success</code> - since every fiber knows and touches only its own index within result array, there's no worry that any other will try to push its result in the same place.</p></div><div class="el-p"><p dir="auto">What you also can see, we're using a <code>-1</code> here as a magic value - we'll use it on the counter as a flag to determine if any of the fibers failed/was cancelled - and if so, which one of them will call the <code>next</code> callback.</p></div></div></div><div class="el-h4 heading-wrapper"><h4 data-heading="Racing to completion" dir="auto" class="heading" id="Racing_to_completion"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>Racing to completion</h4><div class="heading-children"><div class="el-p"><p dir="auto">With first operator (<code>Fiber.parallel</code>) ready, now it's the time to implement <code>Fiber.race</code>. Since I've discussed it behavior multiple times in this post already, let's dive straight into the code:</p></div><div class="el-pre"><pre class="language-fsharp" tabindex="0"><code data-line="0" class="language-fsharp is-loaded"><span class="token keyword">let</span> race <span class="token punctuation">(</span>Fiber left<span class="token punctuation">)</span> <span class="token punctuation">(</span>Fiber right<span class="token punctuation">)</span><span class="token punctuation">:</span> Fiber<span class="token operator">&lt;</span>Choice<span class="token operator">&lt;</span>'a<span class="token punctuation">,</span> 'b<span class="token operator">&gt;&gt;</span> <span class="token operator">=</span>
  Fiber <span class="token operator">&lt;|</span> <span class="token keyword">fun</span> <span class="token punctuation">(</span>s<span class="token punctuation">,</span> c<span class="token punctuation">)</span> next <span class="token operator">-&gt;</span>
    <span class="token keyword">if</span> c<span class="token punctuation">.</span>Cancelled <span class="token keyword">then</span> next None
    <span class="token keyword">else</span> 
      <span class="token keyword">let</span> <span class="token keyword">mutable</span> flag <span class="token operator">=</span> <span class="token number">0</span>
      <span class="token keyword">let</span> cancelChild <span class="token operator">=</span> c<span class="token punctuation">.</span><span class="token function">AddChild</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token keyword">let</span> run fiber choice <span class="token operator">=</span>
          <span class="token comment">(* to be described *)</span>
      run left Choice1Of2
      run right Choice2Of2
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">So again, we want to have shared mutable flag, which we'll use to determine, which of the fibers finished as a first one to be able to call fiber's callback safely and cancel the other. You may see, that our returned fiber uses <code>Choice&lt;,&gt;</code> type - this means, that our left and right fibers can have results of different types. We'll use that soon, but first we need to complete our <code>run</code> function body:</p></div><div class="el-pre"><pre class="language-fsharp" tabindex="0"><code data-line="0" class="language-fsharp is-loaded"><span class="token keyword">let</span> run fiber choice <span class="token operator">=</span>
  s<span class="token punctuation">.</span>Schedule <span class="token punctuation">(</span><span class="token keyword">fun</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span>
    fiber <span class="token punctuation">(</span>s<span class="token punctuation">,</span> cancelChild<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">fun</span> result <span class="token operator">-&gt;</span>
      <span class="token keyword">if</span> Interlocked<span class="token punctuation">.</span><span class="token function">Exchange</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>flag<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span> <span class="token keyword">then</span>
        cancelChild<span class="token punctuation">.</span><span class="token function">Cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> c<span class="token punctuation">.</span>Cancelled <span class="token keyword">then</span> next None
        <span class="token keyword">else</span> <span class="token keyword">match</span> result <span class="token keyword">with</span>
             <span class="token operator">|</span> None <span class="token operator">-&gt;</span> next None
             <span class="token operator">|</span> <span class="token function">Some</span><span class="token punctuation">(</span>Ok v<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> next <span class="token punctuation">(</span><span class="token function">Some</span><span class="token punctuation">(</span><span class="token function">Ok</span><span class="token punctuation">(</span>choice v<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
             <span class="token operator">|</span> <span class="token function">Some</span><span class="token punctuation">(</span>Error e<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> next <span class="token punctuation">(</span><span class="token function">Some</span><span class="token punctuation">(</span>Error e<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">What we do here is simply trying to race to "reserve" out flag variable - the winner gets his result mapped to corresponding choice, while looser gets cancelled.</p></div><div class="el-p"><p dir="auto">What's interesting, we can now combine our <code>race</code> and <code>delay</code> functions to easily implement timeout mechanism:</p></div><div class="el-pre"><pre class="language-fsharp" tabindex="0"><code data-line="0" class="language-fsharp is-loaded"><span class="token keyword">let</span> timeout <span class="token punctuation">(</span>t<span class="token punctuation">:</span> <span class="token class-name">TimeSpan</span><span class="token punctuation">)</span> fiber <span class="token operator">=</span>
  Fiber <span class="token operator">&lt;|</span> <span class="token keyword">fun</span> <span class="token punctuation">(</span>s<span class="token punctuation">,</span> c<span class="token punctuation">)</span> next <span class="token operator">-&gt;</span>
    <span class="token keyword">let</span> <span class="token punctuation">(</span>Fiber call<span class="token punctuation">)</span> <span class="token operator">=</span> race <span class="token punctuation">(</span>delay t<span class="token punctuation">)</span> fiber
    call <span class="token punctuation">(</span>s<span class="token punctuation">,</span> c<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">fun</span> result <span class="token operator">-&gt;</span>
      <span class="token keyword">if</span> c<span class="token punctuation">.</span>Cancelled <span class="token keyword">then</span> next None
      <span class="token keyword">else</span> <span class="token keyword">match</span> result <span class="token keyword">with</span>
           <span class="token operator">|</span> None <span class="token operator">-&gt;</span> next None
           <span class="token operator">|</span> <span class="token function">Some</span><span class="token punctuation">(</span>Ok <span class="token punctuation">(</span>Choice1Of2 _<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> next None <span class="token comment">// timeout won</span>
           <span class="token operator">|</span> <span class="token function">Some</span><span class="token punctuation">(</span>Ok <span class="token punctuation">(</span>Choice2Of2 v<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> next <span class="token punctuation">(</span><span class="token function">Some</span><span class="token punctuation">(</span>Ok v<span class="token punctuation">)</span><span class="token punctuation">)</span>
           <span class="token operator">|</span> <span class="token function">Some</span><span class="token punctuation">(</span>Error e<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> next <span class="token punctuation">(</span><span class="token function">Some</span><span class="token punctuation">(</span>Error e<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">The one last thing left for us, is to be able to run out fibers on the main thread - otherwise we'd start our program, schedule fibers to run in the background and then close the program without waiting for the results.</p></div><div class="el-pre"><pre class="language-fsharp" tabindex="0"><code data-line="0" class="language-fsharp is-loaded"><span class="token keyword">let</span> blocking <span class="token punctuation">(</span>s<span class="token punctuation">:</span> <span class="token class-name">IScheduler</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>cancel<span class="token punctuation">:</span> <span class="token class-name">Cancel</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>Fiber fn<span class="token punctuation">)</span> <span class="token operator">=</span>
  <span class="token keyword">use</span> waiter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ManualResetEventSlim</span><span class="token punctuation">(</span><span class="token keyword">false</span><span class="token punctuation">)</span>
  <span class="token keyword">let</span> <span class="token keyword">mutable</span> res <span class="token operator">=</span> None
  s<span class="token punctuation">.</span><span class="token function">Schedule</span><span class="token punctuation">(</span><span class="token keyword">fun</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> fn <span class="token punctuation">(</span>s<span class="token punctuation">,</span> cancel<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">fun</span> result <span class="token operator">-&gt;</span>
    <span class="token keyword">if</span> <span class="token keyword">not</span> cancel<span class="token punctuation">.</span>Cancelled <span class="token keyword">then</span>
      Interlocked<span class="token punctuation">.</span><span class="token function">Exchange</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>res<span class="token punctuation">,</span> Some result<span class="token punctuation">)</span> <span class="token operator">|&gt;</span> ignore
    waiter<span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  waiter<span class="token punctuation">.</span><span class="token function">Wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  res<span class="token punctuation">.</span>Value
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">It's simple - we'll use standard synchronization primitives provided by .NET runtime, to hold current OS thread until we complete. Sure it's blocking an OS thread, but we'll eventually need that if we don't want our program's main function to finish before all fibers inside the thread pool complete.</p></div></div></div></div></div><div class="el-h3 heading-wrapper"><h3 data-heading="Simulating real environment in tests" dir="auto" class="heading" id="Simulating_real_environment_in_tests"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>Simulating real environment in tests</h3><div class="heading-children"><div class="el-p"><p dir="auto">In theory, we could be done here. But, if you managed to read up to this point, we may want to cover one last scenario. Imagine that we'd want to test our fibers. However running tests using standard thread pool scheduler can lead to funky issues:</p></div><div class="el-ul"><ul>
<li data-line="0" dir="auto">Sometimes you may trigger some race conditions in your code, that only happen in specific situations (like high CPU contention) and are almost impossible to reproduce during debug sessions.</li>
<li data-line="1" dir="auto">Other times you may have some lengthy delays/timeouts in your code, like waiting for seconds or even minutes before continuing. Guess what: now your test will wait for just as long.</li>
</ul></div><div class="el-p"><p dir="auto">These are not new problems. They are well known in world of concurrent and distributed systems. What we need, is a simulation of execution environment. If you want to listen more about that concept, I could recommend you <a data-tooltip-position="top" aria-label="https://www.youtube.com/watch?v=4fFDFbi3toc&amp;ref=bartoszsypytkowski.com" rel="noopener nofollow" class="external-link" href="https://www.youtube.com/watch?v=4fFDFbi3toc&amp;ref=bartoszsypytkowski.com" target="_blank">this presentaton</a>. To run our test predictably, we'll create a dedicated test scheduler, which will run our code in deterministic fashion (on a single core) and in a way that's detached from other invariants eg. actual physical clock and random number generator.</p></div><div class="el-p"><p dir="auto">The idea here is simple - our scheduler will operate on notion of virtual timeline. When we'll try to schedule a new function - to trigger either immediately or after some timeout - we'll store it inside an ordered collection, a timeline. Some of the technical decisions we also made for purposes of this implementation:</p></div><div class="el-ul"><ul>
<li data-line="0" dir="auto">Whenever a fiber is going to schedule multiple parallel executions "at the same time", we'll put them all into a single bucket on a timeline. Later on I'll cover, why this is useful.</li>
<li data-line="1" dir="auto">We'll assume, that single operation execution is instantaneous. It means, it doesn't advance our scheduler's clock. We do it only for delayed executions.</li>
</ul></div><div class="el-p"><p dir="auto">After describing the concept behind the algorithm, the actual implementation really shouldn't be that surprising:</p></div><div class="el-pre"><pre class="language-fsharp" tabindex="0"><code data-line="0" class="language-fsharp is-loaded"><span class="token keyword">type</span> <span class="token class-name">TestScheduler</span><span class="token punctuation">(</span>now<span class="token punctuation">:</span> <span class="token class-name">DateTime</span><span class="token punctuation">)</span> <span class="token operator">=</span>
  <span class="token keyword">let</span> <span class="token keyword">mutable</span> running <span class="token operator">=</span> <span class="token keyword">false</span>
  <span class="token keyword">let</span> <span class="token keyword">mutable</span> currentTime <span class="token operator">=</span> now<span class="token punctuation">.</span>Ticks
  <span class="token keyword">let</span> <span class="token keyword">mutable</span> timeline <span class="token operator">=</span> Map<span class="token punctuation">.</span>empty
  <span class="token keyword">let</span> schedule delay fn <span class="token operator">=</span> <span class="token comment">(* to be defined *)</span>
  <span class="token keyword">let</span> <span class="token keyword">rec</span> run <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token comment">(* to be defined *)</span>
  <span class="token keyword">interface</span> <span class="token class-name">IScheduler</span> <span class="token keyword">with</span>
    <span class="token keyword">member</span> this<span class="token punctuation">.</span>Schedule fn <span class="token operator">=</span> 
      schedule <span class="token number">0L</span> fn
      <span class="token keyword">if</span> <span class="token keyword">not</span> running <span class="token keyword">then</span>
        running <span class="token operator">&lt;-</span> <span class="token keyword">true</span>
        run <span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">member</span> this<span class="token punctuation">.</span>Delay <span class="token punctuation">(</span>timeout<span class="token punctuation">:</span> <span class="token class-name">TimeSpan</span><span class="token punctuation">,</span> fn<span class="token punctuation">)</span> <span class="token operator">=</span> schedule timeout<span class="token punctuation">.</span>Ticks fn
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">We're using a <code>running</code> flag here to not try to invoke <code>run</code> multiple times in nested manner - this would cause non-tailable recursion and potential stack overflow in more expensive tests.</p></div><div class="el-p"><p dir="auto">The schedule function is pretty simple - calculate expected execution time for a function, then add that function to be executed at that point in time.</p></div><div class="el-pre"><pre class="language-fsharp" tabindex="0"><code data-line="0" class="language-fsharp is-loaded"><span class="token keyword">let</span> schedule delay fn <span class="token operator">=</span> 
  <span class="token keyword">let</span> at <span class="token operator">=</span> currentTime <span class="token operator">+</span> delay
  timeline <span class="token operator">&lt;-</span>
    <span class="token keyword">match</span> Map<span class="token punctuation">.</span>tryFind at timeline <span class="token keyword">with</span>
    <span class="token operator">|</span> None <span class="token operator">-&gt;</span> Map<span class="token punctuation">.</span>add at <span class="token punctuation">[</span>fn<span class="token punctuation">]</span> timeline 
    <span class="token operator">|</span> Some fns <span class="token operator">-&gt;</span> Map<span class="token punctuation">.</span>add at <span class="token punctuation">(</span>fn<span class="token operator">::</span>fns<span class="token punctuation">)</span> timeline
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">Given all of the code we already survived in this blog post, run loop should be pretty simple:</p></div><div class="el-pre"><pre class="language-fsharp" tabindex="0"><code data-line="0" class="language-fsharp is-loaded"><span class="token keyword">let</span> <span class="token keyword">rec</span> run <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span>
  <span class="token keyword">match</span> Seq<span class="token punctuation">.</span>tryHead timeline <span class="token keyword">with</span>
  <span class="token operator">|</span> None <span class="token operator">-&gt;</span> running <span class="token operator">&lt;-</span> <span class="token keyword">false</span>
  <span class="token operator">|</span> Some <span class="token punctuation">(</span><span class="token function">KeyValue</span><span class="token punctuation">(</span>time<span class="token punctuation">,</span> bucket<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span>
    timeline <span class="token operator">&lt;-</span> Map<span class="token punctuation">.</span>remove time timeline
    currentTime <span class="token operator">&lt;-</span> time
    <span class="token keyword">for</span> fn <span class="token keyword">in</span> List<span class="token punctuation">.</span>rev bucket <span class="token keyword">do</span> 
      fn <span class="token punctuation">(</span><span class="token punctuation">)</span>          
    run <span class="token punctuation">(</span><span class="token punctuation">)</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">We'll try to pick the first entry from the timeline - since here we use F# map, which is sorted in ascending order, we know that first entry is the one with the shortest execution timeout. We update our "current" time to match the expected one we calculated earlier, and finally we execute all functions scheduled at that time and repeat the loop all over until we eventually run out of scheduled actions.</p></div><div class="el-p"><p dir="auto">Now here's the trick - we use <code>List.rev</code> to execute functions in the same order in which they were scheduled, because we want our tests to be deterministic and our bugs to be reproducible. However this is not the only strategy - <strong>since we know that functions in the same bucket could as well be executing in parallel, we could shuffle them around in different permutations for early discovery of some data races!</strong> I'll won't dive into it, but leave that idea as food for thoughts for you.</p></div><div class="el-p"><p dir="auto">One last note about the test scheduler is that isolating it from the actual physical clock means, we cannot trust our time functions (like <code>DateTime.UtcNow</code>) any longer. This shouldn't really be an issue though - because relying on physical time would potentially make our tests indeterministic, we didn't want to use it anyway, right?</p></div><div class="el-p"><p dir="auto">However, we need to be able to obtain current time from the scheduler, so we need to extend its API:</p></div><div class="el-pre"><pre class="language-fsharp" tabindex="0"><code data-line="0" class="language-fsharp is-loaded"><span class="token keyword">type</span> <span class="token class-name">IScheduler</span> <span class="token operator">=</span>
  <span class="token keyword">abstract</span> UtcNow<span class="token punctuation">:</span> <span class="token class-name">unit <span class="token operator">-&gt;</span> unit</span>
  <span class="token comment">// ... other methods</span>
  
<span class="token keyword">type</span> <span class="token class-name">TestScheduler</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span>
  <span class="token keyword">let</span> <span class="token keyword">mutable</span> currentTime <span class="token operator">=</span> DateTime<span class="token punctuation">.</span>UtcNow<span class="token punctuation">.</span>Ticks
  <span class="token comment">// ... rest of the implementation</span>
  <span class="token keyword">interface</span> <span class="token class-name">IScheduler</span> <span class="token keyword">with</span>
    <span class="token keyword">member</span> __<span class="token punctuation">.</span><span class="token function">UtcNow</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">DateTime</span><span class="token punctuation">(</span>currentTime<span class="token punctuation">)</span>
    <span class="token comment">// ... other methods</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">And that's all. As always, if you got confused or have a problems along the way, you can get the entire code <a data-tooltip-position="top" aria-label="https://gist.github.com/Horusiath/9c790691130150b524aaa9ab426ed982?ref=bartoszsypytkowski.com" rel="noopener nofollow" class="external-link" href="https://gist.github.com/Horusiath/9c790691130150b524aaa9ab426ed982?ref=bartoszsypytkowski.com" target="_blank">here</a>. I wanted to thank to Anthony Lloyd for his initial work on porting Scala <a data-tooltip-position="top" aria-label="https://zio.dev/?ref=bartoszsypytkowski.com" rel="noopener nofollow" class="external-link" href="https://zio.dev/?ref=bartoszsypytkowski.com" target="_blank">ZIO</a> library to F#, which brought me an inspiration to write this piece.</p></div><div class="mod-footer mod-ui"></div></div></div></div></div></div></div></div><div class="sidebar-right sidebar"><div class="sidebar-handle"></div><div class="sidebar-topbar"><div class="topbar-content"></div><div class="clickable-icon sidebar-collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" class="svg-icon"><path d="M21 3H3C1.89543 3 1 3.89543 1 5V19C1 20.1046 1.89543 21 3 21H21C22.1046 21 23 20.1046 23 19V5C23 3.89543 22.1046 3 21 3Z"></path><path d="M10 4V20"></path><path d="M4 7H7"></path><path d="M4 10H7"></path><path d="M4 13H7"></path></svg></div></div><div class="sidebar-content"><div class="graph-view-wrapper"><div class="sidebar-section-header">Interactive Graph</div><div class="graph-view-placeholder">
		<div class="graph-view-container">
			<div class="graph-icon graph-expand" role="button" aria-label="Expand" data-tooltip-position="top"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon"><line x1="7" y1="17" x2="17" y2="7"></line><polyline points="7 7 17 7 17 17"></polyline></svg></div>
			<canvas id="graph-canvas" class="hide" width="512px" height="512px"></canvas>
		</div>
		</div></div><div class="tree-container mod-root nav-folder tree-item outline-tree" data-depth="0"><div class="tree-header"><span class="sidebar-section-header">Table Of Contents</span><button class="clickable-icon collapse-tree-button" aria-label="Collapse All"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></svg></button></div><div class="tree-scroll-area tree-item-children nav-folder-children"><div class="tree-item mod-tree-folder nav-folder mod-collapsible is-collapsed" style="display: none;"></div><div class="tree-item" data-depth="1"><a class="tree-link" href="computer-science/programming-language/fsharp/building-custom-fibers-library-in-fsharp.html#Building custom fibers library in FSharp"><div class="tree-item-contents heading-link" heading-name="Building custom fibers library in FSharp"><span class="tree-item-title">Building custom fibers library in FSharp</span></div></a><div class="tree-item-children nav-folder-children"><div class="tree-item" data-depth="3"><a class="tree-link" href="computer-science/programming-language/fsharp/building-custom-fibers-library-in-fsharp.html#Preemptive_vs_cooperative_scheduler"><div class="tree-item-contents heading-link" heading-name="Preemptive vs cooperative scheduler"><span class="tree-item-title">Preemptive vs cooperative scheduler</span></div></a><div class="tree-item-children nav-folder-children"></div></div><div class="tree-item" data-depth="3"><a class="tree-link" href="computer-science/programming-language/fsharp/building-custom-fibers-library-in-fsharp.html#Stackless_vs._stackful"><div class="tree-item-contents heading-link" heading-name="Stackless vs. stackful"><span class="tree-item-title">Stackless vs. stackful</span></div></a><div class="tree-item-children nav-folder-children"></div></div><div class="tree-item" data-depth="3"><a class="tree-link" href="computer-science/programming-language/fsharp/building-custom-fibers-library-in-fsharp.html#Eager_vs_lazy_fibers"><div class="tree-item-contents heading-link" heading-name="Eager vs lazy fibers"><span class="tree-item-title">Eager vs lazy fibers</span></div></a><div class="tree-item-children nav-folder-children"></div></div><div class="tree-item" data-depth="3"><a class="tree-link" href="computer-science/programming-language/fsharp/building-custom-fibers-library-in-fsharp.html#Interruption"><div class="tree-item-contents heading-link" heading-name="Interruption"><span class="tree-item-title">Interruption</span></div></a><div class="tree-item-children nav-folder-children"></div></div><div class="tree-item mod-collapsible" data-depth="2"><a class="tree-link" href="computer-science/programming-language/fsharp/building-custom-fibers-library-in-fsharp.html#Implementation"><div class="tree-item-contents heading-link" heading-name="Implementation"><div class="collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div><span class="tree-item-title">Implementation</span></div></a><div class="tree-item-children nav-folder-children"><div class="tree-item mod-collapsible" data-depth="3"><a class="tree-link" href="computer-science/programming-language/fsharp/building-custom-fibers-library-in-fsharp.html#Cancellation"><div class="tree-item-contents heading-link" heading-name="Cancellation"><div class="collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div><span class="tree-item-title">Cancellation</span></div></a><div class="tree-item-children nav-folder-children"><div class="tree-item" data-depth="5"><a class="tree-link" href="computer-science/programming-language/fsharp/building-custom-fibers-library-in-fsharp.html#Lock-free_updates"><div class="tree-item-contents heading-link" heading-name="Lock-free updates"><span class="tree-item-title">Lock-free updates</span></div></a><div class="tree-item-children nav-folder-children"></div></div></div></div><div class="tree-item" data-depth="3"><a class="tree-link" href="computer-science/programming-language/fsharp/building-custom-fibers-library-in-fsharp.html#Back_on_track..."><div class="tree-item-contents heading-link" heading-name="Back on track..."><span class="tree-item-title">Back on track...</span></div></a><div class="tree-item-children nav-folder-children"></div></div><div class="tree-item" data-depth="3"><a class="tree-link" href="computer-science/programming-language/fsharp/building-custom-fibers-library-in-fsharp.html#Fiber_computation_expressions"><div class="tree-item-contents heading-link" heading-name="Fiber computation expressions"><span class="tree-item-title">Fiber computation expressions</span></div></a><div class="tree-item-children nav-folder-children"></div></div><div class="tree-item" data-depth="3"><a class="tree-link" href="computer-science/programming-language/fsharp/building-custom-fibers-library-in-fsharp.html#Delayed_execution"><div class="tree-item-contents heading-link" heading-name="Delayed execution"><span class="tree-item-title">Delayed execution</span></div></a><div class="tree-item-children nav-folder-children"></div></div><div class="tree-item mod-collapsible" data-depth="3"><a class="tree-link" href="computer-science/programming-language/fsharp/building-custom-fibers-library-in-fsharp.html#Composing_parallel_fibers"><div class="tree-item-contents heading-link" heading-name="Composing parallel fibers"><div class="collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div><span class="tree-item-title">Composing parallel fibers</span></div></a><div class="tree-item-children nav-folder-children"><div class="tree-item" data-depth="4"><a class="tree-link" href="computer-science/programming-language/fsharp/building-custom-fibers-library-in-fsharp.html#Aggregating_parallel_results"><div class="tree-item-contents heading-link" heading-name="Aggregating parallel results"><span class="tree-item-title">Aggregating parallel results</span></div></a><div class="tree-item-children nav-folder-children"></div></div><div class="tree-item" data-depth="4"><a class="tree-link" href="computer-science/programming-language/fsharp/building-custom-fibers-library-in-fsharp.html#Racing_to_completion"><div class="tree-item-contents heading-link" heading-name="Racing to completion"><span class="tree-item-title">Racing to completion</span></div></a><div class="tree-item-children nav-folder-children"></div></div></div></div><div class="tree-item" data-depth="3"><a class="tree-link" href="computer-science/programming-language/fsharp/building-custom-fibers-library-in-fsharp.html#Simulating_real_environment_in_tests"><div class="tree-item-contents heading-link" heading-name="Simulating real environment in tests"><span class="tree-item-title">Simulating real environment in tests</span></div></a><div class="tree-item-children nav-folder-children"></div></div></div></div></div></div></div></div></div><script defer="">let rs = document.querySelector(".sidebar-right"); rs.classList.add("is-collapsed"); if (window.innerWidth > 768) rs.classList.remove("is-collapsed"); rs.style.setProperty("--sidebar-width", localStorage.getItem("sidebar-right-width"));</script></div></div></body></html>